@page "/attributesetup/attributesetupForm/"
@page "/attributesetup/attributesetupForm/{SessionId:guid}"
@using Application.Queries;
@using global::Core.Entities;
@using MediatR
@inject IMediator Mediator
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@using Microsoft.Extensions.Configuration;
@using global::Core.Repositories.Query;
@inject IJSRuntime JSRuntime;
@implements IDisposable
@using global::Core.Entities.Views;
@inject NavigationManager NavigationManager


<div class="row align-items-end" style="padding: 10px;border: 1px solid #d5d4d4;">
    <div class="cw-480 ch-220" style="margin-top:10px;">

        <DxTabs RenderMode="TabsRenderMode.AllTabs" @bind-ActiveTabIndex="@ActiveTabIndex" TabClick="OnTabClick">
            <DxTabPage Text="Attribute">
                <div style="margin-top:10px;">
                    <div class="card w-100 tooltips" style="margin-bottom:10px;">
                        <div class="card-body p-0 tooltiptops">
                            <div class="row">
                                <div class="">
                                    <DxMenu CollapseItemsToHamburgerMenu="true"
                                            CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                                            DisplayMode="MenuDisplayMode.Desktop" Visible="@isAttributeEnabled">
                                        <Items>
                                            <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@addBAck" />
                                            <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNewForm" />
                                            <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDelete" Enabled="@DeleteEnabled" />
                                            <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                                            <DxMenuItem Text="Add Sub Controls" IconCssClass="fa fa-wpforms" Click="@AddSubFormPopup" Enabled="IsCheckBoxEnabled" />
                                        </Items>
                                    </DxMenu>
                                </div>
                            </div>
                        </div>
                    </div>
                    <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <DxFormLayout CssClass="w-100">
                            <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                                <DxComboBox Data="@_plantItems"
                                            NullText="Select Company..."
                                            ListRenderMode="ListRenderMode.Virtual"
                                            SearchMode="ListSearchMode.AutoSearch"
                                            SearchFilterCondition="ListSearchFilterCondition.Contains"
                                            TextFieldName="NavCompany"
                                            Value="@Data.AttributeCompanyId"
                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                            ValueExpression="@(() => Data.AttributeCompanyId )"
                                            ValueChanged="@((long? plantData) => SelectedPlantChanged(plantData))"
                                            ShowValidationIcon="true">
                                    <Columns>
                                        <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                            Caption="Company Code"
                                                            Width="180px" />
                                        <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                            Caption="Description" />
                                        <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompany)"
                                                            Caption="Nav Company" />
                                    </Columns>
                                </DxComboBox>
                                <ValidationMessage For="@(() => Data.AttributeCompanyId)" />
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Label Name" ColSpanMd="6">
                                <DxTextBox @bind-Text="@Data.Description"></DxTextBox>
                                <ValidationMessage For="@(() => Data.Description)" />
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Control Type" ColSpanMd="6">
                                <DxComboBox Data="@_controlTypeData"
                                            NullText="Select ControlType..."
                                            ListRenderMode="ListRenderMode.Virtual"
                                            SearchMode="ListSearchMode.AutoSearch"
                                            SearchFilterCondition="ListSearchFilterCondition.Contains"
                                            TextFieldName="CodeValue"
                                            ValueFieldName="CodeId"
                                            Enabled="isEdit"
                                            EditFormat="{0}-{1}"
                                            Value="@Data.ControlTypeId"
                                            ValueExpression="@(() => Data.ControlTypeId )"
                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                            ValueChanged="@((int? plantData) => SelectedControlChanged(plantData,"Add"))">
                                    <Columns>
                                        <DxListEditorColumn FieldName="@nameof(CodeMaster.CodeValue)"
                                                            Caption="Control Type"
                                                            Width="200px" />
                                        <DxListEditorColumn FieldName="@nameof(CodeMaster.CodeDescription)"
                                                            Caption="Description" Width="300px" />

                                    </Columns>
                                </DxComboBox>
                                <ValidationMessage For="@(() => Data.ControlTypeId)" />
                            </DxFormLayoutItem>
                            @*  <DxFormLayoutItem Caption="SpinEdit Type" ColSpanMd="6" Visible="IsSpinEditTypeEnabled">
                            <DxComboBox Data="@dynamicFormSectionSpinEdit"
                            @bind-Value="@Data.IsAttributeSpinEditType"
                            Enabled="@IsSpinEditTypeEnabled"
                            TextFieldName="Text"
                            ValueFieldName="Value" ShowValidationIcon="true" />
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Radio Layout" ColSpanMd="6" Visible="IsRadioLayoutEnabled">
                            <DxRadioGroup Items="@RadioButtonOptions"
                            Value="@Data.AttributeRadioLayout"
                            ValueExpression="@(() => Data.AttributeRadioLayout )"
                            ValueChanged="@((string value) => OnTemplateUploadRadioGroupValueChanged(value))"
                            Layout="RadioGroupLayout.Horizontal"
                            Enabled="IsRadioLayoutEnabled"
                            CssClass="dx-demo-radio-group" />
                            </DxFormLayoutItem> *@
                            <DxFormLayoutItem Caption="Is Data Source" ColSpanMd="3" Visible="@isDropDownType">
                                <DxCheckBox Checked="@Data.IsDataSource" CheckedExpression="@(() => Data.IsDataSource)" CheckedChanged="@((bool? value) => OnTemplateDataSourceGroupValueChanged(value))" Enabled="isEdit"></DxCheckBox>
                            </DxFormLayoutItem>
                            @*   <DxFormLayoutItem Caption="Is Filter Source" ColSpanMd="3" Visible="@isDropDownType">
                            <DxCheckBox Checked="@Data.IsFilterDataSource" CheckedExpression="@(() => Data.IsFilterDataSource)" CheckedChanged="@((bool? value) => OnFilterDataSourceValueChanged(value))" Enabled="isEdit"></DxCheckBox>
                            </DxFormLayoutItem> *@
                            @*   <DxFormLayoutItem Caption="DynamicForm Single/Multiple Dropdown" ColSpanMd="3" Visible="@IsDynamicFormDropTagBoxEnabled">
                            <DxCheckBox Checked="@Data.IsDynamicFormDropTagBox" CheckedExpression="@(() => Data.IsDynamicFormDropTagBox)" CheckedChanged="@((bool? value) => OnDynamicFormDropTagBoxValueChanged(value))" Enabled="isEdit"></DxCheckBox>
                            </DxFormLayoutItem> *@
                            <DxFormLayoutItem Caption="Data Source" ColSpanMd="6" Visible="@isDataSource">
                                <DxComboBox Data="@_attributeHeaderDataSource"
                                            NullText="Select Data Source..."
                                            ListRenderMode="ListRenderMode.Virtual"
                                            SearchMode="ListSearchMode.AutoSearch"
                                            SearchFilterCondition="ListSearchFilterCondition.Contains"
                                            TextFieldName="DisplayName"
                                            ValueFieldName="AttributeHeaderDataSourceId"
                                            Enabled="isEdit"
                                            Value="@Data.DataSourceId"
                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                            ValueExpression="@(() => Data.DataSourceId )"
                                            ValueChanged="@((long? plantData) => SelectedItemDataSourceChanged(plantData))">
                                </DxComboBox>
                                <ValidationMessage For="@(() => Data.DataSourceId)" />
                            </DxFormLayoutItem>

                            @*   <DxFormLayoutItem Caption="Filter Source" ColSpanMd="6" Visible="@isFilterDataSource">
                            <DxComboBox Data="@_dynamicFormFilter"
                            NullText="Select Filter Source..."
                            FilteringMode="DataGridFilteringMode.Contains"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                            TextFieldName="DisplayName"
                            ValueFieldName="DynamicFilterId"
                            Enabled="isEdit"
                            SelectedItemChanged="@((DynamicFormFilter plant) => SelectedItemFilterDataSourceChanged(plant))"
                            @bind-Value="@Data.FilterDataSocurceId">

                            </DxComboBox>
                            <ValidationMessage For="@(() => Data.FilterDataSocurceId)" />
                            </DxFormLayoutItem> *@
                            <DxFormLayoutItem Caption="Dynamic Form" ColSpanMd="6" Visible="isGridForm">
                                <DxComboBox Data="@_dynamicForms"
                                            NullText="Select Dynamic Form..."
                                            ListRenderMode="ListRenderMode.Virtual"
                                            SearchMode="ListSearchMode.AutoSearch"
                                            SearchFilterCondition="ListSearchFilterCondition.Contains"
                                            TextFieldName="Name"
                                            ValueFieldName="ID"
                                            Enabled="isEdit"
                                            Value="@Data.DynamicFormId"
                                            ValueExpression="@(() => Data.DynamicFormId )"
                                            ValueChanged="@((long? plantData) => SelectedItemDynamicFormChanged(plantData))"
                                            ShowValidationIcon="true">
                                    <Columns>
                                        <DxListEditorColumn FieldName="@nameof(DynamicForm.Name)"
                                                            Caption="Name"
                                                            Width="180px" />
                                        <DxListEditorColumn FieldName="@nameof(DynamicForm.CompanyName)"
                                                            Caption="Company Name" />
                                        <DxListEditorColumn FieldName="@nameof(DynamicForm.ProfileName)"
                                                            Caption="Profile" />
                                        <DxListEditorColumn FieldName="@nameof(DynamicForm.ScreenID)"
                                                            Caption="Screen Name" />
                                        <DxListEditorColumn FieldName="@nameof(DynamicForm.ModifiedBy)" SearchEnabled="false"
                                                            Caption="Modified By" />
                                        <DxListEditorColumn FieldName="@nameof(DynamicForm.ModifiedDate)" SearchEnabled="false"
                                                            Caption="Modified Date" />
                                    </Columns>
                                </DxComboBox>
                                <ValidationMessage For="@(() => Data.DynamicFormId)" />
                            </DxFormLayoutItem>
                            @* <DxFormLayoutItem Caption="Is Multiple" ColSpanMd="6" Visible="@isListMultiple">
                            <DxCheckBox @bind-Checked="Data.IsMultiple" Enabled="@isListMultiple"></DxCheckBox>
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Is Required" ColSpanMd="6">
                            <DxCheckBox @bind-Checked="Data.IsRequired"></DxCheckBox>
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Required Message" ColSpanMd="6">
                            <DxTextBox @bind-Text="@Data.RequiredMessage" />
                            <ValidationMessage For="@(() => Data.RequiredMessage)" />
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Is Visible" ColSpanMd="6">
                            <DxCheckBox @bind-Checked="Data.AttributeIsVisible"></DxCheckBox>
                            </DxFormLayoutItem> *@
                            @*   <DxFormLayoutItem Caption="Entry Mask" ColSpanMd="6">
                            <DxTextBox @bind-Text="Data.EntryMask" Enabled="@MaskEnabled"></DxTextBox>
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Reg.Exp" ColSpanMd="6">
                            <DxTextBox @bind-Text="Data.RegExp" Enabled="@RegEnabled"></DxTextBox>
                            </DxFormLayoutItem> *@
                            <DxFormLayoutItem Caption="Description" ColSpanMd="12">
                                <DxMemo @bind-Text="@Data.AttrDescription" Rows="5" />
                            </DxFormLayoutItem>
                        </DxFormLayout>

                    </EditForm>
                </div>
            </DxTabPage>
            <DxTabPage Text="Attribute Data" Enabled="AttributeDetailsEnabled">
                <AttributeDetailsSetup @ref=RefDetails></AttributeDetailsSetup>
            </DxTabPage>
        </DxTabs>

    </div>
</div>

<DxPopup @bind-Visible="@Blukdeletepopup"
         ShowFooter="true"
         ShowCloseButton="true"
         HeaderText="Delete"
         Closed="EulaPopupClosed"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Do you want to delete
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="((e) => bulkDelete())" />
    </FooterContentTemplate>
</DxPopup>
<DxPopup @bind-Visible="@AddPopup"
         ShowFooter="false"
         HeaderText="Add Sub Controls"
         Closed="EulaPopupClosed"
         CloseOnOutsideClick="false"
         MinWidth="300" MinHeight="200" MaxWidth="1000px" MaxHeight="800"
         CloseOnEscape="false" ShowCloseButton="true">
    <BodyContentTemplate>
        <AttributeSubFormSetupList RevokeBack="CloseSubFormPopup" Type="SubAttributeID" SubAttributeId="@Data.AttributeID"></AttributeSubFormSetupList>

    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Close" Click="@(() => CloseSubFormPopup())" />
    </FooterContentTemplate>
</DxPopup>
@code {
    private IDisposable? DynamicFormPage;
    [Parameter]
    public Guid? SessionId { get; set; }
    [Parameter]
    public string Type { get; set; }
    public int ActiveTabIndex { get; set; } = 0;
    EditContext _editContext;
    private AttributeDetailsSetup? RefDetails { get; set; }
    bool DeleteEnabled { get; set; } = false; bool IsCheckBoxEnabled { get; set; } = false;
    bool MaskEnabled { get; set; } = false; bool isFilterDataSource { get; set; } = false;
    bool AddPopup { get; set; } = false;
    bool RegEnabled { get; set; } = false;
    bool isMultipleEnabled { get; set; } = false;
    bool Blukdeletepopup { get; set; } = false;
    bool isSelectEnabled { get; set; } = true;
    bool isAddAttributeEnabled { get; set; } = false;
    bool isAttributeEnabled { get; set; } = true;
    bool isEdit { get; set; } = true;
    bool AttributeDetailsEnabled { get; set; } = false;
    IEnumerable<string> RadioButtonOptions = new[] { "Vertical", "Horizontal" };
    private List<ViewPlants>? _plantItems;
    private bool loading;
    private string MyID = "myid";
    long AttributeIDs;
    private List<AttributeHeader>? _attributes;
    string? isDisplay = "display:none;";
    string? isDisplay1 = "";
    AttributeHeader Data = new AttributeHeader();
    private List<CodeMaster> _stausItems;
    private List<ApplicationUser> _applicationUsers;
    private CodeMaster? codemaster;
    public ApplicationUser? applicationUser { get; private set; }
    private AttributeHeader? _master;
    private List<AttributeHeader>? _SaveLst;
    AttributeHeader AttributeNamelst = new AttributeHeader();
    private List<string> ControlTypeChildData = new List<string> { "ComboBox", "ListBox", "TagBox", "Radio" };
    private List<DropDownOptionsModel> DropDownTypeItems { get; set; } = new List<DropDownOptionsModel>();
    private List<DropDownOptionsModel> DataSourceItems { get; set; } = new List<DropDownOptionsModel>();
    IEnumerable<string> TemplateUploadOptions = new[] { "In Build", "Data Source" };
    private List<CodeMaster> _controlTypeData;
    private List<AttributeHeaderDataSource> _attributeHeaderDataSource;
    private List<DynamicFormFilter> _dynamicFormFilter;
    bool isDropDownType { get; set; } = false;
    bool isDataSource { get; set; } = false; bool IsDynamicFormDropTagBoxEnabled { get; set; } = false;
    bool isGridForm { get; set; } = false; private List<DynamicFormSectionSpinEdit> dynamicFormSectionSpinEdit { get; set; } = new List<DynamicFormSectionSpinEdit>();
    private List<DynamicForm> _dynamicForm; private List<DynamicForm> _dynamicForms; string? DataSourceTable { get; set; }
    bool isListMultiple = false; bool IsSpinEditTypeEnabled { get; set; } = false; bool IsRadioLayoutEnabled { get; set; } = false;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        DropDownTypeItems.Add(new DropDownOptionsModel() { Value = "InBuild", Text = "InBuild" });
        DropDownTypeItems.Add(new DropDownOptionsModel() { Value = "DataSource", Text = "Data Source" });
        dynamicFormSectionSpinEdit.Add(new DynamicFormSectionSpinEdit() { Value = "int", Text = "Integer" });
        dynamicFormSectionSpinEdit.Add(new DynamicFormSectionSpinEdit() { Value = "decimal", Text = "Decimal" });
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("Status"));
        _controlTypeData = await Mediator.Send(new GetAllCodeMasterQuery("AttributeControlType"));
        _attributeHeaderDataSource = await Mediator.Send(new GetAttributeHeaderDataSource());
        _dynamicFormFilter = await Mediator.Send(new GetFilterDataSource());
        _plantItems = await Mediator.Send(new GetAllPlantByNavCompanyQuery());
        _dynamicForm = new List<DynamicForm>();
        _dynamicForm = await Mediator.Send(new GetAllDynamicForm(0));
        _dynamicForms = new List<DynamicForm>();
        _dynamicForms = _dynamicForm;
        isAddAttributeEnabled = false;
        isSelectEnabled = true;
        loadPlantItems();
        await loadData();
    }
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            DynamicFormPage =
                NavigationManager.RegisterLocationChangingHandler(OnLocationChanging);
        }
    }
    void SelectedPlantChanged(long? country)
    {
        Data.AttributeCompanyId = null;
        if (country>0)
        {
            Data.AttributeCompanyId = country;
        }
    }
    private ValueTask OnLocationChanging(LocationChangingContext context)
    {
        if (context.TargetLocation == "/counter")
        {
            context.PreventNavigation();
        }

        return ValueTask.CompletedTask;
    }

    public void Dispose()
    {

        DynamicFormPage?.Dispose();
        System.GC.Collect();
        GC.SuppressFinalize(this);
    }
    protected override async Task OnParametersSetAsync()
    {
        await loadData();
        base.OnParametersSet();
    }
    void CloseSubFormPopup()
    {
        AddPopup = false;
        StateHasChanged();
    }
    void AddSubFormPopup()
    {
        AddPopup = true;
        StateHasChanged();
    }
    void loadPlantItems()
    {
        if (_plantItems != null && _plantItems.Count > 0)
        {
            Data.AttributeCompanyId = _plantItems.OrderBy(o => o.PlantID).FirstOrDefault()?.PlantID;
        }
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
            isAttributeEnabled = true;
            AttributeDetailsEnabled = false;
            var controlType = _controlTypeData.FirstOrDefault(f => f.CodeId == Data.ControlTypeId)?.CodeValue;
            if (controlType != null)
            {
                var isChildData = ControlTypeChildData.FirstOrDefault(f => controlType.ToLower().Contains(f.ToLower()));
                if (isChildData != null && Data.DropDownTypeId != "DataSource")
                {
                    AttributeDetailsEnabled = true;
                }
            }
        }
        if (e.TabIndex == 1)
        {
            isAttributeEnabled = false;
            var controlType = _controlTypeData.FirstOrDefault(f => f.CodeId == Data.ControlTypeId)?.CodeValue;
            if (controlType != null)
            {
                var isChildData = ControlTypeChildData.FirstOrDefault(f => controlType.ToLower().Contains(f.ToLower()));
                if (isChildData != null && Data.DropDownTypeId != "DataSource")
                {
                    await RefDetails.Attributeload(Data.AttributeID, controlType, "MainForm");
                }
                else
                {
                    await RefDetails.Attributeload(Data.AttributeID, null, "MainForm");
                }
            }
        }
        StateHasChanged();
    }
    void loadDataSourceItems()
    {
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "Employee", Text = "Employee" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "NAVCustomer", Text = "Customer" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "NavItems", Text = "Nav Items" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "NAVVendor", Text = "Vendor" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "Plant", Text = "Company" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "Department", Text = "Department" });
    }
    async Task loadData()
    {
        if (SessionId != null)
        {
            var _attributesData = await Mediator.Send(new GetAllBySessionAttributeName(SessionId));
            if (_attributesData != null)
            {
                _master = _attributesData;
                SelectedItemChanged(_attributesData, "Edit");
            }
            else
            {
                NavigationManager.NavigateTo("attributesetup/attributesetupForm/");
            }
        }
        else
        {
            NavigationManager.NavigateTo("attributesetup/attributesetupForm/");
        }
        StateHasChanged();
    }
    void addNewForm()
    {
        addNew();
        NavigationManager.NavigateTo("attributesetup/attributesetupForm/");

    }
    void addNew()
    {
        SessionId = null;
        _editContext = new EditContext(Data);
        Data.Description = null;
        Data.EntryMask = null;
        Data.RegExp = null;
        Data.IsInternal = false;
        Data.ControlTypeId = null; Data.ControlType = null;
        Data.AttributeCompanyId = null; Data.AttrDescription = null;
        Data.IsMultiple = false;
        Data.IsRequired = false;
        Data.RequiredMessage = null;
        Data.AttributeID = 0;
        Data.AttributeName = "Attr";
        Data.SessionId = null;
        Data.DataSourceId = 0;
        Data.DropDownTypeId = null;
        Data.IsDataSource = false; Data.IsFilterDataSource = false; Data.FilterDataSocurceId = null;
        Data.DynamicFormId = null;
        Data.IsSubForm = null;
        Data.SubAttributeDetailId = null; Data.AttributeIsVisible = false;
        Data.SubAttributeId = null;
        isAddAttributeEnabled = false;
        isSelectEnabled = true;
        isDisplay = "display:none;";
        isDisplay1 = "";
        isEdit = true;
        DeleteEnabled = false;
        isDropDownType = false; IsDynamicFormDropTagBoxEnabled = false; isFilterDataSource = false;
        isDataSource = false;
        ActiveTabIndex = 0;
        AttributeDetailsEnabled = false; isGridForm = false; DataSourceTable = null;
        Data.IsDynamicFormDropTagBox = false; isListMultiple = false; IsSpinEditTypeEnabled = false; Data.IsAttributeSpinEditType = null;
        IsRadioLayoutEnabled = false; Data.AttributeRadioLayout = null; IsCheckBoxEnabled = false;
        _dynamicForms = new List<DynamicForm>();
        _dynamicForms = _dynamicForm;
        
        loadPlantItems();
        StateHasChanged();
    }
    void addDelete()
    {
        Blukdeletepopup = true;
    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
        else
        {

        }
    }
    async Task HandleValidSubmit()
    {
        await createAttributes();
    }
    void OnEditButtonClick()
    {
        isAddAttributeEnabled = true;
        isSelectEnabled = false;
        StateHasChanged();
    }
    void OnCloseButtonClick()
    {
        isAddAttributeEnabled = false;
        isSelectEnabled = true;
        StateHasChanged();
    }
    void addBAck()
    {
        NavigationManager.NavigateTo("attributesetup");
    }
    async Task createAttributes()
    {

        long? DynamicFormIds = Data.DynamicFormId;
        string? DropDownTypeId = Data.ControlTypeId == 2702 || Data.ControlTypeId == 2708 || Data.ControlTypeId == 2706 ? Data.DropDownTypeId : null;
        long? dataSourceId = Data.ControlTypeId == 2702 || Data.ControlTypeId == 2708 || Data.ControlTypeId == 2706 ? Data.DataSourceId : null;
        if (Data.AttributeID > 0)
        {

        }
        else
        {
            Data.AttributeIsVisible = true;
        }
        long? dynamicFormId = Data.ControlTypeId == 2712 ? DynamicFormIds : null;
        if (Data.IsDataSource == true && Data.DataSourceId > 0)
        {
            var _attributeHeaderDataSources = _attributeHeaderDataSource.FirstOrDefault(f => f.AttributeHeaderDataSourceId == Data.DataSourceId)?.DataSourceTable;
            if (_attributeHeaderDataSources == "DynamicGrid")
            {
                DataSourceTable = _attributeHeaderDataSources;
                dynamicFormId = DynamicFormIds;
            }
        }
        var IsRadioLayout = Data.ControlTypeId == 2705 || Data.ControlTypeId == 2711 ? (string.IsNullOrEmpty(Data.AttributeRadioLayout) ? null : Data.AttributeRadioLayout) : null;
        var IsSpinEditType = Data.ControlTypeId == 2704 ? (string.IsNullOrEmpty(Data.IsAttributeSpinEditType) ? null : Data.IsAttributeSpinEditType) : null;
        var createReq = new CreateAttributeHeader
            {
                AttributeID = Data.AttributeID,
                // AttributeName = Data.AttributeName,
                AttributeName = "Attr",
                Description = Data.Description,
                AttributeCompanyId = Data.AttributeCompanyId,
                ControlType = Data.ControlType,
                IsInternal = Data.IsInternal,
                EntryMask = Data.EntryMask,
                RegExp = Data.RegExp,
                ControlTypeId = Data.ControlTypeId,
                IsMultiple = Data.ControlTypeId == 2706 ? (Data.IsMultiple == true ? true : false) : false,
                IsRequired = Data.IsRequired,
                RequiredMessage = Data.IsRequired == true ? Data.RequiredMessage : null,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now,
                DynamicFormId = dynamicFormId > 0 ? dynamicFormId : null,
                SessionId = Data.SessionId == null ? Guid.NewGuid() : Data.SessionId,
                DataSourceId = DropDownTypeId == "Data Source" ? dataSourceId : null,
                DropDownTypeId = DropDownTypeId,
                IsDynamicFormDropTagBox = Data.IsDynamicFormDropTagBox,
                IsSubForm = Data.IsSubForm,
                SubAttributeDetailId = Data.SubAttributeDetailId,
                SubAttributeId = Data.SubAttributeId,
                AttributeIsVisible = Data.AttributeIsVisible,
                IsAttributeSpinEditType = IsSpinEditType,
                AttributeRadioLayout = IsRadioLayout,
                AttrDescription = Data.AttrDescription,
                IsFilterDataSource = Data.IsFilterDataSource,
                FilterDataSocurceId = Data.FilterDataSocurceId,
            };
        var result = await Mediator.Send(createReq);
        if (result > 0)
        {
            if (Data.AttributeID > 0)
            {
                toastService.ShowToast("Attribute have been Updated successully.", AC.SD.Core.Services.ToastLevel.Success);
            }
            else
            {
                toastService.ShowToast("Attribute have been Added successully.", AC.SD.Core.Services.ToastLevel.Success);
            }
            Data.AttributeID = result;
            AttributeDetailsEnabled = false;
            if (Data.ControlTypeId == 2710)
            {
                IsCheckBoxEnabled = true;
            }
            var controlType = _controlTypeData.FirstOrDefault(f => f.CodeId == Data.ControlTypeId)?.CodeValue;
            if (controlType != null)
            {
                var isChildData = ControlTypeChildData.FirstOrDefault(f => controlType.ToLower().Contains(f.ToLower()));
                if (isChildData != null)
                {
                    if (Data.DropDownTypeId != "Data Source")
                    {
                        AttributeDetailsEnabled = true;
                    }
                    if (Data.IsDynamicFormDropTagBox == true)
                    {
                        AttributeDetailsEnabled = false;
                    }
                    if (Data.IsFilterDataSource == true)
                    {
                        AttributeDetailsEnabled = false;
                    }
                }
                isDisplay1 = "display:none;";
                isDisplay = "";
            }
            NavigationManager.NavigateTo("attributesetup/attributesetupForm/" + createReq.SessionId);
        }
        isAddAttributeEnabled = false;
        isSelectEnabled = true;

        StateHasChanged();

        // await loadData();


    }
    void SelectedItemFilterDataSourceChanged(DynamicFormFilter dynamicFormFilter)
    {
        Data.DataSourceId = 0; isGridForm = false;
        Data.DropDownTypeId = null; Data.DynamicFormId = 0;
        StateHasChanged();
    }
    void SelectedItemDataSourceChanged(long? value)
    {
        Data.DataSourceId = null;
        Data.DynamicFormId = 0; isGridForm = false;
        if (Data.IsDataSource == true && value != null)
        {
            Data.DataSourceId = value;
            var data = _attributeHeaderDataSource.FirstOrDefault(f => f.AttributeHeaderDataSourceId == value);
            if (data!=null && data.DataSourceTable == "DynamicGrid")
            {
                Data.DynamicFormId = null; isGridForm = true;
            }
        }
        StateHasChanged();
    }
    void SelectedItemDynamicFormChanged(long? dynamicForm)
    {
        Data.DynamicFormId = null;
        if (dynamicForm>0)
        {
            Data.DynamicFormId = dynamicForm;
        }
    }
    void SelectedItemChanged(AttributeHeader header, string? type)
    {
        if (type == "Add")
        {
            addNew();
        }
        isEdit = true; DeleteEnabled = false;
        isDropDownType = false; isDataSource = false; IsDynamicFormDropTagBoxEnabled = false;
        isDisplay = "display:none;";
        isDisplay1 = ""; AttributeDetailsEnabled = false; DataSourceTable = null; IsCheckBoxEnabled = false; isListMultiple = false; IsSpinEditTypeEnabled = false;
        IsRadioLayoutEnabled = false;
        if (header != null)
        {
            if (header.AttributeID > 0)
            {
                loadDropDownList(header.AttributeID);
            }
        }
        else
        {
            Data.Description = null; Data.AttributeCompanyId = null;
            Data.EntryMask = null; Data.AttrDescription = null;
            Data.RegExp = null;
            Data.IsInternal = false; Data.ControlType = null;
            Data.ControlTypeId = null;
            Data.IsMultiple = false;
            Data.IsRequired = false;
            Data.RequiredMessage = null;
            Data.AttributeID = 0;
            Data.AttributeName = "Attr";
            Data.SessionId = null;
            Data.DataSourceId = 0;
            Data.DropDownTypeId = null; Data.DynamicFormId = null; isGridForm = false;
            Data.IsDataSource = false; DataSourceTable = null; Data.IsDynamicFormDropTagBox = false;
            Data.IsSubForm = null;
            Data.SubAttributeDetailId = null;
            Data.SubAttributeId = null; IsRadioLayoutEnabled = false; Data.AttributeRadioLayout = null;
            isListMultiple = false; IsSpinEditTypeEnabled = false; Data.IsAttributeSpinEditType = null; IsCheckBoxEnabled = false;
            loadPlantItems();
            if (Data.AttributeID > 0)
            {
                loadDropDownList(Data.AttributeID);
            }
        }
    }
    void loadDropDownList(long? AttributeID)
    {
        isDisplay = "display:none;";
        isDisplay1 = "";
        DeleteEnabled = false; Data.DropDownTypeId = null; Data.IsDataSource = false; DataSourceTable = null; Data.IsFilterDataSource = false;
        Data.IsDynamicFormDropTagBox = false; isListMultiple = false; IsSpinEditTypeEnabled = false; IsRadioLayoutEnabled = false;
        _dynamicForms = new List<DynamicForm>();
        _dynamicForms = _dynamicForm.ToList();
        if (_master != null && _master.AttributeID > 0)
        {

            isDisplay = ""; isDisplay1 = "display:none;";
            Data.Description = _master.Description; Data.AttributeCompanyId = _master.AttributeCompanyId;
            Data.EntryMask = _master.EntryMask;
            Data.RegExp = _master.RegExp;
            Data.IsInternal = _master.IsInternal;
            Data.ControlTypeId = _master.ControlTypeId;
            Data.ControlType = _master.ControlType;
            Data.IsMultiple = _master.IsMultiple;
            Data.IsRequired = _master.IsRequired;
            Data.RequiredMessage = _master.RequiredMessage;
            Data.AttributeID = _master.AttributeID;
            Data.AttributeName = _master.AttributeName;
            Data.SessionId = _master.SessionId;
            Data.DropDownTypeId = _master.DropDownTypeId;
            Data.DynamicFormId = _master.DynamicFormId;
            Data.IsDynamicFormDropTagBox = _master.IsDynamicFormDropTagBox;
            Data.DataSourceId = Data.DropDownTypeId == "Data Source" ? _master.DataSourceId : 0;
            Data.SubAttributeDetailId = _master.SubAttributeDetailId;
            Data.SubAttributeId = _master.SubAttributeId;
            Data.AttributeIsVisible = _master.AttributeIsVisible;
            Data.AttributeRadioLayout = _master.AttributeRadioLayout;
            Data.AttrDescription = _master.AttrDescription;
            Data.IsFilterDataSource = _master.IsFilterDataSource == true ? true : false;
            Data.FilterDataSocurceId = _master.IsFilterDataSource == true && _master.FilterDataSocurceId > 0 ? _master.FilterDataSocurceId : 0;
            Data.IsAttributeSpinEditType = string.IsNullOrEmpty(_master.IsAttributeSpinEditType) ? "int" : _master.IsAttributeSpinEditType;
            SelectedControlChanged(Data.ControlTypeId, "Edit");
            var isChildData = ControlTypeChildData.FirstOrDefault(f => _master.ControlType.ToLower().Contains(f.ToLower()));
            DeleteEnabled = true; AttributeDetailsEnabled = false;
            if (Data.IsFilterDataSource == true)
            {
                isFilterDataSource = true;
                if (_master.FilterDataSocurceId == null)
                {
                    Data.FilterDataSocurceId = null;
                }
                else
                {
                    var ex = _dynamicFormFilter.FirstOrDefault(f => f.DynamicFilterId == _master.FilterDataSocurceId);
                    if (ex == null)
                    {
                        Data.FilterDataSocurceId = null;
                    }
                }
            }
            if (_master.ControlTypeId == 2712)
            {
                _dynamicForms = new List<DynamicForm>();
                _dynamicForms = _dynamicForm.Where(w => w.IsGridForm == true).ToList();
                if (_dynamicForms != null && _dynamicForms.Count() > 0)
                {
                    var exis = _dynamicForms.FirstOrDefault(f => f.ID == _master.DynamicFormId);
                    if (exis != null)
                    {

                    }
                    else
                    {
                        Data.DynamicFormId = null;
                    }
                }
            }
            if (_master.ControlTypeId == 2710)
            {
                IsCheckBoxEnabled = true;
            }
            if (_master.FormUsedCount > 0)
            {
                isEdit = false;
                // DeleteEnabled = false;
            }
            if (Data.DropDownTypeId == "Data Source")
            {
                Data.IsDataSource = true;
                isDataSource = true;
                if (Data.IsDataSource == true && Data.DataSourceId > 0)
                {
                    var _attributeHeaderDataSources = _attributeHeaderDataSource.FirstOrDefault(f => f.AttributeHeaderDataSourceId == Data.DataSourceId)?.DataSourceTable;
                    if (_attributeHeaderDataSources == "DynamicGrid")
                    {
                        isGridForm = true; DataSourceTable = _attributeHeaderDataSources;
                        Data.DynamicFormId = _master.DynamicFormId;
                        if (_dynamicForms != null && _dynamicForms.Count() > 0)
                        {
                            var exis = _dynamicForms.FirstOrDefault(f => f.ID == _master.DynamicFormId);
                            if (exis != null)
                            {

                            }
                            else
                            {
                                Data.DynamicFormId = null;
                            }
                        }
                    }
                }
            }
            if (isChildData != null)
            {
                if (Data.DropDownTypeId != "Data Source")
                {
                    AttributeDetailsEnabled = true;
                }
            }
            if (Data.IsDynamicFormDropTagBox == true)
            {
                AttributeDetailsEnabled = false;
            }
            if (Data.ControlTypeId == 2706)
            {
                isListMultiple = true;
            }
            if (Data.IsFilterDataSource == true)
            {
                AttributeDetailsEnabled = false;
            }
            if (Data.ControlTypeId == 2704)
            {
                IsSpinEditTypeEnabled = true;
            }
            if (Data.ControlTypeId == 2704)
            {
                IsSpinEditTypeEnabled = true;
            }
            if (Data.ControlTypeId == 2705 || Data.ControlTypeId == 2711)
            {
                if (string.IsNullOrEmpty(Data.AttributeRadioLayout))
                {
                    Data.AttributeRadioLayout = "Vertical";
                }
                IsRadioLayoutEnabled = true;
            }
        }
    }
    void OnTemplateUploadRadioGroupValueChanged(string? radioValue)
    {
        Data.AttributeRadioLayout = radioValue;
    }
    void OnTemplateUploadGroupValueChanged(string? radioValue)
    {
        isDataSource = false; Data.DataSourceId = 0;
        Data.DropDownTypeId = radioValue; Data.DataSourceId = null;
        if (radioValue == "Data Source")
        {
            isDataSource = true;
            Data.DataSourceId = null;

        }
        StateHasChanged();
    }
    async void OnDynamicFormDropTagBoxValueChanged(bool? radioValue)
    {
        Data.IsDynamicFormDropTagBox = radioValue;
        if (radioValue == true)
        {
            Data.IsDataSource = false;
            isDataSource = false; Data.DataSourceId = 0; isGridForm = false;
            Data.DropDownTypeId = null; Data.DynamicFormId = 0;
        }
        else
        {
            await OnTemplateDataSourceGroupValueChanged(true);
        }
        StateHasChanged();
    }
    void OnFilterDataSourceValueChanged(bool? radioValue)
    {
        Data.IsDataSource = false; isDataSource = false; Data.DataSourceId = 0; Data.DynamicFormId = 0; isGridForm = false;

        Data.FilterDataSocurceId = null; isFilterDataSource = false;
        Data.IsFilterDataSource = radioValue;
        if (radioValue == true)
        {
            isFilterDataSource = true;
        }
        StateHasChanged();
    }
    async Task OnTemplateDataSourceGroupValueChanged(bool? radioValue)
    {
        Data.IsFilterDataSource = false; Data.FilterDataSocurceId = 0; isFilterDataSource = false;

        Data.IsDataSource = radioValue;
        isDataSource = false; Data.DataSourceId = 0; isGridForm = false;
        Data.DropDownTypeId = null; Data.DynamicFormId = 0;

        if (radioValue == true)
        {
            Data.IsDynamicFormDropTagBox = false;
            Data.DropDownTypeId = "Data Source";
            isDataSource = true;
            Data.DataSourceId = null;
            var _attributeHeaderDataSources = await Mediator.Send(new GetAttributeHeaderDataSource());
            if (Data.ControlTypeId == 2702 || Data.ControlTypeId == 2708)
            {
                _attributeHeaderDataSource = _attributeHeaderDataSources;
            }
            else
            {
                if (_attributeHeaderDataSources != null && _attributeHeaderDataSources.Count > 0)
                {
                    _attributeHeaderDataSource = _attributeHeaderDataSources.Where(w => w.DataSourceTable != "DynamicGrid").ToList();
                }
            }
        }
        StateHasChanged();
    }
    void SelectedControlChanged(int? controlTypeId, string type)
    {
        Data.ControlTypeId = null;
        isMultipleEnabled = false;
        MaskEnabled = false;
        RegEnabled = false; isDropDownType = false; IsDynamicFormDropTagBoxEnabled = false; IsSpinEditTypeEnabled = false;
        isDataSource = false; isGridForm = false; IsRadioLayoutEnabled = false;
        _dynamicForms = new List<DynamicForm>();
        _dynamicForms = _dynamicForm.ToList();
        if (type == "Add")
        {
            Data.DataSourceId = 0; Data.DynamicFormId = 0; isListMultiple = false; Data.IsFilterDataSource = false;
            Data.IsDataSource = false; Data.FilterDataSocurceId = 0; Data.IsDynamicFormDropTagBox = false;
            Data.AttributeRadioLayout = null;
            if (controlTypeId == 2704)
            {
                Data.IsAttributeSpinEditType = "int";
                IsSpinEditTypeEnabled = true;
            }
            if (controlTypeId == 2705 || controlTypeId == 2711)
            {
                if (string.IsNullOrEmpty(Data.AttributeRadioLayout))
                {
                    Data.AttributeRadioLayout = "Vertical";
                }
                IsRadioLayoutEnabled = true;
            }
        }
        if (type == "Edit")
        {
            if (controlTypeId != 2712)
            {
                Data.DynamicFormId = 0;
            }
            if (controlTypeId == 2706)
            {
                isListMultiple = true;
            }
            if (controlTypeId == 2704)
            {
                IsSpinEditTypeEnabled = true;
            }
            if (controlTypeId == 2705 || controlTypeId == 2711)
            {
                if (string.IsNullOrEmpty(Data.AttributeRadioLayout))
                {
                    Data.AttributeRadioLayout = "Vertical";
                }
                IsRadioLayoutEnabled = true;
            }
        }
        if (controlTypeId > 0)
        {
            Data.ControlTypeId = controlTypeId;
            var controlType = _controlTypeData.FirstOrDefault(f => f.CodeId == controlTypeId)?.CodeValue;
            if (!string.IsNullOrEmpty(controlType))
            {
                Data.ControlType = controlType;
                var isChildData = ControlTypeChildData.FirstOrDefault(f => controlType.ToLower().Contains(f.ToLower()));
                if (isChildData != null)
                {
                    isMultipleEnabled = true;
                }
                if (controlType == "TextBox")
                {
                    MaskEnabled = true;
                    RegEnabled = true;
                }
            }
            if (controlTypeId == 2702 || controlTypeId == 2708 || controlTypeId == 2706)
            {
                if (Data.AttributeID == 0)
                {
                    Data.IsDataSource = false;
                    Data.DataSourceId = 0;
                }
                isDropDownType = true;
            }
            if (controlTypeId == 2706)
            {
                isListMultiple = true;
            }
            if (controlTypeId == 2702 || controlTypeId == 2708)
            {
                if (Data.AttributeID == 0)
                {
                    Data.IsDynamicFormDropTagBox = false;
                }
                IsDynamicFormDropTagBoxEnabled = true;
            }
            if (controlTypeId == 2712)
            {
                _dynamicForms = new List<DynamicForm>();
                _dynamicForms = _dynamicForm.Where(w => w.IsGridForm == true).ToList();
                if (type != "Edit")
                {
                    Data.DynamicFormId = null;
                }
                isGridForm = true;
            }
        }

    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        AddPopup = false;
        Blukdeletepopup = false;
        StateHasChanged();
    }
    async Task bulkDelete()
    {
        try
        {
            var request = new DeleteAttributeHeader(Data);
            await Mediator.Send(request);
            Blukdeletepopup = false;
            toastService.ShowToast("Attribute have been Deleted successully.", AC.SD.Core.Services.ToastLevel.Success);

            addNew();
            await loadData();
        }
        catch (Exception eq)
        {
            Blukdeletepopup = false;
            toastService.ShowToast("You Must Delete ValueID.", AC.SD.Core.Services.ToastLevel.Error);
        }

    }
}