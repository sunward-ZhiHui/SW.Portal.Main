@page "/attributesetup"
@using Application.Queries;
@using global::Core.Entities;
@using MediatR
@inject IMediator Mediator
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@using Microsoft.Extensions.Configuration;
@using global::Core.Repositories.Query;
@inject IJSRuntime JSRuntime;




<div class="card w-100 tooltips" style="margin-bottom:10px;">
    <div class="card-body p-0 tooltiptops">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDelete" Enabled="@DeleteEnabled" />

                    </Items>
                </DxMenu>
            </div>
            <div class="save_hover" style="float: left; margin-top: -41px; line-height: 38px; margin-left: 220px; z-index: 9999; width:100px;">
                <button type="submit" form="@MyID" disabled="@loading" class="btnSubmitForm" style="">
                    @if (loading)
                    {
                        <span class="spinner-border spinner-border-sm mr-1"></span>
                    }
                    <i class="fa fa-save"></i>
                    Save
                </button>
            </div>


        </div>
    </div>
</div>




<div class="col-md-12" style="height: calc(100vh - 200px);">
    <div style="height:35%; border: 1px solid #b2afaf;  margin-bottom: 10px; padding:10px;">
        <div class="mini-menu-bar-top">
            <div class="mini-menu-bar-heading">
            </div>

            <div>
                <div class="views-accordion">
                    <EditForm Model="@Data" id="@MyID" Context="EditFormContext" OnInvalidSubmit="@HandleInvalidSubmit" OnValidSubmit="@HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <DxFormLayout CssClass="w-100">
                            <DxFormLayoutItem Caption="Add Or Select Field " ColSpanMd="6" Visible="isSelectEnabled">
                                <span style="@isDisplay">
                                    <DxComboBox Data="@_attributes"
                                                AllowUserInput="true"
                                                NullText="Select Field Name..."
                                                ListRenderMode="ListRenderMode.Virtual"
                                                FilteringMode="DataGridFilteringMode.Contains"
                                                TextFieldName="AttributeName"
                                                ValueFieldName="AttributeName"
                                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    @bind-Value="Data.AttributeName"
                                    @bind-Text="Data.AttributeName"
                                                ShowValidationIcon="true"
                                                SelectedItemChanged="@((AttributeHeader plant) => SelectedItemChanged(plant))">
                                        <Buttons>
                                            <DxEditorButton IconCssClass="fa fa-pencil"
                                                            Tooltip="Edit an Attribute"
                                                            Click="@(_ => OnEditButtonClick())" />
                                        </Buttons>
                                    </DxComboBox>
                                    <ValidationMessage For="@(() => Data.AttributeName)" />
                                </span>
                                <span style="@isDisplay1">
                                    <DxComboBox Data="@_attributes"
                                                AllowUserInput="true"
                                                NullText="Select Field..."
                                                ListRenderMode="ListRenderMode.Virtual"
                                                FilteringMode="DataGridFilteringMode.Contains"
                                                TextFieldName="AttributeName"
                                                ValueFieldName="AttributeName"
                                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    @bind-Value="Data.AttributeName"
                                    @bind-Text="Data.AttributeName"
                                                ShowValidationIcon="true"
                                                SelectedItemChanged="@((AttributeHeader plant) => SelectedItemChanged(plant))">
                                    </DxComboBox>
                                    <ValidationMessage For="@(() => Data.AttributeName)" />
                                </span>

                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Add Or Select Field " ColSpanMd="6" Visible="isAddAttributeEnabled">
                                <DxTextBox @bind-Text="Data.AttributeName">
                                    <Buttons>
                                        <DxEditorButton IconCssClass="fa fa-close"
                                                        Tooltip="Close an Attribute"
                                                        Click="@(_ => OnCloseButtonClick())" />
                                    </Buttons>
                                </DxTextBox>
                                <ValidationMessage For="@(() => Data.AttributeName)" />
                            </DxFormLayoutItem>

                            <DxFormLayoutItem Caption="Label Name" ColSpanMd="6">
                                <DxTextBox @bind-Text="@Data.Description"></DxTextBox>
                                <ValidationMessage For="@(() => Data.Description)" />
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Control Type" ColSpanMd="6">
                                <DxComboBox Data="@_controlTypeData"
                                            NullText="Select ControlType..."
                                            FilteringMode="DataGridFilteringMode.Contains"
                                            TextFieldName="CodeValue"
                                            ValueFieldName="CodeId"
                                            Enabled="isEdit"
                                            EditFormat="{0}-{1}"
                                            SelectedItemChanged="@((CodeMaster plant) =>SelectedControlChanged(plant?.CodeId,"Add"))"
                                @bind-Value="@Data.ControlTypeId">
                                    <Columns>
                                        <DxListEditorColumn FieldName="@nameof(CodeMaster.CodeValue)"
                                                            Caption="Control Type"
                                                            Width="100px" />
                                        <DxListEditorColumn FieldName="@nameof(CodeMaster.CodeDescription)"
                                                            Caption="Description" Width="300px" />

                                    </Columns>
                                </DxComboBox>
                                <ValidationMessage For="@(() => Data.ControlTypeId)" />
                            </DxFormLayoutItem>
                           @*  <DxFormLayoutItem Caption="Dropdown Type" ColSpanMd="6" Visible="@isDropDownType">
                                <DxComboBox Data="@DropDownTypeItems"
                                            NullText="Select Dropdown Type..."
                                            FilteringMode="DataGridFilteringMode.Contains"
                                            TextFieldName="Text"
                                            ValueFieldName="Value"
                                            SelectedItemChanged="@((DropDownOptionsModel plant) =>SelectedDropDownTypeChanged(plant))"
                                @bind-Value="@Data.DropDownTypeId">
                                </DxComboBox>
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Data Source" ColSpanMd="6" Visible="@isDataSource">
                                <DxComboBox Data="@DataSourceItems"
                                            NullText="Select Data Source..."
                                            FilteringMode="DataGridFilteringMode.Contains"
                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                            TextFieldName="Text"
                                            ValueFieldName="Value"
                                @bind-Value="@Data.DataSourceId">

                                </DxComboBox>
                                <ValidationMessage For="@(() => Data.DataSourceId)" />
                            </DxFormLayoutItem> *@
                            <DxFormLayoutItem Caption="Entry Mask" ColSpanMd="6">
                                <DxTextBox @bind-Text="Data.EntryMask" Enabled="@MaskEnabled"></DxTextBox>
                            </DxFormLayoutItem>
                            <DxFormLayoutItem Caption="Reg.Exp" ColSpanMd="6">
                                <DxTextBox @bind-Text="Data.RegExp" Enabled="@RegEnabled"></DxTextBox>
                            </DxFormLayoutItem>

                        </DxFormLayout>

                    </EditForm>
                </div>
            </div>
        </div>
    </div>
    <div style="height:60%;border: 1px solid #b2afaf; overflow: auto; padding:10px;">


        <div class="mini-menu-bar-top">
            <div class="mini-menu-bar-heading">
            </div>

            <div>
                <div class="views-accordion">
                    <AttributeDetailsSetup @ref=RefDetails></AttributeDetailsSetup>
                </div>
            </div>
        </div>

    </div>
</div>

<DxPopup @bind-Visible="@Blukdeletepopup"
         ShowFooter="true"
         HeaderText="CRT"
         Closed="EulaPopupClosed"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Do you want to delete
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="((e) => bulkDelete())" />
    </FooterContentTemplate>
</DxPopup>
@code {
    string FormSubmitResult = "";
    private AttributeDetailsSetup? RefDetails { get; set; }
    bool DeleteEnabled { get; set; } = false;
    bool MaskEnabled { get; set; } = false;
    bool RegEnabled { get; set; } = false;
    bool isMultipleEnabled { get; set; } = false;
    bool Blukdeletepopup { get; set; } = false;
    bool isSelectEnabled { get; set; } = true;
    bool isAddAttributeEnabled { get; set; } = false;
    bool isEdit { get; set; } = true;
    private bool loading;
    private string MyID = "myid";
    long AttributeIDs;
    private List<AttributeHeader>? _attributes;
    string? isDisplay = "display:none;";
    string? isDisplay1 = "";
    AttributeHeader Data = new AttributeHeader();
    private List<CodeMaster> _stausItems;
    private List<ApplicationUser> _applicationUsers;
    private CodeMaster? codemaster;
    public ApplicationUser? applicationUser { get; private set; }
    private List<AttributeHeader>? _master;
    private List<AttributeHeader>? _SaveLst;
    AttributeHeader AttributeNamelst = new AttributeHeader();
    private List<string> ControlTypeChildData = new List<string> { "ComboBox", "ListBox", "TagBox", "Radio" };
    private List<DropDownOptionsModel> DropDownTypeItems { get; set; } = new List<DropDownOptionsModel>();
    private List<DropDownOptionsModel> DataSourceItems { get; set; } = new List<DropDownOptionsModel>();
    private List<CodeMaster> _controlTypeData;
    bool isDropDownType { get; set; } = false;
    bool isDataSource { get; set; } = false;
    protected override async Task OnInitializedAsync()
    {
        DropDownTypeItems.Add(new DropDownOptionsModel() { Value = "InBuild", Text = "InBuild" });
        DropDownTypeItems.Add(new DropDownOptionsModel() { Value = "DataSource", Text = "Data Source" });
        loadDataSourceItems();
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("Status"));
        _controlTypeData = await Mediator.Send(new GetAllCodeMasterQuery("AttributeControlType"));
        isAddAttributeEnabled = false;
        isSelectEnabled = true;
        await loadData();
    }
    void loadDataSourceItems()
    {
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "Employee", Text = "Employee" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "NAVCustomer", Text = "Customer" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "NavItems", Text = "Nav Items" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "NAVVendor", Text = "Vendor" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "Plant", Text = "Company" });
        DataSourceItems.Add(new DropDownOptionsModel() { Value = "Department", Text = "Department" });
    }
    async Task loadData()
    {
        _attributes = await Mediator.Send(new GetAllAttributeNameHeader());
        StateHasChanged();
    }
    void addNew()
    {
        Data = new AttributeHeader();
        isAddAttributeEnabled = false;
        isSelectEnabled = true;
        isDisplay = "display:none;";
        isDisplay1 = "";
        RefDetails.Attributeload(0, "");
        isEdit = true;
        DeleteEnabled = false;
        isDropDownType = false;
        isDataSource = false;
        StateHasChanged();
    }
    void addDelete()
    {
        Blukdeletepopup = true;
    }
    void HandleInvalidSubmit()
    {
        FormSubmitResult = "";
    }

    async Task HandleValidSubmit()
    {
        var ex = _attributes.Where(x => x.AttributeName == Data.AttributeName);
        if (Data.AttributeID > 0)
        {
            var ex1 = _attributes.Where(x => x.AttributeName == Data.AttributeName && x.AttributeID != Data.AttributeID);
            if (ex1.Any())
            {
                toastService.ShowToast("The entered value Already exists.", AC.SD.Core.Services.ToastLevel.Error);
            }
            else
            {
                await createAttributes();
                toastService.ShowToast("Attribute Updated  successully.", AC.SD.Core.Services.ToastLevel.Success);
            }
        }
        else
        {
            if (ex.Any())
            {
                toastService.ShowToast("The entered value Already exists.", AC.SD.Core.Services.ToastLevel.Error);
            }
            else
            {
                await createAttributes();
                DeleteEnabled = true;
                toastService.ShowToast("Attribute have been saved successully.", AC.SD.Core.Services.ToastLevel.Success);
            }
        }
    }
    void OnEditButtonClick()
    {
        isAddAttributeEnabled = true;
        isSelectEnabled = false;
        StateHasChanged();
    }
    void OnCloseButtonClick()
    {
        isAddAttributeEnabled = false;
        isSelectEnabled = true;
        StateHasChanged();
    }
    async Task createAttributes()
    {
        string? DropDownTypeId = Data.ControlTypeId == 2702 || Data.ControlTypeId == 2708 ? Data.DropDownTypeId : null;
        string? dataSourceId = Data.ControlTypeId == 2702 || Data.ControlTypeId == 2708 ? Data.DataSourceId : null;
        var createReq = new CreateAttributeHeader
            {
                AttributeID = Data.AttributeID,
                AttributeName = Data.AttributeName,
                Description = Data.Description,
                ControlType = Data.ControlType,
                IsInternal = Data.IsInternal,
                EntryMask = Data.EntryMask,
                RegExp = Data.RegExp,
                ControlTypeId = Data.ControlTypeId,
                IsMultiple = Data.IsMultiple,
                IsRequired = Data.IsRequired,
                RequiredMessage = Data.RequiredMessage,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now,
                SessionId = Data.SessionId == null ? Guid.NewGuid() : Data.SessionId,
                DataSourceId = dataSourceId,
                DropDownTypeId = DropDownTypeId,
            };
        var result = await Mediator.Send(createReq);
        if (result > 0)
        {
            Data.AttributeID = result;
            var controlType = _controlTypeData.FirstOrDefault(f => f.CodeId == Data.ControlTypeId)?.CodeValue;
            if (controlType != null)
            {
                var isChildData = ControlTypeChildData.FirstOrDefault(f => controlType.ToLower().Contains(f.ToLower()));
                if (isChildData != null)
                {
                    if (Data.DropDownTypeId != "DataSource")
                    {
                        RefDetails.Attributeload(Data.AttributeID, controlType);
                    }
                    else
                    {
                        RefDetails.Attributeload(Data.AttributeID, null);
                    }
                }
                else
                {
                    RefDetails.Attributeload(Data.AttributeID, null);
                }
                isDisplay1 = "display:none;";
                isDisplay = "";
            }
        }
        isAddAttributeEnabled = false;
        isSelectEnabled = true;
        StateHasChanged();
        await loadData();


    }
    async void SelectedItemChanged(AttributeHeader header)
    {
        isEdit = true; DeleteEnabled = false;
        isDropDownType = false; isDataSource = false;
        isDisplay = "display:none;";
        isDisplay1 = "";
        if (header != null)
        {
            if (header.AttributeID > 0)
            {
                loadDropDownList(header.AttributeID);
            }
        }
        else
        {
            Data.Description = null;
            Data.EntryMask = null;
            Data.RegExp = null;
            Data.IsInternal = false;
            Data.ControlTypeId = null;
            Data.IsMultiple = false;
            Data.IsRequired = false;
            Data.RequiredMessage = null;
            Data.AttributeID = 0;
            Data.AttributeName = null;
            Data.SessionId = null;
            Data.DataSourceId = null;
            Data.DropDownTypeId = null;
            if (Data.AttributeID > 0)
            {
                loadDropDownList(Data.AttributeID);
            }
            else
            {
                RefDetails.Attributeload(Data.AttributeID, null);
            }
        }
    }
    void loadDropDownList(long? AttributeID)
    {
        isDisplay = "display:none;";
        isDisplay1 = "";
        DeleteEnabled = false; Data.DropDownTypeId = null;
        _master = _attributes.Where(c => c.AttributeID == AttributeID).ToList();
        if (_master != null && _master.Count > 0)
        {
            isDisplay = ""; isDisplay1 = "display:none;";
            Data.Description = _master[0].Description;
            Data.EntryMask = _master[0].EntryMask;
            Data.RegExp = _master[0].RegExp;
            Data.IsInternal = _master[0].IsInternal;
            Data.ControlTypeId = _master[0].ControlTypeId;
            Data.IsMultiple = _master[0].IsMultiple;
            Data.IsRequired = _master[0].IsRequired;
            Data.RequiredMessage = _master[0].RequiredMessage;
            Data.AttributeID = _master[0].AttributeID;
            Data.AttributeName = _master[0].AttributeName;
            Data.SessionId = _master[0].SessionId;
            Data.DataSourceId = _master[0].DataSourceId;
            Data.DropDownTypeId = _master[0].DropDownTypeId;
            SelectedControlChanged(Data.ControlTypeId,"Edit");
            var isChildData = ControlTypeChildData.FirstOrDefault(f => _master[0].ControlType.ToLower().Contains(f.ToLower()));
            DeleteEnabled = true;
            if (_master[0].FormUsedCount > 0)
            {
                isEdit = false;
                DeleteEnabled = false;
            }
            if (Data.DropDownTypeId == "DataSource")
            {
                isDataSource = true;
            }
            if (isChildData != null)
            {
                if (Data.DropDownTypeId != "DataSource")
                {
                    RefDetails.Attributeload(_master[0].AttributeID, _master[0].ControlType);
                }
                else
                {
                    RefDetails.Attributeload(Data.AttributeID, null);
                }
            }
            else
            {
                RefDetails.Attributeload(_master[0].AttributeID, null);
            }
        }
        else
        {
            RefDetails.Attributeload(Data.AttributeID, null);
        }
    }
    void SelectedDropDownTypeChanged(DropDownOptionsModel MyString)
    {
        isDataSource = false;
        if (MyString != null && MyString.Value == "DataSource")
        {
            isDataSource = true;
        }
        StateHasChanged();
    }
    void SelectedControlChanged(int? controlTypeId,string type)
    {
        isMultipleEnabled = false;
        MaskEnabled = false;
        RegEnabled = false; isDropDownType = false;
        isDataSource = false;
        if (type == "Add")
        {
            Data.DropDownTypeId = "InBuild";
            Data.DataSourceId = null;
        }
        if (controlTypeId > 0)
        {
            var controlType = _controlTypeData.FirstOrDefault(f => f.CodeId == controlTypeId)?.CodeValue;
            if (!string.IsNullOrEmpty(controlType))
            {
                var isChildData = ControlTypeChildData.FirstOrDefault(f => controlType.ToLower().Contains(f.ToLower()));
                if (isChildData != null)
                {
                    isMultipleEnabled = true;
                }
                if (controlType == "TextBox")
                {
                    MaskEnabled = true;
                    RegEnabled = true;
                }
            }
            if (controlTypeId == 2702 || controlTypeId == 2708)
            {
                if (Data.AttributeID == 0)
                {
                    Data.DropDownTypeId = "InBuild";
                }
                isDropDownType = true;
            }
        }
    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        Blukdeletepopup = false;
    }
    async Task bulkDelete()
    {
        try
        {
            var request = new DeleteAttributeHeader(Data.AttributeID);
            await Mediator.Send(request);
            Blukdeletepopup = false;
            toastService.ShowToast("Attribute have been Deleted successully.", AC.SD.Core.Services.ToastLevel.Success);

            addNew();
            await loadData();
            RefDetails.Attributeload(_master[0].AttributeID, "");
        }
        catch (Exception eq)
        {
            Blukdeletepopup = false;
            toastService.ShowToast("You Must Delete ValueID.", AC.SD.Core.Services.ToastLevel.Error);
        }

    }
}