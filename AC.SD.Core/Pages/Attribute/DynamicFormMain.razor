@page "/dynamicMainForm"

@using System.Linq.Expressions
@using System.ComponentModel.DataAnnotations
@using global::Core.AttributeDynamicData;
@using global::Core.Entities.Views;
@inject IMediator Mediator
@using global::Core.Entities;
@using Application.Queries;
@using MediatR
<DxFormLayout CssClass="w-100">
    <EditForm EditContext="this._editContexts" Context="EditFormContext">
        <DataAnnotationsValidator />
        <DxFormLayoutGroup ColSpanMd="12" Caption="Profile No" ExpandButtonDisplayMode="GroupExpandButtonDisplayMode.Start" Expanded="true" AnimationType="LayoutAnimationType.Slide">
            <Items>
                <DxFormLayoutItem Caption="Profile No" ColSpanMd="12">
                    <DxTextBox @bind-Text="@Datas.ProfileNo" Enabled="false" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                    <DxComboBox Data="@_plantItems"
                                NullText="Select Company..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.Default"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                TextFieldName="PlantCode"
                                ValueFieldName="PlantID"
                                SelectedItemChanged="@((ViewPlants plantSelect) => SelectedItemChanged(plantSelect?.PlantID))"
                                @bind-Value="@Datas.PlantId" ShowValidationIcon="true">
                        <Columns>
                            <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                Caption="Plant Code"
                                                Width="180px" />
                            <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                Caption="Description" />
                            <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                                Caption="Nav Company" />
                        </Columns>
                    </DxComboBox>
                    <ValidationMessage For="@(() => Datas.PlantId)" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Division" ColSpanMd="6">
                    <DxComboBox Data="@_divisionItems"
                                NullText="Select Division..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.Default"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                TextFieldName="Name"
                                ValueFieldName="DivisionID"
                                SelectedItemChanged="@((ViewDivision plantSelect) => SelectedItemDivisionChanged(plantSelect?.DivisionID))"
                                @bind-Value="@Datas.DivisionId" ShowValidationIcon="true">
                        <Columns>
                            <DxListEditorColumn FieldName="@nameof(ViewDivision.Name)"
                                                Caption="Name"
                                                Width="180px" />
                            <DxListEditorColumn FieldName="@nameof(ViewDivision.Code)"
                                                Caption="Code" />
                            <DxListEditorColumn FieldName="@nameof(ViewDivision.Description)"
                                                Caption="Description" />
                        </Columns>
                    </DxComboBox>
                    <ValidationMessage For="@(() => Datas.DivisionId)" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Department" ColSpanMd="6">
                    <DxComboBox Data="@_departmentItems"
                                NullText="Select Department..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.Default"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                TextFieldName="DepartmentName"
                                ValueFieldName="DepartmentId"
                                SelectedItemChanged="@((ViewDepartment plantSelect) => SelectedItemDepartementChanged(plantSelect?.DepartmentId))"
                                @bind-Value="@Datas.DepartmentId" ShowValidationIcon="true">
                        <Columns>
                            <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentName)"
                                                Caption="Name"
                                                Width="180px" />
                            <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentCode)"
                                                Caption="Code" />
                            <DxListEditorColumn FieldName="@nameof(ViewDepartment.Description)"
                                                Caption="Description" />
                        </Columns>
                    </DxComboBox>
                    <ValidationMessage For="@(() => Datas.DepartmentId)" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Section" ColSpanMd="6">
                    <DxComboBox Data="@_sectionItems"
                                NullText="Select Section..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.Default"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                TextFieldName="SectionName"
                                ValueFieldName="SectionId"
                                SelectedItemChanged="@((ViewSection plantSelect) => SelectedItemSectionChanged(plantSelect?.SectionId))"
                                @bind-Value="@Datas.SectionId" ShowValidationIcon="true">
                        <Columns>
                            <DxListEditorColumn FieldName="@nameof(ViewSection.SectionName)"
                                                Caption="Name"
                                                Width="180px" />
                            <DxListEditorColumn FieldName="@nameof(ViewSection.SectionCode)"
                                                Caption="Code" />
                            <DxListEditorColumn FieldName="@nameof(ViewSection.Description)"
                                                Caption="Description" />
                        </Columns>
                    </DxComboBox>
                    <ValidationMessage For="@(() => Datas.SectionId)" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="SubSection" ColSpanMd="6">
                    <DxComboBox Data="@_subSectionItems"
                                NullText="Select SubSection..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.Default"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                TextFieldName="SubSectionName"
                                ValueFieldName="SubSectionId"
                                @bind-Value="@Datas.SubSectionId" ShowValidationIcon="true">
                        <Columns>
                            <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionName)"
                                                Caption="Name"
                                                Width="180px" />
                            <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionCode)"
                                                Caption="Code" />
                            <DxListEditorColumn FieldName="@nameof(ViewSubSection.Description)"
                                                Caption="Description" />
                        </Columns>
                    </DxComboBox>
                    <ValidationMessage For="@(() => Datas.SubSectionId)" />
                </DxFormLayoutItem>
            </Items>
        </DxFormLayoutGroup>
    </EditForm>
</DxFormLayout>

@code {
    EditContext _editContexts;
    private List<ViewPlants>? _plantItems;
    private List<ViewDivision>? _divisionItems;
    private List<ViewDepartment>? _departmentItems;
    private List<ViewSection>? _sectionItems;
    private List<ViewSubSection>? _subSectionItems;
    DynamicFormProfile Datas = new DynamicFormProfile();
    protected override async Task OnInitializedAsync()
    {
        _editContexts = new EditContext(Datas);
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
    }
    async Task SelectedItemChanged(long? plantID)
    {
        _divisionItems = new List<ViewDivision>();
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (plantID > 0)
        {
            _divisionItems = await Mediator.Send(new GetDivisionByCompany(plantID));
        }
    }
    async Task SelectedItemDivisionChanged(long? divisionId)
    {
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (divisionId > 0)
        {
            _departmentItems = await Mediator.Send(new GetDepartmentByDivision(divisionId));
        }
    }
    async Task SelectedItemDepartementChanged(long? departmentId)
    {
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (departmentId > 0)
        {
            _sectionItems = await Mediator.Send(new GetSectionByDepartment(departmentId));
        }
    }
    async Task SelectedItemSectionChanged(long? sectionId)
    {
        _subSectionItems = new List<ViewSubSection>();
        if (sectionId > 0)
        {
            _subSectionItems = await Mediator.Send(new GetSubSectionBySection(sectionId));
        }
    }
}
