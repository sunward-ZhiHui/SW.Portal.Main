@using Application.Commands;
@using Application.Queries;
@using DevExpress.Export;
@inject IJSRuntime jsRuntime
@using System.IO;
@using System.Text.RegularExpressions;
@using global::Core.Entities;
@using global::Core.Entities.Views;
@inject IMediator Mediator
@using MediatR
@using Microsoft.Extensions.Configuration;
@using global::Core.Repositories.Query;
@inject IConfiguration Configuration;
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@using System.Linq;
@using Microsoft.AspNetCore.Mvc;
@using Microsoft.EntityFrameworkCore;
@using System;
@inject NavigationManager NavigationManager
@inject IJSRuntime jsRuntime
@implements IAsyncDisposable
<style>
    .dxuc-upload-icon {
        display: none; /* or any other style to disable or hide the icon */
    }
</style>
<div class="card w-100" style="margin-bottom:10px;">
    <div class="card-body p-0">
        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@AddFile" />
                <DxMenuItem Text="Edit" IconCssClass="fa fa-pencil" Click="@EditFile" Enabled="@EditEnabled" />
                <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDelete" Enabled="@DeleteEnabled" />
                <DxMenuItem Text="Download" IconCssClass="fa fa-cloud-download" Click="onDocDownload" Enabled="@DownloadEnabled" />
                <DxMenuItem Text="View Document" IconCssClass="fa fa-eye" Click="onPreView" Enabled="@PreviewEnabled" />

            </Items>
        </DxMenu>
    </div>
</div>
<DxLoadingPanel @bind-Visible="PanelVisible"
                IsContentBlocked="true"
                ApplyBackgroundShading="true"
                IndicatorAreaVisible="false"
                Text="Fetching Data...">


    <DxGrid @ref="Grid" Data="@_reportdocuments" ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
            PagerNavigationMode="PagerNavigationMode.InputBox" PageSizeSelectorVisible="true"
            @bind-SelectedDataItems="@SelectedDataItems"
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            PageSizeSelectorAllRowsItemVisible="true"
            PageSizeSelectorItems="@(new int[] { 5,10,20 })"
            PageSize="20" CustomizeElement="Grid_CustomizeElement" style="height: calc(100vh - 220px);"
            CssClass="w-100" AutoExpandAllGroupRows="true"
            SelectionMode="GridSelectionMode.Multiple"
            FocusedRowEnabled="true"
            EditModelSaving="@OnEditModelSaving"
            RowClick="OnRowClick"
            EditMode="GridEditMode.EditForm"
            SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages" VirtualScrollingEnabled="true">
        <Columns>

            <DxGridDataColumn FieldName="Name" MinWidth="150" />
            <DxGridDataColumn FieldName="Description" MinWidth="250" />
            <DxGridDataColumn FieldName="FileName" Width="180" />
            <DxGridDataColumn FieldName="FileSize " MinWidth="150">
                <CellDisplayTemplate>
                    @{
                        var item = (DynamicFormReport)context.DataItem;
                        var sizes = FormatSize(item.FileSize);
                    }
                    @sizes
                </CellDisplayTemplate>
            </DxGridDataColumn>
        </Columns>
        <EditFormTemplate Context="EditFormContext">
            @{
                var documents = (DynamicFormReport)EditFormContext.EditModel;
            }
            <DxFormLayout CssClass="w-100">
                <DxFormLayoutItem Caption="Name:" ColSpanMd="6">
                    <DxTextBox @bind-Text="@documents.Name" />
                    <ValidationMessage For="@(() => documents.Name)" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Description:" ColSpanMd="6">
                    <DxTextBox @bind-Text="@documents.Description" />
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6">
                    <div id="attachmentSelectButton" style="height: 33px;" class="btn border-primary btn-primary m-1 handline">Select File</div>
                    <DxUpload @ref="uploadComponent" Name="files"
                              Visible="@AttachmentUploadVisible"
                              AcceptedFileTypes=@AcceptedFileTypes
                              UploadMode="@UploadMode.OnButtonClick"
                              FileUploadStart="OnFileUploadStart"
                              ChunkSize="200000"
                              AllowMultiFileUpload="true"
                              ExternalSelectButtonCssSelector="#attachmentSelectButton"
                              SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                              FileUploaded="@isUploadSuccess"
                              FileUploadProgressChanged="@OnUploadProgressChanged"
                              FileUploadStarted="@OnFileUploadStarted"
                              FileUploadError="@OnUploadError">
                    </DxUpload>
                </DxFormLayoutItem>
                <ValidationSummary />
            </DxFormLayout>
        </EditFormTemplate>
    </DxGrid>


</DxLoadingPanel>
<DxPopup @bind-Visible="@Blukdeletepopup"
         ShowFooter="true"
         HeaderText="CRT"
         Closed="EulaPopupClosed"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Do you want to delete
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="@((e) => bulkDelete(_selectedItems))" />
    </FooterContentTemplate>
</DxPopup>

@code {
    private byte[] fileContent;
    private string fileName;
    private string uploadStatus;
    public bool EnableUpload { get; set; } = false;
    int SelectedFilesCount { get; set; }
    int CurrentUplodCount { get; set; }
    bool UploadPopUp { get; set; } = false;
    string MyMessage { get; set; }
    bool AttachmentUploadVisible { get; set; } = false;
    private DxUpload uploadComponent;
    bool EditEnabled { get; set; } = false;
    bool DeleteEnabled { get; set; } = false;
    bool DownloadEnabled { get; set; } = false;
    bool PreviewEnabled { get; set; } = false;
    bool UploadVisible { get; set; } = false;
    IEnumerable<UploadFileInfo> Files { get; set; }
    UploadFileInfo FirstFile { get; set; }
    DxUpload MyUpload { get; set; }
    DynamicFormReport? Data { get; set; } = new DynamicFormReport();
    private DynamicFormReport _selectedItems;
    public ApplicationUser applicationUser { get; private set; }
    Guid? _sessionId;
    [Parameter]
    public DynamicForm? _dynamicform { get; set; }
    [Parameter]
    public List<string> AcceptedFileTypes { get; set; } = new List<string> { ".repx" };

    IReadOnlyList<object> SelectedDataItems { get; set; }
    bool PanelVisible { get; set; }
    private List<DynamicFormReport> _reportdocuments;
    IGrid Grid { get; set; }

    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    bool isFileUpload = false;
    string MyError { get; set; }
    bool ErrorVisible { get; set; } = false;
    bool Blukdeletepopup { get; set; } = false;
    string Message = "Upload";
    protected override async Task OnInitializedAsync()
    {
        PanelVisible = true;
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        await UpdateDataAsync();
        PanelVisible = false;

    }
    void OnUploadProgressChanged(FileUploadEventArgs e)
    {
        var progress = e.FileInfo.LoadedBytes / e.FileInfo.Size * 100;
    }
    void OnFileUploadStarted(FileUploadEventArgs e)
    {
        MyMessage = "Upload of the " + e.FileInfo.Name + " file was started.";
        toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Info);
        InvokeAsync(StateHasChanged);
    }
    async Task OnFileUploadStart(FileUploadStartEventArgs e)
    {
        Message = "Uploading...";


        var SessionId = _sessionId;
        string BaseUrl = NavigationManager.BaseUri + "api/FileUpload/";
        string url = BaseUrl + "UploadDynamicFormReportFile?SessionId=" + _sessionId + "&addedByUserId=" + applicationUser.UserID;
        e.UploadUrl = url;
        await Task.Delay(3000);
    }
    async Task UpdateDataAsync()
    {
        var model = await Mediator.Send(new GetDynamicFormReportList(_dynamicform.ID));
        _reportdocuments = model;
        if (_reportdocuments.Count > 0)
        {
            _selectedItems = _reportdocuments.FirstOrDefault();

            EditEnabled = true;
            DeleteEnabled = true;
            PreviewEnabled = true;
            DownloadEnabled = true;
            StateHasChanged();

        }
        else
        {
            EditEnabled = false;
            DeleteEnabled = false;
            PreviewEnabled = false;
            DownloadEnabled = false;
            EnableUpload = false;
        }

    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }

    }


    private void isUploadSuccess(FileUploadEventArgs e)
    {
        MyMessage = "Upload of the " + e.FileInfo.Name + " file is Completed.";
        toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Success);
        CurrentUplodCount++;

        if (CurrentUplodCount >= SelectedFilesCount)
        {
            Message = "Upload";


            UpdateDataAsync();
            UploadPopUp = false;
        }
        InvokeAsync(StateHasChanged);

    }

    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }
    public static string FormatSize(long? bytes)
    {
        string[] suffixes = { "Bytes", "KB", "MB", "GB", "TB", "PB" };
        int counter = 0;
        decimal number = (decimal)bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number = number / 1024;
            counter++;
        }
        return string.Format("{0:n1} {1}", number, suffixes[counter]);
    }
    public void AddFile()
    {
        Grid.StartEditNewRowAsync();
    }
    public async Task onDocDownload()
    {
        if (_selectedItems != null)
        {
            var request = new DownloadDynamicFormReportFileRequest
                {
                    FileName = _selectedItems.FileName,
                    SessionId = _selectedItems.SessionId,
                };
            var response = await Mediator.Send(request);

            await jsRuntime.InvokeVoidAsync("downloadFile", response.FileName + ".repx", response.FileData, "");
        }
    }
    void OnRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "DynamicFormReportId");
        _selectedItems = _reportdocuments.FirstOrDefault(f => f.DynamicFormReportId == (long?)UniqueId);
        EnableUpload = true;
    }


    async Task OnEditModelSaving(GridEditModelSavingEventArgs e)
    {
        var editModel = (DynamicFormReport)e.EditModel;
        if (e.IsNew)
        {
            var createReq = new InsertDynamicFormReport
                {
                    DynamicFormReportId = editModel.DynamicFormReportId,
                    FileName = editModel.FileName,
                    Name = editModel.Name,
                    DynamicFormId = _dynamicform.ID,
                    SessionId = Guid.NewGuid(),
                    AddedByUserId = applicationUser.UserID,
                    ModifiedByUserId = applicationUser.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeId = 1,
                    AddedDate = DateTime.Now,
                    FilePath = editModel.FilePath,
                    Description = editModel.Description
                };

            try
            {
                var result = await Mediator.Send(createReq);
                if (result != null)
                {
                    if (SelectedFilesCount > 0)
                    {
                        _sessionId = result.SessionId;
                        uploadComponent.UploadAllFiles();
                        await Task.Delay(5000);
                    }
                    await UpdateDataAsync();
                }
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
            }
            catch (Exception eq)
            {


            }
            await UpdateDataAsync();
        }
        else
        {
            var UpdateReq = new InsertDynamicFormReport
                {
                    DynamicFormReportId = editModel.DynamicFormReportId,
                    FileName = editModel.FileName,
                    Name = editModel.Name,
                    DynamicFormId = _dynamicform?.ID,
                    SessionId = editModel.SessionId == null ? Guid.NewGuid() : editModel.SessionId,
                    AddedByUserId = editModel.AddedByUserId,
                    ModifiedByUserId = applicationUser.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeId = 1,
                    AddedDate = editModel.AddedDate,
                    FilePath = editModel.FilePath,
                    Description = editModel.Description

                };
            var result = await Mediator.Send(UpdateReq);
            if (result != null)
            {
                if (SelectedFilesCount > 0)
                {
                    _sessionId = result.SessionId;
                    uploadComponent.UploadAllFiles();
                    await Task.Delay(5000);
                }
                await UpdateDataAsync();
            }
            toastService.ShowToast("Record Updated Successfully", AC.SD.Core.Services.ToastLevel.Success);


        }
    }
    protected void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
        SelectedFilesCount = files.ToList().Count; //Count current files
        InvokeAsync(StateHasChanged);
        if (SelectedFilesCount == 1)
        {
            var file = files.FirstOrDefault();
            var name = file.Name;
            fileName = Path.GetFileNameWithoutExtension(name);
            var ext = Path.GetExtension(name);

            if (ext != ".repx")
            {
                toastService.ShowToast("The Record Format Is Not Supported", AC.SD.Core.Services.ToastLevel.Error);
            }
        }
        else
        {
            var MyMessage = "Upload Only One File Allowed. Remove Another Files.";
            toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Error);
        }
    }
    public async Task onPreView()
    {
        if (_selectedItems != null)
        {
            await jsRuntime.InvokeVoidAsync("window.open", "reportFileUploads/ReportViewer/" + _selectedItems.SessionId + "", "_blank");
        }
    }


    void EditFile()
    {
        Grid.StartEditDataItemAsync(_selectedItems);
    }

    async Task bulkDelete(DynamicFormReport reportdocument)
    {
        var request = new DeleteDynamicFormReport(reportdocument);
        await Mediator.Send(request);
        toastService.ShowToast("Record deleted Successfully", AC.SD.Core.Services.ToastLevel.Success);
        Blukdeletepopup = false;
        await UpdateDataAsync();
    }
    void addDelete()
    {
        Blukdeletepopup = true;
    }
    async Task EulaPopupClosed(PopupClosedEventArgs args)
    {

        Blukdeletepopup = false;

        await UpdateDataAsync();
    }
    void OnUpload()
    {
        UploadPopUp = true;
    }

    public void OnUploadReport(Guid? SessionID)
    {
        _sessionId = SessionID;
        uploadComponent.UploadAllFiles();
    }
    public void clearData()
    {
        Files = null;
        Data= new DynamicFormReport();
        _selectedItems=null;
        SelectedDataItems = null;
        _reportdocuments?.Clear();
        SelectedFiles?.Clear();
    }
    public async ValueTask DisposeAsync()
    {
       // System.GC.Collect();
        clearData();
        //GC.SuppressFinalize(this);
    }
}