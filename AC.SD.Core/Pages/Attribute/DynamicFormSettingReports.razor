@page "/DynamicMasterSetup/DynamicMasterSetupSettingReport"
@page "/DynamicMasterSetup/DynamicMasterSetupSettingReport/{SessionIds:guid}"
@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject ClipboardService ClipboardService
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@* @inject AC.SD.Core.Helpers.TreeGenerateRecursive _treeGenerateRecursive *@
@inject NavigationManager NavigationManager
@implements IAsyncDisposable
<div class="card w-100" style="margin-bottom:10px;">
    <div class="card-body p-0">
        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
               
            </Items>
        </DxMenu>
    </div>
</div>
<div class="" style="overflow-x: hidden;overflow-y: auto;height: calc(100vh - 210px);">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />

                    <DxFormLayoutItem Caption="User Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.AddedBy" ShowValidationIcon="true" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.AddedDate" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                        <DxComboBox Data="@_plantItems"
                                    NullText="Select Company..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="NavCompany"
                                    ValueFieldName="PlantID"
                                    Value="@Data.CompanyId"
                                    Enabled=false
                                    ValueExpression="@(() => Data.CompanyId )"
                                    ValueChanged="@((long? plantData) => SelectedPlantChanged(plantData))"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Company Code"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompany)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.CompanyId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Profile" ColSpanMd="6">
                        <DxComboBox Data="@_documentProfileNoList"
                                    NullText="Select Profile..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Name"
                                    ValueFieldName="ProfileID"
                                    Value="@Data.ProfileId"
                                    Enabled=false
                                    ValueExpression="@(() => Data.ProfileId )"
                                    ValueChanged="@((long? plantData) => SelectedProfileChanged(plantData))"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.Name)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.Abbreviation)"
                                                    Caption="Abbreviation" />
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.SampleDocumentNo)"
                                                    Caption="Sample Document No" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.ProfileId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Screen Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.ScreenID" Enabled=false ShowValidationIcon="true"></DxTextBox>

                        <ValidationMessage For="@(() => Data.ScreenID)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Form Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.Name" Enabled=false ShowValidationIcon="true"></DxTextBox>
                        <ValidationMessage For="@(() => Data.Name)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Approval Level" ColSpanMd="6">
                        <DxCheckBox Enabled=false @bind-Checked="@Data.IsApproval"></DxCheckBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Is Grid Form" ColSpanMd="6">
                        <DxCheckBox Enabled=false @bind-Checked="@Data.IsGridForm"></DxCheckBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="SW Library" ColSpanMd="6" Visible="@Data.IsUpload">
                        <DxTextBox Enabled=false NullText="SW Library..." @bind-Text="@LinkFilterFileprofiletypeName" CssClass="cw-480">

                        </DxTextBox>
                        <DxSpinEdit Enabled=false @bind-Value="@Data.FileProfileTypeId" BindValueMode="BindValueMode.OnInput" style="display:none;" />
                        <ValidationMessage For="@(() => Data.FileProfileTypeId)" />
                    </DxFormLayoutItem>

                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Section Entry">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionSettingForm @ref="refDynamicMasterSectionSettingForm" dynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionSettingForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Approval Level">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormApprovals @ref="refDynamicFormApprovals" dynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormApprovals>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Section Permission">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.PermissionSectionList @ref="refPermissionSectionList" DynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.PermissionSectionList>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="WorkFlow">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormWorkFlows @ref="refDynamicFormWorkFlows" dynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormWorkFlows>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="WorkFlow Approval User">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormWorkFlowApprovals @ref="refDynamicFormWorkFlowApprovals" dynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormWorkFlowApprovals>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Attribute Form">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionAttributeForm @ref="refDynamicMasterSectionAttributeForm" DynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionAttributeForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Formula">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionAttributeForm @ref="refDynamicMasterSectionAttributeFormulaForm" IsFormula="true" DynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionAttributeForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Control Permission">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormSectionAttributePermissionList @ref="refDynamicFormSectionAttributePermissionList"  DynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormSectionAttributePermissionList>
                            </DxFormLayoutTabPage>
                             <DxFormLayoutTabPage Caption="Control Value">
                                <AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormSectionAttributeSectionForm @ref="refDynamicFormSectionAttributeSectionForm"  DynamicFormId="@dynamicFormId"></AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormSectionAttributeSectionForm>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>
        </div>
    </div>


</div>
@code {
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormSectionAttributePermissionList refDynamicFormSectionAttributePermissionList { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionSettingForm refDynamicMasterSectionSettingForm { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.PermissionSectionList refPermissionSectionList { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormWorkFlows refDynamicFormWorkFlows { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormApprovals refDynamicFormApprovals { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormWorkFlowApprovals refDynamicFormWorkFlowApprovals { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionAttributeForm refDynamicMasterSectionAttributeForm { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicMasterSectionAttributeForm refDynamicMasterSectionAttributeFormulaForm { get; set; }
    private AC.SD.Core.Pages.Attribute.DynamicFormSettingForm.DynamicFormSectionAttributeSectionForm refDynamicFormSectionAttributeSectionForm { get; set; }
    int ActiveSubTabIndex { get; set; } = 0;
    public List<DocumentsModel> fileProfileTypeDocumentsAll { get; set; }
    string? FilterDocumentString { get; set; }
    EditContext _editContext;
    public long? dynamicFormId { get; set; }
    [Parameter]
    public Guid? SessionIds { get; set; }
    public DynamicForm _dynamicFormData;
    private bool loading;
    private string MyID = "myid";
    long? EmployeeIds { get; set; }
    private DynamicForm Data = new DynamicForm();
    public ApplicationUser applicationUser { get; private set; }
    string? LinkFilterFileprofiletypeName { get; set; } = null;
    IEnumerable<DocumentsModel> _selectedTreeItems = new List<DocumentsModel>();
    private List<ViewPlants>? _plantItems;
    public List<DocumentProfileNoSeriesModel> _documentProfileNoList { get; set; }
    private List<DynamicFormSection>? _dynamicFormSectionData;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _plantItems = await Mediator.Send(new GetAllPlantByNavCompanyQuery());
        fileProfileTypeDocumentsAll = await Mediator.Send(new GetAllfileprofiletypeListQuery());
        _documentProfileNoList = await Mediator.Send(new GetDocumentProfiles());
    }
    void backUrl()
    {
        string str = NavigationManager.Uri;
        string rep1 = str.Replace(NavigationManager.BaseUri, "").ToLower();
        string[] UrlList = rep1.Split("/");
        string names = "DynamicMasterSetup";
        if (UrlList[0].ToLower() == "DynamicFormWorkFlowList".ToLower())
        {
            NavigationManager.NavigateTo("DynamicMasterSetup");
        }
        else
        {
            NavigationManager.NavigateTo("DynamicMasterSetup");
        }
    }
    void SelectedPlantChanged(long? country)
    {
        Data.CompanyId = null;
        if (country > 0)
        {
            Data.CompanyId = country;
        }
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
            await refDynamicMasterSectionSettingForm.loadChildData(dynamicFormId);
        }
        else if (e.TabIndex == 1)
        {
            //await refPermissionSectionList.loadData(dynamicFormId);
        }
    }
    public async ValueTask DisposeAsync()
    {
        fileProfileTypeDocumentsAll?.Clear();

        Data = new DynamicForm();
        _selectedTreeItems = null;
        _plantItems?.Clear();
        _documentProfileNoList?.Clear();
    }
    protected override async Task OnParametersSetAsync()
    {
        if (applicationUser != null)
        {
            await OnParametersSetLoadAsync();
        }
        base.OnParametersSet();
    }
    void SelectedProfileChanged(long? country)
    {
        Data.ProfileId = null;
        if (country > 0)
        {
            Data.ProfileId = country;
        }
    }
    async Task OnParametersSetLoadAsync()
    {
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedBy = applicationUser.UserName;
        Data.ID = 0;
        Data.IsApproval = false;
        dynamicFormId = -1;
        Data.ModifiedByUserID = null;
        Data.AddedByUserID = null;
        Data.ModifiedDate = null;
        Data.ModifiedBy = null;
        Data.ScreenID = null;
        Data.Name = null;
        Data.SessionId = null;
        Data.IsGridForm = false;
        Data.StatusCodeID = null; Data.CompanyId = null; Data.ProfileId = null;
        Data.IsApproval = false;
        Data.IsUpload = true; Data.FileProfileTypeId = null; LinkFilterFileprofiletypeName = null;
        if (SessionIds != null)
        {
            var dynamicFormData = await Mediator.Send(new GetDynamicFormBySession(SessionIds));
            if (dynamicFormData != null)
            {
                _dynamicFormData = dynamicFormData;
                dynamicFormId = dynamicFormData.ID;
                Data.ID = dynamicFormData.ID;
                Data.AddedBy = dynamicFormData.AddedBy;
                Data.ModifiedByUserID = dynamicFormData.ModifiedByUserID;
                Data.AddedByUserID = dynamicFormData.AddedByUserID;
                Data.AddedDate = dynamicFormData.AddedDate;
                Data.ModifiedDate = dynamicFormData.ModifiedDate;
                Data.ModifiedBy = dynamicFormData.ModifiedBy;
                Data.ScreenID = dynamicFormData.ScreenID;
                Data.Name = dynamicFormData.Name;
                Data.SessionId = dynamicFormData.SessionId;
                Data.StatusCodeID = dynamicFormData.StatusCodeID;
                Data.IsUpload = true;
                Data.FileProfileTypeId = dynamicFormData.FileProfileTypeId;
                Data.CompanyId = dynamicFormData.CompanyId;
                Data.ProfileId = dynamicFormData.ProfileId;
                Data.IsGridForm = dynamicFormData.IsGridForm;
                if (Data.IsUpload == true && dynamicFormData.FileProfileTypeId > 0)
                {
                    var lists = GetFileProfileTypePath(fileProfileTypeDocumentsAll, dynamicFormData.FileProfileTypeId);
                    LinkFilterFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
                }
                Data.IsApproval = dynamicFormData.IsApproval == true ? true : false;
                await refDynamicMasterSectionSettingForm.loadChildData(dynamicFormId);
            }
        }
        StateHasChanged();

    }

    private List<FileProfileTypeModel>
        GetFileProfileTypePath(List<DocumentsModel>
        foldersListItem, long? id)
    {
        var foldersListItems = foldersListItem.Where(t => t.FileProfileTypeId == id).ToList();
        FileProfileTypeModel fileprofile = new FileProfileTypeModel();
        List<FileProfileTypeModel>
        foldersList = new List<FileProfileTypeModel>
        ();
        if (foldersListItems != null && foldersListItems.Count > 0)
        {
            foldersListItems.ForEach(s =>
            {
                List<string>
                                    FolderPathLists = new List<string>
                                        ();
                FileProfileTypeModel fileProfileTypeModel = new FileProfileTypeModel();
                fileProfileTypeModel.FileProfileTypeId = s.FileProfileTypeId.Value;
                fileProfileTypeModel.Name = s.FileName;
                fileprofile = GetProfileTypeName(foldersListItem, s, FolderPathLists, fileprofile);
                FolderPathLists.Add(s.FileName);
                fileProfileTypeModel.FileProfileTypeParentId = fileprofile.ParentId;
                fileProfileTypeModel.FileProfilePath = string.Join(" / ", FolderPathLists);
                foldersList.Add(fileProfileTypeModel);
            });
        }
        return foldersList;
    }
    private FileProfileTypeModel GetProfileTypeName(List<DocumentsModel>
        foldersListItems, DocumentsModel s, List<string>
        foldersModel, FileProfileTypeModel fileProfileTypeModel)
    {

        if (s.ParentId != null)
        {
            var items = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.ParentId);
            GetProfileTypeName(foldersListItems, items, foldersModel, fileProfileTypeModel);
            foldersModel.Add(items.FileName);
        }
        else if (s.ParentId == null)
        {
            fileProfileTypeModel.ParentId = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.FileProfileTypeId)?.FileProfileTypeId;
        }
        return fileProfileTypeModel;
    }
}
