@using System.Dynamic;
@using global::Core.Entities.Views;

@inject IMediator Mediator
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.EntityModels;
@using global::Core.Repositories.Query;
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IJSRuntime JS;
@inject NavigationManager NavigationManager
@using Newtonsoft.Json.Linq;
@using Newtonsoft.Json;
@implements IAsyncDisposable
@inject ClipboardService ClipboardService
@using System.Collections.ObjectModel
@rendermode @(new  InteractiveServerRenderMode(prerender: false))
<div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
    <div class="cw-480 ch-220" style="margin-top:10px;">
        <DxFormLayout CssClass="w-100">
            <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default">

                @if (AttributeGridHeaderList != null && AttributeGridHeaderList.Count() > 0)
                {
                    foreach (var d in AttributeGridHeaderList)
                    {
                        @renderLayoutTabPage(d)

                    }
                }
                else
                {
                   <div>No grid found.</div>
                }
            </DxFormLayoutTabPages>
        </DxFormLayout>
    </div>
</div>
@code {
    [Parameter]
    public long? DynamicFormId { get; set; }
    [Parameter]
    public DynamicFormDataAudit _selectedItemsData { get; set; }
    int ActiveSubTabIndex { get; set; } = 0;
    public ApplicationUser? applicationUser { get; private set; }
    public List<DynamicFormDataAudit> _DynamicFormDataAuditList { get; set; }
    public List<AttributeHeader> AttributeGridHeaderList { get; set; }
    AttributeHeader attributeHeader = new AttributeHeader();
    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        await loadListData();
    }
    async Task loadListData()
    {
        AttributeGridHeaderList = new List<AttributeHeader>();
        if (DynamicFormId > 0)
        {
            AttributeGridHeaderList = await Mediator.Send(new GetDynamicFormDataGridList(DynamicFormId));
        }
    }
    public async ValueTask DisposeAsync()
    {
    }
    private RenderFragment renderLayoutTabPage(AttributeHeader dropDownOptionsList)
    {
        RenderFragment item = b =>
        {
            b.OpenComponent<DxFormLayoutTabPage>(0);
            b.AddAttribute(1, "Caption", dropDownOptionsList.DynamicFormName);
            b.AddAttribute(2, "ChildContent", (RenderFragment)((tabPageBuilder) =>
            {
                tabPageBuilder.OpenComponent<AC.SD.Core.Pages.Attribute.DynamicFormAuditMasterListSubGrid>(1);
                tabPageBuilder.AddAttribute(2, "DynamicFormId", dropDownOptionsList.DynamicFormId);
                tabPageBuilder.AddAttribute(2, "DynamicFormDataGridID", _selectedItemsData.DynamicFormDataId);
                tabPageBuilder.CloseElement();
            }));
            b.CloseComponent();
        };
        return item;
    }
}
