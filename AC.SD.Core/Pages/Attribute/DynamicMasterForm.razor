@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager NavigationManager
@page "/DynamicMasterSetup/DynamicMasterForm"
@page "/DynamicMasterSetup/DynamicMasterForm/{SessionIds:guid}"
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                    </Items>
                </DxMenu>
            </div>
            <div class="save_hover" style="float: left; margin-top: -41px; line-height: 38px; margin-left: 200px; width:100px;">
                <button type="submit" form="@MyID" disabled="@loading" class="btnSubmitForm" onclick="@onsubmitClick">
                    @if (loading)
                    {
                        <span class="spinner-border spinner-border-sm mr-1"></span>
                    }
                    <i class="fa fa-save"></i>
                    Save
                </button>
            </div>

        </div>
    </div>
</div>


<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm Model="@Data" id="@MyID" Context="EditFormContext" OnValidSubmit="@HandleValidSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />

                    <DxFormLayoutItem Caption="User Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.AddedBy" ShowValidationIcon="true" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.AddedDate" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Screen Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.ScreenID"></DxTextBox>
                        <ValidationMessage For="@(() => Data.ScreenID)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.Name"></DxTextBox>
                        <ValidationMessage For="@(() => Data.Name)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Approval Level" ColSpanMd="6">
                        <DxCheckBox @bind-Checked="@Data.IsApproval"></DxCheckBox>
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Section Entry">
                                <DynamicMasterSectionForm @ref="refDynamicMasterSectionForm" dynamicFormId="@dynamicFormId"></DynamicMasterSectionForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Approval Level Entry" Visible=IsApprovalEnabled>
                                <DynamicFormApprovals @ref="refDynamicFormApproval" dynamicFormId="@dynamicFormId"></DynamicFormApprovals>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>

        </div>
    </div>


</div>
@code {
    public long? dynamicFormId { get; set; }
    private DynamicFormApprovals refDynamicFormApproval;
    private DynamicMasterSectionForm refDynamicMasterSectionForm;
    [Parameter]
    public Guid? SessionIds { get; set; }
    public DynamicForm _dynamicFormData;
    private bool loading;
    string MasterType = "MasterPrice";
    private string MyID = "myid";
    long? EmployeeIds { get; set; }
    bool EditEnabledTab { get; set; } = false;
    bool IsApprovalEnabled { get; set; } = false;
    int ActiveSubTabIndex { get; set; } = 0;
    DynamicForm Data = new DynamicForm();
    View_SalesOrderMasterPricing _salesOrderItem = new View_SalesOrderMasterPricing();
    public ApplicationUser applicationUser { get; private set; }
    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
    }
    protected override async Task OnParametersSetAsync()
    {
        await OnParametersSetLoadAsync();
        base.OnParametersSet();
    }
    async Task OnParametersSetLoadAsync()
    {
        Data = new DynamicForm();
        Data.AddedDate = DateTime.Now;
        Data.AddedBy = applicationUser.UserName;
        IsApprovalEnabled = false;
        dynamicFormId = -1;
        if (SessionIds != null)
        {
            var dynamicFormData = await Mediator.Send(new GetDynamicFormBySession(SessionIds));
            if (dynamicFormData != null)
            {
                _dynamicFormData = dynamicFormData;
                dynamicFormId = dynamicFormData.ID;
                Data.ID = dynamicFormData.ID;
                Data.AddedBy = dynamicFormData.AddedBy;
                Data.ModifiedByUserID = dynamicFormData.ModifiedByUserID;
                Data.AddedByUserID = dynamicFormData.AddedByUserID;
                Data.AddedDate = dynamicFormData.AddedDate;
                Data.ModifiedDate = dynamicFormData.ModifiedDate;
                Data.ModifiedBy = dynamicFormData.ModifiedBy;
                Data.ScreenID = dynamicFormData.ScreenID;
                Data.Name = dynamicFormData.Name;
                Data.SessionId = dynamicFormData.SessionId;
                Data.StatusCodeID = dynamicFormData.StatusCodeID;
                Data.IsApproval = dynamicFormData.IsApproval == true ? true : false;
                if(Data.IsApproval==true)
                {
                    IsApprovalEnabled = true;
                }
                await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
            }
        }
        else
        {
            await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
        }
        StateHasChanged();

    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex==0)
        {
            await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
        }
        else if (e.TabIndex == 1)
        {
           // await refDynamicFormApproval.loadChildData(dynamicFormId);
        }
    }
    void backUrl()
    {
        NavigationManager.NavigateTo("DynamicMasterSetup");
    }
    void ResetForm()
    {
        dynamicFormId = -1;
        ActiveSubTabIndex = 0;
        NavigationManager.NavigateTo("DynamicMasterSetup/DynamicMasterForm");
    }
    void addNew()
    {
        NavigationManager.NavigateTo("DynamicMasterSetup/DynamicMasterForm");
    }
    void onsubmitClick()
    {
        ActiveSubTabIndex = 0;
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.ID > 0)
        {
            var editReq = new EditDynamicForm
                {
                    ID = Data.ID,
                    Name = Data.Name,
                    ScreenID = Data.ScreenID,
                    SessionID = Data.SessionID,
                    ModifiedByUserID = applicationUser.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = 1,
                    AddedDate = DateTime.Now,
                    IsApproval=Data.IsApproval,
                };

            await Mediator.Send(editReq);
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;
            await OnParametersSetLoadAsync();
            StateHasChanged();
        }
        else
        {
            var createReq = new CreateDynamicForm
                {
                    Name = Data.Name,
                    ScreenID = Data.ScreenID,
                    SessionID = Guid.NewGuid(),
                    AddedByUserID = applicationUser.UserID,
                    ModifiedByUserID = applicationUser.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = 1,
                    AddedDate = DateTime.Now,
                    IsApproval=Data.IsApproval,
                };
            var result = await Mediator.Send(createReq);
            if (result > 0)
            {
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                dynamicFormId = result;
                ActiveSubTabIndex = 0;
                loading = false;
            }
            NavigationManager.NavigateTo("DynamicMasterSetup/DynamicMasterForm/" + createReq.SessionID + "");


            StateHasChanged();
        }
    }
}
