@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Helpers.TreeGenerateRecursive _treeGenerateRecursive
@inject NavigationManager NavigationManager
@page "/DynamicMasterSetup/DynamicMasterForm"
@page "/DynamicMasterSetup/DynamicMasterForm/{SessionIds:guid}"
@implements IDisposable
<style scoped>
    .save_hover_Master_From_1 {
        float: left;
        margin-top: -41px;
        line-height: 38px;
        margin-left: 200px;
        width: 100px;
    }
</style>
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                        <DxMenuItem Text="Form" IconCssClass="fa fa-wpforms" Click="@OpenNewForm" Enabled="@EditEnabled" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>

<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />

                    <DxFormLayoutItem Caption="User Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.AddedBy" ShowValidationIcon="true" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.AddedDate" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                        <DxComboBox Data="@_plantItems"
                                    NullText="Select Company..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="NavCompany"
                                    ValueFieldName="PlantID"
                                    Value="@Data.CompanyId"
                                    ValueExpression="@(() => Data.CompanyId )"
                                    ValueChanged="@((long? plantData) => SelectedPlantChanged(plantData))"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Company Code"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompany)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.CompanyId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Profile" ColSpanMd="6">
                        <DxComboBox Data="@_documentProfileNoList"
                                    NullText="Select Profile..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Name"
                                    ValueFieldName="ProfileID"
                                    Value="@Data.ProfileId"
                                    ValueExpression="@(() => Data.ProfileId )"
                                    ValueChanged="@((long? plantData) => SelectedProfileChanged(plantData))"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.Name)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.Abbreviation)"
                                                    Caption="Abbreviation" />
                                <DxListEditorColumn FieldName="@nameof(DocumentProfileNoSeriesModel.SampleDocumentNo)"
                                                    Caption="Sample Document No" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.ProfileId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Screen Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.ScreenID" ShowValidationIcon="true"></DxTextBox>

                        <ValidationMessage For="@(() => Data.ScreenID)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Form Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.Name" ShowValidationIcon="true"></DxTextBox>
                        <ValidationMessage For="@(() => Data.Name)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Approval Level" ColSpanMd="6">
                        <DxCheckBox @bind-Checked="@Data.IsApproval"></DxCheckBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Is Grid Form" ColSpanMd="6">
                        <DxCheckBox @bind-Checked="@Data.IsGridForm"></DxCheckBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="SW Library" ColSpanMd="6" Visible="@Data.IsUpload">
                        <DxTextBox NullText="SW Library..." @bind-Text="@LinkFilterFileprofiletypeName" CssClass="cw-480">
                            <Buttons>
                                <DxEditorButton IconCssClass="fa fa-add" Id=@($"flyout-overview-target-container-IsFilterFileProfileTypeDocumentOpen")
                                                Tooltip="Select File ProfileType"
                                                Click="@(_ => OnButtonFileProfileTypeLinDocClick())" />
                            </Buttons>
                        </DxTextBox>
                        <DxSpinEdit @bind-Value="@Data.FileProfileTypeId" BindValueMode="BindValueMode.OnInput" style="display:none;" />
                        <ValidationMessage For="@(() => Data.FileProfileTypeId)" />
                    </DxFormLayoutItem>

                    @*  <DxFormLayoutItem Caption="Is Generate ProfileNo" ColSpanMd="6">
                    <DxCheckBox @bind-Checked="@Data.IsProfileNoGenerate"></DxCheckBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Is Multiple Upload" ColSpanMd="6">
                    <DxCheckBox @bind-Checked="@Data.IsMultipleUpload"></DxCheckBox>
                    </DxFormLayoutItem> *@
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Section Entry">
                                <DynamicMasterSectionForm @ref="refDynamicMasterSectionForm" dynamicFormId="@dynamicFormId" RevokeBack="BackPermissionPopUp"></DynamicMasterSectionForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Approval Level Entry" Visible=IsApprovalEnabled>
                                <DynamicFormApprovals @ref="refDynamicFormApproval" dynamicFormId="@dynamicFormId"></DynamicFormApprovals>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="WorkFlow Level Entry">
                                <DynamicFormWorkFlows @ref="refDynamicFormWorkFlows" dynamicFormId="@dynamicFormId"></DynamicFormWorkFlows>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>

        </div>
    </div>


</div>
<DxFlyout @bind-IsOpen=IsFileProfileTypeFilterDocOpen
          PositionTarget=@($"#flyout-overview-target-container-IsFilterFileProfileTypeDocumentOpen")
          RestrictionTarget="#Navigation-Flyout-Customization"
          AnimationType="FlyoutAnimationType.Fade"
          HeaderVisible="true"
          HeaderText="Select SW Library"
          FooterVisible="true"
          FooterCssClass="custom-flyout-footer"
          Width="max(25vw, 550px)"
          CloseOnOutsideClick="false"
          PreventCloseOnPositionTargetClick="true">
    <BodyContentTemplate Context="PopupContext">
        <DxFormLayout CssClass="w-100" style="height: calc(100vh - 250px);overflow:auto;overflow-x:hidden;">
            <DxFormLayoutItem Caption="">
                <DxTreeView @ref="_treeFilterDocView"
                            @bind-FilterString="FilterDocumentString"
                            ShowFilterPanel="true"
                            FilterMode="NavigationFilterMode.EntireBranch"
                            AllowSelectNodes="true"
                            SelectionChanged="@SelectionChanged"
                            Data="@_selectedTreeItems"
                            LoadChildNodesOnDemand="true">
                    <DataMappings>
                        <DxTreeViewDataMapping Text="FileName"
                                               HasChildren="HasChildren"
                                               Children="Children" />
                    </DataMappings>
                </DxTreeView>
            </DxFormLayoutItem>

        </DxFormLayout>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">
                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsFileProfileTypeFilterDocOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>
@code {
    private IDisposable? DynamicFormPage7;
    bool EditEnabled { get; set; } = false;
    public List<DocumentsModel> fileProfileTypeDocumentsAll { get; set; }
    public bool IsFileProfileTypeFilterDocOpen { get; set; }
    private DxTreeView _treeFilterDocView;
    string? FilterDocumentString { get; set; }
    EditContext _editContext;
    public long? dynamicFormId { get; set; }
    private DynamicFormApprovals refDynamicFormApproval; private DynamicFormWorkFlows refDynamicFormWorkFlows;
    private DynamicMasterSectionForm refDynamicMasterSectionForm;
    [Parameter]
    public Guid? SessionIds { get; set; }
    public DynamicForm _dynamicFormData;
    private bool loading;
    private string MyID = "myid";
    long? EmployeeIds { get; set; }
    bool EditEnabledTab { get; set; } = false;
    bool IsApprovalEnabled { get; set; } = false;
    int ActiveSubTabIndex { get; set; } = 0;
    private DynamicForm Data = new DynamicForm();
    View_SalesOrderMasterPricing _salesOrderItem = new View_SalesOrderMasterPricing();
    public ApplicationUser applicationUser { get; private set; }
    string _zindex = "z-index: 9999;";
    string? LinkFilterFileprofiletypeName { get; set; } = null;
    IEnumerable<DocumentsModel> _selectedTreeItems = new List<DocumentsModel>();
    private List<ViewPlants>? _plantItems;
    public List<DocumentProfileNoSeriesModel> _documentProfileNoList { get; set; }
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _plantItems = await Mediator.Send(new GetAllPlantByNavCompanyQuery());
        fileProfileTypeDocumentsAll = await Mediator.Send(new GetAllfileprofiletypeListQuery());
        _documentProfileNoList = await Mediator.Send(new GetDocumentProfiles());
        if (fileProfileTypeDocumentsAll.Count() > 0)
        {
            _selectedTreeItems = _treeGenerateRecursive.TreeGenerateRecursives(fileProfileTypeDocumentsAll);
        }
    }
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            DynamicFormPage7 =
                NavigationManager.RegisterLocationChangingHandler(OnLocationChanging);
        }
    }

    private ValueTask OnLocationChanging(LocationChangingContext context)
    {
        if (context.TargetLocation == "/counter")
        {
            context.PreventNavigation();
        }

        return ValueTask.CompletedTask;
    }

    void SelectedPlantChanged(long? country)
    {
        Data.CompanyId = null;
        if (country>0)
        {
            Data.CompanyId = country;
        }
    }
    void SelectedProfileChanged(long? country)
    {
        Data.ProfileId = null;
        if (country>0)
        {
            Data.ProfileId = country;
        }
    }
    public void Dispose()
    {

        DynamicFormPage7?.Dispose();
        System.GC.Collect();
        GC.SuppressFinalize(this);
    }
    protected override async Task OnParametersSetAsync()
    {
        if (applicationUser != null)
        {
            await OnParametersSetLoadAsync();
        }
        base.OnParametersSet();
    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
    async Task OnParametersSetLoadAsync()
    {
        EditEnabled = false;
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedBy = applicationUser.UserName;
        Data.ID = 0;
        Data.IsApproval = false;
        IsApprovalEnabled = false;
        dynamicFormId = -1;
        Data.ModifiedByUserID = null;
        Data.AddedByUserID = null;
        Data.ModifiedDate = null;
        Data.ModifiedBy = null;
        Data.ScreenID = null;
        Data.Name = null;
        Data.SessionId = null;
        Data.IsGridForm = false;
        Data.StatusCodeID = null; Data.CompanyId = null; Data.ProfileId = null;
        Data.IsApproval = false;
        Data.IsUpload = true; Data.FileProfileTypeId = null; LinkFilterFileprofiletypeName = null;
        if (SessionIds != null)
        {
            var dynamicFormData = await Mediator.Send(new GetDynamicFormBySession(SessionIds));
            if (dynamicFormData != null)
            {
                EditEnabled = true;
                _dynamicFormData = dynamicFormData;
                dynamicFormId = dynamicFormData.ID;
                Data.ID = dynamicFormData.ID;
                Data.AddedBy = dynamicFormData.AddedBy;
                Data.ModifiedByUserID = dynamicFormData.ModifiedByUserID;
                Data.AddedByUserID = dynamicFormData.AddedByUserID;
                Data.AddedDate = dynamicFormData.AddedDate;
                Data.ModifiedDate = dynamicFormData.ModifiedDate;
                Data.ModifiedBy = dynamicFormData.ModifiedBy;
                Data.ScreenID = dynamicFormData.ScreenID;
                Data.Name = dynamicFormData.Name;
                Data.SessionId = dynamicFormData.SessionId;
                Data.StatusCodeID = dynamicFormData.StatusCodeID;
                Data.IsUpload = true;
                Data.FileProfileTypeId = dynamicFormData.FileProfileTypeId;
                Data.CompanyId = dynamicFormData.CompanyId;
                Data.ProfileId = dynamicFormData.ProfileId;
                Data.IsGridForm = dynamicFormData.IsGridForm;
                if (Data.IsUpload == true && dynamicFormData.FileProfileTypeId > 0)
                {
                    var lists = GetFileProfileTypePath(fileProfileTypeDocumentsAll, dynamicFormData.FileProfileTypeId);
                    LinkFilterFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
                }
                Data.IsApproval = dynamicFormData.IsApproval == true ? true : false;
                if (Data.IsApproval == true)
                {
                    IsApprovalEnabled = true;
                }
                await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
            }
        }
        else
        {
            await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
        }
        StateHasChanged();

    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
            await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
        }
        else if (e.TabIndex == 1)
        {
            // await refDynamicFormApproval.loadChildData(dynamicFormId);
        }
    }
    void backUrl()
    {
        NavigationManager.NavigateTo("DynamicMasterSetup");
    }
    void OpenNewForm()
    {
        if (_dynamicFormData != null)
        {
            NavigationManager.NavigateTo("DynamicMasterSetup/dynamicFormMasterList/" + _dynamicFormData.SessionID);
        }
    }
    void ResetForm()
    {
        dynamicFormId = -1;
        ActiveSubTabIndex = 0;
        NavigationManager.NavigateTo("DynamicMasterSetup/DynamicMasterForm");
    }
    async Task addNew()
    {
        if (SessionIds != null)
        {
            NavigationManager.NavigateTo("DynamicMasterSetup/DynamicMasterForm");
        }
        else
        {
            await OnParametersSetLoadAsync();
        }

    }
    void BackPermissionPopUp(bool? Status)
    {
        if (Status == true)
        {
            _zindex = "";
        }
        else
        {
            _zindex = "z-index: 9999;";
        }
        StateHasChanged();
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.ID > 0)
        {
            var editReq = new EditDynamicForm
                {
                    ID = Data.ID,
                    Name = Data.Name,
                    ScreenID = Data.ScreenID,
                    SessionID = Data.SessionID,
                    ModifiedByUserID = applicationUser.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = 1,
                    AddedDate = DateTime.Now,
                    IsApproval = Data.IsApproval,
                    IsUpload = Data.IsUpload,
                    CompanyId = Data.CompanyId,
                    ProfileId = Data.ProfileId,
                    IsGridForm = Data.IsGridForm,
                    FileProfileTypeId = Data.IsUpload == true && Data.FileProfileTypeId > 0 ? Data.FileProfileTypeId : null,
                };

            await Mediator.Send(editReq);
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;
            await OnParametersSetLoadAsync();
            StateHasChanged();
        }
        else
        {
            var createReq = new CreateDynamicForm
                {
                    Name = Data.Name,
                    ScreenID = Data.ScreenID,
                    SessionID = Guid.NewGuid(),
                    AddedByUserID = applicationUser.UserID,
                    ModifiedByUserID = applicationUser.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = 1,
                    AddedDate = DateTime.Now,
                    IsApproval = Data.IsApproval,
                    CompanyId = Data.CompanyId,
                    ProfileId = Data.ProfileId,
                    IsGridForm = Data.IsGridForm,
                    FileProfileTypeId = Data.IsUpload == true && Data.FileProfileTypeId > 0 ? Data.FileProfileTypeId : null,
                };
            var result = await Mediator.Send(createReq);
            if (result > 0)
            {
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                dynamicFormId = result;
                ActiveSubTabIndex = 0;
                loading = false;
            }
            NavigationManager.NavigateTo("DynamicMasterSetup/DynamicMasterForm/" + createReq.SessionID + "");


            StateHasChanged();
        }
    }
    void OnButtonFileProfileTypeLinDocClick()
    {
        IsFileProfileTypeFilterDocOpen = true;
    }
    protected void SelectionChanged(TreeViewNodeEventArgs e)
    {
        if (e.NodeInfo?.DataItem != null)
        {
            var nodeName = e.NodeInfo.DataItem as DocumentsModel;
            var lists = GetFileProfileTypePath(fileProfileTypeDocumentsAll, nodeName.FileProfileTypeId);
            LinkFilterFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
            Data.FileProfileTypeId = nodeName.FileProfileTypeId;
        }
        IsFileProfileTypeFilterDocOpen = false;
        StateHasChanged();
    }
    private List<FileProfileTypeModel>
        GetFileProfileTypePath(List<DocumentsModel>
        foldersListItem, long? id)
    {
        var foldersListItems = foldersListItem.Where(t => t.FileProfileTypeId == id).ToList();
        FileProfileTypeModel fileprofile = new FileProfileTypeModel();
        List<FileProfileTypeModel>
        foldersList = new List<FileProfileTypeModel>
        ();
        if (foldersListItems != null && foldersListItems.Count > 0)
        {
            foldersListItems.ForEach(s =>
            {
                List<string>
                                    FolderPathLists = new List<string>
                                        ();
                FileProfileTypeModel fileProfileTypeModel = new FileProfileTypeModel();
                fileProfileTypeModel.FileProfileTypeId = s.FileProfileTypeId.Value;
                fileProfileTypeModel.Name = s.FileName;
                fileprofile = GetProfileTypeName(foldersListItem, s, FolderPathLists, fileprofile);
                FolderPathLists.Add(s.FileName);
                fileProfileTypeModel.FileProfileTypeParentId = fileprofile.ParentId;
                fileProfileTypeModel.FileProfilePath = string.Join(" / ", FolderPathLists);
                foldersList.Add(fileProfileTypeModel);
            });
        }
        return foldersList;
    }
    private FileProfileTypeModel GetProfileTypeName(List<DocumentsModel>
        foldersListItems, DocumentsModel s, List<string>
        foldersModel, FileProfileTypeModel fileProfileTypeModel)
    {

        if (s.ParentId != null)
        {
            var items = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.ParentId);
            GetProfileTypeName(foldersListItems, items, foldersModel, fileProfileTypeModel);
            foldersModel.Add(items.FileName);
        }
        else if (s.ParentId == null)
        {
            fileProfileTypeModel.ParentId = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.FileProfileTypeId)?.FileProfileTypeId;
        }
        return fileProfileTypeModel;
    }
}
