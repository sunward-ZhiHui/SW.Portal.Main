@page "/PlanningForProductionProcessByMachineList/PlanningForProductionProcessByMachineItem"
@page "/PlanningForProductionProcessByMachineList/PlanningForProductionProcessByMachineItem/{SessionIds:guid}"
@using Microsoft.Extensions.Configuration;
@using global::Core.Entities;
@using Application.Commands;
@using Application.Queries;
@using Application.Response;
@using MediatR
@inject IMediator Mediator
@using DevExpress.Export
@using global::Core.Entities.Views;
@using global::Core.EntityModels;
@using global::Core.Repositories.Query;
@inject IJSRuntime jsRuntime
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@implements IAsyncDisposable;
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@AddSave" />
                        <DxMenuItem Text="Attachment" IconCssClass="fa fa-paperclip" Click="@addAttachment" Enabled="@AttachmentEnabled" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>


<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4; padding-bottom:10px;">
        <div class="cw-480" style="margin-top:10px;">


            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="@HandleValidSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />
                    <DxFormLayoutItem Caption="Type of Planning" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetails"
                                    NullText="Select Type of Planning..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.TypeOfProductionId" />
                        <ValidationMessage For="@(() => Data.TypeOfProductionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Squence For Planning.." ColSpanMd="12">
                        <DxMemo @bind-Text="@Data.SquenceForPlanning" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Production Planning Process" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetails2"
                                    NullText="Select Production Planning Process..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.ProductionPlanningProcessId" />
                        <ValidationMessage For="@(() => Data.ProductionPlanningProcessId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Machine or Human related?" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetails3"
                                    NullText="Select Machine or Human related?..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.TypeOfProcessId" />
                        <ValidationMessage For="@(() => Data.TypeOfProcessId)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>

            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.OnDemand">
                            <DxFormLayoutTabPage Caption="Form Data">
                                <PlanningForProductionProcessByMachineRelatedLines @ref="refDynamicFormItemLines" DynamicFormItemids="@PlanningForProductionProcessByMachineId" DynamicFormItemList="Data"></PlanningForProductionProcessByMachineRelatedLines>
                            </DxFormLayoutTabPage>

                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>


        </div>
    </div>
</div>
<DxPopup @bind-Visible="@AttachmentPopUp"
         ShowFooter="true"
         HeaderText="Attachment"
         CloseOnOutsideClick="false"
         ShowCloseButton="true"
         CloseOnEscape="false"
         MinWidth="300" MinHeight="200" MaxWidth="1000px" MaxHeight="800">
    <BodyContentTemplate>
        <AC.SD.Core.Pages.UploadDocuments.UploadDocuments @ref="refUploadDocuments" SessionId="@_selectedItems.SessionId" RevokeBack="CloseAttachmentPopup"></AC.SD.Core.Pages.UploadDocuments.UploadDocuments>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Close" Click="@(() => CloseAttachmentPopup())" />
    </FooterContentTemplate>
</DxPopup>

@code {
    private AC.SD.Core.Pages.UploadDocuments.UploadDocuments refUploadDocuments;
    bool AttachmentPopUp { get; set; } = false;
    PlanningForProductionProcessByMachineRelatedLines? refDynamicFormItemLines;
    int ActiveSubTabIndex { get; set; } = 0;
    bool Time = false;
    EditContext _editContext;
    [Parameter]
    public Guid? SessionIds { get; set; }
    public long PlanningForProductionProcessByMachineId { get; set; }
    PlanningForProductionProcessByMachine Data = new PlanningForProductionProcessByMachine();
    public PlanningForProductionProcessByMachine _dynamicFormlistData;
    public ApplicationUser applicationUser { get; private set; }
    private bool loading;
    private PlanningForProductionProcessByMachine _selectedItems; bool AttachmentEnabled { get; set; } = false;
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetails; private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetails2;
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetails3;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _view_ApplicationMasterDetails = await Mediator.Send(new GetAllApplicationMasterDetailQuery(275));
        _view_ApplicationMasterDetails2 = await Mediator.Send(new GetAllApplicationMasterDetailQuery(127));
        _view_ApplicationMasterDetails3 = await Mediator.Send(new GetAllApplicationMasterDetailQuery(481));
    }
    protected override async Task OnParametersSetAsync()
    {
        if (applicationUser != null)
        {

            PlanningForProductionProcessByMachineId = 0; _selectedItems = null; AttachmentEnabled = false;
            if (SessionIds != null)
            {
                var list = await Mediator.Send(new GetPlanningForProductionProcessByMachineBySession(SessionIds));

                if (list != null)
                {
                    AttachmentEnabled = true;
                    _selectedItems = list;
                    PlanningForProductionProcessByMachineId = list.PlanningForProductionProcessByMachineId;
                    Data.TypeOfProductionId = list.TypeOfProductionId;
                    Data.PlanningForProductionProcessByMachineId = list.PlanningForProductionProcessByMachineId;
                    Data.SquenceForPlanning = list.SquenceForPlanning;
                    Data.ProductionPlanningProcessId = list.ProductionPlanningProcessId;
                    Data.TypeOfProcessId = list.TypeOfProcessId;
                    Data.AddedByUserID = list.AddedByUserID;
                    Data.AddedDate = list.AddedDate;
                    Data.SessionId = list.SessionId;
                    await refDynamicFormItemLines.loadData(list.PlanningForProductionProcessByMachineId);
                }
            }
            else
            {
                await OnParametersSetLoadAsync();
            }
        }
        base.OnParametersSet();
    }
    async Task OnParametersSetLoadAsync()
    {
        _editContext = new EditContext(Data); AttachmentEnabled = false;
        PlanningForProductionProcessByMachineId = 0;
        Data.TypeOfProductionId = null;
        Data.PlanningForProductionProcessByMachineId = 0;
        Data.SquenceForPlanning = null;
        Data.ProductionPlanningProcessId = null;
        Data.TypeOfProcessId = null;
        Data.AddedByUserID = applicationUser.UserID;
        Data.AddedDate = DateTime.Now;
        await refDynamicFormItemLines.loadData(PlanningForProductionProcessByMachineId);
        StateHasChanged();
    }
    void backUrl()
    {
        ActiveSubTabIndex = 0;
        NavigationManager.NavigateTo("PlanningForProductionProcessByMachineList");
    }

    async Task AddSave()
    {
        if (_editContext.Validate())
        {
            // draftId = 0;
            await this.HandleValidSubmit();

        }
    }
    async Task addNew()
    {
        if (SessionIds != null)
        {
            SessionIds = null;
            NavigationManager.NavigateTo("PlanningForProductionProcessByMachineList/PlanningForProductionProcessByMachineItem");
        }
        else
        {
            await OnParametersSetLoadAsync();
        }

    }

    async Task HandleValidSubmit()
    {
        if (SessionIds != null)
        {

            var UpdateReq = new InsertOrUpdatePlanningForProductionProcessByMachine
            {
                PlanningForProductionProcessByMachineId = Data.PlanningForProductionProcessByMachineId,
                TypeOfProductionId = Data.TypeOfProductionId,
                SquenceForPlanning = Data.SquenceForPlanning,
                ProductionPlanningProcessId = Data.ProductionPlanningProcessId,
                TypeOfProcessId = Data.TypeOfProcessId,
                StatusCodeID = 1,
                ModifiedByUserID = applicationUser.UserID,
                AddedByUserID = Data.AddedByUserID,
                ModifiedDate = DateTime.Now,
                SessionId = Data.SessionId,
                AddedDate = Data.AddedDate,
            };

            var ans = await Mediator.Send(UpdateReq);
            toastService.ShowToast("Record Updated Successfully", AC.SD.Core.Services.ToastLevel.Success);

        }
        else
        {


            var createReq = new InsertOrUpdatePlanningForProductionProcessByMachine
            {
                PlanningForProductionProcessByMachineId = Data.PlanningForProductionProcessByMachineId,
                TypeOfProductionId = Data.TypeOfProductionId,
                SquenceForPlanning = Data.SquenceForPlanning,
                ProductionPlanningProcessId = Data.ProductionPlanningProcessId,
                TypeOfProcessId = Data.TypeOfProcessId,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = Guid.NewGuid(),
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now,
            };


            var result = await Mediator.Send(createReq);
            PlanningForProductionProcessByMachineId = result.PlanningForProductionProcessByMachineId;
            toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);

            NavigationManager.NavigateTo("PlanningForProductionProcessByMachineList/PlanningForProductionProcessByMachineItem/" + createReq.SessionId + "");
            StateHasChanged();
        }

    }


    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
    }
    void addAttachment()
    {
        AttachmentPopUp = true;
    }
    void CloseAttachmentPopup()
    {
        AttachmentPopUp = false;
        StateHasChanged();
    }
    public async ValueTask DisposeAsync()
    {
        // System.GC.Collect();
        refUploadDocuments?.DisposeAsync();
        refDynamicFormItemLines?.DisposeAsync();
        Data = new PlanningForProductionProcessByMachine();
        _dynamicFormlistData = null;
        _selectedItems = null;
        _view_ApplicationMasterDetails?.Clear();
        _view_ApplicationMasterDetails2?.Clear();
        _view_ApplicationMasterDetails3?.Clear();
    }
}
