@using Application.Commands;
@using Application.Queries;
@using MediatR
@using System.Dynamic
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject ClipboardService ClipboardService
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@* @inject AC.SD.Core.Helpers.TreeGenerateRecursive _treeGenerateRecursive *@
@inject NavigationManager NavigationManager
@page "/RegistrationRequestList/RegistrationRequestForm"
@page "/RegistrationRequestList/RegistrationRequestForm/{SessionId:guid}"
@implements IAsyncDisposable
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                        <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDetailDelete" Enabled="@EditEnabled" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>
<div class="" style="overflow-x: hidden;overflow-y: auto;height: calc(100vh - 210px);">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;margin-bottom:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />
                    <DxFormLayoutItem Caption="Registration Country:" ColSpanMd="6">
                        <DxComboBox Data="@_applicationMasterChildListItems"
                                    NullText="Select Registration Country..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    ListRenderMode="ListRenderMode.Virtual"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterChildId"
                                    Value="@Data.RegistrationCountryId"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ValueExpression="@(() => Data.RegistrationCountryId )"
                                    ValueChanged="@((long? RegistrationCountryId) => SelectedRegistrationCountryChanged(RegistrationCountryId))"
                                    ShowValidationIcon="true">

                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.RegistrationCountryId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Item Information" ColSpanMd="12">
                        <DxDropDownBox @bind-Value="ItemValue"
                                       QueryDisplayText="QueryDisplayDynamicComboBoxText"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Select a Item..."
                                       ShowValidationIcon="true">
                            <DropDownBodyTemplate Context="ddbBodyContext">
                                <DxGrid Data="@_dynamicformObjectDataList"
                                        KeyFieldName="DynamicFormDataId" ShowSearchBox="true"
                                        HighlightRowOnHover="true"
                                        SearchTextParseMode="GridSearchTextParseMode.GroupWordsByAnd"
                                        SelectionMode="GridSelectionMode.Single"
                                        AllowSelectRowByClick="true"
                                        FocusedRowEnabled="true"
                                        TextWrapEnabled="false"
                                        style="height: calc(100vh - 500px);"
                                        CssClass="w-100"
                                        VirtualScrollingEnabled="true"
                                        SelectedDataItem="@(ddbBodyContext.DropDownBox.Value as ExpandoObject)"
                                        SelectedDataItemChanged="item => GridSelectedDataItemChanged(item, ddbBodyContext.DropDownBox)">
                                    <Columns>
                                        <DxGridSelectionColumn AllowSelectAll="true"></DxGridSelectionColumn>
                                        @BuildDataColumns()
                                    </Columns>
                                </DxGrid>
                            </DropDownBodyTemplate>
                        </DxDropDownBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Variation No" ColSpanMd="12">
                        <DxDropDownBox @bind-Value="VariationNoValue"
                                       QueryDisplayText="QueryDisplayVariationDynamicComboBoxText"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Select a Variation No..."
                                       ShowValidationIcon="true">
                            <DropDownBodyTemplate Context="ddbBodyContext1">
                                <DxGrid Data="@_dynamicformObjectDataVariationList"
                                        KeyFieldName="DynamicFormDataId" ShowSearchBox="true"
                                        HighlightRowOnHover="true"
                                        SearchTextParseMode="GridSearchTextParseMode.GroupWordsByAnd"
                                        SelectionMode="GridSelectionMode.Multiple"
                                        AllowSelectRowByClick="true"
                                        FocusedRowEnabled="true"
                                        TextWrapEnabled="false"
                                        VirtualScrollingEnabled="true"
                                        style="height: calc(100vh - 500px);"
                                        CssClass="w-100"
                                        SelectedDataItems="@(ddbBodyContext1.DropDownBox.Value as List<ExpandoObject> )"
                                        SelectedDataItemsChanged="item => GridVariationSelectedDataItemChanged(item, ddbBodyContext1.DropDownBox)">
                                    <Columns>
                                        <DxGridSelectionColumn AllowSelectAll="true"></DxGridSelectionColumn>
                                        @BuildDataVariationsColumns()
                                    </Columns>
                                </DxGrid>
                            </DropDownBodyTemplate>
                        </DxDropDownBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="CC No" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.CCNo" ShowValidationIcon="true"></DxTextBox>

                        <ValidationMessage For="@(() => Data.CCNo)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Expected Submission Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.ExpectedSubmissionDate" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Submission Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.SubmissionDate" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Submission No" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.SubmissionNo" ShowValidationIcon="true"></DxTextBox>

                        <ValidationMessage For="@(() => Data.SubmissionNo)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Purpose Of Registration" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.PurposeOfRegistration" ShowValidationIcon="true"></DxTextBox>
                        <ValidationMessage For="@(() => Data.PurposeOfRegistration)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Section Entry">
                                <RegistrationRequestFormLine @ref="refRegistrationRequestFormLine" applicationUser="@applicationUser" _registrationRequestData="@_registrationRequestData"></RegistrationRequestFormLine>
                            </DxFormLayoutTabPage>
                           
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>
        </div>
    </div>
</div>
@code {
    private RegistrationRequestFormLine refRegistrationRequestFormLine;
    int ActiveSubTabIndex { get; set; } = 0;
    object ItemValue { get; set; }
    object VariationNoValue { get; set; }
    [Parameter]
    public Guid? SessionId { get; set; }
    public ApplicationUser applicationUser { get; private set; }
    private RegistrationRequest Data = new RegistrationRequest();
    EditContext _editContext; bool EditEnabled { get; set; } = false; bool loading { get; set; } = false;
    private List<ApplicationMasterChildModel> _applicationMasterChildListItems;
    private List<ExpandoObject?> _dynamicformObjectDataList { get; set; }
    private List<DropDownOptionsModel> gridlistss { get; set; }
    private List<ExpandoObject?> _dynamicformObjectDataVariationList { get; set; }
    private List<DropDownOptionsModel> _variationgridlistss { get; set; }
    public RegistrationRequest _registrationRequestData;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _applicationMasterChildListItems = await Mediator.Send(new GetAllApplicationMasterChildListQuery("154"));
        List<long?> dynamicFormIds = new List<long?>();
        dynamicFormIds.Add(20);
        var list = await Mediator.Send(new GetDynamicFormItemLineDropdoenList(dynamicFormIds, applicationUser.UserID));
        gridlistss = new List<DropDownOptionsModel>();
        gridlistss = list.DropDownGridOptionsModel.FirstOrDefault()?.DropDownOptionsModels;
        _dynamicformObjectDataList = new List<ExpandoObject>();
        if (list.ObjectData != null)
        {
            foreach (var v in (list.ObjectData as IEnumerable<ExpandoObject>))
            {
                dynamic eod = v;
                var vv = eod.DynamicFormId;
                var AttributeDetailIds = eod.AttributeDetailID;
                string listone = string.Empty;
                if (gridlistss != null && gridlistss.Count() > 0)
                {
                    var g1 = gridlistss.OrderBy(o => o.OrderBy).ToList();
                    g1.ForEach(q =>
                    {
                        var byName = (IDictionary<string, object>)v;
                        var names = (string)byName[q.Value]?.ToString();
                        listone += names + "|";
                    });
                }
                eod.DisplayItemsQuery = listone;
                _dynamicformObjectDataList.Add(eod);
            }
        }

        List<long?> dynamicFormIdss = new List<long?>();
        dynamicFormIdss.Add(10134);
        var lists = await Mediator.Send(new GetDynamicFormItemLineDropdoenList(dynamicFormIdss, applicationUser.UserID));
        _variationgridlistss = new List<DropDownOptionsModel>();
        _variationgridlistss = lists.DropDownGridOptionsModel.FirstOrDefault()?.DropDownOptionsModels;
        _dynamicformObjectDataVariationList = new List<ExpandoObject>();
        if (lists.ObjectData != null)
        {
            foreach (var v in (lists.ObjectData as IEnumerable<ExpandoObject>))
            {
                dynamic eod = v;
                var vv = eod.DynamicFormId;
                var AttributeDetailIds = eod.AttributeDetailID;
                string listone = string.Empty;
                if (_variationgridlistss != null && _variationgridlistss.Count() > 0)
                {
                    var g1 = _variationgridlistss.OrderBy(o => o.OrderBy).ToList();
                    g1.ForEach(q =>
                    {
                        var byName = (IDictionary<string, object>)v;
                        var names = (string)byName[q.Value]?.ToString();
                        listone += names + "|";
                    });
                }
                eod.DisplayItemsQuery = listone;
                _dynamicformObjectDataVariationList.Add(eod);
            }
        }
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
            // await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
        }
        else if (e.TabIndex == 1)
        {
            // await refDynamicFormApproval.loadChildData(dynamicFormId);
        }
    }
    protected override async Task OnParametersSetAsync()
    {
        if (applicationUser != null)
        {
            await OnParametersSetLoadAsync();
        }
        base.OnParametersSet();
    }
    async Task OnParametersSetLoadAsync()
    {
        EditEnabled = false;
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedBy = applicationUser.UserName;
        Data.RegistrationRequestId = 0;
        Data.RegistrationCountryId = null;
        Data.ModifiedUserId = applicationUser.UserID;
        Data.AddedByUserId = applicationUser.UserID;
        Data.ModifiedDate = DateTime.Now;
        Data.ModifiedBy = applicationUser.UserName;
        Data.ProductSpecificationDynamicFormId = null;
        Data.SessionId = null; Data.CCNo = null;
        Data.ExpectedSubmissionDate = null;
        Data.StatusCodeId = 1;
        Data.SubmissionDate = null;
        Data.SubmissionNo = null;
        Data.PurposeOfRegistration = null;
        Data.VariationNoIds = new List<long?>(); ItemValue = null; VariationNoValue = null;
        _registrationRequestData = new RegistrationRequest();
        if (SessionId != null)
        {
            var dynamicFormData = await Mediator.Send(new GetRegistrationRequestBySession(SessionId));
            if (dynamicFormData != null)
            {
                EditEnabled = true;
                _registrationRequestData = dynamicFormData;
                Data.RegistrationRequestId = dynamicFormData.RegistrationRequestId;
                Data.AddedBy = dynamicFormData.AddedBy;
                Data.ModifiedUserId = dynamicFormData.ModifiedUserId;
                Data.AddedByUserId = dynamicFormData.AddedByUserId;
                Data.AddedDate = dynamicFormData.AddedDate;
                Data.ModifiedDate = dynamicFormData.ModifiedDate;
                Data.ModifiedBy = dynamicFormData.ModifiedBy;
                Data.CCNo = dynamicFormData.CCNo;
                Data.RegistrationCountryId = dynamicFormData.RegistrationCountryId;
                Data.StatusCodeId = dynamicFormData.StatusCodeId;
                Data.SessionId = dynamicFormData.SessionId;
                Data.ProductSpecificationDynamicFormId = dynamicFormData.ProductSpecificationDynamicFormId;
                Data.ExpectedSubmissionDate = dynamicFormData.ExpectedSubmissionDate;
                Data.SubmissionDate = dynamicFormData.SubmissionDate;
                Data.SubmissionNo = dynamicFormData.SubmissionNo;
                Data.PurposeOfRegistration = dynamicFormData.PurposeOfRegistration;
                Data.VariationNoIds = dynamicFormData.VariationNoIds;
                var ids = _dynamicformObjectDataList.Cast<dynamic>().Where(x => x.DynamicFormDataId == dynamicFormData.ProductSpecificationDynamicFormId).FirstOrDefault();
                if (ids != null)
                {
                    ItemValue = ids;
                }
                var vids = _dynamicformObjectDataVariationList.Cast<dynamic>().Where(x => Data.VariationNoIds.Contains(x.DynamicFormDataId)).ToList();
                if (vids != null)
                {
                    VariationNoValue = vids.Cast<ExpandoObject>().ToList();
                }
                await refRegistrationRequestFormLine.loadChildData(_registrationRequestData);
            }
        }
        else
        {
            await refRegistrationRequestFormLine.loadChildData(_registrationRequestData);
        }
        StateHasChanged();

    }
    string? QueryDisplayDynamicComboBoxText(DropDownBoxQueryDisplayTextContext arg)
    {
        Data.ProductSpecificationDynamicFormId = null;
        string? returnData = string.Empty;
        if (arg.Value is ExpandoObject value)
        {
            if (value != null)
            {
                dynamic eod = value;
                Data.ProductSpecificationDynamicFormId = (long?)eod.DynamicFormDataId;
                returnData = (string)eod.DisplayItemsQuery;
            }
        }
        return returnData.TrimEnd(',');
    }
    string? QueryDisplayVariationDynamicComboBoxText(DropDownBoxQueryDisplayTextContext arg)
    {
        string? returnData = string.Empty;
        Data.VariationNoIds = new List<long?>();
        if (arg.Value != null)
        {
            List<ExpandoObject> collection = (List<ExpandoObject>)arg.Value;
            if (collection != null && collection.Count() > 0)
            {
                foreach (var item in collection)
                {
                    dynamic eod = item;
                    Data.VariationNoIds.Add((long?)eod.DynamicFormDataId);
                    returnData += (string)eod.DisplayItemsQuery + ",";
                }
            }
        }
        return returnData.TrimEnd(',');
    }
    private RenderFragment BuildDataColumns()
    {
        RenderFragment columns = b =>
        {
            int counter = 0;
            if (gridlistss != null && gridlistss.Count() > 0)
            {
                gridlistss.ForEach(s =>
                {
                    int count = 0;
                    b.OpenComponent(counter, typeof(DxGridDataColumn));
                    b.AddAttribute(count + 1, "FieldName", s.Value);
                    b.AddAttribute(count + 1, "AllowSort", true);
                    b.AddAttribute(count + 1, "SortMode", DevExpress.Blazor.GridColumnSortMode.Custom);
                    b.AddAttribute(count + 1, "Caption", s.Text);
                    b.AddAttribute(count + 1, "Visible", s.IsVisible);
                    b.CloseComponent();
                });
            }
        };

        return columns;
    }
    private RenderFragment BuildDataVariationsColumns()
    {
        RenderFragment columns = b =>
        {
            int counter = 0;
            if (_variationgridlistss != null && _variationgridlistss.Count() > 0)
            {
                _variationgridlistss.ForEach(s =>
                {
                    int count = 0;
                    b.OpenComponent(counter, typeof(DxGridDataColumn));
                    b.AddAttribute(count + 1, "FieldName", s.Value);
                    b.AddAttribute(count + 1, "AllowSort", true);
                    b.AddAttribute(count + 1, "SortMode", DevExpress.Blazor.GridColumnSortMode.Custom);
                    b.AddAttribute(count + 1, "Caption", s.Text);
                    b.AddAttribute(count + 1, "Visible", s.IsVisible);
                    b.CloseComponent();
                });
            }
        };

        return columns;
    }
    void GridSelectedDataItemChanged(object item, IDropDownBox dropDownBox)
    {
        if (item != null)
        {
            ItemValue = item as ExpandoObject;
        }
        dropDownBox.HideDropDown();
    }
    void GridVariationSelectedDataItemChanged(IReadOnlyList<object> selectedItems, IDropDownBox dropDownBox)
    {
        List<ExpandoObject> selectedAllItems = new List<ExpandoObject>();
        if (selectedItems != null)
        {
            foreach (object item in selectedItems)
            {
                if (item is ExpandoObject dataselectItems)
                {
                    selectedAllItems.Add(dataselectItems);
                }
            }
        }
        VariationNoValue = selectedAllItems;
        dropDownBox.BeginUpdate();
        dropDownBox.Value = selectedAllItems;
        dropDownBox.EndUpdate();
    }
    void SelectedRegistrationCountryChanged(long? registrationCountryId)
    {
        Data.RegistrationCountryId = registrationCountryId;
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.RegistrationRequestId > 0)
        {
            var request = new InsertorUpdateRegistrationRequest(Data);
            await Mediator.Send(request);
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;
            StateHasChanged();
        }
        else
        {
            Data.SessionId = Guid.NewGuid();
            var request = new InsertorUpdateRegistrationRequest(Data);
            var result = await Mediator.Send(request);
            toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;

            NavigationManager.NavigateTo("RegistrationRequestList/RegistrationRequestForm/" + Data.SessionId + "");


            StateHasChanged();
        }
    }
    void backUrl()
    {
        NavigationManager.NavigateTo("RegistrationRequestList");
    }
    async Task addNew()
    {
        if (SessionId != null)
        {
            NavigationManager.NavigateTo("RegistrationRequestList/RegistrationRequestForm");
        }
        else
        {
            await OnParametersSetLoadAsync();
        }
    }
    async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
    void addDetailDelete()
    {

    }
    public async ValueTask DisposeAsync()
    {
    }
}
