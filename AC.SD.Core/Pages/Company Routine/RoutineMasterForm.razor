@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject AC.SD.Core.Services.ToastService toastService

@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager NavigationManager
@page "/RoutineMasterSetup/RoutineMasterForm"
@page "/RoutineMasterSetup/RoutineMasterForm/{SessionIds:guid}"
<style scoped>
    .save_hover_Master_From_1 {
        float: left;
        margin-top: -41px;
        line-height: 38px;
        margin-left: 200px;
        width: 100px;
    }
</style>
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>

<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm EditContext="this._editContext">
               

               
               
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                           @* <DxFormLayoutTabPage Caption="Section Entry">
                                <DynamicMasterSectionForm @ref="refDynamicMasterSectionForm" dynamicFormId="@dynamicFormId" RevokeBack="BackPermissionPopUp"></DynamicMasterSectionForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Approval Level Entry" Visible=IsApprovalEnabled>
                                <DynamicFormApprovals @ref="refDynamicFormApproval" dynamicFormId="@dynamicFormId"></DynamicFormApprovals>
                            </DxFormLayoutTabPage>*@
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>

        </div>
    </div>


</div>
<DxFlyout @bind-IsOpen=IsFileProfileTypeFilterDocOpen
          PositionTarget=@($"#flyout-overview-target-container-IsFilterFileProfileTypeDocumentOpen")
          RestrictionTarget="#Navigation-Flyout-Customization"
          AnimationType="FlyoutAnimationType.Fade"
          HeaderVisible="true"
          HeaderText="Select FileProfile Type"
          FooterVisible="true"
          FooterCssClass="custom-flyout-footer"
          Width="max(25vw, 550px)"
          CloseOnOutsideClick="false"
          PreventCloseOnPositionTargetClick="true">
    <BodyContentTemplate Context="PopupContext">
        <DxFormLayout CssClass="w-100" style="height: calc(100vh - 250px);overflow:auto;overflow-x:hidden;">
            <DxFormLayoutItem Caption="">
                <DxTreeView @ref="_treeFilterDocView"
                            @bind-FilterString="FilterDocumentString"
                            ShowFilterPanel="true"
                            FilterMode="NavigationFilterMode.EntireBranch"
                            Data="@fileProfileTypeDocumentsAll"
                            AllowSelectNodes="true"
                            SelectionChanged="@SelectionChanged">
                    <DataMappings>
                        <DxTreeViewDataMapping Text="FileName"
                                               Key="DocumentID"
                                               ParentKey="ParentId" />
                    </DataMappings>
                </DxTreeView>
            </DxFormLayoutItem>

        </DxFormLayout>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">
                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsFileProfileTypeFilterDocOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>
@code {
    public List<DocumentsModel> fileProfileTypeDocumentsAll { get; set; }
    public bool IsFileProfileTypeFilterDocOpen { get; set; }
    private DxTreeView _treeFilterDocView;
    string? FilterDocumentString { get; set; }
    EditContext _editContext;
    public long? dynamicFormId { get; set; }
    //private DynamicFormApprovals refDynamicFormApproval;
    //private DynamicMasterSectionForm refDynamicMasterSectionForm;
    [Parameter]
    public Guid? SessionIds { get; set; }
    public ProductionActivityRoutineAppLine _dynamicFormData;
    private bool loading;
    private string MyID = "myid";
    long? EmployeeIds { get; set; }
    bool EditEnabledTab { get; set; } = false;
 
    int ActiveSubTabIndex { get; set; } = 0;
    private ProductionActivityRoutineAppLine Data = new ProductionActivityRoutineAppLine();
    private List<CodeMaster> _controlTypeData;
  
    public ApplicationUser applicationUser { get; private set; }
    string _zindex = "z-index: 9999;";
  
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
     
       
    }
    protected override async Task OnParametersSetAsync()
    {
       // await OnParametersSetLoadAsync();
        base.OnParametersSet();
    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
   
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
           // await refDynamicMasterSectionForm.loadChildData(dynamicFormId);
        }
        else if (e.TabIndex == 1)
        {
            // await refDynamicFormApproval.loadChildData(dynamicFormId);
        }
    }
    void backUrl()
    {
        NavigationManager.NavigateTo("RoutineMasterSetup");
    }
    void ResetForm()
    {
        dynamicFormId = -1;
        ActiveSubTabIndex = 0;
        NavigationManager.NavigateTo("RoutineMasterSetup/RoutineMasterForm");
    }
    async Task addNew()
    {
        if (SessionIds != null)
        {
            NavigationManager.NavigateTo("RoutineMasterSetup/RoutineMasterForm");
        }
        else
        {
           // await OnParametersSetLoadAsync();
        }

    }
    void BackPermissionPopUp(bool? Status)
    {
        if (Status == true)
        {
            _zindex = "";
        }
        else
        {
            _zindex = "z-index: 9999;";
        }
        StateHasChanged();
    }
    async Task HandleValidSubmit()
    {
        loading = true;
       
    }
    void OnButtonFileProfileTypeLinDocClick()
    {
        IsFileProfileTypeFilterDocOpen = true;
    }
    protected void SelectionChanged(TreeViewNodeEventArgs e)
    {
    }
   
   
}
