@page "/fileProfileTypeTreeView"
@page "/fileProfileTypeTreeView/{FileProfileTypeId:long}"
@using Application.Queries;
@using System.IO;
@using System.Runtime.InteropServices.ComTypes;
@using global::Core.Entities;
@using MediatR
@using global::Core.Entities.Views;
@using global::Core.EntityModels;
@inject IMediator Mediator
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime;
@using Microsoft.Extensions.Configuration;
@inject IConfiguration Configuration
@inject ClipboardService ClipboardService
@using global::Core.Repositories.Query;
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
<div class="menu-bar-content-container col-md-12">
    <div class="card w-100" style="margin-bottom:1px;">



        <div class="card-body p-0">

            <DxMenu CollapseItemsToHamburgerMenu="true"
                    CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                    DisplayMode="MenuDisplayMode.Desktop">

                <Items>
                    <DxMenuItem Position="ItemPosition.Start" IconCssClass="fa fa-reply " Click="onBack" />
                    <DxMenuItem Position="ItemPosition.Start" IconCssClass="fa fa-bars" Click="OnShowhide" />
                    <DxMenuItem Position="ItemPosition.End" IconCssClass="fa fa-shield" Click="OnSecurity" Enabled="@securityEnabled" />
                    <DxMenuItem Position="ItemPosition.End" Text="@Name" />
                    <DxMenuItem Position="ItemPosition.End" IconCssClass="fa fa-file-excel" Click="onDownload" Enabled="@ondownloadEnabled" />
                    <DxMenuItem Position="ItemPosition.End" IconCssClass="fa fa-ellipsis-v" Click="onmore" Enabled="@moreEnabled" />
                    <DxMenuItem Position="ItemPosition.End" IconCssClass="fa fa-info-circle " Click="onInfo" Enabled=@informationEnabled />
                  
              
                  
                    <DxMenuItem Text="More" Position="ItemPosition.Start" IconCssClass="fa fa-ellipsis-v">
                        <Items>
                            <DxMenuItem Text="Download" IconCssClass="fa fa-cloud-download" Click="Download" Enabled="@DownloadEnabled" />
                            <DxMenuItem Text="Upload" IconCssClass="fa fa-cloud-upload" Enabled="@uploadEnabled">
                                <TextTemplate>
                                    <label for="input-file" style="cursor:pointer;">
                                        Upload
                                    </label>
                                </TextTemplate>
                            </DxMenuItem>
                            <DxMenuItem Text="View File" IconCssClass="fa fa-eye" Click="onView" Enabled="@viewfileEnabled" />
                            <DxMenuItem Text="Copy Link" IconCssClass="fa fa-clone" Click="onCopy" Enabled="@copylinkEnabled" />


                            <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="onDelete" Enabled="@deleteEnabled" />
                            <DxMenuItem Text="History" IconCssClass="fa fa-history" Click="onHistory" Enabled="@historyEnabled" />
                            <DxMenuItem Text="Check Out" IconCssClass="fa fa-check-square" Click="onCheckOut" Enabled="@checkoutEnabled" />
                            <DxMenuItem Text="Check In" IconCssClass="fa fa-check-circle" Enabled="@checkInEnabled">
                                <TextTemplate>
                                    <label for="input-file" style="cursor:pointer;">
                                        Check In
                                    </label>
                                </TextTemplate>
                            </DxMenuItem>
                            <DxMenuItem Text="Notify" IconCssClass="fa fa-comment" Click="onNotify" Enabled="@NotifyEnabled" />
                            <DxMenuItem Text="Play" IconCssClass="fa fa-play-circle" Click="onPlay" Enabled="@playEnabled" />
                            <DxMenuItem Text="Share" IconCssClass="fa fa-share-square" Click="onShare" Enabled="@shareEnabled" />
                            <DxMenuItem Text="Link Document" IconCssClass="fa fa-link" Click="onLinkDownload" Enabled="@linkdownloadEnabled" />
                            <DxMenuItem Text="Form Details" IconCssClass="fa fa-info-circle" Click="onFormDetails" Enabled="@formdetailsEnabled" />
                            <DxMenuItem Text="View Parent Documents" IconCssClass="fa fa-paperclip" Click="onViewparentDocuments" Enabled="@viewParentEnabled" />
                            <DxMenuItem Text="Rename" IconCssClass="fa fa-pencil" Click="onRename" Enabled="@renameEnabled" />
                            <DxMenuItem Text="Relese For Wiki" IconCssClass="fa fa-paperclip" Click="onReleaseforwiki" Enabled="@releasewikiEnabled" />
                        </Items>
                    </DxMenuItem>

                </Items>
            </DxMenu>
       
        </div>


    </div>
</div>
<div class="">
    <div class="main-container">
        <div class="row">

            <div class="@treeViewDisplay" style="@styleTreeDisplay">
                <div style="height:90%; border: 1px solid #b2afaf; overflow: auto; margin-bottom: 10px; padding:10px;">
                  

                        <div>
                          
                            <div class="views-accordion">
                                <DxTreeView Data="@_TreeData"
                                            @bind-FilterString="FilterString"
                                            FilterMinLength="2"
                                            ShowFilterPanel="true"
                                            FilterMode="FilterMode"
                                            AllowSelectNodes="true"
                                            LoadChildNodesOnDemand=false 
                                            AnimationType="LayoutAnimationType.Slide" SelectionChanged="@SelectionChanged">
                                    <DataMappings>
                                        <DxTreeViewDataMapping Children="Children" CssClass="CssClass" Text="Label" Name="ParentID" />
                                    </DataMappings>
                                </DxTreeView>
                                
                            </div>
                        </div>
                    
                </div>

            </div>
            <div class="@docViewDisplay">
                <div class="" style="margin-top:10px;">
                    <div id="">
                        <div class="">
                            <div class="">
                                

                                

                                <DxLoadingPanel @bind-Visible="PanelVisible"
                                                IsContentBlocked="true"
                                                ApplyBackgroundShading="true"
                                                IndicatorAreaVisible="false"
                                                Text="Fetching Data...">
                                    <DxGrid @ref="Grid"
                                            Data="_fileProfileselectedlst"
                                            KeyFieldName="DocumentID"
                                            EditMode="GridEditMode.EditForm"
                                            SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages"
                                            EditorRenderMode="GridEditorRenderMode.Integrated"
                                            ColumnResizeMode="GridColumnResizeMode.NextColumn"
                                            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                            ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
                                            PagerNavigationMode="PagerNavigationMode.InputBox"
                                            PageSizeSelectorVisible="true"
                                            PageSizeSelectorAllRowsItemVisible="true"
                                            PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                                            PageSize="20" CustomizeElement="Grid_CustomizeElement" ValidationEnabled="false" F
                                            RowClick="OnRowClick"
                                            FocusedRowEnabled="true"
                                            AllowSelectRowByClick="true"
                                            SelectionMode="GridSelectionMode.Single"
                                            CssClass="ch-360"
                                            style="height: calc(100vh - 219px);">
                                        <Columns>

                                            <DxGridDataColumn FieldName="FileName" Caption="File Name" MinWidth="80">
                                                <CellDisplayTemplate>

                                                    @{
                                                        var item = (DocumentsModel)context.DataItem;
                                                    }
                                                    @if (item.IsLocked == true)
                                                    {
                                                        <i class="fa fa-lock" aria-hidden="true" style="margin-right: 5px;"></i>
                                                    }
                                                    @item.FileName
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>
                                            <DxGridDataColumn FieldName="FileProfileTypeName" Caption="Profile Type Name" MinWidth="80" />
                                            <DxGridDataColumn FieldName="ProfileNo" Caption="Profile No" MinWidth="80" />
                                            <DxGridDataColumn FieldName="FileSize" Caption="Size(KB)" MinWidth="80" />
                                            <DxGridDataColumn FieldName="Description" Caption="Description" MinWidth="80" />
                                            <DxGridDataColumn FieldName="ExpiryDate" Caption="Expiry Date" MinWidth="80" />
                                            <DxGridDataColumn FieldName="AddedByUser" Caption="Modified By" MinWidth="80" />
                                            <DxGridDataColumn FieldName="AddedDate" Caption="Modified Date" MinWidth="80" />


                                        </Columns>
                                        <TotalSummary>
                                            <DxGridSummaryItem SummaryType="GridSummaryItemType.Count" FieldName="FileName" />
                                        </TotalSummary>
                                    </DxGrid>
                                </DxLoadingPanel>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<DxPopup @bind-Visible="@PopupVisible"
         ShowFooter="true"
         HeaderText="CRT"
         Width="1000px">
    <BodyContentTemplate>
      <HistoryPopup selectedFiles="@selectedFiles"></HistoryPopup>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Close" Click="@(() => ClosePopup())" />
    </FooterContentTemplate>
</DxPopup>
@code {

    public bool PopupVisible { get; set; } = false;
    [Parameter]
    public DocumentsModel selectedFiles { get; set; }
    IGrid Grid { get; set; }
    [Parameter]
    public long FileProfileTypeId { get; set; }
    DxTreeView treeview;
    private List<Fileprofiletype> _TreeData { get; set; }
    private DocumentTypeModel _fileProfileselectedlstItems { get; set; }
    private List<DocumentsModel> _fileProfileselectedlst { get; set; }
    DocumentsModel ViewFileprofile { get; set; }
    string FilterString { get; set; }
    string SelectedGroup = "none";
    string treeViewDisplay = "col-md-3";
    string docViewDisplay = "col-md-9";
    string styleTreeDisplay = "height: calc(100vh - 150px); padding:10px";
    public DocumentsModel _selectedItems { get; set; }
    NavigationFilterMode FilterMode { get; set; } = NavigationFilterMode.EntireBranch;
    bool PanelVisible { get; set; }
    bool TreeView { get; set; } = false;
    public Fileprofiletype SelectedName { get; set; }
    public string Name;
    public bool DownloadEnabled { get; set; } = false;
    public bool uploadEnabled { get; set; } = false;
    public bool copylinkEnabled { get; set; } = false;
    public bool deleteEnabled { get; set; } = false;
    public bool viewfileEnabled { get; set; } = false;
    public bool historyEnabled { get; set; } = false;
    public bool checkoutEnabled { get; set; } = false;
    public bool checkInEnabled { get; set; } = false;
    public bool NotifyEnabled { get; set; } = false;
    public bool playEnabled { get; set; } = false;
    public bool shareEnabled { get; set; } = false;
    public bool formdetailsEnabled { get; set; } = false;
    public bool linkdownloadEnabled { get; set; } = false;
    public bool viewParentEnabled { get; set; } = false;
    public bool renameEnabled { get; set; } = false;
    public bool releasewikiEnabled { get; set; } = false;
    public bool ondownloadEnabled { get; set; } = false;
    public bool securityEnabled { get; set; } = false;
    public bool moreEnabled { get; set; } = false;
    public bool informationEnabled { get; set; } = false;
    private string? FileUrl;
    private string? DocumentViewUrl;
    private string? ServerUrl;


    public ApplicationUser applicationUser { get; private set; }

    protected override async Task OnInitializedAsync()
    {
        PanelVisible = true;
        DocumentViewUrl = Configuration["DocumentsUrl:DocumentViewer"];
        ServerUrl = Configuration["DocumentsUrl:ServerUrl"];
        FileUrl = Configuration["DocumentsUrl:FileUrl"];
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _TreeData = await Mediator.Send(new GetAllfileprofiletypeQuery(FileProfileTypeId));
        await loadFileProfileData();
        if (_TreeData.Count > 0)
        {
            SelectedName = _TreeData.FirstOrDefault();
            Name = SelectedName.Name;
        }

        PanelVisible = false;
    }
    private async Task SelectionChanged(TreeViewNodeEventArgs e)
    {
        var list = (Fileprofiletype)e.NodeInfo.DataItem;

        if (list != null)
        {
            Name = list.Name;
            FileProfileTypeId = list.FileProfileTypeId;
            await loadFileProfileData();
        }

    }

    private async Task loadFileProfileData()
    {


        if (FileProfileTypeId > 0)
        {
            PanelVisible = true;
            _fileProfileselectedlstItems = await Mediator.Send(new GetAllSelectedfileprofiletypeQuery(FileProfileTypeId));
            _fileProfileselectedlst = _fileProfileselectedlstItems.DocumentsData;


            if (_fileProfileselectedlst.Count > 0)
            {
                _selectedItems = _fileProfileselectedlst.FirstOrDefault();
                DownloadEnabled = true;
                uploadEnabled = true;
                copylinkEnabled = true;
                viewfileEnabled = true;
                deleteEnabled = true;
                historyEnabled = true;
                checkoutEnabled = true;
                checkInEnabled = false;
                playEnabled = true;
                shareEnabled = true;
                NotifyEnabled = true;
                formdetailsEnabled = true;
                linkdownloadEnabled = true;
                formdetailsEnabled = true;
                renameEnabled = true;
                releasewikiEnabled = true;
                viewParentEnabled = true;
                ondownloadEnabled = true;
                moreEnabled = true;
                informationEnabled = true;
                securityEnabled = true;
                if (_selectedItems.IsLocked == true)
                {
                    checkoutEnabled = false;
                    checkInEnabled = true;
                }
            }
            PanelVisible = false;
        }
        StateHasChanged();
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
        if (e.ElementType == GridElementType.HeaderCell)
        {
            e.Style = "background-color: rgba(0, 0, 0, 0.08)";
            e.CssClass = "header-bold";
        }
    }
    async void OnRowClick(GridRowClickEventArgs e)
    {
        checkoutEnabled = true;
        checkInEnabled = false;
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "DocumentID");
        _selectedItems = _fileProfileselectedlst.FirstOrDefault(f => f.DocumentID == (long?)UniqueId);
        if (_selectedItems.IsLocked == true)
        {
            checkoutEnabled = false;
            checkInEnabled = true;
        }
        StateHasChanged();

    }
    void OnShowhide()
    {
        if (TreeView == false)
        {
            treeViewDisplay = "";
            docViewDisplay = "col-md-12";
            styleTreeDisplay = "height: calc(100vh - 150px); padding:10px;display:none;";
            TreeView = true;
        }
        else
        {
            treeViewDisplay = "col-md-3";
            docViewDisplay = "col-md-9";
            styleTreeDisplay = "height: calc(100vh - 150px); padding:10px";
            TreeView = false;
        }
        StateHasChanged();
    }
    void onBack()
    {
        NavigationManager.NavigateTo($"fileprofiletypedocument/");
    }


    private async Task onCopy()
    {
        if (_selectedItems != null && _selectedItems.DocumentID > 0 && _selectedItems.FilePath != null)
        {
            if (_selectedItems.IsNewPath == true)
            {
                var url = DocumentViewUrl + "?url=" + FileUrl + _selectedItems.FilePath;
                await ClipboardService.WriteTextAsync(url);
                toastService.ShowToast("Copied", AC.SD.Core.Services.ToastLevel.Info);
            }
            else
            {
                var url = DocumentViewUrl + "?url=" + ServerUrl + _selectedItems.FilePath;
                await ClipboardService.WriteTextAsync(url);
                toastService.ShowToast("Copied", AC.SD.Core.Services.ToastLevel.Info);
            }
        }
    }
    private void LoadFiles(InputFileChangeEventArgs e)
    {

    }
    void OnSecurity()
    {

    }
    void onDownload()
    {

    }
    void onmore()
    {

    }
    void onInfo()
    {

    }
    async Task Download()
    {
        if (_selectedItems.DocumentID > 0 && _selectedItems.FilePath != null)
        {
            var response = await Mediator.Send(new GetFileDownload(_selectedItems.DocumentID));
            if (response.StatusCodeID == 0)
            {
                toastService.ShowToast("File Not Exits", AC.SD.Core.Services.ToastLevel.Error);
            }
            else
            {
                //  Trigger file download
                await JSRuntime.InvokeVoidAsync("downloadFile", _selectedItems.FileName, response.ImageData, "");
            }
        }
    }
    void onUpload()
    {

    }
    async void onView()
    {
        if (_selectedItems.DocumentID > 0 && _selectedItems.FilePath != null)
        {
            if (_selectedItems.IsNewPath == true)
            {
                var url = DocumentViewUrl + "?url=" + FileUrl + _selectedItems.FilePath;
                await OpenDocumentPreview(url);
            }
            else
            {
                var url = DocumentViewUrl + "?url=" + ServerUrl + _selectedItems.FilePath;
                await OpenDocumentPreview(url);
            }
        }
    }
    private async Task OpenDocumentPreview(string url)
    {
        await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }
    async Task onDelete()
    {
        if (_selectedItems.DocumentID > 0)
        {
            await Mediator.Send(new GetFileProfileTypeDelete(_selectedItems));
            await loadFileProfileData();
        }
    }
    async Task onHistory()
    {

       
        selectedFiles = _selectedItems;
        PopupVisible = true;
      
    }
   
    async Task onCheckOut()
    {
        if (_selectedItems.DocumentID > 0)
        {
            await Mediator.Send(new GetFileProfileTypeCheckOut(_selectedItems));
            await loadFileProfileData();
            await Download();
        }
    }
    async Task onCheckin()
    {

    }
    void onNotify()
    {

    }
    void onPlay()
    {

    }
    void onShare()
    {

    }
    void onLinkDownload()
    {

    }
    void onFormDetails()
    {

    }
    void onViewparentDocuments()
    {

    }
    void onRename()
    {

    }
    void onReleaseforwiki()
    {

    }
    void ClosePopup()
    {
        PopupVisible = false;
    }
}
