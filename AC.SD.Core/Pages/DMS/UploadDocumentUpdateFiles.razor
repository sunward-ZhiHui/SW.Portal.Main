@using Application.Queries;
@using MediatR;
@using Newtonsoft.Json;
@using global::Core.Entities;
@using global::Core.EntityModels;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@inject IMediator Mediator
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IJSRuntime JSRuntime;
@inject IJSRuntime jsRuntime
@inject AC.SD.Core.Services.ToastService toastService
@inject NavigationManager Navigator
<style>
    .dxuc-file-list-view {
        padding: 20px;
    }

    .dxuc-upload-icon {
        display: none; /* or any other style to disable or hide the icon */
    }

    .isUploadCheckOut {
        display: none;
    }
</style>
<div class="card" style="margin-bottom:10px; margin-top: 10px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                    </Items>
                </DxMenu>
            </div>
            <div class="@IsUploadExt" style="float: left; margin-top: -40px; line-height: 38px; margin-left: 104px; z-index: 9999; width:100px;">
                <div id="attachmentCheckInSelectButton" style="height: 33px;" class="btn border-primary btn-primary m-1 handline">Select File</div>
            </div>
            <div class="@IsUploadExt" style="float: left; margin-top: -41px; line-height: 38px; margin-left: 8px; z-index: 9999; width:100px;">
                <button type="submit" form="@UploadDocFormID" disabled="@checkInloading" class="btn border-primary btn-primary m-1 handline" onclick="@onSubmitCheckInUploadFormClick">
                    @if (checkInloading)
                    {
                        <span class="spinner-border spinner-border-sm mr-1"></span>
                    }
                    <i class="fa fa-upload"></i>
                    @Message
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card w-100" style="margin-bottom:10px; margin-top:10px">
    <div class="card-body p-0">
        <div class="row">
            <div class="col-md-6">
                <span style="font-weight: bold;padding: 10px;line-height: 30px;color:green;">Document Name:  @selectedItems.FileName</span>
            </div>
            <div class="col-md-6">
                <span style="font-weight: bold;padding: 10px;line-height: 30px;color:green;">Allowed FileExtensions:  @ExtensionsList</span>
            </div>
        </div>
    </div>
</div>
<div class="" style="margin-left:10px;">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm Model="@Data" id="@UploadDocFormID" Context="EditFormContext" OnValidSubmit="@HandleValidCheckInSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />
                    <DxFormLayoutItem Caption="Expiry Date:" ColSpanMd="6" Visible="@isExpiryDate">
                        <DxDateEdit NullText="Select a Expiry Date..." MinDate="DateTime.Now" @bind-Date="@Data.ExpiryDate" CssClass="cw-320" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description" ColSpanMd="6">
                        <DxMemo @bind-Text="@Data.Description" Rows="5" ShowValidationIcon="true" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="" ColSpanMd="12">

                        <div class="" style="height: calc(100vh - 565px);overflow: auto;overflow-x: hidden;">
                            <DxUpload @ref="uploadCheckInComponent" Name="files"
                                      Visible="@AttachmentCheckInUploadVisible"
                                      AcceptedFileTypes=@AcceptedFileTypes
                                      ChunkSize="200000"
                                      UploadMode="@UploadMode.OnButtonClick"
                                      FileUploadStart="OnFileUploadStart"
                                      AllowMultiFileUpload="false"
                                      ExternalSelectButtonCssSelector="#attachmentCheckInSelectButton"
                                      SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                      FileUploaded="@isUploadSuccess"
                                      FileUploadProgressChanged="@OnUploadProgressChanged"
                                      FileUploadStarted="@OnFileUploadStarted"
                                      FileUploadError="@OnUploadError">
                            </DxUpload>

                        </div>
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
        </div>
    </div>
</div>
@code {
    [Parameter]
    public DocumentsModel selectedItems { get; set; }
    [Parameter]
    public Guid? FileProfileSessionId { get; set; }
    [Parameter]
    public ApplicationUser applicationUser { get; set; }
    string UploadDocFormID = "UploadDocCheckInForm";
    public bool checkInloading { get; set; } = false;
    string Message = "Upload";
    [Parameter]
    public Action RevokeBack { get; set; }
    string IsUploadExt = ".isUploadCheckOut";
    bool isExpiryDate { get; set; } = false;
    DocumentsUploadModel Data = new DocumentsUploadModel();
    bool AttachmentCheckInUploadVisible { get; set; } = false;
    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    private DxUpload uploadCheckInComponent;
    public List<string> AcceptedFileTypes { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF", ".txt", ".TXT" };
    string ExtensionsList = "";
    int SelectedFilesCount { get; set; }
    int CurrentUplodCount { get; set; }
    public List<DocumentsUploadModel> TempSetIds = new List<DocumentsUploadModel>();
    protected override async Task OnInitializedAsync()
    {
        IsUploadExt = "";
        if (selectedItems != null)
        {
            //AcceptedFileTypes = new List<string>();
            if (!string.IsNullOrEmpty(selectedItems.Extension))
            {
                var contentType = selectedItems.ContentType != null ? selectedItems.ContentType.Split("/").First().ToLower() : "";
                var extenionType = selectedItems.Extension.ToLower();
                if (extenionType == "txt")
                {
                    AcceptedFileTypes = new List<string>() { ".txt" };
                }
                else if (extenionType == "pdf")
                {
                    AcceptedFileTypes = new List<string>() { ".pdf" };
                }
                else if (extenionType == "ppt" || extenionType == "pptx")
                {
                    AcceptedFileTypes = new List<string>() { ".ppt", "pptx" };
                }
                else if (extenionType == "doc" || extenionType == "docx")
                {
                    AcceptedFileTypes = new List<string>() { ".doc", ".docx" };
                }
                else if (extenionType == "xls" || extenionType == "xlsx")
                {
                    AcceptedFileTypes = new List<string>() { ".xls", ".xlsx" };
                }
                else
                {
                    if (contentType == "image")
                    {
                        AcceptedFileTypes = new List<string>() { "image/*" };
                    }
                    else if (contentType == "video")
                    {
                        AcceptedFileTypes = new List<string>() { "video/*" };
                    }
                    else
                    {
                        IsUploadExt = ".isUploadCheckOut";
                    }
                }
            }
            if (selectedItems.IsExpiryDate == true)
            {
                isExpiryDate = true;
            }
            ExtensionsList = string.Join(",", AcceptedFileTypes.ConvertAll(d => d.ToLower()).Distinct().ToList());

            Data.IsCheckOut = true;
            Data.DocumentParentId = selectedItems.DocumentID;
            Data.DocumentMainParentId = selectedItems.DocumentParentId;
            Data.UserSession = applicationUser.SessionId;
            Data.UserId = applicationUser.UserID;
            Data.ProfileId = selectedItems.ProfileID;
            Data.SessionId = selectedItems.SessionId;
            Data.ProfileNo = selectedItems.ProfileNo;
            Data.FileProfileTypeId = selectedItems.FileProfileTypeId > 0 ? selectedItems.FileProfileTypeId : selectedItems.FilterProfileTypeId;
            StateHasChanged();
        }
    }
    void OnFileUploadStart(FileUploadStartEventArgs e)
    {
        Message = "Uploading...";
        checkInloading = true;
        //var newSessionId = FileProfileSessionId == null ? selectedItems.SessionId : FileProfileSessionId;
        string BaseUrl = Navigator.BaseUri + "api/FileUpload/";
        string url = BaseUrl + "UploadDocumentsBySession?SessionId=" + FileProfileSessionId + "&addedByUserId=" + applicationUser.UserID + "&IsNewSession=true";
        e.UploadUrl = url;
    }
    void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentCheckInUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
        SelectedFilesCount = files.ToList().Count; //Count current files
        InvokeAsync(StateHasChanged);
    }
    void OnFileUploadStarted(FileUploadEventArgs e)
    {
        var MyMessage = "Upload of the " + e.FileInfo.Name + " file was started.";
        toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Info);
        InvokeAsync(StateHasChanged);
    }
    async Task isUploadSuccess(FileUploadEventArgs e)
    {
        CurrentUplodCount++;
        var filesessionIds = new Guid(e.FileInfo.Guid);
        var ext = e.FileInfo.Name.Split(".").Last();
        Data.FilePath = @"Documents\" + FileProfileSessionId + @"\" + filesessionIds + "." + ext;
        Data.FileSessionId = FileProfileSessionId;
        var response = await Mediator.Send(new UpdateCreateDocumentBySession(Data));
        if (response.SessionId != null)
        {
            var MyMessage = "Upload of the " + e.FileInfo.Name + " file is Completed.";
            toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Success);
            Message = "Upload";
            checkInloading = false;
            backUrl();
        }

    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        var MyError = e.RequestInfo.ResponseText;
        toastService.ShowToast(MyError, AC.SD.Core.Services.ToastLevel.Error);
        Message = "Upload";
        checkInloading = false;
        InvokeAsync(StateHasChanged);
    }
    void OnUploadProgressChanged(FileUploadEventArgs e)
    {
        var progress = e.FileInfo.LoadedBytes / e.FileInfo.Size * 100;
    }
    void backUrl()
    {
        RevokeBack?.Invoke();
    }
    void onSubmitCheckInUploadFormClick()
    {
        uploadCheckInComponent.UploadAllFiles();
    }
    void HandleValidCheckInSubmit()
    {

    }
}
