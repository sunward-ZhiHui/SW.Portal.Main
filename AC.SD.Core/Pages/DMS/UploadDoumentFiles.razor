@using Application.Queries;
@using MediatR;
@using Newtonsoft.Json;
@using global::Core.Entities;
@using global::Core.EntityModels;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@inject IMediator Mediator
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IJSRuntime JSRuntime;
@using Microsoft.Extensions.Configuration;
@inject IConfiguration Configuration
@inject ClipboardService ClipboardService
@inject IJSRuntime jsRuntime
@inject AC.SD.Core.Services.ToastService toastService
@inject NavigationManager Navigator
<style>
    .dxuc-file-list-view {
        padding: 20px;
    }

    .dxuc-upload-icon {
        display: none; /* or any other style to disable or hide the icon */
    }
</style>
<div class="card" style="margin-bottom:10px; margin-top: 10px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                    </Items>
                </DxMenu>
            </div>
            <div class="" style="float: left; margin-top: -41px; line-height: 38px; margin-left: 104px; z-index: 9999; width:100px;">
                <button type="submit" form="@UploadDocFormID" disabled="@loading" class="btn border-primary btn-primary m-1 handline" onclick="@onsubmitUploadFromClick">
                    @if (loading)
                    {
                        <span class="spinner-border spinner-border-sm mr-1"></span>
                    }
                    <i class="fa fa-save"></i>
                    @Message
                </button>
            </div>

        </div>
    </div>
</div>


<div class="" style="margin-left:10px;">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
<EditForm Model="@Data" id="@UploadDocFormID" Context="EditFormContext" OnValidSubmit="@HandleValidSubmit">

    <DxFormLayout CssClass="w-100">
        <DataAnnotationsValidator />
        <DxFormLayoutItem Caption="Company" ColSpanMd="6">
            <DxComboBox Data="@_plantItems"
                        NullText="Select Company..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="PlantCode"
                        ValueFieldName="PlantID"
                        SelectedItemChanged="@((ViewPlants plantSelect) => SelectedItemChanged(plantSelect?.PlantID))"
                        Enabled="isPlant"
            @bind-Value="@Data.PlantId" ShowValidationIcon="true">
                <Columns>
                    <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                        Caption="Plant Code"
                                        Width="180px" />
                    <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                        Caption="Description" />
                    <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                        Caption="Nav Company" />
                </Columns>
            </DxComboBox>
            <ValidationMessage For="@(() => Data.PlantId)" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="Division" ColSpanMd="6">
            <DxComboBox Data="@_divisionItems"
                        NullText="Select Division..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="Name"
                        ValueFieldName="DivisionID"
                        Enabled="isDivision"
                        SelectedItemChanged="@((ViewDivision plantSelect) => SelectedItemDivisionChanged(plantSelect?.DivisionID))"
            @bind-Value="@Data.DivisionId" ShowValidationIcon="true">
                <Columns>
                    <DxListEditorColumn FieldName="@nameof(ViewDivision.Name)"
                                        Caption="Name"
                                        Width="180px" />
                    <DxListEditorColumn FieldName="@nameof(ViewDivision.Code)"
                                        Caption="Code" />
                    <DxListEditorColumn FieldName="@nameof(ViewDivision.Description)"
                                        Caption="Description" />
                </Columns>
            </DxComboBox>
            <ValidationMessage For="@(() => Data.DivisionId)" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="Department" ColSpanMd="6">
            <DxComboBox Data="@_departmentItems"
                        NullText="Select Department..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="DepartmentName"
                        ValueFieldName="DepartmentId"
                        Enabled="isDepartment"
                        SelectedItemChanged="@((ViewDepartment plantSelect) => SelectedItemDepartementChanged(plantSelect?.DepartmentId))"
            @bind-Value="@Data.DepartmentId" ShowValidationIcon="true">
                <Columns>
                    <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentName)"
                                        Caption="Name"
                                        Width="180px" />
                    <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentCode)"
                                        Caption="Code" />
                    <DxListEditorColumn FieldName="@nameof(ViewDepartment.Description)"
                                        Caption="Description" />
                </Columns>
            </DxComboBox>
            <ValidationMessage For="@(() => Data.DepartmentId)" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="Section" ColSpanMd="6">
            <DxComboBox Data="@_sectionItems"
                        NullText="Select Section..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="SectionName"
                        ValueFieldName="SectionId"
                        Enabled="isSection"
                        SelectedItemChanged="@((ViewSection plantSelect) => SelectedItemSectionChanged(plantSelect?.SectionId))"
            @bind-Value="@Data.SectionId" ShowValidationIcon="true">
                <Columns>
                    <DxListEditorColumn FieldName="@nameof(ViewSection.SectionName)"
                                        Caption="Name"
                                        Width="180px" />
                    <DxListEditorColumn FieldName="@nameof(ViewSection.SectionCode)"
                                        Caption="Code" />
                    <DxListEditorColumn FieldName="@nameof(ViewSection.Description)"
                                        Caption="Description" />
                </Columns>
            </DxComboBox>
            <ValidationMessage For="@(() => Data.SectionId)" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="SubSection" ColSpanMd="6">
            <DxComboBox Data="@_subSectionItems"
                        NullText="Select SubSection..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="SubSectionName"
                        ValueFieldName="SubSectionId"
                        Enabled="isSubSection"
            @bind-Value="@Data.SubSectionId" ShowValidationIcon="true">
                <Columns>
                    <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionName)"
                                        Caption="Name"
                                        Width="180px" />
                    <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionCode)"
                                        Caption="Code" />
                    <DxListEditorColumn FieldName="@nameof(ViewSubSection.Description)"
                                        Caption="Description" />
                </Columns>
            </DxComboBox>
            <ValidationMessage For="@(() => Data.SubSectionId)" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="Expiry Date:" ColSpanMd="6" Visible="@isExpiryDate">
            <DxDateEdit NullText="Select a Expiry Date..." MinDate="DateTime.Now" @bind-Date="@Data.ExpiryDate" CssClass="cw-320" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="Description" ColSpanMd="6">
            <DxMemo @bind-Text="@Data.Description" Rows="5" ShowValidationIcon="true" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="" ColSpanMd="12">
            <div id="attachmentSelectButton" style="height: 33px;" class="btn border-primary btn-primary m-1 handline">Select File</div>
                        <div class="" style="height: calc(100vh - 565px);overflow: auto;overflow-x: hidden;">
                <DxUpload @ref="uploadComponent" Name="files"
                          Visible="@AttachmentUploadVisible"
                          AcceptedFileTypes=@AcceptedFileTypes  
                          ChunkSize="200000"
                          UploadMode="@UploadMode.OnButtonClick"
                          FileUploadStart="OnFileUploadStart"
                          AllowMultiFileUpload="true"
                          ExternalSelectButtonCssSelector="#attachmentSelectButton"
                          SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                          FileUploaded="@isUploadSuccess"
                          FileUploadProgressChanged="@OnUploadProgressChanged"
                          FileUploadStarted="@OnFileUploadStarted"
                          FileUploadError="@OnUploadError">
                </DxUpload>
                <div class="alert alert-info @(MessageVisible? " visible" : " invisible")">@MyMessage</div>

                <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>
            </div>
        </DxFormLayoutItem>
    </DxFormLayout>
</EditForm>
</div>
</div>
</div>
@code {
    public DocumentsModel selectedFiles { get; set; }
    public ApplicationUser applicationUser { get; set; }
    [Parameter]
    public Action RevokeBack { get; set; }
    [Parameter]
    public string UploadDocFormID { get; set; }
    public bool loading { get; set; } = false;
    string Message => loading ? "Uploading..." : "Upload";
    private List<ViewPlants>? _plantItems;
    private List<ViewDivision>? _divisionItems;
    private List<ViewDepartment>? _departmentItems;
    private List<ViewSection>? _sectionItems;
    private List<ViewSubSection>? _subSectionItems;
    bool AttachmentUploadVisible { get; set; } = false;
    DocumentsUploadModel Data = new DocumentsUploadModel();
    public DocumentProfileNoSeriesModel documentProfileNoSeriesData { get; set; }
    private DxUpload uploadComponent;
    string MyError { get; set; }
    bool ErrorVisible { get; set; } = false;
    string MyMessage { get; set; }
    bool MessageVisible { get; set; } = false;
    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    bool isExpiryDate { get; set; } = false;
    bool isPlant { get; set; } = false;
    bool isDivision { get; set; } = false; bool isDepartment { get; set; } = false;
    bool isSection { get; set; } = false; bool isSubSection { get; set; } = false;
    public List<string> AcceptedFileTypes { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF" };
    protected override async Task OnInitializedAsync()
    {

    }
    public async Task loadData(DocumentsModel _selectedFiles,ApplicationUser _applicationUser)
    {
        uploadComponent.RemoveAllFiles();
        MessageVisible = false;
        if (_selectedFiles != null)
        {
            selectedFiles=_selectedFiles;
            applicationUser = _applicationUser;
            documentProfileNoSeriesData = await Mediator.Send(new GetDocumentProfileNoSeriesById(selectedFiles.ProfileID));

            dynamic abbreviation = JsonConvert.DeserializeObject(documentProfileNoSeriesData.Abbreviation1);
            if (abbreviation != null)
            {
                foreach (var item in abbreviation)
                {
                    var itemsId = item.Id;
                    if (itemsId == 1)
                    {
                        isPlant = true;
                        Data.PlantId = null;
                    }
                    if (itemsId == 2)
                    {
                        isDepartment = true; isDivision = true;
                        Data.DepartmentId = null;
                        Data.DivisionId = null;
                    }
                    if (itemsId == 3)
                    {
                        isSection = true;
                        Data.SectionId = null;
                    }
                    if (itemsId == 4)
                    {
                        isSubSection = true;
                        Data.SubSectionId = null;
                    }
                }
            }
            if (selectedFiles.IsExpiryDate == true)
            {
                isExpiryDate = true;
            }
            Data.UserSession = applicationUser.SessionId;
            Data.UserId = applicationUser.UserID;
            Data.ProfileId = selectedFiles.ProfileID;
            Data.FileProfileTypeId = selectedFiles.FileProfileTypeId > 0 ? selectedFiles.FileProfileTypeId : selectedFiles.FilterProfileTypeId;
        }
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        await SelectedItemChanged(0);
        await SelectedItemDivisionChanged(0);
        await SelectedItemDepartementChanged(0);
        await SelectedItemSectionChanged(0);
        StateHasChanged();
    }
    void backUrl()
    {
        RevokeBack?.Invoke();
    }
    async Task OnFileUploadStart(FileUploadStartEventArgs e)
    {
        loading = true;
        var SessionId = new Guid(e.FileInfo.Guid);
        Data.SessionId = SessionId;
        var response = await Mediator.Send(new InsertCreateDocument(Data));
        if (response.DocumentId > 0)
        {
            string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
            string url = BaseUrl + "Upload/uploadchunkfile?SessionId=" + SessionId + "&DocumentId=" + response.DocumentId;
            e.UploadUrl = url;
            loading = false;
        }
    }
    void OnFileUploadStarted(FileUploadEventArgs e)
    {
        MyMessage = "Upload of the " + e.FileInfo.Name + " file was started.";
        MessageVisible = true;
        InvokeAsync(StateHasChanged);
    }
    void OnUploadProgressChanged(FileUploadEventArgs e)
    {
        var progress = e.FileInfo.LoadedBytes / e.FileInfo.Size * 100;
    }
    async Task SelectedItemChanged(long? plantID)
    {
        _divisionItems = new List<ViewDivision>();
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (plantID > 0)
        {
            _divisionItems = await Mediator.Send(new GetDivisionByCompany(plantID));
        }
    }
    async Task SelectedItemDivisionChanged(long? divisionId)
    {
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (divisionId > 0)
        {
            _departmentItems = await Mediator.Send(new GetDepartmentByDivision(divisionId));
        }
    }
    async Task SelectedItemDepartementChanged(long? departmentId)
    {
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (departmentId > 0)
        {
            _sectionItems = await Mediator.Send(new GetSectionByDepartment(departmentId));
        }
    }
    async Task SelectedItemSectionChanged(long? sectionId)
    {
        _subSectionItems = new List<ViewSubSection>();
        if (sectionId > 0)
        {
            _subSectionItems = await Mediator.Send(new GetSubSectionBySection(sectionId));
        }
    }
    protected async void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
    }
    private void isUploadSuccess()
    {
        //backUrl();
    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }
    public void onsubmitUploadFromClick()
    {
    }
    public async Task HandleValidSubmit()
    {
        uploadComponent.UploadAllFiles();
    }
}
