@using Application.Queries;
@using MediatR;
@using Newtonsoft.Json;
@using global::Core.Entities;
@using global::Core.EntityModels;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@inject IMediator Mediator
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IJSRuntime JSRuntime;
@using Microsoft.Extensions.Configuration;
@inject IConfiguration Configuration
@inject ClipboardService ClipboardService
@inject IJSRuntime jsRuntime
@inject AC.SD.Core.Services.ToastService toastService
@inject NavigationManager Navigator
@implements IAsyncDisposable
@* @inject AC.SD.Core.Helpers.TreeGenerateRecursive _treeGenerateRecursive *@
<style>
    .dxuc-file-list-view {
        padding: 20px;
    }

    .dxuc-upload-icon {
        display: none; /* or any other style to disable or hide the icon */
    }
</style>
<div class="card" style="margin-bottom:10px; margin-top: 10px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@LinkDocbackUrl" />
                        <DxMenuItem Text="Select File" IconCssClass="fa fa-paperclip" id="attachmentLinkDocSelectButton" Enabled="@loadingLinkDoc" Click="onGetExitingFile" />
                        <DxMenuItem Text="@LinkDocMessage" IconCssClass="fa fa-upload" Click="@onsubmitUploadLinkDocFromClick" Enabled="@loadingLinkDoc" />
                    </Items>
                </DxMenu>
            </div>

        </div>
    </div>
</div>


<div class="" style="margin-left:10px;">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="@HandleValidLinkDocSubmit">

                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />
                    <DxFormLayoutItem Caption="File ProfileType" ColSpanMd="10">
                        <DxTextBox @bind-Text=@LinkDocFileprofiletypeName Enabled="IsFileProfileTypeLinkDocShow">
                            <Buttons>
                                <DxEditorButton IconCssClass="fa fa-add" Id=@($"flyout-overview-target-container-IsFileProfileTypeLinkDocOpen")
                                                Tooltip="Select File ProfileType"
                                                Click="@(_ => OnButtonFileProfileTypeLinDocClick())" />
                            </Buttons>
                        </DxTextBox>
                        <DxSpinEdit @bind-Value="@Data.FileProfileTypeId" ShowValidationIcon="true" style="display:none;" />
                        <ValidationMessage For="@(() => Data.FileProfileTypeId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">

                        <DxDropDownBox @bind-Value="PlantValue"
                                       QueryDisplayText="QueryPlantText"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Select a Company..."
                                       Enabled="isPlantLinkDoc"
                                       ShowValidationIcon="true">
                            <DropDownBodyTemplate Context="ddbBodyContext">
                                <DxGrid Data="@_plantItems"
                                        KeyFieldName="@nameof(ViewPlants.PlantID)" ShowSearchBox="true"
                                        HighlightRowOnHover="true"
                                        SearchTextParseMode="GridSearchTextParseMode.GroupWordsByAnd"
                                        SelectionMode="GridSelectionMode.Single"
                                        AllowSelectRowByClick="true"
                                        FocusedRowEnabled="true"
                                        TextWrapEnabled="false"
                                        CssClass="templateGrid"
                                        SelectedDataItem="@(ddbBodyContext.DropDownBox.Value as ViewPlants)"
                                        SelectedDataItemChanged="item => GridSelectedDataItemChanged(item, ddbBodyContext.DropDownBox)">
                                    <Columns>
                                        <DxGridDataColumn FieldName="PlantCode" />
                                        <DxGridDataColumn FieldName="Description" />
                                        <DxGridDataColumn FieldName="NavCompanyName" />
                                    </Columns>
                                </DxGrid>
                            </DropDownBodyTemplate>
                        </DxDropDownBox>
                        <DxSpinEdit @bind-Value="@Data.PlantId" ShowValidationIcon="true" style="display:none;" />
                        <ValidationMessage For="@(() => Data.PlantId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Division" ColSpanMd="6">

                        <DxDropDownBox @bind-Value="DivisionValue"
                                       QueryDisplayText="QueryDivisionText"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Select a Division..."
                                       Enabled="isDivisionLinkDoc"
                                       ShowValidationIcon="true">
                            <DropDownBodyTemplate Context="ddbBodyContext">
                                <DxGrid Data="@_divisionItems"
                                        KeyFieldName="@nameof(ViewDivision.DivisionID)" ShowSearchBox="true"
                                        HighlightRowOnHover="true"
                                        SearchTextParseMode="GridSearchTextParseMode.GroupWordsByAnd"
                                        SelectionMode="GridSelectionMode.Single"
                                        AllowSelectRowByClick="true"
                                        FocusedRowEnabled="true"
                                        TextWrapEnabled="false"
                                        CssClass="templateGrid"
                                        SelectedDataItem="@(ddbBodyContext.DropDownBox.Value as ViewDivision)"
                                        SelectedDataItemChanged="item => GridDivisionSelectedDataItemChanged(item, ddbBodyContext.DropDownBox)">
                                    <Columns>
                                        <DxGridDataColumn FieldName="@nameof(ViewDivision.Name)" Caption="Name" />
                                        <DxGridDataColumn FieldName="@nameof(ViewDivision.Code)" Caption="Code" />
                                        <DxGridDataColumn FieldName="@nameof(ViewDivision.Description)" Caption="Description" />
                                    </Columns>
                                </DxGrid>
                            </DropDownBodyTemplate>
                        </DxDropDownBox>
                        <DxSpinEdit @bind-Value="@Data.DivisionId" ShowValidationIcon="true" style="display:none;" />
                        <ValidationMessage For="@(() => Data.DivisionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Department" ColSpanMd="6">

                        <DxDropDownBox @bind-Value="DepartmentValue"
                                       QueryDisplayText="QueryDepartmentText"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Select a Department..."
                                       Enabled="isDepartmentLinkDoc"
                                       ShowValidationIcon="true">
                            <DropDownBodyTemplate Context="ddbBodyContext">
                                <DxGrid Data="@_departmentItems"
                                        KeyFieldName="@nameof(ViewDepartment.DepartmentId)" ShowSearchBox="true"
                                        HighlightRowOnHover="true"
                                        SearchTextParseMode="GridSearchTextParseMode.GroupWordsByAnd"
                                        SelectionMode="GridSelectionMode.Single"
                                        AllowSelectRowByClick="true"
                                        FocusedRowEnabled="true"
                                        TextWrapEnabled="false"
                                        CssClass="templateGrid"
                                        SelectedDataItem="@(ddbBodyContext.DropDownBox.Value as ViewDepartment)"
                                        SelectedDataItemChanged="item => GridDepartmentSelectedDataItemChanged(item, ddbBodyContext.DropDownBox)">
                                    <Columns>
                                        <DxGridDataColumn FieldName="@nameof(ViewDepartment.DepartmentName)" Caption="Name" />
                                        <DxGridDataColumn FieldName="@nameof(ViewDepartment.DepartmentCode)" Caption="Code" />
                                        <DxGridDataColumn FieldName="@nameof(ViewDepartment.Description)" Caption="Description" />
                                    </Columns>
                                </DxGrid>
                            </DropDownBodyTemplate>
                        </DxDropDownBox>
                        <DxSpinEdit @bind-Value="@Data.DepartmentId" ShowValidationIcon="true" style="display:none;" />
                        <ValidationMessage For="@(() => Data.DepartmentId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Section" ColSpanMd="6">

                        <DxDropDownBox @bind-Value="SectionValue"
                                       QueryDisplayText="QuerySectionText"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Select a Section..."
                                       Enabled="isSectionLinkDoc"
                                       ShowValidationIcon="true">
                            <DropDownBodyTemplate Context="ddbBodyContext">
                                <DxGrid Data="@_sectionItems"
                                        KeyFieldName="@nameof(ViewSection.SectionId)" ShowSearchBox="true"
                                        HighlightRowOnHover="true"
                                        SearchTextParseMode="GridSearchTextParseMode.GroupWordsByAnd"
                                        SelectionMode="GridSelectionMode.Single"
                                        AllowSelectRowByClick="true"
                                        FocusedRowEnabled="true"
                                        TextWrapEnabled="false"
                                        CssClass="templateGrid"
                                        SelectedDataItem="@(ddbBodyContext.DropDownBox.Value as ViewSection)"
                                        SelectedDataItemChanged="item => GridSectionSelectedDataItemChanged(item, ddbBodyContext.DropDownBox)">
                                    <Columns>
                                        <DxGridDataColumn FieldName="@nameof(ViewSection.SectionName)" Caption="Name" />
                                        <DxGridDataColumn FieldName="@nameof(ViewSection.SectionCode)" Caption="Code" />
                                        <DxGridDataColumn FieldName="@nameof(ViewSection.Description)" Caption="Description" />
                                    </Columns>
                                </DxGrid>
                            </DropDownBodyTemplate>
                        </DxDropDownBox>
                        <DxSpinEdit @bind-Value="@Data.SectionId" ShowValidationIcon="true" style="display:none;" />
                        <ValidationMessage For="@(() => Data.SectionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="SubSection" ColSpanMd="6">

                        <DxDropDownBox @bind-Value="SubSectionValue"
                                       QueryDisplayText="QuerySubSectionText"
                                       ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                       NullText="Select a Sub Section..."
                                       Enabled="isSubSectionLinkDoc"
                                       ShowValidationIcon="true">
                            <DropDownBodyTemplate Context="ddbBodyContext">
                                <DxGrid Data="@_subSectionItems"
                                        KeyFieldName="@nameof(ViewSubSection.SubSectionId)" ShowSearchBox="true"
                                        HighlightRowOnHover="true"
                                        SearchTextParseMode="GridSearchTextParseMode.GroupWordsByAnd"
                                        SelectionMode="GridSelectionMode.Single"
                                        AllowSelectRowByClick="true"
                                        FocusedRowEnabled="true"
                                        TextWrapEnabled="false"
                                        CssClass="templateGrid"
                                        SelectedDataItem="@(ddbBodyContext.DropDownBox.Value as ViewSubSection)"
                                        SelectedDataItemChanged="item => GridSubSectionSelectedDataItemChanged(item, ddbBodyContext.DropDownBox)">
                                    <Columns>
                                        <DxGridDataColumn FieldName="@nameof(ViewSubSection.SubSectionName)" Caption="Name" />
                                        <DxGridDataColumn FieldName="@nameof(ViewSubSection.SubSectionCode)" Caption="Code" />
                                        <DxGridDataColumn FieldName="@nameof(ViewSubSection.Description)" Caption="Description" />
                                    </Columns>
                                </DxGrid>
                            </DropDownBodyTemplate>
                        </DxDropDownBox>
                        <DxSpinEdit @bind-Value="@Data.SubSectionId" ShowValidationIcon="true" style="display:none;" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Expiry Date:" ColSpanMd="6" Visible="@linkDocisExpiryDate">
                        <DxDateEdit NullText="Select a Expiry Date..." MinDate="DateTime.Now" @bind-Date="@Data.ExpiryDate" CssClass="cw-320" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description" ColSpanMd="6">
                        <DxMemo @bind-Text="@Data.Description" Rows="5" ShowValidationIcon="true" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="" ColSpanMd="12">

                        <div class="" style="height: calc(100vh - 565px);overflow: auto;overflow-x: hidden;">
                            <DxUpload @ref="LinkDocuploadComponent" Name="files"
                                      Visible="@AttachmentUploadLinkDocVisible"
                                      AcceptedFileTypes=@linkDocAcceptedFileTypes
                                      ChunkSize="200000"
                                      UploadMode="@UploadMode.OnButtonClick"
                                      FileUploadStart="OnFileUploadLinkDocStart"
                                      AllowMultiFileUpload="true"
                                      ExternalSelectButtonCssSelector="#attachmentLinkDocSelectButton"
                                      SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                      FileUploaded="@isUploadLinkDocSuccess"
                                      FileUploadProgressChanged="@OnUploadProgressLinkDocChanged"
                                      FileUploadStarted="@OnFileUploadLinkDocStarted"
                                      FileUploadError="@OnUploadLinkDocError">
                            </DxUpload>

                        </div>
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
        </div>
    </div>
</div>
<DxFlyout @bind-IsOpen=IsFileProfileTypeLinkDocOpen
          PositionTarget=@($"#flyout-overview-target-container-IsFileProfileTypeLinkDocOpen")
          RestrictionTarget="#Navigation-Flyout-Customization"
          AnimationType="FlyoutAnimationType.Fade"
          HeaderVisible="true"
          HeaderText="Select FileProfile Type"
          FooterVisible="true"
          FooterCssClass="custom-flyout-footer"
          MinWidth="500" MinHeight="200" MaxWidth="1000px" MaxHeight="800"
          CloseOnOutsideClick="false"
          PreventCloseOnPositionTargetClick="true">
    <BodyContentTemplate Context="PopupContext">
        <DxFormLayout CssClass="w-100" style="height: calc(100vh - 250px);overflow:auto;overflow-x:hidden;">
            <DxFormLayoutItem Caption="" ColSpanMd="12">
                @* <DxTreeView @ref="_treeLinkDocView"
                @bind-FilterString="FilterString"
                ShowFilterPanel="true"
                FilterMode="NavigationFilterMode.EntireBranch"
                AllowSelectNodes="true"
                AfterExpand="@AfterExpand"
                SelectionChanged="@SelectionChanged"
                Data="@_selectedTreeItems"
                LoadChildNodesOnDemand="true">
                <DataMappings>
                <DxTreeViewDataMapping Text="FileName"
                HasChildren="HasChildren"
                Children="Children" />
                </DataMappings>
                </DxTreeView> *@
                <DxTreeList Data="fileProfileTypeLinkDocDocumentsAll"
                            VirtualScrollingEnabled="true"
                            ShowFilterRow="true"
                            KeyFieldName="FileProfileTypeId"
                            ParentKeyFieldName="ParentId"
                            ColumnResizeMode="TreeListColumnResizeMode.NextColumn"
                            TextWrapEnabled="false"
                            CssClass="max-h-480"
                            ShowAllRows="true"
                            FocusedRowEnabled="true"
                            RowClick="OnRowTreeClick"
                            SelectionMode="TreeListSelectionMode.Single"
                            FilterTreeMode="TreeListFilterTreeMode.EntireBranch">
                    <Columns>
                        <DxTreeListDataColumn FieldName="FileName" Caption="Name" FilterRowOperatorType="TreeListFilterRowOperatorType.Contains">
                            <EditSettings>
                                <DxTextBoxSettings NullText="Type a search string and enter" ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                            </EditSettings>
                        </DxTreeListDataColumn>
                    </Columns>
                </DxTreeList>
            </DxFormLayoutItem>

        </DxFormLayout>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">
                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsFileProfileTypeLinkDocOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>
@code {
    object PlantValue { get; set; }
    object DivisionValue { get; set; }
    object DepartmentValue { get; set; }
    object SectionValue { get; set; }
    object SubSectionValue { get; set; }
    EditContext _editContext;
    [Parameter]
    public DocumentsModel selectedFiles { get; set; }
    [Parameter]
    public ApplicationUser applicationUser { get; set; }
    [Parameter]
    public Action RevokeLinkDocBack { get; set; }
    [Parameter]
    public Guid? FileProfileSessionId { get; set; }
    public string UploadDocLinkFormID { get; set; } = "UploadDocLinkFormID";
    private DxTreeView _treeLinkDocView;
    string FilterString { get; set; }
    public string LinkDocFileprofiletypeName { get; set; }
    public bool loadingLinkDoc { get; set; } = true;
    public bool IsFileProfileTypeLinkDocOpen { get; set; }
    string LinkDocMessage = "Upload";
    public bool IsFileProfileTypeLinkDocShow { get; set; } = false;
    private List<ViewPlants>? _plantItems;
    private List<ViewDivision>? _divisionItems;
    private List<ViewDepartment>? _departmentItems;
    private List<ViewSection>? _sectionItems;
    private List<ViewSubSection>? _subSectionItems;
    IEnumerable<DocumentsModel> _selectedTreeItems = new List<DocumentsModel>();
    bool AttachmentUploadLinkDocVisible { get; set; } = false;
    DocumentsUploadModel Data = new DocumentsUploadModel();
    public List<DocumentsUploadModel> TempSetLinkDocIds = new List<DocumentsUploadModel>();
    public DocumentProfileNoSeriesModel documentProfileNoSeriesLinkDocData { get; set; }
    private DxUpload LinkDocuploadComponent;
    string linkDocMyError { get; set; }
    string linkDocMyMessage { get; set; }
    private List<UploadFileInfo> LinkDocSelectedFiles { get; set; } = new List<UploadFileInfo>();
    bool linkDocisExpiryDate { get; set; } = false;
    bool isPlantLinkDoc { get; set; } = false;
    bool isDivisionLinkDoc { get; set; } = false; bool isDepartmentLinkDoc { get; set; } = false;
    bool isSectionLinkDoc { get; set; } = false; bool isSubSectionLinkDoc { get; set; } = false;
    int LinkDocSelectedFilesCount { get; set; }
    int LinkDocCurrentUplodCount { get; set; }
    public long? DocumentIds { get; set; }
    public List<DocumentsModel> fileProfileTypeLinkDocDocumentsAll { get; set; }
    public List<string?> documentsFiles { get; set; } = new List<string?>();
    bool? IsDuplicateUpload { get; set; } = false;
    public List<string> linkDocAcceptedFileTypes { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF", ".txt", ".TXT", ".msg", ".MSG", ".eml", ".EML", "Outlook.File.eml.15", "audio/*" };
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        DocumentIds = selectedFiles.DocumentID;
        await loadLinkDocData(selectedFiles, applicationUser, "Yes");
    }
    public async Task loadLinkDocData(DocumentsModel _selectedFiles, ApplicationUser _applicationUser, string uploadClear)
    {
        IsFileProfileTypeLinkDocShow = true; PlantValue = null;
        if (uploadClear == "Yes")
        {
            fileProfileTypeLinkDocDocumentsAll = await Mediator.Send(new GetAllfileprofiletypeListQuery());
            // if (fileProfileTypeLinkDocDocumentsAll.Count() > 0)
            // {
            //     _selectedTreeItems = _treeGenerateRecursive.TreeGenerateRecursives(fileProfileTypeLinkDocDocumentsAll);
            // }
        }
        isPlantLinkDoc = false;
        isDivisionLinkDoc = false; isDepartmentLinkDoc = false;
        isSectionLinkDoc = false; isSubSectionLinkDoc = false;
        Data.PlantId = 0; Data.DepartmentId = 0;
        Data.DivisionId = 0; Data.SectionId = 0; Data.SubSectionId = 0;
        TempSetLinkDocIds = new List<DocumentsUploadModel>();
        loadingLinkDoc = true;
        LinkDocMessage = "Upload";
        // LinkDocuploadComponent.RemoveAllFiles();
        // LinkDocCurrentUplodCount = 0;
        // LinkDocSelectedFilesCount = 0;
        // LinkDocSelectedFiles = new List<UploadFileInfo>();
        if (uploadClear == "No")
        {
            if (LinkDocSelectedFilesCount > 0)
            {

            }
            else
            {
                LinkDocuploadComponent.RemoveAllFiles();
                LinkDocCurrentUplodCount = 0;
                LinkDocSelectedFilesCount = 0;
                LinkDocSelectedFiles = new List<UploadFileInfo>();
            }
        }
        else
        {
            LinkDocuploadComponent.RemoveAllFiles();
            LinkDocCurrentUplodCount = 0;
            LinkDocSelectedFilesCount = 0;
            LinkDocSelectedFiles = new List<UploadFileInfo>();
        }
        linkDocMyError = ""; linkDocMyMessage = ""; LinkDocFileprofiletypeName = ""; IsDuplicateUpload = false;
        if (_selectedFiles != null && _selectedFiles.ProfileID > 0)
        {
            selectedFiles = _selectedFiles;
            applicationUser = _applicationUser;
            documentProfileNoSeriesLinkDocData = await Mediator.Send(new GetDocumentProfileNoSeriesById(selectedFiles.ProfileID));
            if (documentProfileNoSeriesLinkDocData != null)
            {
                if (!string.IsNullOrEmpty(documentProfileNoSeriesLinkDocData.Abbreviation1))
                {
                    dynamic? abbreviation = JsonConvert.DeserializeObject(documentProfileNoSeriesLinkDocData.Abbreviation1);
                    if (abbreviation != null)
                    {
                        foreach (var item in abbreviation)
                        {
                            var itemsId = item.Id;
                            if (itemsId == 1)
                            {
                                isPlantLinkDoc = true;
                                Data.PlantId = null;
                            }
                            if (itemsId == 2)
                            {
                                isDepartmentLinkDoc = true; isDivisionLinkDoc = true;
                                Data.DepartmentId = null;
                                Data.DivisionId = null;
                            }
                            if (itemsId == 3)
                            {
                                isSectionLinkDoc = true;
                                Data.SectionId = null;
                            }
                            if (itemsId == 4)
                            {
                                isSubSectionLinkDoc = true;
                                Data.SubSectionId = null;
                            }
                        }
                    }
                }
            }
            if (selectedFiles.IsExpiryDate == true)
            {
                linkDocisExpiryDate = true;
            }
            Data.DocumentId = DocumentIds;
            Data.UserSession = applicationUser.SessionId;
            Data.UserId = applicationUser.UserID;
            Data.ProfileId = selectedFiles.ProfileID;
            Data.FileProfileTypeId = selectedFiles.FileProfileTypeId > 0 ? selectedFiles.FileProfileTypeId : selectedFiles.FilterProfileTypeId;
            var lists = GetFileProfileTypePath(fileProfileTypeLinkDocDocumentsAll, Data.FileProfileTypeId);
            LinkDocFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
            IsDuplicateUpload = lists.FirstOrDefault()?.IsDuplicateUpload;
        }
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        await SelectedItemLinkDocChanged(0);
        await SelectedItemDivisionLinkDocChanged(0);
        await SelectedItemDepartementLinkDocChanged(0);
        await SelectedItemSectionLinkDocChanged(0);
        StateHasChanged();
    }
    async Task onGetExitingFile()
    {
        DocumentSearchModel documentSearchModels = new DocumentSearchModel();
        documentSearchModels.FileProfileTypeId = Data.FileProfileTypeId;
        List<long?> list1 = new List<long?>();
        list1.Add(Data.FileProfileTypeId);
        documentSearchModels.FileProfileTypeIds = list1;
        var docList = await Mediator.Send(new GetAllSelectedfileprofiletypesQuery(documentSearchModels));
        if (docList != null && docList.Count() > 0)
        {
            documentsFiles.AddRange(docList.Select(s => s.FileName).Distinct().ToList());
        }

    }
    private List<FileProfileTypeModel> GetFileProfileTypePath(List<DocumentsModel> foldersListItem, long? id)
    {
        var foldersListItems = foldersListItem.Where(t => t.FileProfileTypeId == id).ToList();
        FileProfileTypeModel fileprofile = new FileProfileTypeModel();
        List<FileProfileTypeModel> foldersList = new List<FileProfileTypeModel>();
        if (foldersListItems != null && foldersListItems.Count > 0)
        {
            foldersListItems.ForEach(s =>
            {
                List<string> FolderPathLists = new List<string>();
                FileProfileTypeModel fileProfileTypeModel = new FileProfileTypeModel();
                fileProfileTypeModel.FileProfileTypeId = s.FileProfileTypeId.Value;
                fileProfileTypeModel.Name = s.FileName;
                fileProfileTypeModel.IsDuplicateUpload = s.IsDuplicateUpload;
                fileprofile = GetProfileTypeName(foldersListItem, s, FolderPathLists, fileprofile);
                FolderPathLists.Add(s.FileName);
                fileProfileTypeModel.FileProfileTypeParentId = fileprofile.ParentId;
                fileProfileTypeModel.FileProfilePath = string.Join(" / ", FolderPathLists);
                foldersList.Add(fileProfileTypeModel);
            });
        }
        return foldersList;
    }
    private FileProfileTypeModel GetProfileTypeName(List<DocumentsModel> foldersListItems, DocumentsModel s, List<string> foldersModel, FileProfileTypeModel fileProfileTypeModel)
    {

        if (s.ParentId != null)
        {
            var items = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.ParentId);
            GetProfileTypeName(foldersListItems, items, foldersModel, fileProfileTypeModel);
            foldersModel.Add(items.FileName);
        }
        else if (s.ParentId == null)
        {
            fileProfileTypeModel.ParentId = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.FileProfileTypeId)?.FileProfileTypeId;
        }
        return fileProfileTypeModel;
    }
    private void AfterExpand(TreeViewNodeEventArgs e)
    {
        if (!e.CausedByAPI)
        {
            _treeLinkDocView.ExpandAll();
        }
    }
    async Task SelectionChanged(TreeViewNodeEventArgs e)
    {
        if (e.NodeInfo?.DataItem != null)
        {
            var nodeName = e.NodeInfo.DataItem as DocumentsModel;
            Data.FileProfileTypeId = nodeName.FileProfileTypeId;
            var lists = GetFileProfileTypePath(fileProfileTypeLinkDocDocumentsAll, Data.FileProfileTypeId);
            LinkDocFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
            IsDuplicateUpload = lists.FirstOrDefault()?.IsDuplicateUpload;
            await loadLinkDocData(nodeName, applicationUser, "No");
        }

        StateHasChanged();
    }
    async void OnRowTreeClick(TreeListRowClickEventArgs e)
    {
        var itemId = (long?)e.TreeList.GetRowValue(e.VisibleIndex, "FileProfileTypeId");
        var nodeName = fileProfileTypeLinkDocDocumentsAll.FirstOrDefault(f => f.FileProfileTypeId == itemId);
        if (nodeName != null)
        {
            Data.FileProfileTypeId = nodeName.FileProfileTypeId;
            var lists = GetFileProfileTypePath(fileProfileTypeLinkDocDocumentsAll, Data.FileProfileTypeId);
            LinkDocFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
            IsDuplicateUpload = lists.FirstOrDefault()?.IsDuplicateUpload;
            await loadLinkDocData(nodeName, applicationUser, "No");
        }
        StateHasChanged();
    }
    void OnButtonFileProfileTypeLinDocClick()
    {
        IsFileProfileTypeLinkDocOpen = true;
    }
    void LinkDocbackUrl()
    {
        ClearData();
        RevokeLinkDocBack?.Invoke();
    }
    void OnFileUploadLinkDocStart(FileUploadStartEventArgs e)
    {
        LinkDocMessage = "Uploading...";
        loadingLinkDoc = false;
        var SessionId = new Guid(e.FileInfo.Guid);
        DocumentsUploadModel TempSetId = new DocumentsUploadModel();
        TempSetId.SessionId = SessionId;
        TempSetLinkDocIds.Add(TempSetId);
        string BaseUrl = Navigator.BaseUri + "api/FileUpload/";
        string url = BaseUrl + "UploadDocumentsBySession?SessionId=" + selectedFiles.SessionID + "&addedByUserId=" + applicationUser.UserID + "&IsFileSession=true&SourceFrom=FileProfile";
        e.UploadUrl = url;
    }
    async Task isUploadLinkDocSuccess(FileUploadEventArgs e)
    {
        LinkDocCurrentUplodCount++;
        var filesessionIds = new Guid(e.FileInfo.Guid);
        Data.SessionId = filesessionIds;
        Data.FileSessionId = filesessionIds;
        var ext = e.FileInfo.Name.Split(".").Last();
        Data.FilePath = @"Documents\" + selectedFiles.SessionID + @"\" + filesessionIds + "." + ext;
        Data.Type = "Document Link";
        DocumentsUploadModel documentsUploadModel = new DocumentsUploadModel();
        documentsUploadModel.SessionId = filesessionIds;
        documentsUploadModel.FileSessionId = filesessionIds;
        documentsUploadModel.FilePath = Data.FilePath;
        Data.DocumentsUploadModels.Add(documentsUploadModel);
        //var response = await Mediator.Send(new UpdateCreateDocumentBySession(Data));
        linkDocMyMessage = "Upload of the " + e.FileInfo.Name + " file is Completed.";
        toastService.ShowToast(linkDocMyMessage, AC.SD.Core.Services.ToastLevel.Success);
        if (LinkDocCurrentUplodCount >= LinkDocSelectedFilesCount)
        {
            linkDocMyMessage = "All File is Uploaded. Pls Wait Document No is Generating...";
            toastService.ShowToast(linkDocMyMessage, AC.SD.Core.Services.ToastLevel.Success);
            var responses = await Mediator.Send(new UpdateDocumentNoDocumentBySession(Data));
            if (responses.FileProfileTypeId > 0)
            {
                await Task.Delay(5000);
                linkDocMyMessage = "All File is Uploaded. Pls Wait Document No Generated";
                toastService.ShowToast(linkDocMyMessage, AC.SD.Core.Services.ToastLevel.Success);
                LinkDocMessage = "Upload";
                loadingLinkDoc = true;
                LinkDocbackUrl();
            }
        }

    }
    void OnUploadLinkDocError(FileUploadErrorEventArgs e)
    {
        linkDocMyError = e.RequestInfo.ResponseText;
        toastService.ShowToast(linkDocMyError, AC.SD.Core.Services.ToastLevel.Error);
        LinkDocMessage = "Upload";
        loadingLinkDoc = true;
        InvokeAsync(StateHasChanged);
    }
    void OnFileUploadLinkDocStarted(FileUploadEventArgs e)
    {
        linkDocMyMessage = "Upload of the " + e.FileInfo.Name + " file was started.";
        toastService.ShowToast(linkDocMyMessage, AC.SD.Core.Services.ToastLevel.Info);
        InvokeAsync(StateHasChanged);
    }
    void OnUploadProgressLinkDocChanged(FileUploadEventArgs e)
    {
        // var progress = e.FileInfo.LoadedBytes / e.FileInfo.Size * 100;
    }
    string? QueryPlantText(DropDownBoxQueryDisplayTextContext arg)
    {
        Data.PlantId = isPlantLinkDoc == false ? 0 : null;
        Data.DivisionId = isDivisionLinkDoc == false ? 0 : null;
        Data.DepartmentId = isDepartmentLinkDoc == false ? 0 : null;
        Data.SectionId = isSectionLinkDoc == false ? 0 : null;
        Data.SubSectionId = isSubSectionLinkDoc == false ? 0 : null;
        DivisionValue = null; DepartmentValue = null; SectionValue = null; SubSectionValue = null;
        string? returnData = string.Empty;
        if (arg.Value is ViewPlants value)
        {
            if (value != null)
            {
                Data.PlantId = value.PlantID;
                returnData = value?.PlantCode;
            }
        }
        InvokeAsync(SelectedItemPlantChanged);
        return returnData;
    }
    async Task SelectedItemPlantChanged()
    {
        await SelectedItemLinkDocChanged(Data.PlantId);
    }
    void GridSelectedDataItemChanged(object item, IDropDownBox dropDownBox)
    {
        if (item != null)
        {
            PlantValue = item as ViewPlants;
        }
        dropDownBox.HideDropDown();
    }
    async Task SelectedItemLinkDocChanged(long? plantID)
    {
        _divisionItems = new List<ViewDivision>();
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (plantID > 0)
        {
            _divisionItems = await Mediator.Send(new GetDivisionByCompany(plantID));
        }
    }
    void GridDivisionSelectedDataItemChanged(object item, IDropDownBox dropDownBox)
    {
        if (item != null)
        {
            DivisionValue = item as ViewDivision;
        }
        dropDownBox.HideDropDown();
    }
    string? QueryDivisionText(DropDownBoxQueryDisplayTextContext arg)
    {
        Data.DivisionId = isDivisionLinkDoc == false ? 0 : null;
        Data.DepartmentId = isDepartmentLinkDoc == false ? 0 : null;
        Data.SectionId = isSectionLinkDoc == false ? 0 : null;
        Data.SubSectionId = isSubSectionLinkDoc == false ? 0 : null;
        string? returnData = string.Empty; DepartmentValue = null; SectionValue = null; SubSectionValue = null;
        if (arg.Value is ViewDivision value)
        {
            if (value != null)
            {
                Data.DivisionId = value.DivisionID;
                returnData = value?.Name;
            }
        }
        InvokeAsync(SelectedItemDivisionChangeds);
        return returnData;
    }
    async Task SelectedItemDivisionChangeds()
    {
        await SelectedItemDivisionLinkDocChanged(Data.DivisionId);
    }
    async Task SelectedItemDivisionLinkDocChanged(long? divisionId)
    {
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (divisionId > 0)
        {
            _departmentItems = await Mediator.Send(new GetDepartmentByDivision(divisionId));
        }
    }
    void GridDepartmentSelectedDataItemChanged(object item, IDropDownBox dropDownBox)
    {
        if (item != null)
        {
            DepartmentValue = item as ViewDepartment;
        }
        dropDownBox.HideDropDown();
    }
    string? QueryDepartmentText(DropDownBoxQueryDisplayTextContext arg)
    {

        Data.DepartmentId = isDepartmentLinkDoc == false ? 0 : null;
        Data.SectionId = isSectionLinkDoc == false ? 0 : null;
        Data.SubSectionId = isSubSectionLinkDoc == false ? 0 : null;
        string? returnData = string.Empty; SectionValue = null; SubSectionValue = null;
        if (arg.Value is ViewDepartment value)
        {
            if (value != null)
            {
                Data.DepartmentId = value.DepartmentId;
                returnData = value?.DepartmentName;
            }
        }
        InvokeAsync(SelectedItemDepartementChangeds);
        return returnData;
    }
    async Task SelectedItemDepartementChangeds()
    {
        await SelectedItemDepartementLinkDocChanged(Data.DepartmentId);
    }
    async Task SelectedItemDepartementLinkDocChanged(long? departmentId)
    {
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (departmentId > 0)
        {
            _sectionItems = await Mediator.Send(new GetSectionByDepartment(departmentId));
        }
    }
    void GridSectionSelectedDataItemChanged(object item, IDropDownBox dropDownBox)
    {
        if (item != null)
        {
            SectionValue = item as ViewSection;
        }
        dropDownBox.HideDropDown();
    }
    string? QuerySectionText(DropDownBoxQueryDisplayTextContext arg)
    {
        Data.SectionId = isSectionLinkDoc == false ? 0 : null;
        Data.SubSectionId = isSubSectionLinkDoc == false ? 0 : null;
        SubSectionValue = null;
        string? returnData = string.Empty;
        if (arg.Value is ViewSection value)
        {
            if (value != null)
            {
                Data.SectionId = value.SectionId;
                returnData = value?.SectionName;
            }
        }
        InvokeAsync(SelectedItemSectionChangeds);
        return returnData;
    }
    async Task SelectedItemSectionChangeds()
    {
        await SelectedItemSectionLinkDocChanged(Data.SectionId);
    }
    async Task SelectedItemSectionLinkDocChanged(long? sectionId)
    {
        _subSectionItems = new List<ViewSubSection>();
        if (sectionId > 0)
        {
            _subSectionItems = await Mediator.Send(new GetSubSectionBySection(sectionId));
        }
    }
    string? QuerySubSectionText(DropDownBoxQueryDisplayTextContext arg)
    {
        Data.SubSectionId = isSubSectionLinkDoc == false ? 0 : null;
        string? returnData = string.Empty;
        if (arg.Value is ViewSubSection value)
        {
            if (value != null)
            {
                Data.SubSectionId = value.SubSectionId;
                returnData = value?.SubSectionName;
            }
        }
        return returnData;
    }
    void GridSubSectionSelectedDataItemChanged(object item, IDropDownBox dropDownBox)
    {
        if (item != null)
        {
            SubSectionValue = item as ViewSubSection;
        }
        dropDownBox.HideDropDown();
    }
    void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        var MyMessagess = string.Empty;
        if (files != null && files.ToList().Count() > 0)
        {
            if (IsDuplicateUpload == false)
            {
                files.ToList().ForEach(s =>
                {
                    if (documentsFiles.Contains(s.Name))
                    {
                        MyMessagess += s.Name + " file was Removed.\n\r";

                        LinkDocuploadComponent.RemoveFile(s);
                    }
                });
            }
            AttachmentUploadLinkDocVisible = files.ToList().Count > 0;
            LinkDocSelectedFiles.AddRange(files);
            LinkDocSelectedFilesCount = files.ToList().Count; //Count current files
            if (!string.IsNullOrEmpty(MyMessagess))
            {
                var msg = "File Already Exits." + MyMessagess;
                toastService.ShowToast(msg, AC.SD.Core.Services.ToastLevel.Error);
            }
        }
        InvokeAsync(StateHasChanged);
    }

    public void onsubmitUploadLinkDocFromClick()
    {
        if (_editContext.Validate())
        {
            this.HandleValidLinkDocSubmit();
        }
    }
    void HandleValidLinkDocSubmit()
    {
        LinkDocuploadComponent.UploadAllFiles();
    }
    public void ClearData()
    {
        PlantValue = null;
        DivisionValue = null;
        DepartmentValue = null;
        SectionValue = null;
        SubSectionValue = null;
        selectedFiles = null;
        _plantItems?.Clear();
        _divisionItems?.Clear();
        _departmentItems?.Clear();
        _sectionItems?.Clear();
        _subSectionItems?.Clear();
        Data = new DocumentsUploadModel();
        TempSetLinkDocIds?.Clear();
        documentProfileNoSeriesLinkDocData = null;
        LinkDocSelectedFiles?.Clear();
        fileProfileTypeLinkDocDocumentsAll?.Clear();
        _selectedTreeItems = null; documentsFiles?.Clear();
        linkDocAcceptedFileTypes?.Clear();
    }
    public async ValueTask DisposeAsync()
    {
        //System.GC.Collect();
        ClearData();
        // GC.SuppressFinalize(this);
    }
}
