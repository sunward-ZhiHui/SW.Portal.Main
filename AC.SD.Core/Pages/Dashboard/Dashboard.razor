@page "/Dashboard"
@layout MainLayout
@using Application.Queries;
@using Application.Response;
@using global::Core.Entities;
@using global::Core.Repositories.Query;
@using MediatR
@inject IMediator Mediator
@using AC.SD.Core.Configuration
@inject DemoConfiguration Configuration
@inject DemoThemeService Themes
@inject NavigationManager NavigationManager
@inject ILocalStorageService<ApplicationUser> _localStorageService

@using Data

@*<div class="demo-products demo-products-description theme-@Themes.ActiveTheme.Name.Replace(" ", "-")">
    <h1 class="mb-4">Dashboard</h1>
    <p class="mb-5">The <a href="https://www.devexpress.com/blazor/" target="_blank">Dashboard</a>  </p>
</div>*@


@*<DxScheduler StartDate="@DateTime.Today" DataStorage="@DataStorage" CssClass="w-100">
    <Views>
        <DxSchedulerDayView DayCount="5" ShowWorkTimeOnly="true">
            <DateHeaderCellTemplate>
                <div style="display: flex;">
                    <div class="dxbs-sc-date-hr-wrapper" style="width: 100%;">
                        <span class="dxbs-sc-date-hr-day">@context.Interval.Start.Day</span>
                        <span class="dxbs-sc-date-hr-week">@context.Interval.Start.ToString("ddd")</span>
                    </div>                   
                </div>
            </DateHeaderCellTemplate>
        </DxSchedulerDayView>
    </Views>
</DxScheduler>*@

<DxScheduler StartDate="@DateTime.Today" DataStorage="@DataStorage" CssClass="w-100" AllowCreateAppointment="false"
             AllowEditAppointment="false" AllowDeleteAppointment="false">
    <DxSchedulerDayView DayCount="5" ShowWorkTimeOnly="true">
        <HorizontalAppointmentTemplate>
            <div class="card shadow-sm p-1 bg-white text-dark" style="width:100%; font-size: .925em; font-weight:600; box-shadow: .125rem .25rem rgba(34,34,34,0.15)">
                @context.Appointment.Subject
            </div>
        </HorizontalAppointmentTemplate>
        <VerticalAppointmentTemplate>
            <div class="card shadow-sm bg-white p-2" style="overflow: hidden; height: 100%;box-shadow: .125rem .25rem rgba(34,34,34,0.15)">
                <div><span class="badge mb-1 @context.Status.CssClass" style="white-space: pre-wrap;">@context.Status.Caption</span></div>
                <span class="text-dark ps-0 mb-1" style="font-weight:600; font-size: .925em;">@context.Appointment.Subject</span>
                <div style="height:100%; display:flex; flex-direction:column; justify-content:flex-end;">
                    <div><span class="badge bg-light text-dark" style="white-space: pre-wrap;"><span class="dx-icon-time pe-1"></span>@context.Appointment.End.ToString("MMM dd HH:mm")</span></div>
                </div>
            </div>
        </VerticalAppointmentTemplate>
    </DxSchedulerDayView>
</DxScheduler>


@code {
    public ApplicationUser applicationUser { get; private set; }


    DxSchedulerDataStorage DataStorage = new DxSchedulerDataStorage()
    {
        //AppointmentsSource = AppointmentCollection.GetAppointments(),
        AppointmentMappings = new DxSchedulerAppointmentMappings()
        {
            Type = "EmailType",
            Start = "StartDate",
            End = "EndDate",
            Subject = "Caption",
            AllDay = "AllDay",
            Location = "Location",
            Description = "Description",
            LabelId = "Label",
            StatusId = "Status",
            RecurrenceInfo = "Recurrence"
        }
    };

    protected override async void OnInitialized()
    {
        var checkauthorize = await _localStorageService.GetItem<ApplicationUser>("user");

        var pushToken = await _localStorageService.GetItemOne("PushToken");      

        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");



        if (checkauthorize == null)
        {
            NavigationManager.NavigateTo($"Login");
        }
        else
        {
            if(pushToken != null)
            {
                var rstdata = await Mediator.Send(new AddPushTokenID(applicationUser.LoginID, "Web", pushToken));
            }            
           // NavigationManager.NavigateTo("/hrms/Dashboard");
        }

        var data = await Mediator.Send(new GetEmailSchedulerList(applicationUser.UserID));
        DataStorage.AppointmentsSource = data.ToList();
    }

    
}
