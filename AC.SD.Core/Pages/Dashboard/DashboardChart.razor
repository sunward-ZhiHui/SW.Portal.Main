@page "/chart"
@using System.Collections.Generic
@using DevExpress.Blazor
@layout MainLayout
@using Application.Queries;
@using Application.Response;
@using global::Core.Entities;
@using global::Core.Repositories.Query;
@using MediatR
@inject IMediator Mediator
@using AC.SD.Core.Configuration
@inject DemoConfiguration Configuration
@inject DemoThemeService Themes
@inject NavigationManager NavigationManager
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IJSRuntime jsRuntime;
@inject AC.SD.Core.Services.ToastService toastService


<DxScheduler DataStorage="@DataStorage"
             AppointmentInserting="AppointmentInserting"
             AppointmentRemoving="@AppointmentRemoving"
             AppointmentUpdating="AppointmentUpdating">
    <DxSchedulerDayView ShowWorkTimeOnly="true" />
    <DxSchedulerWeekView ShowWorkTimeOnly="true" />
    <DxSchedulerMonthView />
</DxScheduler>

@code {
    public ApplicationUser? applicationUser { get; private set; }
    DxSchedulerDataStorage DataStorage = new DxSchedulerDataStorage()
        {           
            AppointmentMappings = new DxSchedulerAppointmentMappings()
            {
                Id = "ID",
                Type = "AppointmentType",
                Start = "StartDate",
                End = "EndDate",
                Subject = "Caption",
                AllDay = "AllDay",
                LabelId = "Label",
                StatusId = "Status",
                Location = "Location",
                Description = "Description",
                RecurrenceInfo = "Recurrence"
            }
        };

    protected override async void OnInitialized()
    {       
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        var data1 = await Mediator.Send(new GetAppointmentList(applicationUser.UserID));
        DataStorage.AppointmentsSource = data1.ToList();
    }

    async Task AppointmentInserting(SchedulerAppointmentOperationEventArgs e)
    {
        Appointment insertedItem = e.Appointment.SourceObject as Appointment;

        if (insertedItem != null)
        {
            var InsertReq = new AddAppointment
                {
                    AppointmentType = insertedItem.AppointmentType,
                    StartDate = insertedItem.StartDate,
                    EndDate = insertedItem.EndDate,
                    Caption = insertedItem.Caption,
                    Label = insertedItem.Label,
                    Status = insertedItem.Status,
                    AllDay = insertedItem.AllDay,
                    Location = insertedItem.Location,
                    Description = insertedItem.Description,
                    Recurrence = insertedItem.Recurrence,
                    AddedByUserID = applicationUser.UserID,
                    AddedDate = DateTime.Now
                };

            var ans = await Mediator.Send(InsertReq);
            toastService.ShowToast("Record Insert Successfully", AC.SD.Core.Services.ToastLevel.Success);
            //await UpdateDataAsync();
        }


    }
    async Task AppointmentUpdating(SchedulerAppointmentOperationEventArgs e)
    {      
        if (e.Appointment != null && e.Appointment.Id != null)
        {
            var InsertReq = new EditAppointment
                {
                    ID = (long)e.Appointment.Id,                    
                    StartDate = e.Appointment.Start,
                    EndDate = e.Appointment.End,
                    Caption = e.Appointment.Subject,
                    Label = (int)e.Appointment.LabelId,
                    Status = (int)e.Appointment.StatusId,
                    AllDay = e.Appointment.AllDay,
                    Location = e.Appointment.Location,
                    Description = e.Appointment.Description
                };

            var ans = await Mediator.Send(InsertReq);
            toastService.ShowToast("Record Updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            //await UpdateDataAsync();
        }
    }
    async Task AppointmentRemoving(SchedulerAppointmentOperationEventArgs e)
    {
        if (e.Appointment.Id != null)
        {
            var ans = await Mediator.Send(new DeleteAppointment((long)e.Appointment.Id));
            toastService.ShowToast("Record Deleted Successfully", AC.SD.Core.Services.ToastLevel.Success);
        }
               
    }
}