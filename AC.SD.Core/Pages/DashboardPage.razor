@page "/DashboardPages"
 @using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Http
@using DevExpress.DashboardBlazor
@using DevExpress.DashboardWeb
@using DevExpress.DashboardAspNetCore
@using DevExpress.DashboardCommon;
@using System.IO;
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using global::Core.Entities
@using global::Core.Repositories.Query
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager Navigation

<link href="_content/DevExpress.Blazor.Dashboard/ace.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/ace-theme-dreamweaver.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/ace-theme-ambiance.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx.light.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-analytics.common.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-analytics.light.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-querybuilder.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-dashboard.light.min.css" rel="stylesheet" />
<DxSplitter CssClass="splitter" Width="100%">
    <Panes>
        <DxSplitterPane Size="15%" MinSize="200px" AllowCollapse="true">

            <DxButton Text="@ButtonText" Click="ChangeWorkingMode"
                      CssClass="w-100" />

            <DxListBox Data="@DashboardIds" style="height: calc(100vh - 200px);margin-top: 5px;"
                       TextFieldName="@nameof(DashboardItem.DisplayName)"
                       @bind-SearchText="@SearchText"
                       @bind-Value="@dashboardItem"
                       ShowSearchBox="true"
                       SearchTextParseMode="@SearchTextParseMode"
                       ListRenderMode="ListRenderMode.Virtual">
            </DxListBox>
        </DxSplitterPane>

        <DxSplitterPane MaxSize="100%" AllowCollapse="true">
            <DxDashboard Endpoint="api/dashboard" @bind-WorkingMode="@workingMode" @bind-DashboardId="dashboardItem.Id" style="height: calc(100vh - 200px);">
                <DxBackendOptions RequestHttpHeaders="@headers"></DxBackendOptions>
            </DxDashboard>

        </DxSplitterPane>
    </Panes>
</DxSplitter>
@code {
    string SearchText { get; set; }
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    string endpoint = "api/dashboard";
    WorkingMode workingMode = WorkingMode.Viewer;
    public string DashboardIdValue { get; set; } = "dashboard2";
    DashboardItem dashboardItem = new DashboardItem();
    //public Dictionary<string, string> headers = new Dictionary<string, string>() { { "Authorization", "UniqueAuthKey" } };
    Dictionary<string, string> headers = new();
    long UserId = 1;
    public ApplicationUser? applicationUser { get; private set; }
    public List<DashboardItem> DashboardIds { get; set; } = new List<DashboardItem>();
    public void ChangeWorkingMode()
    {
        workingMode = workingMode == WorkingMode.Designer ? WorkingMode.Viewer : WorkingMode.Designer;
        DashboardIds = LoadDashboardsFromXml();
    }

    public string ButtonText
    {
        get
        {
            string value = workingMode == WorkingMode.Designer ? "Viewer" : "Designer";
            string mode = "Switch to " + value;
            return mode;
        }
    }   

    protected override async Task OnInitializedAsync()
    {       
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        DashboardIds = LoadDashboardsFromXml();
        headers["UserId"] = applicationUser.UserID.ToString();  
    }

    public class DashboardItem
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
    }
    public List<DashboardItem> LoadDashboardsFromXml()
    {
        var dashboards = new List<DashboardItem>();

        foreach (var file in Directory.GetFiles("Data/Dashboards", "*.xml"))
        {
            var dashboardId = Path.GetFileNameWithoutExtension(file);

            var dashboard = new DevExpress.DashboardCommon.Dashboard();
            dashboard.LoadFromXml(file);
            dashboards.Add(new DashboardItem
                {
                    Id = dashboardId,
                    DisplayName = dashboard.Title.Text ?? dashboardId
                });
        }
        if (dashboards != null && dashboards.Count() > 0)
        {
            DashboardIdValue = dashboards.FirstOrDefault()?.Id;
        }
        return dashboards;
    }
}