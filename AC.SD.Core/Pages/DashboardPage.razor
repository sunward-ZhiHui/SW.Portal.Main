@page "/DashboardPages"
 @using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Http
@using DevExpress.DashboardBlazor
@using DevExpress.DashboardWeb
@using DevExpress.DashboardAspNetCore
@using DevExpress.DashboardCommon;
@using System.IO;
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using global::Core.Entities
@using global::Core.Repositories.Query
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager Navigation

<link href="_content/DevExpress.Blazor.Dashboard/ace.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/ace-theme-dreamweaver.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/ace-theme-ambiance.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx.light.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-analytics.common.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-analytics.light.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-querybuilder.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-dashboard.light.min.css" rel="stylesheet" />
<DxSplitter CssClass="splitter" Width="100%">
    <Panes>
        <DxSplitterPane Size="15%" MinSize="200px" AllowCollapse="true">

            <DxButton Text="@ButtonText" Click="ChangeWorkingMode"
                      CssClass="w-100" />

           @*  <DxListBox Data="@DashboardIds" style="height: calc(100vh - 200px);margin-top: 5px;"
                       TextFieldName="@nameof(DashboardItem.DisplayName)"
                       @bind-SearchText="@SearchText"
                       @bind-Value="@dashboardItem"
                       ShowSearchBox="true"
                       SearchTextParseMode="@SearchTextParseMode"
                       ListRenderMode="ListRenderMode.Virtual">
            </DxListBox> *@



            <DxListBox Data="@DashboardIds"
                       TextFieldName="@nameof(DashboardItem.DisplayName)"
                       @bind-SearchText="@SearchText"
                       @bind-Value="@dashboardItem"
                       ShowSearchBox="true"
                       SearchTextParseMode="@SearchTextParseMode"
                       ListRenderMode="ListRenderMode.Virtual"
                       style="height: calc(100vh - 200px); margin-top: 5px;">
                <ItemTemplate Context="item">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span>@item.DisplayName</span>
                        <DxButton IconCssClass="dx-icon-trash"
                                  CssClass="btn btn-sm btn-danger"
                                  Click="@(args => PromptDelete(item))"
                                  Style="margin-left: 8px; font-size: 11px;" />
                    </div>
                </ItemTemplate>

            </DxListBox>



        </DxSplitterPane>

        <DxSplitterPane MaxSize="100%" AllowCollapse="true">
            <DxDashboard Endpoint="api/dashboard" @bind-WorkingMode="@workingMode" @bind-DashboardId="dashboardItem.Id" style="height: calc(100vh - 200px);">
                <DxBackendOptions RequestHttpHeaders="@headers"></DxBackendOptions>
            </DxDashboard>

        </DxSplitterPane>
    </Panes>
</DxSplitter>


<DxPopup @bind-Visible="isDeletePopupVisible"
         ShowCloseButton="true"
         Width="400px"
         CloseOnOutsideClick="true"
         HeaderText="Confirm Delete">
    <div>
        Are you sure you want to delete the dashboard "<b>@dashboardToDelete?.DisplayName</b>"?
    </div>
    <div style="margin-top: 20px; text-align: right;">
        <DxButton Text="Yes" CssClass="btn btn-danger" Click="ConfirmDelete" Style="margin-right: 10px;" />
        <DxButton Text="No" Click="CancelDelete" CssClass="btn btn-secondary" />
    </div>
</DxPopup>



@code {
    string SearchText { get; set; }
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    string endpoint = "api/dashboard";
    WorkingMode workingMode = WorkingMode.Viewer;
    public string DashboardIdValue { get; set; } = "dashboard2";
    DashboardItem dashboardItem = new DashboardItem();
    //public Dictionary<string, string> headers = new Dictionary<string, string>() { { "Authorization", "UniqueAuthKey" } };
    Dictionary<string, string> headers = new();
    long UserId = 1;
    public ApplicationUser? applicationUser { get; private set; }
    public List<DashboardItem> DashboardIds { get; set; } = new List<DashboardItem>();
    bool isDeletePopupVisible = false;
    DashboardItem? dashboardToDelete = null;



    public void ChangeWorkingMode()
    {
        workingMode = workingMode == WorkingMode.Designer ? WorkingMode.Viewer : WorkingMode.Designer;
        DashboardIds = LoadDashboardsFromXml();
    }

    public string ButtonText
    {
        get
        {
            string value = workingMode == WorkingMode.Designer ? "Viewer" : "Designer";
            string mode = "Switch to " + value;
            return mode;
        }
    }   

    protected override async Task OnInitializedAsync()
    {       
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        DashboardIds = LoadDashboardsFromXml();
        headers["UserId"] = applicationUser.UserID.ToString();  
    }

    public class DashboardItem
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
    }
    public List<DashboardItem> LoadDashboardsFromXmlold()
    {
        var dashboards = new List<DashboardItem>();

        foreach (var file in Directory.GetFiles("Data/Dashboards", "*.xml"))
        {
            var dashboardId = Path.GetFileNameWithoutExtension(file);

            var dashboard = new DevExpress.DashboardCommon.Dashboard();
            dashboard.LoadFromXml(file);
            dashboards.Add(new DashboardItem
                {
                    Id = dashboardId,
                    DisplayName = dashboard.Title.Text ?? dashboardId
                });
        }
        if (dashboards != null && dashboards.Count() > 0)
        {
            DashboardIdValue = dashboards.FirstOrDefault()?.Id;
        }
        return dashboards;
    }

    public List<DashboardItem> LoadDashboardsFromXml()
    {
        var dashboards = new List<DashboardItem>();

        foreach (var file in Directory.GetFiles("Data/Dashboards", "*.xml"))
        {
            var dashboardId = Path.GetFileNameWithoutExtension(file);

            var dashboard = new DevExpress.DashboardCommon.Dashboard();
            dashboard.LoadFromXml(file);
            dashboards.Add(new DashboardItem
            {
                Id = dashboardId,
                DisplayName = dashboard.Title.Text ?? dashboardId
            });
        }

        if (dashboards != null && dashboards.Count() > 0)
        {
            DashboardIdValue = dashboards.FirstOrDefault()?.Id;
        }

        return dashboards;
    }

    private void PromptDelete(DashboardItem item)
    {
        dashboardToDelete = item;
        isDeletePopupVisible = true;
    }

    private void CancelDelete()
    {
        dashboardToDelete = null;
        isDeletePopupVisible = false;
    }

    private void ConfirmDeleteold()
    {
        try
        {
            if (dashboardToDelete != null)
            {
                string filePath = Path.Combine("Data/Dashboards", $"{dashboardToDelete.Id}.xml");

                if (File.Exists(filePath))
                {
                    File.Delete(filePath);
                }

                // Reload list
                DashboardIds = LoadDashboardsFromXml();

                // If current dashboard is deleted, reset
                if (dashboardItem?.Id == dashboardToDelete.Id)
                {
                    dashboardItem = DashboardIds.FirstOrDefault();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting dashboard: {ex.Message}");
        }
        finally
        {
            dashboardToDelete = null;
            isDeletePopupVisible = false;
        }
    }
   
    private void ConfirmDelete()
    {
        try
        {
            if (dashboardToDelete != null)
            {
                string sourcePath = Path.Combine("Data/Dashboards", $"{dashboardToDelete.Id}.xml");
                string archiveFolder = Path.Combine("Data/Archived");

                // Ensure the Deleted folder exists
                if (!Directory.Exists(archiveFolder))
                    Directory.CreateDirectory(archiveFolder);

                // Generate new filename: filename_yyyyMMdd_HHmmss.xml
                string timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
                string newFileName = $"{dashboardToDelete.Id}_{timestamp}.xml";
                string destinationPath = Path.Combine(archiveFolder, newFileName);

                if (File.Exists(sourcePath))
                {
                    File.Move(sourcePath, destinationPath);
                }

                // Reload dashboard list
                DashboardIds = LoadDashboardsFromXml();

                // Reset selected dashboard if needed
                if (dashboardItem?.Id == dashboardToDelete.Id)
                {
                    dashboardItem = DashboardIds.FirstOrDefault();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error moving/renaming dashboard: {ex.Message}");
        }
        finally
        {
            dashboardToDelete = null;
            isDeletePopupVisible = false;
        }
    }


}