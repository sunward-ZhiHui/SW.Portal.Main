@page "/DashboardPages"
 @using System.Security.Claims
@using Application.Queries
@using MediatR
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Http
@using DevExpress.DashboardBlazor
@using DevExpress.DashboardWeb
@using DevExpress.DashboardAspNetCore
@using DevExpress.DashboardCommon;
@using System.IO;
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using System.Text.Json
@using global::Core.Entities
@using global::Core.Repositories.Query
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager Navigation

@inject IMediator Mediator
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@inject IJSRuntime JSRuntime;

<DxSplitter CssClass="splitter" Width="100%">
    <Panes>
        <DxSplitterPane Size="18%" MinSize="200px" AllowCollapse="true">
            <div class="d-flex flex-column gap-2">
                <div class="d-flex gap-2">
                    <DxButton Text="@ButtonText"
                              Click="ChangeWorkingMode"
                              CssClass="btn btn-primary flex-fill" />
                    <DxButton Text="Sync"
                              Click="SyncDashboards"
                              CssClass="btn btn-success flex-fill" />
                </div>

                <DxListBox Data="@DashboardIds"
                           TextFieldName="@nameof(DashboardItem.DisplayName)"
                           @bind-SearchText="@SearchText"
                           @bind-Value="@dashboardItem"
                           ShowSearchBox="true"
                           SearchTextParseMode="@SearchTextParseMode"
                           ListRenderMode="ListRenderMode.Virtual"
                           style="height: calc(100vh - 200px); margin-top: 5px;">
                    <ItemTemplate Context="item">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <span>@item.DisplayName</span>
                            <div style="display: flex; gap: 4px;">
                                <DxButton IconCssClass="fa fa-arrow-up"
                                          RenderStyle="ButtonRenderStyle.Success"
                                          Click="@(() => MoveUp(item))"
                                          Style="font-size: 11px;" />
                                <DxButton IconCssClass="fa fa-arrow-down"
                                          RenderStyle="ButtonRenderStyle.Warning"
                                          Click="@(() => MoveDown(item))"
                                          Style="font-size: 11px;" />
                                <DxButton RenderStyle="ButtonRenderStyle.Danger" IconCssClass="dx-icon-trash" Click="@(args => PromptDelete(item))"
                                          Style="font-size: 11px;" />
                            </div>
                        </div>
                    </ItemTemplate>

                </DxListBox>
            </div>
        </DxSplitterPane>

        <DxSplitterPane MaxSize="100%" AllowCollapse="true">
            <DxDashboard Endpoint="api/dashboard"
                         @bind-WorkingMode="@workingMode"
                         @bind-DashboardId="dashboardItem.Id"
                         style="height: calc(100vh - 200px);">
                <DxBackendOptions RequestHttpHeaders="@headers" />
            </DxDashboard>
        </DxSplitterPane>
    </Panes>
</DxSplitter>







<DxPopup @bind-Visible="isDeletePopupVisible"
         ShowCloseButton="true"
         Width="400px"
         CloseOnOutsideClick="true"
         HeaderText="Confirm Delete">
    <div>
        Are you sure you want to delete the dashboard "<b>@dashboardToDelete?.DisplayName</b>"?
    </div>
    <div style="margin-top: 20px; text-align: right;">
        <DxButton Text="Yes" CssClass="btn btn-danger" Click="ConfirmDelete" Style="margin-right: 10px;" />
        <DxButton Text="No" Click="CancelDelete" CssClass="btn btn-secondary" />
    </div>
</DxPopup>



@code {
    string SearchText { get; set; }
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    string endpoint = "api/dashboard";
    WorkingMode workingMode = WorkingMode.Viewer;
    public string DashboardIdValue { get; set; } = "dashboard2";
    DashboardItem dashboardItem = new DashboardItem();
    //public Dictionary<string, string> headers = new Dictionary<string, string>() { { "Authorization", "UniqueAuthKey" } };
    Dictionary<string, string> headers = new();
    long UserId = 1;
    public ApplicationUser? applicationUser { get; private set; }
    public List<DashboardItem> DashboardIds { get; set; } = new List<DashboardItem>();
    bool isDeletePopupVisible = false;
    DashboardItem? dashboardToDelete = null;

    private List<string> _customOrder = new();

    public void ChangeWorkingMode()
    {
        workingMode = workingMode == WorkingMode.Designer ? WorkingMode.Viewer : WorkingMode.Designer;
        DashboardIds = LoadDashboardsFromXml();
    }

    public string ButtonText
    {
        get
        {
            string value = workingMode == WorkingMode.Designer ? "Viewer" : "Designer";
            string mode = "Switch to " + value;
            return mode;
        }
    }   

    protected override async Task OnInitializedAsync()
    {       
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        LoadCustomOrder();
        DashboardIds = LoadDashboardsFromXml();
        dashboardItem = DashboardIds.FirstOrDefault() ?? new DashboardItem();

        if (applicationUser != null)
            headers["UserId"] = applicationUser.UserID.ToString();
    }
    public void LoadCustomOrder()
    {
        var orderPath = Path.Combine("Data", "dashboard-order.json");

        if (File.Exists(orderPath))
        {
            var json = File.ReadAllText(orderPath);
            _customOrder = JsonSerializer.Deserialize<List<string>>(json) ?? new List<string>();
        }
        else
        {
            // fallback if no custom order file
            _customOrder = new();
        }
    }

    public class DashboardItem
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string? XmlData { get; set; } // Optional
    }
    public List<DashboardItem> LoadDashboardsFromXmlold()
    {
        var dashboards = new List<DashboardItem>();

        foreach (var file in Directory.GetFiles("Data/Dashboards", "*.xml"))
        {
            var dashboardId = Path.GetFileNameWithoutExtension(file);

            var dashboard = new DevExpress.DashboardCommon.Dashboard();
            dashboard.LoadFromXml(file);
            dashboards.Add(new DashboardItem
                {
                    Id = dashboardId,
                    DisplayName = dashboard.Title.Text ?? dashboardId
                });
        }
        if (dashboards != null && dashboards.Count() > 0)
        {
            DashboardIdValue = dashboards.FirstOrDefault()?.Id;
        }
        return dashboards;
    }

    public List<DashboardItem> LoadDashboardsFromXml21()
    {
        var dashboards = new List<DashboardItem>();

        foreach (var file in Directory.GetFiles("Data/Dashboards", "*.xml"))
        {
            var dashboardId = Path.GetFileNameWithoutExtension(file);

            var dashboard = new DevExpress.DashboardCommon.Dashboard();
            dashboard.LoadFromXml(file);
            dashboards.Add(new DashboardItem
            {
                Id = dashboardId,
                DisplayName = dashboard.Title.Text ?? dashboardId
            });
        }

        if (dashboards != null && dashboards.Count() > 0)
        {
            DashboardIdValue = dashboards.FirstOrDefault()?.Id;
        }

        return dashboards;
    }
    public List<DashboardItem> LoadDashboardsFromXml()
    {
        var dashboards = new List<DashboardItem>();

        foreach (var file in Directory.GetFiles("Data/Dashboards", "*.xml"))
        {
            var dashboardId = Path.GetFileNameWithoutExtension(file);

            var dashboard = new DevExpress.DashboardCommon.Dashboard();
            dashboard.LoadFromXml(file);

            dashboards.Add(new DashboardItem
            {
                Id = dashboardId,
                DisplayName = dashboard.Title.Text ?? dashboardId
            });
        }

        // Apply custom order
        dashboards = dashboards
            .OrderBy(d => _customOrder.Contains(d.Id) ? _customOrder.IndexOf(d.Id) : int.MaxValue)
            .ThenBy(d => d.DisplayName) // fallback order
            .ToList();

        if (dashboards.Any())
        {
            DashboardIdValue = dashboards.First().Id;
        }

        return dashboards;
    }
    private void PromptDelete(DashboardItem item)
    {
        dashboardToDelete = item;
        isDeletePopupVisible = true;
    }

    private void CancelDelete()
    {
        dashboardToDelete = null;
        isDeletePopupVisible = false;
    }

    private void ConfirmDeleteold()
    {
        try
        {
            if (dashboardToDelete != null)
            {
                string filePath = Path.Combine("Data/Dashboards", $"{dashboardToDelete.Id}.xml");

                if (File.Exists(filePath))
                {
                    File.Delete(filePath);
                }

                // Reload list
                DashboardIds = LoadDashboardsFromXml();

                // If current dashboard is deleted, reset
                if (dashboardItem?.Id == dashboardToDelete.Id)
                {
                    dashboardItem = DashboardIds.FirstOrDefault();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting dashboard: {ex.Message}");
        }
        finally
        {
            dashboardToDelete = null;
            isDeletePopupVisible = false;
        }
    }
   
    private async Task ConfirmDelete_v()
    {
        try
        {
            if (dashboardToDelete != null)
            {
                string sourcePath = Path.Combine("Data/Dashboards", $"{dashboardToDelete.Id}.xml");
                string archiveFolder = Path.Combine("Data/Archived");

                // Ensure the archive folder exists
                Directory.CreateDirectory(archiveFolder);

                // Generate archive filename
                string timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
                string newFileName = $"{dashboardToDelete.Id}_{timestamp}.xml";
                string destinationPath = Path.Combine(archiveFolder, newFileName);

                // Move the file to archive
                if (File.Exists(sourcePath))
                {
                    File.Move(sourcePath, destinationPath);
                }

                //Delete associated permission from DB
                var existingPermissions = await Mediator.Send(new GetApplicationByParentIDListQuery("60800"));

                var matchedPermission = existingPermissions
                    .FirstOrDefault(p => p.PermissionURL == dashboardToDelete.Id);

                if (matchedPermission != null)
                {
                    var request = new DeleteApplicationPermissionListQuery(matchedPermission.PermissionID, matchedPermission.PermissionID);
                    await Mediator.Send(request);
                }

                // Reload dashboard list
                DashboardIds = LoadDashboardsFromXml();

                // Reset selection if deleted item was selected
                if (dashboardItem?.Id == dashboardToDelete.Id)
                {
                    dashboardItem = DashboardIds.FirstOrDefault();
                }

                toastService.ShowToast($"'{dashboardToDelete.DisplayName}' deleted", AC.SD.Core.Services.ToastLevel.Success);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error moving/renaming dashboard: {ex.Message}");
        }
        finally
        {
            dashboardToDelete = null;
            isDeletePopupVisible = false;
        }
    }
    private async Task ConfirmDelete()
    {
        try
        {
            if (dashboardToDelete != null)
            {
                string sourcePath = Path.Combine("Data/Dashboards", $"{dashboardToDelete.Id}.xml");
                string archiveFolder = Path.Combine("Data/Archived");

                // Ensure the archive folder exists
                Directory.CreateDirectory(archiveFolder);

                // Generate archive filename
                string timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
                string newFileName = $"{dashboardToDelete.Id}_{timestamp}.xml";
                string destinationPath = Path.Combine(archiveFolder, newFileName);

                // Move the file to archive
                if (File.Exists(sourcePath))
                {
                    File.Move(sourcePath, destinationPath);
                }

                // ✅ Remove dashboard ID from dashboard-order.json
                string orderPath = Path.Combine("Data", "dashboard-order.json");
                if (File.Exists(orderPath))
                {
                    var json = File.ReadAllText(orderPath);
                    var idList = JsonSerializer.Deserialize<List<string>>(json) ?? new List<string>();

                    if (idList.Remove(dashboardToDelete.Id))
                    {
                        var updatedJson = JsonSerializer.Serialize(idList, new JsonSerializerOptions { WriteIndented = true });
                        File.WriteAllText(orderPath, updatedJson);
                    }
                }

                // Delete associated permission from DB
                var existingPermissions = await Mediator.Send(new GetApplicationByParentIDListQuery("60800"));
                var matchedPermission = existingPermissions.FirstOrDefault(p => p.PermissionURL == dashboardToDelete.Id);

                if (matchedPermission != null)
                {
                    var request = new DeleteApplicationPermissionListQuery(matchedPermission.PermissionID, matchedPermission.PermissionID);
                    await Mediator.Send(request);
                }

                // Reload dashboard list
                DashboardIds = LoadDashboardsFromXml();

                // Reset selection if deleted item was selected
                if (dashboardItem?.Id == dashboardToDelete.Id)
                {
                    dashboardItem = DashboardIds.FirstOrDefault();
                }

                toastService.ShowToast($"'{dashboardToDelete.DisplayName}' deleted", AC.SD.Core.Services.ToastLevel.Success);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error moving/renaming dashboard: {ex.Message}");
        }
        finally
        {
            dashboardToDelete = null;
            isDeletePopupVisible = false;
        }
    }

    private void ConfirmDeleteold1()
    {
        try
        {
            if (dashboardToDelete != null)
            {
                string sourcePath = Path.Combine("Data/Dashboards", $"{dashboardToDelete.Id}.xml");
                string archiveFolder = Path.Combine("Data/Archived");

                // Ensure the Deleted folder exists
                if (!Directory.Exists(archiveFolder))
                    Directory.CreateDirectory(archiveFolder);

                // Generate new filename: filename_yyyyMMdd_HHmmss.xml
                string timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
                string newFileName = $"{dashboardToDelete.Id}_{timestamp}.xml";
                string destinationPath = Path.Combine(archiveFolder, newFileName);

                if (File.Exists(sourcePath))
                {
                    File.Move(sourcePath, destinationPath);
                }

                // Reload dashboard list
                DashboardIds = LoadDashboardsFromXml();

                // Reset selected dashboard if needed
                if (dashboardItem?.Id == dashboardToDelete.Id)
                {
                    dashboardItem = DashboardIds.FirstOrDefault();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error moving/renaming dashboard: {ex.Message}");
        }
        finally
        {
            dashboardToDelete = null;
            isDeletePopupVisible = false;
        }
    }

    public async Task SyncDashboardsold()
    {      
        var dashboards = LoadDashboardsFromXml();

        var existingPermissions = await Mediator.Send(new GetApplicationByParentIDListQuery("60800"));

        foreach (var item in dashboards)
        {            
            if (existingPermissions.Any(p => p.PermissionURL == item.Id))
            continue;


            string xmlPath = $"Data/Dashboards/{item.Id}.xml";
            string xmlContent = await File.ReadAllTextAsync(xmlPath);

            var request = new CreateApplicationPermissionQuery
            {
                ParentID = 60800,
                PermissionName = item.DisplayName,
                PermissionURL = item.Id,
                Component = "DynamicDashboard",
                Name = "DynamicDashboard",
                PermissionLevel = 1,
                IsPermissionURL = true,
                IsHeader = false,
                PermissionOrder = "1"
            };
            await Mediator.Send(request);
            toastService.ShowToast("Record Sync Successfully", AC.SD.Core.Services.ToastLevel.Success);

        }

        StateHasChanged();
    }
    public async Task SyncDashboards()
    {
        var dashboards = LoadDashboardsFromXml(); // already sorted
        var existingPermissions = await Mediator.Send(new GetApplicationByParentIDListQuery("60800"));

        // STEP 1: Create missing permissions with correct PermissionOrder immediately
        for (int i = 0; i < dashboards.Count; i++)
        {
            var item = dashboards[i];
            string correctOrder = (i + 1).ToString();

            var exists = existingPermissions.Any(p => p.PermissionURL == item.Id);
            if (!exists)
            {
                string xmlPath = $"Data/Dashboards/{item.Id}.xml";
                string xmlContent = await File.ReadAllTextAsync(xmlPath);

                var createRequest = new CreateApplicationPermissionQuery
                {
                    ParentID = 60800,
                    PermissionName = item.DisplayName,
                    PermissionURL = item.Id,
                    Component = "DynamicDashboard",
                    Name = "DynamicDashboard",
                    PermissionLevel = 1,
                    IsPermissionURL = true,
                    IsHeader = false,
                    PermissionOrder = correctOrder
                };

                await Mediator.Send(createRequest);
                toastService.ShowToast($"Created: {item.DisplayName}", AC.SD.Core.Services.ToastLevel.Success);
            }
        }

        // STEP 2: Update permission order for all dashboards
        for (int i = 0; i < dashboards.Count; i++)
        {
            var item = dashboards[i];
            string correctOrder = (i + 1).ToString();

            var updateRequest = new UpdateOrderApplicationPermission
            {
                ParentID = 60800,
                PermissionName = item.DisplayName,
                PermissionURL = item.Id,
                Name = "DynamicDashboard",
                PermissionOrder = correctOrder
            };

            await Mediator.Send(updateRequest);
            toastService.ShowToast($"Updated Order: {item.DisplayName}", AC.SD.Core.Services.ToastLevel.Info);
        }

        StateHasChanged();
    }

    void MoveUp(DashboardItem item)
    {
        int index = DashboardIds.IndexOf(item);
        if (index > 0)
        {
            (DashboardIds[index], DashboardIds[index - 1]) = (DashboardIds[index - 1], DashboardIds[index]);
            SaveDashboardOrder();
            StateHasChanged();
        }
    }

    void MoveDown(DashboardItem item)
    {
        int index = DashboardIds.IndexOf(item);
        if (index < DashboardIds.Count - 1)
        {
            (DashboardIds[index], DashboardIds[index + 1]) = (DashboardIds[index + 1], DashboardIds[index]);
            SaveDashboardOrder();
            StateHasChanged();
        }
    }

    void SaveDashboardOrder()
    {
        var orderPath = Path.Combine("Data", "dashboard-order.json");
        var idList = DashboardIds.Select(d => d.Id).ToList();
        var json = JsonSerializer.Serialize(idList);
        File.WriteAllText(orderPath, json);
    }


}