@page "/democontent"
@using global::Core.Repositories.Query
@inject IEmailTopicsQueryRepository EmailRepo
@inject IJSRuntime JSRuntime

<h3>Convert Plain Text</h3>

<button class="btn btn-primary" @onclick="ConvertAllPlainText">Convert</button>

<p><b>Status:</b> @statusMessage</p>

@code {
    private string statusMessage = "";

    private async Task ConvertAllPlainText1()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("showLoading");

            var ids = await EmailRepo.GetAllIdsAsync();

            foreach (var id in ids)
            {
                var fileData = await EmailRepo.GetFileDataByIdAsync(id);
                if (fileData is { Length: > 0 })
                {
                    string plainText = ExtractPlainText(fileData);
                    if (plainText.Length > 500)
                        plainText = plainText[..500];

                    await EmailRepo.UpdateDescriptionAsync(id, plainText);
                }
            }

            statusMessage = "Completed";
        }
        catch (Exception ex)
        {
            statusMessage = "Failed: " + ex.Message;
        }
        finally
        {
            await JSRuntime.InvokeVoidAsync("hideLoading");
        }
    }
    private async Task ConvertAllPlainText()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("showLoading");

            var ids = await EmailRepo.GetAllIdsAsync();
            List<int> failedIds = new();

            foreach (var id in ids)
            {
                try
                {
                    var fileData = await EmailRepo.GetFileDataByIdAsync(id);
                    if (fileData is { Length: > 0 })
                    {
                        string plainText = ExtractPlainText(fileData);
                        if (plainText.Length > 500)
                            plainText = plainText[..500];

                        await EmailRepo.UpdateDescriptionAsync(id, plainText);
                    }
                }
                catch (Exception ex) when (ex.Message.Contains("Timeout expired"))
                {
                    // Log or store failed ID
                    failedIds.Add(id);
                    continue; // Skip this ID and continue with the next one
                }
            }

            statusMessage = failedIds.Count == 0
                ? "Completed"
                : $"Completed with failures. Skipped IDs: {string.Join(", ", failedIds)}";
        }
        catch (Exception ex)
        {
            statusMessage = "Failed: " + ex.Message;
        }
        finally
        {
            await JSRuntime.InvokeVoidAsync("hideLoading");
        }
    }


    private string ExtractPlainText(byte[] fileData)
    {
        using var server = new DevExpress.XtraRichEdit.RichEditDocumentServer();
        server.LoadDocument(fileData); // Supports RTF, DOCX, HTML, etc.
        return server.Text;
    }
}
