@page "/DemoEmail"
@using Application.Commands;
@using Application.Queries;
@using Application.Response;
@using MediatR
@inject IMediator Mediator
@using global::Core.Entities;
@using DevExpress.Export
@using global::Core.Repositories.Query;
@inject IJSRuntime JSRuntime
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService

@using global::Core.Entities.Views;
@using global::Core.EntityModels;

<DxButton Text="@ButtonText" Click="@ToggleRecording" CssClass="record-button"></DxButton>

@if (IsRecording)
{
    <p>Recording... Press the button again to stop.</p>
}

@if (Recordings.Any())
{
    <h3>Recordings</h3>
    <ul>
        @foreach (var recording in Recordings)
        {
            <li>
                <audio controls>
                    <source src="@recording.Url" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
                <DxButton Text="Delete" Click="() => DeleteRecording(recording.Id)" />
            </li>
        }
    </ul>
}




<DxHtmlEditor @bind-Value="@Markup" Height="200px">
    <DxHtmlEditorMentions>
        <DxHtmlEditorMention Data="@_participantData"
                             DisplayFieldName="@nameof(ViewEmployee.Name)"
                             SearchFieldNames="@SearchFieldNames" />
    </DxHtmlEditorMentions>
</DxHtmlEditor>

@code {


    private bool IsRecording { get; set; }
    private string ButtonText => IsRecording ? "Stop Recording" : "Start Recording";

    private List<Recording> Recordings { get; set; } = new();

    private async Task ToggleRecording()
    {
        if (IsRecording)
        {
            await StopRecording();
        }
        else
        {
            await StartRecording();
        }
    }

    private async Task StartRecording()
    {
        IsRecording = true;
        await JSRuntime.InvokeVoidAsync("startVoiceRecording");
    }

    private async Task StopRecording()
    {
        IsRecording = false;
        var recordingUrl = await JSRuntime.InvokeAsync<string>("stopVoiceRecording");

        // Add the new recording to the list
        Recordings.Add(new Recording
            {
                Id = Guid.NewGuid(),
                Url = recordingUrl
            });
    }

    private void DeleteRecording(Guid id)
    {
        var recording = Recordings.FirstOrDefault(r => r.Id == id);
        if (recording != null)
        {
            Recordings.Remove(recording);
        }
    }

    private class Recording
    {
        public Guid Id { get; set; }
        public string Url { get; set; }
    }



    private List<ViewEmployee>? _participant;
    public ApplicationUser? applicationUser { get; private set; }
    private ViewEmployee[] _participantData { get; set; }
    string Markup = "";
    string[] SearchFieldNames = { nameof(ViewEmployee.Name) };

   
     protected override async Task OnInitializedAsync()
    {

        Markup = GetData();

        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        var plist = await Mediator.Send(new GetAllEmployeeListQuery());
        _participant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();


        _participantData = _participant.Select(p => new ViewEmployee
            {
                EmployeeID = p.EmployeeID,
                UserID = p.UserID,
                SageID = p.SageID,
                PlantID = p.PlantID,
                LevelID = p.LevelID,
                FirstName = p.FirstName,
                LastName = p.LastName,
                NickName = p.NickName,
                UserCode = p.UserCode,
                Name = $"{p.FirstName} {p.LastName}",
                
            }).ToArray();
    }
    public string GetData()
    {
        return $@"<p>Supported browsers:
                <table>
                    <tbody>
                        <tr>
                            <td><strong>Google Chrome (including Android)</strong></td>
                            <td>Latest</td>
                        </tr>
                        <tr>
                            <td><strong>Apple Safari (including iOS)</strong></td>
                            <td>Latest</td>
                        </tr>
                        <tr>
                            <td><strong>Mozilla Firefox</strong></td>
                            <td>Latest</td>
                        </tr>
                        <tr>
                            <td><strong>Microsoft Edge</strong></td>
                            <td>Latest</td>
                        </tr>
                        <tr>
                            <td><strong><a href='https://support.microsoft.com/en-us/microsoft-edge/what-is-microsoft-edge-legacy-3e779e55-4c55-08e6-ecc8-2333768c0fb0' rel='noopener noreferrer' target='_blank'>Microsoft Edge Legacy</a></strong></td>
                            <td>Not supported</td>
                        </tr>
                    </tbody>
                </table>
                <br>";
    }
}
