@using Application.Commands;
@using Application.Common.Helper;
@using Application.Queries;
@using Application.Response;
@using Markdig;
@using Microsoft.AspNetCore.Http;
@using Newtonsoft.Json
@using global::Core.Repositories.Query;
@using global::Core.Entities;
@using global::Core.EntityModels;
@using global::Core.Entities.Views;
@using MediatR
@inject IMediator Mediator
@using System.ComponentModel.DataAnnotations
@using DevExpress.Blazor.Internal
@using System.Collections.Generic
@inject ILocalStorageService<ApplicationUser> _localStorageService
@page "/DemoViewEmail"
@page "/DemoViewEmail/{ActiveSessionId}"
@page "/DemoViewEmail/{TodoSessionId:guid}/{Page}"
@using DevExpress.Blazor.RichEdit
@using DevExpress.Blazor.Office
@using System.Globalization
@using System;
@using Application.Command.Document;
@using Microsoft.Extensions.Configuration;
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime;
@inject HttpClient httpClient;
@using System.IO;
@using Microsoft.JSInterop;
@using DevExpress.DocumentView;
@inject NavigationManager NavigationManager
@using System.Web;
@inject IToastService ToastService
@inject AC.SD.Core.Services.ToastService toastService
@using System.Text;
@using RtfPipe;
@inject Application.Common.Helper.Helper  dateformathelper
@using System.Net.Http;
@using System.Threading.Tasks
@using System.Threading
@using System.Timers;
@using Application.Command.ApplicationMasterChilds;
@using Application.Command.ApplicationMasterDetails;
@inject AC.SD.Core.Helpers.TreeGenerateRecursive _treeGenerateRecursive
@implements IAsyncDisposable;
@inherits BasePage
@inject PersistentComponentState ComponentState
@using System.Text.Json;
@using System.Text.Json.Serialization;
@rendermode @(new  InteractiveServerRenderMode(prerender: false))
@inject DataRefreshService RefreshService
@inject ClipboardService ClipboardService
@using System.Text.RegularExpressions

<style scoped>
    .markasunread_border_top {
    border-top: 1px solid #242424 !important;
}
    .short-description {
    font-size: 11px;
    color: #707070;
    margin-top: 4px;
}

    .msgOpen
    {
    height: calc(100% - 97px) !important;
    }
    .attachments
    {
        margin: 5px 0;
    }  
    .email-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 10px;
    border-bottom: 1px solid #ccc;
    margin-bottom: 10px;
    position: sticky;
    z-index: 10;
    top: 0;
    background: #f6f6f6;
    border-top:1px solid #d2d2d2;
    }

    .email-subject {
    font-size: 20px;
    font-weight: bold;
    color: #333;
    }

    .menu-button {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    position: relative;
    }

    .dropdown {
    position: relative;
    display: inline-block;
    }

    .menu-content {
    display: none;
    position: absolute;
    right: 0;
    top: 28px;
    background-color: #fff;
    min-width: 160px;
    border: 1px solid #ccc;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    border-radius: 6px;
    overflow: hidden;
    }

    .menu-content div {
    padding: 10px 16px;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    }

    .menu-content div:hover {
    background-color: #f1f1f1;
    }

    .email-details {
    font-size: 11px;
    color: #666;
    margin-top: 3px;
    cursor: pointer;
    }

    .email-details-content {
    display: none;
    font-size: 13px;
    color: #555;
    margin-top: 5px;
    }

    h2 {
    margin-bottom: 20px;
    color: #333;
    }

    .accordion1 {
    display: flex;
    flex-direction: column;
    gap: 0px;
    margin-bottom: 15px;
    }

    .accordion-item {
    border: 0px solid #ccc;
    border-radius: 8px;
    overflow: hidden;
    /*  background-color: #e9f5f2;
    border-left: 4px solid #4CAF50; */
    border-radius: 0px;
    /* box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); */
    margin-left: 15px;
    margin-right: 15px;
    border: 1px solid #d9d8d8;
    }

    .accordion-header {
    padding: 10px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #333;   
    border-bottom: 1px solid #e4e4e4;
    }


.right-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
}

.icon-bar {
    display: flex;
    gap: 10px;
}

.icon-btn {
    cursor: pointer;
    font-size: 16px;
    color: #555;
    transition: color 0.2s ease;
}

.icon-btn:hover {
    color: #007BFF;
}

.time {
    font-weight: bold;
    font-size: 13px;
    color: #333;
    white-space: nowrap;
}


    .accordion-body {
    display: none;
    padding: 1px; 
    font-size: 14px;
    color: #555;
    /* box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); */
    margin-left:10px;
    }

    .accordion-body.active1 {
    display: block;
    }

    .email-info div {
    margin-bottom: 5px;
    word-break: break-word;
    }

    .email-info.limited {
    max-height: 60px;
    overflow: hidden;
    position: relative;
    }

    .email-info.expanded {
    max-height: none;
    }

    .show-more {
    margin-top: 5px;
    font-size: 12px;
    color: #007BFF;
    cursor: pointer;
    text-decoration: underline;
    }

    .email-body {
    margin: 5px 0;
    border-radius: 5px;
    padding: 0px;
    /* max-height: 300px;
    overflow-y: auto; */
    }

    .attachments ul {
    padding-left: 20px;
    margin-top: 5px;
    }

    .attachments li {
    margin: 4px 0;
    }

    .attachments a {
    color: #007BFF;
    text-decoration: none;
    }

    .attachments a:hover {
    text-decoration: underline;
    }

    .time {
    /*  font-size: 12px;
    color: #777; */
    font-weight:100;
    font-size: 12px;
    color: #777;
    }

    .fromtxt {
    font-weight: bold;
    font-size: 12px;
    }

    .sender-info {
    display: flex;
    align-items: center;
    gap: 8px;
    }

    .avatar-circle {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background-color: #d7d7d7; /* You can make this dynamic */
    color: #000000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    }

    .email-body-wrapper {
    position: relative;
    }

    .limited-body {
    max-height: 180px;
    overflow: hidden;
    position: relative;
    }

    .email-body.expanded-body {
    max-height: none;
    }

    .show-more-btn {
    font-size: 13px;
    color: #007BFF;
    cursor: pointer;
    margin-top: 5px;
    text-align: left;
    }

    .center {
    text-align: left;
    margin: 15px 15px;
    }

    .show-main-body-btn {
    cursor: pointer;
    color: #007BFF;
    text-decoration: underline;
    font-size: 14px;
    }

    .main-body {
    display: none; /* Initially hidden */
    padding: 20px;
    border-top: 1px solid #ccc;
    background-color: #f9f9f9;
    }

</style>
<style>

    .email-header-left {
    display: flex;
    flex-direction: column;
    gap: 5px;
    }

    .email-subject {
    font-size: 1.1rem;
    font-weight: 600;
    }

    .email-date {
    font-size: 11px;
    color: #666;
    }

    .menu-button {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    }

    .menu-content {
    display: none;
    position: absolute;
    right: 12px;
    margin-top: 8px;
    background-color: #fff;
    border: 1px solid #ccc;
    z-index: 100;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .menu-content div {
    padding: 8px 12px;
    cursor: pointer;
    }

    .menu-content div:hover {
    background-color: #f2f2f2;
    }

    .dropdown.show .menu-content {
    display: block;
    }
    .top-action-btn {
    font-size: 13px;
    border: 1px solid #b4b4b4;
    padding: 6px 12px;
    border-radius: 5px;
    background-color: white;
    cursor: pointer;
}

.top-action-btn:hover {
    background-color: #f0f0f0;
}

.bottom-actions {
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #ddd;
    margin-top: 20px;
}

.bottom-actions div {
    cursor: pointer;
    font-size: 18px;
    color: #444;
    padding: 6px;
}

.bottom-actions div:hover {
    color: #007BFF;
}
</style>


<style scoped>
    .btn-load {
    background-color: #aeaeae;
    color: white;
    padding: 3px 9px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    width: 107px;
    transition: background-color 0.3s ease;
    margin: 10px;
    }

    .btn-load:hover {
    background-color: #0056b3;
    }


    .dheight
    {
    height: calc(100vh - 200px);
    } 
    .drawer {
    position: fixed;
    top: 0;
    right: -300px; /* Initially hidden (off-screen to the right) */
    width: 300px;
    height: 100%;
    background-color: #333;
    color: #fff;
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
    transition: right 0.3s ease-in-out;
    overflow-y: auto;
    z-index: 1000;
    }

    .drawer.open {
    right: 0; /* Slide in from the right */
    }

    .drawer-header {
    padding: 20px;
    background-color: #444;
    font-size: 20px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    }

    .drawer-content {
    padding: 20px;
    }

    .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 999;
    }

    .overlay.active {
    display: block; /* Show overlay when drawer is open */
    }

    .toggle-btn {
    padding: 10px 20px;
    background-color: #333;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    }

    .close-btn {
    background-color: transparent;
    color: #fff;
    border: none;
    font-size: 18px;
    cursor: pointer;
    }

</style>

<style>
    .txtEditorMsg {
    height: calc(100vh - 530px);
    background-color: white;
    }
    .lstcoversationrply.markasread img {
    width: 90% !important; 
    height: auto !important; 
    cursor: pointer;
    transition: transform 0.3s ease; 
    }
    #tableData img
    {
    width: 90% !important; 
    height: auto !important; 
    cursor: pointer;
    transition: transform 0.3s ease; 
    }
</style>
<style>
    .center-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: calc(100vh - 310px);
    margin: 0;
    }

    .warning-message {
    text-align: center;
    padding: 20px;
    border: 2px solid #f5c6cb;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    color: #721c24;
    }

    .warning-message h1 {
    font-size: 2rem;
    margin: 0;
    }

    .warning-message p {
    font-size: 1.2rem;
    margin-top: 10px;
    }
</style>





<link href="_content/AC.SD.Core/css/forum-mail.css" rel="stylesheet" />
<div class="">
    <div class="main-container">
        <!--  -->
        <!-- Main Content -->
        <!--  -->
        <div class="content-container row">
            <!-- Mini Menu Bar -->
            <div class="mini-menu-bar col-md-3 @toggleButtonVisible"  style="overflow-x: hidden;">
                <div class="mini-menu-bar-top">                    
                    <div class="card w-100" style="margin-bottom:10px; margin-top:10px;">                     
                        <div class="card-body p-0">
                            <DxTabs ScrollMode="TabsScrollMode.NavButtons" @bind-ActiveTabIndex="@ActiveTabIndex">
                                <DxTabPage Text="All" CssClass="@((isLeftMenuvisible == "All" ? "tActive": "tall"))" Click="@(() => OnLeftMenuItemClick("All"))">

                                </DxTabPage> 
                                <DxTabPage Text="Assign To" CssClass="@((isLeftMenuvisible == "AssignTo" ? "tActive": "tassignto"))" Click="@(() => OnLeftMenuItemClick("AssignTo"))">

                                </DxTabPage>                               
                                <DxTabPage Text="Sent" CssClass="@((isLeftMenuvisible == "Sent" ? "tActive": "sent"))" Click="@(() => OnLeftMenuItemClick("Sent"))">

                                </DxTabPage>
                                <DxTabPage Text="Library" CssClass="@((isLeftMenuvisible == "Library" ? "tActive": "library"))" Click="@(() => OnLeftMenuItemClick("Library"))"></DxTabPage> 
                                <DxTabPage Text="Transfer" CssClass="@((isLeftMenuvisible == "Transfer" ? "tActive": "transfer"))" Click="@(() => OnLeftMenuItemClick("Transfer"))"></DxTabPage> 
                                @if(_openAccessUserLink != null)
                                {
                                    <DxTabPage Text="Administrator" CssClass="@((isLeftMenuvisible == "Administrator" ? "tActive": "administrator"))" Click="@(() => OnLeftMenuItemClick("Administrator"))"></DxTabPage>   
                                } 

                            </DxTabs>                          
                        </div>
                    </div>

                    <div>
                        <div class="views-accordion">
                            @if(isLeftMenuvisible == "All")
                            {                                
                                <AllEmail @ref=RefAssignAll GridSearchText="@GridSearchText" ATopicId="onViewEmailAllClick" SubViewAllTopicId ="onSubViewEmailClick"></AllEmail>
                            }
                            else if (isLeftMenuvisible == "AssignTo")
                            {
                                <AssignToEmail @ref=RefAssignTo Page="@Page" GridSearchText="@GridSearchText" ToTopicId="onViewEmailToClick" SubViewToTopicId="onSubViewEmailClick" ToTopicIds="onViewEmailToClickMultiple " EnableArchiveAll="EnableArchiveAll" EnableClose="EnableClose" EnableOpen="EnableOpen" DisableOpenClose="DisableOpenClose" ></AssignToEmail>
                            }
                            @*  else if (isLeftMenuvisible == "AssignCC")
                        {
                            <CCEmail GridSearchText="@GridSearchText" CCTopicId="onViewEmailCCClick" SubViewCCTopicId="onSubViewEmailClick"></CCEmail>
                        } *@
                            else if(isLeftMenuvisible == "Sent")
                            {
                                <SentEmail sentTopicId="onViewEmailSentClick" SubViewSentTopicId="onSubViewEmailClick"></SentEmail>
                            }  
                            else if(isLeftMenuvisible == "Library")
                            {

                                <MasterSearch @ref=RefMasterSearch GridSearchText="@GridSearchText" MyDayFilterText="@MyDayFilterText" Filtersessionid="@FilterSessionId" ATopicId="onViewEmailAllClick" SubViewAllTopicId="onSubViewEmailClick" ToTopicIds="onViewEmailUnArchiveClick" EnableUnArchiveAll="EnableUnArchiveAll" EnableClose="EnableClose" EnableOpen="EnableOpen"></MasterSearch>
                            }
                            else if(isLeftMenuvisible == "Transfer")
                            {
                                <TransferEmail @ref=RefTransferEamil GridSearchText="@GridSearchText" ATopicId="onViewEmailAllClick" SubViewAllTopicId="onSubViewEmailClick"></TransferEmail>
                            }
                            else if (isLeftMenuvisible == "Administrator")
                            {
                                <AdminEmail @ref=RefAdminSearch GridSearchText="@GridSearchText" MyDayFilterText="@MyDayFilterText" ATopicId="onViewEmailAllClick" SubViewAllTopicId="onSubViewEmailClick" ></AdminEmail>
                            }
                        </div>
                    </div>
                </div>               
            </div>
            <!-- Menu Bar Content -->
            <div class="menu-bar-content-container @hiddenButtonCssClass">
                <div class="content-padding-20">
                    <div class="menu-bar-content-container-heading">
                        <div class="heading-icon-text">                          
                            <div class="mb-cc-text">
                                <div class="card w-100">
                                    <div class="card-body p-0">

                                        @if (ActiveSessionId != null)
                                        {
                                            @if (_discussionList != null && _discussionList.Any())
                                            {
                                                @if(isUserGroup)
                                                {
                                                    <DxMenu Orientation="Orientation.Horizontal"
                                                    DropDownActionMode="MenuDropDownActionMode.Click"
                                                    DisplayMode="MenuDisplayMode.Desktop"
                                                    Title=""
                                                    CollapseItemsToHamburgerMenu="true"
                                                    CollapseItemToIconMode="MenuCollapseItemToIconMode.All">                                               
                                                        <Items> 
                                                            <DxMenuItem Text="" Enabled="@isPage" IconCssClass="fa fa fa-reply" Click="@(() => GoBack())" />
                                                            <DxMenuItem Text="" IconCssClass="fa fa-th-list" Click="@(() => ToggleButtonClick())" />
                                                            <DxMenuItem Text="Posts" class="@((isMenuvisible == "Posts" ? "tActive": "tfiles"))" IconCssClass="menu-icon-products menu-icon" Click="@(() => OnMenuItemClick("Posts"))" />
                                                            <DxMenuItem Text="Files" Enabled="@isEnabled" class="@((isMenuvisible == "Files" ? "tActive": "tfiles"))" IconCssClass="fa fa-paperclip cdspc" Click="@(() => OnMenuItemClick("Files"))" />
                                                            <DxMenuItem Text="Todo" Enabled="@isTodoEnabled" class="@((isMenuvisible == "Todo" ? "tActive": "ttodo"))" IconCssClass="menu-icon-about menu-icon" Click="@(() => OnMenuItemClick("Todo"))" />

                                                            <DxMenuItem Text="Participants List" Enabled="@isEnabled" class="@((isMenuvisible == "AddParticipants" ? "tActive": "taddparticipants"))" IconCssClass="dxbl-image menu-icon-support menu-icon dx-menu-item-image" Click="@(() => OnMenuItemClick("AddParticipants"))" />                                                    

                                                            <DxMenuItem Text="Tags" Enabled="isTagEnabled" class="@((isMenuvisible == "Tags" ? "tActive": "ttags"))" IconCssClass="fa fa-tags" Click="@(() => OnMenuItemClick("Tags"))" />
                                                            <DxMenuItem Text="Archive All" IconCssClass="fa fa-archive" Click="@(() =>AddPopupArchiveAll() )" Visible="@ArchiveEnabled" />
                                                            <DxMenuItem Text="UnArchive All" IconCssClass="fa fa-archive" Click="@(() =>SubmitunArchivedAll() )" Visible="@UnArchiveEnabled" />
                                                            <DxMenuItem Text="Open" Visible="@isOpenEnabled" IconCssClass="fa fa-check-square" Click="@(() => SubmitOpen())" />
                                                            <DxMenuItem Text="Close" Visible="@isCloseEnabled" IconCssClass="fa fa-check" Click="@(() => SubmitClose())" />

                                                        </Items>
                                                    </DxMenu>
                                                }
                                                else
                                                {
                                                    <DxMenu Orientation="Orientation.Horizontal"
                                                    DropDownActionMode="MenuDropDownActionMode.Click"
                                                    DisplayMode="MenuDisplayMode.Desktop"
                                                    Title=""
                                                    CollapseItemsToHamburgerMenu="true"
                                                    CollapseItemToIconMode="MenuCollapseItemToIconMode.All">                                               
                                                        <Items> 
                                                            <DxMenuItem Text="" Enabled="@isPage" IconCssClass="fa fa fa-reply" Click="@(() => GoBack())" />
                                                            <DxMenuItem Text="" IconCssClass="fa fa-th-list" Click="@(() => ToggleButtonClick())" />
                                                            <DxMenuItem Text="Posts" class="@((isMenuvisible == "Posts" ? "tActive": "tfiles"))" IconCssClass="menu-icon-products menu-icon" Click="@(() => OnMenuItemClick("Posts"))" />
                                                            <DxMenuItem Text="Files" Enabled="@isEnabled" class="@((isMenuvisible == "Files" ? "tActive": "tfiles"))" IconCssClass="fa fa-paperclip cdspc" Click="@(() => OnMenuItemClick("Files"))" />
                                                            <DxMenuItem Text="Todo" Enabled="@isTodoEnabled" class="@((isMenuvisible == "Todo" ? "tActive": "ttodo"))" IconCssClass="menu-icon-about menu-icon" Click="@(() => OnMenuItemClick("Todo"))" />

                                                            <DxMenuItem Text="Group List" Enabled="@isEnabled" class="@((isMenuvisible == "AddGroupParticipants" ? "tActive": "taddgroupparticipants"))" IconCssClass="dxbl-image menu-icon-support menu-icon dx-menu-item-image" Click="@(() => OnMenuItemClick("AddGroupParticipants"))" />
                                                            <DxMenuItem Text="Tags" Enabled="isTagEnabled" class="@((isMenuvisible == "Tags" ? "tActive": "ttags"))" IconCssClass="fa fa-tags" Click="@(() => OnMenuItemClick("Tags"))" />
                                                            <DxMenuItem Text="Archive All" IconCssClass="fa fa-archive" Click="@(() =>AddPopupArchiveAll() )" Visible="@ArchiveEnabled" />
                                                            <DxMenuItem Text="UnArchive All" IconCssClass="fa fa-archive" Click="@(() =>SubmitunArchivedAll() )" Visible="@UnArchiveEnabled" />
                                                            <DxMenuItem Text="Open" Visible="@isOpenEnabled" IconCssClass="fa fa-check-square" Click="@(() => SubmitOpen())" />
                                                            <DxMenuItem Text="Close" Visible="@isCloseEnabled" IconCssClass="fa fa-check" Click="@(() => SubmitClose())" />

                                                            @*  <DxMenuItem>
                                                                <Template>
                                                                    <div>@elapsedTime </div>
                                                            </Template>
                                                        </DxMenuItem> *@                                                    
                                                        </Items>
                                                    </DxMenu>
                                                }
                                            }
                                        }
                                        else
                                        {

                                            @if(isUserGroup)
                                            {
                                                <DxMenu Orientation="Orientation.Horizontal"
                                                DropDownActionMode="MenuDropDownActionMode.Click"
                                                DisplayMode="MenuDisplayMode.Desktop"
                                                Title=""
                                                CollapseItemsToHamburgerMenu="true"
                                                CollapseItemToIconMode="MenuCollapseItemToIconMode.All">                                               
                                                    <Items> 
                                                        <DxMenuItem Text="" Enabled="@isPage" IconCssClass="fa fa fa-reply" Click="@(() => GoBack())" />
                                                        <DxMenuItem Text="" IconCssClass="fa fa-th-list" Click="@(() => ToggleButtonClick())" />
                                                        <DxMenuItem Text="Posts" class="@((isMenuvisible == "Posts" ? "tActive": "tfiles"))" IconCssClass="menu-icon-products menu-icon" Click="@(() => OnMenuItemClick("Posts"))" />
                                                        <DxMenuItem Text="Files" Enabled="@isEnabled" class="@((isMenuvisible == "Files" ? "tActive": "tfiles"))" IconCssClass="fa fa-paperclip cdspc" Click="@(() => OnMenuItemClick("Files"))" />
                                                        <DxMenuItem Text="Todo" Enabled="@isTodoEnabled" class="@((isMenuvisible == "Todo" ? "tActive": "ttodo"))" IconCssClass="menu-icon-about menu-icon" Click="@(() => OnMenuItemClick("Todo"))" />

                                                        <DxMenuItem Text="Participants List" Enabled="@isEnabled" class="@((isMenuvisible == "AddParticipants" ? "tActive": "taddparticipants"))" IconCssClass="dxbl-image menu-icon-support menu-icon dx-menu-item-image" Click="@(() => OnMenuItemClick("AddParticipants"))" />                                                    

                                                        <DxMenuItem Text="Tags" Enabled="isTagEnabled" class="@((isMenuvisible == "Tags" ? "tActive": "ttags"))" IconCssClass="fa fa-tags" Click="@(() => OnMenuItemClick("Tags"))" />
                                                        <DxMenuItem Text="Archive All" IconCssClass="fa fa-archive" Click="@(() =>AddPopupArchiveAll() )" Visible="@ArchiveEnabled" />
                                                        <DxMenuItem Text="UnArchive All" IconCssClass="fa fa-archive" Click="@(() =>SubmitunArchivedAll() )" Visible="@UnArchiveEnabled" />
                                                        <DxMenuItem Text="Open" Visible="@isOpenEnabled" IconCssClass="fa fa-check-square" Click="@(() => SubmitOpen())" />
                                                        <DxMenuItem Text="Close" Visible="@isCloseEnabled" IconCssClass="fa fa-check" Click="@(() => SubmitClose())" />
                                                        <DxMenuItem Text="New Subject" Visible="@isNewSubject" Click="@(() => onWindowVisible())" IconCssClass="fa fa-envelope" />
                                                    </Items>
                                                </DxMenu>
                                            }
                                            else
                                            {
                                                <DxMenu Orientation="Orientation.Horizontal"
                                                DropDownActionMode="MenuDropDownActionMode.Click"
                                                DisplayMode="MenuDisplayMode.Desktop"
                                                Title=""
                                                CollapseItemsToHamburgerMenu="true"
                                                CollapseItemToIconMode="MenuCollapseItemToIconMode.All">                                               
                                                    <Items> 
                                                        <DxMenuItem Text="" Enabled="@isPage" IconCssClass="fa fa fa-reply" Click="@(() => GoBack())" />
                                                        <DxMenuItem Text="" IconCssClass="fa fa-th-list" Click="@(() => ToggleButtonClick())" />
                                                        <DxMenuItem Text="Posts" class="@((isMenuvisible == "Posts" ? "tActive": "tfiles"))" IconCssClass="menu-icon-products menu-icon" Click="@(() => OnMenuItemClick("Posts"))" />
                                                        <DxMenuItem Text="Files" Enabled="@isEnabled" class="@((isMenuvisible == "Files" ? "tActive": "tfiles"))" IconCssClass="fa fa-paperclip cdspc" Click="@(() => OnMenuItemClick("Files"))" />
                                                        <DxMenuItem Text="Todo" Enabled="@isTodoEnabled" class="@((isMenuvisible == "Todo" ? "tActive": "ttodo"))" IconCssClass="menu-icon-about menu-icon" Click="@(() => OnMenuItemClick("Todo"))" />

                                                        <DxMenuItem Text="Group List" Enabled="@isEnabled" class="@((isMenuvisible == "AddGroupParticipants" ? "tActive": "taddgroupparticipants"))" IconCssClass="dxbl-image menu-icon-support menu-icon dx-menu-item-image" Click="@(() => OnMenuItemClick("AddGroupParticipants"))" />
                                                        <DxMenuItem Text="Tags" Enabled="isTagEnabled" class="@((isMenuvisible == "Tags" ? "tActive": "ttags"))" IconCssClass="fa fa-tags" Click="@(() => OnMenuItemClick("Tags"))" />
                                                        <DxMenuItem Text="Archive All" IconCssClass="fa fa-archive" Click="@(() =>AddPopupArchiveAll() )" Visible="@ArchiveEnabled" />
                                                        <DxMenuItem Text="UnArchive All" IconCssClass="fa fa-archive" Click="@(() =>SubmitunArchivedAll() )" Visible="@UnArchiveEnabled" />
                                                        <DxMenuItem Text="Open" Visible="@isOpenEnabled" IconCssClass="fa fa-check-square" Click="@(() => SubmitOpen())" />
                                                        <DxMenuItem Text="Close" Visible="@isCloseEnabled" IconCssClass="fa fa-check" Click="@(() => SubmitClose())" />

                                                        @*  <DxMenuItem>
                                                         <Template>
                                                             <div>@elapsedTime </div>
                                                        </Template>
                                                    </DxMenuItem> *@                                                    
                                                    </Items>
                                                </DxMenu>
                                            }

                                        }



                                    </div>
                                </div>
                            </div>

                        </div>
                        <div>
                            @if (_discussionList != null && _discussionList.Any())
                            {
                                @if (_headTopic != null && _headTopic.Any())
                                {
                                    @foreach (var item in _headTopic)
                                    {                                    
                                        <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto">
                                            <div class="uk-card-header topicheadbg" style="height: auto; border-bottom: none;">
                                                <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                    <div class="uk-card-header" style="border-bottom: none;">
                                                        <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">

                                                            <div class="mailbox-read-info">
                                                                @*  <h3 style="width: 90%;">  @(item.TopicName.Length > 100 ? item.TopicName.Substring(0, 100) : item.TopicName)  </h3> *@
                                                                <h3 style="width: 90%;">  @item.TopicName  </h3>
                                                                @if (_headTopic_Tag != null && _headTopic_Tag.Any())
                                                                {
                                                                    @foreach (var Tagitem in _headTopic_Tag)
                                                                    {
                                                                        @if(Tagitem.GroupName != null)
                                                                        {
                                                                            <span class=" handline tagbg">@Tagitem.GroupName</span>
                                                                        }

                                                                        @if(Tagitem.CategoryName != null)
                                                                        {
                                                                            <span class=" handline tagbg">@Tagitem.CategoryName</span>
                                                                        }

                                                                        @if (Tagitem.ActionNames != null && Tagitem.ActionNames.Any())
                                                                        {
                                                                            @foreach (var (itemss, index) in Tagitem.ActionNames.Select((value, i) => (value, i)))
                                                                            {
                                                                                @if (index < 2)
                                                                                {
                                                                                    <span class="handline tagbg">@itemss</span>
                                                                                }
                                                                            }
                                                                            @if (Tagitem.ActionNames.Count > 2)
                                                                            {
                                                                                <span id="showActionTagMultiple" class="handline tagbg more-dots" @onclick="() => ShowActionMultipleFlyout()">...</span>
                                                                            }

                                                                        }

                                                                        @if (!string.IsNullOrWhiteSpace(Tagitem.Name))
                                                                        {
                                                                            <span class="handline tagbg">@Tagitem.Name</span>
                                                                        }                                                                   

                                                                    }
                                                                }                                                               
                                                                @if (_headTopic_UserTag != null && _headTopic_UserTag.Any())
                                                                {
                                                                    @foreach (var (itemss, index) in _headTopic_UserTag.Select((value, i) => (value, i)))
                                                                    {
                                                                        @if (index < 2)
                                                                        {
                                                                            <span class="handline usertag">@itemss.UserTag</span>
                                                                        }
                                                                    }
                                                                    @if (_headTopic_UserTag.Count > 2)
                                                                    {
                                                                        <span id="showUserTagMultiple" class="handline usertag more-dots" @onclick="() => ShowUserMultipleFlyout()">...</span>
                                                                    }

                                                                } 
                                                            </div>  

                                                            <span class="mailbox-read-time pull-right" style="float: right; margin-top: -23px; margin-right: 40px;">@Application.Common.Helper.Helper.FormatDateTime(@item.StartDate)</span>
                                                            <span class="uk-label uk-margin-auto-left" style="float: right; margin-top: -23px; margin-right: 15px;">

                                                                @if (isAddParticipant)
                                                                {
                                                                    @if (isCommandTopicClosed)
                                                                    {
                                                                        @* <button @onclick="onAddPlist" class="btn btn-excel" style="margin-top: 2px;">Add Participant </button>*@
                                                                    }

                                                                }

                                                                @if (isEllipsis)
                                                                {
                                                                    @if (isCommandTopicClosed)
                                                                    {
                                                                        <div Id="showFlyout" class="handline fa fa-ellipsis-v" @onclick="() => IsOpenFlyout = true" style="font-size: 18px;    font-weight: bold;"></div>

                                                                    }
                                                                    else
                                                                    {
                                                                        <div style="color:red;margin-top: 10px;">Closed</div>
                                                                    }
                                                                }
                                                            </span>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            }


                        </div>
                    </div>

                    <DxDrawer CssClass="demo-drawer-overview-right dheight"
                    @bind-IsOpen="IsInfoOpen"
                    Mode="DrawerMode.Overlap"
                    Position="DrawerPosition.Right"
                    CloseOnTargetContentClick="false"
                    PanelWidth="95%">
                        <HeaderTemplate>
                            @DrawerTitle
                            <DxButton Attributes="GetCloseInfoButtonAttributes()"
                            Click="CloseInfo"
                            IconCssClass="fa fa-times"
                            RenderStyle="ButtonRenderStyle.Link" />
                        </HeaderTemplate>
                        <BodyTemplate>
                            <div style="width:100%;">
                                @if (DrawerView == "AttachedEmail")
                                {
                                    <CopyContentPage ItemId="@ecID" OnCloseRequestMsg="onRequestReload" />
                                }
                                else if (DrawerView == "MainSubject")
                                {
                                    <MainSubjectPage Page= "@isLeftMenuvisible"  ItemId="@ecID" OnCloseRequestMsg="onRequestReload" ToggleMainInfo="onToggleMainInfo" />                                   
                                }
                                
                            </div>                            
                        </BodyTemplate>
                        <FooterTemplate>
                            <DxButton Click="CloseInfo"
                            Text="OK" />
                        </FooterTemplate>
                        <TargetContent>


                            <div class="@((isComponentVisible ? "menu-bar-content-container-content msgOpen" : "menu-bar-content-container-content msgClosed"))">

                                @if (isMenuvisible == "Posts")
                                {
                                    <div id="tableData">
                                        <div>
                                            @if (ActiveSessionId != null)
                                            {
                                                var replyIndex = 0;

                                                @if (_discussionList != null && _discussionList.Any())
                                                {
                                                    isAuthorization = true;
                                                    @foreach (var item in _discussionList)
                                                    {
                                                        <div class="@((item.IsRead.GetValueOrDefault(false) || item.IsRead == null ? "markasread_border" : "markasunread_border"))" style="border: 1px solid #d2d2d2;">
                                                            <div class="email-header  @((item.IsRead.GetValueOrDefault(false) || item.IsRead == null ? "markasread_border_top" : "markasunread_border_top"))">
                                                                <!-- Left: Subject + Date -->
                                                                <div class="email-header-left">
                                                                    <div class="email-subject">@item.Name</div>
                                                                    <div class="email-date">
                                                                        @if (item.DueDate != null)
                                                                        {
                                                                            <span style="margin-right:10px;"> Due Date</span> 
                                                                            <span style="font-weight:bold;"> @Application.Common.Helper.Helper.FormatDate(item.DueDate.Value)</span>

                                                                        }
                                                                    </div>
                                                                </div>
                                                                <!-- Right: Reply Button + Dropdown Menu -->
                                                                   @*  <div style="display: flex; align-items: center; gap: 20px;">

                                                                        <button type="button" @onclick="@(() => ToggleMainSubject(item))" class="top-action-btn" style="padding-right: 10px !important; padding-left: 10px !important; font-size: 13px; border: 1px solid #d9d9d9; padding: 2px; border-radius: 5px;">
                                                                            <i class="fa fa-envelope"></i> Main Subject
                                                                        </button>

                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" class="top-action-btn"
                                                                            style="font-size: 13px; border: 1px solid #b4b4b4; padding: 2px 10px; border-radius: 5px;">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>

                                                                        <div class="dropdown">
                                                                            @{
                                                                                dynamicShowSubject = "showOpenSubject_" + item.ID;
                                                                            }
                                                                            <div id="@dynamicShowSubject" class="handline fa fa-ellipsis-v"
                                                                                 @onclick="() => ShowSubjectFlyout(item)"
                                                                                 style="margin-right: 10px; font-size: 18px; font-weight: bold;">
                                                                            </div>
                                                                        </div>
                                                                    </div> *@
                                                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">

                                                                    <!-- First Row: Buttons -->
                                                                    <div style="display: flex; gap: 10px;">
                                                                        <button type="button" @onclick="@(() => ToggleMainSubject(item))"
                                                                                style="padding: 4px 10px; font-size: 13px; border: 1px solid #d9d9d9; border-radius: 5px;">
                                                                            <i class="fa fa-envelope"></i> Main Subject
                                                                        </button>

                                                                        <button type="button" @onclick="@(() => onreply(item.ID))"
                                                                                style="padding: 4px 10px; font-size: 13px; border: 1px solid #b4b4b4; border-radius: 5px;">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>

                                                                        <div class="dropdown">
                                                                            @{
                                                                                dynamicShowSubject = "showOpenSubject_" + item.ID;
                                                                            }
                                                                            <div id="@dynamicShowSubject" class="fa fa-ellipsis-v"
                                                                                 @onclick="() => ShowSubjectFlyout(item)"
                                                                                 style="font-size: 18px; font-weight: bold; cursor: pointer; padding: 4px 8px; border: 1px solid #ccc; border-radius: 5px;">
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <!-- Second Row: Icons -->
                                                                    <div style="display: flex; gap: 5px; justify-content: flex-end;margin-right: 35px;">
                                                                        @* <div title="Like" style="text-align: center; font-size: 16px; color: #555; cursor: pointer;">
                                                                            <i class="fa fa-thumbs-up"></i><br />
                                                                            <span style="font-size: 12px;">Like</span>
                                                                        </div>
                                                                        <div title="Group" style="text-align: center; font-size: 16px; color: #555; cursor: pointer;">
                                                                            <i class="fa fa-users"></i><br />
                                                                            <span style="font-size: 12px;">Group</span>
                                                                        </div>
                                                                        <div title="Message" style="text-align: center; font-size: 16px; color: #555; cursor: pointer;">
                                                                            <i class="fa fa-comment"></i><br />
                                                                            <span style="font-size: 12px;">Message</span>
                                                                        </div> *@

                                                                        @if (item.IsAllowParticipants.GetValueOrDefault(false))
                                                                        {
                                                                            <span class="" style="font-size: 14px;"><i class="fa fa-users" aria-hidden="true"></i></span>
                                                                        }

                                                                        @if (item.Urgent.GetValueOrDefault(false))
                                                                        {
                                                                            <span class="urgent_icon" style="font-size: 14px;"><i class="fas fa-bell" style="" aria-hidden="true"></i></span>
                                                                        }

                                                                        @if (item.NotifyUser.GetValueOrDefault(false))
                                                                        {
                                                                            <span class="" style="font-size: 14px;"><i class="fa fa-commenting" style="" aria-hidden="true"></i></span>
                                                                        }

                                                                        @if (item.IsRead != null)
                                                                        {
                                                                            @if (item.IsRead.GetValueOrDefault(false))
                                                                            {
                                                                                <span class="primary_color_icon handline" style=" font-size: 14px;" @onclick="@(() => onMarkasunRead(item.EmailNotificationId))" title="Mark as unread"><i class="fa fa-envelope-open" aria-hidden="true"></i></span>

                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="primary_color_icon handline" style="font-size: 14px;" @onclick="@(() => onMarkasRead(item.EmailNotificationId))" title="Mark as read"><i class="fa fa-envelope" aria-hidden="true"></i></span>
                                                                            }

                                                                        }



                                                                    </div>
                                                                </div>

                                                                   

                                                            </div>
                                                             <!-- Bottom Icons -->
                                                           @*  <div class="bottom-actions" style="display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ccc; margin-top: 15px;">
                                                                <div title="Like" style="cursor: pointer;"><i class="fa fa-thumbs-up"></i></div>
                                                                <div title="Message" style="cursor: pointer;"><i class="fa fa-comment"></i></div>
                                                                <div title="Group" style="cursor: pointer;"><i class="fa fa-users"></i></div>
                                                                <div title="Mark as Read" style="cursor: pointer;"><i class="fa fa-envelope-open"></i></div>
                                                                <div title="Mark as Unread" style="cursor: pointer;"><i class="fa fa-envelope"></i></div>
                                                            </div> *@

                                                            @if (item.ReplyConversation != null && item.ReplyConversation.Any())
                                                            {
                                                                <div class="accordion1">
                                                                    @foreach (var items in item.ReplyConversation)
                                                                    {
                                                                        bool isFirst = replyIndex == 0;
                                                                        replyIndex++;
                                                                        <!-- Replys-->
                                                                        <div class="accordion-item">
                                                                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                                                                <div>
                                                                                    <div class="sender-info">
                                                                                        <div class="avatar-circle bg-a @((items.IsRead.GetValueOrDefault(false) || items.IsRead == null ? "markasread_b" : "markasunread_b"))">
                                                                                            @(string.IsNullOrEmpty(items.UserName) ? "" : items.UserName.Substring(0, 1))
                                                                                        </div>

                                                                                        <span class="fromtxt"><span style="font-weight: 100;">From:</span> @items.UserName</span>
                                                                                    </div>
                                                                                    <div class="short-description">
                                                                                        @(string.IsNullOrEmpty(items.Description) ? "" : items.Description.Substring(0, Math.Min(200, items.Description.Length)))    
                                                                                    </div>
                                                                                </div>
                                                                                @* <span class="time">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</span> *@
                                                                                
                                                                                 <!-- Right aligned time + icons -->
                                                                                <div class="right-actions">
                                                                                    <div class="time">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</div>
                                                                                    <div class="icon-bar">
                                                                                       @*  <i class="fa fa-thumbs-up icon-btn" title="Like"></i>
                                                                                        <i class="fa fa-comment icon-btn" title="Message"></i>
                                                                                        <i class="fa fa-users icon-btn" title="Group"></i> *@
                                                                                      

                                                                                        @if (items.IsRead != null)
                                                                                        {
                                                                                            @if (items.IsRead.GetValueOrDefault(false))
                                                                                            {
                                                                                                <span class="primary_color_icon handline" @onclick="@(() => onMarkasunRead(items.EmailNotificationId))" title="Mark as unread"><i class="fa fa-envelope-open" aria-hidden="true"></i></span>

                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <span class="primary_color_icon handline" @onclick="@(() => onMarkasRead(items.EmailNotificationId))" title="Mark as read"><i class="fa fa-envelope" aria-hidden="true"></i></span>
                                                                                            }

                                                                                        }
                                                                                    </div>
                                                                                </div>

                                                                            </div>
                                                                            <div class="accordion-body @(isFirst ? "active1" : "")">

                                                                                <div class="email-details" onclick="toggleDetails(this)">
                                                                                    Show To/CC
                                                                                </div>
                                                                                <div class="email-details-content">
                                                                                    <div>
                                                                                        <strong>To:</strong>
                                                                                        @if (items.AssignToList != null && items.AssignToList.Any())
                                                                                        {
                                                                                            @foreach (var itms in items.AssignToList)
                                                                                            {
                                                                                                <span>@itms.FirstName ,</span>
                                                                                            }
                                                                                        }
                                                                                        <br>
                                                                                    </div>
                                                                                    @if (items.AssignCCList != null && items.AssignCCList.Any())
                                                                                    {
                                                                                        <div>
                                                                                            <strong>Cc:</strong>
                                                                                            @foreach (var itm in items.AssignCCList)
                                                                                            {
                                                                                                <span>@itm.FirstName ,</span>
                                                                                            }
                                                                                        </div>
                                                                                    }
                                                                                </div>
                                                                                <div class="">
                                                                                    @if (items.CopyLinkEmailIds != null)
                                                                                    {
                                                                                        dynamicShowDrawer = "ShowOpenDrawer_" + items.ID;

                                                                                        <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(items))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px; " class="">
                                                                                            <i class="fa fa-envelope"></i> Attached Email
                                                                                        </button>
                                                                                    }
                                                                                </div>
                                                                                <div class="email-body">
                                                                                    @if (items.FileData == null)
                                                                                    {

                                                                                        <div class="btn-load" @onclick="() => LoadFileDataAsync(items)">
                                                                                            Load Content
                                                                                        </div>


                                                                                    }
                                                                                    else
                                                                                    {

                                                                                        byte[] htmlBinaryData1 = items.FileData;
                                                                                        string htmlContent1 = System.Text.Encoding.UTF8.GetString(htmlBinaryData1);

                                                                                        <div>
                                                                                            @((MarkupString)htmlContent1)
                                                                                        </div>
                                                                                    }
                                                                                </div>
                                                                                <div class="attachments">
                                                                                    <div>
                                                                                        @foreach (var attachment in items.documents)
                                                                                        {
                                                                                            @* <strong>Attachments:</strong> *@
                                                                                            <div class="tag handline v">
                                                                                                <i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName

                                                                                                @if (attachment.FileName.EndsWith(".wav", StringComparison.OrdinalIgnoreCase))
                                                                                                {
                                                                                                    <div class="options">
                                                                                                        <div class="play" @onclick="@(() => onPlayAudio(attachment.DocumentID))">
                                                                                                            <i class="fa fa-play" aria-hidden="true"></i>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    <div class="options">
                                                                                                        <div class="download" @onclick="@(() => onDocDownload_old(attachment.DocumentID))">
                                                                                                            <i class="fa fa-cloud-download" aria-hidden="true"></i>
                                                                                                        </div>
                                                                                                        <div class="preview" @onclick="@(() => onDocDownload(attachment.DocumentID))">
                                                                                                            <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                }
                                                                                            </div>
                                                                                        }
                                                                                    </div>

                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div>
                                                                    <div class="">
                                                                        <div class="accordion-header">
                                                                            <div class="sender-info">
                                                                                <div class="avatar-circle bg-a">
                                                                                        @(string.IsNullOrEmpty(item.UserName) ? "" : item.UserName.Substring(0, 1))
                                                                                    </div>
                                                                                <span class="fromtxt"><strong>From:</strong> @item.UserName</span>
                                                                            </div>
                                                                            <span class="time">@Application.Common.Helper.Helper.FormatDateTime(@item.AddedDate)</span>
                                                                        </div>
                                                                        <div class="" style="margin: 10px;">

                                                                            <div class="email-details" onclick="toggleDetails(this)">
                                                                                Show To/CC
                                                                            </div>
                                                                            <div class="email-details-content">
                                                                                <div>
                                                                                    <strong>To:</strong>
                                                                                    @if (item.AssignToList != null && item.AssignToList.Any())
                                                                                    {
                                                                                        @foreach (var itms in item.AssignToList)
                                                                                        {
                                                                                            <span>@itms.FirstName ,</span>
                                                                                        }
                                                                                    }
                                                                                    <br>
                                                                                </div>
                                                                                @if (item.AssignCCList != null && item.AssignCCList.Any())
                                                                                {
                                                                                    <div>
                                                                                        <strong>Cc:</strong>
                                                                                        @foreach (var itm in item.AssignCCList)
                                                                                        {
                                                                                            <span>@itm.FirstName ,</span>
                                                                                        }
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                            @if (item.DynamicFormEmailSectionName != null)
                                                                            {
                                                                                <div class="replybox" style="min-height:60px;">
                                                                                    <div style="font-weight: bold;">
                                                                                        Dynamic form @item.DynamicFormEmailSectionName
                                                                                    </div>
                                                                                    <text></text>
                                                                                    <div style=" float: right; font-size: 12px;">@item.ActUserName , @item.ActAddedDate</div>
                                                                                </div>
                                                                            }

                                                                            @if (!string.IsNullOrEmpty(item.BackURL))
                                                                            {
                                                                                string ActivityTypes = item.ActivityType == "FileProfileType" ? "Sunward Libraries" : item.ActivityType == "DynamicForm" ? item.DynamicFormName : "Activity";
                                                                                @if (item.ActivityType != "EmailFileProfileType")
                                                                                {
                                                                                    <div class="replybox" style="min-height:60px;">
                                                                                        <div style="font-weight: bold;">
                                                                                            @ActivityTypes Comment
                                                                                            <div style="float:right; line-height:16px">
                                                                                                @if (item.ActivityType == "FileProfileType")
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>
                                                                                                }
                                                                                                else if (item.ActivityType == "EmailFileProfileType")
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>
                                                                                                }
                                                                                                else if (item.ActivityType == "DynamicForm")
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackDynamicType(item.BackURL))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackActivity(item.BackURL))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>

                                                                                                }

                                                                                            </div>
                                                                                        </div>
                                                                                        <text>@item.ActCommentName</text>
                                                                                        <div style=" float: right; font-size: 12px;">@item.ActUserName , @item.ActAddedDate</div>
                                                                                    </div>

                                                                                }

                                                                            }
                                                                             <div class="">
                                                                                    @if (item.CopyLinkEmailIds != null)
                                                                                    {
                                                                                        dynamicShowDrawer = "ShowOpenDrawer_" + item.ID;

                                                                                        <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(item))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px; " class="">
                                                                                            <i class="fa fa-envelope"></i> Attached Email
                                                                                        </button>
                                                                                    }
                                                                                </div>
                                                                            <div class="email-body">
                                                                                @if (item.FileData == null)
                                                                                {

                                                                                    <div class="btn-load" @onclick="() => LoadFileDataAsync(item)">
                                                                                        Load Content
                                                                                    </div>


                                                                                }
                                                                                else
                                                                                {

                                                                                    byte[] htmlBinaryData1 = item.FileData;
                                                                                    string htmlContent1 = System.Text.Encoding.UTF8.GetString(htmlBinaryData1);

                                                                                    <div>
                                                                                        @((MarkupString)htmlContent1)
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                            <div class="attachments">
                                                                                <div>
                                                                                    @foreach (var attachment in item.documents)
                                                                                    {
                                                                                        @*  <strong>Attachments:</strong> *@
                                                                                        <div class="tag handline">
                                                                                            <i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName

                                                                                            @if (attachment.FileName.EndsWith(".wav", StringComparison.OrdinalIgnoreCase))
                                                                                            {
                                                                                                <div class="options">
                                                                                                    <div class="play" @onclick="@(() => onPlayAudio(attachment.DocumentID))">
                                                                                                        <i class="fa fa-play" aria-hidden="true"></i>
                                                                                                    </div>
                                                                                                </div>
                                                                                            }
                                                                                            else if (attachment.IsView)
                                                                                            {
                                                                                                <div class="options">
                                                                                                    <div class="download" @onclick="@(() => onDocDownload_old(attachment.DocumentID))">
                                                                                                        <i class="fa fa-cloud-download" aria-hidden="true"></i>
                                                                                                    </div>
                                                                                                    <div class="preview" @onclick="@(() => onDocDownload(attachment.DocumentID))">
                                                                                                        <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                                    </div>
                                                                                                </div>
                                                                                            }
                                                                                        </div>
                                                                                    }
                                                                                </div>

                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            }
                                                            @if (item.ReplyConversation?.Count < item.ReplyConversationCount)
                                                            {
                                                                <div style="text-align:center">
                                                                    <button class="loadmorebg" @onclick="() => LoadMoreRepliesnew(item.ID, item.ReplyConversationCount)">Load More</button>
                                                                </div>
                                                            }                                                           

                                                        </div>
                                                        <div>
                                                            @*  <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto  @((item.IsRead.GetValueOrDefault(false) || item.IsRead == null ? "markasread_border" : "markasunread_border"))" style="margin-right: 10px;">
                                                            <div class="uk-card-header">
                                                                <div class="container-header" style="margin-left: -9px;">
                                                                </div>
                                                            </div> *@

                                   
                                                            @* <div class="uk-card-body">
                                                                @if (item.CopyLinkEmailIds != null)
                                                                {
                                                                    dynamicShowDrawer = "ShowOpenDrawer_" + item.ID;

                                                                    <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(item))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px;margin-top: 10px; " class="">
                                                                        <i class="fa fa-envelope"></i> Attached Email
                                                                    </button>
                                                                }
                                                            </div> *@

                                                            <AudioPlayerModal AudioSource="@audioBase64Source"
                                                            DocumentId="@currentAudioId"
                                                            IsVisible="@isAudioPopupVisible"
                                                            IsVisibleChanged="@(v => isAudioPopupVisible = v)"
                                                            OnClosed="ResetAudioPlayer" />


                                                            @*  @if (true)                
                                                            {
                                                                <div class="uk-card-footer">
                                                                    <div>
                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>
                                                                        <p style="color: #5151b3;" class="handline" @onclick="@(() => ToggleItemVisibility(item.ID,item.ReplyConversationCount))">@item.ReplyConversationCount replies </p>

                                                                        @if (itemVisibility.ContainsKey(item.ID) && itemVisibility[item.ID])
                                                                        {
                                                                            if (replyDiscussions.ContainsKey(item.ID) && replyDiscussions[item.ID].Any())
                                                                            {
                                                                                <div class="accordion1">
                                                                                @foreach (var items in replyDiscussions[item.ID])
                                                                                {
                                                                                    bool isFirst = replyIndex == 0;
                                                                                    replyIndex++;

                                                                                    <div class="lstcoversationrply @((items.IsRead.GetValueOrDefault(false) || items.IsRead == null ? "markasread" : "markasunread"))">


                                                                                            <!-- Replys-->
                                                                                            <div class="accordion-item">
                                                                                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                                                                                    <div class="sender-info">
                                                                                                        <div class="avatar-circle bg-a">A</div>
                                                                                                        <span class="fromtxt"><strong>From:</strong> @items.UserName</span>
                                                                                                    </div>
                                                                                                    <span class="time">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</span>
                                                                                                </div>
                                                                                                <div class="accordion-body @(isFirst ? "active1" : "")">

                                                                                                    <div class="email-details" onclick="toggleDetails(this)">
                                                                                                        Show To/CC
                                                                                                    </div>
                                                                                                    <div class="email-details-content">
                                                                                                        <div>
                                                                                                            <strong>To:</strong>
                                                                                                            @if (items.AssignToList != null && items.AssignToList.Any())
                                                                                                            {
                                                                                                                @foreach (var itms in items.AssignToList)
                                                                                                                {
                                                                                                                    <span>@itms.FirstName ,</span>
                                                                                                                }
                                                                                                            }
                                                                                                            <br>
                                                                                                        </div>
                                                                                                        @if (items.AssignCCList != null && items.AssignCCList.Any())
                                                                                                        {
                                                                                                            <div>
                                                                                                                <strong>Cc:</strong>
                                                                                                                @foreach (var itm in items.AssignCCList)
                                                                                                                {
                                                                                                                    <span>@itm.FirstName ,</span>
                                                                                                                }
                                                                                                            </div>
                                                                                                        }
                                                                                                    </div>

                                                                                                    <div class="email-body">
                                                                                                        @if (items.FileData == null)
                                                                                                        {

                                                                                                            <div class="btn-load" @onclick="() => LoadFileDataAsync(items)">
                                                                                                                Load Content
                                                                                                            </div>


                                                                                                        }
                                                                                                        else
                                                                                                        {

                                                                                                            byte[] htmlBinaryData1 = items.FileData;
                                                                                                            string htmlContent1 = System.Text.Encoding.UTF8.GetString(htmlBinaryData1);

                                                                                                            <div>
                                                                                                                @((MarkupString)htmlContent1)
                                                                                                            </div>
                                                                                                        }
                                                                                                    </div>
                                                                                                    <div class="attachments">
                                                                                                        <div>
                                                                                                            @foreach (var attachment in items.documents)
                                                                                                            {
                                                                                                                <strong>Attachments:</strong>
                                                                                                                <div class="tag handline">
                                                                                                                    <i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName

                                                                                                                    @if (attachment.FileName.EndsWith(".wav", StringComparison.OrdinalIgnoreCase))
                                                                                                                    {
                                                                                                                        <div class="options">
                                                                                                                            <div class="play" @onclick="@(() => onPlayAudio(attachment.DocumentID))">
                                                                                                                                <i class="fa fa-play" aria-hidden="true"></i>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    }
                                                                                                                    else if (attachment.IsView)
                                                                                                                    {
                                                                                                                        <div class="options">
                                                                                                                            <div class="download" @onclick="@(() => onDocDownload_old(attachment.DocumentID))">
                                                                                                                                <i class="fa fa-cloud-download" aria-hidden="true"></i>
                                                                                                                            </div>
                                                                                                                            <div class="preview" @onclick="@(() => onDocDownload(attachment.DocumentID))">
                                                                                                                                <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    }
                                                                                                                </div>
                                                                                                            }
                                                                                                        </div>

                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        <div>
                                                                                            @if (items.CopyLinkEmailIds != null)
                                                                                            {
                                                                                                { dynamicShowDrawer = "ShowOpenDrawer_" + item.ID;}

                                                                                                <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(items))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px;margin-top: 10px; " class="">
                                                                                                    <i class="fa fa-envelope"></i> Attached Email
                                                                                                </button>                                                                          
                                                                                            }                                                                                 
                                                                                        </div>   

                                                                                    </div>


                                                                                }
                                                                               </div>
                                                                                @if (hasMore && !isLoading)
                                                                                {
                                                                                    <div style="text-align:center">
                                                                                        <button class="loadmorebg" @onclick="() => LoadMoreReplies(item.ID, item.ReplyConversationCount)">Load More</button>
                                                                                    </div>
                                                                                }
                                                                                else if (isLoading)
                                                                                {
                                                                                    <span>Loading...</span>
                                                                                }
                                                                            }
                                                                        }                                                                       
                                                                    </div>


                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="uk-card-footer">
                                                                    <div>
                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>
                                                                        <p style="color: #5151b3;" class="handline">0 replies </p>
                                                                    </div>
                                                                </div>
                                                            }    *@                                                
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    isAuthorization = false;
                                                    <div class="center-container">
                                                        <div class="warning-message">
                                                            <h1>Authorization  Denied</h1>
                                                            <p>Your authorization does not allow access to this page.</p>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            else
                                            {

                                                var replyIndex = 0;

                                                @if (_discussionList != null && _discussionList.Any())
                                                {
                                                    isAuthorization = true;
                                                    @foreach (var item in _discussionList)
                                                    {
                                                        <div class="@((item.IsRead.GetValueOrDefault(false) || item.IsRead == null ? "markasread_border" : "markasunread_border"))" style="border: 1px solid #d2d2d2;">
                                                            <div class="email-header  @((item.IsRead.GetValueOrDefault(false) || item.IsRead == null ? "markasread_border_top" : "markasunread_border_top"))">
                                                                <!-- Left: Subject + Date -->
                                                                <div class="email-header-left">
                                                                    <div class="email-subject">@item.Name</div>
                                                                    <div class="email-date">
                                                                        @if (item.DueDate != null)
                                                                        {
                                                                            <span style="margin-right:10px;"> Due Date</span> 
                                                                            <span style="font-weight:bold;"> @Application.Common.Helper.Helper.FormatDate(item.DueDate.Value)</span>

                                                                        }
                                                                    </div>
                                                                </div>
                                                                <!-- Right: Reply Button + Dropdown Menu -->
                                                                   @*  <div style="display: flex; align-items: center; gap: 20px;">

                                                                        <button type="button" @onclick="@(() => ToggleMainSubject(item))" class="top-action-btn" style="padding-right: 10px !important; padding-left: 10px !important; font-size: 13px; border: 1px solid #d9d9d9; padding: 2px; border-radius: 5px;">
                                                                            <i class="fa fa-envelope"></i> Main Subject
                                                                        </button>

                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" class="top-action-btn"
                                                                            style="font-size: 13px; border: 1px solid #b4b4b4; padding: 2px 10px; border-radius: 5px;">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>

                                                                        <div class="dropdown">
                                                                            @{
                                                                                dynamicShowSubject = "showOpenSubject_" + item.ID;
                                                                            }
                                                                            <div id="@dynamicShowSubject" class="handline fa fa-ellipsis-v"
                                                                                 @onclick="() => ShowSubjectFlyout(item)"
                                                                                 style="margin-right: 10px; font-size: 18px; font-weight: bold;">
                                                                            </div>
                                                                        </div>
                                                                    </div> *@
                                                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">

                                                                    <!-- First Row: Buttons -->
                                                                    <div style="display: flex; gap: 10px;">
                                                                        <button type="button" @onclick="@(() => ToggleMainSubject(item))"
                                                                                style="padding: 4px 10px; font-size: 13px; border: 1px solid #d9d9d9; border-radius: 5px;">
                                                                            <i class="fa fa-envelope"></i> Main Subject
                                                                        </button>

                                                                        <button type="button" @onclick="@(() => onreply(item.ID))"
                                                                                style="padding: 4px 10px; font-size: 13px; border: 1px solid #b4b4b4; border-radius: 5px;">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>

                                                                        <div class="dropdown">
                                                                            @{
                                                                                dynamicShowSubject = "showOpenSubject_" + item.ID;
                                                                            }
                                                                            <div id="@dynamicShowSubject" class="fa fa-ellipsis-v"
                                                                                 @onclick="() => ShowSubjectFlyout(item)"
                                                                                 style="font-size: 18px; font-weight: bold; cursor: pointer; padding: 4px 8px; border: 1px solid #ccc; border-radius: 5px;">
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <!-- Second Row: Icons -->
                                                                    <div style="display: flex; gap: 5px; justify-content: flex-end;margin-right: 35px;">
                                                                        @* <div title="Like" style="text-align: center; font-size: 16px; color: #555; cursor: pointer;">
                                                                            <i class="fa fa-thumbs-up"></i><br />
                                                                            <span style="font-size: 12px;">Like</span>
                                                                        </div>
                                                                        <div title="Group" style="text-align: center; font-size: 16px; color: #555; cursor: pointer;">
                                                                            <i class="fa fa-users"></i><br />
                                                                            <span style="font-size: 12px;">Group</span>
                                                                        </div>
                                                                        <div title="Message" style="text-align: center; font-size: 16px; color: #555; cursor: pointer;">
                                                                            <i class="fa fa-comment"></i><br />
                                                                            <span style="font-size: 12px;">Message</span>
                                                                        </div> *@

                                                                        @if (item.IsAllowParticipants.GetValueOrDefault(false))
                                                                        {
                                                                            <span class="" style="font-size: 14px;"><i class="fa fa-users" aria-hidden="true"></i></span>
                                                                        }

                                                                        @if (item.Urgent.GetValueOrDefault(false))
                                                                        {
                                                                            <span class="urgent_icon" style="font-size: 14px;"><i class="fas fa-bell" style="" aria-hidden="true"></i></span>
                                                                        }

                                                                        @if (item.NotifyUser.GetValueOrDefault(false))
                                                                        {
                                                                            <span class="" style="font-size: 14px;"><i class="fa fa-commenting" style="" aria-hidden="true"></i></span>
                                                                        }

                                                                        @if (item.IsRead != null)
                                                                        {
                                                                            @if (item.IsRead.GetValueOrDefault(false))
                                                                            {
                                                                                <span class="primary_color_icon handline" style=" font-size: 14px;" @onclick="@(() => onMarkasunRead(item.EmailNotificationId))" title="Mark as unread"><i class="fa fa-envelope-open" aria-hidden="true"></i></span>

                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="primary_color_icon handline" style="font-size: 14px;" @onclick="@(() => onMarkasRead(item.EmailNotificationId))" title="Mark as read"><i class="fa fa-envelope" aria-hidden="true"></i></span>
                                                                            }

                                                                        }



                                                                    </div>
                                                                </div>

                                                                   

                                                            </div>
                                                             <!-- Bottom Icons -->
                                                           @*  <div class="bottom-actions" style="display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ccc; margin-top: 15px;">
                                                                <div title="Like" style="cursor: pointer;"><i class="fa fa-thumbs-up"></i></div>
                                                                <div title="Message" style="cursor: pointer;"><i class="fa fa-comment"></i></div>
                                                                <div title="Group" style="cursor: pointer;"><i class="fa fa-users"></i></div>
                                                                <div title="Mark as Read" style="cursor: pointer;"><i class="fa fa-envelope-open"></i></div>
                                                                <div title="Mark as Unread" style="cursor: pointer;"><i class="fa fa-envelope"></i></div>
                                                            </div> *@

                                                            @if (item.ReplyConversation != null && item.ReplyConversation.Any())
                                                            {
                                                                <div class="accordion1">
                                                                    @foreach (var items in item.ReplyConversation)
                                                                    {
                                                                        bool isFirst = replyIndex == 0;
                                                                        replyIndex++;
                                                                        <!-- Replys-->
                                                                        <div class="accordion-item">
                                                                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                                                                <div>
                                                                                    <div class="sender-info">
                                                                                        <div class="avatar-circle bg-a @((items.IsRead.GetValueOrDefault(false) || items.IsRead == null ? "markasread_b" : "markasunread_b"))">
                                                                                            @(string.IsNullOrEmpty(items.UserName) ? "" : items.UserName.Substring(0, 1))
                                                                                        </div>

                                                                                        <span class="fromtxt"><span style="font-weight: 100;">From:</span> @items.UserName</span>
                                                                                    </div>
                                                                                    <div class="short-description">
                                                                                        @(string.IsNullOrEmpty(items.Description) ? "" : items.Description.Substring(0, Math.Min(200, items.Description.Length)))    
                                                                                    </div>
                                                                                </div>
                                                                                @* <span class="time">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</span> *@
                                                                                
                                                                                 <!-- Right aligned time + icons -->
                                                                                <div class="right-actions">
                                                                                    <div class="time">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</div>
                                                                                    <div class="icon-bar">
                                                                                       @*  <i class="fa fa-thumbs-up icon-btn" title="Like"></i>
                                                                                        <i class="fa fa-comment icon-btn" title="Message"></i>
                                                                                        <i class="fa fa-users icon-btn" title="Group"></i> *@
                                                                                      

                                                                                        @if (items.IsRead != null)
                                                                                        {
                                                                                            @if (items.IsRead.GetValueOrDefault(false))
                                                                                            {
                                                                                                <span class="primary_color_icon handline" @onclick="@(() => onMarkasunRead(items.EmailNotificationId))" title="Mark as unread"><i class="fa fa-envelope-open" aria-hidden="true"></i></span>

                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <span class="primary_color_icon handline" @onclick="@(() => onMarkasRead(items.EmailNotificationId))" title="Mark as read"><i class="fa fa-envelope" aria-hidden="true"></i></span>
                                                                                            }

                                                                                        }
                                                                                    </div>
                                                                                </div>

                                                                            </div>
                                                                            <div class="accordion-body @(isFirst ? "active1" : "")">

                                                                                <div class="email-details" onclick="toggleDetails(this)">
                                                                                    Show To/CC
                                                                                </div>
                                                                                <div class="email-details-content">
                                                                                    <div>
                                                                                        <strong>To:</strong>
                                                                                        @if (items.AssignToList != null && items.AssignToList.Any())
                                                                                        {
                                                                                            @foreach (var itms in items.AssignToList)
                                                                                            {
                                                                                                <span>@itms.FirstName ,</span>
                                                                                            }
                                                                                        }
                                                                                        <br>
                                                                                    </div>
                                                                                    @if (items.AssignCCList != null && items.AssignCCList.Any())
                                                                                    {
                                                                                        <div>
                                                                                            <strong>Cc:</strong>
                                                                                            @foreach (var itm in items.AssignCCList)
                                                                                            {
                                                                                                <span>@itm.FirstName ,</span>
                                                                                            }
                                                                                        </div>
                                                                                    }
                                                                                </div>
                                                                                <div class="">
                                                                                    @if (items.CopyLinkEmailIds != null)
                                                                                    {
                                                                                        dynamicShowDrawer = "ShowOpenDrawer_" + items.ID;

                                                                                        <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(items))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px; " class="">
                                                                                            <i class="fa fa-envelope"></i> Attached Email
                                                                                        </button>
                                                                                    }
                                                                                </div>
                                                                                <div class="email-body">
                                                                                    @if (items.FileData == null)
                                                                                    {

                                                                                        <div class="btn-load" @onclick="() => LoadFileDataAsync(items)">
                                                                                            Load Content
                                                                                        </div>


                                                                                    }
                                                                                    else
                                                                                    {

                                                                                        byte[] htmlBinaryData1 = items.FileData;
                                                                                        string htmlContent1 = System.Text.Encoding.UTF8.GetString(htmlBinaryData1);

                                                                                        <div>
                                                                                            @((MarkupString)htmlContent1)
                                                                                        </div>
                                                                                    }
                                                                                </div>
                                                                                <div class="attachments">
                                                                                    <div>
                                                                                        @foreach (var attachment in items.documents)
                                                                                        {
                                                                                            @* <strong>Attachments:</strong> *@
                                                                                            <div class="tag handline v">
                                                                                                <i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName

                                                                                                @if (attachment.FileName.EndsWith(".wav", StringComparison.OrdinalIgnoreCase))
                                                                                                {
                                                                                                    <div class="options">
                                                                                                        <div class="play" @onclick="@(() => onPlayAudio(attachment.DocumentID))">
                                                                                                            <i class="fa fa-play" aria-hidden="true"></i>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    <div class="options">
                                                                                                        <div class="download" @onclick="@(() => onDocDownload_old(attachment.DocumentID))">
                                                                                                            <i class="fa fa-cloud-download" aria-hidden="true"></i>
                                                                                                        </div>
                                                                                                        <div class="preview" @onclick="@(() => onDocDownload(attachment.DocumentID))">
                                                                                                            <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                }
                                                                                            </div>
                                                                                        }
                                                                                    </div>

                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div>
                                                                    <div class="">
                                                                        <div class="accordion-header">
                                                                            <div class="sender-info">
                                                                                <div class="avatar-circle bg-a">
                                                                                        @(string.IsNullOrEmpty(item.UserName) ? "" : item.UserName.Substring(0, 1))
                                                                                    </div>
                                                                                <span class="fromtxt"><strong>From:</strong> @item.UserName</span>
                                                                            </div>
                                                                            <span class="time">@Application.Common.Helper.Helper.FormatDateTime(@item.AddedDate)</span>
                                                                        </div>
                                                                        <div class="" style="margin: 10px;">

                                                                            <div class="email-details" onclick="toggleDetails(this)">
                                                                                Show To/CC
                                                                            </div>
                                                                            <div class="email-details-content">
                                                                                <div>
                                                                                    <strong>To:</strong>
                                                                                    @if (item.AssignToList != null && item.AssignToList.Any())
                                                                                    {
                                                                                        @foreach (var itms in item.AssignToList)
                                                                                        {
                                                                                            <span>@itms.FirstName ,</span>
                                                                                        }
                                                                                    }
                                                                                    <br>
                                                                                </div>
                                                                                @if (item.AssignCCList != null && item.AssignCCList.Any())
                                                                                {
                                                                                    <div>
                                                                                        <strong>Cc:</strong>
                                                                                        @foreach (var itm in item.AssignCCList)
                                                                                        {
                                                                                            <span>@itm.FirstName ,</span>
                                                                                        }
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                            @if (item.DynamicFormEmailSectionName != null)
                                                                            {
                                                                                <div class="replybox" style="min-height:60px;">
                                                                                    <div style="font-weight: bold;">
                                                                                        Dynamic form @item.DynamicFormEmailSectionName
                                                                                    </div>
                                                                                    <text></text>
                                                                                    <div style=" float: right; font-size: 12px;">@item.ActUserName , @item.ActAddedDate</div>
                                                                                </div>
                                                                            }

                                                                            @if (!string.IsNullOrEmpty(item.BackURL))
                                                                            {
                                                                                string ActivityTypes = item.ActivityType == "FileProfileType" ? "Sunward Libraries" : item.ActivityType == "DynamicForm" ? item.DynamicFormName : "Activity";
                                                                                @if (item.ActivityType != "EmailFileProfileType")
                                                                                {
                                                                                    <div class="replybox" style="min-height:60px;">
                                                                                        <div style="font-weight: bold;">
                                                                                            @ActivityTypes Comment
                                                                                            <div style="float:right; line-height:16px">
                                                                                                @if (item.ActivityType == "FileProfileType")
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>
                                                                                                }
                                                                                                else if (item.ActivityType == "EmailFileProfileType")
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>
                                                                                                }
                                                                                                else if (item.ActivityType == "DynamicForm")
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackDynamicType(item.BackURL))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    <button type="button" @onclick="@(() => onBackActivity(item.BackURL))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                                                        <i class="fa fa-arrow-left"></i> Back
                                                                                                    </button>

                                                                                                }

                                                                                            </div>
                                                                                        </div>
                                                                                        <text>@item.ActCommentName</text>
                                                                                        <div style=" float: right; font-size: 12px;">@item.ActUserName , @item.ActAddedDate</div>
                                                                                    </div>

                                                                                }

                                                                            }
                                                                             <div class="">
                                                                                    @if (item.CopyLinkEmailIds != null)
                                                                                    {
                                                                                        dynamicShowDrawer = "ShowOpenDrawer_" + item.ID;

                                                                                        <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(item))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px; " class="">
                                                                                            <i class="fa fa-envelope"></i> Attached Email
                                                                                        </button>
                                                                                    }
                                                                                </div>
                                                                            <div class="email-body">
                                                                                @if (item.FileData == null)
                                                                                {

                                                                                    <div class="btn-load" @onclick="() => LoadFileDataAsync(item)">
                                                                                        Load Content
                                                                                    </div>


                                                                                }
                                                                                else
                                                                                {

                                                                                    byte[] htmlBinaryData1 = item.FileData;
                                                                                    string htmlContent1 = System.Text.Encoding.UTF8.GetString(htmlBinaryData1);

                                                                                    <div>
                                                                                        @((MarkupString)htmlContent1)
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                            <div class="attachments">
                                                                                <div>
                                                                                    @foreach (var attachment in item.documents)
                                                                                    {
                                                                                        @*  <strong>Attachments:</strong> *@
                                                                                        <div class="tag handline">
                                                                                            <i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName

                                                                                            @if (attachment.FileName.EndsWith(".wav", StringComparison.OrdinalIgnoreCase))
                                                                                            {
                                                                                                <div class="options">
                                                                                                    <div class="play" @onclick="@(() => onPlayAudio(attachment.DocumentID))">
                                                                                                        <i class="fa fa-play" aria-hidden="true"></i>
                                                                                                    </div>
                                                                                                </div>
                                                                                            }
                                                                                            else if (attachment.IsView)
                                                                                            {
                                                                                                <div class="options">
                                                                                                    <div class="download" @onclick="@(() => onDocDownload_old(attachment.DocumentID))">
                                                                                                        <i class="fa fa-cloud-download" aria-hidden="true"></i>
                                                                                                    </div>
                                                                                                    <div class="preview" @onclick="@(() => onDocDownload(attachment.DocumentID))">
                                                                                                        <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                                    </div>
                                                                                                </div>
                                                                                            }
                                                                                        </div>
                                                                                    }
                                                                                </div>

                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            }
                                                            @if (item.ReplyConversation?.Count < item.ReplyConversationCount)
                                                            {
                                                                <div style="text-align:center">
                                                                    <button class="loadmorebg" @onclick="() => LoadMoreRepliesnew(item.ID, item.ReplyConversationCount)">Load More</button>
                                                                </div>
                                                            }                                                           

                                                        </div>
                                                        <div>
                                                            @*  <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto  @((item.IsRead.GetValueOrDefault(false) || item.IsRead == null ? "markasread_border" : "markasunread_border"))" style="margin-right: 10px;">
                                                            <div class="uk-card-header">
                                                                <div class="container-header" style="margin-left: -9px;">
                                                                </div>
                                                            </div> *@

                                   
                                                            @* <div class="uk-card-body">
                                                                @if (item.CopyLinkEmailIds != null)
                                                                {
                                                                    dynamicShowDrawer = "ShowOpenDrawer_" + item.ID;

                                                                    <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(item))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px;margin-top: 10px; " class="">
                                                                        <i class="fa fa-envelope"></i> Attached Email
                                                                    </button>
                                                                }
                                                            </div> *@

                                                            <AudioPlayerModal AudioSource="@audioBase64Source"
                                                            DocumentId="@currentAudioId"
                                                            IsVisible="@isAudioPopupVisible"
                                                            IsVisibleChanged="@(v => isAudioPopupVisible = v)"
                                                            OnClosed="ResetAudioPlayer" />


                                                            @*  @if (true)                
                                                            {
                                                                <div class="uk-card-footer">
                                                                    <div>
                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>
                                                                        <p style="color: #5151b3;" class="handline" @onclick="@(() => ToggleItemVisibility(item.ID,item.ReplyConversationCount))">@item.ReplyConversationCount replies </p>

                                                                        @if (itemVisibility.ContainsKey(item.ID) && itemVisibility[item.ID])
                                                                        {
                                                                            if (replyDiscussions.ContainsKey(item.ID) && replyDiscussions[item.ID].Any())
                                                                            {
                                                                                <div class="accordion1">
                                                                                @foreach (var items in replyDiscussions[item.ID])
                                                                                {
                                                                                    bool isFirst = replyIndex == 0;
                                                                                    replyIndex++;

                                                                                    <div class="lstcoversationrply @((items.IsRead.GetValueOrDefault(false) || items.IsRead == null ? "markasread" : "markasunread"))">


                                                                                            <!-- Replys-->
                                                                                            <div class="accordion-item">
                                                                                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                                                                                    <div class="sender-info">
                                                                                                        <div class="avatar-circle bg-a">A</div>
                                                                                                        <span class="fromtxt"><strong>From:</strong> @items.UserName</span>
                                                                                                    </div>
                                                                                                    <span class="time">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</span>
                                                                                                </div>
                                                                                                <div class="accordion-body @(isFirst ? "active1" : "")">

                                                                                                    <div class="email-details" onclick="toggleDetails(this)">
                                                                                                        Show To/CC
                                                                                                    </div>
                                                                                                    <div class="email-details-content">
                                                                                                        <div>
                                                                                                            <strong>To:</strong>
                                                                                                            @if (items.AssignToList != null && items.AssignToList.Any())
                                                                                                            {
                                                                                                                @foreach (var itms in items.AssignToList)
                                                                                                                {
                                                                                                                    <span>@itms.FirstName ,</span>
                                                                                                                }
                                                                                                            }
                                                                                                            <br>
                                                                                                        </div>
                                                                                                        @if (items.AssignCCList != null && items.AssignCCList.Any())
                                                                                                        {
                                                                                                            <div>
                                                                                                                <strong>Cc:</strong>
                                                                                                                @foreach (var itm in items.AssignCCList)
                                                                                                                {
                                                                                                                    <span>@itm.FirstName ,</span>
                                                                                                                }
                                                                                                            </div>
                                                                                                        }
                                                                                                    </div>

                                                                                                    <div class="email-body">
                                                                                                        @if (items.FileData == null)
                                                                                                        {

                                                                                                            <div class="btn-load" @onclick="() => LoadFileDataAsync(items)">
                                                                                                                Load Content
                                                                                                            </div>


                                                                                                        }
                                                                                                        else
                                                                                                        {

                                                                                                            byte[] htmlBinaryData1 = items.FileData;
                                                                                                            string htmlContent1 = System.Text.Encoding.UTF8.GetString(htmlBinaryData1);

                                                                                                            <div>
                                                                                                                @((MarkupString)htmlContent1)
                                                                                                            </div>
                                                                                                        }
                                                                                                    </div>
                                                                                                    <div class="attachments">
                                                                                                        <div>
                                                                                                            @foreach (var attachment in items.documents)
                                                                                                            {
                                                                                                                <strong>Attachments:</strong>
                                                                                                                <div class="tag handline">
                                                                                                                    <i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName

                                                                                                                    @if (attachment.FileName.EndsWith(".wav", StringComparison.OrdinalIgnoreCase))
                                                                                                                    {
                                                                                                                        <div class="options">
                                                                                                                            <div class="play" @onclick="@(() => onPlayAudio(attachment.DocumentID))">
                                                                                                                                <i class="fa fa-play" aria-hidden="true"></i>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    }
                                                                                                                    else if (attachment.IsView)
                                                                                                                    {
                                                                                                                        <div class="options">
                                                                                                                            <div class="download" @onclick="@(() => onDocDownload_old(attachment.DocumentID))">
                                                                                                                                <i class="fa fa-cloud-download" aria-hidden="true"></i>
                                                                                                                            </div>
                                                                                                                            <div class="preview" @onclick="@(() => onDocDownload(attachment.DocumentID))">
                                                                                                                                <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    }
                                                                                                                </div>
                                                                                                            }
                                                                                                        </div>

                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        <div>
                                                                                            @if (items.CopyLinkEmailIds != null)
                                                                                            {
                                                                                                { dynamicShowDrawer = "ShowOpenDrawer_" + item.ID;}

                                                                                                <button type="button" id="@dynamicShowDrawer" @onclick="@(() => ToggleInfoclick(items))" style="font-size: 13px;border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; margin-right: 10px; padding-right: 10px; padding-left: 10px;margin-top: 10px; " class="">
                                                                                                    <i class="fa fa-envelope"></i> Attached Email
                                                                                                </button>                                                                          
                                                                                            }                                                                                 
                                                                                        </div>   

                                                                                    </div>


                                                                                }
                                                                               </div>
                                                                                @if (hasMore && !isLoading)
                                                                                {
                                                                                    <div style="text-align:center">
                                                                                        <button class="loadmorebg" @onclick="() => LoadMoreReplies(item.ID, item.ReplyConversationCount)">Load More</button>
                                                                                    </div>
                                                                                }
                                                                                else if (isLoading)
                                                                                {
                                                                                    <span>Loading...</span>
                                                                                }
                                                                            }
                                                                        }                                                                       
                                                                    </div>


                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="uk-card-footer">
                                                                    <div>
                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>
                                                                        <p style="color: #5151b3;" class="handline">0 replies </p>
                                                                    </div>
                                                                </div>
                                                            }    *@                                                
                                                        </div>
                                                    }
                                                }
                                            }

                                        </div>



                                        @if (isComponentVisible)
                                        {
                                          @*   @if(isAuthorization)
                                            {
                                                @if(IsConHistory)
                                                {
                                                    <DxButton RenderStyle="ButtonRenderStyle.Success" CssClass="me-1 btn-success open-button"
                                                    Click="onWindowVisible" style="width:200px;">New Subject</DxButton>
                                                }
                                            } *@


                                            <DxWindow @bind-Visible=WindowVisible 
                                            HeaderText="Post"
                                            HorizontalAlignment="HorizontalAlignment.Right"
                                            VerticalAlignment="DevExpress.Blazor.VerticalAlignment.Bottom"
                                            CloseOnEscape="true"                                      
                                            ResizeCompleted="OnWindowResizeCompleted"
                                            DragCompleted="OnWindowDragCompleted"                                          
                                            ShowFooter=false
                                            AllowResize="true"
                                            Closing="EulaClosing"
                                            Width="max(75vw, 250px)"                                                                       
                                            Height="800"
                                            ShowCloseButton="true"                                                
                                            @ref="dxWindow">
                                                <BodyTemplate Context="Context">
                                                    
                                                    <div class="dxwinheight" style="padding: 20px; overflow: auto;">
                                                        <DxFormLayout>
                                                            <div class="open-button-old" style="width:99.5%">                                                      
                                                                @if (isCommand)
                                                                {
                                                                    @if (isCommandTopicClosed)
                                                                    {
                                                                        <div class="boxreplay">
                                                                            <EditForm Model="@Data" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                                                                                
                                                                                <DxFormLayout>
                                                                                    <DxFormLayoutItem Caption="Section:" ColSpanMd="12" Visible="@isDynamicFormEmailSection">                                                                               
                                                                                        <DxComboBox Data="@_DynamicFormEmailSection"
                                                                                        NullText="Select Section Name"
                                                                                        Enabled="@isDynamicFormEmailSection"                                                                                            
                                                                                        TextFieldName="SectionName"
                                                                                        ValueFieldName="EmailFormSectionSessionID"
                                                                                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                        @bind-Value="@Data.EmailFormSectionSessionID"
                                                                                        SelectedItemChanged="@((DynamicFormSection dynamicFormSection) => onSelectedDynFomSectionChanged(dynamicFormSection))">
                                                                                        </DxComboBox>
                                                                                        <ValidationMessage For="@(() => Data.EmailFormSectionSessionID)" />
                                                                                    </DxFormLayoutItem> 
                                                                                    <DxFormLayoutItem Caption="Subject Name" ColSpanMd="12">
                                                                                        <DxTextBox @bind-Text="@Data.Name" ShowValidationIcon="true" spellcheck="true" NullText="Subject Name" Enabled="@IsReadOnly" />
                                                                                        <ValidationMessage For="@(() => Data.Name)" />
                                                                                    </DxFormLayoutItem>
                                                                                    <DxFormLayoutItem Caption="From" ColSpanMd="12">
                                                                                        <DxTextBox @bind-Text="@Data.From" ShowValidationIcon="true" Enabled=false />
                                                                                    </DxFormLayoutItem>

                                                                                    @if (string.IsNullOrEmpty(Data.UserType) || Data.UserType == "Users")
                                                                                    {
                                                                                        @if (isCheckAllowParticipant)
                                                                                        {
                                                                                            <DxFormLayoutItem Caption="Assign To" ColSpanMd="11">
                                                                                                <DxTagBox NullText="Select Assign To..."
                                                                                                Data="@_Toparticipant"
                                                                                                SearchMode="ListSearchMode.AutoSearch"
                                                                                                SearchFilterCondition="ListSearchFilterCondition.Contains"                                                                                                  
                                                                                                Values="@Data.AssigntoIds"
                                                                                                ValuesExpression="@(() => Data.AssigntoIds )"
                                                                                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                                ValueFieldName="UserID"
                                                                                                TextFieldName="Name"
                                                                                                ValuesChanged="@((IEnumerable<long>? values) => onSelectedToItemsChanged(values))"                                                                            
                                                                                                ListRenderMode="ListRenderMode.Virtual"                                                                                                  
                                                                                                CssClass="cw-480">
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.Name)" Caption="Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" Width="100px" />
                                                                                                </DxTagBox>
                                                                                            </DxFormLayoutItem>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <DxFormLayoutItem Caption="Assign To" ColSpanMd="12">
                                                                                                <DxTagBox NullText="Select Assign To..."
                                                                                                Data="@_Toparticipant"
                                                                                                SearchMode="ListSearchMode.AutoSearch"
                                                                                                SearchFilterCondition="ListSearchFilterCondition.Contains"                                                                                                  
                                                                                                Values="@Data.AssigntoIds"
                                                                                                ValuesExpression="@(() => Data.AssigntoIds )"
                                                                                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                                ValueFieldName="UserID"
                                                                                                TextFieldName="Name"
                                                                                                ValuesChanged="@((IEnumerable<long>? values) => onSelectedToItemsChanged(values))"                                                                            
                                                                                                ListRenderMode="ListRenderMode.Virtual" 
                                                                                                CssClass="cw-480">
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.Name)" Caption="Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" Width="100px" />
                                                                                                </DxTagBox>
                                                                                            </DxFormLayoutItem>
                                                                                        }




                                                                                        @if(isCheckAllowParticipant)
                                                                                        {
                                                                                            <DxFormLayoutItem CssClass="gbtn" Caption=" " ColSpanMd="1">
                                                                                                <DxButton IconCssClass="fa fa-users" Id=@($"flyout-overview-target-container-user-group-to-info")
                                                                                                Click="@(_ => OnButtonUserGroupToClick())">
                                                                                                </DxButton>
                                                                                            </DxFormLayoutItem>
                                                                                        }
                                                                                        else
                                                                                        {

                                                                                        }


                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <DxFormLayoutItem Caption="Assign To Group" ColSpanMd="12">
                                                                                            <DxTagBox Data="_ToUserGroup"
                                                                                            @bind-Values="Data.ToUserGroupIds"
                                                                                            FilteringMode="DataGridFilteringMode.Contains"
                                                                                            NullText="Select Assign To Group..."
                                                                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                            ValueFieldName="UserGroupId"
                                                                                            TextFieldName="Name"
                                                                                            SelectedItemsChanged="@((IEnumerable<UserGroup> values) => onSelectedToUserGroupItemsChanged(values))"
                                                                                            ListRenderMode="ListRenderMode.Virtual"
                                                                                            CssClass="cw-480">
                                                                                                <DxListEditorColumn FieldName="@nameof(UserGroup.Name)" Caption="Name" />
                                                                                                <DxListEditorColumn FieldName="@nameof(UserGroup.Description)" Caption="Description" />

                                                                                            </DxTagBox>                                                                                    
                                                                                        </DxFormLayoutItem>
                                                                                    }
                                                                                    @if (string.IsNullOrEmpty(Data.UserType) || Data.UserType == "Users")
                                                                                    {
                                                                                        @if (isCheckAllowParticipant)
                                                                                        {
                                                                                            <DxFormLayoutItem Caption="CC" ColSpanMd="11">
                                                                                                <DxTagBox NullText="Select cc1..."
                                                                                                Data="@_CCparticipant"
                                                                                                SearchMode="ListSearchMode.AutoSearch"
                                                                                                AllowCustomTags="true"
                                                                                                SearchFilterCondition="ListSearchFilterCondition.Contains"                      
                                                                                                Values="@Data.AssignccIds"
                                                                                                ValuesExpression="@(() => Data.AssignccIds )"
                                                                                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                                ValueFieldName="UserID"
                                                                                                TextFieldName="Name"
                                                                                                ValuesChanged="@((IEnumerable<long>? values) => onSelectedCCItemsChanged(values))"                                                                                          
                                                                                                ListRenderMode="ListRenderMode.Virtual"
                                                                                                CssClass="cw-480">
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.Name)" Caption="Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" Width="100px" />
                                                                                                </DxTagBox>
                                                                                            </DxFormLayoutItem>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <DxFormLayoutItem Caption="CC" ColSpanMd="12">
                                                                                                <DxTagBox NullText="Select cc..."
                                                                                                Data="@_CCparticipant"
                                                                                                SearchMode="ListSearchMode.AutoSearch"
                                                                                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                                                                                Values="@Data.AssignccIds"
                                                                                                ValuesExpression="@(() => Data.AssignccIds )"
                                                                                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                                ValueFieldName="UserID"
                                                                                                TextFieldName="Name"
                                                                                                ValuesChanged="@((IEnumerable<long>? values) => onSelectedCCItemsChanged(values))"
                                                                                                ListRenderMode="ListRenderMode.Virtual"
                                                                                                CssClass="cw-480">
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.Name)" Caption="Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" Width="100px" />
                                                                                                </DxTagBox>
                                                                                            </DxFormLayoutItem>
                                                                                        }
                                                                                        @if (isCheckAllowParticipant)
                                                                                        {
                                                                                            <DxFormLayoutItem CssClass="gbtn" Caption=" " ColSpanMd="1">
                                                                                                <DxButton IconCssClass="fa fa-users" Id=@($"flyout-overview-target-container-user-group-cc-info")
                                                                                                Click="@(_ => OnButtonUserGroupCCClick())">
                                                                                                </DxButton>
                                                                                            </DxFormLayoutItem>
                                                                                        }

                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <DxFormLayoutItem Caption="CC Group" ColSpanMd="12">
                                                                                            <DxTagBox NullText="Select Cc Group..."
                                                                                            Data="_CCUserGroup"
                                                                                            @bind-Values="@Data.CCUserGroupIds"
                                                                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                            ListRenderMode="ListRenderMode.Virtual"
                                                                                            ValueFieldName="UserGroupId"
                                                                                            TextFieldName="Name"
                                                                                            SelectedItemsChanged="@((IEnumerable<UserGroup> values) => onSelectedCCUserGroupItemsChanged(values))"
                                                                                            FilteringMode="DataGridFilteringMode.Contains"
                                                                                            CssClass="cw-480">

                                                                                                <DxListEditorColumn FieldName="@nameof(UserGroup.Name)" Caption="Name" />
                                                                                                <DxListEditorColumn FieldName="@nameof(UserGroup.Description)" Caption="Description" />


                                                                                            </DxTagBox>
                                                                                        </DxFormLayoutItem>
                                                                                    }

                                                                                    <DxFormLayoutItem Caption="Attach Email" ColSpanMd="12">
                                                                                        <DxTagBox Data="_CopyLinkList"
                                                                                        SearchMode="ListSearchMode.AutoSearch"
                                                                                        SearchFilterCondition="ListSearchFilterCondition.Contains"
                                                                                        NullText="Select Attach Email"
                                                                                        Values="@Data?.CopyEmailIds"
                                                                                        ValuesExpression="@(() => Data.CopyEmailIds )"
                                                                                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                        ValueFieldName="ConversationSessionID"
                                                                                        TextFieldName="CopyEmailName"
                                                                                        ValuesChanged="@((IEnumerable<Guid>? values) => onEmailCopyChanged(values))"
                                                                                        ListRenderMode="ListRenderMode.Virtual"
                                                                                        CssClass="cw-480">

                                                                                            <DxListEditorColumn FieldName="@nameof(EmailTopics.CopyEmailName)" Caption="Name" />
                                                                                        </DxTagBox>
                                                                                    </DxFormLayoutItem>


                                                                                    @if(newSubjectreply == 1)
                                                                                    {      
                                                                                        <DxFormLayoutItem Caption="Due Date" ColSpanMd="3">                                                                                
                                                                                            <DxDateEdit Date="@Data.DueDate" DateExpression="@(() => Data.DueDate)" DateChanged="@((DateTime? newValue) => OnDateChanged(newValue))" Mask="dd/MMMM/yyyy" />
                                                                                        </DxFormLayoutItem>
                                                                                        <DxFormLayoutItem Caption="" CssClass="topoverdue" ColSpanMd="2">
                                                                                            <DxCheckBox CssClass="w-100"
                                                                                            @bind-Checked="@Data.IsLockDueDate"
                                                                                            Alignment="default"
                                                                                            Enabled ="@LockDueDateEnable"
                                                                                            LabelPosition="LabelPosition.Right">
                                                                                                Lock DueDate
                                                                                            </DxCheckBox>
                                                                                        </DxFormLayoutItem>
                                                                                        <DxFormLayoutItem Caption="" CssClass="topoverdue" ColSpanMd="3">
                                                                                            <DxCheckBox CssClass="w-100"
                                                                                            @bind-Checked="@Data.IsAllowParticipants"
                                                                                            Alignment="default"
                                                                                            LabelPosition="LabelPosition.Right">
                                                                                                Allow Add Participants
                                                                                            </DxCheckBox>
                                                                                        </DxFormLayoutItem>
                                                                                        <DxFormLayoutItem Caption="" CssClass="topoverdue" ColSpanMd="2">
                                                                                            <DxCheckBox CssClass="w-100"
                                                                                            @bind-Checked="@Data.Urgent"
                                                                                            Alignment="default"
                                                                                            LabelPosition="LabelPosition.Right">
                                                                                                Urgent
                                                                                            </DxCheckBox>
                                                                                        </DxFormLayoutItem>
                                                                                        <DxFormLayoutItem Caption="" CssClass="topoverdue" ColSpanMd="2">
                                                                                            <DxCheckBox CssClass="w-100"
                                                                                            @bind-Checked="@Data.NotifyUser"
                                                                                            Alignment="default"
                                                                                            LabelPosition="LabelPosition.Right">
                                                                                                Notify User
                                                                                            </DxCheckBox>
                                                                                        </DxFormLayoutItem>
                                                                                    }
                                                                                    <DxFormLayoutItem ColSpanMd="12">
                                                                                        <div class="">
                                                                                            <DxRichEdit DocumentLoaded="OnDocumentLoaded" CheckSpelling="true" @ref="msgrichEdit" CustomizeToolbar=OnCustomizeToolbar BarMode="BarMode.Toolbar" CssClass="w-100 h-100 txtEditorMsg editor-box-height" Id="editor-box-height" ViewType="ViewType.Simple" />
                                                                                        </div>
                                                                                    </DxFormLayoutItem>
                                                                                    <DxFormLayoutItem ColSpanMd="12">                                                                                      
                                                                                        <button disabled="@loading" class="fa fa-paper-plane sndrot" style="float:right; margin-top:10px;">
                                                                                            @if (loading)
                                                                                            {
                                                                                                <span class="spinner-border spinner-border-sm mr-1"></span>
                                                                                            }                                                                                    
                                                                                        </button>
                                                                                        <div style="display:flex;" class="attmode">
                                                                                            <div id="attachmentSelectButton" class="fa fa-paperclip handline cdspcc" aria-hidden="true"></div>
                                                                                           
                                                                                            <VoiceRecordingPage @ref=RefVoiceRec ></VoiceRecordingPage>


                                                                                            <div class="">
                                                                                                <DxUpload @ref="uploadComponent" Name="files"
                                                                                                Visible="@AttachmentUploadVisible"                                                                                 
                                                                                                AcceptedFileTypes=@AcceptedFileTypes
                                                                                                UploadMode="@UploadMode.OnButtonClick"
                                                                                                FileUploadStart="OnFileUploadStart"
                                                                                                ChunkSize="200000"
                                                                                                AllowMultiFileUpload="true"                                                                                           
                                                                                                ExternalSelectButtonCssSelector="#attachmentSelectButton"
                                                                                                SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                                                                                FileUploaded="@isUploadSuccess"
                                                                                                FileUploadProgressChanged="@OnUploadProgressChanged"
                                                                                                FileUploadStarted="@OnFileUploadStarted"
                                                                                                FileUploadError="@OnUploadError">
                                                                                                </DxUpload>
                                                                                                <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </DxFormLayoutItem>
                                                                                </DxFormLayout>
                                                                            </EditForm>
                                                                        </div>
                                                                    }
                                                                }

                                                              

                                                            </div>
                                                        </DxFormLayout>
                                                    </div>
                                                </BodyTemplate>
                                                <FooterTextTemplate>
                                                    <DxButton SubmitFormOnClick="true" Text="Post" CssClass="" RenderStyle="ButtonRenderStyle.Primary" />
                                                    <DxButton RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@context.CloseCallback" />
                                                    <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@context.CloseCallback" />
                                                </FooterTextTemplate>
                                            </DxWindow>
                                        }                                        
                                    </div>
                                }
                                else if (isMenuvisible == "Files")
                                {      
                                    <EmailAttachment @ref=RefEmailDoc Tid="@Tid" Cid="@Cid" LeftMenu="@isLeftMenuvisible"></EmailAttachment>
                                }
                                else if (isMenuvisible == "Todo")
                                {                           
                                    <UserToDo @ref=RefTopicTodo Tid="@Cid"> </UserToDo>
                                }
                                else if (isMenuvisible == "Tags")
                                {
                                    <TopicTags @ref=RefTopicTagList TopicId="@Tid" loadTagsList="onloadTagsList"></TopicTags>
                                }
                                else if (isMenuvisible == "AddParticipants")
                                {
                                    <ParticipantList @ref=RefTopicAddPList IsValidUser="@IsValidUser" Tid="@Tid" Cid="@Cid"></ParticipantList>
                                }
                                else if(isMenuvisible == "NewEmail")
                                {
                                    <NewEmailPage></NewEmailPage>
                                }
                                else if (isMenuvisible == "AddGroupParticipants")
                                {
                                    <GroupParticipantList @ref=RefTopicAddGroupPList IsValidUser="@IsValidUser" Tid="@Tid" Cid="@Cid"></GroupParticipantList>
                                }
                                else
                                {

                                }
                            </div>

                        </TargetContent>
                    </DxDrawer>

                </div>
            </div>
            <!--Menu Bar Content closed-->


        </div>
    </div>
</div>

<DxFlyout @bind-IsOpen="@isOpenActionTagMultiplePop"                    
PositionTarget=@($"#showActionTagMultiple")
Position="FlyoutPosition.Bottom"
CloseOnOutsideClick="true"
FooterVisible="false">
    <BodyTextTemplate>
        <div style="width:350px;">
            @if (_headTopic_Tag != null && _headTopic_Tag.Any())
            {
                @foreach (var Tagitem in _headTopic_Tag)
                {

                    @if (Tagitem.ActionNames != null && Tagitem.ActionNames.Any())
                    {                   
                        <div class="list-container">
                            @foreach (var items in Tagitem.ActionNames.Skip(2)) // Skip the first two and display the rest
                            {
                                <div class="list-item"> @items</div>
                            }                     
                        </div>
                    }
                }
            }
        </div>
    </BodyTextTemplate>
    <FooterTextTemplate>
        <DxButton Text="close" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxFlyout>
<DxFlyout @bind-IsOpen="@isOpenUserTagMultiplePop"
PositionTarget=@($"#showUserTagMultiple")
Position="FlyoutPosition.Bottom"
CloseOnOutsideClick="true"
FooterVisible="false">
    <BodyTextTemplate>
        <div style="width:350px;">
            @if (_headTopic_UserTag != null && _headTopic_UserTag.Any())
            {
                var userlist = _headTopic_UserTag.Skip(2);
                @foreach (var useritem in userlist)
                {

                    @if (useritem.UserTag != null && useritem.UserTag.Any())
                    {
                        <div class="list-container">


                            <div class="list-item"> @useritem.UserTag</div>

                        </div>
                    }
                }
            }
        </div>
    </BodyTextTemplate>
    <FooterTextTemplate>
        <DxButton Text="close" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxFlyout>
<DxFlyout @bind-IsOpen="@isOpenSubjectPop"                    
PositionTarget=@($"#showOpenSubject_{CurrentEmailConversations?.ID}")
Position="FlyoutPosition.Left"
CloseOnOutsideClick="true"
FooterVisible="false">
    <BodyTextTemplate>
        <DxMenu Orientation="Orientation.Horizontal">
            <Items>               
                <DxMenuItem IconCssClass="fa fa-calendar" Enabled="@IsDueDateUnlocked" @onclick="onSubjectDueDatePop" Text="Due Date" />
                <DxMenuItem IconCssClass="fa fa-ban" @onclick="onCancelDueDatePop" Enabled="@IsDueDateUnlocked" Text="Cancel Due Date" />
                <DxMenuItem IconCssClass="fa fa-text-width" @onclick="@(() => onMarkasAllRead(CurrentEmailConversations.ID))" Text="Mark as all read" />
                <DxMenuItem IconCssClass="fa fa-font" @onclick="onRenameSubjectPop" Text="Rename Subject" />
                <DxMenuItem IconCssClass="fa fa-print" @onclick="onPrintSubjectPop" Text="Print" />
                <DxMenuItem IconCssClass="fa fa-link" @onclick="onCopylink" Text="Copy Link" />
                @if (!string.IsNullOrEmpty(CurrentEmailConversations.BackURL))
                {
                    <DxMenuItem IconCssClass="fa fa-arrow-left" @onclick="onBacklink" Text="Back" /> 
                }

            </Items>
        </DxMenu>
    </BodyTextTemplate>
    <FooterTextTemplate>
        <DxButton Text="close" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxFlyout>

<DxFlyout @bind-IsOpen="@IsOpenFlyout"
PositionTarget="#showFlyout"
Position="FlyoutPosition.Left"
CloseOnOutsideClick="true"
FooterVisible="false">
    <BodyTextTemplate>
        <DxMenu Orientation="Orientation.Horizontal">
            <Items>
                @*<DxMenuItem @onclick="onDueDatePop" Text="Due Date" />
                        <DxMenuItem @onclick="onTopicClosedPop" Text="Close" />*@
                @*<DxMenuItem @onclick="onAddCategoryPop" Text="Tag" />*@
                <DxMenuItem IconCssClass="fa fa-archive" @onclick="onArchivePop" Text="Archive" Enabled="isUserGroup" />
                <DxMenuItem IconCssClass="fa fa-tag" @onclick="onUserTagPop" Text="User Tag"/>
                <DxMenuItem IconCssClass="fa fa-print" @onclick="onPrintMainTopic" Text="Print" />
                <DxMenuItem IconCssClass="fa fa-paperclip" @onclick="onNotifyWendy" Text="Notify PA" />
                @if(_openAccessUserLink != null)
                {
                    <DxMenuItem IconCssClass="fa fa-paperclip" @onclick="onNotifyPA" Text="Notify JD" />
                }
            </Items>
        </DxMenu>               
    </BodyTextTemplate>
    <FooterTextTemplate>       
        <DxButton Text="close" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxFlyout>


<DxPopup @bind-Visible="@isNotifyPAPopupVisible"
HeaderText="Notify JD"
CloseOnOutsideClick="false"
ShowFooter="false"
ShowCloseButton="true">
    <BodyContentTemplate>
        <Notifypa @ref="refNotifypa" applicationUser="@applicationUser" Type ="JD" topicList="@_headTopic[0]" Page ="@isLeftMenuvisible" ClosePopNotify="onCloseNotifyPop"></Notifypa>
    </BodyContentTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isNotifyWendypupVisible"
HeaderText="Notify PA"
CloseOnOutsideClick="false"
ShowFooter="false"
ShowCloseButton="true">
    <BodyContentTemplate>
        <Notifypa @ref="refNotifypa" applicationUser="@applicationUser" Type ="PA" topicList="@_headTopic[0]"  Page ="@isLeftMenuvisible" ClosePopNotify="onCloseNotifyPaPop"></Notifypa>
    </BodyContentTemplate>
</DxPopup>


<DxPopup @ref="popup" HeaderText="CRT" ShowCloseButton="true" Width="100%" Height="100%" @bind-Visible="@PreviewDocPopup">
    <BodyContentTemplate>
        <div class="richeditorHeight">
            <DxRichEdit @ref="@richEdit" DocumentFormat="@MyDocumentFormat" DocumentContent="@documentContent" ViewType="ViewType.Simple" BarMode="BarMode.Toolbar" CssClass="w-100" DocumentContentChanged="OnDocumentContentChanged"></DxRichEdit>
        </div>
        @*  <div id="pdfInterop"></div>*@
        @* <iframe src="@documentPreviewUrl" type="@documentMimeType" width="800" height="600"></iframe>
        <iframe src="https://www.example.com" width="100%" height="500"></iframe>*@
    </BodyContentTemplate>    
</DxPopup>
<DxPopup @bind-Visible="@AddPopupArchive"
ShowFooter="true"
HeaderText="CRT"
Closed="EulaPopupClosed"
Width="300px">
    <BodyContentTemplate>
        <p>Do you want to Archive this Topic</p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton style="align-items" Text="Yes" Click="@((e) => Submit())" RenderStyle="ButtonRenderStyle.Secondary"/>
    </FooterContentTemplate>

</DxPopup>


<DxPopup @ref="popup" HeaderText="Doc Delete" ShowCloseButton="true" Width="300px" @bind-Visible="@DocPopupVisible">
    <div class="text-center">
        <Content>
            <p>
                <div Position="Left" id="@("label"+_documents.FileName)" class="display-field"> Do you want to  Delete this <span style="color:red">@_documents.FileName</span> </div>
            </p>
        </Content>        
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitDocDelete(_documents.DocumentId))"/>
        <DxButton CssClass="dx-button.dx-icon" Text="No" Click="@(() => ClosePopup())" />
    </div>
</DxPopup>

<DxPopup @bind-Visible="@isDueDate" HeaderText="Add Due Date">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataDuDate" OnValidSubmit="@SubmitDueDate" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="DueDate"> DueDate: </label>
                        <DxDateEdit @bind-Date="@_dataDuDate.DueDate"
                        NullText="Select a date..."
                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                        ShowValidationIcon="true"
                        CssClass="cw-320">
                        </DxDateEdit>
                        <ValidationMessage For="@(() => _dataDuDate.DueDate)" />
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>           
        </div>

    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isCancelDueDate"
ShowFooter="true"
HeaderText="CRT"
Closed="EulaPopupClosed"
Width="300px">
    <BodyContentTemplate>
        <p>Do you want to Cancel Due Date this Subject <span class="txthighlite"> @_cancelSubjectName </span> </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitCancelDueDate())" RenderStyle="ButtonRenderStyle.Secondary"/>
    </FooterContentTemplate>

</DxPopup>

<DxPopup @bind-Visible="@isSubjectDueDate" HeaderText="Subject Due Date">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataSubjectDuDate" OnValidSubmit="@SubmitSubjectDueDate" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="DueDate"> Due Date: </label>
                        <DxDateEdit @bind-Date="@_dataSubjectDuDate.DueDate"
                        NullText="Select a date..."
                        MinDate="minDueDate"
                        Mask="dd/MMMM/yyyy"
                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                        ShowValidationIcon="true"
                        CssClass="cw-320">
                        </DxDateEdit>
                        <ValidationMessage For="@(() => _dataSubjectDuDate.DueDate)" />
                        <div style="display: @(IsSubjectNoOfDays ? "block" : "none")">
                            <label for="NoOfDays"> Allowed Days to Extend DueDate: </label>
                            <DxSpinEdit @bind-Value="@_dataSubjectDuDate.NoOfDays" Enabled="@IsSubjectNoOfDays" MinValue="0"></DxSpinEdit>
                        </div>

                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>           
        </div>

    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isUserTagChange" HeaderText="Add/Update UserTag">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@dataUserTag" OnValidSubmit="@SubmitUserTag" class="w-800" Context="EditFormContext">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">  
                        <DxFormLayout>
                            <DxFormLayoutItem Caption="User Tag:" ColSpanMd="12">
                                @*   <DxComboBox Data="@_UserTagList"
                                    AllowUserInput="true"
                                    NullText="Select User Tag..."
                                    ListRenderMode="ListRenderMode.Virtual"                                  
                                    TextFieldName="UserTag"
                                    ValueFieldName="UserTag"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    @bind-Value="@dataUserTag.UserTag"
                                    @bind-Text="@UserTagTxt">
                                </DxComboBox> *@
                                <DxTagBox Data="_UserTagList"
                                @bind-Values="dataUserTag.UserTagIds"

                                NullText="Select User Tag"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                ValueFieldName="ID"
                                TextFieldName="UserTag"
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.AutoSearch"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                CssClass="cw-480">
                                    <DxListEditorColumn FieldName="@nameof(EmailActivityCatgorys.UserTag)" Caption="User Tag" />
                                </DxTagBox>
                                @* <ValidationMessage For="@(() => dataUserTag.UserTag)" /> *@
                            </DxFormLayoutItem>
                        </DxFormLayout>
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>
        </div>

    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isRenameSubject" HeaderText="Rename Subject">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataSubjectName" OnValidSubmit="@SubmitSubjectName" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="DueDate"> Subject Name: </label>
                        <DxTextBox @bind-Text="@_dataSubjectName.SubjectName" ShowValidationIcon="true" NullText="Subject Name" />
                        <ValidationMessage For="@(() => _dataSubjectName.SubjectName)" />
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>
        </div>

    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isTopicClosed" HeaderText="Topic Close">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataTopicClose" OnValidSubmit="@SubmitTopicClose" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="Remarks"> Remarks: </label>
                        <DxMemo @bind-Text="@_dataTopicClose.Remarks"
                        CssClass="cw-480"
                        Rows="5" />
                        <ValidationMessage For="@(() => _dataTopicClose.Remarks)" />
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>

            @* <label>Remarks</label>
            <DxMemo @bind-Text="ClosedMsg"
                    CssClass="cw-480"
                    Rows="5"/>
            <br />
            <DxButton RenderStyleMode="@ButtonRenderStyleMode.Outline"
                      Text="Submit" style="width: 100px !important; float: right;"
                      CssClass="w-100" />*@
        </div>
    </BodyTemplate>
</DxPopup>


<DxPopup @bind-Visible="@isTopicCategoryClosed" HeaderText="Tag" AllowResize="true">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">
            @* <TopicTags TopicId="@Tid" loadTagsList="onloadTagsList"></TopicTags>*@
        </div>
    </BodyTemplate>
</DxPopup>
<DxPopup @bind-Visible="@isArchiveClosed"
ShowFooter="true"
HeaderText="CRT"
Closed="EulaPopupClosed"
Width="300px">
    <BodyContentTemplate>
        <p>Do you want to Archive this Topic</p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitIsArchived())" RenderStyle="ButtonRenderStyle.Secondary"/>
    </FooterContentTemplate>

</DxPopup>


<DxPopup @bind-Visible="@isAssignToVisible" HeaderText="Assigned To">
    <BodyTemplate Context="PopupContext">      
        <DxGrid @ref="Grid" Data="_conversationAssignTo"
        KeyFieldName="ID"
        ShowSearchBox="true"
        PagerNavigationMode="PagerNavigationMode.InputBox"
        PageSizeSelectorVisible="true"
        PageSizeSelectorAllRowsItemVisible="true"
        PageSizeSelectorItems="@(new int[] { 5,10,20 })"
        PageSize="20"
        style="height:calc(100vh - 285px);min-height:400px !important"
        CssClass="ch-360">
            <Columns>                          
                <DxGridDataColumn FieldName="RowIndex" Width="35" Caption="#" />
                <DxGridDataColumn FieldName="FirstName" MinWidth="100" />
                <DxGridDataColumn FieldName="LastName" />
            </Columns>
        </DxGrid>

    </BodyTemplate>
</DxPopup>


<DxPopup @bind-Visible="@DueDateMessageVisible" ShowFooter="true" HeaderText="@DueDateMessageHeader">
    <BodyContentTemplate Context="PopupContext">
        <div class="@((DueDateMessageHeader == "Error" ? "TxtRed" : "TxtGreen"))" style="text-align:center; padding: 10px; font-size: 15px;">
            <span class="@((DueDateMessageHeader == "Warning Info" ? "TxtRed" :""))"> @DueDateMessageBody</span>
        </div>
        <DxFormLayout>
            <DxFormLayoutItem Caption="Reason :" ColSpanMd="12">
                <DxMemo @bind-Text="@DuedateReason"></DxMemo>
            </DxFormLayoutItem>
        </DxFormLayout>

    </BodyContentTemplate>
    <FooterContentTemplate>
        <span>@Application.Common.Helper.Helper.FormatDate(_dataSubjectDuDate.DueDate)</span>
        <DxButton CssClass="popup-button my-1 ms-2" RenderStyle="ButtonRenderStyle.Primary" Text="Sent Request" Click="@(() => onSentDueDateRequest())" />        
    </FooterContentTemplate>
</DxPopup>

<DxPopup @bind-Visible="@MessageVisible" HeaderText="@MessageHeader">
    <BodyTemplate Context="PopupContext">
        <div class="@((MessageHeader == "Error" ? "TxtRed" : "TxtGreen"))" style="text-align:center; padding: 10px; font-size: 15px;">
            <span class="@((MessageHeader == "Warning Info" ? "TxtRed" :""))"> @MessageBody</span>
        </div>
    </BodyTemplate>
</DxPopup>


<style>
    .dxuc-upload-icon {
    display: none; /* or any other style to disable or hide the icon */
    }
</style>

<DxFlyout @bind-IsOpen=IsDescriptionOpen
PositionTarget=@($"#flyout-overview-target-container-ProfileType-{_selectedDescriptionItems?.DocumentId}")
RestrictionTarget="#Navigation-Flyout-Customization"
AnimationType="FlyoutAnimationType.Fade"
PreventCloseOnPositionTargetClick="true"
HeaderVisible="true"
HeaderText="Link to DMS"
FooterVisible="true"
CloseOnOutsideClick="false"
FooterCssClass="custom-flyout-footer"
Width="max(25vw, 550px)"
Position=@(FlyoutPosition.BottomStart | FlyoutPosition.TopStart)>
    <BodyContentTemplate Context="PopupContext">       
        <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit_FileProfileType">
            <DxFormLayout CssClass="w-100">
                <DataAnnotationsValidator />
                <DxFormLayoutItem Caption="" ColSpanMd="12">                    
                    <DxRadioGroup Items="@FileLinkOptions"
                    Value="@_dataFileProfileType.Type"
                    ValueExpression="@(() => _dataFileProfileType.Type )"
                    ValueChanged="@((string value) => OnFileLinkTypeChanged(value))"
                    Layout="RadioGroupLayout.Horizontal"
                    CssClass="dx-demo-radio-group" />
                </DxFormLayoutItem>

                @if (_dataFileProfileType.Type == "Link to DMS")
                {                
                    <DxFormLayoutItem Caption="FileProfile Type" ColSpanMd="12">                        
                        <DxTextBox NullText="Select FileProfile Type" @bind-Text="@LinkFilterFileprofiletypeName" CssClass="cw-480">
                            <Buttons>
                                <DxEditorButton IconCssClass="fa fa-add" Id=@($"flyout-overview-target-container-IsFilterFileProfileTypeDocumentOpen")
                                Tooltip="Select File ProfileType"
                                Click="@(_ => OnButtonFileProfileTypeLinDocClick())" />
                            </Buttons>
                        </DxTextBox>
                        <DxSpinEdit @bind-Value="@_dataFileProfileType.FileProfileTypeId" BindValueMode="BindValueMode.OnInput" style="display:none;" />
                        <ValidationMessage For="@(() => _dataFileProfileType.FileProfileTypeId)" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem Caption="Company" ColSpanMd="12">
                        <DxComboBox Data="@_plantItems"
                        NullText="Select Company..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="PlantCode"
                        ValueFieldName="PlantID"
                        SelectedItemChanged="@((ViewPlants plantSelect) => SelectedItemChanged(plantSelect?.PlantID))"
                        Enabled="isPlant"
                        @bind-Value="@_dataFileProfileType.PlantId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                Caption="Plant Code"
                                Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.PlantId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Division" ColSpanMd="12">
                        <DxComboBox Data="@_divisionItems"
                        NullText="Select Division..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="Name"
                        ValueFieldName="DivisionID"
                        Enabled="isDivision"
                        SelectedItemChanged="@((ViewDivision plantSelect) => SelectedItemDivisionChanged(plantSelect?.DivisionID))"
                        @bind-Value="@_dataFileProfileType.DivisionId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewDivision.Name)"
                                Caption="Name"
                                Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewDivision.Code)"
                                Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewDivision.Description)"
                                Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.DivisionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Department" ColSpanMd="12">
                        <DxComboBox Data="@_departmentItems"
                        NullText="Select Department..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="DepartmentName"
                        ValueFieldName="DepartmentId"
                        Enabled="isDepartment"
                        SelectedItemChanged="@((ViewDepartment plantSelect) => SelectedItemDepartementChanged(plantSelect?.DepartmentId))"
                        @bind-Value="@_dataFileProfileType.DepartmentId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentName)"
                                Caption="Name"
                                Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentCode)"
                                Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewDepartment.Description)"
                                Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.DepartmentId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Section" ColSpanMd="12">
                        <DxComboBox Data="@_sectionItems"
                        NullText="Select Section..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="SectionName"
                        ValueFieldName="SectionId"
                        Enabled="isSection"
                        SelectedItemChanged="@((ViewSection plantSelect) => SelectedItemSectionChanged(plantSelect?.SectionId))"
                        @bind-Value="@_dataFileProfileType.SectionId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewSection.SectionName)"
                                Caption="Name"
                                Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewSection.SectionCode)"
                                Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewSection.Description)"
                                Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.SectionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="SubSection" ColSpanMd="12">
                        <DxComboBox Data="@_subSectionItems"
                        NullText="Select SubSection..."
                        ListRenderMode="ListRenderMode.Virtual"
                        FilteringMode="DataGridFilteringMode.Contains"
                        TextFieldName="SubSectionName"
                        ValueFieldName="SubSectionId"
                        Enabled="isSubSection"
                        @bind-Value="@_dataFileProfileType.SubSectionId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionName)"
                                Caption="Name"
                                Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionCode)"
                                Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewSubSection.Description)"
                                Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.SubSectionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Expiry Date:" ColSpanMd="12" Visible="@isExpiryDate">
                        <DxDateEdit NullText="Select a Expiry Date..." MinDate="DateTime.Now" @bind-Date="@_dataFileProfileType.ExpiryDate" CssClass="cw-320" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description" ColSpanMd="12">
                        <DxMemo @bind-Text="@_dataFileProfileType.Description" Rows="5" ShowValidationIcon="true" />
                    </DxFormLayoutItem>


                }
                else 
                {
                    <DxFormLayoutItem Caption="File Replace (Check-In)" ColSpanMd="12">
                        <DxComboBox Data="@_OnFileReplaceList"
                        NullText="Select File Replace (Check-In)..."
                        FilteringMode="DataGridFilteringMode.Contains"
                        ListRenderMode="ListRenderMode.Virtual"
                        TextFieldName="FileName"
                        ValueFieldName="ReplaceDocumentId"
                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                        SelectedItemChanged="@((Documents documents) => onSelectedFileReplaceChanged(documents))"
                        @bind-Value="@_dataFileProfileType.ReplaceDocumentId" ShowValidationIcon="true">
                            <Columns>       
                                <DxListEditorColumn FieldName="@nameof(Documents.SubjectName)" Caption="Subject Name"/>
                                <DxListEditorColumn FieldName="@nameof(Documents.FileName)" Caption="FileName"/>
                                @*<DxListEditorColumn FieldName="@nameof(Documents.AddedBy)" Caption="AddedBy"/>  *@                                  
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.ReplaceDocumentId)" />
                    </DxFormLayoutItem>

                }



            </DxFormLayout>
        </EditForm>


    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsDescriptionOpen = false) />
        <DxButton RenderStyle="ButtonRenderStyle.Success" Text="Update" Click=@(()=> OnSubmitFileLinked()) />
    </FooterContentTemplate>
</DxFlyout>


<DxFlyout @bind-IsOpen=IsFileProfileTypeFilterDocOpen
PositionTarget=@($"#flyout-overview-target-container-IsFilterFileProfileTypeDocumentOpen")
RestrictionTarget="#Navigation-Flyout-Customization"
AnimationType="FlyoutAnimationType.Fade"
HeaderVisible="true"
HeaderText="Select FileProfile Type"
FooterVisible="true"
FooterCssClass="custom-flyout-footer"
Width="max(25vw, 550px)"
CloseOnOutsideClick="false"
PreventCloseOnPositionTargetClick="true">
    <BodyContentTemplate Context="PopupContext">
        <DxFormLayout CssClass="w-100" style="height: calc(100vh - 250px);overflow:auto;overflow-x:hidden;">
            <DxFormLayoutItem Caption="">
                <DxTreeView @ref="_treeFilterDocView"
                @bind-FilterString="FilterDocumentString"
                ShowFilterPanel="true"
                FilterMode="NavigationFilterMode.EntireBranch"
                AllowSelectNodes="true"
                SelectionChanged="@FileProfileTypeSelectionChanged"
                Data="@_selectedTreeItems"
                LoadChildNodesOnDemand="true">
                    <DataMappings>
                        <DxTreeViewDataMapping Text="FileName"
                        HasChildren="HasChildren"
                        Children="Children" />
                    </DataMappings>
                </DxTreeView>
            </DxFormLayoutItem>

        </DxFormLayout>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">
                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsFileProfileTypeFilterDocOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>


<DxFlyout @bind-IsOpen=IsUserGroupToOpen
PositionTarget=@($"#flyout-overview-target-container-user-group-to-info")
RestrictionTarget="#Navigation-Flyout-Customization-To"
AnimationType="FlyoutAnimationType.Fade"
PreventCloseOnPositionTargetClick="true"
FooterVisible="true"
FooterCssClass="custom-flyout-footer"
Width="max(25vw, 550px)"
CloseOnOutsideClick=false
Position=@(FlyoutPosition.BottomStart | FlyoutPosition.TopStart)>
    <BodyContentTemplate Context="PopupContext">
        <div class="custom-flyout-body" style="width:100%">
            <DxFormLayout>
                <DxFormLayoutItem Caption="To Group" ColSpanMd="12">
                    <DxTagBox Data="_ToUserGroup"
                    @bind-Values="Data.ToUserGroupIds"
                    FilteringMode="DataGridFilteringMode.Contains"
                    NullText="Select To Group..."
                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                    ValueFieldName="UserGroupId"
                    TextFieldName="Name"
                    SelectedItemsChanged="@((IEnumerable<UserGroup> values) => onSelectedToUserGroupItems_New_Changed(values))"
                    ListRenderMode="ListRenderMode.Virtual"
                    CssClass="cw-480">
                        <DxListEditorColumn FieldName="@nameof(UserGroup.Name)" Caption="Name" />
                        <DxListEditorColumn FieldName="@nameof(UserGroup.Description)" Caption="Description" />

                    </DxTagBox>
                </DxFormLayoutItem>
            </DxFormLayout>

        </div>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">

                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsUserGroupToOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>

<DxFlyout @bind-IsOpen=IsUserGroupCCOpen
PositionTarget=@($"#flyout-overview-target-container-user-group-cc-info")
RestrictionTarget="#Navigation-Flyout-Customization-CC"
AnimationType="FlyoutAnimationType.Fade"
PreventCloseOnPositionTargetClick="true"
FooterVisible="true"
FooterCssClass="custom-flyout-footer"
Width="max(25vw, 550px)"
CloseOnOutsideClick=false
Position=@(FlyoutPosition.BottomStart | FlyoutPosition.TopStart)>
    <BodyContentTemplate Context="PopupContext">
        <div class="custom-flyout-body" style="width:100%">
            <DxFormLayout>
                <DxFormLayoutItem Caption="CC Group" ColSpanMd="12">
                    <DxTagBox Data="_CCUserGroup"
                    @bind-Values="@Data.CCUserGroupIds"
                    FilteringMode="DataGridFilteringMode.Contains"
                    NullText="Select To Group..."
                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                    ValueFieldName="UserGroupId"
                    TextFieldName="Name"
                    SelectedItemsChanged="@((IEnumerable<UserGroup> values) => onSelectedCCUserGroupItems_New_Changed(values))"
                    ListRenderMode="ListRenderMode.Virtual"
                    CssClass="cw-480">
                        <DxListEditorColumn FieldName="@nameof(UserGroup.Name)" Caption="Name" />
                        <DxListEditorColumn FieldName="@nameof(UserGroup.Description)" Caption="Description" />

                    </DxTagBox>
                </DxFormLayoutItem>
            </DxFormLayout>

        </div>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">

                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsUserGroupCCOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>


@code {
    string DrawerView = "Email";
    string DrawerTitle = "Attached Email";
    Dictionary<int, int> replyCounts = new();
    private Dictionary<int, List<EmailConversations>> replyDiscussions = new();

    private int currentPage = 1;
    private bool hasMore = true; 

    Dictionary<int, int> currentPages = new(); 
    int replypageSize = 5;

    bool isLoading = false;

    private VoiceRecordingPage? RefVoiceRec { get; set; }
    internal List<EmailTopics>? _CopyLinkList;
    bool IsInfoOpen { get; set; } = false;
    bool IsMainSubject {get;set;} = false;
    void ToggleInfo()
    {
        IsInfoOpen = !IsInfoOpen;
    }

    private void ToggleInfoclick(EmailConversations emailConversations) 
    {        
        ecID = emailConversations.ID;
        IsInfoOpen = true;
        
         DrawerView = "AttachedEmail";
         DrawerTitle = "Attached Email";
    }
    private void ToggleMainSubject(EmailConversations emailConversations) 
    {        
        ecID = emailConversations.ID;
         IsInfoOpen = true;

         DrawerView = "MainSubject";
         DrawerTitle = "Main Subject";
    }

    private void onToggleMainInfo(long id)
    {
        ecID = id;
        IsInfoOpen = false;
        IsInfoOpen = true;
        
         DrawerView = "AttachedEmail";
         DrawerTitle = "Attached Email";
        StateHasChanged();
    }
    private void CloseInfo()
    {
        IsInfoOpen = false;
        StateHasChanged();
    }
    Dictionary<string, object> GetCloseInfoButtonAttributes()
    {
        return new Dictionary<string, object> {
            { A11yAriaAttributeUtils.AriaLabel, "Close Info Drawer" }
        };
    }





    private DemoCodePage? Drawer;

    private void OpenDrawer()
    {
        Drawer?.OpenDrawer();
    }

    private void OnDrawerClose(bool isOpen)
    {
        Console.WriteLine($"Drawer closed: {isOpen}");
    }


    bool IsContentVisible = false;
    private bool isAuthorization { get; set; } = true;
    private bool isNotifyPAPopupVisible = false;
    private bool isNotifyWendypupVisible = false;
    private Notifypa refNotifypa;
    long reply_id = 0;
    int reply_tcount = 0;
    string UserTagTxt { get; set; }    
    private PersistingComponentStateSubscription? subscription;
    private string elapsedTime;
    private int pageNumber = 1; // Initial page number
    private int pageSize = 15; // Number of records per page
    private int submitCount = 0;
    bool IsUserGroupToOpen { get; set; } = false;
    bool IsUserGroupCCOpen { get; set; } = false;   


    private int totalReplyCount = 0;
    public List<EmailConversations> ReplyList { get; set; } = new();

    private void onCloseNotifyPop()
    {
        isNotifyPAPopupVisible  = false;
        IsOpenFlyout = false;
        InvokeAsync(StateHasChanged);
    }
    private void onCloseNotifyPaPop()
    {
        isNotifyWendypupVisible = false;
        IsOpenFlyout = false;
        InvokeAsync(StateHasChanged);
    }
    async Task OnButtonUserGroupToClick()
    {
        IsUserGroupToOpen = false;
        await JSRuntime.InvokeAsync<string>("showLoading");

        var toids = Data.AssigntoIds.Select(id => (long?)id).ToList() ?? new List<long?>();
        var ids = Data.AssignccIds.Select(id => (long?)id).ToList() ?? new List<long?>();
        ids.Add(applicationUser.UserID);
        ids.AddRange(toids);
        //_participantUserGroup = await Mediator.Send(new GetAllUserGroups());
        _participantUserGroup = await Mediator.Send(new GetUserByFilterUserGroups(ids));
        _ToUserGroup = _participantUserGroup;
        //_CCUserGroup = _participantUserGroup;

        Data.ToUserGroupIds = null;
        //Data.CCUserGroupIds = null;

        await JSRuntime.InvokeAsync<string>("hideLoading");

        IsUserGroupToOpen = true;
        StateHasChanged();
    }
    void onEmailCopyChanged(IEnumerable<Guid>? values)
    {

        if (values != null)
        {
            Data.CopyEmailIds = values;

        }
        else
        {
            // Reset _CCparticipant to all participants if nothing is selected in _Toparticipant

            Data.CopyEmailIds = null;
        }

        StateHasChanged();
    }
    async Task OnButtonUserGroupCCClick()
    {       
        IsUserGroupCCOpen = false;
        var toids = Data.AssigntoIds.Select(id => (long?)id).ToList() ?? new List<long?>();
        var ids = Data.AssignccIds.Select(id => (long?)id).ToList() ?? new List<long?>();
        ids.Add(applicationUser.UserID);
        ids.AddRange(toids);

        //var userIds = await Mediator.Send(new GetUserByFilterUserGroups(ids));


        await JSRuntime.InvokeAsync<string>("showLoading");

        //_participantUserGroup = await Mediator.Send(new GetAllUserGroups());
        _participantUserGroup = await Mediator.Send(new GetUserByFilterUserGroups(ids));
        //_ToUserGroup = _participantUserGroup;
        _CCUserGroup = _participantUserGroup;

        //Data.ToUserGroupIds = null;
        Data.CCUserGroupIds = null;  

        await JSRuntime.InvokeAsync<string>("hideLoading");

        IsUserGroupCCOpen = true;
        StateHasChanged();
    }

    async Task HandleValidUserGroupTo()
    {
    }

    void onSelectedToUserGroupItems_New_Changed(IEnumerable<UserGroup> values)
    {
        if (values != null)
        {
            //var userIds = await Mediator.Send(new GetGroupByUserids(1));
            onToChange_Change(values);

            //_CCUserGroup = _participantUserGroup.Except(values).ToList();
        }
        else
        {

            //_CCUserGroup = _participantUserGroup.ToList();
        }

        IsUserGroupToOpen = false;

        StateHasChanged();
    }
    void onSelectedCCUserGroupItems_New_Changed(IEnumerable<UserGroup> values)
    {
        if (values != null)
        {
            //var userIds = await Mediator.Send(new GetGroupByUserids(1));
            onCCChange_Change(values);

            //_CCUserGroup = _participantUserGroup.Except(values).ToList();
        }
        else
        {

            // _CCUserGroup = _participantUserGroup.ToList();
        }

        IsUserGroupCCOpen = false;

        StateHasChanged();
    }
    async Task onToChange_Change(IEnumerable<UserGroup> values)
    {
        var groupid = values.Select(x=>x.UserGroupId).LastOrDefault();
        var userIds = await Mediator.Send(new GetGroupByUserids(groupid));
        // var userIdsList = userIds.Select(s=>s.UserID.Value).ToList();

        var userIdsListss = userIds.Where(s => s.UserID.HasValue).Select(s => s.UserID.Value).ToList();
        var userIdsList = userIdsListss.Where(id => id != applicationUser.UserID).ToList();
        if (Data.AssigntoIds == null & Data.AssignccIds == null)
        {
            Data.AssigntoIds = userIdsList;

            if (_allparticipants != null && userIds != null)
            {                
                var emplst = _allparticipants.Where(employee => userIdsList.Contains(employee.UserID.Value)).ToList();
                var toItems = emplst.Select(employee => employee.UserID.Value).ToList();
                onSelectedToItemsChanged(toItems);
            }
            // _CCparticipant = _participant.Except(userIds, new ViewEmployeeComparer()).ToList();

        }
        else
        {
            IEnumerable<long> v1 = new List<long>();
            if (Data.AssignccIds == null)
            {
                v1 = Data.AssigntoIds.Concat(userIdsList).Distinct();
            }
            else if(Data.AssigntoIds == null)
            {            
                var T1 = Data.AssignccIds.Concat(userIdsList).Distinct();
                v1 = T1.Except(Data.AssignccIds);
            }
            else
            {
                var L1 = Data.AssignccIds.Concat(Data.AssigntoIds);
                var L2 = L1.Concat(userIdsList).Distinct();
                v1 = L2.Except(Data.AssignccIds).Distinct();
            }

            var combinedIds = v1;
            Data.AssigntoIds = combinedIds;            

            if (_allparticipants != null && combinedIds != null)
            {
                var emplst1 =  _allparticipants.Where(employee => combinedIds.Contains(employee.UserID.Value)).ToList();
                var toItems = emplst1.Select(employee => employee.UserID.Value).ToList();
                onSelectedToItemsChanged(toItems);
            }
        }


        StateHasChanged();
    }

    async Task onCCChange_Change(IEnumerable<UserGroup> values)
    {
        var groupid = values.Select(x => x.UserGroupId).LastOrDefault();
        var userIds = await Mediator.Send(new GetGroupByUserids(groupid));


        var userIdsListss = userIds.Where(s => s.UserID.HasValue).Select(s => s.UserID.Value).ToList();
        var userIdsList = userIdsListss.Where(id => id != applicationUser.UserID).ToList();

        if (Data.AssignccIds == null && Data.AssigntoIds == null)
        {
            Data.AssignccIds = userIdsList;

            if (_allparticipants != null && userIds != null)
            {
                var emplst = _allparticipants.Where(employee => userIdsList.Contains(employee.UserID.Value)).ToList();
                var toItems = emplst.Select(employee => employee.UserID.Value).ToList();
                onSelectedCCItemsChanged(toItems);
            }

        }
        else
        {
            IEnumerable<long> v1 = new List<long>();
            if (Data.AssignccIds == null)
            {
                var T1 = Data.AssigntoIds.Concat(userIdsList).Distinct();
                v1 = T1.Except(Data.AssigntoIds);
            }
            else if (Data.AssigntoIds == null)
            {
                v1 = Data.AssignccIds.Concat(userIdsList).Distinct();
            }
            else
            {
                var L1 = Data.AssignccIds.Concat(Data.AssigntoIds);
                var L2 = L1.Concat(userIdsList).Distinct();
                v1 = L2.Except(Data.AssigntoIds).Distinct();
            }

            var combinedIds = v1;
            Data.AssignccIds = combinedIds;
            if (_allparticipants != null && combinedIds != null)
            {
                var emplst1 = _allparticipants.Where(employee => combinedIds.Contains(employee.UserID.Value)).ToList();
                var toItems = emplst1.Select(employee => employee.UserID.Value).ToList();
                onSelectedCCItemsChanged(toItems);
            }
        }

        StateHasChanged();
    }


    private OpenAccessUserLink? _openAccessUserLink { get; set; }
    private List<ViewPlants>? _plantItems;
    private List<ViewDivision>? _divisionItems;
    private List<ViewDepartment>? _departmentItems;
    private List<ViewSection>? _sectionItems;
    private List<ViewSubSection>? _subSectionItems;
    bool isPlant { get; set; } = false;
    bool isDivision { get; set; } = false; bool isDepartment { get; set; } = false;
    bool isSection { get; set; } = false; bool isSubSection { get; set; } = false;
    bool isExpiryDate { get; set; } = false;
    public DocumentProfileNoSeriesModel? documentProfileNoSeriesData { get; set; }
    string ExtensionsList = "";
    string SeletedExtensions = "";
    string IsUploadExt = ".isUploadCheckOut";


    string SelectedRadioGroupString { get; set; } = "Link to DMS";
    IEnumerable<string> FileLinkOptions = new[] { "Link to DMS", "File Replace(Check-In)" };
    private List<Documents>? _OnFileReplaceList;
    private DocumentsModel? _selectedDocumentItems;

    string? LinkFilterFileprofiletypeName { get; set; } = null;
    public bool IsFileProfileTypeFilterDocOpen { get; set; }
    EditContext? _editContext;
    private DxTreeView? _treeFilterDocView;
    string? FilterDocumentString { get; set; }
    private Guid? _activityEmailSessionId { get; set; }
    public List<DocumentsModel>? fileProfileTypeDocumentsAll { get; set; }
    IEnumerable<DocumentsModel> _selectedTreeItems = new List<DocumentsModel>();



    void OnButtonFileProfileTypeLinDocClick()
    {
        IsFileProfileTypeFilterDocOpen = true;
    }

    async Task HandleValidSubmit_FileProfileType()
    {  
        if(_dataFileProfileType.Type == "Link to DMS")
        {
            var UpdateReq = new CreateEmailDocFileProfileType
            {
                FilterProfileTypeId = _dataFileProfileType.FileProfileTypeId,
                DocumentId = _selectedDescriptionItems.DocumentId,
                AddedByUserId = applicationUser.UserID,
                SessionId = Guid.NewGuid(),
                AddedDate = DateTime.Now,
                UploadDate = DateTime.Now
            };
            _activityEmailSessionId = UpdateReq.SessionId;
            var result = await Mediator.Send(UpdateReq);
            if (result > 0)
            {
                var filesessionIds = _activityEmailSessionId;
                _dataFileProfileType.SessionId = filesessionIds;
                _dataFileProfileType.FileSessionId = filesessionIds;
                _dataFileProfileType.SourceFrom = "FileProfile";


                DocumentsUploadModel Datas = new DocumentsUploadModel();

                Datas.DocumentId = result;
                Datas.SessionId = _dataFileProfileType.SessionId;
                Datas.FileSessionId = _dataFileProfileType.FileSessionId;
                Datas.SourceFrom = _dataFileProfileType.SourceFrom;
                Datas.FilePath = _dataFileProfileType.FilePath;
                Datas.Description = _dataFileProfileType.Description;
                Datas.FileProfileTypeId = _dataFileProfileType.FileProfileTypeId;
                Datas.PlantId = _dataFileProfileType.PlantId;
                Datas.DepartmentId = _dataFileProfileType.DepartmentId;
                Datas.SectionId = _dataFileProfileType.SectionId;
                Datas.SubSectionId = _dataFileProfileType.SubSectionId;
                Datas.DivisionId = _dataFileProfileType.DivisionId;
                Datas.ProfileNo = _dataFileProfileType.ProfileNo;             
                Datas.ChangeNewFileName = "New File Empty";
                Datas.UserId = applicationUser.UserID;   
                Datas.ProfileId  = _dataFileProfileType.ProfileId;
                Datas.ExpiryDate = _dataFileProfileType.ExpiryDate;

                var response = await Mediator.Send(new UpdateEmailDocumentBySession(Datas));

                await createActivityTag(LinkFilterFileprofiletypeName);
                onShowPopupMessage("success", "Updated File Profile DMS Successfully");
            }

        }
        else
        {
            ExtensionsList = "";
            CheckExtension();           

            if(IsValidFileExtension(ExtensionsList, SeletedExtensions))
            {
                var doclst = await Mediator.Send(new GetByIdDocument(_dataFileProfileType.ReplaceDocumentId));

                if (doclst.IsLocked.GetValueOrDefault(false))
                {
                    toastService.ShowToast("Selected File has been Locked", AC.SD.Core.Services.ToastLevel.Error);
                    return;

                }
                else
                {

                    _selectedDocumentItems = new DocumentsModel();
                    _selectedDocumentItems.DocumentID = doclst.DocumentId;
                    _selectedDocumentItems.DocumentParentId = doclst.DocumentParentId;
                    _selectedDescriptionItems.DocumentParentId = doclst.DocumentParentId;
                    _selectedDocumentItems.FilterProfileTypeId = doclst.FilterProfileTypeId;
                    _selectedDocumentItems.SessionID = doclst.SessionId;
                    _selectedDocumentItems.ProfileNo = doclst.ProfileNo;
                    _selectedDocumentItems.Description = doclst.FileName;
                    _selectedDocumentItems.FileName = doclst.FileName;

                    if (_selectedDocumentItems != null && _selectedDocumentItems.DocumentID > 0)
                    {

                        var res = await Mediator.Send(new GetFileProfileTypeCheckOut(_selectedDocumentItems));

                        var creReq = new CreateEmailDocFileProfileType
                            {
                                FilterProfileTypeId = doclst.FilterProfileTypeId,
                                DocumentId = _selectedDescriptionItems.DocumentId,
                                AddedByUserId = applicationUser.UserID,
                                SessionId = Guid.NewGuid(),
                                AddedDate = DateTime.Now,
                                UploadDate = DateTime.Now
                            };
                        _activityEmailSessionId = _selectedDocumentItems.SessionID;
                        var result = await Mediator.Send(creReq);

                        DocumentsUploadModel Data = new DocumentsUploadModel();

                        //var finaldoclst = await Mediator.Send(new GetByIdDocument(result));


                        Data.IsCheckOut = true;
                        Data.DocumentId = result;
                        Data.DocumentParentId = _selectedDocumentItems.DocumentID;
                        Data.DocumentMainParentId = _selectedDocumentItems.DocumentParentId;
                        Data.UserSession = applicationUser.SessionId;
                        Data.UserId = applicationUser.UserID;
                        Data.ProfileId = _selectedDocumentItems.ProfileID;
                        Data.SessionId = _selectedDocumentItems.SessionID;
                        Data.ProfileNo = _selectedDocumentItems.ProfileNo;
                        Data.FileProfileTypeId = _selectedDocumentItems.FileProfileTypeId > 0 ? _selectedDocumentItems.FileProfileTypeId : _selectedDocumentItems.FilterProfileTypeId;
                        Data.UserId = applicationUser.UserID;
                        // Data.FilePath = finaldoclst.FilePath;
                        // Data.FileSessionId = finaldoclst.SessionId;

                        var responsess = await Mediator.Send(new UpdateEmailDocumentBySession(Data));                       

                        if (doclst.FilterProfileTypeId != null && doclst.FilterProfileTypeId.Value != 0)
                        {
                            var getbackurlSessionid = await Mediator.Send(new GetByFileprofiletypeId(doclst.FilterProfileTypeId));
                            _selectedDescriptionItems.SessionId = getbackurlSessionid.SessionId;
                        }

                        var emailactivity = CreateEmailActivityEntry(_selectedDescriptionItems);


                    }
                }
            }
            else
            {
                toastService.ShowToast("Selected File Extension Mismatch", AC.SD.Core.Services.ToastLevel.Error);
                return;
            }


        }



    }
    static bool IsValidFileExtension(string validExtensions, string fileExtension)
    {
        // Split the valid extensions into an array
        string[] validExtensionsArray = validExtensions.Split(',');

        // Check if the given file extension is in the array
        foreach (string ext in validExtensionsArray)
        {
            if (fileExtension.Equals(ext, StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }
        }

        return false;
    }
    void CheckExtension()
    {
        IsUploadExt = "";

        if (!string.IsNullOrEmpty(_selectedDescriptionItems.Extension))
        {
            var contentType = _selectedDescriptionItems.ContentType != null ? _selectedDescriptionItems.ContentType.Split("/").First().ToLower() : "";
            var extenionType = _selectedDescriptionItems.Extension.ToLower();
            if (extenionType == ".txt")
            {
                AcceptedFileTypes = new List<string>() { ".txt" };
            }
            else if (extenionType == ".pdf")
            {
                AcceptedFileTypes = new List<string>() { ".pdf" };
            }
            else if (extenionType == ".ppt" || extenionType == ".pptx")
            {
                AcceptedFileTypes = new List<string>() { ".ppt", ".pptx" };
            }
            else if (extenionType == ".doc" || extenionType == ".docx")
            {
                AcceptedFileTypes = new List<string>() { ".doc", ".docx" };
            }
            else if (extenionType == ".xls" || extenionType == ".xlsx")
            {
                AcceptedFileTypes = new List<string>() { ".xls", ".xlsx" };
            }
            else
            {
                if (contentType == "image")
                {
                    AcceptedFileTypes = new List<string>() { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".tiff", ".tif", ".webp", ".svg" };
                }
                else if (contentType == "video")
                {
                    AcceptedFileTypes = new List<string>() { ".mp4", ".avi", ".mkv", ".mov", ".wmv", ".flv", ".webm", ".3gp", ".mpg", "mpeg" };
                }
                else if (contentType == "audio")
                {
                    AcceptedFileTypes = new List<string>() { "audio/*" };
                }
                else
                {
                    IsUploadExt = ".isUploadCheckOut";
                }
            }
        }           

        ExtensionsList = string.Join(",", AcceptedFileTypes.ConvertAll(d => d.ToLower()).Distinct().ToList());

        StateHasChanged();

    }
    async Task CreateEmailActivityEntry(Documents documents)
    {
        var Tid = long.Parse(@SelectedGroup);
        var topiclist = await Mediator.Send(new GetListByIdList(Tid));

        string filePath = documents.FileName;
        string subjectName = Path.GetFileNameWithoutExtension(filePath);

        var createReq = new CreateActivityEmail
                {
                    SubjectName = subjectName,
                    Comment = subjectName,
                    ActivityType = "EmailFileProfileType",
                    SessionId = _activityEmailSessionId,
                    BackURL = documents.SessionId.ToString(),
                    DocumentSessionId = _activityEmailSessionId,
                    EmailTopicSessionId = topiclist[0].SessionId ,
                    AddedByUserID = applicationUser.UserID,
                    AddedDate = DateTime.Now

                };

        var result = await Mediator.Send(createReq);

        var resultdoc = await Mediator.Send(new UpdateEmailDmsDocId(_selectedDescriptionItems.DocumentId, result));        


        IsDescriptionOpen = false; 
        IsFileProfileTypeFilterDocOpen = false;        
        FilterDocumentString = null;
        LinkFilterFileprofiletypeName = null;
        _dataFileProfileType.FileProfileTypeId = null;



        if (RTopicId == 0)
        {
            await loadTopicDocList();
        }
        else
        {
            await loadSubTopicDocList();
        }



    }
    async Task createActivityTag(string? tages)
    {
        var Tid = long.Parse(@SelectedGroup);
        var topiclist = await Mediator.Send(new GetListByIdList(Tid));



        string groupTag = "";
        long grouptTagId = 0;
        long catTagId = 0;


        string inputString = tages;
        string[] splitElements = inputString.Split('/');
        foreach (string element in splitElements)
        {
            Console.WriteLine(element.Trim()); // Trim to remove leading and trailing spaces
        }

        List<string> tagStringList = new List<string>();

        for (var j = 0; j < splitElements.Length; j++)
        {
            var ckl = splitElements[j];

            if (j == 0)
            {
                groupTag = ckl; // Assign the first element to groupTag
            }
            else
            {
                tagStringList.Add(ckl); // Add other elements to tagStringList
            }
        }

        string tagString = string.Join("_", tagStringList);

        if (string.IsNullOrEmpty(tagString))
        {
            tagString = groupTag;
        }

        var tagItems = await Mediator.Send(new GetAllApplicationMasterChildListQuery("122"));

        var cktagItem = tagItems.Where(x => x.Value == groupTag).ToList();
        if (cktagItem.Count > 0)
        {
            grouptTagId = cktagItem[0].ApplicationMasterChildId;
        }
        else
        {
            var request = new CreateApplicationMasterChildCommand
                {
                    ApplicationMasterParentId = 122,
                    ParentId = null,
                    Description = groupTag,
                    Value = groupTag,
                    AddedByUserId = applicationUser.UserID,
                    ModifiedByUserId = applicationUser.UserID,
                    AddedDate = DateTime.Now,
                    ModifiedDate = DateTime.Now,
                    StatusCodeId = 1,
                    SessionId = Guid.NewGuid(),
                };
            var rlt = await Mediator.Send(request);
            grouptTagId = rlt.ApplicationMasterChildId;
        }

        if (!string.IsNullOrEmpty(tagString))
        {
            var catItems = await Mediator.Send(new GetAllApplicationMasterChildByIdQuery(grouptTagId));

            var ckcatItem = catItems.Where(x => x.Value == tagString).ToList();
            if (ckcatItem.Count > 0)
            {
                catTagId = ckcatItem[0].ApplicationMasterChildId;
            }
            else
            {
                var request = new CreateApplicationMasterChildCommand
                    {
                        ApplicationMasterParentId = 123,
                        ParentId = grouptTagId,
                        Description = tagString,
                        Value = tagString,
                        AddedByUserId = applicationUser.UserID,
                        ModifiedByUserId = applicationUser.UserID,
                        AddedDate = DateTime.Now,
                        ModifiedDate = DateTime.Now,
                        StatusCodeId = 1,
                        SessionId = Guid.NewGuid(),
                    };                
                var rlt = await Mediator.Send(request);

                catTagId = rlt.ApplicationMasterChildId;

                await createApplicationMasterChild(124, catTagId, "Review");
                await createApplicationMasterChild(124, catTagId, "Discussion");
            }
        }



        var MainSessionId = _dataFileProfileType.sessionId;
        var doclist = _selectedDescriptionItems;



        //var items = await Mediator.Send(new GetActivityEmailList(_selectedItems.SessionID.Value));

        //if (items.Count == 0)
        //{
        var sessionId = _selectedDescriptionItems.ScreenId;
        string filePath = _selectedDescriptionItems.FileName;
        string subjectName = Path.GetFileNameWithoutExtension(filePath);

        var createReq = new CreateActivityEmail
                {
                    SubjectName = subjectName,
                    Comment = _selectedDescriptionItems.Description,
                    ActivityType = "EmailFileProfileType",
                    SessionId = _activityEmailSessionId,
                    BackURL = MainSessionId.ToString(),
                    DocumentSessionId = _activityEmailSessionId,
                    EmailTopicSessionId = topiclist[0].SessionId ,
                    AddedByUserID = applicationUser.UserID,
                    AddedDate = DateTime.Now,
                    ManufacturingProcessId = grouptTagId,
                    CategoryActionId = catTagId

                };

        var result = await Mediator.Send(createReq);

        var resultdoc = await Mediator.Send(new UpdateEmailDmsDocId(_selectedDescriptionItems.DocumentId, result));

        IsDescriptionOpen = false; 
        IsFileProfileTypeFilterDocOpen = false;        
        FilterDocumentString = null;
        LinkFilterFileprofiletypeName = null;
        _dataFileProfileType.FileProfileTypeId = null;



        if (RTopicId == 0)
        {
            await loadTopicDocList();
        }
        else
        {
            await loadSubTopicDocList();
        }

        //}


    }
    async Task createApplicationMasterChild(long MasterParentId, long ParentId, string notes)
    {

        var request = new CreateApplicationMasterChildCommand
            {
                ApplicationMasterParentId = MasterParentId,
                ParentId = ParentId,
                Description = notes,
                Value = notes,
                AddedByUserId = applicationUser.UserID,
                ModifiedByUserId = applicationUser.UserID,
                AddedDate = DateTime.Now,
                ModifiedDate = DateTime.Now,
                StatusCodeId = 1,
                SessionId = Guid.NewGuid(),
            };
        await Mediator.Send(request);
    }
    protected async Task FileProfileTypeSelectionChanged(TreeViewNodeEventArgs e)
    {
        _dataFileProfileType.PlantId = 0; _dataFileProfileType.DepartmentId = 0;
        _dataFileProfileType.DivisionId = 0; _dataFileProfileType.SectionId = 0; _dataFileProfileType.SubSectionId = 0;


        if (e.NodeInfo?.DataItem != null)
        {
            var nodeName = e.NodeInfo.DataItem as DocumentsModel;
            var ids = nodeName.FileProfileTypeId;
            var lists = GetFileProfileTypePath(fileProfileTypeDocumentsAll, nodeName.FileProfileTypeId);
            LinkFilterFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
            _dataFileProfileType.FileProfileTypeId = nodeName.FileProfileTypeId;
            _dataFileProfileType.ProfileId = nodeName.ProfileID;
            _dataFileProfileType.sessionId = nodeName.SessionID;
        }

        if (_dataFileProfileType != null && _dataFileProfileType.ProfileId > 0)
        {
            _dataFileProfileType = _dataFileProfileType;

            documentProfileNoSeriesData = await Mediator.Send(new GetDocumentProfileNoSeriesById(_dataFileProfileType.ProfileId));

            dynamic abbreviation = JsonConvert.DeserializeObject(documentProfileNoSeriesData.Abbreviation1);
            if (abbreviation != null)
            {
                foreach (var item in abbreviation)
                {
                    var itemsId = item.Id;
                    if (itemsId == 1)
                    {
                        isPlant = true;
                        _dataFileProfileType.PlantId = null;
                    }
                    if (itemsId == 2)
                    {
                        isDepartment = true; isDivision = true;
                        _dataFileProfileType.DepartmentId = null;
                        _dataFileProfileType.DivisionId = null;
                    }
                    if (itemsId == 3)
                    {
                        isSection = true;
                        _dataFileProfileType.SectionId = null;
                    }
                    if (itemsId == 4)
                    {
                        isSubSection = true;
                        _dataFileProfileType.SubSectionId = null;
                    }
                }
            }
            if (_dataFileProfileType.IsExpiryDate == true)
            {
                isExpiryDate = true;
            }
        }

        IsFileProfileTypeFilterDocOpen = false;
        StateHasChanged();
    }
    private List<FileProfileTypeModel>
       GetFileProfileTypePath(List<DocumentsModel>
       foldersListItem, long? id)
    {
        var foldersListItems = foldersListItem.Where(t => t.FileProfileTypeId == id).ToList();
        FileProfileTypeModel fileprofile = new FileProfileTypeModel();
        List<FileProfileTypeModel>
        foldersList = new List<FileProfileTypeModel>
        ();
        if (foldersListItems != null && foldersListItems.Count > 0)
        {
            foldersListItems.ForEach(s =>
            {
                List<string>FolderPathLists = new List<string>();
                FileProfileTypeModel fileProfileTypeModel = new FileProfileTypeModel();
                fileProfileTypeModel.FileProfileTypeId = s.FileProfileTypeId.Value;
                fileProfileTypeModel.Name = s.FileName;
                fileprofile = GetProfileTypeName(foldersListItem, s, FolderPathLists, fileprofile);
                FolderPathLists.Add(s.FileName);
                fileProfileTypeModel.FileProfileTypeParentId = fileprofile.ParentId;
                fileProfileTypeModel.FileProfilePath = string.Join(" / ", FolderPathLists);
                foldersList.Add(fileProfileTypeModel);
            });
        }
        return foldersList;
    }
    private FileProfileTypeModel GetProfileTypeName(List<DocumentsModel>
        foldersListItems, DocumentsModel s, List<string>
        foldersModel, FileProfileTypeModel fileProfileTypeModel)
    {

        if (s.ParentId != null)
        {
            var items = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.ParentId);
            GetProfileTypeName(foldersListItems, items, foldersModel, fileProfileTypeModel);
            foldersModel.Add(items.FileName);
        }
        else if (s.ParentId == null)
        {
            fileProfileTypeModel.ParentId = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.FileProfileTypeId)?.FileProfileTypeId;
        }
        return fileProfileTypeModel;
    }

    private FileProfileType _dataFileProfileType = new FileProfileType();

    private class FileProfileType
    {
        [Required(ErrorMessage = "FileProfile is Required")]
        public long? FileProfileTypeId { get; set; }
        public Guid? sessionId { get; set; }
        public string? Type { get; set; }

        [Required(ErrorMessage = "Select File is Required")]
        public long? ReplaceDocumentId { get; set; }  


        [Required(ErrorMessage = "Company is Required")]
        public long? PlantId { get; set; } = 0;
        [Required(ErrorMessage = "Department is Required")]
        public long? DepartmentId { get; set; } = 0;
        [Required(ErrorMessage = "Section is Required")]
        public long? SectionId { get; set; } = 0;
        [Required(ErrorMessage = "SubSection is Required")]
        public long? SubSectionId { get; set; } = 0;
        [Required(ErrorMessage = "Division is Required")]
        public long? DivisionId { get; set; } = 0;
        public string? CompanyCode { get; set; }
        public string? SectionName { get; set; }
        public string? SubSectionName { get; set; }
        public string? DepartmentName { get; set; }
        public string? ProfileNo { get; set; }
        public string? Description { get; set; }

        public Guid? SessionId { get; set; }
        public Guid? FileSessionId { get; set; }
        public string? SourceFrom { get; set; }
        public string? FilePath { get; set; }
        public bool? IsExpiryDate { get; set; }
        public long? ProfileId { get; set; }
        public DateTime? ExpiryDate { get; set; }

    }
    void onSelectedFileReplaceChanged(Documents documents)
    {
        if(documents != null)
        {
            SeletedExtensions = Path.GetExtension(documents.FileName);

            isPlant = false;
            _dataFileProfileType.PlantId = 0;

            isDepartment = false; isDivision = false;
            _dataFileProfileType.DepartmentId = 0;
            _dataFileProfileType.DivisionId = 0;

            isSection = false;
            _dataFileProfileType.SectionId = 0;


            isSubSection = false;
            _dataFileProfileType.SubSectionId = 0;
        }


    }
    void OnFileLinkTypeChanged(string? radioValue)
    {
        _dataFileProfileType.Type = radioValue;

        if (radioValue == "Link to DMS")
        {
            LinkFilterFileprofiletypeName = null;
            //_dataFileProfileType.Description = null;

            _dataFileProfileType.FileProfileTypeId = null;
            _dataFileProfileType.ReplaceDocumentId = 0;

            // isPlant = false;
            // _dataFileProfileType.PlantId = null;

            // isDepartment = false; isDivision = false;
            // _dataFileProfileType.DepartmentId = null;
            // _dataFileProfileType.DivisionId = null;

            // isSection = false;
            // _dataFileProfileType.SectionId = null;

            // isSubSection = false;
            // _dataFileProfileType.SubSectionId = null;

        }

        if (radioValue == "File Replace(Check-In)")
        {
            _dataFileProfileType.FileProfileTypeId = 0;
            _dataFileProfileType.ReplaceDocumentId = null;

            _dataFileProfileType.PlantId = 0; _dataFileProfileType.DepartmentId = 0; 
            _dataFileProfileType.DivisionId = 0; _dataFileProfileType.SectionId = 0; _dataFileProfileType.SubSectionId = 0;



        }        

        StateHasChanged();
    }


    private class FileReplace
    {

    }



    bool IsDescriptionOpen { get; set; } = false;
    bool IsSubjectNoOfDays {get;set;} = false;
    bool IsRenameOpen { get; set; } = false;
    bool IsFilterOpen { get; set; } = false;
    public bool IsExpiryDateOpen { get; set; } = false;
    Documents _selectedDescriptionItems = new Documents();
    async Task onBackToDMS(Documents item)
    {
        if(item.EmailToDMS != null)
        {
            onBackFileProfileType(item.DMSBackUrl);
            await JSRuntime.InvokeAsync<string>("ReloadUrl");
        }
    }

    public async Task loadFileProfileDDData()
    {
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        await SelectedItemChanged(0);
        await SelectedItemDivisionChanged(0);
        await SelectedItemDepartementChanged(0);
        await SelectedItemSectionChanged(0);



        isPlant = false;
        _dataFileProfileType.PlantId = null;

        isDepartment = false; isDivision = false;
        _dataFileProfileType.DepartmentId = null;
        _dataFileProfileType.DivisionId = null;

        isSection = false;
        _dataFileProfileType.SectionId = null;


        isSubSection = false;
        _dataFileProfileType.SubSectionId = null;


        StateHasChanged();        
    }
    async Task SelectedItemChanged(long? plantID)
    {
        _divisionItems = new List<ViewDivision>();
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (plantID > 0)
        {
            _divisionItems = await Mediator.Send(new GetDivisionByCompany(plantID));

            //  isDepartment = true; isDivision = true;
            // _dataFileProfileType.DepartmentId = null;
            // _dataFileProfileType.DivisionId = null;
        }
    }
    async Task SelectedItemDivisionChanged(long? divisionId)
    {
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (divisionId > 0)
        {
            _departmentItems = await Mediator.Send(new GetDepartmentByDivision(divisionId));

            //  isSection = true;
            // _dataFileProfileType.SectionId = null;

        }
    }
    async Task SelectedItemDepartementChanged(long? departmentId)
    {
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (departmentId > 0)
        {
            _sectionItems = await Mediator.Send(new GetSectionByDepartment(departmentId));

            //  isSubSection = true;
            // _dataFileProfileType.SubSectionId = null;
        }
    }
    async Task SelectedItemSectionChanged(long? sectionId)
    {
        _subSectionItems = new List<ViewSubSection>();
        if (sectionId > 0)
        {
            _subSectionItems = await Mediator.Send(new GetSubSectionBySection(sectionId));
        }
    }

    async Task OnButtonDescriptionClick(Documents items)
    {

        //_dataFileProfileType = new FileProfileType();       
        LinkFilterFileprofiletypeName = null;
        _dataFileProfileType.PlantId = null;
        _dataFileProfileType.DepartmentId = null;
        _dataFileProfileType.DivisionId = null;
        _dataFileProfileType.SectionId = null;
        _dataFileProfileType.SubSectionId = null;
        _dataFileProfileType.Description = null;

        OnFileLinkTypeChanged("Link to DMS");



        await loadFileProfileDDData();

        IsExpiryDateOpen = false; IsRenameOpen = false;
        _selectedDescriptionItems = new Documents();
        _selectedDescriptionItems.FilterProfileTypeId = items.FilterProfileTypeId;
        _selectedDescriptionItems.DocumentId = items.DocumentId;
        _selectedDescriptionItems.Description = items.Description;    
        _selectedDescriptionItems.FileName = items.FileName;
        _selectedDescriptionItems.ContentType = items.ContentType;
        _selectedDescriptionItems.Extension = Path.GetExtension(items.FileName);
        _selectedDescriptionItems.SessionId = items.SessionId;
        //_selectedDescriptionItems.Type = items.Type;
        _selectedDescriptionItems.ModifiedDate = DateTime.Now;
        _selectedDescriptionItems.ModifiedByUserId = applicationUser.UserID;

        fileProfileTypeDocumentsAll = await Mediator.Send(new GetAllfileprofiletypeListQuery());
        if (fileProfileTypeDocumentsAll.Count() > 0)
        {
            _selectedTreeItems = _treeGenerateRecursive.TreeGenerateRecursives(fileProfileTypeDocumentsAll);
        }

        IsDescriptionOpen = true;

        StateHasChanged();
    }   

    async Task OnSubmitFileLinked()
    {       
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit_FileProfileType();
        }
    }

    int SelectedFilesCount { get; set; }
    int CurrentUplodCount { get; set; }
    string MyMessage { get; set; }
    string Message = "Upload";

    void OnUploadProgressChanged(FileUploadEventArgs e)
    {
        var progress = e.FileInfo.LoadedBytes / e.FileInfo.Size * 100;
    }
    async Task OnFileUploadStart(FileUploadStartEventArgs e)
    {
        Message = "Uploading...";
        loading = true;
        var SessionId = _sessionId;        
        string BaseUrl = NavigationManager.BaseUri + "api/FileUpload/";            
        string url = BaseUrl + "UploadDocumentsBySession?SessionId=" + _sessionId + "&addedByUserId=" + AppUserId + "&IsNewSession=false&SourceFrom=Email";
        e.UploadUrl = url;
    }
    void OnFileUploadStarted(FileUploadEventArgs e)
    {
        MyMessage = "Upload of the " + e.FileInfo.Name + " file was started.";
        toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Info);
        InvokeAsync(StateHasChanged);
    }

    private string toggleButtonVisible = "ActiveToggle";
    private string hiddenButtonCssClass = "col-md-9";
    private string? ProductActivityBaseUrl;
    public int ActiveTabIndex { get; set; } = 1;
    string? SearchText { get; set; }
    string? MyDayFilterText  = null;
    Guid? FilterSessionId = null;
    string? GridSearchText { get; set; }
    bool PreviewEnabled { get; set; } = false;
    bool docEnabled { get; set; } = false;
    int newSubjectreply = 0;
    bool isPushNotification { get; set; } = false;
    bool isCheckAllowParticipant { get; set; } = false;
    bool isDynamicFormEmailSection  = false;
    private CancellationTokenSource cancellationTokenSource;
    private const int AutoRefreshInterval = 10000; // 10 seconds
    private Documents? _selectlst;
    [Parameter]
    public string? ActiveSessionId { get; set; }
    [Parameter]
    public Guid TodoSessionId { get; set; }
    [Parameter]
    public string? Page { get; set; }
    public string? filterrowname { get; set; }
    private bool IsConHistory = false;
    [Parameter]
    public EventCallback<string> RId { get; set; }
    IGrid? TOGrid { get; set; }
    IGrid? CCGrid { get; set; }
    IGrid? SentGrid { get; set; }
    DxWindow? dxWindow;
    bool WindowVisible { get; set; } = false;
    private bool IsReadOnly = true;
    List<string>? SelectedGroups = new List<string>();
    private List<EmailTopics>? _forumTopicTo;
    private List<EmailTopics>? _forumTopicCC;
    private List<EmailTopics>? _forumTopicSent;

    private int ElementHeight { get; set; }
    [Parameter]
    public long Tid { get; set; }
    [Parameter]
    public long Cid { get; set; }
    public long RTopicId = 0;
    bool IsOpen { get; set; } = false;
    bool IsOpenFlyout { get; set; } = false;
    bool isOpenSubjectPop { get; set; } = false;
    bool isOpenActionTagMultiplePop { get; set; } = false; 
    bool isOpenUserTagMultiplePop { get; set; } = false;
    bool isOpenSubjectNamePop { get; set; } = false;
    string dynamicShowSubject = "showOpenSubject_";
    string dynamicShowDrawer = "ShowOpenDrawer_";
    long ecID { get; set; } = 0;
    Selection? selection; 
    Selection? richSelection { get; set; }
    [Parameter]
    public EventCallback<IToolbar> CustomizeToolbar { get; set; }
    bool ErrorVisible { get; set; } = false;
    string? MyError { get; set; }
    [Parameter]
    public List<string> AcceptedFileTypes { get; set; } = new List<string> { "image/*", "video/*","audio/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF",".msg", ".MSG", ".eml", ".EML", "Outlook.File.eml.15",".ai"};
    public List<string> AllowedFileExtensions { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF", ".msg", ".MSG", ".eml", ".EML", "Outlook.File.eml.15", ".ai" };
    public DocumentFormat MyDocumentFormat { get; set; }
    private string? BaseUrl;
    private string? FileUrl;
    private string? DocumentViewUrl;
    string documentPath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
    string documentFormat = "docx";
    private ElementReference OfficeContainerRef;
    DxRichEdit? richEdit { get; set; }
    DxRichEdit? msgrichEdit { get; set; }
    string? previewUrl;
    private string? documentPreviewUrl;
    private string? documentMimeType;
    byte[]? documentContent;
    byte[]? msgContent;
    DxUpload MyUpload { get; set; }
    bool UploadVisible { get; set; } = true;
    bool AttachmentUploadVisible { get; set; } = false;
    bool isDescription { get; set; } = false;
    private bool uploadSuccess = false;
    IEnumerable<UploadFileInfo>? Files { get; set; }
    UploadFileInfo? FirstFile { get; set; }
    public string MyHeight { get; set; } = "200px";
    string width = "800px", height = "800px";  
    [Parameter]
    public EventCallback OnDataChange { get; set; }
    private ParticipantList? RefTopicAddPList { get; set; }
    private GroupParticipantList? RefTopicAddGroupPList { get; set; }
    private AssignToEmail? RefAssignTo { get; set; }
    private AllEmail? RefAssignAll{ get; set; }
    private TransferEmail? RefTransferEamil { get; set; }
    private TopicTags? RefTopicTagList { get; set; }
    private UserToDo? RefTopicTodo { get; set; }
    private EmailAttachment? RefEmailDoc { get; set; }
    private MasterSearch? RefMasterSearch { get; set; }
    private AdminEmail? RefAdminSearch { get; set; }
    private bool IsValidUser { get; set; } = false;
    private bool IsFileValidUser { get; set; } = false;
    [Parameter]
    public EventCallback<string> Participent { get; set; }
    private async Task OnWindowResizeCompleted(WindowResizeCompletedEventArgs args) {
        // (width, height) = ($"{args.Size.Width}px", $"{args.Size.Height}px");
        (width) = ($"{args.Size.Width}px");
        MyHeight =  $"{args.Size.Height}px";
        string setHeight = $"{args.Size.Height - 320}";
        string selector = ".editor-box-height";
        IsUserGroupCCOpen = false;
        IsUserGroupToOpen = false;

        //await JSRuntime.InvokeVoidAsync("adjustHeight", setHeight);
        await JSRuntime.InvokeVoidAsync("setHeight", selector, setHeight);
    }
    private List<string>? _actionTagMultiple;
    private async Task ShowActionMultipleFlyout()
    {

        isOpenActionTagMultiplePop = true;
    }   
    private async Task ShowUserMultipleFlyout()
    {

        isOpenUserTagMultiplePop = true;
    }   
    private void ShowSubjectFlyout(EmailConversations emailConversations) {
        CurrentEmailConversations = emailConversations;

        if((applicationUser.UserID == CurrentEmailConversations.UserId) || _openAccessUserLink != null)
        {            
            if (CurrentEmailConversations != null)
            {
                CurrentEmailConversations.IsLockDueDate = false;
            }                
        }

        isOpenSubjectPop = true;
    }
    async Task onMarkasRead(long Id)
    {
        var request = await Mediator.Send(new UpdateMarkasRead(Id));

        if (RTopicId == 0)
        {
            if(reply_id == 0)
            {
                await LoadData();
            }
            else
            {
                await replyslst();
            }


        }
        else
        {
            if(reply_id == 0)
            {
                await LoadReplyData();
            }
            else
            {
                await replyslst();
            }            
        }

        if(isLeftMenuvisible == "AssignTo")
        {
            await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
        }

        if (isLeftMenuvisible == "All")
        {
            await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
        }      

        await RefreshService.RequestRefreshAsync();

    }
    async Task onMarkasunRead(long Id)
    {
        var request = await Mediator.Send(new UpdateMarkasunRead(Id));

        if (RTopicId == 0)
        {
            if(reply_id == 0)
            {
                await LoadData();
            }
            else
            {
                await replyslst();
            }

        }
        else
        {
            if(reply_id == 0)
            {
                await LoadReplyData();
            }
            else
            {
                await replyslst();
            }   
        }

        if (isLeftMenuvisible == "AssignTo")
        {
            if(RefAssignTo != null)
            {
                await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
            }

        }
        if (isLeftMenuvisible == "All")
        {
            if(RefAssignAll != null)
            {
                await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
            }

        }

        await RefreshService.RequestRefreshAsync();
    }
    private async Task LoadMoreRepliesnew(long replyId, int totalReplyCount)
    {
        isLoading = true; 
        await JSRuntime.InvokeAsync<string>("showLoading");

        var targetDiscussion = _discussionList.FirstOrDefault(d => d.ID == replyId);
        if (targetDiscussion == null)
        {
            isLoading = false;
            return;
        }

        var newReplies = await Mediator.Send(new GetReplyListPaged(
            replyId, applicationUser.UserID, targetDiscussion.CurrentPage, replypageSize));

        if (newReplies != null && newReplies.Any())
        {
            if (targetDiscussion.ReplyConversation == null)
                targetDiscussion.ReplyConversation = new List<EmailConversations>();

            targetDiscussion.ReplyConversation.AddRange(newReplies);
            targetDiscussion.CurrentPage++;
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");
        isLoading = false;
    }
    private async Task LoadMoreReplies(long replyId, int totalReplyCount)
    {
        isLoading = true;
        await JSRuntime.InvokeAsync<string>("showLoading");
        if (!currentPages.ContainsKey((int)replyId))
            currentPages[(int)replyId] = 1;

        var page = currentPages[(int)replyId];
        var newReplies = await Mediator.Send(new GetReplyListPaged(replyId, applicationUser.UserID, page, replypageSize));

        if (!replyDiscussions.ContainsKey((int)replyId))
            replyDiscussions[(int)replyId] = new List<EmailConversations>();

        if (newReplies != null && newReplies.Any())
        {
            replyDiscussions[(int)replyId].AddRange(newReplies);
            currentPages[(int)replyId]++;
        }

        hasMore = replyDiscussions[(int)replyId].Count < totalReplyCount;

        await JSRuntime.InvokeAsync<string>("hideLoading");

        isLoading = false;

        StateHasChanged();
    }




    private async Task LoadFileDataAsync(EmailConversations item)
    {
        if (item.FileData == null)
        {          
            await JSRuntime.InvokeAsync<string>("showLoading");
            item.FileData  = await Mediator.Send(new GetFileData(item.ID));
            await JSRuntime.InvokeAsync<string>("hideLoading");
            StateHasChanged(); 
        }
    }

    private async Task replyslst()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        if (_replyDiscussionList != null)
        {
            _replyDiscussionList.Clear();
            _replyDiscussionList = null;
        }
        //await LoadMoreReplies(reply_id, reply_tcount); 
        _replyDiscussionList = await Mediator.Send(new GetOnReplyDiscussionList(reply_id, applicationUser.UserID));
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    private async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }
    private void ToggleButtonClick()
    {
        toggleButtonVisible = toggleButtonVisible == "HiddenToggle" ? "ActiveToggle" : "HiddenToggle";        
        hiddenButtonCssClass = toggleButtonVisible == "HiddenToggle" ? "col-md-12" : "col-md-9";
    }
    private class Model
    {
        [Required(ErrorMessage = "Due Date is required")]
        public DateTime? DueDate { get; set; }    
        public int NoOfDays { get; set; }  
    }
    private class UserTagData
    {
        public string? UserTag { get; set; }
        public long? UserTagId { get; set; }  

        public IEnumerable<long?> UserTagIds { get; set; } = new List<long?>();
    }
    private class ModelClose
    {
        [Required(ErrorMessage = "Remarks is required")]
        public string? Remarks { get; set; }
    }  
    private class SubjectNameModel
    {
        [Required(ErrorMessage = "Subject Name is required")]
        public string? SubjectName { get; set; } 
    }
    private DxUpload? uploadComponent;
    string DuedateReason { get; set; } = "";
    private Model _dataDuDate = new Model();
    private Model _dataSubjectDuDate = new Model();
    private UserTagData dataUserTag = new UserTagData();
    private ModelClose _dataTopicClose = new ModelClose();
    private SubjectNameModel _dataSubjectName = new SubjectNameModel();

    string? ClosedMsg { get; set; }
    DateTime? DateTimeValue { get; set; }
    DxPopup? popup;
    bool PopupVisible { get; set; } = false;
    bool DocPopupVisible { get; set; } = false;
    bool PreviewDocPopup { get; set; } = false;
    bool AddPopupArchive { get; set; } = false;
    private Dictionary<int, bool> itemVisibility = new Dictionary<int, bool>();
    private Dictionary<long, bool> copyitemVisibility = new Dictionary<long, bool>();    
    private Dictionary<int, bool> DocitemVisibility = new Dictionary<int, bool>();
    private Dictionary<long, bool> topicitemVisibility = new Dictionary<long, bool>();
    AccordionExpandMode ExpandMode { get; set; } = AccordionExpandMode.SingleOrNone;
    AccordionExpandCollapseAction ExpandCollapseAction { get; set; } = AccordionExpandCollapseAction.HeaderClick;

    string isMenuvisible = "Posts";
    string isLeftMenuvisible = "AssignTo";
    DxTreeView? treeView;
    IGrid? Grid { get; set; }
    bool isFileUpload = false;
    bool isDueDate =false;
    bool isSubjectDueDate = false;
    // DateTime minDueDate = DateTime.MinValue;
    DateTime minDueDate = DateTime.Now;
    bool isUserTagChange = false;
    private List<EmailActivityCatgorys>? _UserTagList;
    bool isCancelDueDate = false;
    string _cancelSubjectName = "";
    bool isRenameSubject = false;
    bool isTopicClosed = false;
    bool isTopicCategoryClosed = false;
    bool isArchiveClosed = false;
    bool isAllPlistVisible = false;
    bool isAssignToVisible = false;
    bool isComponentVisible = true;
    bool isEnabled { get; set; } = false;
    bool ArchiveEnabled { get; set; } = false;
    bool UnArchiveEnabled { get; set; } = false;
    bool isUserGroup { get; set; } = false;
    bool isPage { get; set; } = false;
    bool isTodoEnabled { get; set; } = false;
    bool isOpenEnabled { get; set; } = false;
    bool isCloseEnabled { get; set; } = false;
    bool isTagEnabled { get; set; } = false;
    bool isAddParticipant = false;
    bool isTags = false;
    bool isCommand = false;
    bool isCommandTopicClosed = true;
    bool isEllipsis = false;
    bool isNewSubject = false;
    long? AppUserId;
    private List<Documents>? _topicDocList;    
    private List<EmailTopics>? _topics;
    public List<EmailConversations>? _getConversationList;
    public List<EmailConversations>? _discussionList;
    public List<EmailConversations>? _replyDiscussionList;

    private EmailConversations? CurrentEmailConversations { get; set; }
    private bool IsDueDateUnlocked => !CurrentEmailConversations.IsLockDueDate;
    public List<EmailConversations>? _discussionFullList;
    public List<EmailConversations>? _replyComment;
    private List<EmailTopics>? _headTopic;
    private List<EmailActivityCatgorys>? _headTopic_Tag;
    private List<EmailActivityCatgorys>? _headTopic_UserTag;
    string? FilterString { get; set; }
    private List<EmailParticipant>? _participant;
    EmailParticipant? _participantLst { get; set; }
    Documents? _documents { get; set; }
    private List<ViewEmployee>? _allparticipant;
    private List<ViewEmployee> plist;
    bool LockDueDateEnable = false;
    private List<ViewEmployee>? _Toparticipant;
    private List<ViewEmployee>? _CCparticipant;

    private List<ViewEmployee>? _allparticipants;

    internal List<UserGroup>? _participantUserGroup;
    internal List<UserGroup>? _ToUserGroup;
    internal List<UserGroup>? _CCUserGroup;

    List<string> sToIds = new List<string>();
    List<string> sCCIds = new List<string>();

    private List<EmailConversationAssignTo>? _conversationAssignTo;
    private List<ViewEmployee>? _selectedlistpartlist;
    NavigationFilterMode FilterMode { get; set; } = NavigationFilterMode.EntireBranch;    
    EmailConversations? Data { get; set; } = new EmailConversations();
    internal List<DynamicFormSection>? _DynamicFormEmailSection = new List<DynamicFormSection>();
    string SelectedGroup = "none";
    string SelectedReplyId = "none";
    public ApplicationUser? applicationUser { get; private set; }
    IReadOnlyList<object>? SelectedDataItems { get; set; }
    List<long> participantIds = new List<long>();
    private bool loading;
    bool MessageVisible { get; set; }
    string styleClass = "";
    string MessageHeader = "Error";
    string MessageBody = "";


    bool DueDateMessageVisible { get; set; }    
    string DueDateMessageHeader = "Error";
    string DueDateMessageBody = "";


    Guid? _sessionId;
    private string uploadUrl;   
    private List<EmailAssignToList>? _assigntoItems;

    byte[] myBytes = Encoding.UTF8.GetBytes("Attachments");

    [Parameter]
    public ViewEmployee? _employeeDatas { get; set; }
    [Parameter]
    public ApplicationUser? _applicationUser { get; set; }

    [Parameter]
    public UploadMode UploadMode { get; set; }
    private string? myFile { get; set; }

    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    IEnumerable<UploadFileInfo>? Filess { get; set; }

    void OnRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "DocumentId");
        if(_topicDocList != null)
        {
            _selectlst = _topicDocList.FirstOrDefault(f => f.DocumentId == (long?)UniqueId);
        }


    }
    void ApplySearch()
    {       
        //var assignToEmailComponent = new AssignToEmail();
        //assignToEmailComponent.ApplySearch(GridSearchText);
    }
    private async Task ScrollToElement()
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", ".msgOpen");
    }
    async Task CloseClick(MouseEventArgs args)
    {
        await dxWindow.CloseAsync();
        closeReply();
    }
    protected async void SelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        SelectedFilesCount = files.ToList().Count;       
        await InvokeAsync(StateHasChanged);
        uploadSuccess = false;
        if(files.ToList().Count > 0)
            await UploadFiles();
    }
    protected async void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
        SelectedFilesCount = files.ToList().Count; //Count current files
        InvokeAsync(StateHasChanged);
    }
    bool UploadVisible1 { get; set; } = false;
    protected void SelectedFilesChanged1(IEnumerable<UploadFileInfo> files)
    {
        Filess = files;
        SelectedFiles.AddRange(files);
        UploadVisible1 = files.ToList().Count > 0;   

        InvokeAsync(StateHasChanged);
    }   
    private void RemoveFile(UploadFileInfo file)
    {
        SelectedFiles.Remove(file);
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
            e.CssClass += "non-selectable-row";
        }
        //if (e.ElementType == GridElementType.HeaderCell)
        //{
        //    e.Style = "background-color: rgba(0, 0, 0, 0.08)";
        //    e.CssClass = "header-bold";
        //}
    }
    void onSelectedToItemsChanged(IEnumerable<long>? values)
    {
        Data.AssigntoIds = values;
        if (Data.AssignccIds != null)
        {
            var list = Data.AssignccIds.Where(p => !values.Contains(p)).ToList();
            Data.AssignccIds = list;
            StateHasChanged();
        }
        // if (values != null)
        // {            
        //     //_CCparticipant = _allparticipants.Except(values).ToList();
        //     _CCparticipant = _allparticipants.Where(p => !values.Contains(p.UserID.Value)).ToList();
        // }
        // else
        // {            
        //     _CCparticipant = _allparticipants.ToList();
        // }
    }
    void onSelectedToItemsChangedold(IEnumerable<ViewEmployee> values)
    {
        if (values != null)
        {
            // Update _CCparticipant based on selected values from _Toparticipant
            _CCparticipant = _allparticipants.Except(values).ToList();
        }
        else
        {
            // Reset _CCparticipant to all participants if nothing is selected in _Toparticipant
            _CCparticipant = _allparticipants.ToList();
        }
    }
    void onSelectedCCItemsChanged(IEnumerable<long>? values)
    {
        Data.AssignccIds = values;
        if (Data.AssigntoIds != null)
        {
            var list = Data.AssigntoIds.Where(p => !values.Contains(p)).ToList();
            Data.AssigntoIds = list;
            StateHasChanged();
        }
        // if (values != null)
        // {            
        //     //_Toparticipant = _allparticipants.Except(values).ToList();
        //     _Toparticipant = _allparticipants.Where(p => !values.Contains(p.UserID.Value)).ToList();
        // }
        // else
        // {            
        //     _Toparticipant = _allparticipants.ToList();
        // }
    }

    void onSelectedCCItemsChangedold(IEnumerable<ViewEmployee> values)
    {
        if (values != null)
        {
            // Update _Toparticipant based on selected values from _CCparticipant
            _Toparticipant = _allparticipants.Except(values).ToList();
        }
        else
        {
            // Reset _Toparticipant to all participants if nothing is selected in _CCparticipant
            _Toparticipant = _allparticipants.ToList();
        }
    }

    void onSelectedToUserGroupItemsChanged(IEnumerable<UserGroup> values)
    {
        if (values != null)
        {

            _CCUserGroup = _participantUserGroup.Except(values).ToList();
        }
        else
        {

            _CCUserGroup = _participantUserGroup.ToList();
        }

        StateHasChanged();
    }
    void onSelectedCCUserGroupItemsChanged(IEnumerable<UserGroup> values)
    {
        if (values != null)
        {
            _ToUserGroup = _participantUserGroup.Except(values).ToList();
        }
        else
        {
            _ToUserGroup = _participantUserGroup.ToList();
        }
        StateHasChanged();
    }
    async void  onSelectedDynFomSectionChanged(DynamicFormSection dynamicFormSections)
    {
        if (dynamicFormSections != null)
        {     
            var SectionUserList = await Mediator.Send(new GetUserPermissionSection(dynamicFormSections.DynamicFormSectionId));
            if(SectionUserList.Count > 0)
            {
                var assTo = SectionUserList.Where(c => c.IsReadWrite == true && c.UserId != applicationUser.UserID).Select(s => (long)s.UserId).ToList();
                var assCC = SectionUserList.Where(c => c.IsReadOnly == true && c.UserId != applicationUser.UserID).Select(s => (long)s.UserId).ToList();

                Data.AssigntoIds = new List<long>();
                Data.AssignccIds = new List<long>();

                var emplst = _allparticipants.Where(employee => assTo.Contains(employee.UserID.Value)).ToList();
                var userIds = emplst.Select(employee => employee.UserID.Value).ToList();
                onSelectedToItemsChanged(userIds);                

                var emplst1 = _allparticipants.Where(employee => assCC.Contains(employee.UserID.Value)).ToList();
                var ccids = emplst1.Select(employee => employee.UserID.Value).ToList();
                onSelectedCCItemsChanged(ccids);


                Data.AssigntoIds = assTo;
                Data.AssignccIds = assCC;
            }

            Data.DynamicFormID = dynamicFormSections.DynamicFormId;
            Data.EmailFormDataSessionID = dynamicFormSections.EmailFormDataSessionID;


            StateHasChanged();
        }
        else
        {
            Data.AssigntoIds = new List<long>();
            Data.AssignccIds = new List<long>();

            var assTo = Data.AssigntoIds;
            var assCC =Data.AssignccIds;


            var emplst = _allparticipants.Where(employee => assTo.Contains(employee.UserID.Value)).ToList();
            var toItems = emplst.Select(employee => employee.UserID.Value).ToList();
            onSelectedToItemsChanged(toItems);

            var emplst1 = _allparticipants.Where(employee => assCC.Contains(employee.UserID.Value)).ToList();
            var ccItems = emplst1.Select(employee => employee.UserID.Value).ToList();
            onSelectedCCItemsChanged(ccItems);

            Data.DynamicFormID = null;
            Data.EmailFormDataSessionID = null;


            StateHasChanged();            
        }

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {   
            await JSRuntime.InvokeVoidAsync("window.addEventListener", "scroll", DotNetObjectReference.Create(this).Value, "HandleScroll");  
        }


        if (uploadSuccess)
        {
            // Invoke another function here
            //AnotherFunction();
        }
    }
    public async Task onDisDocDownload(string FilePath)
    {
        var url = FileUrl + FilePath;
        await OpenUrlInNewTab(url);        
    }

    [JSInvokable("handleScroll")]
    public void HandleScroll(string scrollDirection)
    {
        if (scrollDirection == "down")
        {
            // Scroll down logic
            var scrollY = JSRuntime.InvokeAsync<int>("window.scrollY").Result;
            var scrollDirection1 = scrollY < 100 ? "up" : "down";

            if (scrollDirection1 == "up")
            {
                //isScrollingUp = true;
                //isScrollingDown = false;
            }
            else
            {
                //isScrollingUp = false;
                //isScrollingDown = true;
            }

            StateHasChanged();



        }
        else if (scrollDirection == "up")
        {
            // Scroll up logic
        }
    }
    private async Task InitializeViewer()
    {
        await JSRuntime.InvokeVoidAsync("loadViewerJS");
        string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";
        // Set the document URL
        string documentUrl = filePath;
        await JSRuntime.InvokeVoidAsync("openViewer", "viewerContainer", documentUrl);


    }
    private async Task isUploadSuccess_old()
    {
        uploadComponent.RemoveAllFiles();
        isFileUpload = false;
        await LoadData();
    }
    private async void isUploadSuccess(FileUploadEventArgs e)
    {
        MyMessage = "Upload of the " + e.FileInfo.Name + " file is Completed.";
        toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Success);
        CurrentUplodCount++;
        if (CurrentUplodCount >= SelectedFilesCount)
        {
            Message = "Upload";
            //loading = false;
            await afterUploadClosed();
        }
        await InvokeAsync(StateHasChanged);

    }
    async Task afterUploadClosed()
    {
        onRestText();
        closeReply();
        onloadSession();

        // await msgrichEdit.NewDocumentAsync();
        await onloadTwoGrid();

        if (RTopicId == 0)
        {
            await LoadDataPosts();
        }
        else
        {
            await LoadReplyDataPosts();
        }

        WindowVisible = false;
        loading = false;

        StateHasChanged();
    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleUploadSuccess()
    {   

        FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);

        //MyUpload.RemoveAllFiles();
        ///SelectedFiles.Clear();
        await AnotherFunction();
        // await TriggerCancelIcon();
    }

    async Task OnButtonClick()
    {
        var FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);      
    }   
    private async Task TriggerCancelIcon()
    {      
        await JSRuntime.InvokeVoidAsync("myFunction()");
        await JSRuntime.InvokeVoidAsync("createToast(success)");
    }

    private async Task AnotherFunction()
    {
        await LoadData();

    }

    private void OpenFileUpload()
    {
        //uploadComponent.OpenFileDialog();
    }    
    public string GetDocUploadUrl(Guid? sId)
    {
        //var sessionId = Guid.NewGuid();

        //string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + sId + "&addedByUserId="+ AppUserId;
        return url.ToString();
    }
    public string GetUploadUrl()
    {
        //var sessionId = Guid.NewGuid();

        //string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + _sessionId + "&addedByUserId="+ AppUserId;
        return url.ToString();
    }
    private void closeUploadFiles()
    {
        isFileUpload = false;
        var lst = SelectedFilesCount;
    }
    private async Task UploadFiles()
    {
        //var lst = SelectedFilesCount;    

        byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false);


        string assignCCidsString = string.Join(",", _assigntoItems.Select(s => s.UserID).ToList());
        string assigntoidsString = string.Join(",", Data.AssigntoIds);

        var createReq = new CreateEmailCoversation
            {

                TopicID = (long.Parse(@SelectedGroup)),
                Message = Data.Message != null ? Data.Message : "Attachments",
                FileData = fileContent.Length == 480 ? myBytes : fileContent,
            //AssigntoIds = Data.AssigntoIds.Count() == 0 ? _assigntoItems.Select(s => s.UserID).ToList() : Data.AssigntoIds,
                AssigntoIdss = Data.AssigntoIds.Count() == 0 ? assignCCidsString : assigntoidsString,
            //FileData = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false),
                ParticipantId = applicationUser.UserID,
                ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = _sessionId
            };
        // _sessionId = createReq.SessionId;
        var result = await Mediator.Send(createReq);       
        isFileUpload = false;
        //uploadComponent.UploadAllFiles();
        var rls =   Task.Run(() => uploadComponent.UploadAllFiles());

        await Task.Delay(2000); // Delay for 2 seconds
        await LoadData();
        onRestText();
        closeReply();
        onloadSession();
        //HandleScroll("down");
        await msgrichEdit.NewDocumentAsync();
        //uploadComponent.UploadAllFiles();
    }
    public void ClearUploadedFiles()
    {
        if(uploadComponent != null)
        {
            uploadComponent.CancelAllFilesUpload();
        }

    }
    async Task OnFileUploaded(FileUploadEventArgs e)
    {
        var request = new EditDocumentCommand
            {
                AddedByUserId = _applicationUser.AddedByUserID,
                ModifiedByUserId = _applicationUser.ModifiedByUserID,
                SessionId = _employeeDatas.SessionId,
            };
        var response = await Mediator.Send(request);       
        await InvokeAsync(StateHasChanged);

    }
    private void onTopicClosedPop()
    {
        isTopicClosed = true;
    }
    private void onAddCategoryPop()
    {
        isTopicCategoryClosed = true;
    } 
    private void onArchivePop()
    {
        isArchiveClosed = true;
    }
    private void   AddPopupArchiveAll()
    {
        AddPopupArchive = true ;
    }
    private void showTopicDescription()
    {
        isDescription = true;
    }
    private void hideTopicDescription()
    {
        isDescription = false;
    }
    void onDueDatePop()
    {
        isDueDate = true;       
    }
    void onSubjectDueDatePop()
    {
        isSubjectDueDate = true;
        if(CurrentEmailConversations != null)
        {
            _dataSubjectDuDate.DueDate = CurrentEmailConversations.DueDate;
            _dataSubjectDuDate.NoOfDays = CurrentEmailConversations.NoOfDays;

            if (CurrentEmailConversations.DueDate.HasValue)
            {
                // minDueDate = CurrentEmailConversations.DueDate.Value;
            }


            if((applicationUser.UserID == CurrentEmailConversations.UserId) || _openAccessUserLink != null)
            {
                IsSubjectNoOfDays = true;
                if (CurrentEmailConversations != null)
                {
                    CurrentEmailConversations.IsLockDueDate = false;
                }                
            }             
            else 
            {
                IsSubjectNoOfDays = false;
            }
        }

    }
    async void onUserTagPop()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        UserTagTxt = null;
        _UserTagList = await Mediator.Send(new GetAllUserActivityCatgorys(applicationUser.UserID)); 

        var _getUserTag = await Mediator.Send(new GetByUserTage(long.Parse(@SelectedGroup), applicationUser.UserID));

        if(_getUserTag.Count > 0)
        {


            //  dataUserTag.UserTag = _getUserTag[0].UserTag;
            //  dataUserTag.UserTagId = _getUserTag[0].UserTagId;
            dataUserTag.UserTagIds = _getUserTag.Select(s => s.UserTagId).ToList();

        }
        else
        {
            dataUserTag.UserTag = null;
            dataUserTag.UserTagId = null;
            dataUserTag.UserTagIds = null;
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");

        isUserTagChange = true;
        StateHasChanged();        
    }
    void onCancelDueDatePop()
    {
        isCancelDueDate = true;
        if(CurrentEmailConversations != null)
        {
            _cancelSubjectName = CurrentEmailConversations.Name;
        }

        StateHasChanged();
    }
    void onRenameSubjectPop()
    {
        if(CurrentEmailConversations != null)
        {
            _dataSubjectName.SubjectName = CurrentEmailConversations.Name;
        }

        isRenameSubject = true;
        StateHasChanged();

    }
    async void onPrintMainTopic()
    {
        var url = BaseUrl + "ViewEmail/Emailprint/" + _headTopic[0].SessionId + "/" + isLeftMenuvisible;
        string script = $"window.open('{url}', '_blank');";
        await JSRuntime.InvokeVoidAsync("eval", script);
    }
    private void onNotifyWendy()
    {
        isNotifyWendypupVisible = true;
    }
    private void onNotifyPA()
    {
        isNotifyPAPopupVisible = true;
    }   
    async void onPrintSubjectPop()
    {    
        var url = BaseUrl+"ViewEmail/Emailprint/" + CurrentEmailConversations.SessionId;
        string script = $"window.open('{url}', '_blank');";
        await JSRuntime.InvokeVoidAsync("eval", script);
    }
    async void onCopylink()
    {
        var url = BaseUrl + "ViewEmail/" + CurrentEmailConversations.SessionId + "/Email";
        await ClipboardService.WriteTextAsync(url);
        toastService.ShowToast("Copied", AC.SD.Core.Services.ToastLevel.Info);
    }
    private async Task onBacklink()
    {
        var item = CurrentEmailConversations; 

        if (item.ActivityType == "FileProfileType")
        {
            onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId);
        }
        else if (item.ActivityType == "EmailFileProfileType")
        {
            onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId);
        }
        else if (item.ActivityType == "DynamicForm") 
        {
            onBackDynamicType(item.BackURL);
        }
        else
        {
            onBackActivity(item.BackURL);
        }

        StateHasChanged();

    }
    async void SubmitDueDate()
    {
        var UpdateReq = new UpdateEmailTopicDueDate
            {
            //ID = long.Parse(@SelectedGroup),
                ID = _headTopic[0].ID,
                DueDate = _dataDuDate.DueDate,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);
        if (result == 1)
        {
            isDueDate = false;
            onShowPopupMessage("success", "Updated DueDate Successfully");
        }
        else
        {

        }

    }
    async void SubmitUserTag()
    {
        // var usertag = dataUserTag;
        var UpdateReq = new CreateUserTagMultipleQuery
            {                
                UserTagIds = dataUserTag.UserTagIds,
            //UserTag = dataUserTag.UserTag,
                TopicId =_headTopic[0].ID,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now
            };
        var result = await Mediator.Send(UpdateReq);
        toastService.ShowToast("User Tag Updated Successfully.", AC.SD.Core.Services.ToastLevel.Success);
        // if(dataUserTag.UserTagId != null)
        // {

        //     var UpdateReq = new UpdateUserTag
        //     {                
        //         UserTagId = dataUserTag.UserTagId,
        //         //UserTag = dataUserTag.UserTag,
        //         UserTag = UserTagTxt,
        //         ModifiedByUserID = applicationUser.UserID,
        //         ModifiedDate = DateTime.Now
        //     };

        //     var result = await Mediator.Send(UpdateReq);
        //     if (result == 1)
        //     {
        //         isUserTagChange = false;
        //         onShowPopupMessage("success", "User Tag Updated Successfully");
        //     }            
        // }
        // else
        // {
        //     var UpdateReq = new CreateUserTag
        //         {
        //             TopicId = long.Parse(@SelectedGroup),
        //             //UserTag = dataUserTag.UserTag,
        //             UserTag = UserTagTxt,
        //             AddedByUserID = applicationUser.UserID,
        //             AddedDate = DateTime.Now
        //         };

        //     var result = await Mediator.Send(UpdateReq);
        //     if (result == 1)
        //     {
        //         isUserTagChange = false;
        //         onShowPopupMessage("success", "Added User Tag Successfully");
        //     }
        // }
        isUserTagChange = false;
        onloadTagsList();
        IsOpenFlyout = false;
        StateHasChanged(); 
    }

    async void SubmitSubjectDueDate()
    {       
        if(_openAccessUserLink != null)
        {
            await updateDueDate();
        }
        else if(applicationUser.UserID != CurrentEmailConversations.UserId)
        {
            if (CurrentEmailConversations.DueDate.HasValue)
            {

                DateTime actualDueDate = CurrentEmailConversations.DueDate.Value;

                if(CurrentEmailConversations.ExpiryDueDate != null)
                {
                    if (CurrentEmailConversations.ExpiryDueDate >= _dataSubjectDuDate.DueDate)
                    {
                        await updateDueDate();
                    }
                    else
                    {
                        onShowDueDatePopupMessage("Warning Info", "Please update the due date if you extend the deadline. If no action is taken within  (" + @Application.Common.Helper.Helper.FormatDate(CurrentEmailConversations.ExpiryDueDate) + ") days, contact your supervisor for guidance.");
                    }

                }
                else
                {
                    await updateDueDate();
                }


            }
            else
            {
                await updateDueDate();
            }

        }       
        else
        {
            await updateDueDate();
        }




        isSubjectDueDate = false;
        //onShowPopupMessage("success", "Updated DueDate Successfully");
        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }
        isOpenSubjectPop = false;
        StateHasChanged();
    }

    async Task updateDueDate()
    {
        var UpdateReq = new UpdateEmailTopicSubjectDueDate
                {
            //ID = long.Parse(@SelectedGroup),
                    ID = CurrentEmailConversations.ID,
                    TopicID = CurrentEmailConversations.TopicID,
                    NoOfDays = _dataSubjectDuDate.NoOfDays,
                    DueDate = _dataSubjectDuDate.DueDate,
                    UserId = CurrentEmailConversations.UserId,
                    ModifiedByUserID = applicationUser.UserID,
                    openAccessUserLink = _openAccessUserLink != null ? true :false,
                    IsDueDate = 1,
                    ModifiedDate = DateTime.Now
                };

        var result = await Mediator.Send(UpdateReq);


        //await sendreplymsg();

        isSubjectDueDate = false;
        //onShowPopupMessage("success", "Updated DueDate Successfully");
        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }
        isOpenSubjectPop = false;
        StateHasChanged();
    }


    private async Task sendreplymsg()
    {
        var cList = await Mediator.Send(new GetRequestEmailToCCList(CurrentEmailConversations.ID));        
        var duedate = _dataSubjectDuDate.DueDate;


        var participantIds = new List<long>();
        var AssigntoIdss = new List<long>();
        var AssignccIdss = new List<long>();

        if (cList.Count > 0)
        {
            var ToOnlyList = await Mediator.Send(new GetEmailToOnlyList(CurrentEmailConversations.ID));

            // if (cList[0].ToIds.HasValue)
            //     participantIds.Add(cList[0].ToIds.Value);

            if (long.TryParse(ToOnlyList[0].CcIds, out long toId))
            {
                participantIds.Add(toId);
            }

            if (long.TryParse(cList[0].CcIds, out long ccId))
            {
                participantIds.Add(ccId);
            }

            participantIds.Add(applicationUser.UserID);

            AssigntoIdss = ToOnlyList[0].CcIds != null ? ToOnlyList[0].CcIds.Split(',').Select(long.Parse).ToList() : new List<long>();
            AssignccIdss = cList[0].CcIds != null ? cList[0].CcIds.Split(',').Select(long.Parse).ToList() : new List<long>();
            // foreach(var id in AssignccIdss)
            // {
            //     AssigntoIdss.Add(id);
            // }

            // AssignccIdss = new List<long>();
        }
        else
        {
            var ToOnlyList = await Mediator.Send(new GetRequestEmailToOnlyList(CurrentEmailConversations.ID));


            if (ToOnlyList[0].ToIds.HasValue)
                participantIds.Add(ToOnlyList[0].ToIds.Value);

            if (long.TryParse(ToOnlyList[0].CcIds, out long ccId))
            {
                participantIds.Add(ccId);
            }

            participantIds.Add(applicationUser.UserID);

            AssigntoIdss = ToOnlyList[0].ToIds.HasValue ? new List<long> { ToOnlyList[0].ToIds.Value } : new List<long>();
            AssignccIdss = ToOnlyList[0].CcIds != null ? ToOnlyList[0].CcIds.Split(',').Select(long.Parse).ToList() : new List<long>();

        }


        var emailconlist = new EmailConversations
        {
            TopicID = CurrentEmailConversations.TopicID,
            AssigntoIds = AssigntoIdss,
            AssignccIds = AssignccIdss, 
            //Message = " Your request due date of (" + @Application.Common.Helper.Helper.FormatDate(_dataSubjectDuDate.DueDate) + ") has been successfully approved.",
                Message = "The due date has been changed to (" + @Application.Common.Helper.Helper.FormatDate(_dataSubjectDuDate.DueDate) + ").",
            // Message = $"Request Due Date: \"{Application.Common.Helper.Helper.FormatDate(_dataSubjectDuDate.DueDate)}\"<br/><br/>" +
            // "<strong>Reason:</strong><br/>" +
            // $"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{DuedateReason}",
            PlistIdss="",
            AllowPlistids = "",
            IsAllowParticipants= false,
            Urgent = false,
            ConIds = 0,
            ReplyId = CurrentEmailConversations.ID,
            AllParticipantIds = participantIds.Distinct().ToList(),
            ParticipantId = applicationUser.UserID,
            Name = CurrentEmailConversations.Name,
            AddedByUserID = applicationUser.UserID,
            From = "",
            LastName = "",
            UserCode = "",
            UserName = "",
            FirstName = "",
            UserEmail = "",
            IsDueDate = 2,
            FileData = new byte[0],
            FirebaseDocKey = "",

        };

        string BaseUrl = NavigationManager.BaseUri + "api/Email/";
        string url = BaseUrl + "OnSubmitReply";        
        string jsonData = System.Text.Json.JsonSerializer.Serialize(emailconlist);        
        var content = new StringContent(jsonData, Encoding.UTF8, "application/json");
        // Send the POST request with the content
        var response = await httpClient.PostAsync(url, content);
        var msg = response.StatusCode;

    }

    async void onSentDueDateRequest()
    {      

        //var lst = CurrentEmailConversations;
        var cList = await Mediator.Send(new GetRequestEmailToCCList(CurrentEmailConversations.ID));        
        var duedate = _dataSubjectDuDate.DueDate;


        var participantIds = new List<long>();
        var AssigntoIdss = new List<long>();
        var AssignccIdss = new List<long>();

        if (cList.Count > 0)
        {

            if (cList[0].ToIds.HasValue)
                participantIds.Add(cList[0].ToIds.Value);

            if (long.TryParse(cList[0].CcIds, out long ccId))
            {
                participantIds.Add(ccId);
            }

            participantIds.Add(applicationUser.UserID);

            AssigntoIdss = cList[0].ToIds.HasValue ? new List<long> { cList[0].ToIds.Value } : new List<long>();
            AssignccIdss = cList[0].CcIds != null ? cList[0].CcIds.Split(',').Select(long.Parse).ToList() : new List<long>();
            // foreach(var id in AssignccIdss)
            // {
            //     AssigntoIdss.Add(id);
            // }

            // AssignccIdss = new List<long>();
        }
        else
        {
            var ToOnlyList = await Mediator.Send(new GetRequestEmailToOnlyList(CurrentEmailConversations.ID));


            if (ToOnlyList[0].ToIds.HasValue)
                participantIds.Add(ToOnlyList[0].ToIds.Value);

            if (long.TryParse(ToOnlyList[0].CcIds, out long ccId))
            {
                participantIds.Add(ccId);
            }

            participantIds.Add(applicationUser.UserID);

            AssigntoIdss = ToOnlyList[0].ToIds.HasValue ? new List<long> { ToOnlyList[0].ToIds.Value } : new List<long>();
            AssignccIdss = ToOnlyList[0].CcIds != null ? ToOnlyList[0].CcIds.Split(',').Select(long.Parse).ToList() : new List<long>();

        }


        var emailconlist = new EmailConversations
        {
            TopicID = CurrentEmailConversations.TopicID,
            AssigntoIds = AssigntoIdss,
            AssignccIds = AssignccIdss,
            //  Message = "Requested Due Date(" + @Application.Common.Helper.Helper.FormatDate(_dataSubjectDuDate.DueDate) + "). Reason :" + DuedateReason,
                Message = $"Request Due Date: \"{Application.Common.Helper.Helper.FormatDate(_dataSubjectDuDate.DueDate)}\"<br/><br/>" +
                "<strong>Reason:</strong><br/>" +
                $"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{DuedateReason}",
            PlistIdss="",
            AllowPlistids = "",
            IsAllowParticipants= false,
            Urgent = false,
            ConIds = 0,
            ReplyId = CurrentEmailConversations.ID,
            AllParticipantIds = participantIds.Distinct().ToList(),
            ParticipantId = applicationUser.UserID,
            Name = CurrentEmailConversations.Name,
            AddedByUserID = applicationUser.UserID,
            From = "",
            LastName = "",
            UserCode = "",
            UserName = "",
            FirstName = "",
            UserEmail = "",
            IsDueDate = 1,
            FileData = new byte[0],
            FirebaseDocKey = "",

        };

        string BaseUrl = NavigationManager.BaseUri + "api/Email/";
        string url = BaseUrl + "OnSubmitReply";        
        string jsonData = System.Text.Json.JsonSerializer.Serialize(emailconlist);        
        var content = new StringContent(jsonData, Encoding.UTF8, "application/json");
        // Send the POST request with the content
        var response = await httpClient.PostAsync(url, content);
        var msg = response.StatusCode;



        var emailDueDateHistory = new InsertEmailDueDateHistory
        {
            ID = CurrentEmailConversations.ID,
            DueDate = _dataSubjectDuDate.DueDate,
            NoOfDays = _dataSubjectDuDate.NoOfDays,
            ModifiedByUserID = applicationUser.UserID,
            ModifiedDate = DateTime.Now,
            Reason = DuedateReason
        };

        var result = await Mediator.Send(emailDueDateHistory);


        if (RTopicId == 0)
        {
            await LoadDataPosts();
        }
        else
        {
            await LoadReplyDataPosts();
        }

        DueDateMessageVisible = false;
        DuedateReason = "";
        StateHasChanged();
    }

    async void SubmitCancelDueDate()
    {
        if((applicationUser.UserID == CurrentEmailConversations.UserId) || (applicationUser.UserID == CurrentEmailConversations.OnBehalf) || _openAccessUserLink != null)
        {
            var UpdateReq = new UpdateEmailTopicSubjectDueDate
            {
                //ID = long.Parse(@SelectedGroup),
                ID = CurrentEmailConversations.ID,
                TopicID = CurrentEmailConversations.TopicID,
                DueDate = null,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };
            var result = await Mediator.Send(UpdateReq);


            var emailDueDateHistory = new InsertEmailDueDateHistory
            {
                ID = CurrentEmailConversations.ID,
                DueDate = null,
                NoOfDays = 0,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now

            };

        }        
        else
        {
            onShowPopupMessage("Error", "Only the email initiator can make changes.");
        }




        isCancelDueDate = false;
        //onShowPopupMessage("success", "Updated DueDate Successfully");
        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }
        isOpenSubjectPop = false;
        StateHasChanged();
    }
    async void SubmitSubjectName()
    {
        var UpdateReq = new UpdateEmailSubjectName
            {
            //ID = long.Parse(@SelectedGroup),
                ID = CurrentEmailConversations.ID,
                TopicID = CurrentEmailConversations.TopicID,
                Name = _dataSubjectName.SubjectName,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);

        isRenameSubject = false;
        //onShowPopupMessage("success", "Updated DueDate Successfully");
        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }
        isOpenSubjectPop = false;



        if(isLeftMenuvisible == "AssignTo")
        {
            if(RefAssignTo != null)
            {
                await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
            }
        }

        if (isLeftMenuvisible == "All")
        {
            if(RefAssignAll != null)
            {
                await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
            }

        }


        StateHasChanged();
    }
    async void SubmitTopicClose()
    {
        var UpdateReq = new UpdateTopicClosed
            {
                ID = long.Parse(@SelectedGroup),
                Remarks = _dataTopicClose.Remarks,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };
        var result = await Mediator.Send(UpdateReq);   
        if(result == 1)
        {
            isTopicClosed = false;
            onShowPopupMessage("success", "Topic Closed Successfully");
        }
        else
        {

        }
    }

    private async Task SelectionChanged(TreeViewNodeEventArgs e)
    {
        SelectedGroup = e.NodeInfo?.Name;
        //_discussionList = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
        if(SelectedGroup != "0")
        {
            await LoadData();
        }
    } 
    private async void onSubViewEmailClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        //await Task.Delay(1000); // Example asynchronous operation
        onloadTagsList();
        await LoadReplyData();
        StateHasChanged();
    }    
    private async void onSubViewEmailSentClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();
    }
    private async void onSubViewEmailCCClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged(); 
    }
    private async void onSubViewEmailToClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();       
    }
    private async void onSubViewEmailAllClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();       
    }    
    private async void onViewEmailToClick(string ToTopicId)
    {
        SelectedGroup = ToTopicId;
        ClearDiscussionList();
        await LoadData();
        StateHasChanged();
    } 
    private async void EnableArchiveAll()
    {
        ArchiveEnabled = true;
        StateHasChanged();
    }
    private async void EnableUnArchiveAll()
    {
        UnArchiveEnabled = true;
        StateHasChanged();
    }
    private async void onViewEmailToClickMultiple(List<string> ToTopicId)
    {
        SelectedGroups = ToTopicId;
        await SubmitIsArchivedAll();
        StateHasChanged();
    } 
    private async void onViewEmailUnArchiveClick(List<string> ToTopicId)
    {
        SelectedGroups = ToTopicId;
        await UnArchiveAll();
        StateHasChanged();
    } 
    public async void SubmitunArchivedAll()
    {
        await RefMasterSearch.GetID();        
    }
    public  async Task UnArchiveAll()
    {
        foreach (var item in SelectedGroups)
        {
            var UpdateReq = new UpdateTopicUnArchive
            {
                    ID = long.Parse(item),
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };
            var result = await Mediator.Send(UpdateReq);
            toastService.ShowToast("UnArchive Updated successfully.", AC.SD.Core.Services.ToastLevel.Success);
            await RefMasterSearch.HandleValidSubmit();
            UnArchiveEnabled  = false;
        }
    }


    private async void onViewEmailAllClick(string ATopicId)
    {
        SelectedGroup = ATopicId;
        await LoadData();
        StateHasChanged();
    }    
    private async void onViewEmailCCClick(string CCTopicId)
    {
        SelectedGroup = CCTopicId;
        await LoadData();
        StateHasChanged();
    }
    private async void onViewEmailSentClick(string sentTopicId)
    {
        SelectedGroup = sentTopicId;
        await LoadData();
        StateHasChanged();
    }   
    private async void onSubViewEmailClick_old(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();
    }
    public async Task onPreview(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);       
        // var url = DocumentViewUrl+"?url="+FileUrl + _documents.FilePath;
        var url = DocumentViewUrl + "?url=" + _documents.UniqueSessionId;
        await OpenDocumentPreview(url);
    }
    private async Task OpenDocumentPreview(string url)
    {        
        await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    public async Task onPreview_old(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        string extension = Path.GetExtension(_documents.FilePath);



        if(extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
        {
            MyDocumentFormat = DocumentFormat.OpenXml;
            //documentContent = await File.ReadAllBytesAsync(response.FilePath);      
            var httpClient = new HttpClient();
            var responses = await httpClient.GetAsync(response.FilePath);
            documentContent = await responses.Content.ReadAsByteArrayAsync();
            PreviewDocPopup = true;
        }
        else if(extension.ToLower() == ".txt")
        {
            var url = FileUrl + response.FilePath;
            MyDocumentFormat = DocumentFormat.PlainText;
            //documentContent = await File.ReadAllBytesAsync(response.FilePath);          


            var httpClient = new HttpClient();
            var responses = await httpClient.GetAsync(response.FilePath);
            documentContent = await responses.Content.ReadAsByteArrayAsync();

            //documentContent = await File.ReadAllBytesAsync(fpaath);
            PreviewDocPopup = true;
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".jpeg" || extension.ToLower() == ".jpg" || extension.ToLower() == ".png" || extension.ToLower() == ".gif" || extension.ToLower() == ".bmp" || extension.ToLower() == ".svg")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else
        {
            onShowPopupMessage("Error", "Document format not supported.");
        }

        //var base_url = BaseUrl;
        //var file_url = FileUrl;

        //var filePath1 = BaseUrl + _documents.FilePath;
        //string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        // documentContent = await File.ReadAllBytesAsync(response.FilePath);

        //string filePathpdf = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";

        //await JSRuntime.InvokeVoidAsync("pdfInterop.renderPDF", "pdfInterop", filePathpdf);




        //await Task.Delay(10);       
        //await JSRuntime.InvokeVoidAsync("displayOfficeDocument", OfficeContainerRef, filePath);


    }   

    void OnCustomizeToolbar(IToolbar toolbar)
    {
        //// Returns the first group
        //IBarGroup firstGroup = toolbar.Groups[0];
        //// Returns the Table group
        //IBarGroup tableGroup = toolbar.Groups[RichEditToolbarGroupNames.Table];

        toolbar.Groups.Clear();

        // Inserts the File group at the first position in the group collection
        //toolbar.Groups.Add(0, RichEditToolbarGroupNames.File);
        toolbar.Groups.Add(0, RichEditToolbarGroupNames.Undo);
        toolbar.Groups.Add(1, RichEditToolbarGroupNames.Font);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Paragraph);
        toolbar.Groups.Add(3, RichEditToolbarGroupNames.Picture);
        toolbar.Groups.Add(4, RichEditToolbarGroupNames.Table);

        IBarGroup clipboardGroup = toolbar.Groups[1];
        clipboardGroup.Items.Add(5, RichEditBarItemNames.FontUnderline);
        clipboardGroup.Items.Add(6, RichEditBarItemNames.HighlightText);
        clipboardGroup.Items.Add(7, RichEditBarItemNames.ClipboardMenu);
        clipboardGroup.Items.Add(8, RichEditBarItemNames.ClearFormatting);
        clipboardGroup.Items.Add(9, RichEditBarItemNames.FontStrikeout);
        clipboardGroup.Items.Add(10, RichEditBarItemNames.FontScriptMenu);


        IBarGroup replace = toolbar.Groups[4];
        replace.Items.Add(1, RichEditBarItemNames.ChangeCaseMenu);
        replace.Items.Add(2, RichEditBarItemNames.Replace);


        IBarGroup undoRedoGroup = toolbar.Groups[0];
        undoRedoGroup.Items.Add(0, RichEditBarItemNames.FullScreen);

    }

    void OnContentRemoved(ContentRemovedEventArgs e)
    {
        // Handle the content removal event here
    }
    void OnSelectionChanged(Selection newSelection)
    {
        /* Surround the code that contains an asynchronous operation with a try-catch block to handle
        the OperationCanceledException. This exception is thrown when an asynchronous operation is canceled. */
        try
        {
            richSelection = newSelection;
            // Your code
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }

        StateHasChanged();
    }
    void OnmsgContentChanged(byte[] content)
    {

        try
        {
            msgContent = content;           
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }

        StateHasChanged();
    }
    async Task OnDocumentContentChanged(byte[] content)
    {

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        // string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        string filePath = response.FilePath;
        //string filePath = response.ServerFilePath;
        var urlss = FileUrl + _documents.FilePath;
        string extension = Path.GetExtension(response.FilePath);


        try
        {
            if (extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
            {
                MyDocumentFormat = DocumentFormat.OpenXml;
                documentContent = content;
                //await File.WriteAllBytesAsync(filePath, documentContent);                
            }
            else if (extension.ToLower() == ".txt")
            {                
                MyDocumentFormat = DocumentFormat.PlainText;
                documentContent = content;                
                //await File.WriteAllBytesAsync(filePath, documentContent);                
            }
            else if(extension.ToLower() == ".pdf")
            {
                var url = FileUrl + _documents.FilePath;
                await OpenUrlInNewTab(url);
            }
            else
            {
                onShowPopupMessage("error", "Document format not supported.");
            }

            //documentContent = content;
            //await File.WriteAllBytesAsync(filePath, documentContent);           
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    private async Task OpenUrlInNewTab(string url)
    {
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }
    public async Task onDocDownload(long Id)
    {
        _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup),applicationUser.UserID,isLeftMenuvisible)); 
        var lst =  _topicDocList?.FirstOrDefault(a => a.DocumentId == Id);

        if(lst != null)
        {
            //var url = DocumentViewUrl + "?url=" + FileUrl + lst.FilePath;
            var url = DocumentViewUrl + "?url=" + lst.UniqueSessionId;
            await OpenDocumentPreview(url);
        }

    }
    private string? audioBase64Source;
    private bool isAudioPopupVisible = false;
    private long? currentAudioId = null;

    public async Task onPlayAudio(long documentId)
    {
        // Close and reset if same audio clicked again
        if (currentAudioId == documentId && isAudioPopupVisible)
        {
            await ResetAudioPlayer();
            return;
        }

        // Close any other popups here if needed
        // e.g. isAnotherPopupOpen = false;

        var response = await Mediator.Send(new GetFileDownload(documentId));
        if (response.StatusCodeID == 0)
        {
            toastService.ShowToast("Audio not found", AC.SD.Core.Services.ToastLevel.Error);
            return;
        }

        audioBase64Source = $"data:audio/wav;base64,{Convert.ToBase64String(response.ImageData)}";
        currentAudioId = documentId;
        isAudioPopupVisible = true;
    }

    private Task ResetAudioPlayer()
    {
        isAudioPopupVisible = false;
        audioBase64Source = null;
        currentAudioId = null;
        return Task.CompletedTask;
    }
    public async Task onDocDownload_old(long Id)
    {
        _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup), applicationUser.UserID, isLeftMenuvisible));
        var lst =  _topicDocList?.FirstOrDefault(a => a.DocumentId == Id);

        // var url = FileUrl + lst.FilePath;
        // await OpenUrlInNewTab(url);


        var response = await Mediator.Send(new GetFileDownload(Id));
        if (response.StatusCodeID == 0)
        {
            toastService.ShowToast("File Not Exits", AC.SD.Core.Services.ToastLevel.Error);
        }
        else
        {
            //  Trigger file download
            await JSRuntime.InvokeVoidAsync("downloadFile", lst.FileName, response.ImageData, "");
        }


    }
    public async Task onDocDelete(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);
        DocPopupVisible = true;
    }
    private async void assignedList(long Id)
    {
        _conversationAssignTo = await Mediator.Send(new GetEmailConversationAssignTo(Id));
        if (_conversationAssignTo.Count > 0)
        {
            isAssignToVisible = true;
        }
        else
        {
            toastService.ShowToast("No data found", AC.SD.Core.Services.ToastLevel.Error);
            //isAssignToVisible = false;
        }
    }
    private async Task SubmitIsArchived()
    {       


        if (string.IsNullOrEmpty(_headTopic[0].UserType) || _headTopic[0].UserType == "Users")
        {
            var UpdateReq = new UpdateTopicArchive
                {
                    ID = long.Parse(@SelectedGroup),
                    ModifiedByUserID = applicationUser.UserID,
                    ModifiedDate = DateTime.Now
                };
            var result = await Mediator.Send(UpdateReq);

        }
        else
        {

        }



        isArchiveClosed = false;
        //await LoadData();
        toastService.ShowToast("Archive Updated successfully.", AC.SD.Core.Services.ToastLevel.Success);
        //await JSRuntime.InvokeAsync<string>("ReloadUrl");

        if (isLeftMenuvisible == "AssignTo")
        {
            await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
        }

        if (isLeftMenuvisible == "All")
        {
            await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
        }

        IsOpenFlyout = false;
        _discussionList = new List<EmailConversations>();
        _headTopic = new List<EmailTopics>();
        isComponentVisible = false;

        await RefreshService.RequestRefreshAsync();
        StateHasChanged();
    }
    private async Task Submit()
    {
        await RefAssignTo.GetID();
    }
    private async Task SubmitIsArchivedAll()
    {
        if (SelectedGroups == null || SelectedGroups.Count == 0)
        {
            toastService.ShowToast("No topics selected for archiving.", AC.SD.Core.Services.ToastLevel.Warning);
            return;
        }

        foreach (var item in SelectedGroups)
        {
            if (string.IsNullOrWhiteSpace(item))
                continue;

            var updateReq = new UpdateTopicArchive
            {
                ID = long.Parse(item),
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

            var result = await Mediator.Send(updateReq);

            isArchiveClosed = false;

            toastService.ShowToast("Archive Updated successfully.", AC.SD.Core.Services.ToastLevel.Success);

            if (isLeftMenuvisible == "AssignTo")
            {
                await RefAssignTo.onAssignToGridRefresh(long.Parse(item));
            }

            if (isLeftMenuvisible == "All")
            {
                await RefAssignAll.onAssignAllGridRefresh(long.Parse(item));
            }

            // Resetting state
            IsOpenFlyout = false;
            _discussionList = new List<EmailConversations>();
            _headTopic = new List<EmailTopics>();
            isComponentVisible = false;
            AddPopupArchive = false;
            ArchiveEnabled = false;
        }

        await RefreshService.RequestRefreshAsync();
        StateHasChanged();
    }

    private async Task SubmitDocDelete(long Id)
    {
        if (Id > 0)
        {
            var request = new DeleteDoc(Id);

            var response = await Mediator.Send(request);
            DocPopupVisible = false;
            isAllPlistVisible = false;
            await loadTopicDocList();
            toastService.ShowToast("Document has been deleted successfully.", AC.SD.Core.Services.ToastLevel.Success);
            //onShowPopupMessage("success", "Document has been deleted successfully");
        }
    }

    private async void onShowPopupMessage(string headerText, string bodyText)
    {
        MessageVisible = true;
        MessageBody = bodyText;
        MessageHeader = headerText;
        loading = false;
        StateHasChanged();
    }
    private async void onShowDueDatePopupMessage(string headerText, string bodyText)
    {
        DueDateMessageVisible = true;
        DueDateMessageBody = bodyText;
        DueDateMessageHeader = headerText;
        loading = false;
        StateHasChanged();
    }
    void ClosePopup()
    {
        PopupVisible = false;
        DocPopupVisible = false;
        isArchiveClosed = false;
    }

    private async Task ToggleItemVisibilityold(int id)
    {

        _replyDiscussionList = await Mediator.Send(new GetOnReplyDiscussionList(id, applicationUser.UserID));

        if (itemVisibility.ContainsKey(id))
        {
            itemVisibility[id] = !itemVisibility[id];
        }
        else
        {
            itemVisibility.Add(id, true);
            //await Task.Delay(5000);
            //await onMarkasAllRead(id);
        }
    }
    private async Task ToggleItemVisibility1(int id)
    {
        // Close all other items
        foreach (var key in itemVisibility.Keys.ToList())
        {
            itemVisibility[key] = false;
        }

        // Fetch the discussion list for the clicked item
        _replyDiscussionList = await Mediator.Send(new GetOnReplyDiscussionList(id, applicationUser.UserID));

        // Toggle the visibility of the clicked item
        if (itemVisibility.ContainsKey(id))
        {
            itemVisibility[id] = !itemVisibility[id];
        }
        else
        {
            itemVisibility.Add(id, true);
        }
    }
    void ToggleContent(long id)
    {
        IsContentVisible = !IsContentVisible;

        if (copyitemVisibility.ContainsKey(id) && copyitemVisibility[id])
        {
            // If it's open, close it
            copyitemVisibility[id] = false;
        }
        else
        {
            // Close all other items
            foreach (var key in copyitemVisibility.Keys.ToList())
            {
                copyitemVisibility[key] = false;
            }

            // await JSRuntime.InvokeAsync<string>("showLoading");
            // _replyDiscussionList = await Mediator.Send(new GetOnReplyDiscussionList(id, applicationUser.UserID));
            // await JSRuntime.InvokeAsync<string>("hideLoading");

            // Open the clicked item
            copyitemVisibility[id] = true;
        }
    }
    private async Task ToggleItemVisibility(int id, int replycount)
    {
        reply_id = id;
        reply_tcount = replycount;
        if (itemVisibility.ContainsKey(id) && itemVisibility[id])
        {
            // Hide the clicked item
            itemVisibility[id] = false;
        }
        else
        {
            // Close all
            foreach (var key in itemVisibility.Keys.ToList())
            {
                itemVisibility[key] = false;
            }

            currentPage = 1;
            hasMore = true;

            replyDiscussions[id] = new List<EmailConversations>();
            currentPages[id] = 1;

            await JSRuntime.InvokeAsync<string>("showLoading");
            await LoadMoreReplies(id, replycount); // first page
            await JSRuntime.InvokeAsync<string>("hideLoading");


            // if (!replyDiscussions.ContainsKey(id))
            // {
            //     replyDiscussions[id] = new List<EmailConversations>();
            //     currentPages[id] = 1;
            //     await JSRuntime.InvokeAsync<string>("showLoading");
            //         await LoadMoreReplies(id, replycount); // first page
            //     await JSRuntime.InvokeAsync<string>("hideLoading");
            // }

            itemVisibility[id] = true;
        }
    }


    private async Task ToggleItemVisibilityv(int id)
    {
        reply_id = id;
        // Check if the clicked item is already open
        if (itemVisibility.ContainsKey(id) && itemVisibility[id])
        {
            // If it's open, close it
            itemVisibility[id] = false;
        }
        else
        {
            // Close all other items
            foreach (var key in itemVisibility.Keys.ToList())
            {
                itemVisibility[key] = false;
            }

            if (_replyDiscussionList != null)
            {
                _replyDiscussionList.Clear();
                _replyDiscussionList = null;
            }

            await JSRuntime.InvokeAsync<string>("showLoading");
            //await LoadMoreReplies(id);
            //_replyDiscussionList = await Mediator.Send(new GetOnReplyDiscussionList(id, applicationUser.UserID));
            await JSRuntime.InvokeAsync<string>("hideLoading");

            // Open the clicked item
            itemVisibility[id] = true;
        }
    }


    private async Task onMarkasAllRead(int Id)
    {        
        var request = await Mediator.Send(new UpdateMarkasAllRead(Id,applicationUser.UserID));


        if (RTopicId == 0)
        {
            if (reply_id == 0)
            {
                await LoadData();
            }
            else
            {
                await replyslst();
            }


        }
        else
        {
            if (reply_id == 0)
            {
                await LoadReplyData();
            }
            else
            {
                await replyslst();
            }
        }


        isOpenSubjectPop = false;        

        if(isLeftMenuvisible == "AssignTo")
        {
            if(RefAssignTo != null)
            {
                await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
            }

        }

        if (isLeftMenuvisible == "All")
        {
            if(RefAssignAll != null)
            {

            }

        }

        await RefreshService.RequestRefreshAsync();
        StateHasChanged();
    }
    private void ToggleDocItemVisibility(int id)
    {
        if (DocitemVisibility.ContainsKey(id))
        {
            DocitemVisibility[id] = !DocitemVisibility[id];
        }
        else
        {
            DocitemVisibility.Add(id, true);
        }
    }
    private List<string> data;

    private async Task loadSubTopicDocList()
    {
        var conId = SelectedReplyId;

        if (long.Parse(@SelectedGroup) > 0)
        {
            //await JSRuntime.InvokeAsync<string>("showLoading");
            _topicDocList = await Mediator.Send(new GetSubEmailTopicDocList(long.Parse(@SelectedReplyId)));


            var selectedDocumentIds = _topicDocList.Where(x => x.ReplaceDocumentId != 0).Select(x => x.DocumentId);
            string commaSeparatedIds = string.Join(",", selectedDocumentIds);

            if (!string.IsNullOrEmpty(commaSeparatedIds))
            {
                _OnFileReplaceList = await Mediator.Send(new GetByUniqueDocument(commaSeparatedIds));
            }
            else
            {
                _OnFileReplaceList = new List<Documents>();

            }




            //_OnFileReplaceList = new List<Documents> { await Mediator.Send(new GetByUniqueDocument(commaSeparatedIds)) };


            //await JSRuntime.InvokeAsync<string>("hideLoading");


            if (_topicDocList.Count > 0)
            {
                _selectlst = _topicDocList.FirstOrDefault();
                //EditEnabled = true;
                //DeleteEnabled = true;
                PreviewEnabled = true;
                docEnabled = true;                
                StateHasChanged();
            }
            else
            {                
                PreviewEnabled = false;
                docEnabled = false;
            }
        }
    }
    private async Task loadTopicDocList()
    {        
        if(long.Parse(@SelectedGroup) > 0)
        {
            //await JSRuntime.InvokeAsync<string>("showLoading");
            _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup), applicationUser.UserID, isLeftMenuvisible));
            //await JSRuntime.InvokeAsync<string>("hideLoading");



            var selectedDocumentIds = _topicDocList.Where(x => x.ReplaceDocumentId != 0).Select(x => x.DocumentId);
            string commaSeparatedIds = string.Join(",", selectedDocumentIds);

            if (!string.IsNullOrEmpty(commaSeparatedIds))
            {
                _OnFileReplaceList = await Mediator.Send(new GetByUniqueDocument(commaSeparatedIds));
            }
            else
            {
                _OnFileReplaceList = new List<Documents>();

            }




            if (_topicDocList.Count > 0)
            {
                _selectlst = _topicDocList.FirstOrDefault();
                //EditEnabled = true;
                //DeleteEnabled = true;
                PreviewEnabled=true;
                docEnabled = true;                
                StateHasChanged();
            }
            else
            {                
                PreviewEnabled=false;
                docEnabled = false;
            }
        }

    }  
    public async void onloadTagsList()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        _headTopic = await Mediator.Send(new GetByIdEmailTopics(long.Parse(@SelectedGroup)));
        _headTopic_Tag = await Mediator.Send(new GetAllTopicCategory(long.Parse(@SelectedGroup)));
        _headTopic_UserTag = await Mediator.Send(new GetByUserTage(long.Parse(@SelectedGroup),applicationUser.UserID));
        await JSRuntime.InvokeAsync<string>("hideLoading");
        StateHasChanged();
    }

    private async Task LoadData()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();

        RTopicId = 0;
        Tid = long.Parse(@SelectedGroup);
        var getconid = await Mediator.Send(new GetTopConversationList(Tid));       
        Cid = 0;
        SelectedReplyId = getconid[0].ID.ToString();
        //_discussionList = await Mediator.Send(new GetEmailDiscussionList(long.Parse(@SelectedGroup),applicationUser.UserID,isLeftMenuvisible));
        //_discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(long.Parse(@SelectedGroup)));

        //_assigntoItems = await Mediator.Send(new GetEmailAssignToList(long.Parse(@SelectedGroup))); 
        //var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
        //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
        //var topicToList = await Mediator.Send(new GetEmailTopicToList(long.Parse(@SelectedGroup)));

        //var ck_validuser = await Mediator.Send(new GetEmailValidUserList(long.Parse(@SelectedGroup), applicationUser.UserID));
        //IsValidUser = false;
        //IsFileValidUser = false;


        //if (topicToList != null)
        //{            
        //    Data.AssigntoIds = new List<long>();
        //}       


        await OnMenuItemClick(isMenuvisible);


        if (isMenuvisible == "AddParticipants")
        {
            await  OnMenuItemClick("Posts");
            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicPlist_Data();
            }
            else //sub topic click
            {
                await LoadPlist_Data();
            }            
        }
        else if (isMenuvisible == "AddGroupParticipants")
        {
            await OnMenuItemClick("Posts");
            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicGroupPlist_Data();
            }
            else //sub topic click
            {
                await LoadGroupPlist_Data();
            }
        }
        else if(isMenuvisible == "Tags")
        {
            await OnMenuItemClick("Posts");
            await loadTags_Data();
        }
        else if(isMenuvisible == "Todo")
        {

            await OnMenuItemClick("Posts");
            await loadTodo_Data();

        }
        else if (isMenuvisible == "Files")
        {

            await OnMenuItemClick("Posts");


        }


        if(long.Parse(@SelectedGroup) != 0)
        {
            _headTopic = await Mediator.Send(new GetByIdEmailTopics(long.Parse(@SelectedGroup)));            
            _headTopic_Tag = await Mediator.Send(new GetAllTopicCategory(long.Parse(@SelectedGroup)));
            _headTopic_UserTag = await Mediator.Send(new GetByUserTage(long.Parse(@SelectedGroup), applicationUser.UserID));
            isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

            isEnabled = true;
            isTodoEnabled = false;
            isTagEnabled = true;
            isEllipsis = true;
            isCommand = true;
            IsConHistory = true;            
        }

        //await JSRuntime.InvokeAsync<string>("hideLoading");       

    }
    private async Task LoadReplyData()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        IsFileValidUser = true;        
        Cid = long.Parse(@SelectedReplyId);
        Tid = RTopicId;


        await OnMenuItemClick(isMenuvisible);


        if (isMenuvisible == "AddParticipants")
        {
            await  OnMenuItemClick("Posts");
            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicPlist_Data();
            }
            else //sub topic click
            {
                await LoadPlist_Data();
            }

        }
        else if (isMenuvisible == "AddGroupParticipants")
        {
            await OnMenuItemClick("Posts");
            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicGroupPlist_Data();
            }
            else //sub topic click
            {
                await LoadGroupPlist_Data();
            }
        }
        else if(isMenuvisible == "Todo")
        {
            await OnMenuItemClick("Posts");
            await loadTodo_Data();

        }
        else if (isMenuvisible == "Files")
        {

            await OnMenuItemClick("Posts");


        }
        else if(isMenuvisible == "Tags")
        {
            await OnMenuItemClick("Posts");

        }
        var ConversationList = await Mediator.Send(new GetEmailConversationList(Cid));

        _headTopic = await Mediator.Send(new GetByIdEmailTopics(RTopicId));

        if(_headTopic.Count > 0)
        {
            _headTopic[0].TopicName = ConversationList[0].Name;
            _headTopic[0].AddedDate = ConversationList[0].AddedDate;
            isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;
        }



        isEnabled = true;
        isTodoEnabled = true;
        isTagEnabled = true;
        isEllipsis = true;
        isCommand = true;
        // _participant = await Mediator.Send(new GetEmailParticipantsList(RTopicId));


        IsConHistory = false;
        //await JSRuntime.InvokeAsync<string>("hideLoading");      
        await InvokeAsync(StateHasChanged);

    }
    private async Task LoadDataPosts()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();
        if(@SelectedGroup != "none")
        {
            if (long.Parse(@SelectedGroup) > 0)
            {
                Tid = long.Parse(@SelectedGroup);
                var getconid = await Mediator.Send(new GetTopConversationList(Tid));

                if (string.IsNullOrEmpty(getconid[0].UserType) || getconid[0].UserType == "Users")
                {
                    isUserGroup = true;
                }
                else
                {
                    isUserGroup = false;
                }

                Cid = 0;
                _discussionList = await Mediator.Send(new GetEmailDiscussionList(long.Parse(@SelectedGroup), applicationUser.UserID, isLeftMenuvisible));
                //_discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(long.Parse(@SelectedGroup)));

                foreach (var discussion in _discussionList)
                {
                    await LoadAllRepliesForDiscussions(discussion);
                }

                _assigntoItems = await Mediator.Send(new GetEmailAssignToList(long.Parse(@SelectedGroup)));
                var topicToList = await Mediator.Send(new GetEmailTopicToList(long.Parse(@SelectedGroup)));
                if (topicToList != null)
                {

                    Data.AssigntoIds = new List<long>();
                }


                if(_headTopic != null)
                {
                    //isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;
                }


                isEnabled = true;
                isTodoEnabled = false;
                isEllipsis = true;
                isCommand = true;
                isNewSubject = true;


            }

        }

        await JSRuntime.InvokeAsync<string>("hideLoading");

        await InvokeAsync(StateHasChanged);

    }
    private async Task LoadReplyDataPosts()
    {        
        await JSRuntime.InvokeAsync<string>("showLoading");
        isNewSubject = false;
        closeReply();
        Cid = long.Parse(@SelectedReplyId);
        Tid = RTopicId;
        await JSRuntime.InvokeAsync<string>("showLoading");
        _discussionList = await Mediator.Send(new GetEmailReplyDiscussionList(long.Parse(@SelectedReplyId), applicationUser.UserID));


        if (_discussionList != null && _discussionList.Count > 0)
        {
            totalReplyCount = _discussionList[0].ReplyConversationCount;
        }
        else
        {
            totalReplyCount = 0; // or handle accordingly (e.g., show a message)
        }

        ReplyList = new List<EmailConversations>();
        currentPage = 1;

        //await LoadMoreReplies();

        foreach (var discussion in _discussionList)
        {
            await LoadAllRepliesForDiscussions(discussion);
        }


        if(_discussionList.Count > 0)
        {

            if (string.IsNullOrEmpty(_discussionList[0].UserType) || _discussionList[0].UserType == "Users")
            {
                isUserGroup = true;
            }
            else
            {
                isUserGroup = false;
            }


            IsValidUser = (_discussionList[0].AddedByUserID == applicationUser.UserID || _discussionList[0].OnBehalf == applicationUser.UserID) ? true : false;
        } 

        //_discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(RTopicId));

        _assigntoItems = await Mediator.Send(new GetEmailAssignToList(RTopicId));
        var topicToList = await Mediator.Send(new GetEmailTopicToList(RTopicId));
        if (topicToList != null)
        {
            //Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
        }

        if(_headTopic != null)
        {
            //isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;
        }


        isEnabled = true;
        isTodoEnabled = true;
        isTagEnabled = true;
        isEllipsis = true;
        isCommand = true;
        //_participant = await Mediator.Send(new GetEmailParticipantsList(RTopicId));

        await JSRuntime.InvokeAsync<string>("hideLoading");

        await InvokeAsync(StateHasChanged);



    }
    private async Task LoadMoreReplies()
    {
        isLoading = true;

        var moreReplies = await Mediator.Send(new GetReplyListPaged(long.Parse(@SelectedReplyId), applicationUser.UserID, currentPage, replypageSize));
        if (moreReplies != null)
        {
            ReplyList.AddRange(moreReplies);
            currentPage++;
        }

        isLoading = false;
    }

    private async Task LoadAllRepliesForDiscussions(EmailConversations discussion)
    {
        if (discussion == null) return;

        discussion.IsRepliesLoading = true; // You can add this property in the model if needed

        // Default values, or store per discussion
        if (discussion.CurrentPage == 0) discussion.CurrentPage = 1;

        var moreReplies = await Mediator.Send(new GetReplyListPaged(
            discussion.ID, applicationUser.UserID, discussion.CurrentPage, replypageSize));

        if (moreReplies != null)
        {
            if (discussion.ReplyConversation == null)
                discussion.ReplyConversation = new List<EmailConversations>();

            discussion.ReplyConversation.AddRange(moreReplies);
            discussion.CurrentPage++;
        }

        discussion.IsRepliesLoading = false;
    }



    void OnSelectedDataItemsChanged(IReadOnlyList<object> selectedDataItems)
    {
        SelectedDataItems = selectedDataItems;
    }

    async Task OnEmailToRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ID");       
        SelectedGroup = UniqueId.ToString();
        await LoadData();
        StateHasChanged();
    }   
    async Task OnDocumentLoaded1()
    {        
        await JSRuntime.InvokeVoidAsync("setFontSize", "editor-box-height", 24);
    }
    async Task OnDocumentLoaded(DevExpress.Blazor.RichEdit.Document document)
    {        
        await document.ChangeDefaultCharacterPropertiesAsync(properties =>
        {
            // properties.FontName = "Times New Roman";
            properties.FontSize = 12;
        });
    }
    private void OnWindowDragCompleted()
    {
        // Handle drag completed event if needed
        //msgrichEdit.NewDocumentAsync();
        IsUserGroupCCOpen = false;
        IsUserGroupToOpen = false;
    }

    async Task onRichTxtChangeFontsize()
    {
        if (msgrichEdit == null)
        {

        }
        else
        {
            await msgrichEdit.NewDocumentAsync();
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");
        StateHasChanged(); // Force a UI update
    }
    async Task onRichTxtChangeFontsizeold()
    {
        if (msgrichEdit == null)
        {
            // Handle or log null reference error
            return;
        }

        await msgrichEdit.NewDocumentAsync();

        if (JSRuntime != null)
        {
            await JSRuntime.InvokeAsync<string>("hideLoading");
        }
        else
        {
            // Handle or log null reference error
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");
    }

    protected override async void OnInitialized()
    {
        plist = await Mediator.Send(new GetAllEmployeeListQuery());        
        await InvokeAsync(StateHasChanged);
        //NavigationManager.LocationChanged += OnLocationChanged;

    }    
    void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        StateHasChanged();
    }
    protected override async Task OnParametersSetAsync()
    {
        _editContext = new EditContext(_dataFileProfileType);   

        Page = Page == null ? "AssignTo" : Page;

        var sss = ActiveSessionId;      
        ProductActivityBaseUrl = Configuration["DocumentsUrl:APP_Product_Activity"];        
        cancellationTokenSource = new CancellationTokenSource();        

        BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        FileUrl = Configuration["DocumentsUrl:FileUrl"];
        DocumentViewUrl = Configuration["DocumentsUrl:DocumentViewer"];

        onloadSession();
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _openAccessUserLink = await Mediator.Send(new GetEmailAccessByUser(applicationUser.UserID));
        AppUserId = applicationUser.UserID;
        // await JSRuntime.InvokeAsync<string>("showLoading");

        filterrowname = "";
        if(Page == "Todo") 
        {
            var page = Page;
            isPage = true;
            var todolist = await Mediator.Send(new GetByToDoSessionId(TodoSessionId));
            if(todolist.Count > 0)
            {
                string ridds = todolist[0].TopicId.ToString();

                ActiveTabIndex = 3;
                MyDayFilterText = todolist[0].SubjectName;
                FilterSessionId = todolist[0].TopicSessionId; 
                // var lsts = await Mediator.Send(new GetListByConversationSession(TopicSessionId.ToString()));
                //   if (lsts.Count > 0)
                //   {
                //     FilterSessionId = lsts[0].SessionId;
                //   }

                OnLeftMenuItemClick("Library");
                isLeftMenuvisible = "Library";                
                //await Task.Delay(2000); // Delay for 2 seconds                
                onSubViewEmailClick(ridds);
            }
        }
        else if(Page == "Email")
        {
            var page = Page;
            isPage = true;
            string sessionidString = TodoSessionId.ToString();            
            var lsts = await Mediator.Send(new GetListByConversationSession(sessionidString));
            if (lsts.Count > 0)
            {
                string ridds = lsts[0].ID.ToString();
                ActiveTabIndex = 3;
                MyDayFilterText = lsts[0].Name;
                FilterSessionId = lsts[0].SessionId;
                OnLeftMenuItemClick("Library");
                isLeftMenuvisible = "Library";                
                await Task.Delay(2000); // Delay for 2 seconds
                onSubViewEmailClick(ridds);
            }
        }
        else if(Page == "MyDayEmail")
        {
            var page = Page;
            isPage = true;
            string sessionidString = TodoSessionId.ToString();            
            var lsts = await Mediator.Send(new GetListByConversationSession(sessionidString));
            if (lsts.Count > 0)
            {
                string ridds = lsts[0].ID.ToString();
                ActiveTabIndex = 3;
                MyDayFilterText = lsts[0].Name;
                FilterSessionId = lsts[0].SessionId;
                OnLeftMenuItemClick("Library");
                isLeftMenuvisible = "Library";                
                //await Task.Delay(2000); // Delay for 2 seconds
                onSubViewEmailClick(ridds); 

                //onViewEmailAllClick(lsts[0].TopicID.ToString()); 
            }
        }
        else
        {      
            if (ActiveSessionId != null)
            {
                var lsts = await Mediator.Send(new GetListBySession(ActiveSessionId));
                if (lsts.Count > 0)
                {
                    SelectedGroup = lsts[0].ID.ToString();
                    RTopicId = 0;
                    filterrowname = ActiveSessionId;

                    ActiveTabIndex = 3;                      
                    //OnLeftMenuItemClick("Library");
                    isLeftMenuvisible = "Library";
                    MyDayFilterText = lsts[0].TopicName;
                    //await Task.Delay(2000); // Delay for 2 seconds
                     FilterSessionId = lsts[0].SessionId;

                    _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID, "NULL", pageNumber, pageSize));
                    _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
                    _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID,"NULL"));
                    _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));

                    await LoadData();
                    OnLeftMenuItemClick("Library");
                    
                }
                else
                {
                    var elst = await Mediator.Send(new GetListBySession(ActiveSessionId));

                    SelectedGroup = elst[0].ID.ToString();
                    RTopicId = 0;

                    _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL", pageNumber, pageSize));
                    _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
                    _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID,"NULL"));
                    _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));


                    await LoadData();

                    //if (long.Parse(@SelectedGroup) > 0)
                    //{
                    //    _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID));
                    //    _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID));
                    //    _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID));
                    //    _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
                    //}

                }

            }
            else
            {
                //_forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL", pageNumber, pageSize));
                //_forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
                //_forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID, "NULL"));
                //_topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
            }
        }


        // await JSRuntime.InvokeAsync<string>("hideLoading");
        //_discussionList = await Mediator.Send(new GetDiscussionList(38));


    }

    private async Task RefreshGridData()
    {
        // Perform the logic to refresh your grid data
        // For example, you can re-fetch the data from the server
        await LoadGridData();
        StateHasChanged();
    }
    private async Task LoadGridData()
    {
        _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL", pageNumber, pageSize));
        //_forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
        //_forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID, "NULL"));
        //_topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
    }
    public async ValueTask DisposeAsync()
    {

        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();        

        if (RefAssignAll is IAsyncDisposable asyncDisposableRefAssignAll)
        {
            await asyncDisposableRefAssignAll.DisposeAsync();
        }
        else
        {
            RefAssignAll?.Dispose();
        }

        if(RefTransferEamil is IAsyncDisposable asyncDisposableRefTransferEamil)
        {
            await asyncDisposableRefTransferEamil.DisposeAsync();
        }
        else
        {
            RefTransferEamil?.Dispose();
        }

        if (RefAssignTo is IAsyncDisposable asyncDisposableRefAssignTo)
        {
            await asyncDisposableRefAssignTo.DisposeAsync();
        }
        else
        {
            RefAssignTo?.DisposeAsync();
        }

        if (RefMasterSearch is IAsyncDisposable asyncDisposableRefMasterSearch)
        {
            await asyncDisposableRefMasterSearch.DisposeAsync();
        }
        else
        {
            RefMasterSearch?.Dispose();
        }

        if (RefAdminSearch is IAsyncDisposable asyncDisposableRefAdminSearch)
        {
            await asyncDisposableRefAdminSearch.DisposeAsync();
        }
        else
        {
            RefAdminSearch?.Dispose();
        }

        //GC.Collect();
        //GC.SuppressFinalize(this);

        //subscription?.Dispose();
    }

    // protected virtual void Dispose(bool disposing)
    // {
    //     if (disposing)
    //     {
    //         // Dispose disposable objects here
    //         cancellationTokenSource?.Cancel();
    //         cancellationTokenSource?.Dispose();
    //         // _treeFilterDocView?.Dispose();
    //         // richEdit?.Dispose();
    //         // msgrichEdit?.Dispose();
    //         // MyUpload?.Dispose();

    //         try
    //         {
    //             // Attempt to dispose of components
    //             (richEdit as IDisposable)?.Dispose();
    //             (msgrichEdit as IDisposable)?.Dispose();
    //             (MyUpload as IDisposable)?.Dispose();
    //         }
    //         catch (Exception ex)
    //         {
    //             // Handle any exceptions that might occur during disposal
    //             Console.WriteLine($"Disposal error: {ex.Message}");
    //         }

    //         // Dispose of any other objects if necessary
    //         RefTopicAddPList?.Dispose();
    //         RefTopicAddGroupPList?.Dispose();
    //         RefAssignTo?.Dispose();
    //         RefAssignAll?.Dispose();
    //         RefTopicTagList?.Dispose();
    //         RefTopicTodo?.Dispose();
    //         RefEmailDoc?.Dispose();
    //         RefMasterSearch?.Dispose();
    //         RefAdminSearch?.Dispose();
    //     }
    // }

    // void IDisposable.Dispose()
    // {
    //     Dispose(true);
    //     GC.SuppressFinalize(this);
    // }

    protected virtual async ValueTask DisposeAsyncCore()
    {
        if (cancellationTokenSource != null)
        {
            cancellationTokenSource.Cancel();
            cancellationTokenSource.Dispose();
            cancellationTokenSource = null;
        }

        try
        {
            // Dispose asynchronously of components
            if (richEdit is IAsyncDisposable asyncRichEdit)
                await asyncRichEdit.DisposeAsync();
            else
                (richEdit as IDisposable)?.Dispose();

            if (msgrichEdit is IAsyncDisposable asyncMsgrichEdit)
                await asyncMsgrichEdit.DisposeAsync();
            else
                (msgrichEdit as IDisposable)?.Dispose();

            if (MyUpload is IAsyncDisposable asyncMyUpload)
                await asyncMyUpload.DisposeAsync();
            else
                (MyUpload as IDisposable)?.Dispose();
        }
        catch (Exception ex)
        {
            // Handle any exceptions that might occur during disposal
            Console.WriteLine($"Disposal error: {ex.Message}");
        }

        // Dispose of any other objects if necessary
        RefTopicAddPList?.Dispose();
        RefTopicAddGroupPList?.Dispose();
        RefAssignTo?.DisposeAsync();
        RefAssignAll?.Dispose();
        RefTransferEamil?.Dispose();
        RefTopicTagList?.Dispose();
        RefTopicTodo?.Dispose();
        RefEmailDoc?.Dispose();
        RefMasterSearch?.Dispose();
        RefAdminSearch?.Dispose();
    }

    // public async ValueTask DisposeAsync()
    // {
    //     await DisposeAsyncCore();

    //     // Suppress finalization
    //     GC.SuppressFinalize(this);
    // }

    async Task onloadTwoGrid()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");

        await JSRuntime.InvokeAsync<string>("showLoading");
        _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID, "NULL", pageNumber, pageSize));
        _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
        _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID, "NULL"));

        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    void onloadSession()
    {
        _sessionId = Guid.NewGuid();
    }
    void getConversation()
    {

    }
    private async Task onWindowVisible()
    {
        WindowVisible = true;
        await JSRuntime.InvokeAsync<string>("showLoading");
        CurrentUplodCount = 0;
        SelectedFilesCount = 0;
        Data.CopyEmailIds = null;
        _CopyLinkList = await Mediator.Send(new GetAllEmailTopicsList(applicationUser.UserID));
        //var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
        //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();

        if(long.Parse(@SelectedGroup) > 0)
        {

            var _replyComment = await Mediator.Send(new GetEmailConversationTId(long.Parse(@SelectedGroup)));

            Data.UserType = _replyComment[0].UserType;
            isCheckAllowParticipant = true;


            var DFEmailSection = await Mediator.Send(new GetDynamicFormEmailSection(_replyComment[0].SessionId.Value));

            if(DFEmailSection.Count > 0)
            {
                isDynamicFormEmailSection = true;
                _DynamicFormEmailSection = DFEmailSection;
            }
            else
            {
                isDynamicFormEmailSection = false;
                _DynamicFormEmailSection = new List<DynamicFormSection>();
            }

            if (string.IsNullOrEmpty(Data.UserType) || Data.UserType == "Users")
            {
                //if (_replyComment[0].IsAllowParticipants.GetValueOrDefault(false))
                if (true)
                {
                    //var plist = await Mediator.Send(new GetAllEmployeeListQuery());
                    //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
                    var allplist = plist.Where(c => c.UserID != applicationUser.UserID).ToList();

                    var gettids = await Mediator.Send(new GetByConvasationTIDPList(long.Parse(@SelectedGroup)));
                    // var getplllst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                    var parttcc = gettids.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();



                    #region AssignTo
                    /*Assignto*/
                    var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                    var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();
                    //v
                    //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                    //v
                    //List<long> updatedList = Data.AssigntoIds.ToList();
                    List<long> updatedList = conto.Select(s => s.UserId).ToList();
                    long fromUserId = _replyComment[0].AddedByUserID.Value;

                    if (fromUserId != applicationUser.UserID)
                    {
                        updatedList.Add(fromUserId);
                        _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }
                    else
                    {
                        _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].AddedByUserID.Value).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }

                    //v
                    //Data.AssigntoIds = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    Data.AssigntoIds = new List<long>();

                    #endregion

                    #region AssignCC
                    /*AssignCC*/
                    var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                    var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
                    //Data.AssignccIds = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                    var t1 = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    var t2 = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                    Data.AssignccIds = t1.Concat(t2).ToList();

                    var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                    IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                    sCCIds = CCtags.ToList();


                    // _Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();

                    #endregion

                }
                else
                {
                    var gettid = await Mediator.Send(new GetByConvasationTIDPList(long.Parse(@SelectedGroup)));
                    //_allparticipant = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettid[0].TopicID));
                    //_allparticipant = gettid;
                    var allplist = gettid;


                    var gettids = await Mediator.Send(new GetByConvasationTIDPList(long.Parse(@SelectedGroup)));
                    //var getplsst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                    var getpatlist = gettids.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();


                    #region AssignTo
                    /*Assignto*/
                    var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                    var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();

                    //v
                    //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                    //v
                    //List<long> updatedList = Data.AssigntoIds.ToList();
                    List<long> updatedList = conto.Select(s => s.UserId).ToList();
                    long fromUserId = _replyComment[0].AddedByUserID.Value;

                    if (fromUserId != applicationUser.UserID)
                    {
                        updatedList.Add(fromUserId);
                        _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }
                    else
                    {
                        _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].AddedByUserID.Value).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }
                    //v
                    //Data.AssigntoIds = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    Data.AssigntoIds = new List<long>();

                    #endregion


                    #region AssignCC
                    var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                    var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
                    //Data.AssignccIds = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                    var t1 = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    var t2 = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                    Data.AssignccIds = t1.Concat(t2).ToList();



                    //string assignccIdAsString = Data.AssignccIds.ToString(); // Convert Data.AssignccIds to a string
                    //IEnumerable<string> newTags = new List<string> { assignccIdAsString }; // Create a collection with a single element
                    //onCcChanged(newTags);

                    var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                    IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                    sCCIds = CCtags.ToList();

                    _Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();

                    #endregion
                }
            }
            else
            {         
                _participantUserGroup = await Mediator.Send(new GetAllUserGroups());
                _ToUserGroup = _participantUserGroup;
                _CCUserGroup = _participantUserGroup;    

                var listCC = await Mediator.Send(new GetAssignCCUserGroup(_replyComment[0].ID));
                Data.CCUserGroupIds = listCC.Select(s => s.GroupId).ToList();    


                _ToUserGroup = _ToUserGroup.Where(c => !Data.CCUserGroupIds.Select(id => (long?)id).Contains(c.UserGroupId)).ToList();               

                StateHasChanged();

            }            
        }



        //Data.AssigntoIds = Enumerable.Empty<long>();

        //Data.AssignccIds = null;
        string selector = ".dxwinheight";
        Data.From = applicationUser.UserName;
        ElementHeight = await JSRuntime.InvokeAsync<int>("getElementHeight", selector);
        Data.DueDate = null;
        Data.IsAllowParticipants = true;
        Data.Urgent = false;
        Data.IsLockDueDate = false;
        LockDueDateEnable = false;
        Data.NotifyUser = false;
        newSubjectreply = 1;
        submitCount = 0;
        Data.DynamicFormID = null;
        Data.EmailFormDataSessionID = null;
        Data.EmailFormSectionSessionID = null;        

        StateHasChanged(); // Force a UI update
        //await Task.Delay(1000);
        await onRichTxtChangeFontsize(); // Call your other function here
        //await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    void OnDateChanged(DateTime? newValue)
    {       
        if(newValue != null)
        {
            LockDueDateEnable = true;

        }
        else
        {
            Data.IsLockDueDate = false;
            LockDueDateEnable = false;
        }

        Data.DueDate = newValue;      
        StateHasChanged();
    }
    async void onBackFileProfileType(string url)
    {
        var urls = BaseUrl + "fileprofiletype/" + url;
        NavigationManager.NavigateTo(urls);
        await JSRuntime.InvokeAsync<string>("ReloadUrl");
    }
    private async void onBackActivity(string Url)
    {
        var url = ProductActivityBaseUrl + Url;
        string script = $"window.open('{url}', '_blank');";
        await JSRuntime.InvokeVoidAsync("eval", script);
        //NavigationManager.NavigateTo(url,true);
    }
    async void onBackDynamicType(string url)
    {
        var urls = BaseUrl + url;
        NavigationManager.NavigateTo(urls);
        await JSRuntime.InvokeAsync<string>("ReloadUrl");
    }
    private async Task onreply(long id)
    {
        // var lsslsls = await Mediator.Send(new OnReplyConversation(id,applicationUser.UserID));
        WindowVisible = true;
        await JSRuntime.InvokeAsync<string>("showLoading");
        CurrentUplodCount = 0;
        SelectedFilesCount = 0;
        Data.CopyEmailIds = null;
        _CopyLinkList = await Mediator.Send(new GetAllEmailTopicsList(applicationUser.UserID));
        if (id > 0)
        {           
            _replyComment = _discussionList.Where(c => c.ID == id).ToList();

            isPushNotification = _replyComment[0].NotifyUser.GetValueOrDefault(false);

            Data.IsAllowParticipants = false;
            Data.DueDate = null;
            newSubjectreply = 0;         

            Data.UserType = _replyComment[0].UserType;

            if (string.IsNullOrEmpty(Data.UserType) || Data.UserType == "Users")
            {
                if (_replyComment[0].IsAllowParticipants.GetValueOrDefault(false))
                {
                    isCheckAllowParticipant = true;
                    //var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
                    var allplist = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
                    //_allparticipant = allplist.Where(c => c.UserID != _replyComment[0].UserId.Value).ToList();

                    //_Toparticipant = _allparticipant;
                    //_CCparticipant = _allparticipant;


                    var gettids = await Mediator.Send(new GetEmailConversationList(_replyComment[0].ID));
                    var getplllst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                    var parttcc = getplllst.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();



                    #region AssignTo
                    /*Assignto*/
                    var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                    var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();
                    //v
                    //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                    //v
                    //List<long> updatedList = Data.AssigntoIds.ToList();
                    List<long> updatedList = conto.Select(s => s.UserId).ToList();
                    long fromUserId = _replyComment[0].UserId.Value;

                    if (fromUserId != applicationUser.UserID)
                    {
                        updatedList.Add(fromUserId);
                        _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }
                    else
                    {
                        _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].UserId.Value).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }
                    //v
                    //Data.AssigntoIds = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    Data.AssigntoIds = new List<long>();
                    #endregion

                    #region AssignCC
                    /*AssignCC*/
                    var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                    var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();  
                    //Data.AssignccIds = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();


                    var t1 = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    var t2 = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                    //vk
                    //Data.AssignccIds = t1.Concat(t2).ToList();
                    Data.AssignccIds = parttcc.Where(userId => userId != applicationUser.UserID).ToList();

                    var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                    IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                    sCCIds = CCtags.ToList();


                    // _Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();
                    //_allparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();

                    #endregion

                }
                else
                {
                    isCheckAllowParticipant = false;
                    var gettid = await Mediator.Send(new GetEmailConversationList(_replyComment[0].ID));
                    var allplist = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettid[0].TopicID));



                    var gettids = await Mediator.Send(new GetEmailConversationList(_replyComment[0].ID));
                    var getplsst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                    var getpatlist = getplsst.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();


                    #region AssignTo
                    /*Assignto*/
                    var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                    var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();

                    //v
                    //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                    //Data.AssigntoIds = new List<long>();
                    //v
                    //List<long> updatedList = Data.AssigntoIds.ToList();
                    List<long> updatedList = conto.Select(s => s.UserId).ToList();
                    long fromUserId = _replyComment[0].UserId.Value;

                    if (fromUserId != applicationUser.UserID)
                    {
                        updatedList.Add(fromUserId);

                        _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }
                    else
                    {
                        _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].UserId.Value).ToList();
                        _Toparticipant = _allparticipant.ToList();
                        _CCparticipant = _allparticipant.ToList();
                        _allparticipants = _allparticipant.ToList();
                    }

                    //v
                    //Data.AssigntoIds = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    #endregion


                    #region AssignCC
                    var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                    var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
                    //Data.AssignccIds = concc.Select(s => s.UserId).ToList();
                    //Data.AssignccIds = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();


                    var t1 = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                    var t2 = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                    //vk
                    //Data.AssignccIds = t1.Concat(t2).ToList();                    
                    Data.AssignccIds = getpatlist.Where(userId => userId != applicationUser.UserID).ToList();


                    //string assignccIdAsString = Data.AssignccIds.ToString(); // Convert Data.AssignccIds to a string
                    //IEnumerable<string> newTags = new List<string> { assignccIdAsString }; // Create a collection with a single element
                    //onCcChanged(newTags);           

                    var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                    IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                    sCCIds = CCtags.ToList();

                    //_Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();
                    #endregion
                }

            }
            else
            {
                _participantUserGroup = await Mediator.Send(new GetAllUserGroups());
                _ToUserGroup = _participantUserGroup;
                _CCUserGroup = _participantUserGroup;

                var listCC = await Mediator.Send(new GetAssignCCUserGroup(_replyComment[0].ID));
                Data.CCUserGroupIds = listCC.Select(s => s.GroupId).ToList();

                _ToUserGroup = _ToUserGroup.Where(c => !Data.CCUserGroupIds.Select(id => (long?)id).Contains(c.UserGroupId)).ToList();

                StateHasChanged();
            }




            Data.Name = _replyComment[0].Name;
            Data.From = applicationUser.UserName;
            IsReadOnly = false;

            Data.DynamicFormID = null;
            Data.EmailFormDataSessionID = null;
            Data.EmailFormSectionSessionID = null;  


            await Task.Delay(1000);           
            submitCount = 0;
            await onRichTxtChangeFontsize(); 
            //await JSRuntime.InvokeAsync<string>("hideLoading");

        }        
    }  
    void EulaClosing(WindowClosingEventArgs args) {
        closeReply();
    }
    private void onunderreply(long id)
    {
        if (id > 0)
        {
            if(_discussionFullList != null)
            {
                _replyComment = _discussionFullList.Where(c => c.ID == id).ToList();
                WindowVisible = true;
                Data.Name = _replyComment[0].Name;
                IsReadOnly = false;
            }           
        }

        StateHasChanged();
    }
    void closeReply()
    {
        _replyComment = null;
        Data.Name = null;
        IsReadOnly = true;
        WindowVisible = false;
        IsUserGroupCCOpen = false;
        IsUserGroupToOpen = false;
    }
    void OnLeftMenuItemClick(string text)
    {
        isLeftMenuvisible = text;
        Page = text;
        if (text == "AssignTo" && SelectedGroups.Count > 0)
        {
            ArchiveEnabled = true;
        }
        else
        {
            ArchiveEnabled = false;            
        }
        if (text == "Library" && SelectedGroups.Count > 0)
        {
            UnArchiveEnabled = true;
        }
        else
        {
            UnArchiveEnabled = false;
        }
        StateHasChanged();
    }
    async Task OnMenuItemClick(string text)
    {
        isMenuvisible = text;

        if(text == "Posts")
        {
            isComponentVisible = true;
            isAddParticipant = false;
            isEllipsis = true;
            isCommand = true;
            isTags = false;
            //await LoadDataPosts();
            if (RTopicId == 0)
            {
                await LoadDataPosts();
            }
            else
            {
                await LoadReplyDataPosts();
            }
        }
        else if (text == "Files")
        {
            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
            isTags = false;

            if (RTopicId == 0)
            {                
                await loadTopicDocList();
            }
            else
            {
                await loadSubTopicDocList();
            }            
        }
        else if (text == "AddParticipants")
        {
            isAddParticipant = true;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
            isTags = false;
        }
        else if (text == "AddGroupParticipants")
        {
            isAddParticipant = true;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
            isTags = false;
        }
        else if (text == "Tags")
        {
            isTags = true;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;  
        }
        else if(text == "NewEmail")
        {
            isTags = false;
            isComponentVisible = true;
            isEllipsis = false;
            isCommand = false;  
        }
        else
        {

            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = true;
            isCommand = false;
            isTags = false;
        }
    }  
    async Task LoadPlist_Data()
    {
        if(Cid > 0)
        {
            if(RefTopicAddPList != null)
            {
                await RefTopicAddPList.loadParticipentList(long.Parse(@SelectedReplyId));
            }

        }        
    } 
    async Task LoadGroupPlist_Data()
    {
        if(Cid > 0)
        {
            if(RefTopicAddGroupPList != null)
            {
                await RefTopicAddGroupPList.loadParticipentList(long.Parse(@SelectedReplyId));
            }

        }        
    }     
    async Task loadTags_Data()
    {
        if(RefTopicTagList != null)
        {
            await RefTopicTagList.loadTagList(long.Parse(@SelectedGroup));
        }

    }
    async Task loadLibary_Data(string txt)
    {
        if(RefMasterSearch != null)
        {
            await RefMasterSearch.loadLibaryList(txt);
        }

    }
    async Task loadTodo_Data()
    {
        if(Cid > 0)
        {
            if(RefTopicTodo != null)
            {
                await RefTopicTodo.leftTodoLst(Cid);
            }

        }
        else
        {
            if(RefTopicTodo != null)
            {
                await RefTopicTodo.leftTodoLst(-1);
            }            

        }

    }

    async Task LoadMainTopicPlist_Data()
    {        
        if(RefTopicAddPList != null)
        {
            await RefTopicAddPList.loadMainTopicParticipentList(long.Parse(@SelectedGroup));
        }

    }
    async Task LoadMainTopicGroupPlist_Data()
    {
        if (RefTopicAddGroupPList != null)
        {
            await RefTopicAddGroupPList.loadMainTopicParticipentList(long.Parse(@SelectedGroup));
        }
    }

    private async Task HandleValidSubmit()
    {
        if (loading)
        {
            return; // Prevent multiple submissions
        }

        if(submitCount == 0)
        {
            loading = true;        
            //var contentdd = msgContent;
            //byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
            byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);      


            string htmlString = string.Empty;
            var len = fileContent.Length;
            //documentContent = null;            


            htmlString = Encoding.UTF8.GetString(fileContent);
            //if (fileContent != null)
            //{
            //    // Convert the RTF byte array to HTML string
            //    htmlString = Rtf.ToHtml(fileContent);
            //}

            if(fileContent.Length == 443)
            {
                toastService.ShowToast("Please Enter Messages", AC.SD.Core.Services.ToastLevel.Error);
                loading = false;
                return;
            }    

            await msgrichEdit.SaveDocumentAsync();
            using DevExpress.XtraRichEdit.RichEditDocumentServer server = new DevExpress.XtraRichEdit.RichEditDocumentServer();
            byte[] fileContent1 = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
            server.LoadDocument(fileContent1);
            server.Options.Export.Html.EmbedImages = true;
            byte[] fileContents = server.SaveDocument(DevExpress.XtraRichEdit.DocumentFormat.Html);


            string plainText = server.Text;
            string shortDescription = plainText.Length > 500 ? plainText.Substring(0, 500) : plainText;

            if(Data.Name == null)
            {
                toastService.ShowToast("Please Enter Subject Name", AC.SD.Core.Services.ToastLevel.Error);
                loading = false;
                return;
            }

            if (string.IsNullOrEmpty(Data.UserType) || Data.UserType == "Users")
            {
                if (Data.AssigntoIds.Count() == 0)
                {
                    toastService.ShowToast("Please Select Assign To", AC.SD.Core.Services.ToastLevel.Error);
                    loading = false;
                    return;
                }
            }
            else
            {
                if(Data.ToUserGroupIds == null)
                {
                    toastService.ShowToast("Please Select Assign To Group", AC.SD.Core.Services.ToastLevel.Error);
                    loading = false;
                    return;

                }

                if (Data.ToUserGroupIds.Count() == 0)
                {
                    toastService.ShowToast("Please Select Assign To Group", AC.SD.Core.Services.ToastLevel.Error);
                    loading = false;
                    return;
                }
            }



            string assignCCidsString = string.Join(",", _assigntoItems.Select(s => s.UserID).ToList());
            string assignccidsString = null;

            string assigntoidsString = "";

            if(Data.AssigntoIds != null)
            {
                assigntoidsString = string.Join(",", Data.AssigntoIds);
            }


            if(Data.AssignccIds != null)
            {
                assignccidsString = string.Join(",", Data.AssignccIds);
            }


            List<long> concatList;
            List<long> NotificationconcatList = new List<long>();

            if (Data.AssignccIds != null)
            {
                concatList = Data.AssigntoIds.Concat(Data.AssignccIds).ToList();
            }
            else
            {
                if(Data.AssigntoIds != null)
                {
                    concatList = Data.AssigntoIds.ToList();
                }
                else
                {
                    concatList = new List<long>();
                }

            }

            //List<long> concatList = Data.AssigntoIds.Concat(Data.AssignccIds).ToList();
            concatList.Add(applicationUser.UserID);
            concatList = concatList.Distinct().ToList();
            string participantidsString = string.Join(",", concatList);

            string plistUniqueItems = null;
            long ConIds = 0;

            var coId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0;
            if(coId > 0)
            {
                if (string.IsNullOrEmpty(Data.UserType) || Data.UserType == "Users")
                {
                    var plist = await Mediator.Send(new GetByConvasationPList(coId));
                    List<long> plst = plist.Select(x => x.UserID.GetValueOrDefault()).ToList();
                    NotificationconcatList = plst;
                    List<long> uniqueItems = concatList.Except(plst).ToList();
                    if (uniqueItems.Count > 0)
                    {
                        plistUniqueItems = string.Join(",", uniqueItems);
                        NotificationconcatList.AddRange(uniqueItems);
                    }
                }
                else
                {
                    List<long> UGlist = await Mediator.Send(new GetByConvasationPUserGroupList(coId));
                    string UGlistString = string.Join(",", UGlist);

                    List<long> concatListUserGroupItems = new List<long>();
                    if (Data.ToUserGroupIds != null)
                    {
                        concatListUserGroupItems.AddRange(Data.ToUserGroupIds);
                    }

                    if (Data.CCUserGroupIds != null)
                    {
                        concatListUserGroupItems.AddRange(Data.CCUserGroupIds);
                    }

                    // Convert the merged list to a comma-separated string
                    var concatListUserGroup = string.Join(",", concatListUserGroupItems);

                    // Convert string to a list of long
                    concatListUserGroupItems = concatListUserGroup.Split(',').Select(long.Parse).ToList();

                    // Use Except on the collections
                    //List<long> uniqueUserGroupItems = UGlist.Except(concatListUserGroupItems).ToList();
                    //List<long> uniqueUserGroupItems = UGlist.Where(item => !concatListUserGroupItems.Contains(item)).ToList();
                    List<long> uniqueUserGroupItems = concatListUserGroupItems.Except(UGlist).ToList();



                    if (uniqueUserGroupItems.Count > 0)
                    {
                        plistUniqueItems = string.Join(",", uniqueUserGroupItems);
                    }
                }


                ConIds = _replyComment[0].ID;

            }       

            var susertype = Data.UserType;
            var sToUserGroup = "";

            if(Data.ToUserGroupIds != null)
            {
                sToUserGroup = string.Join(",", Data.ToUserGroupIds);
            }        

            var sCCUserGroup = "";
            if (Data.CCUserGroupIds != null)
            {
                sCCUserGroup = string.Join(",", Data.CCUserGroupIds);
            }
            else
            {
                sCCUserGroup = "";
            }

            var sParticipantsUserGroup = "";
            if (sCCUserGroup != null)
            {
                sParticipantsUserGroup = string.Join(",", sToUserGroup, sCCUserGroup);
            }
            else
            {
                sParticipantsUserGroup = string.Join(",", Data.ToUserGroupIds);
            }




            var createReq = new CreateEmailCoversation
                {
                    //TopicID = (long.Parse(@SelectedGroup)),
                    TopicID = RTopicId == 0 ? (long.Parse(@SelectedGroup)) : RTopicId,
                   // Message = Data.Message != null ? Data.Message : "Attachments",
                    Message = htmlString,
                    //FileData = Data.Message != null ? Encoding.UTF8.GetBytes(Data.Message) : Encoding.UTF8.GetBytes("Attachments"),
                    FileData = fileContents,
                    Description = shortDescription,
                    //AssigntoIdss = Data.AssigntoIds.Count() == 0 ? assignCCidsString : assigntoidsString,
                    AssigntoIdss =  assigntoidsString,
                    AssignccIdss = assignccidsString,
                    PlistIdss = participantidsString,
                    AllowPlistids = plistUniqueItems,
                    DueDate = Data.DueDate,
                    EmailFormSectionSessionID = Data.EmailFormSectionSessionID,
                    EmailFormDataSessionID = Data.EmailFormDataSessionID,
                    DynamicFormID = Data.DynamicFormID,
                    IsAllowParticipants = Data.IsAllowParticipants,
                    Urgent = Data.Urgent,
                    NotifyUser = Data.NotifyUser,
                    ConIds = ConIds,
                   // AllParticipantIds = _assigntoItems.Select(s => s.UserID).ToList(),
                    AllParticipantIds = coId > 0 ? NotificationconcatList : concatList,
                    ParticipantId = applicationUser.UserID,
                    ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                    StatusCodeID = 1,
                    IsMobile = 0,
                    AddedByUserID = applicationUser.UserID,
                    AddedDate = DateTime.Now,
                    Name = Data.Name,
                    SessionId = _sessionId,
                    ToUserGroup = sToUserGroup,
                    CCUserGroup = sCCUserGroup,
                    IsLockDueDate = Data.IsLockDueDate,
                    ParticipantsUserGroup = sParticipantsUserGroup,
                    UserType = Data.UserType,
                    CopyEmailIds = Data.CopyEmailIds
                };
            var result = await Mediator.Send(createReq);

            if (result > 1)
            {

                if(isPushNotification)
                {
                    string BaseUrl = NavigationManager.BaseUri + "api/Email/";
                    string url = BaseUrl + "SendMessage?id="+result;
                    // Make a GET request to the controller action
                    var response = await httpClient.GetAsync(url);                
                }

                if (Data.NotifyUser.GetValueOrDefault(false))
                {
                    string BaseUrl = NavigationManager.BaseUri + "api/Email/";
                    string url = BaseUrl + "SendMessage?id="+result;
                    // Make a GET request to the controller action
                    var response = await httpClient.GetAsync(url);
                }

                //var getRec = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
                //sessionId = getRec.Last().SessionId;

                //uploadUrl = GetUploadUrl();           
                //uploadComponent.UploadAllFiles();

                //await SendAllRecordings(_sessionId);
                 if (RefVoiceRec != null)
                    {
                        await RefVoiceRec.SendAllRecordings(_sessionId,"Email",0);
                    }

                if(SelectedFilesCount > 0)
                {
                    if(uploadComponent != null)
                    {
                        uploadComponent.UploadAllFiles();
                    }

                }
                else
                {
                    onRestText();
                    closeReply();
                    onloadSession();

                    await msgrichEdit.NewDocumentAsync();
                    await onloadTwoGrid();

                    if (RTopicId == 0)
                    {
                        await LoadDataPosts();
                    }
                    else
                    {
                        await LoadReplyDataPosts();
                    }

                    WindowVisible = false;
                    loading = false;
                }



                //if(RTopicId == 0)
                //{
                //    await LoadData();
                //}
                //else
                //{
                //    await LoadReplyData();
                //}

                // await LoadData();


            }
            else
            {

            }

            submitCount++;
        }
    }
    private void onRestText()
    {
        Data.Message = null;
        Data.CopyEmailIds = null;
    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        isArchiveClosed = false;
        AddPopupArchive = false;

    }

    void HandleInvalidSubmit()
    {

    } 
    private async void EnableClose()
    {
        isCloseEnabled = true;
        isOpenEnabled = false;
        StateHasChanged();
    }
    private async void EnableOpen()
    {
        isOpenEnabled = true;
        isCloseEnabled = false;
        StateHasChanged();
    }
    private async void DisableOpenClose()
    {
        isOpenEnabled = false;
        isCloseEnabled = false;
        StateHasChanged();
    }
    public async void SubmitOpen()
    {
        var List = await Mediator.Send(new GetEmailClosedQuery(long.Parse(SelectedReplyId), applicationUser.UserID,0));
        toastService.ShowToast("The Selected Topic Open Successfully", AC.SD.Core.Services.ToastLevel.Success);
        if (isLeftMenuvisible == "AssignTo")
        {
            RefAssignTo?.ParticipantCloseList();
        }
        if (isLeftMenuvisible == "Library")
        {
            RefMasterSearch?.ParticipantCloseList();
        }

    }
    public async void SubmitClose()
    {
        var List = await Mediator.Send(new GetEmailClosedQuery(long.Parse(SelectedReplyId), applicationUser.UserID,1));
        toastService.ShowToast("The Selected Topic Close Successfully", AC.SD.Core.Services.ToastLevel.Success);
        if (isLeftMenuvisible == "AssignTo")
        {
            RefAssignTo?.ParticipantCloseList();
        }
        if(isLeftMenuvisible == "Library")
        {
            RefMasterSearch?.ParticipantCloseList();
        }

    }
    public  void onNewEmail()
    {

    }
    private void ClearDiscussionList()
    {
        if (_discussionList != null)
        {
            _discussionList.Clear();
            _discussionList = null;

            // Optionally, force garbage collection
            //GC.Collect();
            //GC.WaitForPendingFinalizers();
            //GC.Collect();
        }
    }    
    private async void onRequestReload()
    {
        if (RTopicId == 0)
        {
            await LoadDataPosts();
        }
        else
        {
            await LoadReplyDataPosts();
        }


        CloseInfo();
    }
}

<script>
    function toggleDetails(element) {
    const content = element.nextElementSibling;
    content.style.display = content.style.display === "block" ? "none" : "block";
    element.textContent = content.style.display === "block" ? "Hide To/CC" : "Show To/CC";
    }

    // Show only first 2 replies initially
    document.querySelectorAll('.accordion-body').forEach((el, index) => {
    if (index < 1) el.classList.add('active1');
    });

    function toggleAccordion(header) {
    const body = header.nextElementSibling;
    body.classList.toggle('active1');
    }

    function toggleShowMore(button) {
    const info = button.parentElement;
    if (info.classList.contains('expanded')) {
    info.classList.remove('expanded');
    button.innerText = "Show more";
    } else {
    info.classList.add('expanded');
    button.innerText = "Show less";
    }
    }

    function toggleMenu(event) {
    event.stopPropagation();
    document.querySelectorAll('.menu-content').forEach(menu => menu.style.display = 'none'); // close others
    const menu = event.currentTarget.nextElementSibling;
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    // Close menu when clicking outside
    window.addEventListener('click', function () {
    document.querySelectorAll('.menu-content').forEach(menu => menu.style.display = 'none');
    });

    document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.menu-content').forEach(menu => menu.style.display = 'none');
    });


    function handleMenuClick(action) {
    switch (action) {
    case 'dueDate':
    alert("Set Due Date clicked");
    break;
    case 'cancelDueDate':
    alert("Cancel Due Date clicked");
    break;
    case 'renameSubject':
    alert("Rename Subject clicked");
    break;
    case 'print':
    window.print();
    break;
    case 'copyLink':
    navigator.clipboard.writeText(window.location.href);
    alert("Link copied to clipboard");
    break;
    }

    // Close menu
    document.querySelectorAll('.menu-content').forEach(menu => menu.style.display = 'none');
    }

</script>

<script>
    function toggleMainBody(btn) {
    const mainBody = document.getElementById("mainBody");
    const isVisible = mainBody.style.display === "block";
    mainBody.style.display = isVisible ? "none" : "block";
    btn.innerText = isVisible ? "Show Main Subject" : "Hide Main Subject";
    }

    function toggleBodyVisibility(button) {
    const body = button.previousElementSibling;
    if (body.classList.contains('expanded-body')) {
    body.classList.remove('expanded-body');
    button.innerText = "Show more";
    } else {
    body.classList.add('expanded-body');
    button.innerText = "Show less";
    }
    }

    // Load More Functionality
    const repliesPerPage = 1;
    let visibleReplies = repliesPerPage;

    document.querySelector('.loadmorebg').addEventListener('click', () => {
    const items = document.querySelectorAll('.accordion-item');
    for (let i = visibleReplies; i < visibleReplies + repliesPerPage; i++) {
    if (items[i]) {
    items[i].querySelector('.accordion-body').classList.add('active1');
    }
    }
    visibleReplies += repliesPerPage;

    if (visibleReplies >= items.length) {
    document.querySelector('.loadmorebg').style.display = 'none';
    }
    });
</script>