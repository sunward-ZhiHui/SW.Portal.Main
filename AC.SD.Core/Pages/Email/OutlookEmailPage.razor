@page "/OutlookEmail"
@using System.Net.Http.Json
@using global::Core.Entities
@inject HttpClient Http
@inject OutlookEmailService EmailService
@inject IJSRuntime JSRuntime;
@using global::Core.Repositories.Query
@inject ILocalStorageService<ApplicationUser> _localStorageService

<h3 class="mb-3">Inbox</h3>

@if (emails == null)
{
    <p class="text-muted">Loading emails...</p>
}
else if (emails.Count == 0)
{
    <p class="text-muted">No emails found.</p>
}
else
{
    <div class="email-list">
        @foreach (var email in emails)
        {
            <div class="email-item" @onclick="() => ToggleEmail(email)">
                <span class="sender">@email.FromName</span>
                <span class="subject"><strong>@email.Subject</strong> - @((MarkupString)email.Preview)</span>
                <span class="date">@email.Date.ToString("g")</span>
            </div>

            @if (email.IsExpanded)
            {
                <div class="email-detail">
                    <p><strong>From:</strong> @email.FromName</p>
                    <p><strong>Date:</strong> @email.Date.ToString("g")</p>
                    <hr />
                    <p>@((MarkupString)email.BodyHtml)</p>

                    @if (email.Attachments?.Count > 0)
                    {
                        <div class="attachments">
                            <strong>Attachments:</strong>
                            <ul>
                                @foreach (var attachment in email.Attachments)
                                {
                                    <li>
                                        <a href="@attachment.DownloadUrl" target="_blank">@attachment.FileName</a>
                                    </li>
                                }
                            </ul>
                        </div>
                    }

                    <div class="email-actions">
                        <button @onclick="() => ReplyToEmail(email)" class="btn btn-primary">Reply</button>
                        <button @onclick="() => ForwardEmail(email)" class="btn btn-secondary">Forward</button>
                        <button @onclick="() => DeleteEmail(email)" class="btn btn-danger">Delete</button>
                    </div>

                    @if (email.Replies?.Count > 0)
                    {
                        <div class="replies">
                            <h5>Reply History:</h5>
                            <ul>
                                @foreach (var reply in email.Replies)
                                {
                                    <li>
                                        <strong>@reply.Date.ToString("g") from @reply.From:</strong>
                                        <p>@reply.Body</p>
                                    </li>
                                }
                            </ul>
                        </div>
                    }

                    @if (email.IsReplying)
                    {
                        <div class="reply-section">
                            <textarea @bind="email.ReplyText" class="form-control" rows="3" placeholder="Write a reply..."></textarea>
                            <button @onclick="() => SendReply(email)" class="btn btn-success mt-2">Send</button>
                        </div>
                    }
                </div>
            }
        }
    </div>
}

<style>
    .email-list {
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .email-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #ddd;
        transition: background 0.2s;
        cursor: pointer;
    }

        .email-item:hover {
            background: #f5f5f5;
        }

    .sender {
        font-weight: bold;
        flex: 1;
    }

    .subject {
        flex: 2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .date {
        color: #999;
        margin-left: auto;
    }

    .email-detail {
        padding: 15px;
        background: #f9f9f9;
        border-top: 1px solid #ddd;
        animation: fadeIn 0.3s ease-in-out;
    }

    .attachments {
        margin-top: 10px;
        padding: 10px;
        background: #eef;
        border-radius: 5px;
    }

        .attachments ul {
            list-style-type: none;
            padding: 0;
        }

        .attachments li {
            margin: 5px 0;
        }

    .email-actions {
        margin-top: 10px;
    }

    .replies {
        margin-top: 20px;
        padding: 10px;
        background: #eef;
        border-radius: 5px;
    }

    .reply-section {
        margin-top: 15px;
    }
</style>

@code {
    private List<EmailViewModel> emails = new List<EmailViewModel>();
    public ApplicationUser? applicationUser { get; private set; }
    private void Reply(EmailViewModel email) => email.IsReplying = true;
    private void ReplyAll(EmailViewModel email) => email.IsReplying = true;
    private void Forward(EmailViewModel email) => email.IsReplying = true;
    
    private async Task DeleteEmail(EmailViewModel email)
    {
        await EmailService.DeleteEmailAsync(email.MessageId);
        emails.Remove(email);
    }


    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        await JSRuntime.InvokeAsync<string>("showLoading");
        var receivedEmails = await EmailService.ReceiveEmailsAsync(applicationUser.UserID);
        emails = receivedEmails.Select(email => new EmailViewModel(email)).ToList();
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }

    private void ToggleEmail(EmailViewModel email)
    {
        email.IsExpanded = !email.IsExpanded;
    }

    private void ReplyToEmail(EmailViewModel email)
    {
        email.IsReplying = !email.IsReplying;
    }

    private async Task SendReply(EmailViewModel email)
    {
        if (!string.IsNullOrWhiteSpace(email.ReplyText))
        {
            //await EmailService.SendReplyAsync(email.MessageId, email.ReplyText);
            email.Replies.Add(new EmailReply
                {
                    From = "You",
                    Date = DateTime.Now,
                    Body = email.ReplyText
                });
            email.ReplyText = "";
            email.IsReplying = false;
        }
    }
    private async Task ForwardEmail(EmailViewModel email)
    {
        //await EmailService.ForwardEmailAsync(email);
        await JSRuntime.InvokeAsync<string>("alert", "Email forwarded successfully!");
    }

    // private async Task SendReply(EmailViewModel email)
    // {
    //     if (string.IsNullOrWhiteSpace(email.ReplyMessage))
    //         return;

    //     await EmailService.SendEmailAsync(email.From, "Re: " + email.Subject, email.ReplyMessage);

    //     email.IsReplying = false;
    //     email.ReplyMessage = "";
    // }

    // private void DeleteEmail(EmailViewModel email)
    // {
    //     emails.Remove(email);
    // }

    private void MarkAsRead(EmailViewModel email)
    {
        email.Subject = "[Read] " + email.Subject;
    }

    public class EmailViewModel : EmailModel
    {
        public bool IsExpanded { get; set; } = false;
        public bool IsReplying { get; set; } = false;
        public string ReplyText { get; set; } = "";
        public string ReplyMessage { get; set; } = "";
        public string Preview { get; set; }
        public string ReplyBody { get; set; } = "";



        public EmailViewModel(EmailModel email)
        {
            this.Subject = email.Subject;
            this.FromName = email.FromName;
            this.ToName = email.ToName;
            this.Date = email.Date;
            this.BodyText = email.BodyText;
            this.BodyHtml = email.BodyHtml;
            this.From = email.From;
            this.To = email.To;
            this.MessageId = email.MessageId;
            this.IsAttachment = email.IsAttachment;
            this.Attachments = email.Attachments ?? new List<EmailAttachmentModel>();
            this.Replies = email.Replies ?? new List<EmailReply>();

            this.Preview = !string.IsNullOrEmpty(email.BodyHtml)
                ? email.BodyHtml.Length > 50 ? email.BodyHtml.Substring(0, 50) + "..." : email.BodyHtml
                : "No preview available";           
        }
    }

}
