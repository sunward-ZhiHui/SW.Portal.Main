@using Application.Queries;
@using global::Core.Repositories.Query;
@using global::Core.Entities;
@using global::Core.Entities.Views;
@inject ILocalStorageService<ApplicationUser> _localStorageService
@using MediatR
@inject IMediator Mediator
@implements IDisposable;
@inject NavigationManager NavigationManager

<style scoped>   
    .subviewEmail .dxbl-grid-header-row {
        display: none;
    }

    .dxbl-grid-detail-cell
    {
        padding: 10px 5px 10px 20px !important;
    }
</style>
<DxLoadingPanel @bind-Visible="PanelVisible" IsContentBlocked="true" ApplyBackgroundShading="true" IndicatorAreaVisible="false" Text="Fetching Data...">
    <DxGrid Data="@_forumTopicTo" 
            PageSize="20" EditMode="GridEditMode.EditForm"
            PagerNavigationMode="PagerNavigationMode.InputBox" 
            KeyFieldName="ReplyId"             
            CssClass="w-100 subviewEmail" 
            SelectionMode="GridSelectionMode.Multiple"
            SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages"
            RowClick="OnEmailToRowClick"
            AutoExpandAllGroupRows="true"
            AllowSelectRowByClick="true">
        <Columns>           
            <DxGridDataColumn FieldName="FirstName" Caption="">
                <CellDisplayTemplate>
                    @{
                        var item = (EmailTopics)context.DataItem;
                    }                    
                    <div style="width:100%">
                        <strong>
                            @item.FirstName 

                            @if (item.DueDate.HasValue)
                            {
                                <span class="showDueDate">(@Application.Common.Helper.Helper.FormatDate(item.DueDate.Value))</span>
                            }
                            @if (item.IsToDoDuDate.GetValueOrDefault(false))
                            {
                                <span class="urgent_icon" title="Todo DueDate"><i class="fa fa-calendar" aria-hidden="true"></i></span>
                            }

                            @if (item.NotificationCount != 0)
                            {
                                <span class="notificationCount">@item.NotificationCount</span>
                            }
                           @*  @if (item.Urgent.GetValueOrDefault(false))
                            {
                                <span class="urgent_icon"><i class="fas fa-bell" aria-hidden="true"></i></span>
                            } *@
                            @if (item.IsAllowParticipants.GetValueOrDefault(false))
                            {
                                <span class="primary_color_icon"><i class="fa fa-users" aria-hidden="true"></i></span>
                            }  
                            @if(item.IsClosed)
                            {
                                @* <span class="primary_color_icon"><i class="fa fa-times-circle"></i></span> *@
                                <span class="primary_color_icon" style="font-size:11px;color:brown;">Closed</span>
                            }
                            @if (!string.IsNullOrEmpty(item.Priorities) &&
                                                        item.Priorities.Equals("High", StringComparison.OrdinalIgnoreCase))
                            {
                                <div class="priority_l high">@item.Priorities</div>
                            }

                            @* 
                            @{
                                dynamicDueDate = "showDueDate_" + item.ReplyId;
                            }
                            <span Id="@dynamicDueDate" class="primary_color_icon" @onmouseover="() => ShowDueDate(item)"><i class="fa fa-calendar" aria-hidden="true"></i></span>
                                         *@               
                        </strong>
                        <div>
                            <span style="float:right; font-size:11px;"> @Application.Common.Helper.Helper.FormatDateTime(item.StartDate)</span>
                            <text>@item.TopicName</text>
                        </div>
                    </div>
                </CellDisplayTemplate>
            </DxGridDataColumn>
            @*<DxGridDataColumn FieldName="NotificationCount" Caption="#" Width="30" />*@
        </Columns>

    </DxGrid>
</DxLoadingPanel>

<DxFlyout @bind-IsOpen="@IsOpenFlyout"
          RestrictionTarget="#Navigation-Flyout-Customization"          
          PositionTarget=@($"#showDueDate_{CurrentEmailConversations?.ReplyId}")
          Position="FlyoutPosition.Bottom"
          CloseOnOutsideClick="true"
          PreventCloseOnPositionTargetClick="true"       
          FooterCssClass="custom-flyout-footer"
          BodyText="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
            incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
            exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat."
          Width="400"
          FooterVisible="true">   
</DxFlyout>

@code {   
    private EmailTopics? CurrentEmailConversations { get; set; }
    private void ShowDueDate(EmailTopics emailTopics)
    {
        CurrentEmailConversations = emailTopics;
        IsOpenFlyout = true;
    }
    string dynamicDueDate = "showDueDate_";
    bool IsOpenFlyout { get; set; } = false;
    IGrid? Grid { get; set; }
    bool PanelVisible { get; set; }
    [Parameter]
    public EmailTopics? Items { get; set; }
    internal List<EmailTopics>? _forumTopicTo;
    public ApplicationUser? applicationUser { get; internal set; }
    string SelectedId = "none";
    [Parameter]
    public Action<string>? RId { get; set; }        
    protected override async Task OnInitializedAsync()
    {
        PanelVisible = true;      
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        if(Items != null)
        {
            _forumTopicTo = await Mediator.Send(new GetSubEmailTopicTo(Items.ID, applicationUser.UserID, "NULL"));
        }

        PanelVisible = false;
        //NavigationManager.LocationChanged += OnLocationChanged;
    }
    void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        StateHasChanged();
    }
    public async Task onSubAssignToGridRefresh(long id)
    {
        if(applicationUser != null)
        {
            _forumTopicTo = await Mediator.Send(new GetSubEmailTopicTo(id, applicationUser.UserID, "NULL"));
        }
        
    }
    void OnEmailToRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ReplyId");
        SelectedId = UniqueId?.ToString() ?? "none";
        RId?.Invoke(SelectedId);   
        StateHasChanged();
    }
    public void Dispose()
    {
        //NavigationManager.LocationChanged -= OnLocationChanged;
        //System.GC.Collect();
        //GC.SuppressFinalize(this);
    }
}