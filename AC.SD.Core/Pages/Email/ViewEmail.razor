@using Application.Commands;
@using Application.Common.Helper;
@using Application.Queries;
@using Application.Response;
@using Markdig;
@using Microsoft.AspNetCore.Http;
@using Newtonsoft.Json
@using global::Core.Repositories.Query;
@using global::Core.Entities;
@using global::Core.EntityModels;
@using global::Core.Entities.Views;
@using MediatR
@inject IMediator Mediator
@using System.ComponentModel.DataAnnotations
@using DevExpress.Blazor.Internal
@using System.Collections.Generic
@inject ILocalStorageService<ApplicationUser> _localStorageService
@page "/ViewEmail"
@page "/ViewEmail/{ActiveSessionId}"
@page "/ViewEmail/{TodoSessionId:guid}/{Page}"
@using DevExpress.Blazor.RichEdit
@using DevExpress.Blazor.Office
@using System.Globalization
@using System;
@using Application.Command.Document;
@using Microsoft.Extensions.Configuration;
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime;
@inject HttpClient httpClient;
@using System.IO;
@using Microsoft.JSInterop;
@using DevExpress.DocumentView;
@inject NavigationManager NavigationManager
@using System.Web;
@inject IToastService ToastService
@inject AC.SD.Core.Services.ToastService toastService
@using System.Text;
@using RtfPipe;
@inject Application.Common.Helper.Helper  dateformathelper
@using System.Net.Http;
@using System.Threading.Tasks
@using System.Threading
@using System.Timers;
@using DevExpress.Blazor.RichEdit;
@inject HttpClient httpClient;
@using Application.Command.ApplicationMasterChilds;
@using Application.Command.ApplicationMasterDetails;
@inject AC.SD.Core.Helpers.TreeGenerateRecursive _treeGenerateRecursive
@implements IDisposable;

<link href="_content/AC.SD.Core/css/forum-mail.css" rel="stylesheet" />
<div class="">
    <div class="main-container">
        <!--  -->
        <!-- Main Content -->
        <!--  -->
        <div class="content-container row">
            <!-- Mini Menu Bar -->
            <div class="mini-menu-bar col-md-3 @toggleButtonVisible"  style="overflow-x: hidden;">
                <div class="mini-menu-bar-top">                    
                    <div class="card w-100" style="margin-bottom:10px; margin-top:10px;">                     
                        <div class="card-body p-0">
                            <DxTabs ScrollMode="TabsScrollMode.NavButtons" @bind-ActiveTabIndex="@ActiveTabIndex">
                                <DxTabPage Text="All" CssClass="@((isLeftMenuvisible == "All" ? "tActive": "tall"))" Click="@(() => OnLeftMenuItemClick("All"))">
                                   
                                </DxTabPage>
                                <DxTabPage Text="Assign To" CssClass="@((isLeftMenuvisible == "AssignTo" ? "tActive": "tassignto"))" Click="@(() => OnLeftMenuItemClick("AssignTo"))">
                                   
                                </DxTabPage>
                                <DxTabPage Text="CC" CssClass="@((isLeftMenuvisible == "AssignCC" ? "tActive": "tassigncc"))" Click="@(() => OnLeftMenuItemClick("AssignCC"))">
                                   
                                </DxTabPage>
                                <DxTabPage Text="Sent" CssClass="@((isLeftMenuvisible == "Sent" ? "tActive": "sent"))" Click="@(() => OnLeftMenuItemClick("Sent"))">

                                </DxTabPage>
                                <DxTabPage Text="Library" CssClass="@((isLeftMenuvisible == "Library" ? "tActive": "library"))" Click="@(() => OnLeftMenuItemClick("Library"))">

                                </DxTabPage>
                                @if(_openAccessUserLink != null)
                                {
                                    <DxTabPage Text="Administrator" CssClass="@((isLeftMenuvisible == "Administrator" ? "tActive": "administrator"))" Click="@(() => OnLeftMenuItemClick("Administrator"))"></DxTabPage>   
                                }
                                
                              </DxTabs>                          
                        </div>
                    </div>

                    <div>
                        <div class="views-accordion">
                        @if(isLeftMenuvisible == "All")
                        {                                
                            <AllEmail @ref=RefAssignAll GridSearchText="@GridSearchText" ATopicId="onViewEmailAllClick" SubViewAllTopicId ="onSubViewEmailClick"></AllEmail>
                        }
                        else if (isLeftMenuvisible == "AssignTo")
                        {
                                <AssignToEmail @ref=RefAssignTo Page="@Page" GridSearchText="@GridSearchText" ToTopicId="onViewEmailToClick" SubViewToTopicId="onSubViewEmailClick"></AssignToEmail>
                        }
                        else if (isLeftMenuvisible == "AssignCC")
                        {
                            <CCEmail GridSearchText="@GridSearchText" CCTopicId="onViewEmailCCClick" SubViewCCTopicId="onSubViewEmailClick"></CCEmail>
                        }
                        else if(isLeftMenuvisible == "Sent")
                        {
                            <SentEmail sentTopicId="onViewEmailSentClick" SubViewSentTopicId="onSubViewEmailClick"></SentEmail>
                        }  
                        else if(isLeftMenuvisible == "Library")
                        {
                            <MasterSearch @ref=RefMasterSearch GridSearchText="@GridSearchText" MyDayFilterText="@MyDayFilterText" ATopicId="onViewEmailAllClick" SubViewAllTopicId="onSubViewEmailClick"></MasterSearch>
                        }
                        else if (isLeftMenuvisible == "Administrator")
                        {
                            <AdminEmail @ref=RefAdminSearch GridSearchText="@GridSearchText" MyDayFilterText="@MyDayFilterText" ATopicId="onViewEmailAllClick" SubViewAllTopicId="onSubViewEmailClick"></AdminEmail>
                        }
                        </div>
                    </div>
                </div>               
            </div>
            <!-- Menu Bar Content -->
            <div class="menu-bar-content-container @hiddenButtonCssClass">
                <div class="content-padding-20">
                    <div class="menu-bar-content-container-heading">
                        <div class="heading-icon-text">                          
                            <div class="mb-cc-text">
                                <div class="card w-100">
                                    <div class="card-body p-0">
                                                                          

                                          <DxMenu Orientation="Orientation.Horizontal"
                                                DropDownActionMode="MenuDropDownActionMode.Click"
                                                DisplayMode="MenuDisplayMode.Desktop"
                                                Title=""
                                                CollapseItemsToHamburgerMenu="true"
                                                CollapseItemToIconMode="MenuCollapseItemToIconMode.All">                                               
                                            <Items> 
                                                <DxMenuItem Text="" Enabled="@isPage" IconCssClass="fa fa fa-reply" Click="@(() => GoBack())" />
                                                <DxMenuItem Text="" IconCssClass="fa fa-th-list" Click="@(() => ToggleButtonClick())" />
                                                <DxMenuItem Text="Posts" class="@((isMenuvisible == "Posts" ? "tActive": "tfiles"))" IconCssClass="menu-icon-products menu-icon" Click="@(() => OnMenuItemClick("Posts"))" />
                                                <DxMenuItem Text="Files" Enabled="@isEnabled" class="@((isMenuvisible == "Files" ? "tActive": "tfiles"))" IconCssClass="fa fa-paperclip cdspc" Click="@(() => OnMenuItemClick("Files"))" />
                                                <DxMenuItem Text="Todo" Enabled="@isTodoEnabled" class="@((isMenuvisible == "Todo" ? "tActive": "ttodo"))" IconCssClass="menu-icon-about menu-icon" Click="@(() => OnMenuItemClick("Todo"))" />
                                                <DxMenuItem Text="Participants List" Enabled="@isEnabled" class="@((isMenuvisible == "AddParticipants" ? "tActive": "taddparticipants"))" IconCssClass="dxbl-image menu-icon-support menu-icon dx-menu-item-image" Click="@(() => OnMenuItemClick("AddParticipants"))" />
                                                <DxMenuItem Text="Tags" Enabled="@isEnabled" class="@((isMenuvisible == "Tags" ? "tActive": "ttags"))" IconCssClass="fa fa-tags" Click="@(() => OnMenuItemClick("Tags"))" />
                                            
                                            </Items>
                                        </DxMenu>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div>          
                            @if (_headTopic != null && _headTopic.Any())
                            {
                                @foreach (var item in _headTopic)
                                {                                    
                                    <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto">
                                        <div class="uk-card-header topicheadbg" style="height: auto; border-bottom: none;">
                                            <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                <div class="uk-card-header" style="border-bottom: none;">
                                                    <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">

                                                        <div class="mailbox-read-info">
                                                            <h3 style="width: 90%;">  @(item.TopicName.Length > 100 ? item.TopicName.Substring(0, 100) : item.TopicName)  </h3>
                                                            @if (_headTopic_Tag != null && _headTopic_Tag.Any())
                                                            {
                                                                @foreach (var Tagitem in _headTopic_Tag)
                                                                {
                                                                    @if(Tagitem.GroupName != null)
                                                                    {
                                                                        <span class=" handline tagbg">@Tagitem.GroupName</span>
                                                                    }
                                                                    
                                                                    @if(Tagitem.CategoryName != null)
                                                                    {
                                                                        <span class=" handline tagbg">@Tagitem.CategoryName</span>
                                                                    }
                                                                    
                                                                    @if(Tagitem.ActionName != null)
                                                                    {
                                                                        <span class=" handline tagbg">@Tagitem.ActionName</span>
                                                                    }

                                                                    @if (!string.IsNullOrWhiteSpace(Tagitem.Name))
                                                                    {
                                                                        <span class="handline tagbg">@Tagitem.Name</span>
                                                                    }                                                                   

                                                                }
                                                            }
                                                            @if (_headTopic_UserTag != null && _headTopic_UserTag.Any())
                                                            {                                                                    
                                                                @if (!string.IsNullOrWhiteSpace(_headTopic_UserTag[0].UserTag))
                                                                {
                                                                    <span class="handline usertag">@_headTopic_UserTag[0].UserTag</span>
                                                                }                                                                                                                                
                                                            }
                                                        </div>  
                                                       
                                                        <span class="mailbox-read-time pull-right" style="float: right; margin-top: -23px; margin-right: 40px;">@Application.Common.Helper.Helper.FormatDateTime(@item.StartDate)</span>
                                                        <span class="uk-label uk-margin-auto-left" style="float: right; margin-top: -23px; margin-right: 15px;">

                                                            @if (isAddParticipant)
                                                            {
                                                                @if (isCommandTopicClosed)
                                                                {
                                                                   @* <button @onclick="onAddPlist" class="btn btn-excel" style="margin-top: 2px;">Add Participant </button>*@
                                                                }

                                                            }

                                                            @if (isEllipsis)
                                                            {
                                                                @if (isCommandTopicClosed)
                                                                {
                                                                    <div Id="showFlyout" class="handline fa fa-ellipsis-v" @onclick="() => IsOpenFlyout = true" style="font-size: 18px;    font-weight: bold;"></div>
                                                                   
                                                                }
                                                                else
                                                                {
                                                                    <div style="color:red;margin-top: 10px;">Closed</div>
                                                                }
                                                            }
                                                        </span>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    <div class="@((isComponentVisible ? "menu-bar-content-container-content msgOpen" : "menu-bar-content-container-content msgClosed"))">
                        @* <div class="spacing-box"></div>  *@
                        @if (isMenuvisible == "Posts")
                        {
                            <div id="tableData">
                                <div>
                                    @if (_discussionList != null && _discussionList.Any())
                                    {
                                        @foreach (var item in _discussionList)
                                        {
                                            @if (item.ReplyId > 0)
                                            {
                                                @*<div class="lstcoversationrply">
                                                    <i class="fa fa-reply-all" aria-hidden="true"></i>
                                                    <div>@item.ReplyMessage</div>
                                                    <div style="float:right;margin-top: -13px;">@item.ReplyUserName , @item.ReplyDateTime</div>
                                                </div>*@
                                            }

                                            <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto" style="margin-right: 10px;">
                                                <div class="uk-card-header">
                                                    <div class="container-header" style="margin-left: -9px;">
                                                        <div class="left-column">
                                                            <div style="font-size: 20px; margin: 0;"> @(item.Name.Length > 100 ? item.Name.Substring(0, 100) : item.Name) </div>
                                                            <p style="font-size:12px; line-height: 1.1; margin: 0;    padding: 5px 0 0 0;">
                                                                From: @item.UserName
                                                            @if (item.OnBehalfName != null)
                                                            {
                                                                <span style="font-weight:bold; font-size:12px; margin-left:10px;">OnBehalf : </span>
                                                                <span style="font-size:12px;"> @item.OnBehalfName </span>
                                                                @if (item.Follow == "Follow Up")
                                                                {
                                                                    <span class="fa fa-link" style="font-size:12px; margin-left: 10px;color: red;" aria-hidden="true"></span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="fa fa-chain-broken" style="font-size:12px; margin-left: 10px;" aria-hidden="true"></span>
                                                                }
                                                            }
                                                            <br>                                                            
                                                            To:
                                                            @if (item.AssignToList != null && item.AssignToList.Any())
                                                            {
                                                                @foreach (var items in item.AssignToList)
                                                                {
                                                                    <span>@items.FirstName ,</span>
                                                                }
                                                            }
                                                            <br>
                                                            @if (item.AssignCCList != null && item.AssignCCList.Any())
                                                            {
                                                                <text>CC:</text>
                                                                @foreach (var items in item.AssignCCList)
                                                                {
                                                                    <span>@items.FirstName ,</span>
                                                                }
                                                            }
                                                            </p>
                                                        </div>

                                                        <div class="right-column">
                                                            <div class="shared-div">
                                                                <div class="date-and-notes">
                                                                    @if(item.DueDate != null)
                                                                    {
                                                                        <div class="" style="margin-right: 10px; font-size: 12px;"><span style="font-weight:bold;"> Due Date</span> @Application.Common.Helper.Helper.FormatDate(item.DueDate.Value)</div>
                                                                        
                                                                    }

                                                                    <button type="button" @onclick="@(() => onreply(item.ID))" style="font-size: 13px; margin-right: 10px; border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;padding-right: 10px; padding-left: 10px;" class="">
                                                                        <i class="fa fa-reply"></i> Reply
                                                                    </button>
                                                                     
                                                                     @{ dynamicShowSubject = "showOpenSubject_" + item.ID; }
                                                                       <div id="@dynamicShowSubject"  class="handline fa fa-ellipsis-v" @onclick="() => ShowSubjectFlyout(item)" style=" margin-right: 10px; font-size: 18px;font-weight: bold;"></div>
                                                                </div>
                                                                <div class="date-and-notes">
                                                                    <div class="" style="font-size:12px; margin-right: 10px;">@Application.Common.Helper.Helper.FormatDateTime(@item.AddedDate)</div>
                                                                    @if (item.IsAllowParticipants.GetValueOrDefault(false))
                                                                    {
                                                                        <span class="" style="margin-right: 10px; font-size: 14px;"><i class="fa fa-users" aria-hidden="true"></i></span>
                                                                    }
                                                                    @if (item.Urgent.GetValueOrDefault(false))
                                                                    {
                                                                        <span class="urgent_icon" style="margin-right: 10px; font-size: 14px;"><i class="fas fa-bell" style="" aria-hidden="true"></i></span>
                                                                    }
                                                                    @if (item.NotifyUser.GetValueOrDefault(false))
                                                                    {
                                                                        <span class="" style="margin-right: 10px; font-size: 14px;"><i class="fa fa-commenting" style="" aria-hidden="true"></i></span>
                                                                    }
                                                                
                                                                </div>
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @* <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">                                                        
                                                        <div class="mailbox-read-info">  
                                                           <h3 style="width: 90%;">  @(item.Name.Length > 100 ? item.Name.Substring(0, 100) : item.Name)  </h3>
                                                           @if(item.DueDate != null)
                                                           {
                                                                <div class="mailbox-read-time pull-right">
                                                                    <div class="" style="margin-top: -21px; margin-right: 104px;"><span style="font-weight:bold;"> Due Date</span> @Application.Common.Helper.Helper.FormatDate(item.DueDate.Value)</div>
                                                                </div>
                                                           }                                                        
                                                           
                                                            @{
                                                                dynamicShowSubject = "showOpenSubject_" + item.ID;                                                                
                                                            }
                                                            <div id="@dynamicShowSubject"  class="handline fa fa-ellipsis-v" @onclick="() => ShowSubjectFlyout(item)" style="font-size: 18px;    font-weight: bold; float: right; margin-top: -20px;"></div>
                                                            @if (item.IsAllowParticipants.GetValueOrDefault(false))
                                                            {
                                                                <span class="primary_color_icon" style="margin-top: 5px;"><i class="fa fa-users" aria-hidden="true"></i></span>
                                                            }
                                                            @if (item.Urgent.GetValueOrDefault(false))
                                                            {
                                                                <span class="urgent_icon"><i class="fas fa-bell" style="margin-top: 8px;" aria-hidden="true"></i></span>
                                                            }                                                            
                                                            @if (item.NotifyUser.GetValueOrDefault(false))
                                                            {
                                                                <span class="primary_color_icon"><i class="fa fa-commenting" style="margin-top: 8px;" aria-hidden="true"></i></span>
                                                            }
                                                            <div class="mailbox-read-time pull-right">
                                                                <button type="button" @onclick="@(() => onreply(item.ID))" style="margin-top: -21px; margin-right: -13px; border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: right; padding-right: 10px; padding-left: 10px;" class="">
                                                                    <i class="fa fa-reply"></i> Reply
                                                                </button>
                                                            </div>
                                                            <h5>                                                               
                                                                From: @item.UserName
                                                                @if (item.OnBehalfName != null)
                                                                {
                                                                    <span style="font-weight:bold; font-size:12px; margin-left:10px;">OnBehalf : </span>
                                                                    <span style="font-size:12px;"> @item.OnBehalfName </span>
                                                                    @if (item.Follow == "Follow Up")
                                                                    {
                                                                        <span class="fa fa-link" style="font-size:12px; margin-left: 10px;color: red;" aria-hidden="true"></span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="fa fa-chain-broken" style="font-size:12px; margin-left: 10px;" aria-hidden="true"></span>
                                                                    }
                                                                }
                                                                <br>
                                                                
                                                                <div class="mailbox-read-time pull-right">
                                                                    <div class="" style="margin-top: -8px;">@Application.Common.Helper.Helper.FormatDateTime(@item.AddedDate)</div>                                                                   
                                                                </div>
                                                                To:
                                                                @if (item.AssignToList != null && item.AssignToList.Any())
                                                                {
                                                                    @foreach (var items in item.AssignToList)
                                                                    {
                                                                        <span>@items.FirstName ,</span>
                                                                    }
                                                                }
                                                                <br>                                                             
                                                                @if (item.AssignCCList != null && item.AssignCCList.Any())
                                                                {
                                                                    <text>CC:</text>
                                                                    @foreach (var items in item.AssignCCList)
                                                                    {
                                                                        <span>@items.FirstName ,</span>
                                                                    }
                                                                }                                                                
                                                            </h5>
                                                        </div>                                                                                                            
                                                    </div> *@
                                                </div>
                                                @if (!string.IsNullOrEmpty(item.BackURL))
                                                {    
                                                     string ActivityTypes = item.ActivityType == "FileProfileType" ? "Sunward Libraries" : "Activity";
                                                     @if(item.ActivityType != "EmailFileProfileType")
                                                    {
                                                        <div class="replybox" style="min-height:60px;">
                                                            <div style="font-weight: bold;">
                                                                @ActivityTypes Comment
                                                                <div style="float:right; line-height:16px">
                                                                    @if (item.ActivityType == "FileProfileType")
                                                                    {
                                                                        <button type="button" @onclick="@(() => onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                            <i class="fa fa-arrow-left"></i> Back
                                                                        </button>
                                                                    }
                                                                    else if (item.ActivityType == "EmailFileProfileType")
                                                                    {
                                                                        <button type="button" @onclick="@(() => onBackFileProfileType(item.BackURL+"/"+item.DocumentSessionId))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                            <i class="fa fa-arrow-left"></i> Back
                                                                        </button>
                                                                    }
                                                                    else
                                                                    {
                                                                        <button type="button" @onclick="@(() => onBackActivity(item.BackURL))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;" class="">
                                                                            <i class="fa fa-arrow-left"></i> Back
                                                                        </button>

                                                                    }

                                                                </div>
                                                            </div>
                                                            <text>@item.ActCommentName</text>
                                                            <div style=" float: right; font-size: 12px;">@item.ActUserName , @item.ActAddedDate</div>
                                                        </div>
                                                        
                                                    }

                                                   

                                                }
                                                <div class="uk-card-body">
                                                    
                                                    <div>
                                                        @{
                                                            byte[] htmlBinaryData = item.FileData; // Your HTML binary data
                                                            string htmlContent = System.Text.Encoding.UTF8.GetString(htmlBinaryData);
                                                            @((MarkupString)htmlContent)
                                                        }                                                        
                                                    </div>
                                                   @* <CopyToClipboardButton Text="htmlContent" />*@
                                                @*    <p class="uk-text-success">                                                       
                                                        <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />                                                      
                                                    </p>*@

                                                    @if (item.documents.Any())
                                                    {
                                                        <div class="uk-card-footer">
                                                            <div>
                                                                <div class="">
                                                                    @foreach (var attachment in item.documents)
                                                                    {
                                                                        <div class="tag handline" @onclick="@(() => onDocDownload(attachment.DocumentID))"><i class="fas fa-file"  aria-hidden="true"></i> @attachment.FileName</div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                                                                   
                                                </div>
                                                
                                                @if (item.ReplyConversation.Count() > 0)
                                                {
                                                    <div class="uk-card-footer">
                                                        <div>   
                                                            <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                <i class="fa fa-reply"></i> Reply
                                                            </button>
                                                            <p style="color: #5151b3;" class="handline" @onclick="@(() => ToggleItemVisibility(item.ID))">@item.ReplyConversation.Count() replies </p>
                                                            @if (@item.ReplyConversation != null && @item.ReplyConversation.Any())
                                                            {
                                                                @if (itemVisibility.ContainsKey(item.ID) && itemVisibility[item.ID])
                                                                {
                                                                    @foreach (var items in @item.ReplyConversation)
                                                                    {
                                                                        <div class="lstcoversationrply @((items.IsRead.GetValueOrDefault(false) || items.IsRead == null ? "markasread" : "markasunread"))">
                                                                            <div class="mailbox-read-info" style="border-bottom:1px solid #f4f4f4">
                                                                                @*<h3>@items.Name</h3>*@
                                                                                <h5>                                                                                   
                                                                                    From: @items.UserName
                                                                                    <br>
                                                                                    @if(items.IsRead != null)
                                                                                    {
                                                                                        @if (items.IsRead.GetValueOrDefault(false))
                                                                                        {
                                                                                            <span class="primary_color_icon handline" @onclick="@(() => onMarkasunRead(items.EmailNotificationId))" title="Mark as unread"><i class="fa fa-envelope-open" aria-hidden="true"></i></span>

                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <span class="primary_color_icon handline" @onclick="@(() => onMarkasRead(items.EmailNotificationId))" title="Mark as read"><i class="fa fa-envelope" aria-hidden="true"></i></span>
                                                                                        }

                                                                                    }
                                                                                   
                                                                                    <span class="mailbox-read-time pull-right">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</span>
                                                                                    To:
                                                                                    @if (items.AssignToList != null && items.AssignToList.Any())
                                                                                    {
                                                                                        @foreach (var itms in items.AssignToList)
                                                                                        {
                                                                                            <span>@itms.FirstName ,</span>
                                                                                        }
                                                                                    }
                                                                                    <br>
                                                                                    
                                                                                    @if (items.AssignCCList != null && items.AssignCCList.Any())
                                                                                    {
                                                                                        <text>CC:</text>
                                                                                        @foreach (var itm in items.AssignCCList)
                                                                                        {
                                                                                            <span>@itm.FirstName ,</span>
                                                                                        }
                                                                                    }                                                                                   
                                                                                 
                                                                                </h5>
                                                                            </div> 
                                                                           
                                                                            @{
                                                                                byte[] htmlBinaryData1 = items.FileData; // Your HTML binary data
                                                                                string htmlContent1 = System.Text.Encoding.UTF8.GetString(htmlBinaryData1);
                                                                                //string btxt = Markdown.ToHtml(htmlContent1);
                                                                                //<CopyToClipboardButton Text="@btxt" />
                                                                                <div style="padding: 10px;">
                                                                                    @((MarkupString)htmlContent1)
                                                                                </div>
                                                                            }   
                                                                            @if (items.documents != null && items.documents.Any())
                                                                            {
                                                                                @foreach (var attachment in items.documents)
                                                                                {
                                                                                    <div class="tag handline" @onclick="@(() => onDocDownload(attachment.DocumentID))"><i class="fas fa-file"  aria-hidden="true"></i> @attachment.FileName</div>
                                                                                }                                                                              
                                                                            }                                                                            
                                                                        </div>
                                                                       
                                                                    }

                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="uk-card-footer">
                                                        <div>
                                                            <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                <i class="fa fa-reply"></i> Reply
                                                            </button>
                                                            <p style="color: #5151b3;" class="handline" >0 replies </p>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>



                                @if (isComponentVisible)
                                {
                                    @if(IsConHistory)
                                    {
                                        <DxButton RenderStyle="ButtonRenderStyle.Success" CssClass="me-1 btn-success open-button"
                                      Click="onWindowVisible" style="width:200px;">New Subject</DxButton>
                                    }
                                    
                                    <DxWindow @bind-Visible=WindowVisible 
                                      HeaderText="Post"
                                      HorizontalAlignment="HorizontalAlignment.Right"
                                      VerticalAlignment="DevExpress.Blazor.VerticalAlignment.Bottom"
                                      CloseOnEscape="true"                                      
                                      ResizeCompleted="OnWindowResizeCompleted"
                                      DragCompleted="OnWindowDragCompleted"                                          
                                      ShowFooter=false
                                      AllowResize="true"
                                      Closing="EulaClosing"
                                      MinWidth="800"
                                      Width="800"                                      
                                      Height="600"
                                      ShowCloseButton="true"                                                
                                      @ref="dxWindow">
                                        <BodyTemplate Context="Context">
                                            @*<div class="close-button handline" @onclick="CloseClick">X</div>*@
                                            <div class="dxwinheight" style="padding: 20px; overflow: auto;">
                                                <DxFormLayout>
                                                    <div class="open-button-old" style="width:99.5%">
                                                       @* @if (_replyComment != null && _replyComment.Any())
                                                        {
                                                            @foreach (var item in _replyComment)
                                                            {
                                                                <div class="replybox">
                                                                    <div> <i class="fa fa-reply" aria-hidden="true"></i> Reply</div>
                                                                    <div class="closebtn" @onclick="closeReply">X</div>
                                                                    
                                                                    <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg editor-reply-height" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />
                                                                    <div>@item.UserName  , @item.AddedDate</div>
                                                                </div>
                                                            }
                                                        }*@
                                                        @*       DocumentContentChanged="OnmsgContentChanged"
                                                Selection="@richSelection" SelectionChanged="OnSelectionChanged"
                                                *@
                                                        @if (isCommand)
                                                        {
                                                            @if (isCommandTopicClosed)
                                                            {
                                                                <div class="boxreplay">
                                                                   @* @if (_headTopic != null && _headTopic.Any())
                                                                    {
                                                                        @foreach (var item in _headTopic)
                                                                        {
                                                                            <h3>@item.TopicName</h3>
                                                                        }
                                                                    }*@

                                                                    <EditForm Model="@Data" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                                                                        @* <DataAnnotationsValidator />*@
                                                                        <DxFormLayout>
                                                                            <DxFormLayoutItem Caption="Subject Name" ColSpanMd="12">
                                                                                <DxTextBox @bind-Text="@Data.Name" ShowValidationIcon="true" NullText="Subject Name" Enabled="@IsReadOnly" />
                                                                                <ValidationMessage For="@(() => Data.Name)" />
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="From" ColSpanMd="12">
                                                                                <DxTextBox @bind-Text="@Data.From" ShowValidationIcon="true" Enabled=false />
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="Assign To" ColSpanMd="12">
                                                                            <DxTagBox NullText="Select Assign To..."
                                                                                      Data="@_Toparticipant"
                                                                                      ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                      ValueFieldName="UserID"
                                                                                      TextFieldName="Name"                                                                                      
                                                                                      ListRenderMode="ListRenderMode.Virtual"                                                                                      
                                                                                      
                                                                                      @bind-Values="@Data.AssigntoIds"
                                                                                      SelectedItemsChanged="@((IEnumerable<ViewEmployee> values) => onSelectedToItemsChanged(values))"
                                                                                      CssClass="cw-480">
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.Name)" Caption="Name" />
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" Width="100px" />
                                                                                </DxTagBox>
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="CC" ColSpanMd="12">
                                                                            <DxTagBox NullText="Select cc..."
                                                                          Data="@_CCparticipant"
                                                                                      ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                      ValueFieldName="UserID"
                                                                                      TextFieldName="Name"
                                                                                      SelectedItemsChanged="@((IEnumerable<ViewEmployee> values) => onSelectedCCItemsChanged(values))"
                                                                                      ListRenderMode="ListRenderMode.Virtual"
                                                                                      @bind-Values="@Data.AssignccIds"
                                                                                      
                                                                                      CssClass="cw-480">
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.Name)" Caption="Name" />
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" Width="100px" />
                                                                                </DxTagBox>
                                                                            </DxFormLayoutItem>
                                                                         @if(newSubjectreply == 1)
                                                                         {      
                                                                            <DxFormLayoutItem Caption="Due Date" ColSpanMd="5">
                                                                                <DxDateEdit @bind-Date="@Data.DueDate" Mask="dd/MMMM/yyyy" />
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="" CssClass="topoverdue" ColSpanMd="3">
                                                                                <DxCheckBox CssClass="w-100"
                                                                                @bind-Checked="@Data.IsAllowParticipants"
                                                                                Alignment="default"
                                                                                LabelPosition="LabelPosition.Right">
                                                                                    Allow Add Participants
                                                                                </DxCheckBox>
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="" CssClass="topoverdue" ColSpanMd="2">
                                                                                <DxCheckBox CssClass="w-100"
                                                                                @bind-Checked="@Data.Urgent"
                                                                                Alignment="default"
                                                                                LabelPosition="LabelPosition.Right">
                                                                                   Urgent
                                                                                </DxCheckBox>
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="" CssClass="topoverdue" ColSpanMd="2">
                                                                                <DxCheckBox CssClass="w-100"
                                                                                @bind-Checked="@Data.NotifyUser"
                                                                                Alignment="default"
                                                                                LabelPosition="LabelPosition.Right">
                                                                                   Notify User
                                                                                </DxCheckBox>
                                                                            </DxFormLayoutItem>
                                                                         }
                                                                            <DxFormLayoutItem ColSpanMd="12">
                                                                                <div class="">
                                                                                    <DxRichEdit DocumentLoaded="OnDocumentLoaded" @ref="msgrichEdit" CustomizeToolbar=OnCustomizeToolbar BarMode="BarMode.Toolbar" CssClass="w-100 h-100 txtEditorMsg editor-box-height" Id="editor-box-height" ViewType="ViewType.Simple" />
                                                                                </div>
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem ColSpanMd="12">
                                                                               @* <DxButton SubmitFormOnClick="true" Text="" CssClass="fa fa-paper-plane sndrot" style="float:right" RenderStyle="ButtonRenderStyle.Secondary">
                                                                                   
                                                                                </DxButton>*@
                                                                                <button disabled="@loading" class="fa fa-paper-plane sndrot" style="float:right; margin-top:10px;">
                                                                                    @if (loading)
                                                                                    {
                                                                                        <span class="spinner-border spinner-border-sm mr-1"></span>
                                                                                    }                                                                                    
                                                                                </button>
                                                                                <div style="display:flex;" class="attmode">
                                                                                    <div id="attachmentSelectButton" class="fa fa-paperclip handline cdspcc" aria-hidden="true"></div>

                                                                                        <div class="">
                                                                                            <DxUpload @ref="uploadComponent" Name="files"
                                                                                              Visible="@AttachmentUploadVisible"                                                                                 
                                                                                              AcceptedFileTypes=@AcceptedFileTypes
                                                                                              UploadMode="@UploadMode.OnButtonClick"
                                                                                              FileUploadStart="OnFileUploadStart"
                                                                                              ChunkSize="200000"
                                                                                              AllowMultiFileUpload="true"                                                                                           
                                                                                              ExternalSelectButtonCssSelector="#attachmentSelectButton"
                                                                                              SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                                                                              FileUploaded="@isUploadSuccess"
                                                                                              FileUploadProgressChanged="@OnUploadProgressChanged"
                                                                                              FileUploadStarted="@OnFileUploadStarted"
                                                                                              FileUploadError="@OnUploadError">
                                                                                            </DxUpload>
                                                                                        <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>
                                                                                    </div>
                                                                                </div>
                                                                            </DxFormLayoutItem>
                                                                        </DxFormLayout>
                                                                    </EditForm>
                                                                </div>
                                                            }
                                                        }

                                                        @* <DxRichEdit Height="500px" Width="100%"></DxRichEdit>*@

                                                    </div>
                                                </DxFormLayout>
                                            </div>
                                        </BodyTemplate>
                                        <FooterTextTemplate>
                                            <DxButton SubmitFormOnClick="true" Text="Post" CssClass="" RenderStyle="ButtonRenderStyle.Primary" />
                                            <DxButton RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@context.CloseCallback" />
                                            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@context.CloseCallback" />
                                        </FooterTextTemplate>
                                    </DxWindow>
                                }
                                else
                                {

                                   @* <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                                      Text="New Conversation"
                                      Click="@(() => isComponentVisible = true)"
                                      IconCssClass="btn-icon-undo"
                                              style="color:white; width:200px;"
                                      CssClass="me-1 btn-success open-button" />*@
                                }
                            </div>
                        }
                        else if (isMenuvisible == "Files")
                        {
                            @* <div class="card w-100" style="margin-bottom:10px; margin-top:10px">
                                <div class="card-body p-0">                                   
                                    <DxMenu CollapseItemsToHamburgerMenu="true" 
                                    CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                                    DisplayMode="MenuDisplayMode.Desktop">
                                    <Items>                                      
                                        <DxMenuItem Text="Preview" IconCssClass="fa fa-eye" Click="((e) => onPreview(_selectlst.DocumentId))" Enabled=PreviewEnabled />                                        
                                    </Items>
                                    </DxMenu>
                                </div>
                            </div> *@
                            @* <DxGrid @ref="Grid" Data="@_topicDocList" EditMode="GridEditMode.EditForm" ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
                                PagerNavigationMode="PagerNavigationMode.InputBox"
                                PageSizeSelectorVisible="true"
                                PageSizeSelectorAllRowsItemVisible="true"
                                PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                                PageSize="20"
                                style="height:calc(100vh - 355px)"
                                CssClass="ch-360"
                                AutoExpandAllGroupRows="true"
                                RowClick="OnRowClick"
                                FocusedRowEnabled="true"
                                SelectionMode="GridSelectionMode.Multiple"
                                SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages">
                                <Columns>                               
                                    <DxGridDataColumn FieldName="SubjectName" MinWidth="200" FixedPosition="GridColumnFixedPosition.Left"  />
                                    <DxGridDataColumn FieldName="FileName" MinWidth="200" />
                                    <DxGridDataColumn FieldName="AddedBy" MinWidth="200" />
                                    <DxGridDataColumn FieldName="AddedDate" Width="180px">
                                        <CellDisplayTemplate>
                                            @{
                                                var item = (Documents)context.DataItem;
                                            }
                                            @Application.Common.Helper.Helper.FormatDateTime(item.AddedDate)
                                        </CellDisplayTemplate>
                                    </DxGridDataColumn>                                   
                                    <DxGridDataColumn FieldName="DocumentId" Caption="Link to DMS" FixedPosition="GridColumnFixedPosition.Left" Width="70">
                                        <CellDisplayTemplate>
                                            @{
                                                var item = (Documents)context.DataItem;
                                            }
                                            @if(item.EmailToDMS > 0)
                                            {
                                                <i class="fa fa-arrow-left" aria-hidden="true" style="margin-right: 5px;cursor:pointer;" onclick="@(() => onBackToDMS(item))" title="Back to DMS"></i>                                                
                                            }
                                            else
                                            {
                                                <i class="fa fa-clone" aria-hidden="true" style="margin-right: 5px;cursor:pointer;" id=@($"flyout-overview-target-container-ProfileType-{item.DocumentId}") onclick="@(() => OnButtonDescriptionClick(item))" title="Link to DMS"></i>
                                            }
                                        </CellDisplayTemplate>
                                    </DxGridDataColumn>
                                </Columns>
                            </DxGrid> *@

                            <EmailAttachment @ref=RefEmailDoc Tid="@Tid" Cid="@Cid" LeftMenu="@isLeftMenuvisible"></EmailAttachment>

                        }
                        else if (isMenuvisible == "Todo")
                        {                           
                            <UserToDo @ref=RefTopicTodo Tid="@Cid"> </UserToDo>
                        }
                        else if (isMenuvisible == "Tags")
                        {
                            <TopicTags @ref=RefTopicTagList TopicId="@Tid" loadTagsList="onloadTagsList"></TopicTags>
                        }
                        else
                        {
                            <ParticipantList @ref=RefTopicAddPList IsValidUser="@IsValidUser" Tid="@Tid" Cid="@Cid"></ParticipantList>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<DxFlyout @bind-IsOpen="@isOpenSubjectPop"                    
          PositionTarget=@($"#showOpenSubject_{CurrentEmailConversations?.ID}")
          Position="FlyoutPosition.Left"
          CloseOnOutsideClick="true"
          FooterVisible="false">
    <BodyTextTemplate>
        <DxMenu Orientation="Orientation.Horizontal">
            <Items>
                <DxMenuItem IconCssClass="fa fa-calendar" @onclick="onSubjectDueDatePop" Text="Due Date" />
                <DxMenuItem IconCssClass="fa fa-ban" @onclick="onCancelDueDatePop" Text="Cancel Due Date" />
                <DxMenuItem IconCssClass="fa fa-text-width" @onclick="@(() => onMarkasAllRead(CurrentEmailConversations.ID))" Text="Mark as all read" />
                <DxMenuItem IconCssClass="fa fa-font" @onclick="onRenameSubjectPop" Text="Rename Subject" />
                <DxMenuItem IconCssClass="fa fa-print" @onclick="onPrintSubjectPop" Text="Print" />
            </Items>
        </DxMenu>
    </BodyTextTemplate>
    <FooterTextTemplate>
        <DxButton Text="close" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxFlyout>

<DxFlyout @bind-IsOpen="@IsOpenFlyout"
          PositionTarget="#showFlyout"
          Position="FlyoutPosition.Left"
          CloseOnOutsideClick="true"
          FooterVisible="false">
           <BodyTextTemplate>
                <DxMenu Orientation="Orientation.Horizontal">
                    <Items>
                        @*<DxMenuItem @onclick="onDueDatePop" Text="Due Date" />
                        <DxMenuItem @onclick="onTopicClosedPop" Text="Close" />*@
                        @*<DxMenuItem @onclick="onAddCategoryPop" Text="Tag" />*@
                        <DxMenuItem @onclick="onArchivePop" Text="Archive" />
                        <DxMenuItem @onclick="onUserTagPop" Text="User Tag"/>
                    </Items>
                </DxMenu>               
            </BodyTextTemplate>
    <FooterTextTemplate>       
        <DxButton Text="close" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxFlyout>

<DxPopup @ref="popup" HeaderText="CRT" ShowCloseButton="true" Width="100%" Height="100%" @bind-Visible="@PreviewDocPopup">
    <BodyContentTemplate>
        <div class="richeditorHeight">
            <DxRichEdit @ref="@richEdit" DocumentFormat="@MyDocumentFormat" DocumentContent="@documentContent" ViewType="ViewType.Simple" BarMode="BarMode.Toolbar" CssClass="w-100" DocumentContentChanged="OnDocumentContentChanged"></DxRichEdit>
        </div>
      @*  <div id="pdfInterop"></div>*@
       @* <iframe src="@documentPreviewUrl" type="@documentMimeType" width="800" height="600"></iframe>
        <iframe src="https://www.example.com" width="100%" height="500"></iframe>*@
    </BodyContentTemplate>    
</DxPopup>



<DxPopup @ref="popup" HeaderText="Doc Delete" ShowCloseButton="true" Width="300px" @bind-Visible="@DocPopupVisible">
    <div class="text-center">
        <Content>
            <p>
                <div Position="Left" id="@("label"+_documents.FileName)" class="display-field"> Do you want to  Delete this <span style="color:red">@_documents.FileName</span> </div>
            </p>
        </Content>        
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitDocDelete(_documents.DocumentId))"/>
        <DxButton CssClass="dx-button.dx-icon" Text="No" Click="@(() => ClosePopup())" />
    </div>
</DxPopup>

<DxPopup @bind-Visible="@isDueDate" HeaderText="Add Due Date">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

        <EditForm Model="@_dataDuDate" OnValidSubmit="@SubmitDueDate" class="w-800">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-md-12" style="padding-bottom: 12px">
                <label for="DueDate"> DueDate: </label>
                <DxDateEdit @bind-Date="@_dataDuDate.DueDate"
                            NullText="Select a date..."
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                            ShowValidationIcon="true"
                            CssClass="cw-320">
                </DxDateEdit>
                <ValidationMessage For="@(() => _dataDuDate.DueDate)" />
            </div>
            <div class="col-md-12">
                <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
            </div>
        </div>
        </EditForm>           
        </div>
       
    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isCancelDueDate"
         ShowFooter="true"
         HeaderText="CRT"
         Closed="EulaPopupClosed"
         Width="300px">
    <BodyContentTemplate>
        <p>Do you want to Cancel Due Date this Subject <span class="txthighlite"> @_cancelSubjectName </span> </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
          <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitCancelDueDate())" RenderStyle="ButtonRenderStyle.Secondary"/>
    </FooterContentTemplate>

</DxPopup>

<DxPopup @bind-Visible="@isSubjectDueDate" HeaderText="Subject Due Date">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

        <EditForm Model="@_dataSubjectDuDate" OnValidSubmit="@SubmitSubjectDueDate" class="w-800">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-md-12" style="padding-bottom: 12px">
                <label for="DueDate"> DueDate: </label>
                <DxDateEdit @bind-Date="@_dataSubjectDuDate.DueDate"
                            NullText="Select a date..."
                                    Mask="dd/MMMM/yyyy"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                            ShowValidationIcon="true"
                            CssClass="cw-320">
                </DxDateEdit>
                <ValidationMessage For="@(() => _dataSubjectDuDate.DueDate)" />
            </div>
            <div class="col-md-12">
                <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
            </div>
        </div>
        </EditForm>           
        </div>
       
    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isUserTagChange" HeaderText="Add/Update UserTag">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@dataUserTag" OnValidSubmit="@SubmitUserTag" class="w-800" Context="EditFormContext">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">  
                    <DxFormLayout>
                       <DxFormLayoutItem Caption="User Tag:" ColSpanMd="12">
                                <DxComboBox Data="@_UserTagList"
                                    AllowUserInput="true"
                                    NullText="Select User Tag..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="UserTag"
                                    ValueFieldName="UserTag"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    @bind-Value="@dataUserTag.UserTag"
                                    @bind-Text="@dataUserTag.UserTag" 
                                    ShowValidationIcon="true">
                                </DxComboBox>
                                <ValidationMessage For="@(() => dataUserTag.UserTag)" />
                            </DxFormLayoutItem>
                    </DxFormLayout>
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>
        </div>

    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isRenameSubject" HeaderText="Rename Subject">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataSubjectName" OnValidSubmit="@SubmitSubjectName" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="DueDate"> Subject Name: </label>
                        <DxTextBox @bind-Text="@_dataSubjectName.SubjectName" ShowValidationIcon="true" NullText="Subject Name" />
                        <ValidationMessage For="@(() => _dataSubjectName.SubjectName)" />
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>
        </div>

    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isTopicClosed" HeaderText="Topic Close">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataTopicClose" OnValidSubmit="@SubmitTopicClose" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="Remarks"> Remarks: </label>
                        <DxMemo @bind-Text="@_dataTopicClose.Remarks"
                                CssClass="cw-480"
                                Rows="5" />
                        <ValidationMessage For="@(() => _dataTopicClose.Remarks)" />
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>

           @* <label>Remarks</label>
            <DxMemo @bind-Text="ClosedMsg"
                    CssClass="cw-480"
                    Rows="5"/>
            <br />
            <DxButton RenderStyleMode="@ButtonRenderStyleMode.Outline"
                      Text="Submit" style="width: 100px !important; float: right;"
                      CssClass="w-100" />*@
        </div>
    </BodyTemplate>
</DxPopup>


<DxPopup @bind-Visible="@isTopicCategoryClosed" HeaderText="Tag" AllowResize="true">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">
           @* <TopicTags TopicId="@Tid" loadTagsList="onloadTagsList"></TopicTags>*@
        </div>
    </BodyTemplate>
</DxPopup>
<DxPopup @bind-Visible="@isArchiveClosed"
         ShowFooter="true"
         HeaderText="CRT"
         Closed="EulaPopupClosed"
         Width="300px">
    <BodyContentTemplate>
        <p>Do you want to Archive this Topic</p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
          <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitIsArchived())" RenderStyle="ButtonRenderStyle.Secondary"/>
    </FooterContentTemplate>

</DxPopup>
@*<DxPopup @bind-Visible="@isArchiveClosed" HeaderText="Archive">
    <BodyTemplate Context="PopupContext">       
    <div class="text-center">
        <Content>
            <p>Do you want to Archive this Topic</p>
        </Content>        
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitIsArchived())"/>
        <DxButton CssClass="dx-button.dx-icon" Text="No" Click="@(() => ClosePopup())" />
    </div>      
    </BodyTemplate>
</DxPopup>*@

<DxPopup @bind-Visible="@isAssignToVisible" HeaderText="Assigned To">
    <BodyTemplate Context="PopupContext">      
        <DxGrid @ref="Grid" Data="_conversationAssignTo"
                KeyFieldName="ID"
                ShowSearchBox="true"
                PagerNavigationMode="PagerNavigationMode.InputBox"
                PageSizeSelectorVisible="true"
                PageSizeSelectorAllRowsItemVisible="true"
                PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                PageSize="20"
                style="height:calc(100vh - 285px);min-height:400px !important"
                CssClass="ch-360">
            <Columns>                          
                <DxGridDataColumn FieldName="RowIndex" Width="35" Caption="#" />
                <DxGridDataColumn FieldName="FirstName" MinWidth="100" />
                <DxGridDataColumn FieldName="LastName" />
            </Columns>
        </DxGrid>

    </BodyTemplate>
</DxPopup>




<DxPopup @bind-Visible="@MessageVisible" HeaderText="@MessageHeader">
    <BodyTemplate Context="PopupContext">
        <div class="@((MessageHeader == "Error" ? "TxtRed" : "TxtGreen"))" style="text-align:center; padding: 10px; font-size: 15px;">
            <span> @MessageBody</span>
        </div>
    </BodyTemplate>
</DxPopup>

@*<DxPopup @bind-Visible="@isFileUpload" HeaderText="Attachments">
    <BodyTemplate Context="PopupContext">
        <div style="padding: 15px;">
            <button id="overviewDemoSelectButton" class="btn border-primary btn-primary m-1">Selected File</button>
            <div class="">              
                <DxUpload @ref="uploadComponent" Name="files"                          
                          Visible="@UploadVisible"                        
                          AcceptedFileTypes=@AcceptedFileTypes
                          UploadMode="@UploadMode.OnButtonClick"                        
                          UploadUrl="@GetUploadUrl()"
                          AllowMultiFileUpload="false"
                          ExternalSelectButtonCssSelector="#overviewDemoSelectButton"                         
                          SelectedFilesChanged="@SelectedFilesChanged"
                          FileUploaded="@isUploadSuccess"
                          FileUploadError="@OnUploadError">
                </DxUpload> 
                <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>               
            </div>
        </div>
    </BodyTemplate>
</DxPopup>*@
<style>
    .dxuc-upload-icon {
        display: none; /* or any other style to disable or hide the icon */
    }
</style>
@*
<button class="btn btn-primary" @onclick="ShowToast">Show Toast</button>

<button class="btn btn-primary" @onclick="@(()=>ToastService.ShowSuccess("welcome to ass"))">Show Toast</button>
*@

<DxFlyout @bind-IsOpen=IsDescriptionOpen
          PositionTarget=@($"#flyout-overview-target-container-ProfileType-{_selectedDescriptionItems?.DocumentId}")
          RestrictionTarget="#Navigation-Flyout-Customization"
          AnimationType="FlyoutAnimationType.Fade"
          PreventCloseOnPositionTargetClick="true"
          HeaderVisible="true"
          HeaderText="Link to DMS"
          FooterVisible="true"
          CloseOnOutsideClick="false"
          FooterCssClass="custom-flyout-footer"
          Width="max(25vw, 550px)"
          Position=@(FlyoutPosition.BottomStart | FlyoutPosition.TopStart)>
    <BodyContentTemplate Context="PopupContext">       
        <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit_FileProfileType">
            <DxFormLayout CssClass="w-100">
                <DataAnnotationsValidator />
                <DxFormLayoutItem Caption="" ColSpanMd="12">                    
                    <DxRadioGroup Items="@FileLinkOptions"
                                  Value="@_dataFileProfileType.Type"
                                  ValueExpression="@(() => _dataFileProfileType.Type )"
                                  ValueChanged="@((string value) => OnFileLinkTypeChanged(value))"
                                  Layout="RadioGroupLayout.Horizontal"
                                  CssClass="dx-demo-radio-group" />
                </DxFormLayoutItem>
                
                @if (_dataFileProfileType.Type == "Link to DMS")
                {                
                    <DxFormLayoutItem Caption="FileProfile Type" ColSpanMd="12">                        
                        <DxTextBox NullText="Select FileProfile Type" @bind-Text="@LinkFilterFileprofiletypeName" CssClass="cw-480">
                            <Buttons>
                                <DxEditorButton IconCssClass="fa fa-add" Id=@($"flyout-overview-target-container-IsFilterFileProfileTypeDocumentOpen")
                                            Tooltip="Select File ProfileType"
                                            Click="@(_ => OnButtonFileProfileTypeLinDocClick())" />
                            </Buttons>
                        </DxTextBox>
                        <DxSpinEdit @bind-Value="@_dataFileProfileType.FileProfileTypeId" BindValueMode="BindValueMode.OnInput" style="display:none;" />
                        <ValidationMessage For="@(() => _dataFileProfileType.FileProfileTypeId)" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem Caption="Company" ColSpanMd="12">
                        <DxComboBox Data="@_plantItems"
                                    NullText="Select Company..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="PlantCode"
                                    ValueFieldName="PlantID"
                                    SelectedItemChanged="@((ViewPlants plantSelect) => SelectedItemChanged(plantSelect?.PlantID))"
                                    Enabled="isPlant"
                                    @bind-Value="@_dataFileProfileType.PlantId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Plant Code"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.PlantId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Division" ColSpanMd="12">
                        <DxComboBox Data="@_divisionItems"
                                    NullText="Select Division..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="Name"
                                    ValueFieldName="DivisionID"
                                    Enabled="isDivision"
                                    SelectedItemChanged="@((ViewDivision plantSelect) => SelectedItemDivisionChanged(plantSelect?.DivisionID))"
                                    @bind-Value="@_dataFileProfileType.DivisionId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewDivision.Name)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewDivision.Code)"
                                                    Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewDivision.Description)"
                                                    Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.DivisionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Department" ColSpanMd="12">
                        <DxComboBox Data="@_departmentItems"
                                    NullText="Select Department..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="DepartmentName"
                                    ValueFieldName="DepartmentId"
                                    Enabled="isDepartment"
                                    SelectedItemChanged="@((ViewDepartment plantSelect) => SelectedItemDepartementChanged(plantSelect?.DepartmentId))"
                                    @bind-Value="@_dataFileProfileType.DepartmentId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentName)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewDepartment.DepartmentCode)"
                                                    Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewDepartment.Description)"
                                                    Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.DepartmentId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Section" ColSpanMd="12">
                        <DxComboBox Data="@_sectionItems"
                                    NullText="Select Section..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="SectionName"
                                    ValueFieldName="SectionId"
                                    Enabled="isSection"
                                    SelectedItemChanged="@((ViewSection plantSelect) => SelectedItemSectionChanged(plantSelect?.SectionId))"
                                    @bind-Value="@_dataFileProfileType.SectionId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewSection.SectionName)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewSection.SectionCode)"
                                                    Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewSection.Description)"
                                                    Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.SectionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="SubSection" ColSpanMd="12">
                        <DxComboBox Data="@_subSectionItems"
                                    NullText="Select SubSection..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="SubSectionName"
                                    ValueFieldName="SubSectionId"
                                    Enabled="isSubSection"
                                    @bind-Value="@_dataFileProfileType.SubSectionId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionName)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewSubSection.SubSectionCode)"
                                                    Caption="Code" />
                                <DxListEditorColumn FieldName="@nameof(ViewSubSection.Description)"
                                                    Caption="Description" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.SubSectionId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Expiry Date:" ColSpanMd="12" Visible="@isExpiryDate">
                        <DxDateEdit NullText="Select a Expiry Date..." MinDate="DateTime.Now" @bind-Date="@_dataFileProfileType.ExpiryDate" CssClass="cw-320" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description" ColSpanMd="12">
                        <DxMemo @bind-Text="@_dataFileProfileType.Description" Rows="5" ShowValidationIcon="true" />
                    </DxFormLayoutItem>

                   
                }
                else 
                {
                    <DxFormLayoutItem Caption="File Replace (Check-In)" ColSpanMd="12">
                        <DxComboBox Data="@_OnFileReplaceList"
                                NullText="Select File Replace (Check-In)..."
                                FilteringMode="DataGridFilteringMode.Contains"
                                ListRenderMode="ListRenderMode.Virtual"
                                TextFieldName="FileName"
                                ValueFieldName="ReplaceDocumentId"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    SelectedItemChanged="@((Documents documents) => onSelectedFileReplaceChanged(documents))"
                                @bind-Value="@_dataFileProfileType.ReplaceDocumentId" ShowValidationIcon="true">
                                <Columns>       
                                    <DxListEditorColumn FieldName="@nameof(Documents.SubjectName)" Caption="Subject Name"/>
                                    <DxListEditorColumn FieldName="@nameof(Documents.FileName)" Caption="FileName"/>
                                    @*<DxListEditorColumn FieldName="@nameof(Documents.AddedBy)" Caption="AddedBy"/>  *@                                  
                                </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _dataFileProfileType.ReplaceDocumentId)" />
                    </DxFormLayoutItem>
                
                }

               

            </DxFormLayout>
        </EditForm>
           
        
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsDescriptionOpen = false) />
        <DxButton RenderStyle="ButtonRenderStyle.Success" Text="Update" Click=@(()=> OnSubmitFileLinked()) />
    </FooterContentTemplate>
</DxFlyout>


<DxFlyout @bind-IsOpen=IsFileProfileTypeFilterDocOpen
          PositionTarget=@($"#flyout-overview-target-container-IsFilterFileProfileTypeDocumentOpen")
          RestrictionTarget="#Navigation-Flyout-Customization"
          AnimationType="FlyoutAnimationType.Fade"
          HeaderVisible="true"
          HeaderText="Select FileProfile Type"
          FooterVisible="true"
          FooterCssClass="custom-flyout-footer"
          Width="max(25vw, 550px)"
          CloseOnOutsideClick="false"
          PreventCloseOnPositionTargetClick="true">
    <BodyContentTemplate Context="PopupContext">
        <DxFormLayout CssClass="w-100" style="height: calc(100vh - 250px);overflow:auto;overflow-x:hidden;">
            <DxFormLayoutItem Caption="">
                <DxTreeView @ref="_treeFilterDocView"
                            @bind-FilterString="FilterDocumentString"
                            ShowFilterPanel="true"
                            FilterMode="NavigationFilterMode.EntireBranch"
                            AllowSelectNodes="true"
                            SelectionChanged="@FileProfileTypeSelectionChanged"
                            Data="@_selectedTreeItems"
                            LoadChildNodesOnDemand="true">
                    <DataMappings>
                        <DxTreeViewDataMapping Text="FileName"
                                               HasChildren="HasChildren"
                                               Children="Children" />
                    </DataMappings>
                </DxTreeView>
            </DxFormLayoutItem>

        </DxFormLayout>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">
                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsFileProfileTypeFilterDocOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>


@code {
    private OpenAccessUserLink _openAccessUserLink { get; set; }
    private List<ViewPlants>? _plantItems;
    private List<ViewDivision>? _divisionItems;
    private List<ViewDepartment>? _departmentItems;
    private List<ViewSection>? _sectionItems;
    private List<ViewSubSection>? _subSectionItems;
    bool isPlant { get; set; } = false;
    bool isDivision { get; set; } = false; bool isDepartment { get; set; } = false;
    bool isSection { get; set; } = false; bool isSubSection { get; set; } = false;
    bool isExpiryDate { get; set; } = false;
    public DocumentProfileNoSeriesModel documentProfileNoSeriesData { get; set; }
    string ExtensionsList = "";
    string SeletedExtensions = "";
    string IsUploadExt = ".isUploadCheckOut";


    string SelectedRadioGroupString { get; set; } = "Link to DMS";
    IEnumerable<string> FileLinkOptions = new[] { "Link to DMS", "File Replace(Check-In)" };
    private List<Documents>? _OnFileReplaceList;
    private DocumentsModel? _selectedDocumentItems;

    string? LinkFilterFileprofiletypeName { get; set; } = null;
    public bool IsFileProfileTypeFilterDocOpen { get; set; }
    EditContext _editContext;
    private DxTreeView _treeFilterDocView;
    string? FilterDocumentString { get; set; }
    private Guid? _activityEmailSessionId { get; set; }
    public List<DocumentsModel> fileProfileTypeDocumentsAll { get; set; }
    IEnumerable<DocumentsModel> _selectedTreeItems = new List<DocumentsModel>();
    void OnButtonFileProfileTypeLinDocClick()
    {
        IsFileProfileTypeFilterDocOpen = true;
    }

    async Task HandleValidSubmit_FileProfileType()
    {  
        if(_dataFileProfileType.Type == "Link to DMS")
        {
            var UpdateReq = new CreateEmailDocFileProfileType
            {
                FilterProfileTypeId = _dataFileProfileType.FileProfileTypeId,
                DocumentId = _selectedDescriptionItems.DocumentId,
                AddedByUserId = applicationUser.UserID,
                SessionId = Guid.NewGuid(),
                AddedDate = DateTime.Now,
                UploadDate = DateTime.Now
            };
            _activityEmailSessionId = UpdateReq.SessionId;
            var result = await Mediator.Send(UpdateReq);
            if (result > 0)
            {
                var filesessionIds = _activityEmailSessionId;
                _dataFileProfileType.SessionId = filesessionIds;
                _dataFileProfileType.FileSessionId = filesessionIds;
                _dataFileProfileType.SourceFrom = "FileProfile";


                DocumentsUploadModel Datas = new DocumentsUploadModel();

                Datas.DocumentId = result;
                Datas.SessionId = _dataFileProfileType.SessionId;
                Datas.FileSessionId = _dataFileProfileType.FileSessionId;
                Datas.SourceFrom = _dataFileProfileType.SourceFrom;
                Datas.FilePath = _dataFileProfileType.FilePath;
                Datas.Description = _dataFileProfileType.Description;
                Datas.FileProfileTypeId = _dataFileProfileType.FileProfileTypeId;
                Datas.PlantId = _dataFileProfileType.PlantId;
                Datas.DepartmentId = _dataFileProfileType.DepartmentId;
                Datas.SectionId = _dataFileProfileType.SectionId;
                Datas.SubSectionId = _dataFileProfileType.SubSectionId;
                Datas.DivisionId = _dataFileProfileType.DivisionId;
                Datas.ProfileNo = _dataFileProfileType.ProfileNo;             
                Datas.ChangeNewFileName = "New File Empty";
                Datas.UserId = applicationUser.UserID;   
                Datas.ProfileId  = _dataFileProfileType.ProfileId;
                Datas.ExpiryDate = _dataFileProfileType.ExpiryDate;

                var response = await Mediator.Send(new UpdateEmailDocumentBySession(Datas));

                await createActivityTag(LinkFilterFileprofiletypeName);
                onShowPopupMessage("success", "Updated File Profile DMS Successfully");
            }

        }
        else
        {
            ExtensionsList = "";
            CheckExtension();           

            if(IsValidFileExtension(ExtensionsList, SeletedExtensions))
            {
                var doclst = await Mediator.Send(new GetByIdDocument(_dataFileProfileType.ReplaceDocumentId));

                if (doclst.IsLocked.GetValueOrDefault(false))
                {
                    toastService.ShowToast("Selected File has been Locked", AC.SD.Core.Services.ToastLevel.Error);
                    return;

                }
                else
                {

                    _selectedDocumentItems = new DocumentsModel();
                    _selectedDocumentItems.DocumentID = doclst.DocumentId;
                    _selectedDocumentItems.DocumentParentId = doclst.DocumentParentId;
                    _selectedDescriptionItems.DocumentParentId = doclst.DocumentParentId;
                    _selectedDocumentItems.FilterProfileTypeId = doclst.FilterProfileTypeId;
                    _selectedDocumentItems.SessionId = doclst.SessionId;
                    _selectedDocumentItems.ProfileNo = doclst.ProfileNo;
                    _selectedDocumentItems.Description = doclst.FileName;
                    _selectedDocumentItems.FileName = doclst.FileName;

                    if (_selectedDocumentItems != null && _selectedDocumentItems.DocumentID > 0)
                    {

                        var res = await Mediator.Send(new GetFileProfileTypeCheckOut(_selectedDocumentItems));

                        var creReq = new CreateEmailDocFileProfileType
                            {
                                FilterProfileTypeId = doclst.FilterProfileTypeId,
                                DocumentId = _selectedDescriptionItems.DocumentId,
                                AddedByUserId = applicationUser.UserID,
                                SessionId = Guid.NewGuid(),
                                AddedDate = DateTime.Now,
                                UploadDate = DateTime.Now
                            };
                        _activityEmailSessionId = _selectedDocumentItems.SessionId;
                        var result = await Mediator.Send(creReq);

                        DocumentsUploadModel Data = new DocumentsUploadModel();

                        //var finaldoclst = await Mediator.Send(new GetByIdDocument(result));


                        Data.IsCheckOut = true;
                        Data.DocumentId = result;
                        Data.DocumentParentId = _selectedDocumentItems.DocumentID;
                        Data.DocumentMainParentId = _selectedDocumentItems.DocumentParentId;
                        Data.UserSession = applicationUser.SessionId;
                        Data.UserId = applicationUser.UserID;
                        Data.ProfileId = _selectedDocumentItems.ProfileID;
                        Data.SessionId = _selectedDocumentItems.SessionId;
                        Data.ProfileNo = _selectedDocumentItems.ProfileNo;
                        Data.FileProfileTypeId = _selectedDocumentItems.FileProfileTypeId > 0 ? _selectedDocumentItems.FileProfileTypeId : _selectedDocumentItems.FilterProfileTypeId;
                        Data.UserId = applicationUser.UserID;
                        // Data.FilePath = finaldoclst.FilePath;
                        // Data.FileSessionId = finaldoclst.SessionId;

                        var responsess = await Mediator.Send(new UpdateEmailDocumentBySession(Data));                       

                        if (doclst.FilterProfileTypeId != null && doclst.FilterProfileTypeId.Value != 0)
                        {
                            var getbackurlSessionid = await Mediator.Send(new GetByFileprofiletypeId(doclst.FilterProfileTypeId));
                            _selectedDescriptionItems.SessionId = getbackurlSessionid.SessionId;
                        }

                        var emailactivity = CreateEmailActivityEntry(_selectedDescriptionItems);


                    }
                }
            }
            else
            {
                toastService.ShowToast("Selected File Extension Mismatch", AC.SD.Core.Services.ToastLevel.Error);
                return;
            }


        }



    }
    static bool IsValidFileExtension(string validExtensions, string fileExtension)
    {
        // Split the valid extensions into an array
        string[] validExtensionsArray = validExtensions.Split(',');

        // Check if the given file extension is in the array
        foreach (string ext in validExtensionsArray)
        {
            if (fileExtension.Equals(ext, StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }
        }

        return false;
    }
    void CheckExtension()
    {
        IsUploadExt = "";

        if (!string.IsNullOrEmpty(_selectedDescriptionItems.Extension))
        {
            var contentType = _selectedDescriptionItems.ContentType != null ? _selectedDescriptionItems.ContentType.Split("/").First().ToLower() : "";
            var extenionType = _selectedDescriptionItems.Extension.ToLower();
            if (extenionType == ".txt")
            {
                AcceptedFileTypes = new List<string>() { ".txt" };
            }
            else if (extenionType == ".pdf")
            {
                AcceptedFileTypes = new List<string>() { ".pdf" };
            }
            else if (extenionType == ".ppt" || extenionType == ".pptx")
            {
                AcceptedFileTypes = new List<string>() { ".ppt", "pptx" };
            }
            else if (extenionType == ".doc" || extenionType == ".docx")
            {
                AcceptedFileTypes = new List<string>() { ".doc", ".docx" };
            }
            else if (extenionType == ".xls" || extenionType == ".xlsx")
            {
                AcceptedFileTypes = new List<string>() { ".xls", ".xlsx" };
            }
            else
            {
                if (contentType == "image")
                {
                    AcceptedFileTypes = new List<string>() { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".tiff", ".tif", ".webp", ".svg" };
                }
                else if (contentType == "video")
                {
                    AcceptedFileTypes = new List<string>() { ".mp4", ".avi", ".mkv", ".mov", ".wmv", ".flv", ".webm", ".3gp", ".mpg", "mpeg" };
                }
                else
                {
                    IsUploadExt = ".isUploadCheckOut";
                }
            }
        }           

        ExtensionsList = string.Join(",", AcceptedFileTypes.ConvertAll(d => d.ToLower()).Distinct().ToList());

        StateHasChanged();

    }
    async Task CreateEmailActivityEntry(Documents documents)
    {
        var Tid = long.Parse(@SelectedGroup);
        var topiclist = await Mediator.Send(new GetListByIdList(Tid));

        string filePath = documents.FileName;
        string subjectName = Path.GetFileNameWithoutExtension(filePath);

        var createReq = new CreateActivityEmail
                {
                    SubjectName = subjectName,
                    Comment = subjectName,
                    ActivityType = "EmailFileProfileType",
                    SessionId = _activityEmailSessionId,
                    BackURL = documents.SessionId.ToString(),
                    DocumentSessionId = _activityEmailSessionId,
                    EmailTopicSessionId = topiclist[0].SessionId ,
                    AddedByUserID = applicationUser.UserID,
                    AddedDate = DateTime.Now

                };

        var result = await Mediator.Send(createReq);

        var resultdoc = await Mediator.Send(new UpdateEmailDmsDocId(_selectedDescriptionItems.DocumentId, result));        


        IsDescriptionOpen = false; 
        IsFileProfileTypeFilterDocOpen = false;        
        FilterDocumentString = null;
        LinkFilterFileprofiletypeName = null;
        _dataFileProfileType.FileProfileTypeId = null;



        if (RTopicId == 0)
        {
            await loadTopicDocList();
        }
        else
        {
            await loadSubTopicDocList();
        }



    }
    async Task createActivityTag(string? tages)
    {
        var Tid = long.Parse(@SelectedGroup);
        var topiclist = await Mediator.Send(new GetListByIdList(Tid));



        string groupTag = "";
        long grouptTagId = 0;
        long catTagId = 0;


        string inputString = tages;
        string[] splitElements = inputString.Split('/');
        foreach (string element in splitElements)
        {
            Console.WriteLine(element.Trim()); // Trim to remove leading and trailing spaces
        }

        List<string> tagStringList = new List<string>();

        for (var j = 0; j < splitElements.Length; j++)
        {
            var ckl = splitElements[j];

            if (j == 0)
            {
                groupTag = ckl; // Assign the first element to groupTag
            }
            else
            {
                tagStringList.Add(ckl); // Add other elements to tagStringList
            }
        }

        string tagString = string.Join("_", tagStringList);

        if (string.IsNullOrEmpty(tagString))
        {
            tagString = groupTag;
        }

        var tagItems = await Mediator.Send(new GetAllApplicationMasterChildListQuery("122"));

        var cktagItem = tagItems.Where(x => x.Value == groupTag).ToList();
        if (cktagItem.Count > 0)
        {
            grouptTagId = cktagItem[0].ApplicationMasterChildId;
        }
        else
        {
            var request = new CreateApplicationMasterChildCommand
                {
                    ApplicationMasterParentId = 122,
                    ParentId = null,
                    Description = groupTag,
                    Value = groupTag,
                    AddedByUserId = applicationUser.UserID,
                    ModifiedByUserId = applicationUser.UserID,
                    AddedDate = DateTime.Now,
                    ModifiedDate = DateTime.Now,
                    StatusCodeId = 1,
                    SessionId = Guid.NewGuid(),
                };
            var rlt = await Mediator.Send(request);
            grouptTagId = rlt.ApplicationMasterChildId;
        }

        if (!string.IsNullOrEmpty(tagString))
        {
            var catItems = await Mediator.Send(new GetAllApplicationMasterChildByIdQuery(grouptTagId));

            var ckcatItem = catItems.Where(x => x.Value == tagString).ToList();
            if (ckcatItem.Count > 0)
            {
                catTagId = ckcatItem[0].ApplicationMasterChildId;
            }
            else
            {
                var request = new CreateApplicationMasterChildCommand
                    {
                        ApplicationMasterParentId = 123,
                        ParentId = grouptTagId,
                        Description = tagString,
                        Value = tagString,
                        AddedByUserId = applicationUser.UserID,
                        ModifiedByUserId = applicationUser.UserID,
                        AddedDate = DateTime.Now,
                        ModifiedDate = DateTime.Now,
                        StatusCodeId = 1,
                        SessionId = Guid.NewGuid(),
                    };                
                var rlt = await Mediator.Send(request);

                catTagId = rlt.ApplicationMasterChildId;

                await createApplicationMasterChild(124, catTagId, "Review");
                await createApplicationMasterChild(124, catTagId, "Discussion");
            }
        }



        var MainSessionId = _dataFileProfileType.sessionId;
        var doclist = _selectedDescriptionItems;



        //var items = await Mediator.Send(new GetActivityEmailList(_selectedItems.SessionID.Value));

        //if (items.Count == 0)
        //{
        var sessionId = _selectedDescriptionItems.ScreenId;
        string filePath = _selectedDescriptionItems.FileName;
        string subjectName = Path.GetFileNameWithoutExtension(filePath);

        var createReq = new CreateActivityEmail
                {
                    SubjectName = subjectName,
                    Comment = _selectedDescriptionItems.Description,
                    ActivityType = "EmailFileProfileType",
                    SessionId = _activityEmailSessionId,
                    BackURL = MainSessionId.ToString(),
                    DocumentSessionId = _activityEmailSessionId,
                    EmailTopicSessionId = topiclist[0].SessionId ,
                    AddedByUserID = applicationUser.UserID,
                    AddedDate = DateTime.Now,
                    ManufacturingProcessId = grouptTagId,
                    CategoryActionId = catTagId

                };

        var result = await Mediator.Send(createReq);

        var resultdoc = await Mediator.Send(new UpdateEmailDmsDocId(_selectedDescriptionItems.DocumentId, result));

        IsDescriptionOpen = false; 
        IsFileProfileTypeFilterDocOpen = false;        
        FilterDocumentString = null;
        LinkFilterFileprofiletypeName = null;
        _dataFileProfileType.FileProfileTypeId = null;



        if (RTopicId == 0)
        {
            await loadTopicDocList();
        }
        else
        {
            await loadSubTopicDocList();
        }

        //}


    }
    async Task createApplicationMasterChild(long MasterParentId, long ParentId, string notes)
    {

        var request = new CreateApplicationMasterChildCommand
            {
                ApplicationMasterParentId = MasterParentId,
                ParentId = ParentId,
                Description = notes,
                Value = notes,
                AddedByUserId = applicationUser.UserID,
                ModifiedByUserId = applicationUser.UserID,
                AddedDate = DateTime.Now,
                ModifiedDate = DateTime.Now,
                StatusCodeId = 1,
                SessionId = Guid.NewGuid(),
            };
        await Mediator.Send(request);
    }
    protected async Task FileProfileTypeSelectionChanged(TreeViewNodeEventArgs e)
    {
        _dataFileProfileType.PlantId = 0; _dataFileProfileType.DepartmentId = 0;
        _dataFileProfileType.DivisionId = 0; _dataFileProfileType.SectionId = 0; _dataFileProfileType.SubSectionId = 0;


        if (e.NodeInfo?.DataItem != null)
        {
            var nodeName = e.NodeInfo.DataItem as DocumentsModel;
            var ids = nodeName.FileProfileTypeId;
            var lists = GetFileProfileTypePath(fileProfileTypeDocumentsAll, nodeName.FileProfileTypeId);
            LinkFilterFileprofiletypeName = lists.FirstOrDefault()?.FileProfilePath;
            _dataFileProfileType.FileProfileTypeId = nodeName.FileProfileTypeId;
            _dataFileProfileType.ProfileId = nodeName.ProfileID;
            _dataFileProfileType.sessionId = nodeName.SessionId;
        }

        if (_dataFileProfileType != null && _dataFileProfileType.ProfileId > 0)
        {
            _dataFileProfileType = _dataFileProfileType;

            documentProfileNoSeriesData = await Mediator.Send(new GetDocumentProfileNoSeriesById(_dataFileProfileType.ProfileId));

            dynamic abbreviation = JsonConvert.DeserializeObject(documentProfileNoSeriesData.Abbreviation1);
            if (abbreviation != null)
            {
                foreach (var item in abbreviation)
                {
                    var itemsId = item.Id;
                    if (itemsId == 1)
                    {
                        isPlant = true;
                        _dataFileProfileType.PlantId = null;
                    }
                    if (itemsId == 2)
                    {
                        isDepartment = true; isDivision = true;
                        _dataFileProfileType.DepartmentId = null;
                        _dataFileProfileType.DivisionId = null;
                    }
                    if (itemsId == 3)
                    {
                        isSection = true;
                        _dataFileProfileType.SectionId = null;
                    }
                    if (itemsId == 4)
                    {
                        isSubSection = true;
                        _dataFileProfileType.SubSectionId = null;
                    }
                }
            }
            if (_dataFileProfileType.IsExpiryDate == true)
            {
                isExpiryDate = true;
            }
        }

        IsFileProfileTypeFilterDocOpen = false;
        StateHasChanged();
    }
    private List<FileProfileTypeModel>
       GetFileProfileTypePath(List<DocumentsModel>
       foldersListItem, long? id)
    {
        var foldersListItems = foldersListItem.Where(t => t.FileProfileTypeId == id).ToList();
        FileProfileTypeModel fileprofile = new FileProfileTypeModel();
        List<FileProfileTypeModel>
        foldersList = new List<FileProfileTypeModel>
        ();
        if (foldersListItems != null && foldersListItems.Count > 0)
        {
            foldersListItems.ForEach(s =>
            {
                List<string>FolderPathLists = new List<string>();
                FileProfileTypeModel fileProfileTypeModel = new FileProfileTypeModel();
                fileProfileTypeModel.FileProfileTypeId = s.FileProfileTypeId.Value;
                fileProfileTypeModel.Name = s.FileName;
                fileprofile = GetProfileTypeName(foldersListItem, s, FolderPathLists, fileprofile);
                FolderPathLists.Add(s.FileName);
                fileProfileTypeModel.FileProfileTypeParentId = fileprofile.ParentId;
                fileProfileTypeModel.FileProfilePath = string.Join(" / ", FolderPathLists);
                foldersList.Add(fileProfileTypeModel);
            });
        }
        return foldersList;
    }
    private FileProfileTypeModel GetProfileTypeName(List<DocumentsModel>
        foldersListItems, DocumentsModel s, List<string>
        foldersModel, FileProfileTypeModel fileProfileTypeModel)
    {

        if (s.ParentId != null)
        {
            var items = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.ParentId);
            GetProfileTypeName(foldersListItems, items, foldersModel, fileProfileTypeModel);
            foldersModel.Add(items.FileName);
        }
        else if (s.ParentId == null)
        {
            fileProfileTypeModel.ParentId = foldersListItems.FirstOrDefault(f => f.FileProfileTypeId == s.FileProfileTypeId)?.FileProfileTypeId;
        }
        return fileProfileTypeModel;
    }

    private FileProfileType _dataFileProfileType = new FileProfileType();

    private class FileProfileType
    {
        [Required(ErrorMessage = "FileProfile is Required")]
        public long? FileProfileTypeId { get; set; }
        public Guid? sessionId { get; set; }
        public string? Type { get; set; }

        [Required(ErrorMessage = "Select File is Required")]
        public long? ReplaceDocumentId { get; set; }  


        [Required(ErrorMessage = "Company is Required")]
        public long? PlantId { get; set; } = 0;
        [Required(ErrorMessage = "Department is Required")]
        public long? DepartmentId { get; set; } = 0;
        [Required(ErrorMessage = "Section is Required")]
        public long? SectionId { get; set; } = 0;
        [Required(ErrorMessage = "SubSection is Required")]
        public long? SubSectionId { get; set; } = 0;
        [Required(ErrorMessage = "Division is Required")]
        public long? DivisionId { get; set; } = 0;
        public string? CompanyCode { get; set; }
        public string? SectionName { get; set; }
        public string? SubSectionName { get; set; }
        public string? DepartmentName { get; set; }
        public string? ProfileNo { get; set; }
        public string? Description { get; set; }

        public Guid? SessionId { get; set; }
        public Guid? FileSessionId { get; set; }
        public string? SourceFrom { get; set; }
        public string? FilePath { get; set; }
        public bool? IsExpiryDate { get; set; }
        public long? ProfileId { get; set; }
        public DateTime? ExpiryDate { get; set; }

    }
    void onSelectedFileReplaceChanged(Documents documents)
    {
        if(documents != null)
        {
            SeletedExtensions = Path.GetExtension(documents.FileName);

            isPlant = false;
            _dataFileProfileType.PlantId = 0;

            isDepartment = false; isDivision = false;
            _dataFileProfileType.DepartmentId = 0;
            _dataFileProfileType.DivisionId = 0;

            isSection = false;
            _dataFileProfileType.SectionId = 0;


            isSubSection = false;
            _dataFileProfileType.SubSectionId = 0;
        }


    }
    void OnFileLinkTypeChanged(string? radioValue)
    {
        _dataFileProfileType.Type = radioValue;

        if (radioValue == "Link to DMS")
        {
            LinkFilterFileprofiletypeName = null;
            //_dataFileProfileType.Description = null;

            _dataFileProfileType.FileProfileTypeId = null;
            _dataFileProfileType.ReplaceDocumentId = 0;

            // isPlant = false;
            // _dataFileProfileType.PlantId = null;

            // isDepartment = false; isDivision = false;
            // _dataFileProfileType.DepartmentId = null;
            // _dataFileProfileType.DivisionId = null;

            // isSection = false;
            // _dataFileProfileType.SectionId = null;

            // isSubSection = false;
            // _dataFileProfileType.SubSectionId = null;

        }

        if (radioValue == "File Replace(Check-In)")
        {
            _dataFileProfileType.FileProfileTypeId = 0;
            _dataFileProfileType.ReplaceDocumentId = null;

            _dataFileProfileType.PlantId = 0; _dataFileProfileType.DepartmentId = 0; 
            _dataFileProfileType.DivisionId = 0; _dataFileProfileType.SectionId = 0; _dataFileProfileType.SubSectionId = 0;



        }        

        StateHasChanged();
    }


    private class FileReplace
    {

    }



    bool IsDescriptionOpen { get; set; } = false;
    bool IsRenameOpen { get; set; } = false;
    bool IsFilterOpen { get; set; } = false;
    public bool IsExpiryDateOpen { get; set; } = false;
    Documents _selectedDescriptionItems = new Documents();
    async Task onBackToDMS(Documents item)
    {
        if(item.EmailToDMS != null)
        {
            onBackFileProfileType(item.DMSBackUrl);
            JSRuntime.InvokeAsync<string>("ReloadUrl");
        }
    }

    public async Task loadFileProfileDDData()
    {
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        await SelectedItemChanged(0);
        await SelectedItemDivisionChanged(0);
        await SelectedItemDepartementChanged(0);
        await SelectedItemSectionChanged(0);



        isPlant = false;
        _dataFileProfileType.PlantId = null;

        isDepartment = false; isDivision = false;
        _dataFileProfileType.DepartmentId = null;
        _dataFileProfileType.DivisionId = null;

        isSection = false;
        _dataFileProfileType.SectionId = null;


        isSubSection = false;
        _dataFileProfileType.SubSectionId = null;


        StateHasChanged();        
    }
    async Task SelectedItemChanged(long? plantID)
    {
        _divisionItems = new List<ViewDivision>();
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (plantID > 0)
        {
            _divisionItems = await Mediator.Send(new GetDivisionByCompany(plantID));

            //  isDepartment = true; isDivision = true;
            // _dataFileProfileType.DepartmentId = null;
            // _dataFileProfileType.DivisionId = null;
        }
    }
    async Task SelectedItemDivisionChanged(long? divisionId)
    {
        _departmentItems = new List<ViewDepartment>();
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (divisionId > 0)
        {
            _departmentItems = await Mediator.Send(new GetDepartmentByDivision(divisionId));

            //  isSection = true;
            // _dataFileProfileType.SectionId = null;

        }
    }
    async Task SelectedItemDepartementChanged(long? departmentId)
    {
        _sectionItems = new List<ViewSection>();
        _subSectionItems = new List<ViewSubSection>();
        if (departmentId > 0)
        {
            _sectionItems = await Mediator.Send(new GetSectionByDepartment(departmentId));

            //  isSubSection = true;
            // _dataFileProfileType.SubSectionId = null;
        }
    }
    async Task SelectedItemSectionChanged(long? sectionId)
    {
        _subSectionItems = new List<ViewSubSection>();
        if (sectionId > 0)
        {
            _subSectionItems = await Mediator.Send(new GetSubSectionBySection(sectionId));
        }
    }

    async Task OnButtonDescriptionClick(Documents items)
    {

        //_dataFileProfileType = new FileProfileType();       
        LinkFilterFileprofiletypeName = null;
        _dataFileProfileType.PlantId = null;
        _dataFileProfileType.DepartmentId = null;
        _dataFileProfileType.DivisionId = null;
        _dataFileProfileType.SectionId = null;
        _dataFileProfileType.SubSectionId = null;
        _dataFileProfileType.Description = null;

        OnFileLinkTypeChanged("Link to DMS");



        await loadFileProfileDDData();

        IsExpiryDateOpen = false; IsRenameOpen = false;
        _selectedDescriptionItems = new Documents();
        _selectedDescriptionItems.FilterProfileTypeId = items.FilterProfileTypeId;
        _selectedDescriptionItems.DocumentId = items.DocumentId;
        _selectedDescriptionItems.Description = items.Description;    
        _selectedDescriptionItems.FileName = items.FileName;
        _selectedDescriptionItems.ContentType = items.ContentType;
        _selectedDescriptionItems.Extension = Path.GetExtension(items.FileName);
        _selectedDescriptionItems.SessionId = items.SessionId;
        //_selectedDescriptionItems.Type = items.Type;
        _selectedDescriptionItems.ModifiedDate = DateTime.Now;
        _selectedDescriptionItems.ModifiedByUserId = applicationUser.UserID;

        fileProfileTypeDocumentsAll = await Mediator.Send(new GetAllfileprofiletypeListQuery());
        if (fileProfileTypeDocumentsAll.Count() > 0)
        {
            _selectedTreeItems = _treeGenerateRecursive.TreeGenerateRecursives(fileProfileTypeDocumentsAll);
        }

        IsDescriptionOpen = true;

        StateHasChanged();
    }   

    async Task OnSubmitFileLinked()
    {       
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit_FileProfileType();
        }
    }

    int SelectedFilesCount { get; set; }
    int CurrentUplodCount { get; set; }
    string MyMessage { get; set; }
    string Message = "Upload";

    void OnUploadProgressChanged(FileUploadEventArgs e)
    {
        var progress = e.FileInfo.LoadedBytes / e.FileInfo.Size * 100;
    }
    async Task OnFileUploadStart(FileUploadStartEventArgs e)
    {
        Message = "Uploading...";
        loading = true;
        var SessionId = _sessionId;        
        string BaseUrl = NavigationManager.BaseUri + "api/FileUpload/";            
        string url = BaseUrl + "UploadDocumentsBySession?SessionId=" + _sessionId + "&addedByUserId=" + AppUserId + "&IsNewSession=false&SourceFrom=Email";
        e.UploadUrl = url;
    }
    void OnFileUploadStarted(FileUploadEventArgs e)
    {
        MyMessage = "Upload of the " + e.FileInfo.Name + " file was started.";
        toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Info);
        InvokeAsync(StateHasChanged);
    }

    private string toggleButtonVisible = "ActiveToggle";
    private string hiddenButtonCssClass = "col-md-9";
    private string? ProductActivityBaseUrl;
    public int ActiveTabIndex { get; set; } = 1;
    string? SearchText { get; set; }
    string? MyDayFilterText  = null;
    string? GridSearchText { get; set; }
    bool PreviewEnabled { get; set; } = false;
    bool docEnabled { get; set; } = false;
    int newSubjectreply = 0;
    bool isPushNotification { get; set; } = false;
    private CancellationTokenSource cancellationTokenSource;
    private const int AutoRefreshInterval = 10000; // 10 seconds
    private Documents _selectlst;
    [Parameter]
    public string ActiveSessionId { get; set; }
    [Parameter]
    public Guid TodoSessionId { get; set; }
    [Parameter]
    public string Page { get; set; }
    public string filterrowname { get; set; }
    private bool IsConHistory = false;
    [Parameter]
    public EventCallback<string> RId { get; set; }
    IGrid TOGrid { get; set; }
    IGrid CCGrid { get; set; }
    IGrid SentGrid { get; set; }
    DxWindow dxWindow;
    bool WindowVisible { get; set; } = false;
    private bool IsReadOnly = true;

    private List<EmailTopics>? _forumTopicTo;
    private List<EmailTopics>? _forumTopicCC;
    private List<EmailTopics>? _forumTopicSent;

    private int ElementHeight { get; set; }
    [Parameter]
    public long Tid { get; set; }
    [Parameter]
    public long Cid { get; set; }
    public long RTopicId = 0;
    bool IsOpen { get; set; } = false;
    bool IsOpenFlyout { get; set; } = false;
    bool isOpenSubjectPop { get; set; } = false;
    bool isOpenSubjectNamePop { get; set; } = false;
    string dynamicShowSubject = "showOpenSubject_";    
    Selection selection; 
    Selection richSelection { get; set; }
    [Parameter]
    public EventCallback<IToolbar> CustomizeToolbar { get; set; }
    bool ErrorVisible { get; set; } = false;
    string MyError { get; set; }
    [Parameter]
    public List<string> AcceptedFileTypes { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF",".msg",".ai"};
    public List<string> AllowedFileExtensions { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx",".txt",".pdf",".PDF",".msg",".ai"};
    public DocumentFormat MyDocumentFormat { get; set; }
    private string? BaseUrl;
    private string? FileUrl;
    private string? DocumentViewUrl;
    string documentPath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
    string documentFormat = "docx";
    private ElementReference OfficeContainerRef;
    DxRichEdit richEdit { get; set; }
    DxRichEdit msgrichEdit { get; set; }
    string previewUrl;
    private string documentPreviewUrl;
    private string documentMimeType;
    byte[] documentContent;
    byte[] msgContent;
    DxUpload MyUpload { get; set; }
    bool UploadVisible { get; set; } = true;
    bool AttachmentUploadVisible { get; set; } = false;
    bool isDescription { get; set; } = false;
    private bool uploadSuccess = false;
    IEnumerable<UploadFileInfo> Files { get; set; }
    UploadFileInfo FirstFile { get; set; }
    public string MyHeight { get; set; } = "200px";
    string width = "800px", height = "800px";
    private ParticipantList? RefTopicAddPList { get; set; }
    private AssignToEmail? RefAssignTo { get; set; }
    private AllEmail? RefAssignAll{ get; set; }
    private TopicTags? RefTopicTagList { get; set; }
    private UserToDo? RefTopicTodo { get; set; }
    private EmailAttachment? RefEmailDoc { get; set; }
    private MasterSearch? RefMasterSearch { get; set; }
    private AdminEmail? RefAdminSearch { get; set; }
    private bool IsValidUser { get; set; } = false;
    private bool IsFileValidUser { get; set; } = false;
    [Parameter]
    public EventCallback<string> Participent { get; set; }
    private async Task OnWindowResizeCompleted(WindowResizeCompletedEventArgs args) {
        // (width, height) = ($"{args.Size.Width}px", $"{args.Size.Height}px");
        (width) = ($"{args.Size.Width}px");
        MyHeight =  $"{args.Size.Height}px";
        string setHeight = $"{args.Size.Height - 320}";
        string selector = ".editor-box-height";

        //await JSRuntime.InvokeVoidAsync("adjustHeight", setHeight);
        await JSRuntime.InvokeVoidAsync("setHeight", selector, setHeight);
    }
    private void ShowSubjectFlyout(EmailConversations emailConversations) {
        CurrentEmailConversations = emailConversations;
        isOpenSubjectPop = true;
    }
    async Task onMarkasRead(long Id)
    {
        var request = await Mediator.Send(new UpdateMarkasRead(Id));

        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }

        if(isLeftMenuvisible == "AssignTo")
        {
            await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
        }

        if (isLeftMenuvisible == "All")
        {
            await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
        }

    }
    async Task onMarkasunRead(long Id)
    {
        var request = await Mediator.Send(new UpdateMarkasunRead(Id));

        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }

        if (isLeftMenuvisible == "AssignTo")
        {
            await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
        }
        if (isLeftMenuvisible == "All")
        {
            await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
        }


    }
    private async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }
    private void ToggleButtonClick()
    {
        toggleButtonVisible = toggleButtonVisible == "HiddenToggle" ? "ActiveToggle" : "HiddenToggle";        
        hiddenButtonCssClass = toggleButtonVisible == "HiddenToggle" ? "col-md-12" : "col-md-9";
    }
    private class Model
    {
        [Required(ErrorMessage = "Due Date is required")]
        public DateTime? DueDate { get; set; }      
    }
    private class UserTagData
    {
        public string? UserTag { get; set; }
        public long? UserTagId { get; set; }        
    }
    private class ModelClose
    {
        [Required(ErrorMessage = "Remarks is required")]
        public string? Remarks { get; set; }
    }  
    private class SubjectNameModel
    {
        [Required(ErrorMessage = "Subject Name is required")]
        public string? SubjectName { get; set; } 
    }
    private DxUpload uploadComponent;  

    private Model _dataDuDate = new Model();
    private Model _dataSubjectDuDate = new Model();
    private UserTagData dataUserTag = new UserTagData();
    private ModelClose _dataTopicClose = new ModelClose();
    private SubjectNameModel _dataSubjectName = new SubjectNameModel();

    string ClosedMsg { get; set; }
    DateTime? DateTimeValue { get; set; }
    DxPopup? popup;
    bool PopupVisible { get; set; } = false;
    bool DocPopupVisible { get; set; } = false;
    bool PreviewDocPopup { get; set; } = false;
    private Dictionary<int, bool> itemVisibility = new Dictionary<int, bool>();
    private Dictionary<int, bool> DocitemVisibility = new Dictionary<int, bool>();
    private Dictionary<long, bool> topicitemVisibility = new Dictionary<long, bool>();
    AccordionExpandMode ExpandMode { get; set; } = AccordionExpandMode.SingleOrNone;
    AccordionExpandCollapseAction ExpandCollapseAction { get; set; } = AccordionExpandCollapseAction.HeaderClick;

    string isMenuvisible = "Posts";
    string isLeftMenuvisible = "AssignTo";
    DxTreeView treeView;
    IGrid? Grid { get; set; }
    bool isFileUpload = false;
    bool isDueDate =false;
    bool isSubjectDueDate = false;
    bool isUserTagChange = false;
    private List<EmailActivityCatgorys> _UserTagList;
    bool isCancelDueDate = false;
    string _cancelSubjectName = "";
    bool isRenameSubject = false;
    bool isTopicClosed = false;
    bool isTopicCategoryClosed = false;
    bool isArchiveClosed = false;
    bool isAllPlistVisible = false;
    bool isAssignToVisible = false;
    bool isComponentVisible = true;
    bool isEnabled { get; set; } = false;
    bool isPage { get; set; } = false;
    bool isTodoEnabled { get; set; } = false;
    bool isAddParticipant = false;
    bool isTags = false;
    bool isCommand = false;
    bool isCommandTopicClosed = true;
    bool isEllipsis = false;
    long? AppUserId;
    private List<Documents>? _topicDocList;    
    private List<EmailTopics>? _topics;
    public List<EmailConversations> _getConversationList;
    public List<EmailConversations> _discussionList;
    private EmailConversations CurrentEmailConversations { get; set; }
    public List<EmailConversations> _discussionFullList;
    public List<EmailConversations> _replyComment;
    private List<EmailTopics>? _headTopic;
    private List<EmailActivityCatgorys>? _headTopic_Tag;
    private List<EmailActivityCatgorys>? _headTopic_UserTag;
    string FilterString { get; set; }
    private List<EmailParticipant>? _participant;
    EmailParticipant _participantLst { get; set; }
    Documents _documents { get; set; }
    private List<ViewEmployee>? _allparticipant;

    private List<ViewEmployee>? _Toparticipant;
    private List<ViewEmployee>? _CCparticipant;

    private List<ViewEmployee>? _allparticipants;

    List<string> sToIds = new List<string>();
    List<string> sCCIds = new List<string>();

    private List<EmailConversationAssignTo>? _conversationAssignTo;
    private List<ViewEmployee>? _selectedlistpartlist;
    NavigationFilterMode FilterMode { get; set; } = NavigationFilterMode.EntireBranch;    
    EmailConversations? Data { get; set; } = new EmailConversations();
    string SelectedGroup = "none";
    string SelectedReplyId = "none";
    public ApplicationUser applicationUser { get; private set; }
    IReadOnlyList<object>? SelectedDataItems { get; set; }
    List<long> participantIds = new List<long>();
    private bool loading;
    bool MessageVisible { get; set; }
    string styleClass = "";
    string MessageHeader = "Error";
    string MessageBody = "";
    Guid? _sessionId;
    private string uploadUrl;   
    private List<EmailAssignToList>? _assigntoItems;

    byte[] myBytes = Encoding.UTF8.GetBytes("Attachments");

    [Parameter]
    public ViewEmployee _employeeDatas { get; set; }
    [Parameter]
    public ApplicationUser _applicationUser { get; set; }

    [Parameter]
    public UploadMode UploadMode { get; set; }
    private string myFile { get; set; }

    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    IEnumerable<UploadFileInfo> Filess { get; set; }

    void OnRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "DocumentId");
        _selectlst = _topicDocList.FirstOrDefault(f => f.DocumentId == (long?)UniqueId);

    }
    void ApplySearch()
    {       
        //var assignToEmailComponent = new AssignToEmail();
        //assignToEmailComponent.ApplySearch(GridSearchText);
    }
    private async Task ScrollToElement()
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", ".msgOpen");
    }
    async Task CloseClick(MouseEventArgs args)
    {
        await dxWindow.CloseAsync();
        closeReply();
    }
    protected async void SelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        SelectedFilesCount = files.ToList().Count;       
        await InvokeAsync(StateHasChanged);
        uploadSuccess = false;
        if(files.ToList().Count > 0)
            await UploadFiles();
    }
    protected async void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
        SelectedFilesCount = files.ToList().Count; //Count current files
        InvokeAsync(StateHasChanged);
    }
    bool UploadVisible1 { get; set; } = false;
    protected void SelectedFilesChanged1(IEnumerable<UploadFileInfo> files)
    {
        Filess = files;
        SelectedFiles.AddRange(files);
        UploadVisible1 = files.ToList().Count > 0;   

        InvokeAsync(StateHasChanged);
    }   
    private void RemoveFile(UploadFileInfo file)
    {
        SelectedFiles.Remove(file);
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
            e.CssClass += "non-selectable-row";
        }
        //if (e.ElementType == GridElementType.HeaderCell)
        //{
        //    e.Style = "background-color: rgba(0, 0, 0, 0.08)";
        //    e.CssClass = "header-bold";
        //}
    }
    void onSelectedToItemsChanged(IEnumerable<ViewEmployee> values)
    {
        if (values != null)
        {
            // Update _CCparticipant based on selected values from _Toparticipant
            _CCparticipant = _allparticipants.Except(values).ToList();
        }
        else
        {
            // Reset _CCparticipant to all participants if nothing is selected in _Toparticipant
            _CCparticipant = _allparticipants.ToList();
        }
    }

    void onSelectedCCItemsChanged(IEnumerable<ViewEmployee> values)
    {
        if (values != null)
        {
            // Update _Toparticipant based on selected values from _CCparticipant
            _Toparticipant = _allparticipants.Except(values).ToList();
        }
        else
        {
            // Reset _Toparticipant to all participants if nothing is selected in _CCparticipant
            _Toparticipant = _allparticipants.ToList();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {   
            await JSRuntime.InvokeVoidAsync("window.addEventListener", "scroll", DotNetObjectReference.Create(this).Value, "HandleScroll");
        }


        if (uploadSuccess)
        {
            // Invoke another function here
            //AnotherFunction();
        }
    }
    public async Task onDisDocDownload(string FilePath)
    {
        var url = FileUrl + FilePath;
        await OpenUrlInNewTab(url);        
    }

    [JSInvokable("handleScroll")]
    public void HandleScroll(string scrollDirection)
    {
        if (scrollDirection == "down")
        {
            // Scroll down logic
            var scrollY = JSRuntime.InvokeAsync<int>("window.scrollY").Result;
            var scrollDirection1 = scrollY < 100 ? "up" : "down";

            if (scrollDirection1 == "up")
            {
                //isScrollingUp = true;
                //isScrollingDown = false;
            }
            else
            {
                //isScrollingUp = false;
                //isScrollingDown = true;
            }

            StateHasChanged();



        }
        else if (scrollDirection == "up")
        {
            // Scroll up logic
        }
    }
    private async Task InitializeViewer()
    {
        await JSRuntime.InvokeVoidAsync("loadViewerJS");
        string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";
        // Set the document URL
        string documentUrl = filePath;
        await JSRuntime.InvokeVoidAsync("openViewer", "viewerContainer", documentUrl);


    }
    private async Task isUploadSuccess_old()
    {
        uploadComponent.RemoveAllFiles();
        isFileUpload = false;
        await LoadData();
    }
    private void isUploadSuccess(FileUploadEventArgs e)
    {
        MyMessage = "Upload of the " + e.FileInfo.Name + " file is Completed.";
        toastService.ShowToast(MyMessage, AC.SD.Core.Services.ToastLevel.Success);
        CurrentUplodCount++;
        if (CurrentUplodCount >= SelectedFilesCount)
        {
            Message = "Upload";
            //loading = false;
            afterUploadClosed();
        }
        InvokeAsync(StateHasChanged);

    }
    async Task afterUploadClosed()
    {
        onRestText();
        closeReply();
        onloadSession();

        // await msgrichEdit.NewDocumentAsync();
        await onloadTwoGrid();

        if (RTopicId == 0)
        {
            await LoadDataPosts();
        }
        else
        {
            await LoadReplyDataPosts();
        }

        WindowVisible = false;
        loading = false;

        StateHasChanged();
    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleUploadSuccess()
    {   

        FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);

        //MyUpload.RemoveAllFiles();
        ///SelectedFiles.Clear();
        await AnotherFunction();
        // await TriggerCancelIcon();
    }

    async Task OnButtonClick()
    {
        var FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);      
    }   
    private async Task TriggerCancelIcon()
    {      
        await JSRuntime.InvokeVoidAsync("myFunction()");
        await JSRuntime.InvokeVoidAsync("createToast(success)");
    }

    private async Task AnotherFunction()
    {
        await LoadData();

    }

    private void OpenFileUpload()
    {
        //uploadComponent.OpenFileDialog();
    }    
    public string GetDocUploadUrl(Guid? sId)
    {
        //var sessionId = Guid.NewGuid();

        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + sId + "&addedByUserId="+ AppUserId;
        return url.ToString();
    }
    public string GetUploadUrl()
    {
        //var sessionId = Guid.NewGuid();

        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + _sessionId + "&addedByUserId="+ AppUserId;
        return url.ToString();
    }
    private void closeUploadFiles()
    {
        isFileUpload = false;
        var lst = SelectedFilesCount;
    }
    private async Task UploadFiles()
    {
        //var lst = SelectedFilesCount;    
        byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false);


        string assignCCidsString = string.Join(",", _assigntoItems.Select(s => s.UserID).ToList());
        string assigntoidsString = string.Join(",", Data.AssigntoIds);

        var createReq = new CreateEmailCoversation
            {

                TopicID = (long.Parse(@SelectedGroup)),
                Message = Data.Message != null ? Data.Message : "Attachments",
                FileData = fileContent.Length == 480 ? myBytes : fileContent,
                //AssigntoIds = Data.AssigntoIds.Count() == 0 ? _assigntoItems.Select(s => s.UserID).ToList() : Data.AssigntoIds,
                AssigntoIdss = Data.AssigntoIds.Count() == 0 ? assignCCidsString : assigntoidsString,
                //FileData = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false),
                ParticipantId = applicationUser.UserID,
                ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = _sessionId
            };
        // _sessionId = createReq.SessionId;
        var result = await Mediator.Send(createReq);       
        isFileUpload = false;
        //uploadComponent.UploadAllFiles();
        var rls =   Task.Run(() => uploadComponent.UploadAllFiles());

        await Task.Delay(2000); // Delay for 2 seconds
        await LoadData();
        onRestText();
        closeReply();
        onloadSession();
        //HandleScroll("down");
        await msgrichEdit.NewDocumentAsync();
        //uploadComponent.UploadAllFiles();
    }
    public void ClearUploadedFiles()
    {
        uploadComponent.CancelAllFilesUpload();
    }
    async Task OnFileUploaded(FileUploadEventArgs e)
    {
        var request = new EditDocumentCommand
            {
                AddedByUserId = _applicationUser.AddedByUserID,
                ModifiedByUserId = _applicationUser.ModifiedByUserID,
                SessionId = _employeeDatas.SessionId,
            };
        var response = await Mediator.Send(request);       
        await InvokeAsync(StateHasChanged);

    }
    private void onTopicClosedPop()
    {
        isTopicClosed = true;
    }
    private void onAddCategoryPop()
    {
        isTopicCategoryClosed = true;
    } 
    private void onArchivePop()
    {
        isArchiveClosed = true;
    }     
    private void showTopicDescription()
    {
        isDescription = true;
    }
    private void hideTopicDescription()
    {
        isDescription = false;
    }
    async void onDueDatePop()
    {
        isDueDate = true;       
    }
    async void onSubjectDueDatePop()
    {
        isSubjectDueDate = true;
        _dataSubjectDuDate.DueDate = CurrentEmailConversations.DueDate;
    }
    async void onUserTagPop()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        _UserTagList = await Mediator.Send(new GetAllUserActivityCatgorys(applicationUser.UserID)); 

        var _getUserTag = await Mediator.Send(new GetByUserTage(long.Parse(@SelectedGroup), applicationUser.UserID));

        if(_getUserTag.Count > 0)
        {
            dataUserTag.UserTag = _getUserTag[0].UserTag;
            dataUserTag.UserTagId = _getUserTag[0].UserTagId;
        }
        else
        {
            dataUserTag.UserTag = null;
            dataUserTag.UserTagId = null;
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");

        isUserTagChange = true;
        StateHasChanged();        
    }
    async void onCancelDueDatePop()
    {
        isCancelDueDate = true;
        _cancelSubjectName = CurrentEmailConversations.Name;
    }
    async void onRenameSubjectPop()
    {
        _dataSubjectName.SubjectName = CurrentEmailConversations.Name;
        isRenameSubject = true;

    }
    async void onPrintSubjectPop()
    {    
        var url = BaseUrl+"ViewEmail/Emailprint/" + CurrentEmailConversations.SessionId;
        string script = $"window.open('{url}', '_blank');";
        JSRuntime.InvokeVoidAsync("eval", script);
    }
    async void SubmitDueDate()
    {
        var UpdateReq = new UpdateEmailTopicDueDate
            {
                //ID = long.Parse(@SelectedGroup),
                ID = _headTopic[0].ID,
                DueDate = _dataDuDate.DueDate,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);
        if (result == 1)
        {
            isDueDate = false;
            onShowPopupMessage("success", "Updated DueDate Successfully");
        }
        else
        {

        }

    }
    async void SubmitUserTag()
    {
        var usertag = dataUserTag;
        if(dataUserTag.UserTagId != null)
        {

            var UpdateReq = new UpdateUserTag
            {                
                UserTagId = dataUserTag.UserTagId,
                UserTag = dataUserTag.UserTag,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

            var result = await Mediator.Send(UpdateReq);
            if (result == 1)
            {
                isUserTagChange = false;
                onShowPopupMessage("success", "User Tag Updated Successfully");
            }            
        }
        else
        {
            var UpdateReq = new CreateUserTag
                {
                    TopicId = long.Parse(@SelectedGroup),
                    UserTag = dataUserTag.UserTag,
                    AddedByUserID = applicationUser.UserID,
                    AddedDate = DateTime.Now
                };

            var result = await Mediator.Send(UpdateReq);
            if (result == 1)
            {
                isUserTagChange = false;
                onShowPopupMessage("success", "Added User Tag Successfully");
            }
        }

        onloadTagsList();
        IsOpenFlyout = false;
        StateHasChanged(); 
    }

    async void SubmitSubjectDueDate()
    {
        var UpdateReq = new UpdateEmailTopicSubjectDueDate
            {
                //ID = long.Parse(@SelectedGroup),
                ID = CurrentEmailConversations.ID,
                TopicID = CurrentEmailConversations.TopicID,
                DueDate = _dataSubjectDuDate.DueDate,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);

        isSubjectDueDate = false;
        //onShowPopupMessage("success", "Updated DueDate Successfully");
        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }
        isOpenSubjectPop = false;
        StateHasChanged();
    }

    async void SubmitCancelDueDate()
    {
        var UpdateReq = new UpdateEmailTopicSubjectDueDate
            {
                //ID = long.Parse(@SelectedGroup),
                ID = CurrentEmailConversations.ID,
                TopicID = CurrentEmailConversations.TopicID,
                DueDate = null,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);

        isCancelDueDate = false;
        //onShowPopupMessage("success", "Updated DueDate Successfully");
        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }
        isOpenSubjectPop = false;
        StateHasChanged();
    }
    async void SubmitSubjectName()
    {
        var UpdateReq = new UpdateEmailSubjectName
            {
                //ID = long.Parse(@SelectedGroup),
                ID = CurrentEmailConversations.ID,
                TopicID = CurrentEmailConversations.TopicID,
                Name = _dataSubjectName.SubjectName,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);

        isRenameSubject = false;
        //onShowPopupMessage("success", "Updated DueDate Successfully");
        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }
        isOpenSubjectPop = false;



        if(isLeftMenuvisible == "AssignTo")
        {
            await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
        }

        if (isLeftMenuvisible == "All")
        {
            await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
        }


        StateHasChanged();
    }
    async void SubmitTopicClose()
    {
        var UpdateReq = new UpdateTopicClosed
            {
                ID = long.Parse(@SelectedGroup),
                Remarks = _dataTopicClose.Remarks,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };
        var result = await Mediator.Send(UpdateReq);   
        if(result == 1)
        {
            isTopicClosed = false;
            onShowPopupMessage("success", "Topic Closed Successfully");
        }
        else
        {

        }
    }

    private async Task SelectionChanged(TreeViewNodeEventArgs e)
    {
        SelectedGroup = e.NodeInfo?.Name;
        //_discussionList = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
        if(SelectedGroup != "0")
        {
            await LoadData();
        }
    } 
    private async void onSubViewEmailClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();
    }    
    private async void onSubViewEmailSentClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();
    }
    private async void onSubViewEmailCCClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged(); 
    }
    private async void onSubViewEmailToClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();       
    }
    private async void onSubViewEmailAllClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();       
    }    
    private async void onViewEmailToClick(string ToTopicId)
    {
        SelectedGroup = ToTopicId;
        await LoadData();
        StateHasChanged();
    } 
    private async void onViewEmailAllClick(string ATopicId)
    {
        SelectedGroup = ATopicId;
        await LoadData();
        StateHasChanged();
    }    
    private async void onViewEmailCCClick(string CCTopicId)
    {
        SelectedGroup = CCTopicId;
        await LoadData();
        StateHasChanged();
    }
    private async void onViewEmailSentClick(string sentTopicId)
    {
        SelectedGroup = sentTopicId;
        await LoadData();
        StateHasChanged();
    }   
    private async void onSubViewEmailClick_old(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();
    }
    public async Task onPreview(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);       
        // var url = DocumentViewUrl+"?url="+FileUrl + _documents.FilePath;
        var url = DocumentViewUrl + "?url=" + _documents.UniqueSessionId;
        await OpenDocumentPreview(url);
    }
    private async Task OpenDocumentPreview(string url)
    {        
        await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    public async Task onPreview_old(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        string extension = Path.GetExtension(_documents.FilePath);



        if(extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
        {
            MyDocumentFormat = DocumentFormat.OpenXml;
            //documentContent = await File.ReadAllBytesAsync(response.FilePath);      
            var httpClient = new HttpClient();
            var responses = await httpClient.GetAsync(response.FilePath);
            documentContent = await responses.Content.ReadAsByteArrayAsync();
            PreviewDocPopup = true;
        }
        else if(extension.ToLower() == ".txt")
        {
            var url = FileUrl + response.FilePath;
            MyDocumentFormat = DocumentFormat.PlainText;
            //documentContent = await File.ReadAllBytesAsync(response.FilePath);          


            var httpClient = new HttpClient();
            var responses = await httpClient.GetAsync(response.FilePath);
            documentContent = await responses.Content.ReadAsByteArrayAsync();

            //documentContent = await File.ReadAllBytesAsync(fpaath);
            PreviewDocPopup = true;
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".jpeg" || extension.ToLower() == ".jpg" || extension.ToLower() == ".png" || extension.ToLower() == ".gif" || extension.ToLower() == ".bmp" || extension.ToLower() == ".svg")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else
        {
            onShowPopupMessage("Error", "Document format not supported.");
        }

        //var base_url = BaseUrl;
        //var file_url = FileUrl;

        //var filePath1 = BaseUrl + _documents.FilePath;
        //string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        // documentContent = await File.ReadAllBytesAsync(response.FilePath);

        //string filePathpdf = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";

        //await JSRuntime.InvokeVoidAsync("pdfInterop.renderPDF", "pdfInterop", filePathpdf);




        //await Task.Delay(10);       
        //await JSRuntime.InvokeVoidAsync("displayOfficeDocument", OfficeContainerRef, filePath);


    }   

    void OnCustomizeToolbar(IToolbar toolbar)
    {
        //// Returns the first group
        //IBarGroup firstGroup = toolbar.Groups[0];
        //// Returns the Table group
        //IBarGroup tableGroup = toolbar.Groups[RichEditToolbarGroupNames.Table];

        toolbar.Groups.Clear();

        // Inserts the File group at the first position in the group collection
        //toolbar.Groups.Add(0, RichEditToolbarGroupNames.File);
        toolbar.Groups.Add(0, RichEditToolbarGroupNames.Undo);
        toolbar.Groups.Add(1, RichEditToolbarGroupNames.Font);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Table);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Picture);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Paragraph);

        IBarGroup undoRedoGroup = toolbar.Groups[0];
        undoRedoGroup.Items.Add(0, RichEditBarItemNames.FullScreen);

    }

    void OnContentRemoved(ContentRemovedEventArgs e)
    {
        // Handle the content removal event here
    }
    async Task OnSelectionChanged(Selection newSelection)
    {
        /* Surround the code that contains an asynchronous operation with a try-catch block to handle
        the OperationCanceledException. This exception is thrown when an asynchronous operation is canceled. */
        try
        {
            richSelection = newSelection;
            // Your code
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    async Task OnmsgContentChanged(byte[] content)
    {

        /* Surround the code that contains an asynchronous operation with a try-catch block to handle
        the OperationCanceledException. This exception is thrown when an asynchronous operation is canceled. */
        try
        {
            msgContent = content;

            //var createReq = new CreateEmailCoversation
            //    {

            //        TopicID = (long.Parse(@SelectedGroup)),
            //        Message = Data.Message != null ? Data.Message : "Attachments",
            //        FileData = content,
            //        ParticipantId = applicationUser.UserID,
            //        ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
            //        StatusCodeID = 1,
            //        AddedByUserID = applicationUser.UserID,
            //        AddedDate = DateTime.Now,
            //        SessionId = Guid.NewGuid()
            //    };
            //var result = await Mediator.Send(createReq);

            //if (result == 1)
            //{               
            //    await LoadData();
            //    onRestText();
            //    closeReply();
            //}
            //else
            //{

            //}




            //await File.WriteAllBytesAsync("C:\\Users\\Public\\annual-report.rtf", documentContent);
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    async Task OnDocumentContentChanged(byte[] content)
    {

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        // string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        string filePath = response.FilePath;
        //string filePath = response.ServerFilePath;
        var urlss = FileUrl + _documents.FilePath;
        string extension = Path.GetExtension(response.FilePath);


        try
        {
            if (extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
            {
                MyDocumentFormat = DocumentFormat.OpenXml;
                documentContent = content;
                //await File.WriteAllBytesAsync(filePath, documentContent);                
            }
            else if (extension.ToLower() == ".txt")
            {                
                MyDocumentFormat = DocumentFormat.PlainText;
                documentContent = content;                
                //await File.WriteAllBytesAsync(filePath, documentContent);                
            }
            else if(extension.ToLower() == ".pdf")
            {
                var url = FileUrl + _documents.FilePath;
                await OpenUrlInNewTab(url);
            }
            else
            {
                onShowPopupMessage("error", "Document format not supported.");
            }

            //documentContent = content;
            //await File.WriteAllBytesAsync(filePath, documentContent);           
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    private async Task OpenUrlInNewTab(string url)
    {
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }
    public async Task onDocDownload(long Id)
    {
        _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup),applicationUser.UserID,isLeftMenuvisible)); 
        var lst =  _topicDocList?.FirstOrDefault(a => a.DocumentId == Id);

        if(lst != null)
        {
            //var url = DocumentViewUrl + "?url=" + FileUrl + lst.FilePath;
            var url = DocumentViewUrl + "?url=" + lst.UniqueSessionId;
            await OpenDocumentPreview(url);
        }

    }
    public async Task onDocDownload_old(long Id)
    {
        _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup), applicationUser.UserID, isLeftMenuvisible));
        var lst =  _topicDocList?.FirstOrDefault(a => a.DocumentId == Id);



        var url = FileUrl + lst.FilePath;
        await OpenUrlInNewTab(url);
        //  NavigationManager.NavigateTo(url, forceLoad: true);

        //var request = new DownloadFileRequest
        //    {
        //        FileName = lst.FileName, 
        //        FilePath = lst.FilePath, 
        //        ContentType = lst.ContentType
        //    };

        //var response = await Mediator.Send(request);

        ////  Trigger file download
        //await JSRuntime.InvokeVoidAsync("downloadFile", response.FileName, response.FileData, response.ContentType,"");
    }
    public async Task onDocDelete(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);
        DocPopupVisible = true;
    }
    private async void assignedList(long Id)
    {
        _conversationAssignTo = await Mediator.Send(new GetEmailConversationAssignTo(Id));
        if (_conversationAssignTo.Count > 0)
        {
            isAssignToVisible = true;
        }
        else
        {
            toastService.ShowToast("No data found", AC.SD.Core.Services.ToastLevel.Error);
            //isAssignToVisible = false;
        }
    }
    private async Task SubmitIsArchived()
    {       
        var UpdateReq = new UpdateTopicArchive
        {
            ID = long.Parse(@SelectedGroup),                
            ModifiedByUserID = applicationUser.UserID,
            ModifiedDate = DateTime.Now
        };
        var result = await Mediator.Send(UpdateReq);   

        isArchiveClosed = false;
        //await LoadData();
        toastService.ShowToast("Archive Updated successfully.", AC.SD.Core.Services.ToastLevel.Success);
        await JSRuntime.InvokeAsync<string>("ReloadUrl");

    }
    private async Task SubmitDocDelete(long Id)
    {
        if (Id > 0)
        {
            var request = new DeleteDoc(Id);

            var response = await Mediator.Send(request);
            DocPopupVisible = false;
            isAllPlistVisible = false;
            await loadTopicDocList();
            toastService.ShowToast("Document has been deleted successfully.", AC.SD.Core.Services.ToastLevel.Success);
            //onShowPopupMessage("success", "Document has been deleted successfully");
        }
    }

    private async void onShowPopupMessage(string headerText, string bodyText)
    {
        MessageVisible = true;
        MessageBody = bodyText;
        MessageHeader = headerText;
        loading = false;
        StateHasChanged();
    }
    async void ClosePopup()
    {
        PopupVisible = false;
        DocPopupVisible = false;
        isArchiveClosed = false;
    }

    private async void ToggleItemVisibility(int id)
    {
        if (itemVisibility.ContainsKey(id))
        {
            itemVisibility[id] = !itemVisibility[id];
        }
        else
        {
            itemVisibility.Add(id, true);
            //await Task.Delay(5000);
            //await onMarkasAllRead(id);
        }



    }
    private async Task onMarkasAllRead(int Id)
    {        
        var request = await Mediator.Send(new UpdateMarkasAllRead(Id,applicationUser.UserID));

        if (RTopicId == 0)
        {
            await LoadData();
        }
        else
        {
            await LoadReplyData();
        }

        isOpenSubjectPop = false;        

        if(isLeftMenuvisible == "AssignTo")
        {
            await RefAssignTo.onAssignToGridRefresh(long.Parse(@SelectedGroup));
        }

        if (isLeftMenuvisible == "All")
        {
            await RefAssignAll.onAssignAllGridRefresh(long.Parse(@SelectedGroup));
        }


        StateHasChanged();
    }
    private void ToggleDocItemVisibility(int id)
    {
        if (DocitemVisibility.ContainsKey(id))
        {
            DocitemVisibility[id] = !DocitemVisibility[id];
        }
        else
        {
            DocitemVisibility.Add(id, true);
        }
    }
    private List<string> data;

    private async Task loadSubTopicDocList()
    {
        var conId = SelectedReplyId;

        if (long.Parse(@SelectedGroup) > 0)
        {
            //await JSRuntime.InvokeAsync<string>("showLoading");
            _topicDocList = await Mediator.Send(new GetSubEmailTopicDocList(long.Parse(@SelectedReplyId)));


            var selectedDocumentIds = _topicDocList.Where(x => x.ReplaceDocumentId != 0).Select(x => x.DocumentId);
            string commaSeparatedIds = string.Join(",", selectedDocumentIds);

            if (!string.IsNullOrEmpty(commaSeparatedIds))
            {
                _OnFileReplaceList = await Mediator.Send(new GetByUniqueDocument(commaSeparatedIds));
            }
            else
            {
                _OnFileReplaceList = new List<Documents>();
                
            }

         
           

            //_OnFileReplaceList = new List<Documents> { await Mediator.Send(new GetByUniqueDocument(commaSeparatedIds)) };


            //await JSRuntime.InvokeAsync<string>("hideLoading");


            if (_topicDocList.Count > 0)
            {
                _selectlst = _topicDocList.FirstOrDefault();
                //EditEnabled = true;
                //DeleteEnabled = true;
                PreviewEnabled = true;
                docEnabled = true;                
                StateHasChanged();
            }
            else
            {                
                PreviewEnabled = false;
                docEnabled = false;
            }
        }
    }
    private async Task loadTopicDocList()
    {        
        if(long.Parse(@SelectedGroup) > 0)
        {
            //await JSRuntime.InvokeAsync<string>("showLoading");
            _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup), applicationUser.UserID, isLeftMenuvisible));
            //await JSRuntime.InvokeAsync<string>("hideLoading");



            var selectedDocumentIds = _topicDocList.Where(x => x.ReplaceDocumentId != 0).Select(x => x.DocumentId);
            string commaSeparatedIds = string.Join(",", selectedDocumentIds);

            if (!string.IsNullOrEmpty(commaSeparatedIds))
            {
                _OnFileReplaceList = await Mediator.Send(new GetByUniqueDocument(commaSeparatedIds));
            }
            else
            {
                _OnFileReplaceList = new List<Documents>();
                
            }




            if (_topicDocList.Count > 0)
            {
                _selectlst = _topicDocList.FirstOrDefault();
                //EditEnabled = true;
                //DeleteEnabled = true;
                PreviewEnabled=true;
                docEnabled = true;                
                StateHasChanged();
            }
            else
            {                
                PreviewEnabled=false;
                docEnabled = false;
            }
        }

    }
    public async void onloadTagsList()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
            _headTopic_Tag = await Mediator.Send(new GetAllTopicCategory(long.Parse(@SelectedGroup)));
            _headTopic_UserTag = await Mediator.Send(new GetByUserTage(long.Parse(@SelectedGroup),applicationUser.UserID));
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }

    private async Task LoadData()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();

        RTopicId = 0;
        Tid = long.Parse(@SelectedGroup);
        var getconid = await Mediator.Send(new GetTopConversationList(Tid));       
        Cid = 0;
        SelectedReplyId = getconid[0].ID.ToString();
        //_discussionList = await Mediator.Send(new GetEmailDiscussionList(long.Parse(@SelectedGroup),applicationUser.UserID,isLeftMenuvisible));
        //_discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(long.Parse(@SelectedGroup)));

        //_assigntoItems = await Mediator.Send(new GetEmailAssignToList(long.Parse(@SelectedGroup))); 
        //var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
        //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
        //var topicToList = await Mediator.Send(new GetEmailTopicToList(long.Parse(@SelectedGroup)));

        //var ck_validuser = await Mediator.Send(new GetEmailValidUserList(long.Parse(@SelectedGroup), applicationUser.UserID));
        //IsValidUser = false;
        //IsFileValidUser = false;
        

        //if (topicToList != null)
        //{            
        //    Data.AssigntoIds = new List<long>();
        //}       


        OnMenuItemClick(isMenuvisible);


        if (isMenuvisible == "AddParticipants")
        {
            OnMenuItemClick("Posts");
            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicPlist_Data();
            }
            else //sub topic click
            {
                await LoadPlist_Data();
            }            
        }
        else if(isMenuvisible == "Tags")
        {
            OnMenuItemClick("Posts");
            await loadTags_Data();
        }
        else if(isMenuvisible == "Todo")
        {

            OnMenuItemClick("Posts");
            await loadTodo_Data();

        }
        else if (isMenuvisible == "Files")
        {

            OnMenuItemClick("Posts");


        }
       

        if(long.Parse(@SelectedGroup) != 0)
        {
            _headTopic = await Mediator.Send(new GetByIdEmailTopics(long.Parse(@SelectedGroup)));            
            _headTopic_Tag = await Mediator.Send(new GetAllTopicCategory(long.Parse(@SelectedGroup)));
            _headTopic_UserTag = await Mediator.Send(new GetByUserTage(long.Parse(@SelectedGroup), applicationUser.UserID));
            isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

            isEnabled = true;
            isTodoEnabled = false;
            isEllipsis = true;
            isCommand = true;
            IsConHistory = true;            
        }

        //await JSRuntime.InvokeAsync<string>("hideLoading");       
        
    }
    private async Task LoadReplyData()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        IsFileValidUser = true;

        //var rTopicId =@RTopicId;
        Cid = long.Parse(@SelectedReplyId);
        Tid = RTopicId;
        //_discussionList = await Mediator.Send(new GetEmailReplyDiscussionList(long.Parse(@SelectedReplyId), applicationUser.UserID));
        //_discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(RTopicId));
        //if(_discussionList.Count > 0)
        //{
        //    IsValidUser = (_discussionList[0].AddedByUserID == applicationUser.UserID || _discussionList[0].OnBehalf == applicationUser.UserID) ? true : false;
        //}        

        //_assigntoItems = await Mediator.Send(new GetEmailAssignToList(RTopicId));        
        //var topicToList = await Mediator.Send(new GetEmailTopicToList(RTopicId));
        //if (topicToList != null)
        //{
        //    //Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
        //    Data.AssigntoIds = new List<long>();
        //}   

        OnMenuItemClick(isMenuvisible);


        if (isMenuvisible == "AddParticipants")
        {
            OnMenuItemClick("Posts");
            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicPlist_Data();
            }
            else //sub topic click
            {
                await LoadPlist_Data();
            }

        }
        else if(isMenuvisible == "Todo")
        {
            OnMenuItemClick("Posts");
            await loadTodo_Data();

        }
        else if (isMenuvisible == "Files")
        {

            OnMenuItemClick("Posts");


        }
        else if(isMenuvisible == "Tags")
        {
            OnMenuItemClick("Posts");

        }
        var ConversationList = await Mediator.Send(new GetEmailConversationList(Cid));

        _headTopic = await Mediator.Send(new GetByIdEmailTopics(RTopicId));

        if(_headTopic.Count > 0)
        {
            _headTopic[0].TopicName = ConversationList[0].Name;
            _headTopic[0].AddedDate = ConversationList[0].AddedDate;
            isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;
        }

       

        isEnabled = true;
        isTodoEnabled = true;
        isEllipsis = true;
        isCommand = true;
        // _participant = await Mediator.Send(new GetEmailParticipantsList(RTopicId));


        IsConHistory = false;
        //await JSRuntime.InvokeAsync<string>("hideLoading");      
        await InvokeAsync(StateHasChanged);

    }
    private async Task LoadDataPosts()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();
        if(@SelectedGroup != "none")
        {
            if (long.Parse(@SelectedGroup) > 0)
            {
                Tid = long.Parse(@SelectedGroup);
                var getconid = await Mediator.Send(new GetTopConversationList(Tid));
                
                Cid = 0;
                _discussionList = await Mediator.Send(new GetEmailDiscussionList(long.Parse(@SelectedGroup), applicationUser.UserID, isLeftMenuvisible));
                _discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(long.Parse(@SelectedGroup)));

                _assigntoItems = await Mediator.Send(new GetEmailAssignToList(long.Parse(@SelectedGroup)));
                var topicToList = await Mediator.Send(new GetEmailTopicToList(long.Parse(@SelectedGroup)));
                if (topicToList != null)
                {
                    
                    Data.AssigntoIds = new List<long>();
                }


                isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

                isEnabled = true;
                isTodoEnabled = false;
                isEllipsis = true;
                isCommand = true;
                

            }

        }

        await JSRuntime.InvokeAsync<string>("hideLoading");

        await InvokeAsync(StateHasChanged);

    }
    private async Task LoadReplyDataPosts()
    {        
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();
        Cid = long.Parse(@SelectedReplyId);
        Tid = RTopicId;
        await JSRuntime.InvokeAsync<string>("showLoading");
        _discussionList = await Mediator.Send(new GetEmailReplyDiscussionList(long.Parse(@SelectedReplyId), applicationUser.UserID));
       
        _discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(RTopicId));

        _assigntoItems = await Mediator.Send(new GetEmailAssignToList(RTopicId));
        var topicToList = await Mediator.Send(new GetEmailTopicToList(RTopicId));
        if (topicToList != null)
        {
            //Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
        }


        isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

        isEnabled = true;
        isTodoEnabled = true;
        isEllipsis = true;
        isCommand = true;
        //_participant = await Mediator.Send(new GetEmailParticipantsList(RTopicId));

        await JSRuntime.InvokeAsync<string>("hideLoading");

        await InvokeAsync(StateHasChanged);



    }
    void OnSelectedDataItemsChanged(IReadOnlyList<object> selectedDataItems)
    {
        SelectedDataItems = selectedDataItems;
    }

    async Task OnEmailToRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ID");       
        SelectedGroup = UniqueId.ToString();
        await LoadData();
        StateHasChanged();
    }   

    async Task OnDocumentLoaded(DevExpress.Blazor.RichEdit.Document document)
    {
        await document.ChangeDefaultCharacterPropertiesAsync(properties =>
        {
            // properties.FontName = "Times New Roman";
            properties.FontSize = 12;
        });
    }
    private void OnWindowDragCompleted()
    {
        // Handle drag completed event if needed
        //msgrichEdit.NewDocumentAsync();
    }

    async Task onRichTxtChangeFontsize()
    {
        await msgrichEdit.NewDocumentAsync();
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }

    protected override async Task OnParametersSetAsync()
    {
        _editContext = new EditContext(_dataFileProfileType);   
        

       


        Page = Page == null ? "AssignTo" : Page;

        var sss = ActiveSessionId;      
        ProductActivityBaseUrl = Configuration["DocumentsUrl:APP_Product_Activity"];        
        cancellationTokenSource = new CancellationTokenSource();
        //StartAutoRefresh();

        BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        FileUrl = Configuration["DocumentsUrl:FileUrl"];
        DocumentViewUrl = Configuration["DocumentsUrl:DocumentViewer"];

        onloadSession();
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _openAccessUserLink = await Mediator.Send(new GetEmailAccessByUser(applicationUser.UserID));
        AppUserId = applicationUser.UserID;
        await JSRuntime.InvokeAsync<string>("showLoading");

        filterrowname = "";
        if(Page == "Todo")
        {
            var page = Page;
            isPage = true;
            var todolist = await Mediator.Send(new GetByToDoSessionId(TodoSessionId));
            if(todolist.Count > 0)
            {
                string ridds = todolist[0].TopicId.ToString();

                ActiveTabIndex = 4;
                OnLeftMenuItemClick("Library");
                isLeftMenuvisible = "Library";
                MyDayFilterText = todolist[0].SubjectName;
                await Task.Delay(2000); // Delay for 2 seconds                
                onSubViewEmailClick(ridds);
            }
        }
        else if(Page == "Email")
        {
            var page = Page;
            isPage = true;
            string sessionidString = TodoSessionId.ToString();            
            var lsts = await Mediator.Send(new GetListByConversationSession(sessionidString));
            if (lsts.Count > 0)
            {
                string ridds = lsts[0].ID.ToString();
                ActiveTabIndex = 4;
                OnLeftMenuItemClick("Library");
                isLeftMenuvisible = "Library";
                MyDayFilterText = lsts[0].Name;
                await Task.Delay(2000); // Delay for 2 seconds
                onSubViewEmailClick(ridds);
            }
        }
        else
        {      
            if (ActiveSessionId != null)
            {
                var lsts = await Mediator.Send(new GetListBySession(ActiveSessionId));
                if (lsts.Count > 0)
                {
                    SelectedGroup = lsts[0].ID.ToString();
                    RTopicId = 0;
                    filterrowname = ActiveSessionId;

                    ActiveTabIndex = 4;
                    OnLeftMenuItemClick("Library");
                    isLeftMenuvisible = "Library";
                    MyDayFilterText = lsts[0].TopicName;
                    await Task.Delay(2000); // Delay for 2 seconds


                    _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL"));
                    _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
                    _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID,"NULL"));
                    _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));

                    await LoadData();

                }
                else
                {
                    var elst = await Mediator.Send(new GetListBySession(ActiveSessionId));
                    
                    SelectedGroup = elst[0].ID.ToString();
                    RTopicId = 0;

                    _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL"));
                    _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
                    _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID,"NULL"));
                    _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));

                    
                    await LoadData();

                    //if (long.Parse(@SelectedGroup) > 0)
                    //{
                    //    _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID));
                    //    _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID));
                    //    _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID));
                    //    _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
                    //}

                }

            }
            else
            {
                _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL"));
                _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
                _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID, "NULL"));
                _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
            }
        }


        await JSRuntime.InvokeAsync<string>("hideLoading");
        //_discussionList = await Mediator.Send(new GetDiscussionList(38));


    }
    private async Task StartAutoRefresh()
    {
        //try
        //{
        //    while (true)
        //    {
        //        await Task.Delay(AutoRefreshInterval, cancellationTokenSource.Token);

        //        await RefreshGridData();
        //    }
        //}
        //catch (TaskCanceledException)
        //{
        //    // Task was canceled, no action needed
        //}
    }
    private async Task RefreshGridData()
    {
        // Perform the logic to refresh your grid data
        // For example, you can re-fetch the data from the server
        await LoadGridData();
        StateHasChanged();
    }
    private async Task LoadGridData()
    {
        _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL"));
        _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
        _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID, "NULL"));
        _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
    }
    public void Dispose()
    {
        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();
        System.GC.Collect();
        GC.SuppressFinalize(this);
    }

    async Task onloadTwoGrid()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");

        await JSRuntime.InvokeAsync<string>("showLoading");
        _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID,"NULL"));
        _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID,"NULL"));
        _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID, "NULL"));

        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    void onloadSession()
    {
        _sessionId = Guid.NewGuid();
    }
    void getConversation()
    {

    }
    private async Task onWindowVisible()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        CurrentUplodCount = 0;
        SelectedFilesCount = 0;

        //var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
        //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();

        if(long.Parse(@SelectedGroup) > 0)
        {

            var _replyComment = await Mediator.Send(new GetEmailConversationTId(long.Parse(@SelectedGroup)));

            //var getplllst = await Mediator.Send(new GetByConvasationTIDPList(long.Parse(@SelectedGroup)));
            //var parttcc = getplllst.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();
            //#region AssignTo
            //    /*Assignto*/            
            //var _convListss = await Mediator.Send(new GetEmailConversationTId(long.Parse(@SelectedGroup)));
            //    var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_convListss[0].ID));
            //    var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();
            //    Data.AssigntoIds = conto.Select(s => s.UserId).ToList();

            //    List<long> updatedList = Data.AssigntoIds.ToList();
            //    long fromUserId = _convListss[0].AddedByUserID.Value;

            //    if (fromUserId != applicationUser.UserID)
            //    {
            //        updatedList.Add(fromUserId);
            //    }

            //    //Data.AssigntoIds = updatedList;

            //    Data.AssigntoIds = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();

            //    #endregion
            //#region AssignCC
            ///*AssignCC*/
            //var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_convListss[0].ID));
            //var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
            ////Data.AssignccIds = concc.Select(s => s.UserId).ToList();



            ////var parttcc = getplllst.Select(p => p.UserID).ToList();
            ////Data.AssigntoIds = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();


            //Data.AssignccIds = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

            //#endregion


            //if (_replyComment[0].IsAllowParticipants.GetValueOrDefault(false))
            if(true)
            {
                var plist = await Mediator.Send(new GetAllEmployeeListQuery());
                //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
                var allplist = plist.Where(c => c.UserID != applicationUser.UserID).ToList();

                var gettids = await Mediator.Send(new GetByConvasationTIDPList(long.Parse(@SelectedGroup)));
                // var getplllst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                var parttcc = gettids.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();



                #region AssignTo
                /*Assignto*/
                var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();
                //v
                //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                //v
                //List<long> updatedList = Data.AssigntoIds.ToList();
                List<long> updatedList = conto.Select(s => s.UserId).ToList();
                long fromUserId = _replyComment[0].AddedByUserID.Value;

                if (fromUserId != applicationUser.UserID)
                {
                    updatedList.Add(fromUserId);
                    _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }
                else
                {
                    _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].AddedByUserID.Value).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }

                //v
                //Data.AssigntoIds = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                Data.AssigntoIds = new List<long>();

                #endregion

                #region AssignCC
                /*AssignCC*/
                var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
                //Data.AssignccIds = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                var t1 = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                var t2 = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                Data.AssignccIds = t1.Concat(t2).ToList();

                var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                sCCIds = CCtags.ToList();


                _Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();

                #endregion

            }
            else
            {
                var gettid = await Mediator.Send(new GetByConvasationTIDPList(long.Parse(@SelectedGroup)));
                //_allparticipant = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettid[0].TopicID));
                //_allparticipant = gettid;
                var allplist = gettid;


                var gettids = await Mediator.Send(new GetByConvasationTIDPList(long.Parse(@SelectedGroup)));
                //var getplsst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                var getpatlist = gettids.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();


                #region AssignTo
                /*Assignto*/
                var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();

                //v
                //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                //v
                //List<long> updatedList = Data.AssigntoIds.ToList();
                List<long> updatedList = conto.Select(s => s.UserId).ToList();
                long fromUserId = _replyComment[0].AddedByUserID.Value;

                if (fromUserId != applicationUser.UserID)
                {
                    updatedList.Add(fromUserId);
                    _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }
                else
                {
                    _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].AddedByUserID.Value).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }
                //v                
                //Data.AssigntoIds = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                Data.AssigntoIds = new List<long>();

                #endregion


                #region AssignCC
                var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();                
                //Data.AssignccIds = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                var t1 = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                var t2 = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                Data.AssignccIds = t1.Concat(t2).ToList();



                //string assignccIdAsString = Data.AssignccIds.ToString(); // Convert Data.AssignccIds to a string
                //IEnumerable<string> newTags = new List<string> { assignccIdAsString }; // Create a collection with a single element
                //onCcChanged(newTags);

                var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                sCCIds = CCtags.ToList();

                _Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();

                #endregion
            }
        }



        //Data.AssigntoIds = Enumerable.Empty<long>();
        WindowVisible = true;        
        //Data.AssignccIds = null;
        string selector = ".dxwinheight";
        Data.From = applicationUser.UserName;
        ElementHeight = await JSRuntime.InvokeAsync<int>("getElementHeight", selector);
        Data.DueDate = null;
        Data.IsAllowParticipants = true;
        Data.Urgent = false;
        Data.NotifyUser = false;
        newSubjectreply = 1;

         StateHasChanged(); // Force a UI update
        await Task.Delay(2700);
        await onRichTxtChangeFontsize(); // Call your other function here
    }
    async void onBackFileProfileType(string url)
    {
        var urls = BaseUrl + "fileprofiletype/" + url;
        NavigationManager.NavigateTo(urls);
        JSRuntime.InvokeAsync<string>("ReloadUrl");
    }
    private void onBackActivity(string Url)
    {
        var url = ProductActivityBaseUrl + Url;
        string script = $"window.open('{url}', '_blank');";
        JSRuntime.InvokeVoidAsync("eval", script);
        //NavigationManager.NavigateTo(url,true);
    }
    private async Task onreply(long id)
    {
        // var lsslsls = await Mediator.Send(new OnReplyConversation(id,applicationUser.UserID));
        await JSRuntime.InvokeAsync<string>("showLoading");
        CurrentUplodCount = 0;
        SelectedFilesCount = 0;

        if (id > 0)
        {           
            _replyComment = _discussionList.Where(c => c.ID == id).ToList();

            isPushNotification = _replyComment[0].NotifyUser.GetValueOrDefault(false);

            Data.IsAllowParticipants = false;
            Data.DueDate = null;
            newSubjectreply = 0;
            //asignto
            //_allparticipant = await Mediator.Send(new GetAllConvAssToListQuery(_replyComment[0].ID));
            //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();

            //var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
            //var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();
            //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();

            //List<long> updatedList = Data.AssigntoIds.ToList();
            //long fromUserId = _replyComment[0].UserId.Value;

            //if(fromUserId != applicationUser.UserID)
            //{
            //    updatedList.Add(fromUserId);
            //}

            //Data.AssigntoIds = updatedList;

            //cclist
            //var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
            //var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
            //Data.AssignccIds = concc.Select(s => s.UserId).ToList();


            if (_replyComment[0].IsAllowParticipants.GetValueOrDefault(false))
            {
                var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
                var allplist = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
                //_allparticipant = allplist.Where(c => c.UserID != _replyComment[0].UserId.Value).ToList();

                //_Toparticipant = _allparticipant;
                //_CCparticipant = _allparticipant;


                var gettids = await Mediator.Send(new GetEmailConversationList(_replyComment[0].ID));
                var getplllst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                var parttcc = getplllst.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();



                #region AssignTo
                /*Assignto*/
                var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();
                //v
                //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                //v
                //List<long> updatedList = Data.AssigntoIds.ToList();
                List<long> updatedList = conto.Select(s => s.UserId).ToList();
                long fromUserId = _replyComment[0].UserId.Value;

                if (fromUserId != applicationUser.UserID)
                {
                    updatedList.Add(fromUserId);
                    _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }
                else
                {
                    _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].UserId.Value).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }
                //v
                //Data.AssigntoIds = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                Data.AssigntoIds = new List<long>();
                #endregion

                #region AssignCC
                /*AssignCC*/
                var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();  
                //Data.AssignccIds = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();


                var t1 = parttcc.Where(userId => updatedList.Any(s => s == userId)).ToList();
                var t2 = parttcc.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                Data.AssignccIds = t1.Concat(t2).ToList();

                var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                sCCIds = CCtags.ToList();


                _Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();
                //_allparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();

                #endregion

            }
            else
            {
                var gettid = await Mediator.Send(new GetEmailConversationList(_replyComment[0].ID));
                var allplist = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettid[0].TopicID));



                var gettids = await Mediator.Send(new GetEmailConversationList(_replyComment[0].ID));
                var getplsst = await Mediator.Send(new GetByConvasationTopicIDPList(id, gettids[0].TopicID));
                var getpatlist = getplsst.Select(p => p.UserID).Where(userId => userId.HasValue).Select(userId => userId.Value).ToList();


                #region AssignTo
                /*Assignto*/
                var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
                var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();

                //v
                //Data.AssigntoIds = conto.Select(s => s.UserId).ToList();
                //Data.AssigntoIds = new List<long>();
                //v
                //List<long> updatedList = Data.AssigntoIds.ToList();
                List<long> updatedList = conto.Select(s => s.UserId).ToList();
                long fromUserId = _replyComment[0].UserId.Value;

                if (fromUserId != applicationUser.UserID)
                {
                    updatedList.Add(fromUserId);

                    _allparticipant = allplist.Where(c => c.UserID != applicationUser.UserID).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }
                else
                {
                    _allparticipant = allplist.Where(c => c.UserID != _replyComment[0].UserId.Value).ToList();
                    _Toparticipant = _allparticipant.ToList();
                    _CCparticipant = _allparticipant.ToList();
                    _allparticipants = _allparticipant.ToList();
                }

                //v
                //Data.AssigntoIds = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                #endregion


                #region AssignCC
                var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
                var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
                //Data.AssignccIds = concc.Select(s => s.UserId).ToList();
                //Data.AssignccIds = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();


                var t1 = getpatlist.Where(userId => updatedList.Any(s => s == userId)).ToList();
                var t2 = getpatlist.Where(userId => concc.Any(s => s.UserId == userId)).ToList();

                Data.AssignccIds = t1.Concat(t2).ToList();



                //string assignccIdAsString = Data.AssignccIds.ToString(); // Convert Data.AssignccIds to a string
                //IEnumerable<string> newTags = new List<string> { assignccIdAsString }; // Create a collection with a single element
                //onCcChanged(newTags);           

                var filteredCCList = _allparticipant.Where(c => Data.AssignccIds.Contains(c.UserID.Value)).ToList();
                IEnumerable<string> CCtags = filteredCCList.Select(s => s.Name + "-" + s.NickName).ToList();
                sCCIds = CCtags.ToList();

                _Toparticipant = _Toparticipant.Where(c => !Data.AssignccIds.Select(id => (long?)id).Contains(c.UserID)).ToList();
                #endregion
            }


            WindowVisible = true;
            Data.Name = _replyComment[0].Name;
            Data.From = applicationUser.UserName;
            IsReadOnly = false;

            StateHasChanged(); // Force a UI update
            await Task.Delay(2700);
            await onRichTxtChangeFontsize(); // Call your other function here

        }        
    }  
    void EulaClosing(WindowClosingEventArgs args) {
        closeReply();
    }
    private async Task onunderreply(long id)
    {
        if (id > 0)
        {
            _replyComment = _discussionFullList.Where(c => c.ID == id).ToList();
            WindowVisible = true;
            Data.Name = _replyComment[0].Name;
            IsReadOnly = false;
        }
    }
    void closeReply()
    {
        _replyComment = null;
        Data.Name = null;
        IsReadOnly = true;
        WindowVisible = false;
    }
    async void OnLeftMenuItemClick(string text)
    {
        isLeftMenuvisible = text;
        Page = text;
    }
    async Task OnMenuItemClick(string text)
    {
        isMenuvisible = text;

        if(text == "Posts")
        {
            isComponentVisible = true;
            isAddParticipant = false;
            isEllipsis = true;
            isCommand = true;
            isTags = false;
            //await LoadDataPosts();
            if (RTopicId == 0)
            {
                await LoadDataPosts();
            }
            else
            {
                await LoadReplyDataPosts();
            }
        }
        else if (text == "Files")
        {
            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
            isTags = false;

            if (RTopicId == 0)
            {                
                await loadTopicDocList();
            }
            else
            {
                await loadSubTopicDocList();
            }            
        }
        else if (text == "AddParticipants")
        {
            isAddParticipant = true;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
            isTags = false;
        }
        else if (text == "Tags")
        {
            isTags = true;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;  
        }
        else
        {
            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
            isTags = false;
        }
    }  
    async Task LoadPlist_Data()
    {
        if(Cid > 0)
        {
            await RefTopicAddPList.loadParticipentList(long.Parse(@SelectedReplyId));
        }        
    } 
    async Task loadTags_Data()
    {
        await RefTopicTagList.loadTagList(long.Parse(@SelectedGroup));
    }
    async Task loadLibary_Data(string txt)
    {
        if(RefMasterSearch != null)
        {
            await RefMasterSearch.loadLibaryList(txt);
        }

    }
    async Task loadTodo_Data()
    {
        if(Cid > 0)
        {
            await RefTopicTodo.leftTodoLst(Cid);
        }
        else
        {
            await RefTopicTodo.leftTodoLst(-1);

        }

    }

    async Task LoadMainTopicPlist_Data()
    {        
        await RefTopicAddPList.loadMainTopicParticipentList(long.Parse(@SelectedGroup));        
    }
    private async Task HandleValidSubmit()
    {
        loading = true;        
        //var contentdd = msgContent;
        //byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
        byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);      


        string htmlString = string.Empty;
        var len = fileContent.Length;
        //documentContent = null;            


        htmlString = Encoding.UTF8.GetString(fileContent);
        //if (fileContent != null)
        //{
        //    // Convert the RTF byte array to HTML string
        //    htmlString = Rtf.ToHtml(fileContent);
        //}

        if(fileContent.Length == 480)
        {
            toastService.ShowToast("Please Enter Messages", AC.SD.Core.Services.ToastLevel.Error);
            loading = false;
            return;
        }    

        await msgrichEdit.SaveDocumentAsync();
        using DevExpress.XtraRichEdit.RichEditDocumentServer server = new DevExpress.XtraRichEdit.RichEditDocumentServer();
        byte[] fileContent1 = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
        server.LoadDocument(fileContent1);
        server.Options.Export.Html.EmbedImages = true;
        byte[] fileContents = server.SaveDocument(DevExpress.XtraRichEdit.DocumentFormat.Html);


        if(Data.Name == null)
        {
            toastService.ShowToast("Please Enter Subject Name", AC.SD.Core.Services.ToastLevel.Error);
            loading = false;
            return;
        }

        if(Data.AssigntoIds.Count() == 0)
        {
            toastService.ShowToast("Please Select Assign To", AC.SD.Core.Services.ToastLevel.Error);
            loading = false;
            return;
        }

        string assignCCidsString = string.Join(",", _assigntoItems.Select(s => s.UserID).ToList());
        string assignccidsString = null;
        string assigntoidsString = string.Join(",", Data.AssigntoIds);
        if(Data.AssignccIds != null)
        {
            assignccidsString = string.Join(",", Data.AssignccIds);
        }


        List<long> concatList;
        List<long> NotificationconcatList = new List<long>();

        if (Data.AssignccIds != null)
        {
            concatList = Data.AssigntoIds.Concat(Data.AssignccIds).ToList();
        }
        else
        {
            concatList = Data.AssigntoIds.ToList();
        }

        //List<long> concatList = Data.AssigntoIds.Concat(Data.AssignccIds).ToList();
        concatList.Add(applicationUser.UserID);
        concatList = concatList.Distinct().ToList();
        string participantidsString = string.Join(",", concatList);

        string plistUniqueItems = null;
        long ConIds = 0;

        var coId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0;
        if(coId > 0)
        {
            var plist = await Mediator.Send(new GetByConvasationPList(coId));
            List<long> plst = plist.Select(x => x.UserID.GetValueOrDefault()).ToList();
            NotificationconcatList = plst;
            List<long> uniqueItems = concatList.Except(plst).ToList();
            if(uniqueItems.Count > 0)
            {
                plistUniqueItems = string.Join(",", uniqueItems);                
                NotificationconcatList.AddRange(uniqueItems);
            }

            ConIds = _replyComment[0].ID;

        }       

        var createReq = new CreateEmailCoversation
            {
                //TopicID = (long.Parse(@SelectedGroup)),
                TopicID = RTopicId == 0 ? (long.Parse(@SelectedGroup)) : RTopicId,
               // Message = Data.Message != null ? Data.Message : "Attachments",
                Message = htmlString,
                //FileData = Data.Message != null ? Encoding.UTF8.GetBytes(Data.Message) : Encoding.UTF8.GetBytes("Attachments"),
                FileData = fileContents,
                //AssigntoIdss = Data.AssigntoIds.Count() == 0 ? assignCCidsString : assigntoidsString,
                AssigntoIdss =  assigntoidsString,
                AssignccIdss = assignccidsString,
                PlistIdss = participantidsString,
                AllowPlistids = plistUniqueItems,
                DueDate = Data.DueDate,
                IsAllowParticipants = Data.IsAllowParticipants,
                Urgent = Data.Urgent,
                NotifyUser = Data.NotifyUser,
                ConIds = ConIds,
               // AllParticipantIds = _assigntoItems.Select(s => s.UserID).ToList(),
                AllParticipantIds = coId > 0 ? NotificationconcatList : concatList,
                ParticipantId = applicationUser.UserID,
                ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                StatusCodeID = 1,
                IsMobile = 0,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                Name = Data.Name,
                SessionId = _sessionId
            };
        var result = await Mediator.Send(createReq);

        if (result > 1)
        {

            if(isPushNotification)
            {
                string BaseUrl = NavigationManager.BaseUri + "api/Email/";
                string url = BaseUrl + "SendMessage?id="+result;
                // Make a GET request to the controller action
                var response = await httpClient.GetAsync(url);                
            }

            if (Data.NotifyUser.GetValueOrDefault(false))
            {
                string BaseUrl = NavigationManager.BaseUri + "api/Email/";
                string url = BaseUrl + "SendMessage?id="+result;
                // Make a GET request to the controller action
                var response = await httpClient.GetAsync(url);
            }

            //var getRec = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
            //sessionId = getRec.Last().SessionId;

            //uploadUrl = GetUploadUrl();           
            //uploadComponent.UploadAllFiles();
            if(SelectedFilesCount > 0)
            {
                uploadComponent.UploadAllFiles();  
            }
            else
            {
                onRestText();
                closeReply();
                onloadSession();

                await msgrichEdit.NewDocumentAsync();
                await onloadTwoGrid();

                if (RTopicId == 0)
                {
                    await LoadDataPosts();
                }
                else
                {
                    await LoadReplyDataPosts();
                }

                WindowVisible = false;
                loading = false;
            }

                     

            //if(RTopicId == 0)
            //{
            //    await LoadData();
            //}
            //else
            //{
            //    await LoadReplyData();
            //}

            // await LoadData();

           
        }
        else
        {

        }
    }
    private void onRestText()
    {
        Data.Message = null;
    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        isArchiveClosed = false;

    }
    void HandleInvalidSubmit()
    {

    } 
}