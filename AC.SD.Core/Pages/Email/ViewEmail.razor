@using Application.Commands;
@using Application.Common.Helper;
@using Application.Queries;
@using Application.Response;
@using Microsoft.AspNetCore.Http;
@using global::Core.Repositories.Query;
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using MediatR
@inject IMediator Mediator
@using System.ComponentModel.DataAnnotations
@using DevExpress.Blazor.Internal
@using System.Collections.Generic
@inject ILocalStorageService<ApplicationUser> _localStorageService
@page "/ViewEmail"
@page "/ViewEmail/{ActiveSessionId}"
@using DevExpress.Blazor.RichEdit
@using DevExpress.Blazor.Office
@using System.Globalization
@using System;
@using Application.Command.Document;
@using Microsoft.Extensions.Configuration;
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime;
@inject HttpClient httpClient;
@using System.IO;
@using Microsoft.JSInterop;
@using DevExpress.DocumentView;
@inject NavigationManager NavigationManager
@using System.Web;
@inject IToastService ToastService
@inject AC.SD.Core.Services.ToastService toastService
@using System.Text;
@using RtfPipe;
@inject Application.Common.Helper.Helper  dateformathelper
@using System.Net.Http;
@using System.Threading.Tasks
@using System.Threading
@using System.Timers

<link href="_content/AC.SD.Core/css/forum-mail.css" rel="stylesheet" />

<div class="">
    <div class="main-container">
        <!--  -->
        <!-- Main Content -->
        <!--  -->
        <div class="content-container row">
            <!-- Side Bar -->
            @* <div class="side-menu-bar">

            <div class="side-menu-bar-top">
            <div class="side-menu-bar-text circle">RN</div>
            <div class="side-menu-bar-text circle">IPIR</div>
            <div class="side-menu-bar-text circle">PA</div>
            <div class="side-menu-bar-text circle">CS</div>
            <div class="side-menu-bar-text circle">GL</div>
            </div>

            </div>*@
            <!-- Mini Menu Bar -->
            <div class="mini-menu-bar col-md-3" style="overflow-x: hidden;">
                <div class="mini-menu-bar-top">
                    @*<div class="mini-menu-bar-heading">
                        <div class="files-title">General Information</div>
                    </div> *@
                    <div class="card w-100" style="margin-bottom:10px; margin-top:10px;">
                        <div class="d-flex py-2">
                           @* <DxTextBox @bind-Text="SearchText" style="width: 100%;    margin-left: 5px;" />
                            <DxButton Text="Apply" Click="() => GridSearchText = SearchText" CssClass="mx-2" />*@
                        </div>
                        <div class="card-body p-0">
                            <DxTabs ScrollMode="TabsScrollMode.NavButtons" @bind-ActiveTabIndex="@ActiveTabIndex">
                                <DxTabPage Text="All" CssClass="@((isLeftMenuvisible == "All" ? "tActive": "tall"))" Click="@(() => OnLeftMenuItemClick("All"))">
                                   
                                </DxTabPage>
                                <DxTabPage Text="Assign To" CssClass="@((isLeftMenuvisible == "AssignTo" ? "tActive": "tassignto"))" Click="@(() => OnLeftMenuItemClick("AssignTo"))">
                                   
                                </DxTabPage>
                                <DxTabPage Text="CC" CssClass="@((isLeftMenuvisible == "AssignCC" ? "tActive": "tassigncc"))" Click="@(() => OnLeftMenuItemClick("AssignCC"))">
                                   
                                </DxTabPage>
                                <DxTabPage Text="Sent" CssClass="@((isLeftMenuvisible == "Sent" ? "tActive": "sent"))" Click="@(() => OnLeftMenuItemClick("Sent"))">

                                </DxTabPage>
                                <DxTabPage Text="Library" CssClass="@((isLeftMenuvisible == "Library" ? "tActive": "library"))" Click="@(() => OnLeftMenuItemClick("Library"))">

                                </DxTabPage>                                
                              </DxTabs>
                           @* <DxMenu CollapseItemsToHamburgerMenu="true"
                                    CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                                    DisplayMode="MenuDisplayMode.Auto">
                                <Items>
                                    <DxMenuItem Text="All" class="@((isLeftMenuvisible == "All" ? "tActive": "tall"))" IconCssClass="fa fa-list-alt" Click="@(() => OnLeftMenuItemClick("All"))" />
                                    <DxMenuItem Text="Assign To" class="@((isLeftMenuvisible == "AssignTo" ? "tActive": "tassignto"))" IconCssClass="fa fa-envelope" Click="@(() => OnLeftMenuItemClick("AssignTo"))" />                                    
                                    <DxMenuItem Text="CC" class="@((isLeftMenuvisible == "AssignCC" ? "tActive": "tassigncc"))" IconCssClass="popup-image popup-icon-position" Click="@(() => OnLeftMenuItemClick("AssignCC"))" />
                                    <DxMenuItem Text="Sent" class="@((isLeftMenuvisible == "Sent" ? "tActive": "sent"))" IconCssClass="fa fa-paper-plane" Click="@(() => OnLeftMenuItemClick("Sent"))" />

                                    @if (ActiveSessionId != null)
                                    {
                                        <DxButton Click="@(() => TOGrid.ClearFilter())">Clear Filter</DxButton>
                                    }
                                    </Items>
                            </DxMenu>*@
                        </div>
                    </div>

                    <div>
                        <div class="views-accordion">
                            @*@if (_forumTopicTo != null && _forumTopicTo.Any())
                            {
                                @foreach (var item in _forumTopicTo)
                                {
                                    <div class="card">
                                        <div class="card-body">
                                            <article class="media">                                        
                                                <div class="media-body">
                                                    <div class="content">
                                                        <p class="h5">@item.FirstName <small>@item.LastName</small> <small class="float-right text-muted">@Application.Common.Helper.Helper.FormatDateTime(item.StartDate)</small></p>
                                                        <p>@item.TopicName</p>
                                                    </div>                                         
                                                </div>
                                            </article>
                                        </div>
                                    </div>
                                }
                            }*@

                        @if(isLeftMenuvisible == "All")
                        {                                
                            <AllEmail GridSearchText="@GridSearchText" ATopicId="onViewEmailAllClick" SubViewAllTopicId ="onSubViewEmailAllClick"></AllEmail>
                        }
                        else if (isLeftMenuvisible == "AssignTo")
                        {                           
                               <AssignToEmail GridSearchText="@GridSearchText" ToTopicId="onViewEmailToClick " SubViewToTopicId ="onSubViewEmailToClick"></AssignToEmail>
                            }
                            else if (isLeftMenuvisible == "AssignCC")
                            {
                                <CCEmail GridSearchText="@GridSearchText" CCTopicId="onViewEmailCCClick" SubViewCCTopicId="onSubViewEmailCCClick"></CCEmail>
                            }
                            else if(isLeftMenuvisible == "Sent")
                            {
                                <SentEmail sentTopicId="onViewEmailSentClick" SubViewSentTopicId="onSubViewEmailSentClick"></SentEmail>
                            }  
                            else if(isLeftMenuvisible == "Library")
                            {
                                <MasterSearch GridSearchText="@GridSearchText" ATopicId="onViewEmailAllClick" SubViewAllTopicId="onSubViewEmailAllClick"></MasterSearch>
                            }  
                            

                            
                        </div>
                    </div>
                </div>
                @*<div class="mini-menu-bar-down">
                <div class="add-cloud-storage-btn">
                <div class="cloud-storage-btn">
                <div class="add-btn-text">Add cloud storage</div>
                </div>
                </div>
                </div>*@
            </div>
            <!-- Menu Bar Content -->
            <div class="menu-bar-content-container col-md-9">
                <div class="content-padding-20">
                    <div class="menu-bar-content-container-heading">
                        <div class="heading-icon-text">                          
                            <div class="mb-cc-text">
                                <div class="card w-100">
                                    <div class="card-body p-0">
                                        <DxMenu Orientation="Orientation.Horizontal"
                                                DropDownActionMode="MenuDropDownActionMode.Click"
                                                DisplayMode="MenuDisplayMode.Desktop"
                                                Title=""
                                                CollapseItemsToHamburgerMenu="true"
                                                CollapseItemToIconMode="MenuCollapseItemToIconMode.All">
                                            <Items>
                                                <DxMenuItem Text="Posts" class="@((isMenuvisible == "Posts" ? "tActive": "tfiles"))" IconCssClass="menu-icon-products menu-icon" Click="@(() => OnMenuItemClick("Posts"))" />
                                                <DxMenuItem Text="Files" Enabled="@isEnabled" class="@((isMenuvisible == "Files" ? "tActive": "tfiles"))" IconCssClass="fa fa-paperclip cdspc" Click="@(() => OnMenuItemClick("Files"))" />
                                                <DxMenuItem Text="Todo" class="@((isMenuvisible == "Todo" ? "tActive": "ttodo"))" IconCssClass="menu-icon-about menu-icon" Click="@(() => OnMenuItemClick("Todo"))" />
                                                <DxMenuItem Text="Participants List" Enabled="@isEnabled" class="@((isMenuvisible == "AddParticipants" ? "tActive": "taddparticipants"))" IconCssClass="dxbl-image menu-icon-support menu-icon dx-menu-item-image" Click="@(() => OnMenuItemClick("AddParticipants"))" />
                                            </Items>
                                        </DxMenu>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div>
                            @if (_headTopic != null && _headTopic.Any())
                            {
                                @foreach (var item in _headTopic)
                                {
                                    <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto">
                                        <div class="uk-card-header topicheadbg" style="height: auto; border-bottom: none;">
                                            <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                <div class="uk-card-header" style="border-bottom: none;">
                                                    <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">

                                                        <div class="mailbox-read-info">
                                                            <h3>@item.TopicName</h3>
                                                            @if (_headTopic_Tag != null && _headTopic_Tag.Any())
                                                            {
                                                                @foreach (var Tagitem in _headTopic_Tag)
                                                                {
                                                                   @* <span class=" handline tagbg">@Tagitem.ManufacturingProcess</span>
                                                                    <span class=" handline tagbg">@Tagitem.CategoryAction</span>
                                                                    <span class=" handline tagbg">@Tagitem.ActionName</span>*@

                                                                    <span class=" handline tagbg">@Tagitem.Name</span>
                                                                }
                                                            }

                                                            
                                                           @* <h5>
                                                                From: @item.FirstName
                                                                <br>
                                                                To:                                                                
                                                                @if (item.TopicToList != null && item.TopicToList.Any())
                                                                {
                                                                    @foreach (var items in item.TopicToList)
                                                                    {
                                                                        <span>@items.FirstName ,</span>
                                                                    }
                                                                }
                                                                <br>
                                                                CC:
                                                                @if (item.TopicCCList != null && item.TopicCCList.Any())
                                                                {
                                                                    @foreach (var items in item.TopicCCList)
                                                                    {
                                                                        <span>@items.FirstName ,</span>
                                                                    }
                                                                }                                                               
                                                                <span class="mailbox-read-time pull-right">@Application.Common.Helper.Helper.FormatDateTime(@item.StartDate)</span>
                                                            </h5>*@
                                                        </div>                                                         

                                                       @* <div class="uk-card-title uk-first-column" style="margin-right:10px; float: left; margin-top: 4px; margin-left: 10px;">@item.TicketNo - @item.TopicName</div>
                                                        <span class="uk-label uk-margin-auto-left">@Application.Common.Helper.Helper.FormatDate(@item.AddedDate)</span>
                                                        *@
                                                        <span class="mailbox-read-time pull-right" style="float: right; margin-top: -23px; margin-right: 40px;">@Application.Common.Helper.Helper.FormatDateTime(@item.StartDate)</span>
                                                        <span class="uk-label uk-margin-auto-left" style="float: right; margin-top: -23px; margin-right: 15px;">

                                                            @if (isAddParticipant)
                                                            {
                                                                @if (isCommandTopicClosed)
                                                                {
                                                                   @* <button @onclick="onAddPlist" class="btn btn-excel" style="margin-top: 2px;">Add Participant </button>*@
                                                                }

                                                            }

                                                            @if (isEllipsis)
                                                            {
                                                                @if (isCommandTopicClosed)
                                                                {
                                                                    <div Id="showFlyout" class="handline fa fa-ellipsis-v" @onclick="() => IsOpenFlyout = true" style="font-size: 18px;    font-weight: bold;"></div>
                                                                    @*<DxButton Id="showFlyout" Click="() => IsOpenFlyout = true">Show a flyout window</DxButton>*@
                                                                    @*<DxMenu Orientation="Orientation.Horizontal" DisplayMode="MenuDisplayMode.Mobile">
                                                                        <Items>
                                                                            <DxMenuItem @onclick="onDueDatePop" Text="Due Date" />
                                                                            <DxMenuItem @onclick="onTopicClosedPop" Text="Close" />

                                                                            @if(isDescription)
                                                                            {
                                                                                <DxMenuItem @onclick="hideTopicDescription" Text="Hide Description" />
                                                                            }
                                                                            else
                                                                            {
                                                                                <DxMenuItem @onclick="showTopicDescription" Text="Show Description" />   
                                                                            }

                                                                        </Items>
                                                                    </DxMenu>*@
                                                                }
                                                                else
                                                                {
                                                                    <div style="color:red;margin-top: 10px;">Closed</div>
                                                                }
                                                            }

                                                            @*<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                            <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
                                                            </svg>*@
                                                        </span>

                                                    </div>
                                                </div>

                                                @if(isDescription)
                                                {   
                                                    <div>
                                                        <div> Description :</div>
                                                        <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />
                                                    </div>
                                                }
                                                
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    <div class="@((isComponentVisible ? "menu-bar-content-container-content msgOpen" : "menu-bar-content-container-content msgClose"))">
                        @* <div class="spacing-box"></div>  *@
                        @if (isMenuvisible == "Posts")
                        {
                            <div id="tableData">
                                <div>
                                    @if (_discussionList != null && _discussionList.Any())
                                    {
                                        @foreach (var item in _discussionList)
                                        {
                                            @if (item.ReplyId > 0)
                                            {
                                                @*<div class="lstcoversationrply">
                                                    <i class="fa fa-reply-all" aria-hidden="true"></i>
                                                    <div>@item.ReplyMessage</div>
                                                    <div style="float:right;margin-top: -13px;">@item.ReplyUserName , @item.ReplyDateTime</div>
                                                </div>*@
                                            }

                                            <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto" style="margin-right: 10px;">
                                                <div class="uk-card-header">
                                                    <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">                                                       
                                                        <div class="mailbox-read-info">                                                           
                                                           <h3>@item.Name</h3>
                                                            <h5>                                                                
                                                                From: @item.UserName
                                                                <br>
                                                                To:
                                                                @if (item.AssignToList != null && item.AssignToList.Any())
                                                                {
                                                                    @foreach (var items in item.AssignToList)
                                                                    {
                                                                        <span>@items.FirstName ,</span>
                                                                    }
                                                                }
                                                                <br>
                                                                CC:
                                                                @if (item.AssignCCList != null && item.AssignCCList.Any())
                                                                {
                                                                    @foreach (var items in item.AssignCCList)
                                                                    {
                                                                        <span>@items.FirstName ,</span>
                                                                    }
                                                                }
                                                                
                                                                <div class="mailbox-read-time pull-right">
                                                                    <div class="" style="margin-top: -8px;">@Application.Common.Helper.Helper.FormatDateTime(@item.AddedDate)</div>
                                                                   @* <div class="btn-group" style="float: right; margin-top: -25px;">
                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 8px; border-radius: 5px;" class="">
                                                                            <i class="fa fa-reply"></i> Reply
                                                                        </button>
                                                                    </div>*@
                                                                </div>
                                                            </h5>
                                                        </div>                                                                                                            
                                                    </div>
                                                </div>
                                                <div class="uk-card-body">                                                   
                                                    <p class="uk-text-success">                                                       
                                                        <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />                                                      
                                                    </p>

                                                    @if (item.documents.Any())
                                                    {
                                                        <div class="uk-card-footer">
                                                            <div>
                                                                <div class="">
                                                                    @foreach (var attachment in item.documents)
                                                                    {
                                                                        <div class="tag handline" @onclick="@(() => onDocDownload(attachment.DocumentId))"><i class="fas fa-file"  aria-hidden="true"></i> @attachment.FileName</div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }

                                                   @* <div class="uk-card-footer">
                                                        <div>
                                                            <div class="accordion-item">
                                                                <div class="accordion-title" @onclick="@(() => ToggleDocItemVisibility(item.ID))"> Attachment </div>                                                               
                                                               
                                                                   @if (DocitemVisibility.ContainsKey(item.ID) && DocitemVisibility[item.ID])
                                                                    {
                                                                        @foreach (var attachment in item.documents)
                                                                        {
                                                                            <div class="tag"><i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName</div>
                                                                        }
                                                                            string firststring = "#overviewDemoSelectButton_";
                                                                            Guid? secondstring = item.SessionId;
                                                                            string extt = firststring + secondstring;
                                                                        
                                                                        <div id="overviewDemoSelectButton_@item.SessionId" class="tag fa fa-plus-square"></div>
                                                                            <DxUpload @ref="MyUpload" Name="files"
                                                                              AcceptedFileTypes=@AcceptedFileTypes
                                                                              Visible="@UploadVisible"
                                                                              ExternalSelectButtonCssSelector="@extt"
                                                                              UploadUrl="@GetDocUploadUrl(@item.SessionId)"
                                                                              Id="@extt"
                                                                              SelectedFilesChanged="@SelectedFilesChanged1"
                                                                              CssClass="w-100"
                                                                              FileUploaded="@HandleUploadSuccess">
                                                                            </DxUpload>
                                                                    }
                                                                
                                                            </div>
                                                        </div>
                                                    </div>*@                                                    
                                                </div>
                                                
                                                @if (item.ReplyConversation.Count() > 0)
                                                {
                                                    <div class="uk-card-footer">
                                                        <div>   
                                                            <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                <i class="fa fa-reply"></i> Reply
                                                            </button>
                                                            <p style="color: #5151b3;" class="handline" @onclick="@(() => ToggleItemVisibility(item.ID))">@item.ReplyConversation.Count() replies </p>
                                                            @if (@item.ReplyConversation != null && @item.ReplyConversation.Any())
                                                            {
                                                                @if (itemVisibility.ContainsKey(item.ID) && itemVisibility[item.ID])
                                                                {
                                                                    @foreach (var items in @item.ReplyConversation)
                                                                    {
                                                                        <div class="lstcoversationrply">
                                                                            <div class="mailbox-read-info" style="border-bottom:1px solid #f4f4f4">
                                                                                @*<h3>@items.Name</h3>*@
                                                                                <h5>                                                                                   
                                                                                    From: @items.UserName
                                                                                    <br>
                                                                                    To:
                                                                                    @if (items.AssignToList != null && items.AssignToList.Any())
                                                                                    {
                                                                                        @foreach (var itms in items.AssignToList)
                                                                                        {
                                                                                            <span>@itms.FirstName ,</span>
                                                                                        }
                                                                                    }
                                                                                    <br>
                                                                                    CC:
                                                                                    @if (items.AssignCCList != null && items.AssignCCList.Any())
                                                                                    {
                                                                                        @foreach (var itm in items.AssignCCList)
                                                                                        {
                                                                                            <span>@itm.FirstName ,</span>
                                                                                        }
                                                                                    }
                                                                                    <span class="mailbox-read-time pull-right">@Application.Common.Helper.Helper.FormatDateTime(@items.AddedDate)</span>
                                                                                   @* <div class="mailbox-read-time pull-right">
                                                                                        <div class="" style="margin-right: 77px; margin-top: -8px;">@Application.Common.Helper.Helper.FormatDateTime(@item.AddedDate)</div>
                                                                                        <div class="btn-group" style="float: right; margin-top: -25px;">
                                                                                            <button type="button" @onclick="@(() => onunderreply(items.ID))" style="border: 1px solid #eeebeb; padding: 8px; border-radius: 5px;" class="">
                                                                                                <i class="fa fa-reply"></i> Reply
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>*@
                                                                                </h5>
                                                                            </div>                                                                           
                                                                            <div>
                                                                                <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@items.FileData" />
                                                                            </div>
                                                                            @if (items.documents != null && items.documents.Any())
                                                                            {
                                                                                @foreach (var attachment in items.documents)
                                                                                {
                                                                                    <div class="tag handline" @onclick="@(() => onDocDownload(attachment.DocumentId))"><i class="fas fa-file"  aria-hidden="true"></i> @attachment.FileName</div>
                                                                                }                                                                              
                                                                            }
                                                                            @if (items.ReplyConversation.Count() > 0)
                                                                            {
                                                                                <div class="uk-card-footer">
                                                                                    <div>
                                                                                        <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                                            <i class="fa fa-reply"></i> Reply
                                                                                        </button>
                                                                                        <p style="color: #5151b3;" class="handline" @onclick="@(() => ToggleItemVisibility(items.ID))">@items.ReplyConversation.Count() replies </p>
                                                                                        @if (@items.ReplyConversation != null && @items.ReplyConversation.Any())
                                                                                        {
                                                                                            @if (itemVisibility.ContainsKey(items.ID) && itemVisibility[items.ID])
                                                                                            {
                                                                                                 @foreach (var itm in @items.ReplyConversation)
                                                                                                {
                                                                                                    <div class="lstcoversationrply">
                                                                                                    <div class="mailbox-read-info" style="border-bottom:1px solid #f4f4f4">
                                                                                                            <h3>@itm.Name</h3>
                                                                                                        <h5>
                                                                                                            
                                                                                                            From: @itm.UserName
                                                                                                            <br>
                                                                                                            To:
                                                                                                            @if (itm.AssignToList != null && itm.AssignToList.Any())
                                                                                                            {
                                                                                                                @foreach (var itms in itm.AssignToList)
                                                                                                                {
                                                                                                                    <span>@itms.FirstName ,</span>
                                                                                                                }
                                                                                                            }
                                                                                                             <br>
                                                                                                            CC:
                                                                                                            @if (itm.AssignCCList != null && itm.AssignCCList.Any())
                                                                                                            {
                                                                                                                @foreach (var itms in itm.AssignCCList)
                                                                                                                {
                                                                                                                    <span>@itms.FirstName ,</span>
                                                                                                                }
                                                                                                            }
                                                                                                            <span class="mailbox-read-time pull-right">@Application.Common.Helper.Helper.FormatDateTime(@itm.AddedDate)</span>                                                                                                            
                                                                                                        </h5>
                                                                                                    </div>
                                                                                                    <div>
                                                                                                        <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@itm.FileData" />
                                                                                                    </div>
                                                                                                    @if (itm.documents != null && itm.documents.Any())
                                                                                                    {
                                                                                                        @foreach (var attachment in itm.documents)
                                                                                                        {
                                                                                                            <div class="tag handline" @onclick="@(() => onDocDownload(attachment.DocumentId))"><i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName</div>
                                                                                                        }
                                                                                                    }
                                                                                                    </div>
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    </div>
                                                                                </div>

                                                                            }
                                                                        </div>
                                                                       
                                                                    }

                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="uk-card-footer">
                                                        <div>
                                                            <button type="button" @onclick="@(() => onreply(item.ID))" style="border: 1px solid #eeebeb; padding: 1px; border-radius: 5px;float: left; margin-right: 10px; padding-right: 10px; padding-left: 10px;" class="">
                                                                <i class="fa fa-reply"></i> Reply
                                                            </button>
                                                            <p style="color: #5151b3;" class="handline" >0 replies </p>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>



                                @if (isComponentVisible)
                                {
                                    @if(IsConHistory)
                                    {
                                        <DxButton RenderStyle="ButtonRenderStyle.Success" CssClass="me-1 btn-success open-button"
                                      Click="onWindowVisible" style="width:200px;">New Conversation</DxButton>
                                    }
                                    
                                    <DxWindow @bind-Visible=WindowVisible 
                                      HeaderText="Post"
                                      HorizontalAlignment="HorizontalAlignment.Right"
                                      VerticalAlignment="DevExpress.Blazor.VerticalAlignment.Bottom"
                                      CloseOnEscape="true"
                                      ResizeCompleted="OnWindowResizeCompleted"
                                      ShowFooter=false
                                      AllowResize="true"
                                      Closing="EulaClosing"
                                      MinWidth="800"
                                      Width="800"                                      
                                      Height="600"
                                      ShowCloseButton="true"                                                
                                      @ref="dxWindow">
                                        <BodyTemplate Context="Context">
                                            @*<div class="close-button handline" @onclick="CloseClick">X</div>*@
                                            <div class="dxwinheight" style="padding: 20px; overflow: auto;">
                                                <DxFormLayout>
                                                    <div class="open-button-old" style="width:99.5%">
                                                       @* @if (_replyComment != null && _replyComment.Any())
                                                        {
                                                            @foreach (var item in _replyComment)
                                                            {
                                                                <div class="replybox">
                                                                    <div> <i class="fa fa-reply" aria-hidden="true"></i> Reply</div>
                                                                    <div class="closebtn" @onclick="closeReply">X</div>
                                                                    
                                                                    <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg editor-reply-height" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />
                                                                    <div>@item.UserName  , @item.AddedDate</div>
                                                                </div>
                                                            }
                                                        }*@
                                                        @*       DocumentContentChanged="OnmsgContentChanged"
                                                Selection="@richSelection" SelectionChanged="OnSelectionChanged"
                                                *@
                                                        @if (isCommand)
                                                        {
                                                            @if (isCommandTopicClosed)
                                                            {
                                                                <div class="boxreplay">
                                                                   @* @if (_headTopic != null && _headTopic.Any())
                                                                    {
                                                                        @foreach (var item in _headTopic)
                                                                        {
                                                                            <h3>@item.TopicName</h3>
                                                                        }
                                                                    }*@

                                                                    <EditForm Model="@Data" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                                                                        @* <DataAnnotationsValidator />*@
                                                                        <DxFormLayout>
                                                                            <DxFormLayoutItem Caption="Subject Name" ColSpanMd="12">
                                                                                <DxTextBox @bind-Text="@Data.Name" ShowValidationIcon="true" NullText="Subject Name" Enabled="@IsReadOnly" />
                                                                                <ValidationMessage For="@(() => Data.Name)" />
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="From" ColSpanMd="12">
                                                                                <DxTextBox @bind-Text="@Data.From" ShowValidationIcon="true" Enabled=false />
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="Assign To" ColSpanMd="12">
                                                                            <DxTagBox NullText="Select Assign To..."
                                                                          Data="@_allparticipant"
                                                                                      ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                      ValueFieldName="UserID"
                                                                                      TextFieldName="FirstName"
                                                                                      ListRenderMode="ListRenderMode.Virtual"
                                                                                      @bind-Values="@Data.AssigntoIds"
                                                                                      CssClass="cw-480">
                                                                                <DxListEditorColumn FieldName="@nameof(EmailAssignToList.CompanyName)"
                                                                                    Caption="Company"
                                                                                    Width="100px"/>
                                                                                <DxListEditorColumn FieldName="@nameof(EmailAssignToList.DesignationName)"
                                                                                    Caption="Designation" />
                                                                                <DxListEditorColumn FieldName="@nameof(EmailAssignToList.FirstName)"
                                                                                    Caption="First Name" 
                                                                                    Width="100px" />
                                                                                    <DxListEditorColumn FieldName="@nameof(EmailAssignToList.NickName)"
                                                                                    Caption="Nick Name" />
                                                                            </DxTagBox>
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem Caption="CC" ColSpanMd="12">
                                                                            <DxTagBox NullText="Select cc..."
                                                                                      Data="@_allparticipant"
                                                                                      ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                                                      ValueFieldName="UserID"
                                                                                      TextFieldName="FirstName"
                                                                                       ListRenderMode="ListRenderMode.Virtual"
                                                                                      @bind-Values="@Data.AssignccIds"
                                                                                      CssClass="cw-480">
                                                                                <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)"
                                                                                    Caption="Company"
                                                                                    Width="100px"/>
                                                                                <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)"
                                                                                    Caption="Designation" />
                                                                                <DxListEditorColumn FieldName="@nameof(ViewEmployee.FirstName)"
                                                                                    Caption="First Name" 
                                                                                    Width="100px" />
                                                                                    <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)"
                                                                                    Caption="Nick Name" />
                                                                            </DxTagBox>
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem ColSpanMd="12">
                                                                                <div class="">
                                                                                    <DxRichEdit @ref="msgrichEdit" CustomizeToolbar=OnCustomizeToolbar BarMode="BarMode.Toolbar" CssClass="w-100 h-100 txtEditorMsg editor-box-height" Id="editor-box-height" ViewType="ViewType.Simple" />
                                                                                </div>
                                                                            </DxFormLayoutItem>
                                                                            <DxFormLayoutItem ColSpanMd="12">
                                                                               @* <DxButton SubmitFormOnClick="true" Text="" CssClass="fa fa-paper-plane sndrot" style="float:right" RenderStyle="ButtonRenderStyle.Secondary">
                                                                                   
                                                                                </DxButton>*@
                                                                                <button disabled="@loading" class="fa fa-paper-plane sndrot" style="float:right; margin-top:10px;">
                                                                                    @if (loading)
                                                                                    {
                                                                                        <span class="spinner-border spinner-border-sm mr-1"></span>
                                                                                    }                                                                                    
                                                                                </button>
                                                                                <div style="display:flex;" class="attmode">
                                                                                    <div id="attachmentSelectButton" class="fa fa-paperclip handline cdspcc" aria-hidden="true"></div>

                                                                                    <div class="">
                                                                                        <DxUpload @ref="uploadComponent" Name="files"
                                                                                  Visible="@AttachmentUploadVisible"                                                                                 
                                                                                  AcceptedFileTypes=@AcceptedFileTypes
                                                                                  UploadMode="@UploadMode.OnButtonClick"
                                                                                  UploadUrl="@GetUploadUrl()"
                                                                                  AllowMultiFileUpload="true"
                                                                                  ExternalSelectButtonCssSelector="#attachmentSelectButton"
                                                                                  SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                                                                  FileUploaded="@isUploadSuccess"
                                                                                  FileUploadError="@OnUploadError">
                                                                                        </DxUpload>
                                                                                        <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>
                                                                                    </div>
                                                                                </div>
                                                                            </DxFormLayoutItem>
                                                                        </DxFormLayout>
                                                                    </EditForm>
                                                                </div>
                                                            }
                                                        }

                                                        @* <DxRichEdit Height="500px" Width="100%"></DxRichEdit>*@

                                                    </div>
                                                </DxFormLayout>
                                            </div>
                                        </BodyTemplate>
                                        <FooterTextTemplate>
                                            <DxButton SubmitFormOnClick="true" Text="Post" CssClass="" RenderStyle="ButtonRenderStyle.Primary" />
                                            <DxButton RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@context.CloseCallback" />
                                            <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@context.CloseCallback" />
                                        </FooterTextTemplate>
                                    </DxWindow>
                                }
                                else
                                {

                                   @* <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                                      Text="New Conversation"
                                      Click="@(() => isComponentVisible = true)"
                                      IconCssClass="btn-icon-undo"
                                              style="color:white; width:200px;"
                                      CssClass="me-1 btn-success open-button" />*@
                                }
                            </div>
                        }
                        else if (isMenuvisible == "Files")
                        {
                            <div class="card w-100" style="margin-bottom:10px; margin-top:10px">
                                <div class="card-body p-0">                                   
                                    <DxMenu CollapseItemsToHamburgerMenu="true" 
                                    CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                                    DisplayMode="MenuDisplayMode.Desktop">
                                    <Items>
                                        @if(IsValidUser)
                                        {
                                            <DxMenuItem Text="Preview" IconCssClass="fa fa-eye" Click="((e) => onPreview(_selectlst.DocumentId))" Enabled=PreviewEnabled />
                                            <DxMenuItem Text="Download" IconCssClass="fa fa-cloud-download" Click="((e) => onDocDownload(_selectlst.DocumentId))" Enabled=docEnabled />
                                        }                                       
                                        
                                    </Items>
                                    </DxMenu>
                                </div>
                            </div>
                            <DxGrid @ref="Grid" Data="@_topicDocList" EditMode="GridEditMode.EditForm" ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
                                PagerNavigationMode="PagerNavigationMode.InputBox"
                                PageSizeSelectorVisible="true"
                                PageSizeSelectorAllRowsItemVisible="true"
                                PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                                PageSize="20"
                                style="height:calc(100vh - 355px)"
                                CssClass="ch-360"
                                AutoExpandAllGroupRows="true"
                                RowClick="OnRowClick"
                                FocusedRowEnabled="true"
                                SelectionMode="GridSelectionMode.Multiple"
                                SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages">
                                <Columns>
                                @*    <DxGridSelectionColumn Width="60px" AllowSelectAll="true" />*@
                                    <DxGridDataColumn FieldName="FileIndex" Caption="#" Width="35px" FixedPosition="GridColumnFixedPosition.Left"></DxGridDataColumn>
                                    <DxGridDataColumn FieldName="SubjectName" MinWidth="200" FixedPosition="GridColumnFixedPosition.Left"  />
                                    <DxGridDataColumn FieldName="FileName" MinWidth="200" />

                                    <DxGridDataColumn FieldName="AddedBy" MinWidth="200" />
                                    <DxGridDataColumn FieldName="AddedDate" Width="180px">
                                        <CellDisplayTemplate>
                                            @{
                                                var item = (Documents)context.DataItem;
                                            }
                                            @Application.Common.Helper.Helper.FormatDateTime(item.AddedDate)
                                        </CellDisplayTemplate>
                                    </DxGridDataColumn>
                                    <DxGridDataColumn FieldName="ModifiedBy" MinWidth="200" />
                                    <DxGridDataColumn FieldName="ModifiedDate" Width="180px">
                                        <CellDisplayTemplate>
                                            @{
                                                var item = (Documents)context.DataItem;
                                            }
                                            @Application.Common.Helper.Helper.FormatDateTime(item.ModifiedDate)
                                        </CellDisplayTemplate>
                                    </DxGridDataColumn>

                                    @*<DxGridDataColumn FieldName="FileSize" />*@
                                   @* <DxGridDataColumn FieldName="DocumentId" Caption="Preview" AllowSort="false" Width="90px" MinWidth="45" TextAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate><button class="dxbl-btn fa fa-eye" @onclick="() => onPreview((long)context.Value)"></button></CellDisplayTemplate>
                                    </DxGridDataColumn>
                                    <DxGridDataColumn FieldName="DocumentId" Caption="Download" AllowSort="false" Width="90px" FixedPosition="GridColumnFixedPosition.Right"  MinWidth="45" TextAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate><button class="dxbl-btn fa fa-cloud-download" @onclick="() => onDocDownload((long)context.Value)"></button></CellDisplayTemplate>
                                    </DxGridDataColumn>*@
                                   @* <DxGridDataColumn FieldName="DocumentId" Caption="Delete" AllowSort="false" Width="90px" MinWidth="45" TextAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate><button class="btnDelete fas fa-trash" @onclick="() => onDocDelete((long)context.Value)"></button></CellDisplayTemplate>
                                    </DxGridDataColumn>*@
                                </Columns>
                            </DxGrid>
                        }
                        else if (isMenuvisible == "Todo")
                        {
                            <ToDoList Tid="@Tid"></ToDoList>
                          
                        }
                        else
                        {
                            <ParticipantList @ref=RefTopicAddPList IsValidUser="@IsValidUser" Tid="@Tid" Cid="@Cid"></ParticipantList>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<DxFlyout @bind-IsOpen="@IsOpenFlyout"
          PositionTarget="#showFlyout"
          Position="FlyoutPosition.Left"
          CloseOnOutsideClick="true"
          FooterVisible="false">
           <BodyTextTemplate>
                <DxMenu Orientation="Orientation.Horizontal">
                    <Items>
                        <DxMenuItem @onclick="onDueDatePop" Text="Due Date" />
                        <DxMenuItem @onclick="onTopicClosedPop" Text="Close" />
                        <DxMenuItem @onclick="onAddCategoryPop" Text="Tag" />
                    </Items>
                </DxMenu>               
            </BodyTextTemplate>
    <FooterTextTemplate>       
        <DxButton Text="close" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxFlyout>

<DxPopup @ref="popup" HeaderText="CRT" ShowCloseButton="true" Width="100%" Height="100%" @bind-Visible="@PreviewDocPopup">
    <BodyContentTemplate>
        <div class="richeditorHeight">
            <DxRichEdit @ref="@richEdit" DocumentFormat="@MyDocumentFormat" DocumentContent="@documentContent" ViewType="ViewType.Simple" BarMode="BarMode.Toolbar" CssClass="w-100" DocumentContentChanged="OnDocumentContentChanged"></DxRichEdit>
        </div>
      @*  <div id="pdfInterop"></div>*@
       @* <iframe src="@documentPreviewUrl" type="@documentMimeType" width="800" height="600"></iframe>
        <iframe src="https://www.example.com" width="100%" height="500"></iframe>*@
    </BodyContentTemplate>    
</DxPopup>



<DxPopup @ref="popup" HeaderText="Doc Delete" ShowCloseButton="true" Width="300px" @bind-Visible="@DocPopupVisible">
    <div class="text-center">
        <Content>
            <p>
                <div Position="Left" id="@("label"+_documents.FileName)" class="display-field"> Do you want to  Delete this <span style="color:red">@_documents.FileName</span> </div>
            </p>
        </Content>        
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitDocDelete(_documents.DocumentId))"/>
        <DxButton CssClass="dx-button.dx-icon" Text="No" Click="@(() => ClosePopup())" />
    </div>
</DxPopup>

<DxPopup @bind-Visible="@isDueDate" HeaderText="Add Due Date">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

        <EditForm Model="@_dataDuDate" OnValidSubmit="@SubmitDueDate" class="w-800">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-md-12" style="padding-bottom: 12px">
                <label for="DueDate"> DueDate: </label>
                <DxDateEdit @bind-Date="@_dataDuDate.DueDate"
                            NullText="Select a date..."
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                            ShowValidationIcon="true"
                            CssClass="cw-320">
                </DxDateEdit>
                <ValidationMessage For="@(() => _dataDuDate.DueDate)" />
            </div>
            <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
            </div>
        </div>
        </EditForm>           
        </div>
       
    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isTopicClosed" HeaderText="Topic Close">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataTopicClose" OnValidSubmit="@SubmitTopicClose" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="Remarks"> Remarks: </label>
                        <DxMemo @bind-Text="@_dataTopicClose.Remarks"
                                CssClass="cw-480"
                                Rows="5" />
                        <ValidationMessage For="@(() => _dataTopicClose.Remarks)" />
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>

           @* <label>Remarks</label>
            <DxMemo @bind-Text="ClosedMsg"
                    CssClass="cw-480"
                    Rows="5"/>
            <br />
            <DxButton RenderStyleMode="@ButtonRenderStyleMode.Outline"
                      Text="Submit" style="width: 100px !important; float: right;"
                      CssClass="w-100" />*@
        </div>
    </BodyTemplate>
</DxPopup>


<DxPopup @bind-Visible="@isTopicCategoryClosed" HeaderText="Tag">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">
            <TopicCategory TopicId="@Tid" loadTagsList="onloadTagsList"></TopicCategory>
        </div>
    </BodyTemplate>
</DxPopup>


<DxPopup @bind-Visible="@isAssignToVisible" HeaderText="Assigned To">
    <BodyTemplate Context="PopupContext">      
        <DxGrid @ref="Grid" Data="_conversationAssignTo"
                KeyFieldName="ID"
                ShowSearchBox="true"
                PagerNavigationMode="PagerNavigationMode.InputBox"
                PageSizeSelectorVisible="true"
                PageSizeSelectorAllRowsItemVisible="true"
                PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                PageSize="20"
                style="height:calc(100vh - 285px);min-height:400px !important"
                CssClass="ch-360">
            <Columns>                          
                <DxGridDataColumn FieldName="RowIndex" Width="35" Caption="#" />
                <DxGridDataColumn FieldName="FirstName" MinWidth="100" />
                <DxGridDataColumn FieldName="LastName" />
            </Columns>
        </DxGrid>

    </BodyTemplate>
</DxPopup>




<DxPopup @bind-Visible="@MessageVisible" HeaderText="@MessageHeader">
    <BodyTemplate Context="PopupContext">
        <div class="@((MessageHeader == "Error" ? "TxtRed" : "TxtGreen"))" style="text-align:center; padding: 10px; font-size: 15px;">
            <span> @MessageBody</span>
        </div>
    </BodyTemplate>
</DxPopup>

@*<DxPopup @bind-Visible="@isFileUpload" HeaderText="Attachments">
    <BodyTemplate Context="PopupContext">
        <div style="padding: 15px;">
            <button id="overviewDemoSelectButton" class="btn border-primary btn-primary m-1">Selected File</button>
            <div class="">              
                <DxUpload @ref="uploadComponent" Name="files"                          
                          Visible="@UploadVisible"                        
                          AcceptedFileTypes=@AcceptedFileTypes
                          UploadMode="@UploadMode.OnButtonClick"                        
                          UploadUrl="@GetUploadUrl()"
                          AllowMultiFileUpload="false"
                          ExternalSelectButtonCssSelector="#overviewDemoSelectButton"                         
                          SelectedFilesChanged="@SelectedFilesChanged"
                          FileUploaded="@isUploadSuccess"
                          FileUploadError="@OnUploadError">
                </DxUpload> 
                <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>               
            </div>
        </div>
    </BodyTemplate>
</DxPopup>*@
<style>
    .dxuc-upload-icon {
        display: none; /* or any other style to disable or hide the icon */
    }
</style>
@*
<button class="btn btn-primary" @onclick="ShowToast">Show Toast</button>

<button class="btn btn-primary" @onclick="@(()=>ToastService.ShowSuccess("welcome to ass"))">Show Toast</button>
*@


@code {
    public int ActiveTabIndex { get; set; } = 1;
    string? SearchText { get; set; }
    string? GridSearchText { get; set; }
    bool PreviewEnabled { get; set; } = false;
    bool docEnabled { get; set; } = false;
    private CancellationTokenSource cancellationTokenSource;
    private const int AutoRefreshInterval = 10000; // 10 seconds
    private Documents _selectlst;
    [Parameter]
    public string ActiveSessionId { get; set; }
    public string filterrowname { get; set; }
    private bool IsConHistory = false;
    [Parameter]
    public EventCallback<string> RId { get; set; }
    IGrid TOGrid { get; set; }
    IGrid CCGrid { get; set; }
    IGrid SentGrid { get; set; }
    DxWindow dxWindow;
    bool WindowVisible { get; set; } = false;
    private bool IsReadOnly = true;

    private List<EmailTopics>? _forumTopicTo;
    private List<EmailTopics>? _forumTopicCC;
    private List<EmailTopics>? _forumTopicSent;

    private int ElementHeight { get; set; }
    [Parameter]
    public long Tid { get; set; }
    [Parameter]
    public long Cid { get; set; }
    public long RTopicId = 0;
    bool IsOpen { get; set; } = false;
    bool IsOpenFlyout { get; set; } = false;
    Selection selection; 
    Selection richSelection { get; set; }
    [Parameter]
    public EventCallback<IToolbar> CustomizeToolbar { get; set; }
    bool ErrorVisible { get; set; } = false;
    string MyError { get; set; }

    [Parameter]
    public List<string> AcceptedFileTypes { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF" };
    public List<string> AllowedFileExtensions { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx",".txt",".pdf",".PDF" };
    public DocumentFormat MyDocumentFormat { get; set; }
    private string? BaseUrl;
    private string? FileUrl;
    string documentPath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
    string documentFormat = "docx";
    private ElementReference OfficeContainerRef;
    DxRichEdit richEdit { get; set; }
    DxRichEdit msgrichEdit { get; set; }
    string previewUrl;
    private string documentPreviewUrl;
    private string documentMimeType;
    byte[] documentContent;
    byte[] msgContent;
    DxUpload MyUpload { get; set; }
    bool UploadVisible { get; set; } = true;
    bool AttachmentUploadVisible { get; set; } = false;
    bool isDescription { get; set; } = false;
    private bool uploadSuccess = false;
    IEnumerable<UploadFileInfo> Files { get; set; }
    UploadFileInfo FirstFile { get; set; }
    public string MyHeight { get; set; } = "200px";
    string width = "800px", height = "800px";
    private ParticipantList? RefTopicAddPList { get; set; }
    private bool IsValidUser { get; set; } = false;
    [Parameter]
    public EventCallback<string> Participent { get; set; }
    private async Task OnWindowResizeCompleted(WindowResizeCompletedEventArgs args) {
        // (width, height) = ($"{args.Size.Width}px", $"{args.Size.Height}px");
        (width) = ($"{args.Size.Width}px");
        MyHeight =  $"{args.Size.Height}px";
        string setHeight = $"{args.Size.Height - 290}";
        string selector = ".editor-box-height";

        //await JSRuntime.InvokeVoidAsync("adjustHeight", setHeight);
        await JSRuntime.InvokeVoidAsync("setHeight", selector, setHeight);
    }
    private class Model
    {
        [Required(ErrorMessage = "Due Date is required")]
        public DateTime? DueDate { get; set; }      
    }
    private class ModelClose
    {
        [Required(ErrorMessage = "Remarks is required")]
        public string? Remarks { get; set; }
    }   
    private DxUpload uploadComponent;  

    private Model _dataDuDate = new Model();
    private ModelClose _dataTopicClose = new ModelClose();

    string ClosedMsg { get; set; }
    DateTime? DateTimeValue { get; set; }
    DxPopup? popup;
    bool PopupVisible { get; set; } = false;
    bool DocPopupVisible { get; set; } = false;
    bool PreviewDocPopup { get; set; } = false;
    private Dictionary<int, bool> itemVisibility = new Dictionary<int, bool>();
    private Dictionary<int, bool> DocitemVisibility = new Dictionary<int, bool>();
    private Dictionary<long, bool> topicitemVisibility = new Dictionary<long, bool>();
    AccordionExpandMode ExpandMode { get; set; } = AccordionExpandMode.SingleOrNone;
    AccordionExpandCollapseAction ExpandCollapseAction { get; set; } = AccordionExpandCollapseAction.HeaderClick;

    string isMenuvisible = "Posts";
    string isLeftMenuvisible = "AssignTo";
    DxTreeView treeView;
    IGrid? Grid { get; set; }
    bool isFileUpload = false;
    bool isDueDate =false;
    bool isTopicClosed = false;
    bool isTopicCategoryClosed = false;
    bool isAllPlistVisible = false;
    bool isAssignToVisible = false;
    bool isComponentVisible = true;
    bool isEnabled { get; set; } = false;
    bool isAddParticipant = false;
    bool isCommand = false;
    bool isCommandTopicClosed = true;
    bool isEllipsis = false;
    long? AppUserId;
    private List<Documents>? _topicDocList;    
    private List<EmailTopics>? _topics;
    public List<EmailConversations> _getConversationList;
    public List<EmailConversations> _discussionList;
    public List<EmailConversations> _discussionFullList;
    public List<EmailConversations> _replyComment;
    private List<EmailTopics>? _headTopic;
    private List<EmailActivityCatgorys>? _headTopic_Tag;
    string FilterString { get; set; }
    private List<EmailParticipant>? _participant;
    EmailParticipant _participantLst { get; set; }
    Documents _documents { get; set; }
    private List<ViewEmployee>? _allparticipant;
    private List<EmailConversationAssignTo>? _conversationAssignTo;
    private List<ViewEmployee>? _selectedlistpartlist;
    NavigationFilterMode FilterMode { get; set; } = NavigationFilterMode.EntireBranch;    
    EmailConversations? Data { get; set; } = new EmailConversations();
    string SelectedGroup = "none";
    string SelectedReplyId = "none";
    public ApplicationUser applicationUser { get; private set; }
    IReadOnlyList<object>? SelectedDataItems { get; set; }
    List<long> participantIds = new List<long>();
    private bool loading;
    bool MessageVisible { get; set; }
    string styleClass = "";
    string MessageHeader = "Error";
    string MessageBody = "";
    Guid? _sessionId;
    private string uploadUrl;   
    private List<EmailAssignToList>? _assigntoItems;

    byte[] myBytes = Encoding.UTF8.GetBytes("Attachments");

    [Parameter]
    public ViewEmployee _employeeDatas { get; set; }
    [Parameter]
    public ApplicationUser _applicationUser { get; set; }

    [Parameter]
    public UploadMode UploadMode { get; set; }
    private string myFile { get; set; }

    int SelectedFilesCount { get; set; }

    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    IEnumerable<UploadFileInfo> Filess { get; set; }

    void OnRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "DocumentId");
        _selectlst = _topicDocList.FirstOrDefault(f => f.DocumentId == (long?)UniqueId);

    }
    void ApplySearch()
    {       
        //var assignToEmailComponent = new AssignToEmail();
        //assignToEmailComponent.ApplySearch(GridSearchText);
    }
    private async Task ScrollToElement()
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", ".msgOpen");
    }
    async Task CloseClick(MouseEventArgs args)
    {
        await dxWindow.CloseAsync();
        closeReply();
    }
    protected async void SelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        SelectedFilesCount = files.ToList().Count;       
        await InvokeAsync(StateHasChanged);
        uploadSuccess = false;
        if(files.ToList().Count > 0)
            await UploadFiles();
    }
    protected async void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
    }
    bool UploadVisible1 { get; set; } = false;
    protected void SelectedFilesChanged1(IEnumerable<UploadFileInfo> files)
    {
        Filess = files;
        SelectedFiles.AddRange(files);
        UploadVisible1 = files.ToList().Count > 0;   

        InvokeAsync(StateHasChanged);
    }   
    private void RemoveFile(UploadFileInfo file)
    {
        SelectedFiles.Remove(file);
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
            e.CssClass += "non-selectable-row";
        }
        //if (e.ElementType == GridElementType.HeaderCell)
        //{
        //    e.Style = "background-color: rgba(0, 0, 0, 0.08)";
        //    e.CssClass = "header-bold";
        //}
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {            
            await JSRuntime.InvokeVoidAsync("window.addEventListener", "scroll", DotNetObjectReference.Create(this).Value, "HandleScroll");
        }


        if (uploadSuccess)
        {
            // Invoke another function here
            //AnotherFunction();
        }
    }
    public async Task onDisDocDownload(string FilePath)
    {
        var url = FileUrl + FilePath;
        await OpenUrlInNewTab(url);        
    }

    [JSInvokable("handleScroll")]
    public void HandleScroll(string scrollDirection)
    {
        if (scrollDirection == "down")
        {
            // Scroll down logic
            var scrollY = JSRuntime.InvokeAsync<int>("window.scrollY").Result;
            var scrollDirection1 = scrollY < 100 ? "up" : "down";

            if (scrollDirection1 == "up")
            {
                //isScrollingUp = true;
                //isScrollingDown = false;
            }
            else
            {
                //isScrollingUp = false;
                //isScrollingDown = true;
            }

            StateHasChanged();



        }
        else if (scrollDirection == "up")
        {
            // Scroll up logic
        }
    }
    private async Task InitializeViewer()
    {
        await JSRuntime.InvokeVoidAsync("loadViewerJS");
        string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";
        // Set the document URL
        string documentUrl = filePath;
        await JSRuntime.InvokeVoidAsync("openViewer", "viewerContainer", documentUrl);


    }
    private async Task isUploadSuccess()
    {
        uploadComponent.RemoveAllFiles();
        isFileUpload = false;
        await LoadData();
    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleUploadSuccess()
    {   

        FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);

        //MyUpload.RemoveAllFiles();
        ///SelectedFiles.Clear();
        await AnotherFunction();
        // await TriggerCancelIcon();
    }

    async Task OnButtonClick()
    {
        var FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);      
    }   
    private async Task TriggerCancelIcon()
    {      
        await JSRuntime.InvokeVoidAsync("myFunction()");
        await JSRuntime.InvokeVoidAsync("createToast(success)");
    }

    private async Task AnotherFunction()
    {
        await LoadData();

    }

    private void OpenFileUpload()
    {
        //uploadComponent.OpenFileDialog();
    }    
    public string GetDocUploadUrl(Guid? sId)
    {
        //var sessionId = Guid.NewGuid();

        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + sId + "&addedByUserId="+ AppUserId;
        return url.ToString();
    }
    public string GetUploadUrl()
    {
        //var sessionId = Guid.NewGuid();

        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + _sessionId + "&addedByUserId="+ AppUserId;
        return url.ToString();
    }
    private void closeUploadFiles()
    {
        isFileUpload = false;
        var lst = SelectedFilesCount;
    }
    private async Task UploadFiles()
    {
        //var lst = SelectedFilesCount;    
        byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false);


        string assignCCidsString = string.Join(",", _assigntoItems.Select(s => s.UserID).ToList());
        string assigntoidsString = string.Join(",", Data.AssigntoIds);

        var createReq = new CreateEmailCoversation
            {

                TopicID = (long.Parse(@SelectedGroup)),
                Message = Data.Message != null ? Data.Message : "Attachments",
                FileData = fileContent.Length == 480 ? myBytes : fileContent,
                //AssigntoIds = Data.AssigntoIds.Count() == 0 ? _assigntoItems.Select(s => s.UserID).ToList() : Data.AssigntoIds,
                AssigntoIdss = Data.AssigntoIds.Count() == 0 ? assignCCidsString : assigntoidsString,
                //FileData = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false),
                ParticipantId = applicationUser.UserID,
                ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = _sessionId
            };
        // _sessionId = createReq.SessionId;
        var result = await Mediator.Send(createReq);       
        isFileUpload = false;
        //uploadComponent.UploadAllFiles();
        var rls =   Task.Run(() => uploadComponent.UploadAllFiles());

        await Task.Delay(2000); // Delay for 2 seconds
        await LoadData();
        onRestText();
        closeReply();
        onloadSession();
        //HandleScroll("down");
        await msgrichEdit.NewDocumentAsync();
        //uploadComponent.UploadAllFiles();
    }
    public void ClearUploadedFiles()
    {
        uploadComponent.CancelAllFilesUpload();
    }
    async Task OnFileUploaded(FileUploadEventArgs e)
    {
        var request = new EditDocumentCommand
            {
                AddedByUserId = _applicationUser.AddedByUserID,
                ModifiedByUserId = _applicationUser.ModifiedByUserID,
                SessionId = _employeeDatas.SessionId,
            };
        var response = await Mediator.Send(request);       
        await InvokeAsync(StateHasChanged);

    }
    private void onTopicClosedPop()
    {
        isTopicClosed = true;
    }
    private void onAddCategoryPop()
    {
        isTopicCategoryClosed = true;
    }    
    private void showTopicDescription()
    {
        isDescription = true;
    }
    private void hideTopicDescription()
    {
        isDescription = false;
    }
    async void onDueDatePop()
    {
        isDueDate = true;       
    }
    async void SubmitDueDate()
    {
        var UpdateReq = new UpdateTopicDueDate
            {
                ID = long.Parse(@SelectedGroup),
                DueDate = _dataDuDate.DueDate,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);
        if (result == 1)
        {
            isDueDate = false;
            onShowPopupMessage("success", "Updated DueDate Successfully");
        }
        else
        {

        }

    }
    async void SubmitTopicClose()
    {
        var UpdateReq = new UpdateTopicClosed
            {
                ID = long.Parse(@SelectedGroup),
                Remarks = _dataTopicClose.Remarks,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };
        var result = await Mediator.Send(UpdateReq);   
        if(result == 1)
        {
            isTopicClosed = false;
            onShowPopupMessage("success", "Topic Closed Successfully");
        }
        else
        {

        }
    }

    private async Task SelectionChanged(TreeViewNodeEventArgs e)
    {
        SelectedGroup = e.NodeInfo?.Name;
        //_discussionList = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
        if(SelectedGroup != "0")
        {
            await LoadData();
        }
    } 
    private async void onSubViewEmailSentClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();
    }
    private async void onSubViewEmailCCClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged(); 
    }
    private async void onSubViewEmailToClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();       
    }
    private async void onSubViewEmailAllClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();       
    }    
    private async void onViewEmailToClick(string ToTopicId)
    {
        SelectedGroup = ToTopicId;
        await LoadData();
        StateHasChanged();
    } 
    private async void onViewEmailAllClick(string ATopicId)
    {
        SelectedGroup = ATopicId;
        await LoadData();
        StateHasChanged();
    }    
    private async void onViewEmailCCClick(string CCTopicId)
    {
        SelectedGroup = CCTopicId;
        await LoadData();
        StateHasChanged();
    }
    private async void onViewEmailSentClick(string sentTopicId)
    {
        SelectedGroup = sentTopicId;
        await LoadData();
        StateHasChanged();
    }   
    private async void onSubViewEmailClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        await Task.Delay(1000); // Example asynchronous operation
        await LoadReplyData();
        StateHasChanged();
    }
    public async Task onPreview(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        string extension = Path.GetExtension(_documents.FilePath);



        if(extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
        {
            MyDocumentFormat = DocumentFormat.OpenXml;
            //documentContent = await File.ReadAllBytesAsync(response.FilePath);      
            var httpClient = new HttpClient();
            var responses = await httpClient.GetAsync(response.FilePath);
            documentContent = await responses.Content.ReadAsByteArrayAsync();
            PreviewDocPopup = true;
        }
        else if(extension.ToLower() == ".txt")
        {
            var url = FileUrl + response.FilePath;
            MyDocumentFormat = DocumentFormat.PlainText;
            //documentContent = await File.ReadAllBytesAsync(response.FilePath);          


            var httpClient = new HttpClient();
            var responses = await httpClient.GetAsync(response.FilePath);
            documentContent = await responses.Content.ReadAsByteArrayAsync();

            //documentContent = await File.ReadAllBytesAsync(fpaath);
            PreviewDocPopup = true;
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".jpeg" || extension.ToLower() == ".jpg" || extension.ToLower() == ".png" || extension.ToLower() == ".gif" || extension.ToLower() == ".bmp" || extension.ToLower() == ".svg")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else
        {
            onShowPopupMessage("Error", "Document format not supported.");
        }

        //var base_url = BaseUrl;
        //var file_url = FileUrl;

        //var filePath1 = BaseUrl + _documents.FilePath;
        //string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        // documentContent = await File.ReadAllBytesAsync(response.FilePath);

        //string filePathpdf = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";

        //await JSRuntime.InvokeVoidAsync("pdfInterop.renderPDF", "pdfInterop", filePathpdf);




        //await Task.Delay(10);       
        //await JSRuntime.InvokeVoidAsync("displayOfficeDocument", OfficeContainerRef, filePath);


    }   

    void OnCustomizeToolbar(IToolbar toolbar)
    {
        //// Returns the first group
        //IBarGroup firstGroup = toolbar.Groups[0];
        //// Returns the Table group
        //IBarGroup tableGroup = toolbar.Groups[RichEditToolbarGroupNames.Table];

        toolbar.Groups.Clear();

        // Inserts the File group at the first position in the group collection
        //toolbar.Groups.Add(0, RichEditToolbarGroupNames.File);
        toolbar.Groups.Add(0, RichEditToolbarGroupNames.Undo);
        toolbar.Groups.Add(1, RichEditToolbarGroupNames.Font);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Table);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Picture);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Paragraph);

        IBarGroup undoRedoGroup = toolbar.Groups[0];
        undoRedoGroup.Items.Add(0, RichEditBarItemNames.FullScreen);

    }

    void OnContentRemoved(ContentRemovedEventArgs e)
    {
        // Handle the content removal event here
    }
    async Task OnSelectionChanged(Selection newSelection)
    {
        /* Surround the code that contains an asynchronous operation with a try-catch block to handle
        the OperationCanceledException. This exception is thrown when an asynchronous operation is canceled. */
        try
        {
            richSelection = newSelection;
            // Your code
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    async Task OnmsgContentChanged(byte[] content)
    {

        /* Surround the code that contains an asynchronous operation with a try-catch block to handle
        the OperationCanceledException. This exception is thrown when an asynchronous operation is canceled. */
        try
        {
            msgContent = content;

            //var createReq = new CreateEmailCoversation
            //    {

            //        TopicID = (long.Parse(@SelectedGroup)),
            //        Message = Data.Message != null ? Data.Message : "Attachments",
            //        FileData = content,
            //        ParticipantId = applicationUser.UserID,
            //        ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
            //        StatusCodeID = 1,
            //        AddedByUserID = applicationUser.UserID,
            //        AddedDate = DateTime.Now,
            //        SessionId = Guid.NewGuid()
            //    };
            //var result = await Mediator.Send(createReq);

            //if (result == 1)
            //{               
            //    await LoadData();
            //    onRestText();
            //    closeReply();
            //}
            //else
            //{

            //}




            //await File.WriteAllBytesAsync("C:\\Users\\Public\\annual-report.rtf", documentContent);
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    async Task OnDocumentContentChanged(byte[] content)
    {

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        // string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        string filePath = response.FilePath;
        //string filePath = response.ServerFilePath;
        var urlss = FileUrl + _documents.FilePath;
        string extension = Path.GetExtension(response.FilePath);


        try
        {
            if (extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
            {
                MyDocumentFormat = DocumentFormat.OpenXml;
                documentContent = content;
                await File.WriteAllBytesAsync(filePath, documentContent);
            }
            else if (extension.ToLower() == ".txt")
            {                
                MyDocumentFormat = DocumentFormat.PlainText;
                documentContent = content;                
                await File.WriteAllBytesAsync(filePath, documentContent);
            }
            else if(extension.ToLower() == ".pdf")
            {
                var url = FileUrl + _documents.FilePath;
                await OpenUrlInNewTab(url);
            }
            else
            {
                onShowPopupMessage("error", "Document format not supported.");
            }

            //documentContent = content;
            //await File.WriteAllBytesAsync(filePath, documentContent);           
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    private async Task OpenUrlInNewTab(string url)
    {
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }
    public async Task onDocDownload(long Id)
    {
        _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup))); 
        var lst =  _topicDocList?.FirstOrDefault(a => a.DocumentId == Id);



        //var url = FileUrl + lst.FilePath;
        //await OpenUrlInNewTab(url);
        //NavigationManager.NavigateTo(url, forceLoad: true);

        var request = new DownloadFileRequest
            {
                FileName = lst.FileName, 
                FilePath = lst.FilePath, 
                ContentType = lst.ContentType
            };

        var response = await Mediator.Send(request);

        //  Trigger file download
        await JSRuntime.InvokeVoidAsync("downloadFile", response.FileName, response.FileData, response.ContentType,"");
    }
    public async Task onDocDelete(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);
        DocPopupVisible = true;
    }
    private async void assignedList(long Id)
    {
        _conversationAssignTo = await Mediator.Send(new GetEmailConversationAssignTo(Id));
        if (_conversationAssignTo.Count > 0)
        {
            isAssignToVisible = true;
        }
        else
        {
            toastService.ShowToast("No data found", AC.SD.Core.Services.ToastLevel.Error);
            //isAssignToVisible = false;
        }
    }
    private async Task SubmitDocDelete(long Id)
    {
        if (Id > 0)
        {
            var request = new DeleteDoc(Id);

            var response = await Mediator.Send(request);
            DocPopupVisible = false;
            isAllPlistVisible = false;
            await loadTopicDocList();
            toastService.ShowToast("Document has been deleted successfully.", AC.SD.Core.Services.ToastLevel.Success);
            //onShowPopupMessage("success", "Document has been deleted successfully");
        }
    }

    private async void onShowPopupMessage(string headerText, string bodyText)
    {
        MessageVisible = true;
        MessageBody = bodyText;
        MessageHeader = headerText;
        loading = false;
        StateHasChanged();
    }
    async void ClosePopup()
    {
        PopupVisible = false;
        DocPopupVisible = false;
    }

    private void ToggleItemVisibility(int id)
    {
        if (itemVisibility.ContainsKey(id))
        {
            itemVisibility[id] = !itemVisibility[id];
        }
        else
        {
            itemVisibility.Add(id, true);
        }
    }
    private void ToggleDocItemVisibility(int id)
    {
        if (DocitemVisibility.ContainsKey(id))
        {
            DocitemVisibility[id] = !DocitemVisibility[id];
        }
        else
        {
            DocitemVisibility.Add(id, true);
        }
    }
    private List<string> data;

    private async Task loadSubTopicDocList()
    {
        var conId = SelectedReplyId;

        if (long.Parse(@SelectedGroup) > 0)
        {
            //await JSRuntime.InvokeAsync<string>("showLoading");
            _topicDocList = await Mediator.Send(new GetSubEmailTopicDocList(long.Parse(@SelectedReplyId)));
            //await JSRuntime.InvokeAsync<string>("hideLoading");


            if (_topicDocList.Count > 0)
            {
                _selectlst = _topicDocList.FirstOrDefault();
                //EditEnabled = true;
                //DeleteEnabled = true;
                PreviewEnabled = true;
                docEnabled = true;                
                StateHasChanged();
            }
            else
            {                
                PreviewEnabled = false;
                docEnabled = false;
            }
        }
    }
    private async Task loadTopicDocList()
    {
        if(long.Parse(@SelectedGroup) > 0)
        {
            //await JSRuntime.InvokeAsync<string>("showLoading");
            _topicDocList = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup)));          
            //await JSRuntime.InvokeAsync<string>("hideLoading");


            if (_topicDocList.Count > 0)
            {
                _selectlst = _topicDocList.FirstOrDefault();
                //EditEnabled = true;
                //DeleteEnabled = true;
                PreviewEnabled=true;
                docEnabled = true;                
                StateHasChanged();
            }
            else
            {                
                PreviewEnabled=false;
                docEnabled = false;
            }
        }

    }
    private async void onloadTagsList()
    {
        _headTopic_Tag = await Mediator.Send(new GetAllTopicCategory(long.Parse(@SelectedGroup)));
    }

    private async Task LoadData()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();

        RTopicId = 0;
        Tid = long.Parse(@SelectedGroup);
        var getconid = await Mediator.Send(new GetTopConversationList(Tid));
        // Cid = getconid[0].ID;
        Cid = 0;
        SelectedReplyId = getconid[0].ID.ToString();
        _discussionList = await Mediator.Send(new GetEmailDiscussionList(long.Parse(@SelectedGroup),applicationUser.UserID));
        _discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(long.Parse(@SelectedGroup)));

        _assigntoItems = await Mediator.Send(new GetEmailAssignToList(long.Parse(@SelectedGroup))); 
        var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
        _allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
        var topicToList = await Mediator.Send(new GetEmailTopicToList(long.Parse(@SelectedGroup)));

        var ck_validuser = await Mediator.Send(new GetEmailValidUserList(long.Parse(@SelectedGroup), applicationUser.UserID));
        IsValidUser = false;
        //if(ck_validuser.Count > 0)
        //{
        //    IsValidUser = true;
        //}
        //else
        //{
        //    IsValidUser = false;
        //}

        if (topicToList != null)
        {
            Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
        }

        // Data.AssigntoIds = _assigntoItems.Take(1);


        OnMenuItemClick(isMenuvisible);


        if (isMenuvisible == "AddParticipants")
        {

            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicPlist_Data();
            }
            else //sub topic click
            {
                await LoadPlist_Data();
            }            
        }

        // Generate index IDs for each row
        //var indexedDiscussionList = _discussionList.Select((item, index) => new
        //{
        //    IndexId = index + 1, // Adding 1 to make the index IDs start from 1
        //    Item = item
        //}).ToList();

        if(long.Parse(@SelectedGroup) != 0)
        {
            _headTopic = await Mediator.Send(new GetByIdEmailTopics(long.Parse(@SelectedGroup)));
            //_headTopic_Tag = await Mediator.Send(new GetByActivityEmailSession(_headTopic[0].SessionId.GetValueOrDefault()));
            _headTopic_Tag = await Mediator.Send(new GetAllTopicCategory(long.Parse(@SelectedGroup)));


            isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

            isEnabled = true;
            isEllipsis = true;
            isCommand = true;
            //_participant = await Mediator.Send(new GetEmailParticipantsList(long.Parse(@SelectedGroup)));


            IsConHistory = true;            
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");
        //var plist = await Mediator.Send(new GetAllEmployeeListQuery());
        // _participant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
    }
    private async Task LoadReplyData()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        IsValidUser = true;
        //var rTopicId =@RTopicId;
        Cid = long.Parse(@SelectedReplyId);
        Tid = RTopicId;
        _discussionList = await Mediator.Send(new GetEmailReplyDiscussionList(long.Parse(@SelectedReplyId), applicationUser.UserID));
        _discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(RTopicId));

        _assigntoItems = await Mediator.Send(new GetEmailAssignToList(RTopicId));        
        var topicToList = await Mediator.Send(new GetEmailTopicToList(RTopicId));
        if (topicToList != null)
        {
            Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
        }   

        OnMenuItemClick(isMenuvisible);


        if (isMenuvisible == "AddParticipants")
        {

            if (RTopicId == 0) //main topic click
            {
                await LoadMainTopicPlist_Data();
            }
            else //sub topic click
            {
                await LoadPlist_Data();
            }

        }

        var ConversationList = await Mediator.Send(new GetEmailConversationList(Cid));

        _headTopic = await Mediator.Send(new GetByIdEmailTopics(RTopicId));

        _headTopic[0].TopicName = ConversationList[0].Name;
        _headTopic[0].AddedDate = ConversationList[0].AddedDate;

        isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

        isEnabled = true;
        isEllipsis = true;
        isCommand = true;
        // _participant = await Mediator.Send(new GetEmailParticipantsList(RTopicId));


        IsConHistory = false;
        await JSRuntime.InvokeAsync<string>("hideLoading");

    }
    private async Task LoadDataPosts()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();
        if(@SelectedGroup != "none")
        {
            if (long.Parse(@SelectedGroup) > 0)
            {
                Tid = long.Parse(@SelectedGroup);
                var getconid = await Mediator.Send(new GetTopConversationList(Tid));
                //Cid = getconid[0].ID;
                Cid = 0;
                _discussionList = await Mediator.Send(new GetEmailDiscussionList(long.Parse(@SelectedGroup),applicationUser.UserID));
                _discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(long.Parse(@SelectedGroup)));

                _assigntoItems = await Mediator.Send(new GetEmailAssignToList(long.Parse(@SelectedGroup)));
                var topicToList = await Mediator.Send(new GetEmailTopicToList(long.Parse(@SelectedGroup)));
                if (topicToList != null)
                {
                    Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
                }


                isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

                isEnabled = true;
                isEllipsis = true;
                isCommand = true;
                //_participant = await Mediator.Send(new GetEmailParticipantsList(long.Parse(@SelectedGroup)));

            }

        }

        await JSRuntime.InvokeAsync<string>("hideLoading");

    }
    private async Task LoadReplyDataPosts()
    {        
        await JSRuntime.InvokeAsync<string>("showLoading");
        closeReply();
        Cid = long.Parse(@SelectedReplyId);
        Tid = RTopicId;
        _discussionList = await Mediator.Send(new GetEmailReplyDiscussionList(long.Parse(@SelectedReplyId), applicationUser.UserID));
        _discussionFullList = await Mediator.Send(new GetEmailFullDiscussionList(RTopicId));

        _assigntoItems = await Mediator.Send(new GetEmailAssignToList(RTopicId));
        var topicToList = await Mediator.Send(new GetEmailTopicToList(RTopicId));
        if (topicToList != null)
        {
            Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
        }


        isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

        isEnabled = true;
        isEllipsis = true;
        isCommand = true;
        //_participant = await Mediator.Send(new GetEmailParticipantsList(RTopicId));

        await JSRuntime.InvokeAsync<string>("hideLoading");

    }
    void OnSelectedDataItemsChanged(IReadOnlyList<object> selectedDataItems)
    {
        SelectedDataItems = selectedDataItems;
    }

    async Task OnEmailToRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ID");       
        SelectedGroup = UniqueId.ToString();
        await LoadData();
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        var sss = ActiveSessionId;
        cancellationTokenSource = new CancellationTokenSource();
        StartAutoRefresh();

        BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        FileUrl = Configuration["DocumentsUrl:FileUrl"];

        onloadSession();
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        AppUserId = applicationUser.UserID;
        await JSRuntime.InvokeAsync<string>("showLoading");

        filterrowname = "";
        if (ActiveSessionId != null)
        {
            var lsts = await Mediator.Send(new GetListBySession(ActiveSessionId));
            if(lsts.Count > 0)
            {
                SelectedGroup = lsts[0].ID.ToString();
                RTopicId = 0;
                filterrowname = ActiveSessionId;

                _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID));
                _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID));
                _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID));
                _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));

                await LoadData();

            }
            else
            {
                RTopicId = 0;
                SelectedGroup = "0";
                await LoadData();

                //if (long.Parse(@SelectedGroup) > 0)
                //{
                //    _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID));
                //    _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID));
                //    _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID));
                //    _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
                //}

            }

        }
        else
        {
            _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID));
            _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID));
            _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID));
            _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");
        //_discussionList = await Mediator.Send(new GetDiscussionList(38));


    }
    private async Task StartAutoRefresh()
    {
        //try
        //{
        //    while (true)
        //    {
        //        await Task.Delay(AutoRefreshInterval, cancellationTokenSource.Token);

        //        await RefreshGridData();
        //    }
        //}
        //catch (TaskCanceledException)
        //{
        //    // Task was canceled, no action needed
        //}
    }
    private async Task RefreshGridData()
    {
        // Perform the logic to refresh your grid data
        // For example, you can re-fetch the data from the server
        await LoadGridData();
        StateHasChanged();
    }
    private async Task LoadGridData()
    {
        _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID));
        _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID));
        _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID));
        _topics = await Mediator.Send(new GetUserEmailTopics(applicationUser.UserID));
    }
    public void Dispose()
    {
        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();
    }

    async Task onloadTwoGrid()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");

        await JSRuntime.InvokeAsync<string>("showLoading");
        _forumTopicTo = await Mediator.Send(new GetEmailTopicTo(applicationUser.UserID));
        _forumTopicCC = await Mediator.Send(new GetEmailTopicCC(applicationUser.UserID));
        _forumTopicSent = await Mediator.Send(new GetSentTopic(applicationUser.UserID));

        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    void onloadSession()
    {
        _sessionId = Guid.NewGuid();
    }
    void getConversation()
    {

    }
    private async Task onWindowVisible()
    {
        var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
        _allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
        Data.AssigntoIds = Enumerable.Empty<long>();
        WindowVisible = true;        
        Data.AssignccIds = null;
        string selector = ".dxwinheight";
        Data.From = applicationUser.UserName;
        ElementHeight = await JSRuntime.InvokeAsync<int>("getElementHeight", selector);


    }
    private async Task onreply(long id)
    {
        if (id > 0)
        {           
            _replyComment = _discussionList.Where(c => c.ID == id).ToList();


            //_allparticipant = await Mediator.Send(new GetAllConvAssToListQuery(_replyComment[0].ID));
            //_allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();

            var convlistTo = await Mediator.Send(new GetEmailConversationAssignTo(_replyComment[0].ID));
            var conto = convlistTo.Where(c => c.UserId != applicationUser.UserID).ToList();
            Data.AssigntoIds = conto.Select(s => s.UserId).ToList();

            List<long> updatedList = Data.AssigntoIds.ToList();
            long fromUserId = _replyComment[0].UserId.Value;

            if(fromUserId != applicationUser.UserID)
            {
                updatedList.Add(fromUserId);
            }

            Data.AssigntoIds = updatedList;


            var convlistCC = await Mediator.Send(new GetEmailConversationAssignCC(_replyComment[0].ID));
            var concc = convlistCC.Where(c => c.UserId != applicationUser.UserID).ToList();
            Data.AssignccIds = concc.Select(s => s.UserId).ToList();


            if(_headTopic[0].IsAllowParticipants.GetValueOrDefault(false))
            {
                var plist = await Mediator.Send(new GetAllEmployeeListQuery());  
                _allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
            }
            else
            {
                var gettid = await Mediator.Send(new GetEmailConversationList(_replyComment[0].ID));
                _allparticipant = await Mediator.Send(new GetByConvasationTopicIDPList(id,gettid[0].TopicID));           

            }



            WindowVisible = true;
            Data.Name = _replyComment[0].Name;
            Data.From = applicationUser.UserName;
            IsReadOnly = false;
        }        
    }  
    void EulaClosing(WindowClosingEventArgs args) {
        closeReply();
    }
    private async Task onunderreply(long id)
    {
        if (id > 0)
        {
            _replyComment = _discussionFullList.Where(c => c.ID == id).ToList();
            WindowVisible = true;
            Data.Name = _replyComment[0].Name;
            IsReadOnly = false;
        }
    }
    void closeReply()
    {
        _replyComment = null;
        Data.Name = null;
        IsReadOnly = true;
        WindowVisible = false;
    }
    async void OnLeftMenuItemClick(string text)
    {
        isLeftMenuvisible = text;
    }
    async Task OnMenuItemClick(string text)
    {
        isMenuvisible = text;

        if(text == "Posts")
        {
            isComponentVisible = true;
            isAddParticipant = false;
            isEllipsis = true;
            isCommand = true;
            //await LoadDataPosts();
            if (RTopicId == 0)
            {
                await LoadDataPosts();
            }
            else
            {
                await LoadReplyDataPosts();
            }
        }
        else if (text == "Files")
        {
            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;

            if (RTopicId == 0)
            {                
                await loadTopicDocList();
            }
            else
            {
                await loadSubTopicDocList();
            }            
        }
        else if (text == "AddParticipants")
        {
            isAddParticipant = true;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;  
        }
        else
        {
            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
        }
    }  
    async Task LoadPlist_Data()
    {
        if(Cid > 0)
        {
            await RefTopicAddPList.loadParticipentList(long.Parse(@SelectedReplyId));
        }        
    }
    async Task LoadMainTopicPlist_Data()
    {        
        await RefTopicAddPList.loadMainTopicParticipentList(long.Parse(@SelectedGroup));        
    }
    private async Task HandleValidSubmit()
    {
        loading = true;        
        //var contentdd = msgContent;
        //byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
        byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
        string htmlString = string.Empty;
        var len = fileContent.Length;
        //documentContent = null;            


        htmlString = Encoding.UTF8.GetString(fileContent);
        //if (fileContent != null)
        //{
        //    // Convert the RTF byte array to HTML string
        //    htmlString = Rtf.ToHtml(fileContent);
        //}

        if(fileContent.Length == 480)
        {
            toastService.ShowToast("Please Enter Messages", AC.SD.Core.Services.ToastLevel.Error);
            loading = false;
            return;
        }    

        if(Data.Name == null)
        {
            toastService.ShowToast("Please Enter Subject Name", AC.SD.Core.Services.ToastLevel.Error);
            loading = false;
            return;
        }

        if(Data.AssigntoIds.Count() == 0)
        {
            toastService.ShowToast("Please Select Assign To", AC.SD.Core.Services.ToastLevel.Error);
            loading = false;
            return;
        }

        string assignCCidsString = string.Join(",", _assigntoItems.Select(s => s.UserID).ToList());
        string assignccidsString = null;
        string assigntoidsString = string.Join(",", Data.AssigntoIds);
        if(Data.AssignccIds != null)
        {
            assignccidsString = string.Join(",", Data.AssignccIds);
        }


        List<long> concatList;

        if (Data.AssignccIds != null)
        {
            concatList = Data.AssigntoIds.Concat(Data.AssignccIds).ToList();
        }
        else
        {
            concatList = Data.AssigntoIds.ToList();
        }

        //List<long> concatList = Data.AssigntoIds.Concat(Data.AssignccIds).ToList();
        concatList.Add(applicationUser.UserID);
        concatList = concatList.Distinct().ToList();
        string participantidsString = string.Join(",", concatList);

        string plistUniqueItems = null;
        long ConIds = 0;

        var coId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0;
        if(coId > 0)
        {
            var plist = await Mediator.Send(new GetByConvasationPList(coId));
            List<long> plst = plist.Select(x => x.UserID.GetValueOrDefault()).ToList();
            List<long> uniqueItems = concatList.Except(plst).ToList();
            if(uniqueItems.Count > 0)
            {
                plistUniqueItems = string.Join(",", uniqueItems);
            }

            ConIds = _replyComment[0].ID;

        }
     
        var createReq = new CreateEmailCoversation
            {
                //TopicID = (long.Parse(@SelectedGroup)),
                TopicID = RTopicId == 0 ? (long.Parse(@SelectedGroup)) : RTopicId,
               // Message = Data.Message != null ? Data.Message : "Attachments",
                Message = htmlString,
                //FileData = Data.Message != null ? Encoding.UTF8.GetBytes(Data.Message) : Encoding.UTF8.GetBytes("Attachments"),
                FileData = fileContent,
                AssigntoIdss = Data.AssigntoIds.Count() == 0 ? assignCCidsString : assigntoidsString,
                AssignccIdss = assignccidsString,
                PlistIdss = participantidsString,
                AllowPlistids = plistUniqueItems,
                ConIds = ConIds,
                AllParticipantIds = _assigntoItems.Select(s => s.UserID).ToList(),
                ParticipantId = applicationUser.UserID,
                ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                Name = Data.Name,
                SessionId = _sessionId
            };
        var result = await Mediator.Send(createReq);

        if (result > 1)
        {
            //var getRec = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
            //sessionId = getRec.Last().SessionId;

            //uploadUrl = GetUploadUrl();           
            //uploadComponent.UploadAllFiles();

            uploadComponent.UploadAllFiles();

            if(RTopicId == 0)
            {
                await LoadData();
            }
            else
            {
                await LoadReplyData();
            }

            // await LoadData();
            
            onRestText();
            closeReply();
            onloadSession();
            // HandleScroll("down");
            await msgrichEdit.NewDocumentAsync();
            await onloadTwoGrid();

            if (RTopicId == 0)
            {
                await LoadDataPosts();
            }
            else
            {
                await LoadReplyDataPosts();
            }
           
            WindowVisible = false;
            loading = false;
        }
        else
        {

        }
    }
    private void onRestText()
    {
        Data.Message = null;
    }

    void HandleInvalidSubmit()
    {

    } 
    
   
}