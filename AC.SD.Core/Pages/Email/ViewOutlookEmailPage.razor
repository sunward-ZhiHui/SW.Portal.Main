@page "/ViewOutlookEmail"
@using System.Net.Http.Json
@using System.IO
@using Application.Queries
@using MediatR
@using global::Core.Entities
@inject HttpClient Http
@inject IMediator Mediator
@inject OutlookEmailService EmailService
@inject IJSRuntime JSRuntime;
@using global::Core.Repositories.Query
@inject ILocalStorageService<ApplicationUser> _localStorageService
@using System.ComponentModel.DataAnnotations;

<link href="_content/AC.SD.Core/css/forum-mail.css" rel="stylesheet" />
<style scoped>
    .demo-content .main > .content
    {
        margin-left: -10px !important;
        margin-right: -31px !important;
        margin-top: -17px;
    }

    .hand-cursor {
        cursor: pointer;
    }
</style>
<div>
    <div class="main-container">
        <div class="content-container row">
            <div class="col-md-12 d-flex justify-content-between align-items-center" style="background: #158cba; padding: 10px; color: white; z-index: 999;">
                <span>Outlook Email</span>
                <span class="hand-cursor" @onclick="@(() => Emaillogout())" style="color: white; text-decoration: none;">Logout</span>
            </div>
            <div class="mini-menu-bar col-md-3 @toggleButtonVisible"  style="overflow-x: hidden;">
                <div class="mini-menu-bar-top">
                    <div class="card w-100" style="margin-bottom:10px; margin-top:10px;">
                        <div class="card-body p-0">
                            <div class="views-accordion">
                                <OutlookInboxpage @ref=RefAssignAll ToView="onOutlookClick"></OutlookInboxpage>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-bar-content-container @hiddenButtonCssClass" style="height: calc(100vh - 138px); overflow: auto;">
                @if (selectedEmail != null)
                {
                    <div class="email-detail">
                        <button type="button" @onclick="@(() => ReplyToEmail(selectedEmail))" style="float: right;margin-top: 10px;" class="btn btn-primary">
                            <i class="fa fa-reply"></i> Reply
                        </button>
                        <p><strong>From:</strong> @selectedEmail.FromName</p>
                        <p><strong>Date:</strong> @selectedEmail.Date.ToString("g")</p>                        
                        <hr />
                        <p>@((MarkupString)selectedEmail.BodyHtml)</p>

                        @if (selectedEmail.Attachments?.Count > 0)
                        {
                            <div class="attachments">
                                <strong>Attachments:</strong>
                                <div class="uk-card-footer">
                                    @foreach (var attachment in selectedEmail.Attachments)
                                    {
                                        <div class="tag handline">
                                            <div class="">
                                                <a href="@attachment.DownloadUrl" target="_blank">@attachment.FileName</a>
                                            </div>                                            
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <div class="email-actions">                         
                            <button type="button" @onclick="@(() => ReplyToEmail(selectedEmail))" class="btn btn-primary">
                                <i class="fa fa-reply"></i> Reply
                            </button>
                            @* <button @onclick="() => DeleteEmail(selectedEmail)" class="btn btn-danger">Delete</button> *@
                        </div>

                        <!-- Reply Section -->
                        @if (selectedEmail.IsReplying)
                        {
                            <div class="reply-section card mt-3 p-3">
                                <h5>Reply</h5>
                                <label>To:</label>
                                <input type="text" @bind="selectedEmail.ReplyTo" class="form-control" />

                                <label>Cc:</label>
                                <input type="text" @bind="selectedEmail.ReplyCc" class="form-control" />

                                <label>Bcc:</label>
                                <input type="text" @bind="selectedEmail.ReplyBcc" class="form-control" />

                                <label>Message:</label>
                                @*  <textarea @bind="selectedEmail.ReplyText" class="form-control" rows="3"></textarea> *@

                                <DxHtmlEditor @bind-Markup="@selectedEmail.ReplyText" Height="calc(100vh - 690px)">
                                </DxHtmlEditor>

                                <label>Attachments:</label>
                                <InputFile OnChange="HandleAttachmentUpload" multiple class="form-control" />


                                <!-- Display uploaded attachments -->
                                <div class="mt-2">
                                    <ul>
                                        @foreach (var file in selectedEmail.ReplyAttachments)
                                        {
                                            <li>@file.Name</li>
                                        }
                                    </ul>
                                </div>

                                <button @onclick="() => SendReply(selectedEmail)" class="btn btn-success mt-2">Send</button>
                                <button @onclick="() => selectedEmail.IsReplying = false" class="btn mt-2">Cancel</button>
                            </div>
                        }

                        @if (selectedEmail.Replies?.Count > 0)
                        {
                            @* <div class="replies">
                                <h5>Reply History:</h5>
                                <ul>
                                    @foreach (var reply in selectedEmail.Replies)
                                    {
                                        <li>
                                            <strong>@reply.Date.ToString("g") from @reply.From:</strong>
                                            <p>@reply.Body</p>
                                        </li>
                                    }
                                </ul>
                            </div> *@


                            <div class="replies mt-4">
                                <h5><i class="fa fa-comments"></i> Reply History</h5>
                                <div class="reply-list">
                                    @foreach (var reply in selectedEmail.Replies)
                                    {
                                        <div class="reply-item p-2 mb-3 border rounded"
                                        style="background-color: @(reply.From == selectedEmail.FromName ? "#e0f7fa" : "#f1f1f1");">
                                            <small class="text-muted">@reply.Date.ToString("g") from <strong>@reply.From</strong></small>

                                            <p class="mt-1">@((MarkupString)reply.BodyHtml)</p>


                                            <!-- Trimmed Reply Body -->
                                            @*  @if (reply.BodyHtml.Length > 200)
                                            {
                                                <p>@(expandedReplies.Contains(reply) ? reply.Body : reply.Body.Substring(0, 200) + "...")</p>
                                                <button @onclick="@(() => ToggleReply(reply))" class="btn btn-link">
                                                    @(expandedReplies.Contains(reply) ? "Read Less" : "Read More")
                                                </button>
                                            }
                                            else
                                            {
                                                <p class="mt-1">@((MarkupString)reply.BodyHtml)</p>
                                            }  *@



                                            <!-- Attachments for the Reply -->
                                            @if (reply.Attachments?.Count > 0)
                                            {
                                                <div class="reply-attachments mt-2">
                                                    <strong><i class="fa fa-paperclip"></i> Attachments:</strong>
                                                    <ul class="list-unstyled">
                                                        @foreach (var attachment in reply.Attachments)
                                                        {
                                                            <li>
                                                                <a href="@attachment.DownloadUrl" target="_blank">@attachment.FileName</a>
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>




                        }


                    </div>
                }

            </div>

        </div>
    </div>
</div>

@* <DxWindow @bind-Visible=WindowVisible 
HeaderText="Post"
HorizontalAlignment="HorizontalAlignment.Right"
VerticalAlignment="DevExpress.Blazor.VerticalAlignment.Bottom"
CloseOnEscape="true"                                      
ResizeCompleted="OnWindowResizeCompleted"
DragCompleted="OnWindowDragCompleted"                                          
ShowFooter=false
AllowResize="true"
Closing="EulaClosing"
Width="max(75vw, 250px)"                                                                       
Height="800"
ShowCloseButton="true"                                                
@ref="dxWindow">
    <BodyTemplate Context="Context">
        <div class="dxwinheight" style="padding: 20px; overflow: auto;">
            <DxFormLayout>
                <div class="open-button-old" style="width:99.5%">  
                    <div class="boxreplay">
                        <EditForm Model="@Data" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                            <DxFormLayout>
                                <DxFormLayoutItem Caption="To:" ColSpanMd="12">
                                    <DxTextBox @bind-Text="@Data.ReplyTo" ShowValidationIcon="true" spellcheck="true" NullText="To"  />
                                    <ValidationMessage For="@(() => Data.ReplyTo)" />
                                </DxFormLayoutItem>
                                <DxFormLayoutItem ColSpanMd="12">
                                    <div class="">
                                        <DxRichEdit DocumentLoaded="OnDocumentLoaded" CheckSpelling="true" @ref="msgrichEdit" CustomizeToolbar=OnCustomizeToolbar BarMode="BarMode.Toolbar" CssClass="w-100 h-100 txtEditorMsg editor-box-height" Id="editor-box-height" ViewType="ViewType.Simple" />
                                    </div>
                                </DxFormLayoutItem>
                            </DxFormLayout>
                        </EditForm>
                    </div>
                </div>
            </DxFormLayout>
        </div>
    </BodyTemplate>
    <FooterTextTemplate>
        <DxButton SubmitFormOnClick="true" Text="Post" CssClass="" RenderStyle="ButtonRenderStyle.Primary" />
        <DxButton RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxWindow>
 *@

<DxPopup @bind-Visible="@IsPopupVisible" ShowCloseButton="true" Width="350px" Height="250px" HeaderText="Outlook Login Details">


    <EditForm Model="@loginModel" OnValidSubmit="@OnValidSubmit" class="w-800">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-md-12" style="padding-bottom: 12px">
                <label>Email Id</label>
                <DxTextBox @bind-Text="@loginModel.UserLoginID" NullText="Email Id" />
                <ValidationMessage For="@(() => loginModel.UserLoginID)" />

                <label>Password</label>
                <DxTextBox @bind-Text="@loginModel.UserPassword" NullText="password" />
                <ValidationMessage For="@(() => loginModel.UserPassword)" />
            </div>
            @if (!string.IsNullOrEmpty(message))
            {
                <div class="col-md-12">
                    <span style="color:red; font-weight: bold;">@message</span>
                </div>
            }
            <div class="col-md-12">
                <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
            </div>
        </div>
    </EditForm>
</DxPopup>


@code{

    private bool IsPopupVisible { get; set; } = false;
    private bool loading = false;
    private LoginModel loginModel = new();
    private string message = "";

    public class LoginModel
    {
        [Required(ErrorMessage = "UserId is required")]
        public string UserLoginID { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        public string UserPassword { get; set; } = string.Empty;
    }
    private void Emaillogout()
    {     
        selectedEmail = null;
        StateHasChanged();
        RefAssignAll?.OnLogoutTrigger();
    }

    private async Task OnValidSubmit()
    {
        loading = true;
         message = ""; 
        StateHasChanged(); 
        await JSRuntime.InvokeAsync<string>("showLoading");       
        var checkLogin = await EmailService.LoginAuthentication(loginModel.UserLoginID, loginModel.UserPassword);
        if(checkLogin)
        {


            var UpdateReq = new UpdateOutlookLoginQuery
                {
                    UserID = applicationUser.UserID,
                    OutlookEmailID = loginModel.UserLoginID,
                    OutlookPassword = loginModel.UserPassword,                    
                    ColumnsToUpdate = new List<string> { "OutlookEmailID", "OutlookPassword"}
                };
            var result = await Mediator.Send(UpdateReq);

            IsPopupVisible = false;
        }
        else
        {
            loading = false;
            message = "Login Failed. Please check your email and password.";
        }

        await JSRuntime.InvokeAsync<string>("hideLoading");     
        StateHasChanged();
    }





    private bool showFullEmail = false;
    public ApplicationUser? applicationUser { get; private set; }
    private HashSet<EmailReply> expandedReplies = new HashSet<EmailReply>();

    EmailModel? Data { get; set; } = new EmailModel();
    private string toggleButtonVisible = "ActiveToggle";
    private string hiddenButtonCssClass = "col-md-9";
    private OutlookInboxpage? RefAssignAll { get; set; }
    private EmailModel? selectedEmail { get; set; }
    bool WindowVisible { get; set; } = false;
    public string MyHeight { get; set; } = "200px";
    string width = "600px", height = "600px";
    DxWindow? dxWindow;
    DxRichEdit? msgrichEdit { get; set; }
    async Task OnDocumentLoaded(DevExpress.Blazor.RichEdit.Document document)
    {
        await document.ChangeDefaultCharacterPropertiesAsync(properties =>
        {
            // properties.FontName = "Times New Roman";
            properties.FontSize = 12;
        });
    }
    void OnCustomizeToolbar(IToolbar toolbar)
    {
        //// Returns the first group
        //IBarGroup firstGroup = toolbar.Groups[0];
        //// Returns the Table group
        //IBarGroup tableGroup = toolbar.Groups[RichEditToolbarGroupNames.Table];

        toolbar.Groups.Clear();

        // Inserts the File group at the first position in the group collection
        //toolbar.Groups.Add(0, RichEditToolbarGroupNames.File);
        toolbar.Groups.Add(0, RichEditToolbarGroupNames.Undo);
        toolbar.Groups.Add(1, RichEditToolbarGroupNames.Font);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Paragraph);
        toolbar.Groups.Add(3, RichEditToolbarGroupNames.Picture);
        toolbar.Groups.Add(4, RichEditToolbarGroupNames.Table);

        IBarGroup clipboardGroup = toolbar.Groups[1];
        clipboardGroup.Items.Add(5, RichEditBarItemNames.FontUnderline);
        clipboardGroup.Items.Add(6, RichEditBarItemNames.HighlightText);
        clipboardGroup.Items.Add(7, RichEditBarItemNames.ClipboardMenu);
        clipboardGroup.Items.Add(8, RichEditBarItemNames.ClearFormatting);
        clipboardGroup.Items.Add(9, RichEditBarItemNames.FontStrikeout);
        clipboardGroup.Items.Add(10, RichEditBarItemNames.FontScriptMenu);


        IBarGroup replace = toolbar.Groups[4];
        replace.Items.Add(1, RichEditBarItemNames.ChangeCaseMenu);
        replace.Items.Add(2, RichEditBarItemNames.Replace);


        IBarGroup undoRedoGroup = toolbar.Groups[0];
        undoRedoGroup.Items.Add(0, RichEditBarItemNames.FullScreen);

    }
    private async Task OnWindowResizeCompleted(WindowResizeCompletedEventArgs args)
    {

        (width) = ($"{args.Size.Width}px");
        MyHeight = $"{args.Size.Height}px";
        string setHeight = $"{args.Size.Height - 320}";
        string selector = ".editor-box-height";
        //IsUserGroupCCOpen = false;
        //IsUserGroupToOpen = false;

        //await JSRuntime.InvokeVoidAsync("adjustHeight", setHeight);
        await JSRuntime.InvokeVoidAsync("setHeight", selector, setHeight);
    }
    private void OnWindowDragCompleted()
    {

        //IsUserGroupCCOpen = false;
        //IsUserGroupToOpen = false;
    }
    void EulaClosing(WindowClosingEventArgs args)
    {
        //closeReply();
    }
    private async Task onOutlookClick(EmailModel emailViewModel)
    { 
        await JSRuntime.InvokeAsync<string>("showLoading");
        //selectedEmail = emailViewModel;
        //selectedEmail.ReplyTo = emailViewModel.From;


        //var repliess = await EmailService.ReceiveEmailsReplyAsync(emailViewModel.MessageId);
        //selectedEmail = repliess;

        var receivedEmails = await EmailService.ReceiveEmailsAsync(applicationUser.UserID);

        selectedEmail = receivedEmails
       .Where(e => e.MessageId == emailViewModel.MessageId)
       .FirstOrDefault();

        selectedEmail.ReplyTo = emailViewModel.From;

        //await LoadReplyEmail(emailViewModel);

        
        await JSRuntime.InvokeAsync<string>("hideLoading");
        StateHasChanged();
    }
    private async Task onreply(EmailModel emailModel)
    {
        WindowVisible = true;        
    }
    private async Task LoadReplyEmail(EmailModel email)
    {
        var lst = await EmailService.LoadEmailRepliesAsync(email.MessageId);

    }
    private async Task SendReply25(EmailModel email)
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        if (!string.IsNullOrWhiteSpace(email.ReplyText))
        {
            // Convert IBrowserFile to a List of AttachmentData
            var attachmentDataList = new List<AttachmentData>();
            foreach (var file in email.ReplyAttachments)
            {
                using var stream = file.OpenReadStream();
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);

                attachmentDataList.Add(new AttachmentData
                    {
                        FileName = file.Name,
                        Content = memoryStream.ToArray(),
                        ContentType = file.ContentType
                    });
            }

            await EmailService.SendReplyAsync(
                email.ReplyTo, email.ReplyCc, email.ReplyBcc,email.ToName,
                email.Subject, email.ReplyText, email.MessageId, attachmentDataList
            );

            email.Replies.Add(new EmailReply
                {
                    From = "You",
                    Date = DateTime.Now,
                    Body = email.ReplyText
                });

            email.ReplyText = "";
            email.ReplyTo = "";
            email.ReplyCc = "";
            email.ReplyBcc = "";
            email.ReplyAttachments.Clear();
            email.IsReplying = false;
        }

       await loadData(email);

        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    private async Task SendReply(EmailModel email)
    {
        await JSRuntime.InvokeAsync<string>("showLoading");

        if (!string.IsNullOrWhiteSpace(email.ReplyText))
        {
            // Convert IBrowserFile to a List of AttachmentData
            var attachmentDataList = new List<AttachmentData>();
            foreach (var file in email.ReplyAttachments)
            {
                using var stream = file.OpenReadStream();
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);

                attachmentDataList.Add(new AttachmentData
                    {
                        FileName = file.Name,
                        Content = memoryStream.ToArray(),
                        ContentType = file.ContentType
                    });
            }

            await EmailService.SendReplyAsync(
                email.ReplyTo, email.ReplyCc, email.ReplyBcc, email.ToName,
                email.Subject, email.ReplyText, email.MessageId, attachmentDataList
            );

            email.Replies.Add(new EmailReply
                {
                    From = "You",
                    Date = DateTime.Now,
                    Body = email.ReplyText
                });

            // Reset input fields after sending email
            email.ReplyText = "";
            email.ReplyTo = "";
            email.ReplyCc = "";
            email.ReplyBcc = "";
            email.ReplyAttachments.Clear();
            email.IsReplying = false;
        }

        await loadData(email);
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
   
    private async Task loadData(EmailModel email)
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        var receivedEmails = await EmailService.ReceiveEmailsAsync(applicationUser.UserID);

        selectedEmail = receivedEmails
       .Where(e => e.MessageId == email.MessageId)
       .FirstOrDefault();

        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
  
    private void ReplyToEmail(EmailModel email)
    {
        //WindowVisible = true;
        email.IsReplying = !email.IsReplying;
    }
    private async Task DeleteEmail(EmailModel email)
    {
        await EmailService.DeleteEmailAsync(email.MessageId);
        //emails.Remove(email);
    }
    private async Task HandleValidSubmit()
    {
    }
    void HandleInvalidSubmit()
    {

    }
    private List<IBrowserFile> uploadedFiles = new();

    private void HandleAttachmentUpload(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            selectedEmail.ReplyAttachments.Add(file);
        }
    }
    private const long MaxFileSize = 5 * 1024 * 1024; // 5MB
    private string fileUploadError = "";

    

    private void ToggleFullEmail()
    {
        showFullEmail = !showFullEmail;
    }

    private void ToggleReply(EmailReply reply)
    {
        if (expandedReplies.Contains(reply))
        {
            expandedReplies.Remove(reply);
        }
        else
        {
            expandedReplies.Add(reply);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        IsPopupVisible = false;
       
        //await JSRuntime.InvokeAsync<string>("showLoading");
        
       
        
        //await JSRuntime.InvokeAsync<string>("hideLoading");
    }
}
