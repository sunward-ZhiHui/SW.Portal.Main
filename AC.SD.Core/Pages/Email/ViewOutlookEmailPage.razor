@page "/ViewOutlookEmail"
@using System.Net.Http.Json
@using System.IO
@using global::Core.Entities
@inject HttpClient Http
@inject OutlookEmailService EmailService
@inject IJSRuntime JSRuntime;
<link href="_content/AC.SD.Core/css/forum-mail.css" rel="stylesheet" />

<div>
    <div class="main-container">
        <div class="content-container row">
            <div class="mini-menu-bar col-md-3 @toggleButtonVisible"  style="overflow-x: hidden;">
                <div class="mini-menu-bar-top">
                    <div class="card w-100" style="margin-bottom:10px; margin-top:10px;">
                        <div class="card-body p-0">
                            <div class="views-accordion">
                                <OutlookInboxpage @ref=RefAssignAll ToView="onOutlookClick"></OutlookInboxpage>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-bar-content-container @hiddenButtonCssClass" style="height: calc(100vh - 138px); overflow: auto;">
                @if (selectedEmail != null)
                {
                    <div class="email-detail">
                        <button type="button" @onclick="@(() => ReplyToEmail(selectedEmail))" style="float: right;margin-top: 10px;" class="btn btn-primary">
                            <i class="fa fa-reply"></i> Reply
                        </button>
                        <p><strong>From:</strong> @selectedEmail.FromName</p>
                        <p><strong>Date:</strong> @selectedEmail.Date.ToString("g")</p>                        
                        <hr />
                        <p>@((MarkupString)selectedEmail.BodyHtml)</p>

                        @if (selectedEmail.Attachments?.Count > 0)
                        {
                            <div class="attachments">
                                <strong>Attachments:</strong>
                                <div class="uk-card-footer">
                                    @foreach (var attachment in selectedEmail.Attachments)
                                    {
                                        <div class="tag handline">
                                            <div class="">
                                                <a href="@attachment.DownloadUrl" target="_blank">@attachment.FileName</a>
                                            </div>                                            
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <div class="email-actions">
                            <button @onclick="() => ReplyToEmail(selectedEmail)" class="btn btn-primary">Reply</button>                            
                            <button @onclick="() => DeleteEmail(selectedEmail)" class="btn btn-danger">Delete</button>
                        </div>

                        @if (selectedEmail.Replies?.Count > 0)
                        {
                            @* <div class="replies">
                                <h5>Reply History:</h5>
                                <ul>
                                    @foreach (var reply in selectedEmail.Replies)
                                    {
                                        <li>
                                            <strong>@reply.Date.ToString("g") from @reply.From:</strong>
                                            <p>@reply.Body</p>
                                        </li>
                                    }
                                </ul>
                            </div> *@


                         @*    <div class="replies mt-4">
                                <h5><i class="fa fa-comments"></i> Reply History</h5>
                                <div class="reply-list">
                                    @foreach (var reply in selectedEmail.Replies)
                                    {
                                        <div class="reply-item p-2 mb-3 border rounded"
                                             style="background-color: @(reply.From == selectedEmail.FromName ? "#e0f7fa" : "#f1f1f1");">
                                            <small class="text-muted">@reply.Date.ToString("g") from <strong>@reply.From</strong></small>
                                            
                                            <p class="mt-1">@((MarkupString)reply.BodyHtml)</p>


                                            <!-- Trimmed Reply Body -->
                                           @*  @if (reply.BodyHtml.Length > 200)
                                            {
                                                <p>@(expandedReplies.Contains(reply) ? reply.Body : reply.Body.Substring(0, 200) + "...")</p>
                                                <button @onclick="@(() => ToggleReply(reply))" class="btn btn-link">
                                                    @(expandedReplies.Contains(reply) ? "Read Less" : "Read More")
                                                </button>
                                            }
                                            else
                                            {
                                                <p class="mt-1">@((MarkupString)reply.BodyHtml)</p>
                                            } 
                                          


                                            <!-- Attachments for the Reply -->
                                            @if (reply.Attachments?.Count > 0)
                                            {
                                                <div class="reply-attachments mt-2">
                                                    <strong><i class="fa fa-paperclip"></i> Attachments:</strong>
                                                    <ul class="list-unstyled">
                                                        @foreach (var attachment in reply.Attachments)
                                                        {
                                                            <li>
                                                                <a href="@attachment.DownloadUrl" target="_blank">@attachment.FileName</a>
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
 *@



                        }

                        <!-- Reply Section -->
                        @if (selectedEmail.IsReplying)
                        {
                            <div class="reply-section card mt-3 p-3">
                                <h5>Reply</h5>
                                <label>To:</label>
                                <input type="text" @bind="selectedEmail.ReplyTo" class="form-control" />

                                <label>Cc:</label>
                                <input type="text" @bind="selectedEmail.ReplyCc" class="form-control" />

                                <label>Bcc:</label>
                                <input type="text" @bind="selectedEmail.ReplyBcc" class="form-control" />

                                <label>Message:</label>
                                <textarea @bind="selectedEmail.ReplyText" class="form-control" rows="3"></textarea>

                              @*   <label>Attachments:</label>
                                <InputFile OnChange="HandleAttachmentUpload" multiple class="form-control" />


                                <!-- Display uploaded attachments -->
                                <div class="mt-2">
                                    <ul>
                                        @foreach (var file in selectedEmail.ReplyAttachments)
                                        {
                                            <li>@file.Name</li>
                                        }
                                    </ul>
                                </div> *@

                                <button @onclick="() => SendReply(selectedEmail)" class="btn btn-success mt-2">Send</button>
                                <button @onclick="() => selectedEmail.IsReplying = false" class="btn mt-2">Cancel</button>
                            </div>
                        }
                    </div>
                }

            </div>

        </div>
    </div>
</div>

<DxWindow @bind-Visible=WindowVisible 
    HeaderText="Post"
    HorizontalAlignment="HorizontalAlignment.Right"
    VerticalAlignment="DevExpress.Blazor.VerticalAlignment.Bottom"
    CloseOnEscape="true"                                      
    ResizeCompleted="OnWindowResizeCompleted"
    DragCompleted="OnWindowDragCompleted"                                          
    ShowFooter=false
    AllowResize="true"
    Closing="EulaClosing"
    Width="max(75vw, 250px)"                                                                       
    Height="800"
    ShowCloseButton="true"                                                
    @ref="dxWindow">
     <BodyTemplate Context="Context">
          <div class="dxwinheight" style="padding: 20px; overflow: auto;">
            <DxFormLayout>
                <div class="open-button-old" style="width:99.5%">  
                    <div class="boxreplay">
                        <EditForm Model="@Data" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                         <DxFormLayout>
                                <DxFormLayoutItem Caption="To:" ColSpanMd="12">
                                    <DxTextBox @bind-Text="@Data.ReplyTo" ShowValidationIcon="true" spellcheck="true" NullText="To"  />
                                    <ValidationMessage For="@(() => Data.ReplyTo)" />
                                </DxFormLayoutItem>
                                <DxFormLayoutItem ColSpanMd="12">
                                    <div class="">
                                        <DxRichEdit DocumentLoaded="OnDocumentLoaded" CheckSpelling="true" @ref="msgrichEdit" CustomizeToolbar=OnCustomizeToolbar BarMode="BarMode.Toolbar" CssClass="w-100 h-100 txtEditorMsg editor-box-height" Id="editor-box-height" ViewType="ViewType.Simple" />
                                    </div>
                                </DxFormLayoutItem>
                         </DxFormLayout>
                        </EditForm>
                    </div>
                </div>
            </DxFormLayout>
        </div>
    </BodyTemplate>
    <FooterTextTemplate>
        <DxButton SubmitFormOnClick="true" Text="Post" CssClass="" RenderStyle="ButtonRenderStyle.Primary" />
        <DxButton RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@context.CloseCallback" />
    </FooterTextTemplate>
</DxWindow>

@code{
     private bool showFullEmail = false;
    private HashSet<EmailReply> expandedReplies = new HashSet<EmailReply>();

    EmailModel? Data { get; set; } = new EmailModel();
    private string toggleButtonVisible = "ActiveToggle";
    private string hiddenButtonCssClass = "col-md-9";
    private OutlookInboxpage? RefAssignAll { get; set; }
    private EmailModel? selectedEmail { get; set; }
    bool WindowVisible { get; set; } = false;
    public string MyHeight { get; set; } = "200px";
    string width = "600px", height = "600px";
    DxWindow? dxWindow;
    DxRichEdit? msgrichEdit { get; set; }
    async Task OnDocumentLoaded(DevExpress.Blazor.RichEdit.Document document)
    {
        await document.ChangeDefaultCharacterPropertiesAsync(properties =>
        {
            // properties.FontName = "Times New Roman";
            properties.FontSize = 12;
        });
    }
    void OnCustomizeToolbar(IToolbar toolbar)
    {
        //// Returns the first group
        //IBarGroup firstGroup = toolbar.Groups[0];
        //// Returns the Table group
        //IBarGroup tableGroup = toolbar.Groups[RichEditToolbarGroupNames.Table];

        toolbar.Groups.Clear();

        // Inserts the File group at the first position in the group collection
        //toolbar.Groups.Add(0, RichEditToolbarGroupNames.File);
        toolbar.Groups.Add(0, RichEditToolbarGroupNames.Undo);
        toolbar.Groups.Add(1, RichEditToolbarGroupNames.Font);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Paragraph);
        toolbar.Groups.Add(3, RichEditToolbarGroupNames.Picture);
        toolbar.Groups.Add(4, RichEditToolbarGroupNames.Table);

        IBarGroup clipboardGroup = toolbar.Groups[1];
        clipboardGroup.Items.Add(5, RichEditBarItemNames.FontUnderline);
        clipboardGroup.Items.Add(6, RichEditBarItemNames.HighlightText);
        clipboardGroup.Items.Add(7, RichEditBarItemNames.ClipboardMenu);
        clipboardGroup.Items.Add(8, RichEditBarItemNames.ClearFormatting);
        clipboardGroup.Items.Add(9, RichEditBarItemNames.FontStrikeout);
        clipboardGroup.Items.Add(10, RichEditBarItemNames.FontScriptMenu);


        IBarGroup replace = toolbar.Groups[4];
        replace.Items.Add(1, RichEditBarItemNames.ChangeCaseMenu);
        replace.Items.Add(2, RichEditBarItemNames.Replace);


        IBarGroup undoRedoGroup = toolbar.Groups[0];
        undoRedoGroup.Items.Add(0, RichEditBarItemNames.FullScreen);

    }
    private async Task OnWindowResizeCompleted(WindowResizeCompletedEventArgs args)
    {
        
        (width) = ($"{args.Size.Width}px");
        MyHeight = $"{args.Size.Height}px";
        string setHeight = $"{args.Size.Height - 320}";
        string selector = ".editor-box-height";
        //IsUserGroupCCOpen = false;
        //IsUserGroupToOpen = false;

        //await JSRuntime.InvokeVoidAsync("adjustHeight", setHeight);
        await JSRuntime.InvokeVoidAsync("setHeight", selector, setHeight);
    }
    private void OnWindowDragCompleted()
    {
       
        //IsUserGroupCCOpen = false;
        //IsUserGroupToOpen = false;
    }
    void EulaClosing(WindowClosingEventArgs args)
    {
        //closeReply();
    }
    private async Task onOutlookClick(EmailModel emailViewModel)
    {
        selectedEmail = emailViewModel;

        //var emailId = "demoinfotech001@gmail.com";
        //var replies = await EmailService.LoadEmailRepliesAsync(emailId);
        //var repliess = await EmailService.LoadEmailRepliesAsync(emailViewModel.MessageId);
        //await LoadReplyEmail(emailViewModel);
        StateHasChanged();
    }
    private async Task onreply(EmailModel emailModel)
    {
        WindowVisible = true;        
    }
    private async Task LoadReplyEmail(EmailModel email)
    {
        var lst = await EmailService.LoadEmailRepliesAsync(email.MessageId);
        
    }
    private async Task SendReply(EmailModel email)
    {
        if (!string.IsNullOrWhiteSpace(email.ReplyText))
        {
            // Convert IBrowserFile to a List of AttachmentData
            var attachmentDataList = new List<AttachmentData>();
            foreach (var file in email.ReplyAttachments)
            {
                using var stream = file.OpenReadStream();
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);

                attachmentDataList.Add(new AttachmentData
                    {
                        FileName = file.Name,
                        Content = memoryStream.ToArray(),
                        ContentType = file.ContentType
                    });
            }

            await EmailService.SendReplyAsync(
                email.ReplyTo, email.ReplyCc, email.ReplyBcc,
                email.Subject, email.ReplyText, email.MessageId, attachmentDataList
            );

            email.Replies.Add(new EmailReply
                {
                    From = "You",
                    Date = DateTime.Now,
                    Body = email.ReplyText
                });

            email.ReplyText = "";
            email.ReplyTo = "";
            email.ReplyCc = "";
            email.ReplyBcc = "";
            email.ReplyAttachments.Clear();
            email.IsReplying = false;
        }
    }


    private void ReplyToEmail(EmailModel email)
    {
        //WindowVisible = true;
        email.IsReplying = !email.IsReplying;
    }
    private async Task DeleteEmail(EmailModel email)
    {
        await EmailService.DeleteEmailAsync(email.MessageId);
        //emails.Remove(email);
    }
    private async Task HandleValidSubmit()
    {
    }
    void HandleInvalidSubmit()
    {

    }
    private List<IBrowserFile> uploadedFiles = new();

    private void HandleAttachmentUpload(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            selectedEmail.ReplyAttachments.Add(file);
        }
    }
    private void ToggleFullEmail()
    {
        showFullEmail = !showFullEmail;
    }

    private void ToggleReply(EmailReply reply)
    {
        if (expandedReplies.Contains(reply))
        {
            expandedReplies.Remove(reply);
        }
        else
        {
            expandedReplies.Add(reply);
        }
    }
}
