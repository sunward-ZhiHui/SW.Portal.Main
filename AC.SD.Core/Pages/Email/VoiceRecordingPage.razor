@using System.IO
@using global::Core.Entities
@using global::Core.Repositories.Query
@inject IJSRuntime JSRuntime;
@inject NavigationManager NavigationManager
@inject ILocalStorageService<ApplicationUser> _localStorageService

<div @onclick="() => ToggleRecording()" class="fa fa-microphone handline" CssClass="record-button"></div>
@if (IsRecording)
{
    <p>Recording... Press the button again to stop.</p>
}

@if (Recordings.Any())
{
    <ul>
        @foreach (var recording in Recordings)
        {
            <li style="list-style: none;">
                <audio controls>
                    <source src="@GetAudioUrl(recording)" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
                <div class="fa fa-trash handline" @onclick="() => DeleteRecording(recording.Id)" style="margin-top: 15px; float: right; margin-left: 15px;" CssClass="delete-button"></div>     
            </li>
        }
    </ul>

    @*  <DxButton Text="Send All" Click="@SendAllRecordings" CssClass="send-all-button" /> *@
}


@code {
    [Parameter]
    public EventCallback<string> OnRecordingCompleted { get; set; }

    private bool IsRecording { get; set; }
    private string ButtonText => IsRecording ? "Stop Recording" : "Start Recording";
    private List<Recording> Recordings { get; set; } = new();
    private HttpClient _httpClient = new HttpClient();
    private string? BaseUrl;
    public ApplicationUser? applicationUser { get; private set; }
    protected override async void OnInitialized()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        BaseUrl = NavigationManager.BaseUri;
    }

   
    private string GetAudioUrl(Recording recording)
    {
        if (recording.FileData == null || recording.FileData.Length == 0)
            return "";

        var base64 = Convert.ToBase64String(recording.FileData);
        return $"data:audio/wav;base64,{base64}";
    }
    private async Task ToggleRecording()
    {
        if (IsRecording)
        {
            await StopRecording();
        }
        else
        {
            await StartRecording();
        }
    }

    private async Task StartRecording()
    {
        IsRecording = true;
        await JSRuntime.InvokeVoidAsync("startVoiceRecording");
    }

    private async Task StopRecording()
    {
        IsRecording = false;

        var recordingUrl = await JSRuntime.InvokeAsync<string>("stopVoiceRecording");

        if (string.IsNullOrEmpty(recordingUrl))
        {
            //toastService.ShowError("Failed to fetch recording.");
            return;
        }

        try
        {
            var fileStreamRef = await JSRuntime.InvokeAsync<IJSStreamReference>("fetchFile", recordingUrl);
            var fileName = $"recording_{Guid.NewGuid()}.wav";

            using var stream = await fileStreamRef.OpenReadStreamAsync();
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);

            var recording = new Recording
                {
                    Id = Guid.NewGuid(),
                    FileName = fileName,
                    FileData = memoryStream.ToArray() // Store as byte array
                };

            Recordings.Add(recording);
            //await OnRecordingCompleted.InvokeAsync(fileName);
        }
        catch (Exception ex)
        {
            //toastService.ShowError($"Error fetching recording: {ex.Message}");
        }
    }
    public async Task SendAllRecordings(Guid? sessionId, string sourcefrom, int fileProfileid)
    {
        if (!Recordings.Any())
        {
            //toastService.ShowWarning("No recordings to send.");
            return;
        }

        try
        {
            var fileContent = new MultipartFormDataContent();
            var addedByUserId = applicationUser.UserID; 
            var isFileSession = true;
            var sourceFrom = sourcefrom;
            var fileProfileId = fileProfileid;

            foreach (var recording in Recordings)
            {
                if (recording.FileData == null || recording.FileData.Length == 0)
                    continue;

                var byteArrayContent = new ByteArrayContent(recording.FileData);
                byteArrayContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("audio/wav");

                fileContent.Add(byteArrayContent, "files", recording.FileName);
            }

            // Add additional parameters
            fileContent.Add(new StringContent(sessionId.ToString()), "SessionId");
            fileContent.Add(new StringContent(addedByUserId.ToString()), "addedByUserId");
            fileContent.Add(new StringContent(isFileSession.ToString()), "IsFileSession");
            fileContent.Add(new StringContent(sourceFrom), "SourceFrom");
            fileContent.Add(new StringContent(fileProfileId.ToString()), "FileProfileId");

            var baseUrl = BaseUrl?.TrimEnd('/');
            var endpoint = "api/FileUpload/upload-multiple";
            var url = $"{baseUrl}/{endpoint}";
            var response = await _httpClient.PostAsync(url, fileContent);

            if (response.IsSuccessStatusCode)
            {
                // Reset everything on success
                Recordings.Clear();
                IsRecording = false;
                StateHasChanged(); // Refresh UI

                //toastService.ShowSuccess("All recordings sent successfully.");
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                //toastService.ShowError($"Failed to send recordings. Server response: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            //toastService.ShowError($"Error: {ex.Message}");
        }
    }

    public async Task SendAllRecordingsold(Guid? sessionId)
    {
        if (!Recordings.Any())
        {
            //toastService.ShowWarning("No recordings to send.");
            return;
        }

        try
        {
            var fileContent = new MultipartFormDataContent();
            //var sessionId = Guid.Parse("D39A69E7-2909-4408-B316-D065F027748A");
            var addedByUserId = 1; // Assign actual user ID
            var isFileSession = true;
            var sourceFrom = "Email";
            var fileProfileId = 0; // Assign actual profile ID

            foreach (var recording in Recordings)
            {
                if (recording.FileData == null || recording.FileData.Length == 0)
                    continue;

                var byteArrayContent = new ByteArrayContent(recording.FileData);
                byteArrayContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("audio/wav");

                fileContent.Add(byteArrayContent, "files", recording.FileName);
            }

            // Add additional parameters
            fileContent.Add(new StringContent(sessionId.ToString()), "SessionId");
            fileContent.Add(new StringContent(addedByUserId.ToString()), "addedByUserId");
            fileContent.Add(new StringContent(isFileSession.ToString()), "IsFileSession");
            fileContent.Add(new StringContent(sourceFrom), "SourceFrom");
            fileContent.Add(new StringContent(fileProfileId.ToString()), "FileProfileId");


            var baseUrl = BaseUrl?.TrimEnd('/');
            var endpoint = "api/FileUpload/upload-multiple";
            var url = $"{baseUrl}/{endpoint}";
            var response = await _httpClient.PostAsync(url, fileContent);

            //var response = await _httpClient.PostAsync("https://localhost:44300/api/FileUpload/upload-multiple", fileContent);

            if (response.IsSuccessStatusCode)
            {
                //toastService.ShowSuccess("All recordings sent successfully.");
                Recordings.Clear(); // Clear after successful upload
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                //toastService.ShowError($"Failed to send recordings. Server response: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            //toastService.ShowError($"Error: {ex.Message}");
        }
    }

    private void DeleteRecording(Guid id)
    {
        var recording = Recordings.FirstOrDefault(r => r.Id == id);
        if (recording != null)
        {
            Recordings.Remove(recording);
        }
    }

    private class Recording
    {
        public Guid Id { get; set; }
        public string FileName { get; set; }
        public byte[] FileData { get; set; }
    }
}
