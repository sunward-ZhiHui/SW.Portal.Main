@using Application.Commands;
@using Application.Queries;
@using Application.Response;
@using global::Core.Repositories.Query;
@using global::Core.Entities;
@using MediatR
@inject IMediator Mediator
@using System.ComponentModel.DataAnnotations
@using DevExpress.Blazor.Internal
@using System.Collections.Generic
@inject ILocalStorageService<ApplicationUser> _localStorageService

@page "/ForumConversations"

<style>
   
</style>
<link href="_content/AC.SD.Core/css/forum-discussion.css" rel="stylesheet" />
<div class="">

   @* <DxFormLayout CssClass="w-100">
        <DxFormLayoutGroup Caption="General Information" ColSpanMd="3">
            asdfasdf
        </DxFormLayoutGroup>
        <DxFormLayoutGroup Caption="Forum Discussion List" ColSpanMd="9">
            asdfasdf
        </DxFormLayoutGroup>
    </DxFormLayout>*@

    <div class="main-container">
        <!--  -->
        <!-- Main Content -->
        <!--  -->
        <div class="content-container">
            <!-- Side Bar -->
           @* <div class="side-menu-bar">
               
                <div class="side-menu-bar-top">
                    <div class="side-menu-bar-text circle">RN</div>
                    <div class="side-menu-bar-text circle">IPIR</div>
                    <div class="side-menu-bar-text circle">PA</div>
                    <div class="side-menu-bar-text circle">CS</div>
                    <div class="side-menu-bar-text circle">GL</div>
                </div>
               
            </div>*@
            <!-- Mini Menu Bar -->
            <div class="mini-menu-bar">
                <div class="mini-menu-bar-top">
                    <div class="mini-menu-bar-heading">
                        <div class="files-title">General Information</div>
                    </div>
                    <!-- Views Accordion -->
                    <div class="views-accordion">                       
                        <DxTreeView Data="@_topics"
                                    @bind-FilterString="FilterString"
                                    FilterMinLength="2"
                                    ShowFilterPanel="true"                                
                                    FilterMode="FilterMode"
                                    AllowSelectNodes=true
                                    LoadChildNodesOnDemand="true"                                   
                                    SelectionChanged="@SelectionChanged" AnimationType="LayoutAnimationType.Slide">
                            <DataMappings>
                                <DxTreeViewDataMapping Key="ID" CssClass="CssClass" ParentKey="TypeId" Text="TopicName" Name="ID"/>
                            </DataMappings>
                        </DxTreeView>
                    </div>                                        
                </div>
                @*<div class="mini-menu-bar-down">
                    <div class="add-cloud-storage-btn">
                        <div class="cloud-storage-btn">                           
                            <div class="add-btn-text">Add cloud storage</div>
                        </div>
                    </div>
                </div>*@
            </div>
            <!-- Menu Bar Content -->
            <div class="menu-bar-content-container">
                <div class="content-padding-20">
                    <div class="menu-bar-content-container-heading">
                        <div class="heading-icon-text">
                            <div class="mb-cc-icon">
                                <svg viewBox="-6 -6 32 32" role="presentation" class="app-svg icons-recents">
                                    <g class="icons-default-fill">
                                        <path d="M10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2ZM10 3C6.13401 3 3 6.13401 3 10C3 13.866 6.13401 17 10 17C13.866 17 17 13.866 17 10C17 6.13401 13.866 3 10 3ZM9.5 5C9.74546 5 9.94961 5.17688 9.99194 5.41012L10 5.5V10H12.5C12.7761 10 13 10.2239 13 10.5C13 10.7455 12.8231 10.9496 12.5899 10.9919L12.5 11H9.5C9.25454 11 9.05039 10.8231 9.00806 10.5899L9 10.5V5.5C9 5.22386 9.22386 5 9.5 5Z">
                                        </path>
                                    </g>
                                </svg>
                            </div>
                            <div class="mb-cc-text">

                                <div class="card w-100">
                                    <div class="card-body p-0">
                                        <DxMenu Orientation="Orientation.Horizontal"
                                                DropDownActionMode="MenuDropDownActionMode.Click"
                                                DisplayMode="MenuDisplayMode.Desktop"
                                                Title=""
                                                CollapseItemsToHamburgerMenu="true"
                                                CollapseItemToIconMode="MenuCollapseItemToIconMode.All">
                                            <Items>
                                                <DxMenuItem Text="Posts" IconCssClass="menu-icon-products menu-icon" />
                                                <DxMenuItem Text="Files" IconCssClass="menu-icon-support menu-icon" />
                                                <DxMenuItem Text="Wiki" IconCssClass="menu-icon-about menu-icon" />
                                            </Items>
                                        </DxMenu>
                                    </div>
                                </div>
                            </div>
                           
                        </div>
                        <div>
                            @if (_headTopic != null && _headTopic.Any())
                                {
                                @foreach (var item in _headTopic)
                                    {
                                        <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto">
                                            <div class="uk-card-header">
                                                <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                <div class="uk-card-title uk-first-column" style="font-size: 16px;">
                                                    @item.TicketNo - @item.TopicName
                                                </div>
                                                    <span class="uk-label uk-margin-auto-left">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
                                                    </svg>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                            }
                        </div>
                    </div>
                    <div class="@((isComponentVisible ? "menu-bar-content-container-content msgOpen" : "menu-bar-content-container-content msgClose"))">
                       @* <div class="spacing-box"></div>  *@                     
                       
                        <div id="tableData">
                            <div>
                                @if (_discussionList != null && _discussionList.Any())
                                {
                                    @foreach (var item in _discussionList)
                                    {
                                       
                                        <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto">
                                            <div class="uk-card-header">
                                                <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                    <div class="uk-card-title uk-first-column">@item.UserName</div>
                                                    <span class="uk-label uk-margin-auto-left">@item.AddedDate</span>
                                                </div>
                                            </div>
                                            <div class="uk-card-body">
                                                <p class="uk-text-success">
                                                    @item.Message
                                                </p>
                                            </div>
                                           
                                            <div class="uk-card-footer">
                                                <div>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-reply" viewBox="0 0 16 16">
                                                        <path d="M6.598 5.013a.144.144 0 0 1 .202.134V6.3a.5.5 0 0 0 .5.5c.667 0 2.013.005 3.3.822.984.624 1.99 1.76 2.595 3.876-1.02-.983-2.185-1.516-3.205-1.799a8.74 8.74 0 0 0-1.921-.306 7.404 7.404 0 0 0-.798.008h-.013l-.005.001h-.001L7.3 9.9l-.05-.498a.5.5 0 0 0-.45.498v1.153c0 .108-.11.176-.202.134L2.614 8.254a.503.503 0 0 0-.042-.028.147.147 0 0 1 0-.252.499.499 0 0 0 .042-.028l3.984-2.933zM7.8 10.386c.068 0 .143.003.223.006.434.02 1.034.086 1.7.271 1.326.368 2.896 1.202 3.94 3.08a.5.5 0 0 0 .933-.305c-.464-3.71-1.886-5.662-3.46-6.66-1.245-.79-2.527-.942-3.336-.971v-.66a1.144 1.144 0 0 0-1.767-.96l-3.994 2.94a1.147 1.147 0 0 0 0 1.946l3.994 2.94a1.144 1.144 0 0 0 1.767-.96v-.667z" />
                                                    </svg>  Reply
                                                </div>
                                              
                                            </div>
                                        </div>
                                    }
                                }
                            </div>



                            @if (isComponentVisible)
                            {
                                <div class="open-button ">
                                    <EditForm Model="@Data" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                                        <DataAnnotationsValidator />
                                        <DxFormLayout>
                                            <DxFormLayoutItem ColSpanMd="12">
                                                <DxMemo @bind-Text="@Data.Message" NullText="Message" />
                                                <ValidationMessage For="@(() => Data.Message)" />
                                            </DxFormLayoutItem>
                                            <DxFormLayoutItem ColSpanMd="12">
                                                <DxButton SubmitFormOnClick="true"
                                                      Text="Submit"
                                                      CssClass="btn-submit"
                                                          style="float:right"
                                                      RenderStyle="ButtonRenderStyle.Secondary" />

                                                <i class="fa fa-paper-plane" aria-hidden="true"></i>

                                                      <div style="color:black;display:flex;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
                                                        <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z" />
                                                    </svg>
                                                      
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
                                                    </svg>
                                                     
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                                                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z" />
                                                    </svg>
                                                   @* <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square" viewBox="0 0 16 16">
                                                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                                                    </svg> *@


                                                    <div style="font-size: 24px; line-height: 1.5em;">
                                                        <i class="fa-thin fa-paper-plane-top"></i>
                                                        <i class="fab fa-paper-plane-f" aria-hidden="true"></i>
                                                    </div>
                                                      </div>


                                             @*   <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                                                      Text="Close"
                                                      style="color: white;"
                                                      Click="@(() => isComponentVisible = false)"
                                                      IconCssClass="btn-icon-undo"
                                            CssClass="me-1 btn-success" />*@
                                               
                                            </DxFormLayoutItem>
                                        </DxFormLayout>
                                    </EditForm>

                                   
                                </div>
                            }
                            else
                            {

                                <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                                      Text="New Conversation"
                                      Click="@(() => isComponentVisible = true)"
                                      IconCssClass="btn-icon-undo"
                                          style="color:white; width:200px;"
                                      CssClass="me-1 btn-success open-button" />
                            }
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    DxTreeView treeView; 
    bool isComponentVisible = true;
    private List<ForumTypes>? _types;
    private List<ForumTopics>? _topics;
    public List<ForumConversations> _discussionList;
    private List<ForumTopics>? _headTopic;
    string FilterString { get; set; }
    NavigationFilterMode FilterMode { get; set; } = NavigationFilterMode.EntireBranch;
    public ForumTypes SelectedNodes { get; set; }
    ForumConversations? Data { get; set; } = new ForumConversations();
    string SelectedGroup = "none";    
    public ApplicationUser applicationUser { get; private set; }
    private async Task SelectionChanged(TreeViewNodeEventArgs e)
    {
        SelectedGroup = e.NodeInfo?.Name;
        //_discussionList = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
        await LoadData();
    }
    private List<string> data;
    private async Task LoadData()
    {  
        _discussionList = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
        _headTopic = await Mediator.Send(new GetByIdTopics(long.Parse(@SelectedGroup)));
       
    }


    protected override async Task OnInitializedAsync()
    {
        var model = await Mediator.Send(new GetAllForumTypes());
        _types = model;       

        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");     
        
        _topics = await Mediator.Send(new GetUserForumTopics(applicationUser.UserID));

        var lst = await Mediator.Send(new GetTreeList(applicationUser.UserID));

        //_discussionList = await Mediator.Send(new GetDiscussionList(38));
    }
    void getConversation()
    {

    }

    private void OnSelectedNodeChangeds(ForumTypes item)
    {
        SelectedNodes = item;
    }
    private async Task HandleValidSubmit()
    {
        var createReq = new CreateForumCoversation
            {

                TopicID = (long.Parse(@SelectedGroup)),
                Message = Data.Message,
                ParticipantId = applicationUser.UserID,
                ReplyId = 0,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = Guid.NewGuid()
            };
        var result = await Mediator.Send(createReq);

        if(result == 1)
        {
            await LoadData();
            onRestText();
        }
        else
        {

        }
    }
    private void onRestText()
    {
        Data.Message = null;
    }

    void HandleInvalidSubmit()
    {
       
    }

    private List<TreeViewItem> TreeData = new List<TreeViewItem>
    {
        new TreeViewItem { ID = 1, ParentID = null, Name = "Item 1" },
        new TreeViewItem { ID = 2, ParentID = 1, Name = "Item 1.1" },
        new TreeViewItem { ID = 3, ParentID = 1, Name = "Item 1.2" },
        new TreeViewItem { ID = 4, ParentID = 2, Name = "Item 1.1.1" },
        new TreeViewItem { ID = 5, ParentID = 2, Name = "Item 1.1.2" },
        new TreeViewItem { ID = 6, ParentID = 3, Name = "Item 1.2.1" }
    };
    private TreeViewItem SelectedNode { get; set; }

    private void OnSelectedNodeChanged(TreeViewItem node)
    {
        SelectedNode = node;
        // Do something with the selected node
    }

    private class TreeViewItem
    {
        public int ID { get; set; }
        public int? ParentID { get; set; }
        public string Name { get; set; }
    }
}