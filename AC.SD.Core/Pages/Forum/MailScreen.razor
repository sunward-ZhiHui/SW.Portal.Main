@using Application.Commands;
@using Application.Common.Helper;
@using Application.Queries;
@using Application.Response;
@using Microsoft.AspNetCore.Http;
@using global::Core.Repositories.Query;
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using MediatR
@inject IMediator Mediator
@using System.ComponentModel.DataAnnotations
@using DevExpress.Blazor.Internal
@using System.Collections.Generic
@inject ILocalStorageService<ApplicationUser> _localStorageService
@page "/mail"
@using DevExpress.Blazor.RichEdit
@using DevExpress.Blazor.Office
@using System.Globalization
@using System;
@using Application.Command.Document;
@using Microsoft.Extensions.Configuration;
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime;
@inject HttpClient httpClient;
@using System.IO;
@using Microsoft.JSInterop;
@using DevExpress.DocumentView;
@inject NavigationManager NavigationManager
@using System.Web;
@inject IToastService ToastService
@inject AC.SD.Core.Services.ToastService toastService
@using System.Text;
@using RtfPipe;
@inject Application.Common.Helper.Helper  dateformathelper

<link href="_content/AC.SD.Core/css/forum-mail.css" rel="stylesheet" />

<div class="">

    @* <DxFormLayout CssClass="w-100">
    <DxFormLayoutGroup Caption="General Information" ColSpanMd="3">
    asdfasdf
    </DxFormLayoutGroup>
    <DxFormLayoutGroup Caption="Forum Discussion List" ColSpanMd="9">
    asdfasdf
    </DxFormLayoutGroup>
    </DxFormLayout>*@

    <div class="main-container">
        <!--  -->
        <!-- Main Content -->
        <!--  -->
        <div class="content-container">
            <!-- Side Bar -->
            @* <div class="side-menu-bar">

            <div class="side-menu-bar-top">
            <div class="side-menu-bar-text circle">RN</div>
            <div class="side-menu-bar-text circle">IPIR</div>
            <div class="side-menu-bar-text circle">PA</div>
            <div class="side-menu-bar-text circle">CS</div>
            <div class="side-menu-bar-text circle">GL</div>
            </div>

            </div>*@
            <!-- Mini Menu Bar -->
            <div class="mini-menu-bar">
                <div class="mini-menu-bar-top">
                    <div class="mini-menu-bar-heading">
                        <div class="files-title">General Information</div>
                    </div>                  

                    <div>
                        <div class="views-accordion">

                            <DxGrid @ref="TOGrid"
                                    Data="_employeeItems"
                                    KeyFieldName="UserID"
                                    CustomizeElement="Grid_CustomizeElement"
                                    PagerNavigationMode="PagerNavigationMode.InputBox"
                                    PageSizeSelectorVisible="true"
                                    PageSizeSelectorAllRowsItemVisible="true"
                                    PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                                    PageSize="20"                                                                  
                                    ValidationEnabled="true"
                                    AutoExpandAllGroupRows="true"
                                    CssClass="ch-360 " style="height: calc(100vh - 220px);"                                  
                                    RowClick="OnRowClick"
                                    AllowSelectRowByClick="true">
                                <Columns>


                                    <DxGridDataColumn FieldName="SageID" MinWidth="80">
                                        @* <CellDisplayTemplate>
                                        @{
                                        var item = (ViewEmployee)context.DataItem;
                                        }
                                        <DxButton IconCssClass="btnDelete fas fa-trash" Enabled=@(item.LoginID != "crt") />
                                        </CellDisplayTemplate>*@
                                    </DxGridDataColumn>
                                    <DxGridDataColumn FieldName="FirstName" />
                                    <DxGridDataColumn FieldName="LastName" />
                                    <DxGridDataColumn FieldName="NickName" MinWidth="80" />
                                    <DxGridDataColumn FieldName="StatusCode" MinWidth="80" />
                                    <DxGridDataColumn FieldName="ModifiedDate" />
                                    <DxGridDataColumn FieldName="Locked" />
                                    <DxGridDataColumn FieldName="ModifiedByUser" />
                                </Columns>
                                <TotalSummary>
                                    <DxGridSummaryItem SummaryType="GridSummaryItemType.Count" FieldName="SageID" />
                                </TotalSummary>
                            </DxGrid>
                        </div>
                    </div>





                </div>
                @*<div class="mini-menu-bar-down">
                <div class="add-cloud-storage-btn">
                <div class="cloud-storage-btn">
                <div class="add-btn-text">Add cloud storage</div>
                </div>
                </div>
                </div>*@
            </div>
            <!-- Menu Bar Content -->
            <div class="menu-bar-content-container">
                <div class="content-padding-20">
                    <div class="menu-bar-content-container-heading">
                        <div class="heading-icon-text">
                           @* <div class="mb-cc-icon">
                                <svg viewBox="-6 -6 32 32" role="presentation" class="app-svg icons-recents">
                                    <g class="icons-default-fill">
                                        <path d="M10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2ZM10 3C6.13401 3 3 6.13401 3 10C3 13.866 6.13401 17 10 17C13.866 17 17 13.866 17 10C17 6.13401 13.866 3 10 3ZM9.5 5C9.74546 5 9.94961 5.17688 9.99194 5.41012L10 5.5V10H12.5C12.7761 10 13 10.2239 13 10.5C13 10.7455 12.8231 10.9496 12.5899 10.9919L12.5 11H9.5C9.25454 11 9.05039 10.8231 9.00806 10.5899L9 10.5V5.5C9 5.22386 9.22386 5 9.5 5Z">
                                        </path>
                                    </g>
                                </svg>
                            </div>*@
                            <div class="mb-cc-text">

                                <div class="card w-100">
                                    <div class="card-body p-0">
                                        <DxMenu Orientation="Orientation.Horizontal"
                                                DropDownActionMode="MenuDropDownActionMode.Click"
                                                DisplayMode="MenuDisplayMode.Desktop"
                                                Title=""
                                                CollapseItemsToHamburgerMenu="true"
                                                CollapseItemToIconMode="MenuCollapseItemToIconMode.All">
                                            <Items>
                                                <DxMenuItem Text="Posts" class="@((isMenuvisible == "Posts" ? "tActive": "tfiles"))" IconCssClass="menu-icon-products menu-icon" Click="@(() => OnMenuItemClick("Posts"))" />
                                                <DxMenuItem Text="Files" Enabled="@isEnabled" class="@((isMenuvisible == "Files" ? "tActive": "tfiles"))" IconCssClass="fa fa-paperclip cdspc" Click="@(() => OnMenuItemClick("Files"))" />
                                                <DxMenuItem Text="Todo" class="@((isMenuvisible == "Todo" ? "tActive": "ttodo"))" IconCssClass="menu-icon-about menu-icon" Click="@(() => OnMenuItemClick("Todo"))" />
                                                <DxMenuItem Text="Participants List" Enabled="@isEnabled" class="@((isMenuvisible == "AddParticipants" ? "tActive": "taddparticipants"))" IconCssClass="dxbl-image menu-icon-support menu-icon dx-menu-item-image" Click="@(() => OnMenuItemClick("AddParticipants"))" />
                                            </Items>
                                        </DxMenu>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div>
                            @if (_headTopic != null && _headTopic.Any())
                            {
                                @foreach (var item in _headTopic)
                                {
                                    <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto">
                                        <div class="uk-card-header" style="height: auto; border-bottom: none;">
                                            <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                @*<div class="uk-card-title uk-first-column" style="font-size: 16px;">
                                                   <span> @item.TicketNo - @item.TopicName </span>
                                                    <br>
                                                    <div> Description :</div>
                                                    <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />
                                                </div>*@


                                                <div class="uk-card-header" style="border-bottom: none;">
                                                    <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                        <div class="uk-card-title uk-first-column" style="margin-right:10px; float: left; margin-top: 4px; margin-left: 10px;">@item.TicketNo - @item.TopicName</div>
                                                        <span class="uk-label uk-margin-auto-left">@Application.Common.Helper.Helper.FormatDate(@item.AddedDate)</span>
                                                        
                                                        <span class="uk-label uk-margin-auto-left" style="float: right; margin-top: -10px; margin-right: 0px;">

                                                            @if (isAddParticipant)
                                                            {
                                                                @if (isCommandTopicClosed)
                                                                {
                                                                    <button @onclick="onAddPlist" class="btn btn-excel" style="margin-top: 2px;">Add Participant </button>
                                                                }

                                                            }

                                                            @if (isEllipsis)
                                                            {
                                                                @if (isCommandTopicClosed)
                                                                {
                                                                    <DxMenu Orientation="Orientation.Horizontal" DisplayMode="MenuDisplayMode.Mobile">
                                                                        <Items>
                                                                            <DxMenuItem @onclick="onDueDatePop" Text="Due Date" />
                                                                            <DxMenuItem @onclick="onTopicClosedPop" Text="Close" />

                                                                            @if(isDescription)
                                                                            {
                                                                                <DxMenuItem @onclick="hideTopicDescription" Text="Hide Description" />
                                                                            }
                                                                            else
                                                                            {
                                                                                <DxMenuItem @onclick="showTopicDescription" Text="Show Description" />   
                                                                            }

                                                                        </Items>
                                                                    </DxMenu>
                                                                }
                                                                else
                                                                {
                                                                    <div style="color:red;margin-top: 10px;">Closed</div>
                                                                }
                                                            }

                                                            @*<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                            <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
                                                            </svg>*@
                                                        </span>

                                                    </div>
                                                </div>

                                                @if(isDescription)
                                                {
                                                    <div>
                                                        <div> Description :</div>
                                                        <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />
                                                    </div>
                                                }
                                                
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    <div class="@((isComponentVisible ? "menu-bar-content-container-content msgOpen" : "menu-bar-content-container-content msgClose"))">
                        @* <div class="spacing-box"></div>  *@
                        @if (isMenuvisible == "Posts")
                        {


                            <div id="tableData">
                                <div>
                                    @if (_discussionList != null && _discussionList.Any())
                                    {
                                        @foreach (var item in _discussionList)
                                        {
                                            @if (item.ReplyId > 0)
                                            {
                                                <div class="lstcoversationrply">
                                                    <i class="fa fa-reply-all" aria-hidden="true"></i>
                                                    <div>@item.ReplyMessage</div>
                                                    <div style="float:right;margin-top: -13px;">@item.ReplyUserName , @item.ReplyDateTime</div>
                                                </div>
                                            }

                                            <div class="uk-card uk-card-default uk-margin-medium-bottom uk-overflow-auto">
                                                <div class="uk-card-header">
                                                    <div class="uk-grid-small uk-flex-middle uk-grid" uk-grid="">
                                                        <div class="uk-card-title uk-first-column" style="margin-right:10px; float: left; margin-top: 4px; margin-left: 10px;">@item.UserName</div>
                                                        <span class="uk-label uk-margin-auto-left">@Application.Common.Helper.Helper.FormatDate(@item.AddedDate)</span>
                                                        <div title="Assigned To" class="handline" style="margin-top: 0px; float: right;margin-right: 10px;" @onclick="@(() => assignedList(item.ID))"> <i class="fa fa-users" aria-hidden="true"></i> </div>
                                                        <span class="uk-label uk-margin-auto-left" style="float: right; margin-right: 15px; margin-top: 1px;">
                                                            <div class="handline" @onclick="@(() => onreply(item.ID))">
                                                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-top: -5px;" width="16" height="16" fill="currentColor" class="bi bi-reply" viewBox="0 0 16 16">
                                                                    <path d="M6.598 5.013a.144.144 0 0 1 .202.134V6.3a.5.5 0 0 0 .5.5c.667 0 2.013.005 3.3.822.984.624 1.99 1.76 2.595 3.876-1.02-.983-2.185-1.516-3.205-1.799a8.74 8.74 0 0 0-1.921-.306 7.404 7.404 0 0 0-.798.008h-.013l-.005.001h-.001L7.3 9.9l-.05-.498a.5.5 0 0 0-.45.498v1.153c0 .108-.11.176-.202.134L2.614 8.254a.503.503 0 0 0-.042-.028.147.147 0 0 1 0-.252.499.499 0 0 0 .042-.028l3.984-2.933zM7.8 10.386c.068 0 .143.003.223.006.434.02 1.034.086 1.7.271 1.326.368 2.896 1.202 3.94 3.08a.5.5 0 0 0 .933-.305c-.464-3.71-1.886-5.662-3.46-6.66-1.245-.79-2.527-.942-3.336-.971v-.66a1.144 1.144 0 0 0-1.767-.96l-3.994 2.94a1.147 1.147 0 0 0 0 1.946l3.994 2.94a1.144 1.144 0 0 0 1.767-.96v-.667z" />
                                                                </svg>  Reply
                                                            </div>                                                            
                                                        </span>
                                                        
                                                    </div>
                                                </div>
                                                <div class="uk-card-body">
                                                    @{
                                                        string htmlString = "";
                                                        // byte[] byteArray = Encoding.UTF8.GetBytes(item.Message);
                                                        if(item.FileData != null)
                                                        {
                                                            htmlString = Encoding.UTF8.GetString(item.FileData);
                                                        }
                                                        else
                                                        {
                                                            htmlString = "";
                                                        }
                                                        
                                                    }
                                                    <p class="uk-text-success">
                                                       @* <div>@htmlString</div>
                                                        <div>@(new MarkupString(htmlString))</div>*@
                                                        <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />
                                                       @* @item.Message*@
                                                    </p>

                                                    <div class="uk-card-footer">
                                                        <div>
                                                            <div class="accordion-item">
                                                                <div class="accordion-title" @onclick="@(() => ToggleDocItemVisibility(item.ID))"> Attachment </div>

                                                                @*<p style="color: #5151b3;" class="handline" @onclick="@(() => ToggleDocItemVisibility(item.ID))">Attachment </p>*@
                                                               
                                                                   @if (DocitemVisibility.ContainsKey(item.ID) && DocitemVisibility[item.ID])
                                                                    {
                                                                        @foreach (var attachment in item.documents)
                                                                        {
                                                                            <div class="tag"><i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName</div>
                                                                        }
                                                                
                                                           
                                                                        
                                                                            string firststring = "#overviewDemoSelectButton_";
                                                                            Guid? secondstring = item.SessionId;
                                                                            string extt = firststring + secondstring;
                                                                        
                                                                    <div id="overviewDemoSelectButton_@item.SessionId" class="tag fa fa-plus-square"></div>
                                                                            <DxUpload @ref="MyUpload" Name="files"
                                                                              AcceptedFileTypes=@AcceptedFileTypes
                                                                              Visible="@UploadVisible"
                                                                              ExternalSelectButtonCssSelector="@extt"
                                                                              UploadUrl="@GetDocUploadUrl(@item.SessionId)"
                                                                              Id="@extt"
                                                                              SelectedFilesChanged="@SelectedFilesChanged1"
                                                                              CssClass="w-100"
                                                                              FileUploaded="@HandleUploadSuccess">
                                                                            </DxUpload>
                                                                    }
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>                              

                                                @if (item.ReplyConversation.Count() > 0)
                                                {
                                                    <div class="uk-card-footer">
                                                        <div>
                                                            <p style="color: #5151b3;" class="handline" @onclick="@(() => ToggleItemVisibility(item.ID))">@item.ReplyConversation.Count() replies </p>
                                                            @if (@item.ReplyConversation != null && @item.ReplyConversation.Any())
                                                            {
                                                                @if (itemVisibility.ContainsKey(item.ID) && itemVisibility[item.ID])
                                                                {
                                                                    @foreach (var items in @item.ReplyConversation)
                                                                    {
                                                                        <div class="lstcoversationrply">
                                                                            <div><span style="font-weight:600">@item.UserName</span>, @item.AddedDate</div>
                                                                            <div class="handline" title="Assigned To" style="margin-top: -20px; float: right;" @onclick="@(() => assignedList(item.ID))"> <i class="fa fa-users" aria-hidden="true"></i> </div>
                                                                            @*<div>@items.Message</div>*@
                                                                            <div>
                                                                                <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@items.FileData" />
                                                                            </div>
                                                                            @if (items.documents != null && items.documents.Any())
                                                                            {
                                                                                @foreach (var attachment in items.documents)
                                                                                {
                                                                                    <div class="tag"><i class="fas fa-file" aria-hidden="true"></i> @attachment.FileName</div>
                                                                                }                                                                              
                                                                            }
                                                                            @{
                                                                                string firststring = "#overviewDemoSelectButton_";
                                                                                Guid? secondstring = items.SessionId;
                                                                                string extt = firststring + secondstring;

                                                                            }                                                                          

                                                                            <div id="overviewDemoSelectButton_@items.SessionId" class="tag fa fa-plus-square"></div>
                                                                            <DxUpload @ref="MyUpload" Name="files"
                                                                              AcceptedFileTypes=@AcceptedFileTypes
                                                                              Visible="@UploadVisible"
                                                                              ExternalSelectButtonCssSelector="@extt"
                                                                              UploadUrl="@GetDocUploadUrl(@items.SessionId)"
                                                                              Id="@extt"
                                                                              SelectedFilesChanged="@SelectedFilesChanged1"
                                                                              CssClass="w-100"
                                                                              FileUploaded="@HandleUploadSuccess">
                                                                            </DxUpload>
                                                                        </div>                                                                                                                                               
                                                                    }

                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                }                                               
                                            </div>
                                        }
                                    }
                                </div>



                                @if (isComponentVisible)
                                {
                                    <div id="dropdown-customization-target-container" class="open-button">
                                        <DxButton Click="() => IsOpen = !IsOpen"
                                          RenderStyle="@ButtonRenderStyle.Secondary">SHOW A DROPDOWN</DxButton>
                                    </div>




                                    <DxDropDown @bind-IsOpen="@IsOpen"
                                        MinWidth="max(25vw, 250px)"
                                        PositionMode="DropDownPositionMode.Bottom"
                                        PositionTarget="#dropdown-customization-target-container"
                                        RestrictionTarget="#Navigation-DropDown-Customization"
                                        CloseMode="DropDownCloseMode.Close"
                                        PreventCloseOnPositionTargetClick="true"
                                        HeaderVisible="true"
                                        HeaderText="Edit Contact"
                                        FooterVisible="true">
                                        <BodyTextTemplate>
                                           welcome
                                        </BodyTextTemplate>
                                        <FooterTextTemplate>
                                            <DxButton CssClass="popup-button my-1 ms-2" RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@context.CloseCallback" />
                                            <DxButton CssClass="popup-button my-1 ms-2" RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@context.CloseCallback" />
                                        </FooterTextTemplate>
                                    </DxDropDown>




                                    <div class="open-button-old" style="width:99.5%">
                                        @if (_replyComment != null && _replyComment.Any())
                                        {
                                            @foreach (var item in _replyComment)
                                            {
                                                <div class="replybox">
                                                    <div> <i class="fa fa-reply" aria-hidden="true"></i> Reply</div>
                                                    <div class="closebtn" @onclick="closeReply">X</div>
                                                    @*<p>@item.Message</p>*@
                                                    <DxRichEdit DocumentFormat="DocumentFormat.Rtf" ViewType="ViewType.Simple" CssClass="w-100 txtEditorMsg" @ref="richEdit" ReadOnly="true" BarMode=BarMode.None DocumentContent="@item.FileData" />
                                                    <div>@item.UserName  , @item.AddedDate</div>
                                                </div>
                                            }
                                        }
                                         @*       DocumentContentChanged="OnmsgContentChanged"
                                        Selection="@richSelection" SelectionChanged="OnSelectionChanged"
                                         *@
                                        @if(isCommand)
                                        {
                                            @if(isCommandTopicClosed)
                                            {
                                                <EditForm Model="@Data" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                                                @* <DataAnnotationsValidator />*@
                                                <DxFormLayout>
                                                    <DxFormLayoutItem Caption="Assign To" ColSpanMd="12">
                                                        <DxTagBox NullText="Select Assign To..."
                                                      Data="@_assigntoItems"
                                                      ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                      ValueFieldName="UserID"
                                                      TextFieldName="FirstName"
                                                      @bind-Values="@Data.AssigntoIds"
                                                      CssClass="cw-480" />
                                                    </DxFormLayoutItem>
                                                    <DxFormLayoutItem ColSpanMd="12">
                                                        <div class="">
                                                            <DxRichEdit @ref="msgrichEdit" CustomizeToolbar=OnCustomizeToolbar BarMode="BarMode.Toolbar" CssClass="w-100 txtEditorMsg" ViewType="ViewType.Simple" />
                                                            @* <DxRichEdit @ref="@msgrichEdit" CustomizeToolbar=OnCustomizeToolbar DocumentContentChanged="OnmsgContentChanged" DocumentContent="@documentContent" BarMode="BarMode.Toolbar" CssClass="w-100 txtEditorMsg" ViewType="ViewType.Simple"></DxRichEdit>
                                                *@
                                                        </div>
                                                        @* <DxMemo @bind-Text="@Data.Message" NullText="Message" style="height:170px;" />
                                            <ValidationMessage For="@(() => Data.Message)" />*@
                                                    </DxFormLayoutItem>
                                                    <DxFormLayoutItem ColSpanMd="12">
                                                        <DxButton SubmitFormOnClick="true"
                                                      Text=""
                                                      CssClass="fa fa-paper-plane sndrot"
                                                                  style="float:right"
                                                      RenderStyle="ButtonRenderStyle.Secondary" />
                                                        <div style="display:flex;" class="attmode">
                                                            @*<div @onclick="@(() => isFileUpload = true)" class="fa fa-paperclip cdspcc" aria-hidden="true"></div>*@
                                                            <div id="attachmentSelectButton" class="fa fa-paperclip handline cdspcc" aria-hidden="true"></div>

                                                            <div class="">
                                                                <DxUpload @ref="uploadComponent" Name="files"
                                                              Visible="@AttachmentUploadVisible"
                                                                  AcceptedFileTypes=@AcceptedFileTypes
                                                                  UploadMode="@UploadMode.OnButtonClick"
                                                                  UploadUrl="@GetUploadUrl()"
                                                                  AllowMultiFileUpload="true"
                                                                  ExternalSelectButtonCssSelector="#attachmentSelectButton"
                                                                  SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                                                  FileUploaded="@isUploadSuccess"
                                                                  FileUploadError="@OnUploadError">
                                                                </DxUpload>
                                                                <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>
                                                                @* <button class="btn btn-success" RenderStyle="ButtonRenderStyle.Success" style="float:right;" @onclick="UploadFiles">Add</button>*@
                                                            </div>


                                                            @*<DxUpload @ref="uploadComponent" Name="files" UploadUrl="@GetUploadUrl()" FileUploaded="@OnFileUploaded"></DxUpload>*@
                                                            @*<div class="fa fa-ellipsis-v cdspcc" aria-hidden="true"></div>*@
                                                        </div>


                                                        @*   <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                                            Text="Close"
                                            style="color: white;"
                                            Click="@(() => isComponentVisible = false)"
                                            IconCssClass="btn-icon-undo"
                                            CssClass="me-1 btn-success" />*@

                                                    </DxFormLayoutItem>
                                                </DxFormLayout>
                                            </EditForm>
                                            }
                                        }
                                       
                                        @* <DxRichEdit Height="500px" Width="100%"></DxRichEdit>*@

                                    </div>
                                }
                                else
                                {

                                   @* <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                                      Text="New Conversation"
                                      Click="@(() => isComponentVisible = true)"
                                      IconCssClass="btn-icon-undo"
                                              style="color:white; width:200px;"
                                      CssClass="me-1 btn-success open-button" />*@
                                }
                            </div>
                        }
                        else if (isMenuvisible == "Files")
                        {

                            <DxGrid @ref="Grid" Data="@_topicDocList" EditMode="GridEditMode.EditForm" ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
                                PagerNavigationMode="PagerNavigationMode.InputBox"
                                PageSizeSelectorVisible="true"
                                PageSizeSelectorAllRowsItemVisible="true"
                                PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                                PageSize="20"
                                    style="height:calc(100vh - 289px)"
                                CssClass="ch-360"
                                AutoExpandAllGroupRows="true"
                                SelectionMode="GridSelectionMode.Multiple"
                                SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages">
                                <Columns>
                                @*    <DxGridSelectionColumn Width="60px" AllowSelectAll="true" />*@
                                    <DxGridDataColumn FieldName="FileIndex" Caption="#" Width="35px"></DxGridDataColumn>
                                    <DxGridDataColumn FieldName="FileName" MinWidth="200" />
                                    @*<DxGridDataColumn FieldName="FileSize" />*@
                                    <DxGridDataColumn FieldName="DocumentId" Caption="Preview" AllowSort="false" Width="90px" MinWidth="45" TextAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate><button class="dxbl-btn fa fa-eye" @onclick="() => onPreview((long)context.Value)"></button></CellDisplayTemplate>
                                    </DxGridDataColumn>
                                    <DxGridDataColumn FieldName="DocumentId" Caption="Download" AllowSort="false" Width="90px" MinWidth="45" TextAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate><button class="dxbl-btn fa fa-cloud-download" @onclick="() => onDocDownload((long)context.Value)"></button></CellDisplayTemplate>
                                    </DxGridDataColumn>
                                    <DxGridDataColumn FieldName="DocumentId" Caption="Delete" AllowSort="false" Width="90px" MinWidth="45" TextAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate><button class="btnDelete fas fa-trash" @onclick="() => onDocDelete((long)context.Value)"></button></CellDisplayTemplate>
                                    </DxGridDataColumn>
                                </Columns>
                            </DxGrid>
                        }
                        else if (isMenuvisible == "Todo")
                        {
                            <div>Todo</div>
                          
                        }
                        else
                        {
                           @* <div class="card-header text-center">
                                <span> Participant List</span>
                                @*<DxButton style="float:right;" RenderStyle="ButtonRenderStyle.Info" class="btn btn-add" Click="@onClickParticipant">Add</DxButton>
                            </div>*@
                            <div class="">
                                <DxGrid @ref="Grid" Data="_participant"
                                    KeyFieldName="ID"
                                    ShowSearchBox="true"
                                    PagerNavigationMode="PagerNavigationMode.InputBox"                                   
                                    PageSizeSelectorAllRowsItemVisible="true"
                                    PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                                    PageSize="20"
                                    style="height:calc(100vh - 290px);min-height:400px !important"
                                    CssClass="ch-360"
                                    SelectionMode="GridSelectionMode.Multiple"
                                    AllowSelectRowByClick="true">
                                    <Columns>
                                        @*<DxDataGridColumn>
                                    <DxDataGridCheckBoxColumn Field="@nameof(ViewEmployee.UserID)" Caption="Selected" />
                                    </DxDataGridColumn>*@
                                        <DxGridDataColumn FieldName="RowIndex" Width="30" Caption="#" />
                                        <DxGridDataColumn FieldName="UserName" MinWidth="100" />
                                        <DxGridDataColumn FieldName="UserCode" />
                                        <DxGridDataColumn FieldName="ID" Caption="Action" AllowSort="false" Width="90px" MinWidth="45" TextAlignment="GridTextAlignment.Center">
                                            <CellDisplayTemplate>
                                                @{
                                                    var item = (TopicParticipant)context.DataItem;
                                                }
                                                <DxButton IconCssClass="btnDelete fas fa-trash" style=" background: transparent; border: none;" Click="() => onDeletePlist((long)context.Value)" Enabled=@(item.IsEnabled) />
                                                @*<button class="btnDelete fas fa-trash" Enabled=@(item.IsEnabled) @onclick="() => onDeletePlist((long)context.Value)"></button>*@
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>                                        
                                    </Columns>
                                </DxGrid>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<DxPopup @ref="popup" HeaderText="CRT" ShowCloseButton="true" Width="100%" Height="100%" @bind-Visible="@PreviewDocPopup">
    <BodyContentTemplate>
        <div class="richeditorHeight">
            <DxRichEdit @ref="@richEdit" DocumentFormat="@MyDocumentFormat" DocumentContent="@documentContent" ViewType="ViewType.Simple" BarMode="BarMode.Toolbar" CssClass="w-100" DocumentContentChanged="OnDocumentContentChanged"></DxRichEdit>
        </div>
      @*  <div id="pdfInterop"></div>*@
       @* <iframe src="@documentPreviewUrl" type="@documentMimeType" width="800" height="600"></iframe>
        <iframe src="https://www.example.com" width="100%" height="500"></iframe>*@
    </BodyContentTemplate>    
</DxPopup>

<DxPopup @ref="popup" HeaderText="CRT" ShowCloseButton="true" Width="300px" @bind-Visible="@PopupVisible">
    <div class="text-center">
        <Content>
            <p>
                <div Position="Left" id="@("label"+_participantLst.UserName)" class="display-field"> Do you want to  Delete this <span style="color:red">@_participantLst.UserName</span> </div>
            </p>
        </Content>        
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitDelete(_participantLst.ID))" />
        <DxButton CssClass="dx-button.dx-icon" Text="No" Click="@(() => ClosePopup())" />
    </div>
</DxPopup>

<DxPopup @ref="popup" HeaderText="Doc Delete" ShowCloseButton="true" Width="300px" @bind-Visible="@DocPopupVisible">
    <div class="text-center">
        <Content>
            <p>
                <div Position="Left" id="@("label"+_documents.FileName)" class="display-field"> Do you want to  Delete this <span style="color:red">@_documents.FileName</span> </div>
            </p>
        </Content>        
        <DxButton style="align-items" Text="Yes" Click="@((e) => SubmitDocDelete(_documents.DocumentId))"/>
        <DxButton CssClass="dx-button.dx-icon" Text="No" Click="@(() => ClosePopup())" />
    </div>
</DxPopup>

<DxPopup @bind-Visible="@isDueDate" HeaderText="Add Due Date">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

        <EditForm Model="@_dataDuDate" OnValidSubmit="@SubmitDueDate" class="w-800">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-md-12" style="padding-bottom: 12px">
                <label for="DueDate"> DueDate: </label>
                <DxDateEdit @bind-Date="@_dataDuDate.DueDate"
                            NullText="Select a date..."
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                            ShowValidationIcon="true"
                            CssClass="cw-320">
                </DxDateEdit>
                <ValidationMessage For="@(() => _dataDuDate.DueDate)" />
            </div>
            <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
            </div>
        </div>
        </EditForm>           
        </div>
       
    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@isTopicClosed" HeaderText="Topic Close">
    <BodyTemplate Context="PopupContext">
        <div style="padding:10px;">

            <EditForm Model="@_dataTopicClose" OnValidSubmit="@SubmitTopicClose" class="w-800">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-md-12" style="padding-bottom: 12px">
                        <label for="Remarks"> Remarks: </label>
                        <DxMemo @bind-Text="@_dataTopicClose.Remarks"
                                CssClass="cw-480"
                                Rows="5" />
                        <ValidationMessage For="@(() => _dataTopicClose.Remarks)" />
                    </div>
                    <div class="col-md-12">
                        <DxButton SubmitFormOnClick="true" style="float: right;" Text="Submit" RenderStyle="ButtonRenderStyle.Primary" />
                    </div>
                </div>
            </EditForm>

           @* <label>Remarks</label>
            <DxMemo @bind-Text="ClosedMsg"
                    CssClass="cw-480"
                    Rows="5"/>
            <br />
            <DxButton RenderStyleMode="@ButtonRenderStyleMode.Outline"
                      Text="Submit" style="width: 100px !important; float: right;"
                      CssClass="w-100" />*@
        </div>
    </BodyTemplate>
</DxPopup>


<DxPopup @bind-Visible="@isAssignToVisible" HeaderText="Assigned To">
    <BodyTemplate Context="PopupContext">      
        <DxGrid @ref="Grid" Data="_conversationAssignTo"
                KeyFieldName="ID"
                ShowSearchBox="true"
                PagerNavigationMode="PagerNavigationMode.InputBox"
                PageSizeSelectorVisible="true"
                PageSizeSelectorAllRowsItemVisible="true"
                PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                PageSize="20"
                style="height:calc(100vh - 285px);min-height:400px !important"
                CssClass="ch-360">
            <Columns>                          
                <DxGridDataColumn FieldName="RowIndex" Width="35" Caption="#" />
                <DxGridDataColumn FieldName="FirstName" MinWidth="100" />
                <DxGridDataColumn FieldName="LastName" />
            </Columns>
        </DxGrid>

    </BodyTemplate>
</DxPopup>


<DxPopup @bind-Visible="@isAllPlistVisible" HeaderText="Add Participants">
    <BodyTemplate Context="PopupContext">
        <div>
            <button class="btn btn-excel" style="float: right; margin-right: 10px; margin-top: 10px; margin-bottom: 10px;" @onclick="onSubmitPList">
                Add
            </button>            
        </div>
        <DxGrid @ref="Grid" Data="_allparticipant"
                KeyFieldName="UserID"
                ShowSearchBox="true"
                PagerNavigationMode="PagerNavigationMode.InputBox"
                PageSizeSelectorVisible="true"
                PageSizeSelectorAllRowsItemVisible="true"
                PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                PageSize="20"
                style="height:calc(100vh - 285px);min-height:400px !important"
                CssClass="ch-360"
                SelectionMode="GridSelectionMode.Multiple"
                AllowSelectRowByClick="true"
                SelectedDataItemsChanged="@OnSelectedDataItemsChanged"
                SelectedRowsChanged="HandleSelectedRowsChanged">
            <Columns>
                @*<DxDataGridColumn>
                <DxDataGridCheckBoxColumn Field="@nameof(ViewEmployee.UserID)" Caption="Selected" />
                </DxDataGridColumn>*@
                <DxGridSelectionColumn Width="104px" />
                <DxGridDataColumn FieldName="FirstName" MinWidth="100" />
                <DxGridDataColumn FieldName="LastName" />
            </Columns>
        </DxGrid>

    </BodyTemplate>
</DxPopup>

<DxPopup @bind-Visible="@MessageVisible" HeaderText="@MessageHeader">
    <BodyTemplate Context="PopupContext">
        <div class="@((MessageHeader == "Error" ? "TxtRed" : "TxtGreen"))" style="text-align:center; padding: 10px; font-size: 15px;">
            <span> @MessageBody</span>
        </div>
    </BodyTemplate>
</DxPopup>

@*<DxPopup @bind-Visible="@isFileUpload" HeaderText="Attachments">
    <BodyTemplate Context="PopupContext">
        <div style="padding: 15px;">
            <button id="overviewDemoSelectButton" class="btn border-primary btn-primary m-1">Selected File</button>
            <div class="">              
                <DxUpload @ref="uploadComponent" Name="files"                          
                          Visible="@UploadVisible"                        
                          AcceptedFileTypes=@AcceptedFileTypes
                          UploadMode="@UploadMode.OnButtonClick"                        
                          UploadUrl="@GetUploadUrl()"
                          AllowMultiFileUpload="false"
                          ExternalSelectButtonCssSelector="#overviewDemoSelectButton"                         
                          SelectedFilesChanged="@SelectedFilesChanged"
                          FileUploaded="@isUploadSuccess"
                          FileUploadError="@OnUploadError">
                </DxUpload> 
                <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>               
            </div>
        </div>
    </BodyTemplate>
</DxPopup>*@
<style>
    .dxuc-upload-icon {
        display: none; /* or any other style to disable or hide the icon */
    }
</style>
@*
<button class="btn btn-primary" @onclick="ShowToast">Show Toast</button>

<button class="btn btn-primary" @onclick="@(()=>ToastService.ShowSuccess("welcome to ass"))">Show Toast</button>
*@


@code {
    IGrid TOGrid { get; set; }
    private List<ViewEmployee> _employeeItems;
    bool IsOpen { get; set; } = false;
    Selection selection; 
    Selection richSelection { get; set; }
    [Parameter]
    public EventCallback<IToolbar> CustomizeToolbar { get; set; }
    bool ErrorVisible { get; set; } = false;
    string MyError { get; set; }
    [Parameter]
    public List<string> AcceptedFileTypes { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx", ".txt", ".pdf", ".PDF" };
    public List<string> AllowedFileExtensions { get; set; } = new List<string> { "image/*", "video/*", ".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx",".txt",".pdf",".PDF" };
    public DocumentFormat MyDocumentFormat { get; set; }
    private string? BaseUrl;
    private string? FileUrl;
    string documentPath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
    string documentFormat = "docx";
    private ElementReference OfficeContainerRef;
    DxRichEdit richEdit { get; set; }
    DxRichEdit msgrichEdit { get; set; }
    string previewUrl;
    private string documentPreviewUrl;
    private string documentMimeType;
    byte[] documentContent;
    byte[] msgContent;
    DxUpload MyUpload { get; set; }
    bool UploadVisible { get; set; } = true;
    bool AttachmentUploadVisible { get; set; } = false;
    bool isDescription { get; set; } = false;
    private bool uploadSuccess = false;
    IEnumerable<UploadFileInfo> Files { get; set; }
    UploadFileInfo FirstFile { get; set; }
    private class Model
    {
        [Required(ErrorMessage = "Due Date is required")]
        public DateTime? DueDate { get; set; }      
    }
    private class ModelClose
    {
        [Required(ErrorMessage = "Remarks is required")]
        public string? Remarks { get; set; }
    }
    private DxUpload uploadComponent;  

    private Model _dataDuDate = new Model();
    private ModelClose _dataTopicClose = new ModelClose();   
    string ClosedMsg { get; set; }
    DateTime? DateTimeValue { get; set; }
    DxPopup? popup;
    bool PopupVisible { get; set; } = false;
    bool DocPopupVisible { get; set; } = false;
    bool PreviewDocPopup { get; set; } = false;
    private Dictionary<int, bool> itemVisibility = new Dictionary<int, bool>();
    private Dictionary<int, bool> DocitemVisibility = new Dictionary<int, bool>();
    AccordionExpandMode ExpandMode { get; set; } = AccordionExpandMode.SingleOrNone;
    AccordionExpandCollapseAction ExpandCollapseAction { get; set; } = AccordionExpandCollapseAction.HeaderClick;

    string isMenuvisible = "Posts";
    DxTreeView treeView;
    IGrid? Grid { get; set; }
    bool isFileUpload = false;
    bool isDueDate =false;
    bool isTopicClosed = false;
    bool isAllPlistVisible = false;
    bool isAssignToVisible = false;
    bool isComponentVisible = true;
    bool isEnabled { get; set; } = false;
    bool isAddParticipant = false;
    bool isCommand = false;
    bool isCommandTopicClosed = true;
    bool isEllipsis = false;
    private List<Documents>? _topicDocList;
    IEnumerable<(ForumTypes, int)> Items;
    private List<ForumTopics>? _topics;
    private List<ForumTopics>? _TreeView;
    public List<ForumConversations> _discussionList;
    public List<ForumConversations> _replyComment;
    private List<ForumTopics>? _headTopic;
    string FilterString { get; set; }
    private List<TopicParticipant>? _participant;
    TopicParticipant _participantLst { get; set; }
    Documents _documents { get; set; }
    private List<ViewEmployee>? _allparticipant;
    private List<ForumConversationAssignTo>? _conversationAssignTo;
    private List<ViewEmployee>? _selectedlistpartlist;
    NavigationFilterMode FilterMode { get; set; } = NavigationFilterMode.EntireBranch;
    public ForumTypes SelectedNodes { get; set; }
    ForumConversations? Data { get; set; } = new ForumConversations();
    string SelectedGroup = "none";
    public ApplicationUser applicationUser { get; private set; }
    IReadOnlyList<object>? SelectedDataItems { get; set; }
    List<long> participantIds = new List<long>();
    private bool loading;
    bool MessageVisible { get; set; }
    string styleClass = "";
    string MessageHeader = "Error";
    string MessageBody = "";
    Guid? _sessionId;
    private string uploadUrl;   
    private List<ForumAssignToList>? _assigntoItems;

    byte[] myBytes = Encoding.UTF8.GetBytes("Attachments");

    [Parameter]
    public ViewEmployee _employeeDatas { get; set; }
    [Parameter]
    public ApplicationUser _applicationUser { get; set; }

    [Parameter]
    public UploadMode UploadMode { get; set; }
    private string myFile { get; set; }

    int SelectedFilesCount { get; set; }

    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    IEnumerable<UploadFileInfo> Filess { get; set; }

    private async Task ScrollToElement()
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", ".msgOpen");
    }
    protected async void SelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        SelectedFilesCount = files.ToList().Count;       
        await InvokeAsync(StateHasChanged);
        uploadSuccess = false;
        if(files.ToList().Count > 0)
            await UploadFiles();
    }
    protected async void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
    }
    bool UploadVisible1 { get; set; } = false;
    protected void SelectedFilesChanged1(IEnumerable<UploadFileInfo> files)
    {
        Filess = files;
        SelectedFiles.AddRange(files);
        UploadVisible1 = files.ToList().Count > 0;   

        InvokeAsync(StateHasChanged);
    }   
    private void RemoveFile(UploadFileInfo file)
    {
        SelectedFiles.Remove(file);
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
            e.CssClass += "non-selectable-row";
        }
        if (e.ElementType == GridElementType.HeaderCell)
        {
            e.Style = "background-color: rgba(0, 0, 0, 0.08)";
            e.CssClass = "header-bold";
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {            
            await JSRuntime.InvokeVoidAsync("window.addEventListener", "scroll", DotNetObjectReference.Create(this).Value, "HandleScroll");
        }


        if (uploadSuccess)
        {
            // Invoke another function here
            //AnotherFunction();
        }
    }

    [JSInvokable("handleScroll")]
    public void HandleScroll(string scrollDirection)
    {
        if (scrollDirection == "down")
        {
            // Scroll down logic
            var scrollY = JSRuntime.InvokeAsync<int>("window.scrollY").Result;
            var scrollDirection1 = scrollY < 100 ? "up" : "down";

            if (scrollDirection1 == "up")
            {
                //isScrollingUp = true;
                //isScrollingDown = false;
            }
            else
            {
                //isScrollingUp = false;
                //isScrollingDown = true;
            }

            StateHasChanged();



        }
        else if (scrollDirection == "up")
        {
            // Scroll up logic
        }
    }
    private async Task InitializeViewer()
    {
        await JSRuntime.InvokeVoidAsync("loadViewerJS");
        string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";
        // Set the document URL
        string documentUrl = filePath;
        await JSRuntime.InvokeVoidAsync("openViewer", "viewerContainer", documentUrl);
    }
    private async Task isUploadSuccess()
    {
        uploadComponent.RemoveAllFiles();
        isFileUpload = false;
        await LoadData();
    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleUploadSuccess()
    {   

        FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);

        //MyUpload.RemoveAllFiles();
        ///SelectedFiles.Clear();
        await AnotherFunction();
        // await TriggerCancelIcon();
    }

    async Task OnButtonClick()
    {
        var FirstFile = Filess.First();
        MyUpload.RemoveFile(FirstFile);      
    }   
    private async Task TriggerCancelIcon()
    {      
        await JSRuntime.InvokeVoidAsync("myFunction()");
        await JSRuntime.InvokeVoidAsync("createToast(success)");
    }

    private async Task AnotherFunction()
    {
        await LoadData();

    }

    private void OpenFileUpload()
    {
        //uploadComponent.OpenFileDialog();
    }    
    public string GetDocUploadUrl(Guid? sId)
    {
        //var sessionId = Guid.NewGuid();

        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + sId;
        return url.ToString();
    }
    public string GetUploadUrl()
    {
        //var sessionId = Guid.NewGuid();

        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        string url = BaseUrl + "Upload/UploadDocuments?SessionId=" + _sessionId;
        return url.ToString();
    }
    private void closeUploadFiles()
    {
        isFileUpload = false;
        var lst = SelectedFilesCount;
    }
    private async Task UploadFiles()
    {
        //var lst = SelectedFilesCount;    
        byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false);

        var createReq = new CreateForumCoversation
            {

                TopicID = (long.Parse(@SelectedGroup)),
                Message = Data.Message != null ? Data.Message : "Attachments",
                FileData = fileContent.Length == 480 ? myBytes : fileContent,
                AssigntoIds = Data.AssigntoIds.Count() == 0 ? _assigntoItems.Select(s => s.UserID).ToList() : Data.AssigntoIds,
                //FileData = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf).ConfigureAwait(false),
                ParticipantId = applicationUser.UserID,
                ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = _sessionId
            };
        // _sessionId = createReq.SessionId;
        var result = await Mediator.Send(createReq);       
        isFileUpload = false;
        //uploadComponent.UploadAllFiles();
        var rls =   Task.Run(() => uploadComponent.UploadAllFiles());

        await Task.Delay(2000); // Delay for 2 seconds
        await LoadData();
        onRestText();
        closeReply();
        onloadSession();
        //HandleScroll("down");
        await msgrichEdit.NewDocumentAsync();
        //uploadComponent.UploadAllFiles();
    }
    public void ClearUploadedFiles()
    {
        uploadComponent.CancelAllFilesUpload();
    }
    async Task OnFileUploaded(FileUploadEventArgs e)
    {
        var request = new EditDocumentCommand
            {
                AddedByUserId = _applicationUser.AddedByUserID,
                ModifiedByUserId = _applicationUser.ModifiedByUserID,
                SessionId = _employeeDatas.SessionId,
            };
        var response = await Mediator.Send(request);       
        await InvokeAsync(StateHasChanged);

    }
    private void onTopicClosedPop()
    {
        isTopicClosed = true;
    }
    private void showTopicDescription()
    {
        isDescription = true;
    }
     private void hideTopicDescription()
    {
        isDescription = false;
    }
    async void onDueDatePop()
    {
        isDueDate = true;       
    }
    async void SubmitDueDate()
    {
        var UpdateReq = new UpdateTopicDueDate
            {
                ID = long.Parse(@SelectedGroup),
                DueDate = _dataDuDate.DueDate,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };

        var result = await Mediator.Send(UpdateReq);
        if (result == 1)
        {
            isDueDate = false;
            onShowPopupMessage("success", "Updated DueDate Successfully");
        }
        else
        {

        }

    }
    async void SubmitTopicClose()
    {
        var UpdateReq = new UpdateTopicClosed
            {
                ID = long.Parse(@SelectedGroup),
                Remarks = _dataTopicClose.Remarks,
                ModifiedByUserID = applicationUser.UserID,
                ModifiedDate = DateTime.Now
            };
        var result = await Mediator.Send(UpdateReq);   
        if(result == 1)
        {
            isTopicClosed = false;
            onShowPopupMessage("success", "Topic Closed Successfully");
        }
        else
        {

        }
    }

    private async Task SelectionChanged(TreeViewNodeEventArgs e)
    {
        SelectedGroup = e.NodeInfo?.Name;
        //_discussionList = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
        if(SelectedGroup != "0")
        {
            await LoadData();
        }

    }
    public async Task onDeletePlist(long Id)
    {
        _participantLst = _participant.FirstOrDefault(a => a.ID == Id);
        PopupVisible = true;        
    }
    public async Task onPreview(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        string extension = Path.GetExtension(_documents.FilePath);



        if(extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
        {
            MyDocumentFormat = DocumentFormat.OpenXml;
            documentContent = await File.ReadAllBytesAsync(response.FilePath);            
            PreviewDocPopup = true;
        }
        else if(extension.ToLower() == ".txt")
        {
            MyDocumentFormat = DocumentFormat.PlainText;
            documentContent = await File.ReadAllBytesAsync(response.FilePath);
            PreviewDocPopup = true;
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".pdf")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else if (extension.ToLower() == ".jpeg" || extension.ToLower() == ".jpg" || extension.ToLower() == ".png" || extension.ToLower() == ".gif" || extension.ToLower() == ".bmp" || extension.ToLower() == ".svg")
        {
            var url = FileUrl + _documents.FilePath;
            await OpenUrlInNewTab(url);
        }
        else
        {
            onShowPopupMessage("Error", "Document format not supported.");
        }

        //var base_url = BaseUrl;
        //var file_url = FileUrl;

        //var filePath1 = BaseUrl + _documents.FilePath;
        //string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        // documentContent = await File.ReadAllBytesAsync(response.FilePath);

        //string filePathpdf = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.pdf";

        //await JSRuntime.InvokeVoidAsync("pdfInterop.renderPDF", "pdfInterop", filePathpdf);




        //await Task.Delay(10);       
        //await JSRuntime.InvokeVoidAsync("displayOfficeDocument", OfficeContainerRef, filePath);


    }   
    void OnCustomizeToolbar(IToolbar toolbar)
    {
        //// Returns the first group
        //IBarGroup firstGroup = toolbar.Groups[0];
        //// Returns the Table group
        //IBarGroup tableGroup = toolbar.Groups[RichEditToolbarGroupNames.Table];



        toolbar.Groups.Clear();

        // Inserts the File group at the first position in the group collection
        //toolbar.Groups.Add(0, RichEditToolbarGroupNames.File);
        toolbar.Groups.Add(0, RichEditToolbarGroupNames.Undo);
        toolbar.Groups.Add(1, RichEditToolbarGroupNames.Font);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Table);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Picture);
        toolbar.Groups.Add(2, RichEditToolbarGroupNames.Paragraph);




    }

    void OnContentRemoved(ContentRemovedEventArgs e)
    {
        // Handle the content removal event here
    }
    async Task OnSelectionChanged(Selection newSelection)
    {
        /* Surround the code that contains an asynchronous operation with a try-catch block to handle
        the OperationCanceledException. This exception is thrown when an asynchronous operation is canceled. */
        try
        {
            richSelection = newSelection;
            // Your code
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    async Task OnmsgContentChanged(byte[] content)
    {

        /* Surround the code that contains an asynchronous operation with a try-catch block to handle
        the OperationCanceledException. This exception is thrown when an asynchronous operation is canceled. */
        try
        {
            msgContent = content;

            //var createReq = new CreateForumCoversation
            //    {

            //        TopicID = (long.Parse(@SelectedGroup)),
            //        Message = Data.Message != null ? Data.Message : "Attachments",
            //        FileData = content,
            //        ParticipantId = applicationUser.UserID,
            //        ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
            //        StatusCodeID = 1,
            //        AddedByUserID = applicationUser.UserID,
            //        AddedDate = DateTime.Now,
            //        SessionId = Guid.NewGuid()
            //    };
            //var result = await Mediator.Send(createReq);

            //if (result == 1)
            //{               
            //    await LoadData();
            //    onRestText();
            //    closeReply();
            //}
            //else
            //{

            //}




            //await File.WriteAllBytesAsync("C:\\Users\\Public\\annual-report.rtf", documentContent);
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    async Task OnDocumentContentChanged(byte[] content)
    {

        var request = new DownloadFileRequest
            {
                FileName = _documents.FileName,
                FilePath = _documents.FilePath,
                ContentType = _documents.ContentType
            };

        var response = await Mediator.Send(request);

        // string filePath = @"D:\Projects\SW.Portal.Solutions\DocumentApi\AppUpload\Documents\21c984af-3b75-4284-8ae1-8513d5df003e\21c984af-3b75-4284-8ae1-8513d5df003e.docx";
        string filePath = response.FilePath;

        string extension = Path.GetExtension(response.FilePath);


        try
        {
            if (extension.ToLower() == ".doc" || extension.ToLower() == ".docx")
            {
                MyDocumentFormat = DocumentFormat.OpenXml;
                documentContent = content;
                await File.WriteAllBytesAsync(filePath, documentContent);
            }
            else if (extension.ToLower() == ".txt")
            {
                MyDocumentFormat = DocumentFormat.PlainText;
                documentContent = content;
                await File.WriteAllBytesAsync(filePath, documentContent);
            }
            else if(extension.ToLower() == ".pdf")
            {
                var url = FileUrl + _documents.FilePath;
                await OpenUrlInNewTab(url);
            }
            else
            {
                onShowPopupMessage("error", "Document format not supported.");
            }

            //documentContent = content;
            //await File.WriteAllBytesAsync(filePath, documentContent);           
        }
        catch (OperationCanceledException e)
        {
            Console.WriteLine($"{nameof(OperationCanceledException)} thrown with message: {e.Message}");
        }
    }
    private async Task OpenUrlInNewTab(string url)
    {
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }
    public async Task onDocDownload(long Id)
    {
        var lst =  _topicDocList.FirstOrDefault(a => a.DocumentId == Id);


        var url = FileUrl + lst.FilePath;
        await OpenUrlInNewTab(url);
        //NavigationManager.NavigateTo(url, forceLoad: true);

        //var request = new DownloadFileRequest
        //    {
        //        FileName = lst.FileName, 
        //        FilePath = lst.FilePath, 
        //        ContentType = lst.ContentType
        //    };

        //var response = await Mediator.Send(request);

        // Trigger file download
        // await JSRuntime.InvokeVoidAsync("downloadFile", response.FileName, response.FileData, response.ContentType,"");
    }
    public async Task onDocDelete(long Id)
    {
        _documents = _topicDocList.FirstOrDefault(a => a.DocumentId == Id);
        DocPopupVisible = true;
    }
    private async void assignedList(long Id)
    {
        _conversationAssignTo = await Mediator.Send(new GetConversationAssignTo(Id));
        if (_conversationAssignTo.Count > 0)
        {
            isAssignToVisible = true;
        }
        else
        {
            toastService.ShowToast("No data found", AC.SD.Core.Services.ToastLevel.Error);
            //isAssignToVisible = false;
        }
    }
    private async void SubmitDocDelete(long Id)
    {
        if (Id > 0)
        {
            var request = new DeleteDoc(Id);

            var response = await Mediator.Send(request);
            DocPopupVisible = false;
            isAllPlistVisible = false;
            await loadTopicDocList();
            onShowPopupMessage("success", "Document has been deleted successfully");
        }
    }
    private async void SubmitDelete(long Id)
    {        
        if (Id > 0)
        {
            var request = new DeleteParticipant
                {
                    ID = Id,

                };
            var response = await Mediator.Send(request);
            PopupVisible = false;
            isAllPlistVisible = false;
            await LoadGetPList();
            onShowPopupMessage("success", "Participant has been deleted successfully");
        }
    }
    private async void onShowPopupMessage(string headerText, string bodyText)
    {
        MessageVisible = true;
        MessageBody = bodyText;
        MessageHeader = headerText;
        loading = false;
        StateHasChanged();
    }
    async void ClosePopup()
    {
        PopupVisible = false;
        DocPopupVisible = false;
    }

    private void ToggleItemVisibility(int id)
    {
        if (itemVisibility.ContainsKey(id))
        {
            itemVisibility[id] = !itemVisibility[id];
        }
        else
        {
            itemVisibility.Add(id, true);
        }
    }
    private void ToggleDocItemVisibility(int id)
    {
        if (DocitemVisibility.ContainsKey(id))
        {
            DocitemVisibility[id] = !DocitemVisibility[id];
        }
        else
        {
            DocitemVisibility.Add(id, true);
        }
    }
    private List<string> data;
    private async Task loadTopicDocList()
    {
        if(long.Parse(@SelectedGroup) > 0)
        {
            //await JSRuntime.InvokeAsync<string>("showLoading");
            _topicDocList = await Mediator.Send(new GetTopicDocList(long.Parse(@SelectedGroup)));          
            //await JSRuntime.InvokeAsync<string>("hideLoading");
        }

    }
    private async Task LoadData()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        _discussionList = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));

        _assigntoItems = await Mediator.Send(new GetAssignToList(long.Parse(@SelectedGroup)));        
        var topicToList = await Mediator.Send(new GetTopicToList(long.Parse(@SelectedGroup)));
        if (topicToList != null)
        {
            Data.AssigntoIds = topicToList.Select(s => s.UserID).ToList();
        }

        // Data.AssigntoIds = _assigntoItems.Take(1);


        OnMenuItemClick(isMenuvisible);
        // Generate index IDs for each row
        //var indexedDiscussionList = _discussionList.Select((item, index) => new
        //{
        //    IndexId = index + 1, // Adding 1 to make the index IDs start from 1
        //    Item = item
        //}).ToList();

        _headTopic = await Mediator.Send(new GetByIdTopics(long.Parse(@SelectedGroup)));


        isCommandTopicClosed = _headTopic[0].Status == "closed" ? false : true;

        isEnabled = true;
        isEllipsis = true;
        isCommand = true;
        _participant = await Mediator.Send(new GetParticipantsList(long.Parse(@SelectedGroup)));      

        //_participant[1].IsEnabled = false; // Disable the second row

        await JSRuntime.InvokeAsync<string>("hideLoading");
        //var plist = await Mediator.Send(new GetAllEmployeeListQuery());
        // _participant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();
    }
    void OnSelectedDataItemsChanged(IReadOnlyList<object> selectedDataItems)
    {
        SelectedDataItems = selectedDataItems;
    }
    private async Task onAddPlist()
    {
        await LoadAllParticipantList();
    }
    private async Task LoadAllParticipantList()
    {
        var plist = await Mediator.Send(new GetAllParticipantListQuery(long.Parse(@SelectedGroup)));
        _allparticipant = plist.Where(c => c.UserID != applicationUser.UserID).ToList();

        isAllPlistVisible = true;
    }
    private async Task LoadGetPList()
    {
        _participant = await Mediator.Send(new GetParticipantsList(long.Parse(@SelectedGroup)));
        SelectedDataItems = null;
        participantIds.Clear();
    }
    private async Task onSubmitPList()
    {
        var lst = SelectedDataItems;


        if (SelectedDataItems != null)
        {
            foreach (object item in SelectedDataItems)
            {
                if (item is ViewEmployee employee)
                {
                    participantIds.Add((long)employee.UserID);
                }
            }
        }

        string participantidsString = string.Join(",", participantIds);


        var createReq = new CreateTopicParticipant
            {
                PList = participantidsString,
                TopicId = long.Parse(@SelectedGroup),
                UserId = applicationUser.UserID,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = Guid.NewGuid()  
            };
        var result = await Mediator.Send(createReq);

        isAllPlistVisible = false;
        await LoadGetPList();
    }
    void OnRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "UserID");       
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        BaseUrl = Configuration["DocumentsUrl:BaseUrl"];
        FileUrl = Configuration["DocumentsUrl:FileUrl"];

        await JSRuntime.InvokeAsync<string>("showLoading");
        var model = await Mediator.Send(new GetAllEmployeeListQuery());
        _employeeItems = model;
        await JSRuntime.InvokeAsync<string>("hideLoading");

        onloadSession();
       
        //var model = await Mediator.Send(new GetAllForumTypes());
        //_types = model;
        //Items = model.Select((item, index) => (item, index));

        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");

        _topics = await Mediator.Send(new GetUserForumTopics(applicationUser.UserID));

        _TreeView = await Mediator.Send(new GetTreeList(applicationUser.UserID));

        //_discussionList = await Mediator.Send(new GetDiscussionList(38));
    }
    void onloadSession()
    {
        _sessionId = Guid.NewGuid();
    }
    void getConversation()
    {

    }
    private async Task onreply(long id)
    {
        if (id > 0)
        {
            _replyComment = _discussionList.Where(c => c.ID == id).ToList();
        }
    }
    void closeReply()
    {
        _replyComment = null;
    }
    async void OnMenuItemClick(string text)
    {
        isMenuvisible = text;

        if(text == "Posts")
        {
            isComponentVisible = true;
            isAddParticipant = false;
            isEllipsis = true;
            isCommand = true;
        }
        else if (text == "Files")
        {
            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
            await loadTopicDocList();
        }
        else if (text == "AddParticipants")
        {
            isAddParticipant = true;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
        }
        else
        {
            isAddParticipant = false;
            isComponentVisible = false;
            isEllipsis = false;
            isCommand = false;
        }
    }

    private void OnSelectedNodeChangeds(ForumTypes item)
    {
        SelectedNodes = item;
    }
    private async Task HandleValidSubmit()
    {        
        //var contentdd = msgContent;
        //byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
        byte[] fileContent = await msgrichEdit.ExportDocumentAsync(DocumentFormat.Rtf);
        string htmlString = string.Empty;
        var len = fileContent.Length;
        //documentContent = null;            


        htmlString = Encoding.UTF8.GetString(fileContent);
        //if (fileContent != null)
        //{
        //    // Convert the RTF byte array to HTML string
        //    htmlString = Rtf.ToHtml(fileContent);
        //}

        if(fileContent.Length == 480)
        {
            toastService.ShowToast("Please Enter Messages", AC.SD.Core.Services.ToastLevel.Error);
            return;
        }    


        var createReq = new CreateForumCoversation
            {

                TopicID = (long.Parse(@SelectedGroup)),
               // Message = Data.Message != null ? Data.Message : "Attachments",
                Message = htmlString,
                //FileData = Data.Message != null ? Encoding.UTF8.GetBytes(Data.Message) : Encoding.UTF8.GetBytes("Attachments"),
                FileData = fileContent,
                AssigntoIds = Data.AssigntoIds.Count() == 0 ? _assigntoItems.Select(s => s.UserID).ToList() : Data.AssigntoIds,
                ParticipantId = applicationUser.UserID,
                ReplyId = _replyComment != null && _replyComment.Any() ? _replyComment[0].ID : 0,
                StatusCodeID = 1,
                AddedByUserID = applicationUser.UserID,
                AddedDate = DateTime.Now,
                SessionId = _sessionId
            };
        var result = await Mediator.Send(createReq);

        if (result > 1)
        {
            //var getRec = await Mediator.Send(new GetDiscussionList(long.Parse(@SelectedGroup)));
            //sessionId = getRec.Last().SessionId;

            //uploadUrl = GetUploadUrl();           
            //uploadComponent.UploadAllFiles();

            uploadComponent.UploadAllFiles();
            await LoadData();
            onRestText();
            closeReply();
            onloadSession();
           // HandleScroll("down");
            await msgrichEdit.NewDocumentAsync();
        }
        else
        {

        }
    }
    private void onRestText()
    {
        Data.Message = null;
    }

    void HandleInvalidSubmit()
    {

    }  
}