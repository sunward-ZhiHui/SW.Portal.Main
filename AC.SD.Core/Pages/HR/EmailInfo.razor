@using Application.Command.EmployeeEmailInfos;
@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities.Views;
@using global::Core.Entities;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using global::Core.Repositories.Query;
@inject ILocalStorageService<ApplicationUser> _localStorageService

<DxGrid @ref="EmailGrid"
        Data="_EmployeeEmailInfoItems"
        KeyFieldName="EmployeeEmailInfoID"
        EditModelSaving="Grid_EditModelSavingEmailInfo"
        DataItemDeleting="Grid_DataItemDeletingEmailInfo"
        CustomizeEditModel="Grid_CustomizeEditModelEmailInfo"
        ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
        PagerNavigationMode="PagerNavigationMode.InputBox"
        PageSizeSelectorVisible="true"
        PageSizeSelectorAllRowsItemVisible="true"
        PageSizeSelectorItems="@(new int[] { 5,10,20 })"
        PageSize="20"
        SelectionMode="GridSelectionMode.Multiple"
        SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages"
        ValidationEnabled="true"
        AutoExpandAllGroupRows="true"
        CssClass="ch-360">
    <Columns>

        <DxGridDataColumn FieldName="EmailGuide" Caption="Email Guide" MinWidth="80" />
        <DxGridDataColumn FieldName="Subscription" Caption="Subscription" MinWidth="80" />
        <DxGridCommandColumn Width="150px" NewButtonVisible="true" EditButtonVisible="true">
            <CellDisplayTemplate>
                @{
                    <DxButton Click="() => EmailGrid.StartEditDataItemAsync(context.DataItem)"
                          Text="Edit" RenderStyle="ButtonRenderStyle.Link" RenderStyleMode="ButtonRenderStyleMode.Contained" />
                    <DxButton Click="() => EmailGrid.ShowDataItemDeleteConfirmation(context.DataItem)"
                          Text="Delete" RenderStyle="ButtonRenderStyle.Link" RenderStyleMode="ButtonRenderStyleMode.Contained" />
                    <NavLink href="javascrtpit:void(0);" @onclick="@(() => OpenEmailPopUp((View_EmployeeEmailInfo)context.DataItem))" RenderStyle="@ButtonRenderStyle.Secondary">Forward To</NavLink>
                    <NavLink href="javascrtpit:void(0);" @onclick="@(() => OpenEmailAuthPopUp((View_EmployeeEmailInfo)context.DataItem))" RenderStyle="@ButtonRenderStyle.Secondary" style="padding:5px;">Authority</NavLink>
                }
            </CellDisplayTemplate>
        </DxGridCommandColumn>
    </Columns>
    <EditFormTemplate Context="EditFormContext">
        @{
            var responseOtherData = (View_EmployeeEmailInfo)EditFormContext.EditModel;
        }
        <DxFormLayout CssClass="w-100">
            <DxFormLayoutItem Caption="Email Guide" ColSpanMd="6">
                <DxComboBox Data="@_view_ApplicationMasterDetailsEmailGuide"
                            NullText="Select Duty TYpe..."
                            FilteringMode="DataGridFilteringMode.Contains"
                            TextFieldName="Value"
                            ValueFieldName="ApplicationMasterDetailID"
                            @bind-Value="@responseOtherData.EmailGuideID" ShowValidationIcon="true" />
                <ValidationMessage For="@(() => responseOtherData.EmailGuideID)" />
            </DxFormLayoutItem>
            <DxFormLayoutItem Caption="Subscription" ColSpanMd="6">
                <DxComboBox Data="@_view_ApplicationMasterDetailsSubscription"
                            NullText="Select Duty TYpe..."
                            FilteringMode="DataGridFilteringMode.Contains"
                            TextFieldName="Value"
                            ValueFieldName="ApplicationMasterDetailID"
                            @bind-Value="@responseOtherData.SubscriptionID" ShowValidationIcon="true" />
                <ValidationMessage For="@(() => responseOtherData.SubscriptionID)" />
            </DxFormLayoutItem>
        </DxFormLayout>
    </EditFormTemplate>
</DxGrid>
<DxPopup @bind-Visible="@PopupForwardToVisible"
         CloseOnOutsideClick="false"
         HeaderText="Forward To "
         ShowFooter="false">
    <BodyTemplate Context="PopupContext">
        @*<DxWindow @ref=windowRef1
        AllowResize="true"
        ShowCloseButton="true"
        CloseOnEscape="true"
        HeaderText="Authority"
        FooterText="Footer"
        ShowFooter="false"
        Width="max(50vw, 500px)"
        MinWidth="500"
        MinHeight="400"
        MaxWidth="1200"
        MaxHeight="900"
        @bind-Visible=PopupForwardToVisible>
        <BodyTextTemplate Context="PopupContext">*@
        <div style="padding: 20px">
            <DxGrid @ref="GridEmail"
                    Data="_employeeEmailInfoForwardItems"
                    KeyFieldName="EmployeeEmailInfoForwardID"
                    EditModelSaving="Grid_EditModelSavingEmail"
                    DataItemDeleting="Grid_DataItemDeletingEmail"
                    CustomizeEditModel="Grid_CustomizeEditModelEmail"
                    ShowSearchBox="true"
                    PagerNavigationMode="PagerNavigationMode.InputBox"
                    PageSizeSelectorVisible="true"
                    PageSizeSelectorAllRowsItemVisible="true"
                    PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                    PageSize="20"
                    SelectionMode="GridSelectionMode.Multiple"
                    SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages"
                    ValidationEnabled="true"
                    AutoExpandAllGroupRows="true"
                    CssClass="ch-360">
                <Columns>
                    <DxGridDataColumn FieldName="EmailAddress" Caption="Email Address" MinWidth="80" />
                    <DxGridCommandColumn Width="150px">
                    </DxGridCommandColumn>
                </Columns>
                <EditFormTemplate Context="EditFormContext">
                    @{
                        var employeeEmailInfoForwardData = (EmployeeEmailInfoForward)EditFormContext.EditModel;
                    }
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutItem Caption="Email Address" ColSpanMd="12">
                            <DxTextBox @bind-Text="@employeeEmailInfoForwardData.EmailAddress" ShowValidationIcon="true" />
                            <ValidationMessage For="@(() => employeeEmailInfoForwardData.EmailAddress)" />
                        </DxFormLayoutItem>
                    </DxFormLayout>
                </EditFormTemplate>
            </DxGrid>
        </div>
    </BodyTemplate>
</DxPopup>
@* </BodyTextTemplate>
</DxWindow>*@
@*<DxWindow @ref=windowRef
          AllowResize="true"
          ShowCloseButton="true"
          CloseOnEscape="true"
          HeaderText="Authority"
          FooterText="Footer"
          ShowFooter="false"
          Width="max(50vw, 500px)"
          MinWidth="500"
          MinHeight="400"
          MaxWidth="1200"
          MaxHeight="900"
          @bind-Visible=PopupEmailInfoAuthorityVisible>
    <BodyTextTemplate Context="PopupContext">*@

<DxPopup @bind-Visible="@PopupEmailInfoAuthorityVisible"
         CloseOnOutsideClick="false"
         HeaderText="Authority"
         ShowFooter="false">
    <BodyTemplate Context="PopupContext">
        <div style="padding: 20px">
            <DxGrid @ref="GridEmailAuth"
                    Data="_employeeEmailInfoAuthorityItems"
                    KeyFieldName="EmployeeEmailInfoAuthorityID"
                    EditModelSaving="Grid_EditModelSavingEmailAuth"
                    DataItemDeleting="Grid_DataItemDeletingEmailAuth"
                    CustomizeEditModel="Grid_CustomizeEditModelEmailAuth"
                    ShowSearchBox="true"
                    PagerNavigationMode="PagerNavigationMode.InputBox"
                    PageSizeSelectorVisible="true"
                    PageSizeSelectorAllRowsItemVisible="true"
                    PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                    PageSize="20"
                    SelectionMode="GridSelectionMode.Multiple"
                    SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages"
                    ValidationEnabled="true"
                    AutoExpandAllGroupRows="true"
                    CssClass="ch-360">
                <Columns>
                    <DxGridDataColumn FieldName="Name" MinWidth="80" />
                    <DxGridDataColumn FieldName="Description" MinWidth="80" />
                    <DxGridDataColumn FieldName="Purpose" MinWidth="80" />
                    <DxGridCommandColumn Width="80">
                    </DxGridCommandColumn>
                </Columns>
                <EditFormTemplate Context="EditFormContext">
                    @{
                        var employeeEmailAuthData = (EmployeeEmailInfoAuthority)EditFormContext.EditModel;
                    }
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutItem Caption="Name" ColSpanMd="12">
                            <DxMemo @bind-Text="@employeeEmailAuthData.Name" ShowValidationIcon="true" />
                            <ValidationMessage For="@(() => employeeEmailAuthData.Name)" />
                        </DxFormLayoutItem>
                        <DxFormLayoutItem Caption="Description" ColSpanMd="12">
                            <DxMemo @bind-Text="@employeeEmailAuthData.Description" ShowValidationIcon="true" />
                        </DxFormLayoutItem>
                        <DxFormLayoutItem Caption="Purpose" ColSpanMd="12">
                            <DxMemo @bind-Text="@employeeEmailAuthData.Purpose" ShowValidationIcon="true" />
                        </DxFormLayoutItem>
                    </DxFormLayout>
                </EditFormTemplate>
            </DxGrid>
        </div>
        @*</BodyTextTemplate>
        </DxWindow>*@
    </BodyTemplate>
</DxPopup>
@code {
    [Parameter]
    public Guid? SessionIds { get; set; }
    DxWindow windowRef;
    DxWindow windowRef1;
    ElementReference popupTarget;
    ElementReference popupTarget1;
    [Parameter]
     public long? EmployeeIds { get; set; }
    private List<View_EmployeeEmailInfo> _EmployeeEmailInfoItems;
    private List<EmployeeEmailInfoForward> _employeeEmailInfoForwardItems;
    private List<EmployeeEmailInfoAuthority> _employeeEmailInfoAuthorityItems;
    bool PopupForwardToVisible { get; set; }
    bool PopupEmailInfoAuthorityVisible { get; set; }
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetailsEmailGuide;
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetailsSubscription;
    public ApplicationUser applicationUser { get; private set; }
    IGrid EmailGrid { get; set; }
    IGrid GridEmail { get; set; }
    IGrid GridEmailAuth { get; set; }
    long employeeEmailInfoID = 0;
    protected override async Task OnInitializedAsync()
    {
        var Texts = SessionIds;
        if (EmployeeIds > 0)
        {
            applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
            _EmployeeEmailInfoItems = await Mediator.Send(new GetEmployeeEmailInfoQuery(EmployeeIds));
            _view_ApplicationMasterDetailsEmailGuide = await Mediator.Send(new GetAllApplicationMasterDetailQuery(327));
            _view_ApplicationMasterDetailsSubscription = await Mediator.Send(new GetAllApplicationMasterDetailQuery(328));
        }
    }
    async Task UpdateDataAsyncEmailInfo()
    {
        _EmployeeEmailInfoItems = await Mediator.Send(new GetEmployeeEmailInfoQuery(EmployeeIds));
    }
    void Grid_CustomizeEditModelEmailInfo(GridCustomizeEditModelEventArgs e)
    {
        if (EmployeeIds > 0)
        {
            var newplant = (View_EmployeeEmailInfo)e.EditModel;
            if (e.IsNew)
            {
                newplant.EmployeeID = EmployeeIds;
                newplant.EmailGuideID = null;
                newplant.SubscriptionID = null;

            }
            else
            {

            }
        }
    }
    async Task Grid_EditModelSavingEmailInfo(GridEditModelSavingEventArgs e)
    {
        var editablePlant = (View_EmployeeEmailInfo)e.EditModel;
        if (e.IsNew)
        {
            var request = new CreateEmployeeEmailInfoCommand
                {
                    EmployeeID = EmployeeIds,
                    SubscriptionID = editablePlant.SubscriptionID,
                    EmailGuideID = editablePlant.EmailGuideID,
                };
            await Mediator.Send(request);
            await UpdateDataAsyncEmailInfo();
        }
        else
        {
            await UpdatePlantAsyncEmailInfo(editablePlant);
        }

    }
    async Task Grid_DataItemDeletingEmailInfo(GridDataItemDeletingEventArgs e)
    {
        var editablePlant = (View_EmployeeEmailInfo)e.DataItem;
        var request = new DeleteEmployeeEmailInfoCommand(editablePlant.EmployeeEmailInfoID);
        await Mediator.Send(request);
        await UpdateDataAsyncEmailInfo();
    }
    async Task UpdatePlantAsyncEmailInfo(View_EmployeeEmailInfo editablePlant)
    {
        var request = new EditEmployeeEmailInfoCommand
            {
                EmployeeEmailInfoID = editablePlant.EmployeeEmailInfoID,
                EmployeeID = EmployeeIds,
                SubscriptionID = editablePlant.SubscriptionID,
                EmailGuideID = editablePlant.EmailGuideID,
            };
        await Mediator.Send(request);
        await UpdateDataAsyncEmailInfo();
    }




    async void OpenEmailPopUp(View_EmployeeEmailInfo Id)
    {
        //await windowRef1.ShowAtAsync(popupTarget1);
        employeeEmailInfoID = Id.EmployeeEmailInfoID;
        PopupForwardToVisible = true;
        StateHasChanged();
        await UpdateDataEmailAsync();
    }
    async Task UpdateDataEmailAsync()
    {
        _employeeEmailInfoForwardItems = await Mediator.Send(new GetEmployeeEmailInfoForwardQuery(employeeEmailInfoID));
    }
    void Grid_CustomizeEditModelEmail(GridCustomizeEditModelEventArgs e)
    {
        var newplant = (EmployeeEmailInfoForward)e.EditModel;
        if (e.IsNew)
        {
            newplant.EmployeeEmailInfoID = employeeEmailInfoID;
            newplant.EmailAddress = null;

        }
        else
        {

        }
    }
    async Task Grid_EditModelSavingEmail(GridEditModelSavingEventArgs e)
    {
        var editablePlant = (EmployeeEmailInfoForward)e.EditModel;
        if (e.IsNew)
        {
            var request = new CreateEmployeeEmailInfoForwardCommand
                {
                    EmployeeEmailInfoID = employeeEmailInfoID,
                    EmailAddress = editablePlant.EmailAddress,
                };
            await Mediator.Send(request);
            await UpdateDataEmailAsync();
        }
        else
        {
            await UpdatePlantAsyncEmail(editablePlant);
        }

    }
    async Task Grid_DataItemDeletingEmail(GridDataItemDeletingEventArgs e)
    {
        var editablePlant = (EmployeeEmailInfoForward)e.DataItem;
        var request = new DeleteEmployeeEmailInfoForwardCommand(editablePlant.EmployeeEmailInfoForwardID);
        await Mediator.Send(request);
        await UpdateDataEmailAsync();
    }
    async Task UpdatePlantAsyncEmail(EmployeeEmailInfoForward editablePlant)
    {
        var request = new EditEmployeeEmailInfoForwardCommand
            {
                EmployeeEmailInfoForwardID = editablePlant.EmployeeEmailInfoForwardID,
                EmployeeEmailInfoID = employeeEmailInfoID,
                EmailAddress = editablePlant.EmailAddress,
            };
        await Mediator.Send(request);
        await UpdateDataEmailAsync();
    }








    async void OpenEmailAuthPopUp(View_EmployeeEmailInfo Id)
    {
        //await windowRef.ShowAtAsync(popupTarget);
        employeeEmailInfoID = Id.EmployeeEmailInfoID;
        PopupEmailInfoAuthorityVisible = true;
        StateHasChanged();
        await UpdateDataEmailAuthAsync();
    }
    async Task UpdateDataEmailAuthAsync()
    {
        _employeeEmailInfoAuthorityItems = await Mediator.Send(new GetEmployeeEmailInfoAuthorityQuery(employeeEmailInfoID));
    }
    void Grid_CustomizeEditModelEmailAuth(GridCustomizeEditModelEventArgs e)
    {
        var newplant = (EmployeeEmailInfoAuthority)e.EditModel;
        if (e.IsNew)
        {
            newplant.EmployeeEmailInfoID = employeeEmailInfoID;
            newplant.Name = "";
            newplant.Description = "";
            newplant.Purpose = "";
        }
        else
        {

        }
    }
    async Task Grid_EditModelSavingEmailAuth(GridEditModelSavingEventArgs e)
    {
        var editablePlant = (EmployeeEmailInfoAuthority)e.EditModel;
        if (e.IsNew)
        {
            var request = new CreateEmployeeEmailInfoAuthorityCommand
                {
                    EmployeeEmailInfoID = employeeEmailInfoID,
                    Name = editablePlant.Name,
                    Description = editablePlant.Description,
                    Purpose = editablePlant.Purpose,
                };
            await Mediator.Send(request);
            await UpdateDataEmailAuthAsync();
        }
        else
        {
            await UpdatePlantAsyncEmailAuth(editablePlant);
        }
    }
    async Task Grid_DataItemDeletingEmailAuth(GridDataItemDeletingEventArgs e)
    {
        var editablePlant = (EmployeeEmailInfoAuthority)e.DataItem;
        var request = new DeleteEmployeeEmailInfoAuthorityCommand(editablePlant.EmployeeEmailInfoAuthorityID);
        await Mediator.Send(request);
        await UpdateDataEmailAuthAsync();
    }
    async Task UpdatePlantAsyncEmailAuth(EmployeeEmailInfoAuthority editablePlant)
    {
        var request = new EditEmployeeEmailInfoAuthorityCommand
            {
                EmployeeEmailInfoAuthorityID = editablePlant.EmployeeEmailInfoAuthorityID,
                EmployeeEmailInfoID = employeeEmailInfoID,
                Name = editablePlant.Name,
                Description = editablePlant.Description,
                Purpose = editablePlant.Purpose,
            };
        await Mediator.Send(request);
        await UpdateDataEmailAuthAsync();
    }
}
