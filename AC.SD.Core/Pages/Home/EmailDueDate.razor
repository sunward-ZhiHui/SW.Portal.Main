@using Application.Commands;
@using Application.Common.Helper;
@using Application.Queries;
@using Application.Response;
@using Microsoft.AspNetCore.Http;
@using global::Core.Repositories.Query;
@using global::Core.Entities;
@using MediatR
@inject IMediator Mediator
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IJSRuntime JSRuntime;
@inject NavigationManager NavigationManager
<div class="card w-100" style="margin-bottom:10px;">
    <div class="card-body p-0">
        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Reload" IconCssClass="fa fa-refresh" Click="@onRefresh"/>
                @* <DxMenuItem Text="Message" IconCssClass="fa fa-commenting" Click="@onReplyMsg" Enabled="@ReplyMsgEnabled" /> *@
            </Items>
        </DxMenu>
    </div>
</div>
<DxGrid @ref="EmailDueDateGrid" SearchText="@GridSearchText"
        Data="_emailTopicDueDate"
        ShowGroupPanel="true"
        VirtualScrollingEnabled="true"
        FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
        KeyFieldName="ID"
        CustomizeElement="Grid_CustomizeElement"
        PagerNavigationMode="PagerNavigationMode.InputBox"
        PageSizeSelectorVisible="true"
        PageSizeSelectorAllRowsItemVisible="true"
        PageSizeSelectorItems="@(new int[] { 5,10,20 })"
        PageSize="20"
        ValidationEnabled="true"
        AutoExpandAllGroupRows="true"
        CssClass="w-100" style="height: calc(100vh - 285px);"        
        RowClick="OnRowClick"
        RowDoubleClick="OnEmailDueRowClick"
        ColumnResizeMode="GridColumnResizeMode.NextColumn"
        AllowSelectRowByClick="true">
    <Columns>    
        <DxGridDataColumn FieldName="TopicName" Caption="Main Subject"  FixedPosition="GridColumnFixedPosition.Left" MinWidth="250" />
        <DxGridDataColumn FieldName="Name" Caption="Subject Name" MinWidth="250" />
        <DxGridDataColumn FieldName="FirstName" Caption="Name" MinWidth="100" />
        <DxGridDataColumn FieldName="DueDate" Width="180">
            <CellDisplayTemplate>
                @{
                    var item = (EmailTopics)context.DataItem;
                }
                <span style="font-size:11px; margin-left: 5px; margin-right: 15px;"> @Application.Common.Helper.Helper.FormatDateTime(item.DueDate)</span>
            </CellDisplayTemplate>
        </DxGridDataColumn>
       @*  <DxGridDataColumn FieldName="AssignFrom" Caption="Assign From" MinWidth="100" />
        <DxGridDataColumn FieldName="AssignTo" Caption="Assign To" MinWidth="100" />
        <DxGridDataColumn FieldName="Replymsg" Caption="Msg" Width="80"> 
            <CellDisplayTemplate>
                @{
                    var item = (EmailTopics)context.DataItem;
                }
                @if(item.Replymsg != null)
                {
                    <span class="fa fa-commenting" @onclick="@(() => onReplyMsg())"></span>
                }
                
            </CellDisplayTemplate>
        </DxGridDataColumn> *@
    </Columns>
  @*   <DetailRowTemplate>
        <EmailSubDueDate Items="(EmailTopics)context.DataItem" />
    </DetailRowTemplate> *@
    <TotalSummary>
        <DxGridSummaryItem SummaryType="GridSummaryItemType.Count" FieldName="ID" />
    </TotalSummary>
</DxGrid>

<DxPopup @ref="popup" HeaderText="CRT" ShowCloseButton="true"  Width="max(25vw, 550px)" @bind-Visible="@Previewmsg">
    <BodyContentTemplate>
        <div style="height: calc(100vh - 250px);overflow:auto;overflow-x:hidden;">
            @{
                byte[] htmlBinaryData = _selectedItems.Replymsg; // Your HTML binary data
                string htmlContent = System.Text.Encoding.UTF8.GetString(htmlBinaryData);
                @((MarkupString)htmlContent)
            }
        </div>
    </BodyContentTemplate>
</DxPopup>

@code {
    DxPopup? popup;
    bool Previewmsg { get; set; } = false;
    public bool ReplyMsgEnabled { get; set; } = false;
    IGrid EmailDueDateGrid { get; set; }
    private EmailSubDueDate? RefSubAssignAll { get; set; }
    private List<EmailTopics>? _emailTopicDueDate;
    private EmailTopics? _selectedItems;
    string SelectedGroup = "none";
    string SelectedReplyId = "none";
    public string filterrowname { get; set; }
    public long RTopicId = 0;
    public ApplicationUser applicationUser { get; private set; }
    [Parameter]
    public Action<string> ATopicId { get; set; }
    [Parameter]
    public string? GridSearchText { get; set; }
    [Parameter]
    public Action<string> SubViewAllTopicId { get; set; }

    async Task onRefresh()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        _emailTopicDueDate = await Mediator.Send(new GetEmailTopicHome(applicationUser.UserID));
        await JSRuntime.InvokeAsync<string>("hideLoading");
        EmailDueDateGrid.Reload();
    }
    async Task onReplyMsg()
    {
        var rlmsg = _selectedItems;
        Previewmsg = true;
    }
    protected override async Task OnInitializedAsync()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _emailTopicDueDate = await Mediator.Send(new GetEmailTopicHome(applicationUser.UserID));
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
            e.CssClass += "non-selectable-row";
        }
    }
    void OnRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ID");
        _selectedItems = _emailTopicDueDate.FirstOrDefault(f => f.ID == (long?)UniqueId);
        ReplyMsgEnabled = true;
        StateHasChanged();

    }
    async Task OnEmailDueRowClick(GridRowClickEventArgs e)
    {
        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ID");
        SelectedGroup = UniqueId.ToString();

        var lst = _emailTopicDueDate.Where(x => x.ID == long.Parse(SelectedGroup)).FirstOrDefault();   
        
        NavigationManager.NavigateTo($"ViewEmail/{lst.SessionId}/Email");
        //ATopicId?.Invoke(SelectedGroup);
        ////await LoadData();
        StateHasChanged();
    }
    public async Task onAssignAllGridRefresh(long tid)
    {
        _emailTopicDueDate = await Mediator.Send(new GetEmailTopicAll(applicationUser.UserID, "NULL"));
        if (RefSubAssignAll != null)
        {
            await RefSubAssignAll.onSubAssignAllGridRefresh(tid);
        }

    }
    private async void onSubViewEmailClick(string RId)
    {
        SelectedReplyId = RId;
        var conversationList = await Mediator.Send(new GetEmailConversationList(long.Parse(RId)));
        RTopicId = conversationList[0].TopicID;
        SelectedGroup = conversationList[0].TopicID.ToString();
        SubViewAllTopicId?.Invoke(SelectedReplyId);
        await Task.Delay(1000); // Example asynchronous operation
                                //await LoadReplyData();
        StateHasChanged();
    }
}