@using Application.Command.Employees;
@using Application.Command.SalesOrderMasterPricings;
@using Application.Command.SoSalesOrder;
@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager NavigationManager
@page "/AddItemChangePrice"
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />

                    </Items>
                </DxMenu>
            </div>
            <div class="save_hover" style="float: left; margin-top: -41px; line-height: 38px; margin-left: 104px; z-index: 9999; width:100px;">
                <button type="submit" form="@MyID" disabled="@loading" class="btnSubmitForm" onclick="@onsubmitClick">
                    @if (loading)
                    {
                        <span class="spinner-border spinner-border-sm mr-1"></span>
                    }
                    <i class="fa fa-save"></i>
                    Save
                </button>
            </div>

        </div>
    </div>
</div>


<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">

            <EditForm Model="@Data" id="@MyID" Context="EditFormContext" OnValidSubmit="@HandleValidSubmit">

                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />

                    <DxFormLayoutItem Caption="User Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.AddedBy" ShowValidationIcon="true" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.AddedDate" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                        <DxComboBox Data="@_plantItems"
                                    NullText="Select Company..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="PlantCode"
                                    ValueFieldName="PlantID"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    @bind-Value="@Data.CompanyId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Customer Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.CompanyId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Sales Pricing For" ColSpanMd="6">
                        <DxComboBox Data="@_viewSalesPricingForItems"
                                    NullText="Select Sales Pricing For..."
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.SalesPricingForId" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.SalesPricingForId)" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem Caption="Price Validaity From" ColSpanMd="6">
                        <DxDateEdit NullText="Select Price Validaity From..." @bind-Date="@Data.PriceValidaityFrom" Format="MMMM/yyyy" PickerDisplayMode="@DatePickerDisplayMode.ScrollPicker" ScrollPickerFormat="MMMM yyyy" CssClass="cw-320" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.PriceValidaityFrom)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Price Validaity To" ColSpanMd="6">
                        <DxDateEdit NullText="Select Price Validaity To..." @bind-Date="@Data.PriceValidaityTo" Format="MMMM/yyyy" PickerDisplayMode="@DatePickerDisplayMode.ScrollPicker" ScrollPickerFormat="MMMM yyyy" CssClass="cw-320" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.PriceValidaityTo)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Reason For Change" ColSpanMd="6">
                        <DxComboBox Data="@_viewReasonForChangeItems"
                                    NullText="Select Reason For Change..."
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.ReasonForChangeId" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.ReasonForChangeId)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>

            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.OnDemand">
                            <DxFormLayoutTabPage Caption="Item Entry">
                                <div style="padding: 10px;border: 1px solid #d5d4d4; border-top: none"><AddItemLine></AddItemLine></div>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>

        </div>
    </div>


</div>
@code {
    public long? SalesOrderMasterPricingId { get; set; }
    private bool loading;
    string MasterType = "SpecificItemMasterPrice";
    private string MyID = "myid";
    long? EmployeeIds { get; set; }
    bool EditEnabledTab { get; set; } = false;
    int ActiveSubTabIndex { get; set; } = 0;
    private List<View_SalesOrderMasterPricing> _salesOrderItems;
    List<SoSalesOrder> AccodianData { get; set; }
    private List<ViewPlants>? _plantItems;
    private List<View_ApplicationMasterDetail> _viewSalesPricingForItems;
    private List<View_ApplicationMasterDetail> _viewReasonForChangeItems;
    View_SalesOrderMasterPricing Data = new View_SalesOrderMasterPricing();
    View_SalesOrderMasterPricing _salesOrderItem = new View_SalesOrderMasterPricing();
    public ApplicationUser applicationUser { get; private set; }

    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _viewSalesPricingForItems = await Mediator.Send(new GetAllApplicationMasterDetailQuery(336));
        _viewReasonForChangeItems = await Mediator.Send(new GetAllApplicationMasterDetailQuery(337));
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        Data.AddedDate = DateTime.Now;
        Data.AddedBy = applicationUser.UserName;
    }

    void backUrl()
    {
        NavigationManager.NavigateTo("SpecificItemChangePricing");
    }
    void ResetForm()
    {
        SalesOrderMasterPricingId = -1;
        ActiveSubTabIndex = 0;
        NavigationManager.NavigateTo("AddItemChangePrice");
    }
    void onsubmitClick()
    {
        ActiveSubTabIndex = 0;
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.SalesOrderMasterPricingId > 0)
        {
            loading = false;
        }
        else
        {
            var editModel = new SalesOrderMasterPricing();
            var createReq = new CreateSalesOrderMasterPricingCommand
                {
                    CompanyId = Data.CompanyId,
                    PriceValidaityFrom = Data.PriceValidaityFrom,
                    PriceValidaityTo = Data.PriceValidaityTo,
                    MasterType = MasterType,
                    ReasonForChangeId = Data.ReasonForChangeId,
                    SalesPricingForId = Data.SalesPricingForId,
                    AddedByUserId = applicationUser.UserID,
                    ModifiedByUserId = applicationUser.UserID,
                    AddedDate = DateTime.Now,
                    ModifiedDate = DateTime.Now,
                    SessionId = Guid.NewGuid(),
                    StatusCodeId = 1

                };

            var result = await Mediator.Send(createReq);
            toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
            SalesOrderMasterPricingId = result.SalesOrderMasterPricingId;
            ActiveSubTabIndex = 0;
            NavigationManager.NavigateTo("EditItemChangePrice/" + createReq.SessionId + "");
            loading = false;
            StateHasChanged();
        }
    }
}
