@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@inject IMediator Mediator
@using Application.Commands;
@using Application.Queries;
@inject IJSRuntime jsRuntime
@inject AC.SD.Core.Services.ToastService toastService
@using global::Core.Repositories.Query;
@inject ILocalStorageService<ApplicationUser> _localStorageService
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                    </Items>
                </DxMenu>
            </div>
            <div class="save_hover" style="float: left; margin-top: -41px; line-height: 38px; margin-left: 104px; z-index: 9999; width:100px;">
                <button type="submit" form="@MyID" disabled="@loading" class="btnSubmitForm" onclick="@onsubmitClick">
                    @if (loading)
                    {
                        <span class="spinner-border spinner-border-sm mr-1"></span>
                    }
                    <i class="fa fa-save"></i>
                    Save
                </button>
            </div>

        </div>
    </div>
</div>
<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm Model="@_navItems" id="@MyID" Context="EditFormContext" OnValidSubmit="@HandleValidSubmit">

                <DxFormLayout CssClass="w-100">
                    <DxFormLayoutItem Caption="User Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@_navItems.AddedBy" ShowValidationIcon="true" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@_navItems.AddedDate" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                        <DxComboBox Data="@_plantItems"
                                    NullText="Select Company..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="PlantCode"
                                    ValueFieldName="PlantID"
                                    @bind-Value="@_navItems.CompanyId"
                                    ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Company Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => _navItems.CompanyId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="No" ColSpanMd="6">
                        <DxTextBox @bind-Text="@_navItems.No" ShowValidationIcon="true" Enabled="false" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description" ColSpanMd="6">
                        <DxTextBox @bind-Text="@_navItems.Description" ShowValidationIcon="true" Enabled="false" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description2" ColSpanMd="6">
                        <DxTextBox @bind-Text="@_navItems.Description2" ShowValidationIcon="true" Enabled="false" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Pack Size" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetailsPackSize"
                                    NullText="Select Pack Size..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@_navItems.PackSizeId" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Supply To" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetailsSupplyTo"
                                    NullText="Select Supply To..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@_navItems.SupplyToId" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="UOM" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetailsUom"
                                    NullText="Select Uom..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@_navItems.UomId" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="ItemSerialNo" ColSpanMd="6">
                        <DxTextBox @bind-Text="@_navItems.ItemSerialNo" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => _navItems.ItemSerialNo)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveTabIndex" RenderMode="TabsRenderMode.Default">
                            <DxFormLayoutTabPage Caption="Cross Reference">
                                <CrossReference @ref="refCrossRefrence" ItemId="@ItemId"></CrossReference>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Production Information">
                                <ProductionInformation @ref="refProductionInformation" ItemId="@ItemId"></ProductionInformation>
                            </DxFormLayoutTabPage>

                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>

        </div>
    </div>
</div>
@code {
    private bool loading;
    private string MyID = "myid";
    private CrossReference? refCrossRefrence;
    private ProductionInformation? refProductionInformation;
    private List<ViewPlants>? _plantItems;
    View_NavItems _navItems = new View_NavItems();
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetailsUom;
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetailsPackSize;
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetailsSupplyTo;
    int ActiveTabIndex { get; set; } = 0;
    long? ItemId { get; set; }
    [Parameter]
    public Action RevokeBack { get; set; }
    public ApplicationUser applicationUser { get; private set; }
    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        _view_ApplicationMasterDetailsPackSize = await Mediator.Send(new GetAllApplicationMasterDetailQuery(113));
        _view_ApplicationMasterDetailsUom = await Mediator.Send(new GetAllApplicationMasterDetailQuery(178));
        _view_ApplicationMasterDetailsSupplyTo = await Mediator.Send(new GetAllApplicationMasterDetailQuery(335));
        await loadData(ItemId, _navItems);
    }
    void onsubmitClick()
    {
    }
    async Task HandleValidSubmit()
    {
        await UpdatePlantAsync(_navItems);
    }
    void backUrl()
    {
        RevokeBack?.Invoke();
    }
    public async Task loadData(long? itemId, View_NavItems _navItem)
    {
        ActiveTabIndex = 0;
        ItemId = itemId;
        if (ItemId > 0)
        {

            _navItem.AddedBy = _navItem.AddedBy == null ? applicationUser.UserName : _navItem.AddedBy;
            _navItem.AddedDate = _navItem.AddedDate == null ? DateTime.Now : _navItem.AddedDate;
            _navItems = _navItem;
            StateHasChanged();
            await refCrossRefrence.loadData(ItemId);
        }
        StateHasChanged();
    }
    async Task UpdatePlantAsync(View_NavItems editablePlant)
    {
        loading = true;
        var request = new EditNavItemsCommand
            {
                ItemId = editablePlant.ItemId,
                ItemSerialNo = editablePlant.ItemSerialNo,
                PackSizeId = editablePlant.PackSizeId,
                SupplyToId = editablePlant.SupplyToId,
                UomId = editablePlant.UomId,
                CompanyId = editablePlant.CompanyId,
                StatusCodeId = editablePlant.StatusCodeId,
                AddedByUserId = editablePlant.AddedByUserId == null ? applicationUser.UserID : editablePlant.AddedByUserId,
                ModifiedByUserId = applicationUser.UserID,
                AddedDate = editablePlant.AddedDate == null ? DateTime.Now : editablePlant.AddedDate,
                ModifiedDate = DateTime.Now,
            };
        var response = await Mediator.Send(request);
        if (response.ItemId > 0)
        {
            loading = false;
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
        }
        else
        {
            loading = false;
            toastService.ShowToast("Item SerialNo already exits", AC.SD.Core.Services.ToastLevel.Warning);
        }
        StateHasChanged();
    }
}