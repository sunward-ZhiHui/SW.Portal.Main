@page "/OdataGridList"
 @using RestSharp;
 @using Newtonsoft.Json;
 @using Newtonsoft.Json.Linq;
 @using System.Dynamic;
<DxLoadingPanel @bind-Visible="PanelVisible"
                IsContentBlocked="true"
                ApplyBackgroundShading="true"
                IndicatorAreaVisible="false"
                Text="Fetching Data...">
    <div class="menu-bar-content-container col-md-12">
        <div class="card w-100" style="margin-bottom:1px;">



            <div class="card-body p-0">

                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Auto">

                    <Items>
                        <DxMenuItem Position="ItemPosition.End" title="Export to XLSX" IconCssClass="fa fa-file-excel" Click="ExportXlsx_Click" />
                    </Items>
                </DxMenu>

            </div>


        </div>
    </div>
    <div class="card" style="margin-bottom:10px;">
        <div class="card-body p-0" style="margin-left: 10px;margin-top: 10px;margin-bottom: 10px;">
            <div class="row">
                <div class="">
                    <DxPager PageCount="@PageCount"
                             ActivePageIndex="@ActivePageIndex" ActivePageIndexChanged="OnActivePageIndexChanged" NavigationMode="PagerNavigationMode.InputBox"
                             SizeMode="SizeMode.Medium">
                    </DxPager>
                </div>
            </div>
        </div>
    </div>

    <DxGrid Data="@DataSource" @ref="Grid"
            PageSize="@PageSize"
            KeyFieldName="dynamicFormDataId"
            ShowGroupPanel="true" ShowGroupedColumns="true"
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            ColumnResizeMode="GridColumnResizeMode.NextColumn"
            VirtualScrollingEnabled="true"
            ShowSearchBox="true"
            SearchTextParseMode="GridSearchTextParseMode.ExactMatch"
            SearchText="@searchText"
            SearchTextChanged="OnSearchTextChanged"
            CustomizeSummaryDisplayText="Grid_CustomizeSummaryDisplayText"
            CustomizeElement="Grid_CustomizeElement"
            FocusedRowEnabled="true"
            style="height: calc(100vh - 280px);"
            CssClass="w-100"
            TextWrapEnabled="false">
        <Columns>
            <DxGridDataColumn FieldName="dynamicFormDataId" Visible="false" />
            <DxGridDataColumn FieldName="profileNo" Caption="Profile No" />
            <DxGridDataColumn FieldName="name" Visible="false" />
            <DxGridDataColumn FieldName="10973_Attr$QC_Reference_No_-_PDJ" Caption="QC Reference No - PDJ" />
            <DxGridDataColumn FieldName="10972_Attr$FP_Batch_information" Caption="FP Batch information" />
            <DxGridDataColumn FieldName="11013_Attr$Machine" Caption="Machine" />

        </Columns>
        <TotalSummary>
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Count" FieldName="profileNo" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Custom" Name="Custom" FieldName="profileNo" />
        </TotalSummary>
        <DetailRowTemplate>
            @{
                var employee = (dynamic)context.DataItem;
                var e1 = (long?)employee["dynamicFormDataId"];
                var e2 = subGridItems(e1);
            }
            <DxGrid Data="e2" AutoCollapseDetailRow="true"
                    ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                    ColumnResizeMode="GridColumnResizeMode.NextColumn"
                    PagerNavigationMode="PagerNavigationMode.InputBox"
                    KeyFieldName="dynamicFormDataId"
                    PageSizeSelectorVisible="true"
                    PageSizeSelectorAllRowsItemVisible="true"
                    PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                    PageSize="20"
                    FocusedRowEnabled="true"
                    CssClass="ch-360">
                <Columns>
                    <DxGridDataColumn FieldName="profileNo" Caption="Profile No" />
                    <DxGridDataColumn FieldName="name" Visible="false" />
                    <DxGridDataColumn FieldName="10981_Attr$Type_of_Moisture_Test" Caption="QC Reference No - PDJ" />
                    <DxGridDataColumn FieldName="10981_392_AppMaster$QC_Moisture_test_method" Caption="FP Batch information" />
                    <DxGridDataColumn FieldName="11042_Attr$Retest" Caption="Machine" />
                    <DxGridDataColumn FieldName="10986_Attr$Mass_of_Container_/g" Caption="Machine" />
                    <DxGridDataColumn FieldName="10987_Attr$M<ass_of_Container_+_Sample_Before_Drying_/g" Caption="Machine" />
                    <DxGridDataColumn FieldName="10982_Attr$Date_of_Test" Caption="Date" Context="context1">
                        <CellDisplayTemplate>
                            @{
                                dynamic item = (dynamic)context1.DataItem;
                                DateTime? items = (DateTime?)item["10982_Attr$Date_of_Test"];
                            }
                            @(items != null ? (items?.ToString("dd-MMM-yyyy")) : null)
                        </CellDisplayTemplate>
                    </DxGridDataColumn>
                </Columns>
            </DxGrid>
        </DetailRowTemplate>
    </DxGrid>
    <div class="card" style="margin-bottom:10px;">
        <div class="card-body p-0" style="margin-left: 10px;margin-top: 10px;margin-bottom: 10px;">
            <div class="row">
                <div class="">
                    <DxPager PageCount="@PageCount"
                             ActivePageIndex="@ActivePageIndex" ActivePageIndexChanged="OnActivePageIndexChanged" NavigationMode="PagerNavigationMode.InputBox"
                             SizeMode="SizeMode.Medium">
                    </DxPager>
                </div>
            </div>
        </div>
    </div>
</DxLoadingPanel>
@code {
    //main Grid
    int PageCount { get; set; } = 0; int TotalRecords { get; set; } = 0; int PageNo { get; set; } = 1;
    int ActivePageIndex { get; set; } = 0;
    public string? searchText { get; set; }
    IGrid? Grid { get; set; }
    bool PanelVisible { get; set; } = true;
    public int PageSize = 50;
    public List<dynamic> DataSource { get; set; } = new List<dynamic>();
    bool ExportSelectedRowsOnly { get; set; }
    //
    public string? Baseurl = "https://portal.sunwardpharma.com:8423/api/DynamicForm/GetDynamicFormDataListPaging?DynamicFormSessionId=d59cfc4b-8e20-4114-9d77-63f683b53056";
    public string? url = string.Empty;
    int PagePageNo { get; set; } = 1;
    private int apiSearchCount { get; set; } = 0;
    public List<dynamic> DataSource1 { get; set; } = new List<dynamic>();
    public List<dynamic> DataSourceItems { get; set; } = new List<dynamic>();
    public List<string> ColumnList { get; set; } = new List<string>();
    protected override async Task OnInitializedAsync()
    {
        await GenerateList();
    }
    string GenerateUrl()
    {
        string urlString = Baseurl + "&&PageNo=" + PagePageNo + "&&PageSize=" + PageSize;
        return urlString;
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }

    }
    void Grid_CustomizeSummaryDisplayText(GridCustomizeSummaryDisplayTextEventArgs e)
    {
        if (e.Item.Name == "Custom")
            e.DisplayText = string.Format("Total Records: {0}", TotalRecords);
    }
    async Task OnActivePageIndexChanged(int activePageIndex)
    {
        ActivePageIndex = activePageIndex;
        if (!string.IsNullOrEmpty(searchText))
        {
            PageNo = ActivePageIndex + 1;
            filterPagination(ActivePageIndex + 1);
        }
        else
        {
            PagePageNo = ActivePageIndex + 1;
            PageNo = ActivePageIndex + 1;
            await GenerateList();
        }
    }
    void filterPagination(int filterPageNo)
    {
        if (DataSource1 != null && DataSource1.Count() > 0)
        {
            var pCount = DataSource1.Count();
            TotalRecords = pCount;
            if (pCount > 0)
            {
                PageCount = ((pCount - 1) / PageSize) + 1;
            }
            DataSource = DataSource1.Skip((int)((filterPageNo - 1) * PageSize)).Take(PageSize).ToList();
        }
        PanelVisible = false;

    }
    async Task GenerateList()
    {
        PanelVisible = true;
        var DataSources = await restApi();
        if (DataSources.Count() > 0)
        {
            DataSource = DataSources;
            PanelVisible = false;
        }
        else
        {
            DataSource = new List<dynamic>();
            PanelVisible = false;
        }
    }
    private List<dynamic> subGridItems(long? dynamicFormDataId)
    {
        List<dynamic> ListItems = new List<dynamic>();
        if (DataSourceItems.Count > 0)
        {
            var counts = DataSourceItems.Count;
            for (int i = 0; i < counts; i++)
            {
                if ((long?)DataSourceItems[i].dynamicFormDataId == dynamicFormDataId)
                {
                    var ListItemss = DataSourceItems[i].dynamicFormReportItems;
                    var ListItemsCount = ListItemss.Count;
                    if (ListItemsCount > 0)
                    {
                        for (int j = 0; j < ListItemsCount; j++)
                        {
                            bool? listOne = (bool?)ListItemss[j].isGrid;
                            if (listOne == true)
                            {
                                ListItems.AddRange(ListItemss[j].gridSingleItems);
                                break;
                            }
                        }
                    }
                    break;
                }
            }
        }
        return ListItems;
    }
    async Task<List<dynamic>> restApi()
    {
        List<dynamic> DataSourceItem = new List<dynamic>();
        string? Url = GenerateUrl();
        var client = new RestClient(Url);
        var request = new RestRequest(Url, Method.Get);
        RestResponse response = await client.ExecuteAsync(request);
        var deserial = JsonConvert.DeserializeObject<dynamic>(response.Content);
        if (deserial.results.Count > 0)
        {
            DataSourceItems.AddRange(deserial.results);
            var counts = deserial.results.Count;
            for (int i = 0; i < counts; i++)
            {
                if (i == 0)
                {
                    TotalRecords = (int)deserial.results[i].totalPage;
                    if (TotalRecords > 0)
                    {
                        PageCount = ((TotalRecords - 1) / PageSize) + 1;
                    }
                }
                if (deserial.results[i].objectDataItems != null)
                {
                    var result = deserial.results[i].objectDataItems;
                    DataSourceItem.Add(result);
                }
            }
        }
        return DataSourceItem;
    }
    async Task OnSearchTextChanged(string? newSearchText)
    {
        DataSource = new List<dynamic>(); DataSource1 = new List<dynamic>(); TotalRecords = 0;
        searchText = newSearchText;
        int searchPageCount = 1; DataSourceItems = new List<dynamic>();
        if (!string.IsNullOrEmpty(newSearchText))
        {
            await loadFilterData(searchPageCount, newSearchText);
        }
        else
        {
            PageNo = 1; PagePageNo = 1;
            await GenerateList();
        }
    }
    async Task loadFilterData(int searchPageCount, string? newSearchText)
    {
        for (int i = 1; i <= PageCount; i++)
        {
            PanelVisible = true;
            PagePageNo = i;
            var listData = await restApi();
            if (listData != null && listData.Count > 0)
            {
                listData.ForEach(f =>
                {
                    List<string> nameValue = new List<string>();
                    ExpandoObject listData = f.ToObject<ExpandoObject>();
                    var li = listData.ToList();
                    li.ForEach(l =>
                    {
                        if (l.Key.ToLower() != "dynamicFormDataId".ToLower() && l.Key.ToLower() != "name".ToLower() && l.Key.ToLower() != "SessionId".ToLower())
                        {
                            if (l.Value != null)
                            {
                                string value = l.Value?.ToString();
                                if (!string.IsNullOrEmpty(value))
                                {
                                    nameValue.Add(value);
                                }
                            }
                        }
                    });
                    if (nameValue != null && nameValue.Count() > 0)
                    {
                        var exits = nameValue.Where(s => s != null && s.ToLower().Contains(newSearchText?.ToLower())).ToList();
                        if (exits.Count() > 0)
                        {
                            DataSource1.Add(f);
                        }
                    }
                });
            }
        }
        filterPagination(1);
        StateHasChanged();
    }
    async Task ExportXlsx_Click()
    {
        await Grid.ExportToXlsxAsync("ExportResult", new GridXlExportOptions()
            {
                ExportSelectedRowsOnly = ExportSelectedRowsOnly
            });
    }
}