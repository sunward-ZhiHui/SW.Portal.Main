@page "/OdataGridList"
 @using RestSharp;
 @using Newtonsoft.Json;
 @using Newtonsoft.Json.Linq;
 @using System.Dynamic;
<DxLoadingPanel @bind-Visible="PanelVisible"
                IsContentBlocked="true"
                ApplyBackgroundShading="true"
                IndicatorAreaVisible="false"
                Text="Fetching Data...">
    <div class="menu-bar-content-container col-md-12">
        <div class="card w-100" style="margin-bottom:1px;">



            <div class="card-body p-0">

                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Auto">

                    <Items>
                        <DxMenuItem Position="ItemPosition.End" title="Export to XLSX" IconCssClass="fa fa-file-excel" Click="ExportXlsx_Click" />
                    </Items>
                </DxMenu>

            </div>


        </div>
    </div>
    <div class="card" style="margin-bottom:10px;">
        <div class="card-body p-0" style="margin-left: 10px;margin-top: 10px;margin-bottom: 10px;">
            <div class="row">
                <div class="">
                    <DxPager PageCount="@PageCount"
                             ActivePageIndex="@ActivePageIndex" ActivePageIndexChanged="OnActivePageIndexChanged" NavigationMode="PagerNavigationMode.InputBox"
                             SizeMode="SizeMode.Medium">
                    </DxPager>
                </div>
            </div>
        </div>
    </div>
    <DxFormLayout CssClass="w-100">

        <DxFormLayoutItem Caption="QC Reference No - PDJ" ColSpanMd="6">
            <DxTextBox @bind-Text="@QCReferenceNo" ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="Machine" ColSpanMd="6">
            <DxTextBox @bind-Text="@MachineName" ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="FP Batch information" ColSpanMd="6">
            <DxComboBox Data="@_FPBatchinformationItems"
                        NullText="Select FP Batch information..."
                        ListRenderMode="ListRenderMode.Virtual"
                        SearchMode="ListSearchMode.AutoSearch"
                        SearchFilterCondition="ListSearchFilterCondition.Contains"
                        TextFieldName="attributeDetailName"
                        ValueFieldName="attributeDetailID"
                        @bind-Value="FPBatchinformationId"
                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                        ShowValidationIcon="true">
            </DxComboBox>
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="" ColSpanMd="4">
            <DxButton Text="Search" Click="searchPage"></DxButton><DxButton Text="Clear" Click="ClearsearchPage"></DxButton>
        </DxFormLayoutItem>
    </DxFormLayout>
    <DxGrid Data="@DataSource" @ref="Grid"
            PageSize="@PageSize"
            KeyFieldName="dynamicFormDataId"
            ShowGroupPanel="true" ShowGroupedColumns="true"
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            ColumnResizeMode="GridColumnResizeMode.NextColumn"
            VirtualScrollingEnabled="true"
            ShowSearchBox="true"
            SearchTextParseMode="GridSearchTextParseMode.ExactMatch"
            SearchText="@searchText"
            SearchTextChanged="OnSearchTextChanged"
            CustomizeSummaryDisplayText="Grid_CustomizeSummaryDisplayText"
            CustomizeElement="Grid_CustomizeElement"
            FocusedRowEnabled="true"
            style="height: calc(100vh - 280px);"
            CssClass="w-100"
            TextWrapEnabled="false">
        <Columns>
            <DxGridDataColumn FieldName="dynamicFormDataId" Visible="false" />
            <DxGridDataColumn FieldName="profileNo" Caption="Profile No" />
            <DxGridDataColumn FieldName="10973_Attr$QC_Reference_No_-_PDJ" Caption="QC Reference No - PDJ" />
            <DxGridDataColumn FieldName="10972_Attr$FP_Batch_information" Caption="FP Batch information" />
            <DxGridDataColumn FieldName="11013_Attr$Machine" Caption="Machine" />

        </Columns>
        <TotalSummary>
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Count" FieldName="profileNo" />
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Custom" Name="Custom" FieldName="profileNo" />
        </TotalSummary>
        <DetailRowTemplate>
            @{
                var employee = (dynamic)context.DataItem;
                var e1 = (long?)employee["dynamicFormDataId"];
                var e2 = subGridItems(e1);
            }
            <DxGrid Data="e2" AutoCollapseDetailRow="true"
                    ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                    ColumnResizeMode="GridColumnResizeMode.NextColumn"
                    PagerNavigationMode="PagerNavigationMode.InputBox"
                    KeyFieldName="dynamicFormDataId"
                    PageSizeSelectorVisible="true"
                    PageSizeSelectorAllRowsItemVisible="true"
                    PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                    PageSize="20"
                    FocusedRowEnabled="true"
                    CssClass="ch-360">
                <Columns>
                    <DxGridDataColumn FieldName="profileNo" Caption="Profile No" />
                    <DxGridDataColumn FieldName="name" Visible="false" />
                    <DxGridDataColumn FieldName="10981_Attr$Type_of_Moisture_Test" Caption="QC Reference No - PDJ" />
                    <DxGridDataColumn FieldName="10981_392_AppMaster$QC_Moisture_test_method" Caption="FP Batch information" />
                    <DxGridDataColumn FieldName="11042_Attr$Retest" Caption="Machine" />
                    <DxGridDataColumn FieldName="10986_Attr$Mass_of_Container_/g" Caption="Machine" />
                    <DxGridDataColumn FieldName="10987_Attr$M<ass_of_Container_+_Sample_Before_Drying_/g" Caption="Machine" />
                    <DxGridDataColumn FieldName="10982_Attr$Date_of_Test" Caption="Date" Context="context1">
                        <CellDisplayTemplate>
                            @{
                                dynamic item = (dynamic)context1.DataItem;
                                DateTime? items = (DateTime?)item["10982_Attr$Date_of_Test"];
                            }
                            @(items != null ? (items?.ToString("dd-MMM-yyyy")) : null)
                        </CellDisplayTemplate>
                    </DxGridDataColumn>
                </Columns>
            </DxGrid>
        </DetailRowTemplate>
    </DxGrid>
    <div class="card" style="margin-bottom:10px;">
        <div class="card-body p-0" style="margin-left: 10px;margin-top: 10px;margin-bottom: 10px;">
            <div class="row">
                <div class="">
                    <DxPager PageCount="@PageCount"
                             ActivePageIndex="@ActivePageIndex" ActivePageIndexChanged="OnActivePageIndexChanged" NavigationMode="PagerNavigationMode.InputBox"
                             SizeMode="SizeMode.Medium">
                    </DxPager>
                </div>
            </div>
        </div>
    </div>
</DxLoadingPanel>
@code {
    //Change This SessionId For Every Dyanamic Form
    public string? SessionId { get; set; } = "d59cfc4b-8e20-4114-9d77-63f683b53056";
    public string? MainBaseurl = "https://portal.sunwardpharma.com:8423/api/DynamicForm/";
    //main Grid
    int PageCount { get; set; } = 0; int TotalRecords { get; set; } = 0; int PageNo { get; set; } = 1;
    int ActivePageIndex { get; set; } = 0;
    public string? searchText { get; set; }
    IGrid? Grid { get; set; }
    bool PanelVisible { get; set; } = true;
    public int PageSize = 50;
    public List<dynamic> DataSource { get; set; } = new List<dynamic>();
    bool ExportSelectedRowsOnly { get; set; }
    public string? Baseurl = string.Empty;

    public string? url = string.Empty;
    int PagePageNo { get; set; } = 1;
    public List<dynamic> DataSourceItems { get; set; } = new List<dynamic>();
    private List<ExpandoObject>? _FPBatchinformationItems;
    long? FPBatchinformationId { get; set; }
    long? EmployeeId { get; set; }
    string? QCReferenceNo { get; set; }
    string? MachineName { get; set; }
    public IDictionary<string, object> dynamicsData = new ExpandoObject();
    protected override async Task OnInitializedAsync()
    {
        Baseurl = MainBaseurl + "GetDynamicFormDataListPaging?DynamicFormSessionId=" + SessionId;

        //DropDown Form Select Values in Search Options
        _FPBatchinformationItems = await generateDropdown("10972_Attr");
        await GenerateList();
    }
    void submitForm()
    {
        dynamicsData["10972_Attr"] = FPBatchinformationId;
        dynamicsData["10973_Attr"] = QCReferenceNo;
        dynamicsData["11013_Attr"] = MachineName;
    }
    async Task ClearsearchPage()
    {
        FPBatchinformationId = null; QCReferenceNo = null; MachineName = null;
        DataSource = new List<dynamic>(); TotalRecords = 0;
        PageNo = 1; PagePageNo = 1; PageCount = 0; ActivePageIndex = 0;
        StateHasChanged();
        await GenerateList();
    }
    async Task searchPage()
    {
        DataSource = new List<dynamic>();  TotalRecords = 0;
        PageNo = 1; PagePageNo = 1; PageCount = 0; ActivePageIndex = 0;
        StateHasChanged();
        submitForm();
        await GenerateList();
    }
    async Task<List<ExpandoObject>> generateDropdown(string? attrName)
    {
        List<ExpandoObject>? list = new List<ExpandoObject>();
        string Url = MainBaseurl + "GetDynamicFormDropdownList?DynamicFormSessionId=" + SessionId + "&&attrName=" + attrName;
        var client = new RestClient(Url);
        var request = new RestRequest(Url, Method.Get);
        RestResponse response = await client.ExecuteAsync(request);
        var deserial = JsonConvert.DeserializeObject<dynamic>(response.Content);
        if (deserial.results.Count > 0)
        {
            var counts = deserial.results.Count;
            for (int i = 0; i < counts; i++)
            {
                var itemValue = deserial.results[i];
                dynamic listData = itemValue.ToObject<ExpandoObject>();
                list.Add(listData);
            }
        }
        return list;
    }
    string GenerateUrl()
    {
        string urlString = Baseurl + "&&PageNo=" + PagePageNo + "&&PageSize=" + PageSize;
        submitForm();
        var datad = dynamicsData.ToList();
        if (datad != null && datad.Count() > 0)
        {
            datad.ForEach(f =>
            {
                if (f.Value != null)
                {
                    urlString += "&&" + f.Key + "=" + (f.Value.ToString());
                }
            });
        }
        return urlString;
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }

    }
    void Grid_CustomizeSummaryDisplayText(GridCustomizeSummaryDisplayTextEventArgs e)
    {
        if (e.Item.Name == "Custom")
            e.DisplayText = string.Format("Total Records: {0}", TotalRecords);
    }
    async Task OnActivePageIndexChanged(int activePageIndex)
    {
        ActivePageIndex = activePageIndex;
        PagePageNo = ActivePageIndex + 1;
        PageNo = ActivePageIndex + 1;
        await GenerateList();
    }

    async Task GenerateList()
    {
        PanelVisible = true;
        var DataSources = await restApi();
        if (DataSources.Count() > 0)
        {
            DataSource = DataSources;
            PanelVisible = false;
        }
        else
        {
            DataSource = new List<dynamic>();
            PanelVisible = false;
        }
    }
    async Task<List<dynamic>> restApi()
    {
        List<dynamic> DataSourceItem = new List<dynamic>();
        string? Url = GenerateUrl();
        var client = new RestClient(Url);
        var request = new RestRequest(Url, Method.Get);
        RestResponse response = await client.ExecuteAsync(request);
        var deserial = JsonConvert.DeserializeObject<dynamic>(response.Content);
        if (deserial.results.Count > 0)
        {
            DataSourceItems.AddRange(deserial.results);
            var counts = deserial.results.Count;
            for (int i = 0; i < counts; i++)
            {
                if (i == 0)
                {
                    TotalRecords = (int)deserial.results[i].totalPage;
                    if (TotalRecords > 0)
                    {
                        PageCount = ((TotalRecords - 1) / PageSize) + 1;
                    }
                }
                if (deserial.results[i].objectDataItems != null)
                {
                    var result = deserial.results[i].objectDataItems;
                    DataSourceItem.Add(result);
                }
            }
        }
        return DataSourceItem;
    }
    async Task OnSearchTextChanged(string? newSearchText)
    {
        searchText = newSearchText;
    }
    async Task ExportXlsx_Click()
    {
        await Grid.ExportToXlsxAsync("ExportResult", new GridXlExportOptions()
            {
                ExportSelectedRowsOnly = ExportSelectedRowsOnly
            });
    }
    private List<dynamic> subGridItems(long? dynamicFormDataId)
    {
        List<dynamic> ListItems = new List<dynamic>();
        if (DataSourceItems.Count > 0)
        {
            var counts = DataSourceItems.Count;
            for (int i = 0; i < counts; i++)
            {
                if ((long?)DataSourceItems[i].dynamicFormDataId == dynamicFormDataId)
                {
                    var ListItemss = DataSourceItems[i].dynamicFormReportItems;
                    var ListItemsCount = ListItemss.Count;
                    if (ListItemsCount > 0)
                    {
                        for (int j = 0; j < ListItemsCount; j++)
                        {
                            bool? listOne = (bool?)ListItemss[j].isGrid;
                            if (listOne == true)
                            {
                                ListItems.AddRange(ListItemss[j].gridSingleItems);
                                break;
                            }
                        }
                    }
                    break;
                }
            }
        }
        return ListItems;
    }
}