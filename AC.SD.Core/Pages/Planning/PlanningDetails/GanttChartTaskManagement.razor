@page "/SyrupGroupScheduleGantt"
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Gantt
@using Syncfusion.Blazor.Navigations
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupReportDtos
@inject NavigationManager NavigationManager
@using global::Core.Entities
@using static global::Core.EntityModels.SyrupPlanning
@inject IStockInformationMasterQueryRepository StockQueryRepo

<style>
    /* Container class used in the SfGantt: gantt-halfhour-grid */
    .gantt-halfhour-grid .e-gantt-chart {
        /*
                   Two repeating gradients:
                   - faint line every half-hour (60px)
                   - stronger line every hour (120px)
                   Adjust 60px/120px if you change TimelineUnitSize.
                */
        background-image: repeating-linear-gradient( to right, rgba(0,0,0,0.04) 0px, rgba(0,0,0,0.04) 1px, transparent 1px, transparent 60px ), repeating-linear-gradient( to right, rgba(0,0,0,0.09) 0px, rgba(0,0,0,0.09) 1px, transparent 1px, transparent 120px );
        background-position: left top;
        background-repeat: repeat-y;
        background-size: auto 100%;
    }

        /* Slight tweak to ensure the chart content overlays grid cleanly */
        .gantt-halfhour-grid .e-gantt-chart .e-chart-row {
            background: transparent; /* keep the repeating-grid visible */
        }

    /* If header misaligns slightly depending on Syncfusion version, try this */
    .gantt-halfhour-grid .e-gantt-timeline {
        position: relative;
        z-index: 3;
    }

</style>
<style scoped>
    .e-yscroll, .e-chart-scroll-container {
        scrollbar-width: thin;
    }
</style>
<div class="col-lg-12 control-section">
    <div class="content-wrapper">
        <div class="row">
            <SfGantt DataSource="@TaskCollection" Height="450px" Width="100%" HighlightWeekends="true" DurationUnit="DurationUnit.Hour"
                     AllowSelection="true" GridLines="GridLine.Both" TreeColumnIndex="1" ProjectStartDate="@ProjectStartDate" ProjectEndDate="@ProjectEndDate" ScrollToTaskbarOnClick="true">
                <GanttTaskFields Id="TaskId" Name="TaskName" StartDate="StartDate" EndDate="EndDate" Duration="Duration" Progress="Progress"
                                 Dependency="Predecessor" ParentID="ParentId"></GanttTaskFields>
                <GanttColumns>
                    <GanttColumn Field="TaskId" Width="100"></GanttColumn>
                    <GanttColumn Field="TaskName" Width="250" ClipMode="Syncfusion.Blazor.Grids.ClipMode.EllipsisWithTooltip"></GanttColumn>                                    
                </GanttColumns>
                <GanttEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" AllowTaskbarEditing="true" ShowDeleteConfirmDialog="true"></GanttEditSettings>
                <GanttLabelSettings LeftLabel="TaskName" TValue="GanttTaskData"></GanttLabelSettings>
                <GanttSplitterSettings Position="28%"></GanttSplitterSettings>
                <GanttDayWorkingTimeCollection>
                    <GanttDayWorkingTime From="8" To="12"></GanttDayWorkingTime>
                    <GanttDayWorkingTime From="14" To="18"></GanttDayWorkingTime>
                </GanttDayWorkingTimeCollection>
                <GanttTimelineSettings TimelineUnitSize="40">
                    <GanttTopTierSettings Unit="TimelineViewMode.Day" Format="ddd"></GanttTopTierSettings>
                    <GanttBottomTierSettings Unit="TimelineViewMode.Hour"></GanttBottomTierSettings>
                </GanttTimelineSettings>
            </SfGantt>
        </div>
    </div>
</div>
<style>
    html, body {
        height: 100%;
    }
</style>
@code {

    public class GanttTaskData
    {
        public long TaskId { get; set; }
        public string TaskName { get; set; } = string.Empty;
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public string? Duration { get; set; }
        public int Progress { get; set; }
        public string Predecessor { get; set; } = string.Empty;
        public string Notes { get; set; } = string.Empty;
        public long? ParentId { get; set; }
    }


    public class WorkTimeRangeData
    {
        public class TaskData
        {
            public int TaskId { get; set; }
            public string TaskName { get; set; } = string.Empty;
            public DateTime? StartDate { get; set; }
            public DateTime? EndDate { get; set; }
            public string? Duration { get; set; }
            public int Progress { get; set; }
            public string Predecessor { get; set; } = string.Empty;
            public string Notes { get; set; } = string.Empty;
            public int? ParentId { get; set; }

        }
        public static List<TaskData> ProjectNewData()
        {
            List<TaskData> Tasks = new List<TaskData>()
            {
                new TaskData() { TaskId = 1, TaskName = "Product concept", StartDate = new DateTime(2021, 04, 02), EndDate = new DateTime(2021, 04, 08), Duration = "5" },
                new TaskData() { TaskId = 2, TaskName = "Defining the product usage", StartDate = new DateTime(2021, 04, 02), EndDate = new DateTime(2021, 04, 08), Duration = "3", Progress = 30, ParentId = 1 },
                new TaskData() { TaskId = 3, TaskName = "Defining the target audience", StartDate = new DateTime(2021, 04, 02), EndDate = new DateTime(2021, 04, 04), Duration = "3", Progress = 40, ParentId = 1 },
                new TaskData() { TaskId = 4, TaskName = "Prepare product sketch and notes", StartDate = new DateTime(2021, 04, 05), EndDate = new DateTime(2021, 04, 08), Duration = "2", Progress = 30, ParentId = 1, Predecessor = "2" },
                new TaskData() { TaskId = 5, TaskName = "Concept approval", StartDate = new DateTime(2021, 04, 08), EndDate = new DateTime(2021, 04, 08), Duration = "0", Predecessor = "3,4" },
                new TaskData() { TaskId = 6, TaskName = "Market research", StartDate = new DateTime(2021, 04, 09), EndDate = new DateTime(2021, 04, 18), Duration = "4", Progress = 30 },
                new TaskData() { TaskId = 7, TaskName = "Demand analysis", StartDate = new DateTime(2021, 04, 09), EndDate = new DateTime(2021, 04, 12), Duration = "4", Progress = 40, ParentId = 6 },
                new TaskData() { TaskId = 8, TaskName = "Customer strength", StartDate = new DateTime(2021, 04, 09), EndDate = new DateTime(2021, 04, 12), Duration = "4", Progress = 30, ParentId = 7, Predecessor = "5" },
                new TaskData() { TaskId = 9, TaskName = "Market opportunity analysis", StartDate = new DateTime(2021, 04, 09), EndDate = new DateTime(2021, 04, 012), Duration = "4", ParentId = 7, Predecessor = "5" },
                new TaskData() { TaskId = 10, TaskName = "Competitor analysis", StartDate = new DateTime(2021, 04, 15), EndDate = new DateTime(2021, 04, 18), Duration = "4", Progress = 30, ParentId = 6, Predecessor = "7,8" },
                new TaskData() { TaskId = 11, TaskName = "Product strength analysis", StartDate = new DateTime(2021, 04, 15), EndDate = new DateTime(2021, 04, 18), Duration = "4", Progress = 40, ParentId = 6, Predecessor = "9" },
                new TaskData() { TaskId = 12, TaskName = "Research completed", StartDate = new DateTime(2021, 04, 18), EndDate = new DateTime(2021, 04, 18), Duration = "0", Progress = 30, ParentId = 6, Predecessor = "10" }
            };
            return Tasks;
        }
    }
    private DateTime ProjectStartDate { get; set; } = DateTime.Now;
    private DateTime ProjectEndDate { get; set; } = DateTime.Now;
    // private List<TaskData> TaskCollection { get; set; } = new List<TaskData>();
    private List<GanttTaskData> TaskCollection { get; set; } = new List<GanttTaskData>();
    protected override async void OnInitialized()
    {
        DateTime productionDay = DateTime.Today; 
        TimeSpan shiftStart = TimeSpan.FromHours(8);
        TimeSpan shiftEnd = TimeSpan.FromHours(20);
        
        ProjectStartDate = productionDay.Date + shiftStart;
        ProjectEndDate = productionDay.Date + shiftEnd;

        //var readOnly = await StockQueryRepo.GetProductionGanttAsyncList("MC-0054", productionDay, shiftStart);

        // Map repo DTO -> GanttTaskData explicitly
        // // TaskCollection = readOnly.Select(r => new GanttTaskData
        // // {
        // //     TaskId = r.TaskId,                       // ensure r.TaskId is long (or cast)
        // //     TaskName = r.TaskName ?? string.Empty,
        // //     StartDate = r.StartDate,
        // //     EndDate = r.EndDate,
        // //     Progress = r.Progress,
        // //     Predecessor = r.Predecessor ?? string.Empty,
        // //     ParentId = r.ParentId
        // // }).ToList();

        StateHasChanged();
    }
}