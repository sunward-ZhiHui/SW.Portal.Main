@page "/SyrupScheduleGantt"
@using AC.SD.Core.Helpers
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Gantt
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupReportDtos
@inject IStockInformationMasterQueryRepository StockQueryRepo
@inject NavigationManager NavigationManager
@inject IMediator Mediator
@using Application.Queries;
@using MediatR;
@inject IJSRuntime JSRuntime;
@using System.Globalization;

<style>
    /* Container class used in the SfGantt: gantt-halfhour-grid */
    .gantt-halfhour-grid .e-gantt-chart {
        /*
                   Two repeating gradients:
                   - faint line every half-hour (60px)
                   - stronger line every hour (120px)
                   Adjust 60px/120px if you change TimelineUnitSize.
                */
        background-image: repeating-linear-gradient( to right, rgba(0,0,0,0.04) 0px, rgba(0,0,0,0.04) 1px, transparent 1px, transparent 60px ), repeating-linear-gradient( to right, rgba(0,0,0,0.09) 0px, rgba(0,0,0,0.09) 1px, transparent 1px, transparent 120px );
        background-position: left top;
        background-repeat: repeat-y;
        background-size: auto 100%;
    }

        /* Slight tweak to ensure the chart content overlays grid cleanly */
        .gantt-halfhour-grid .e-gantt-chart .e-chart-row {
            background: transparent; /* keep the repeating-grid visible */
        }

    /* If header misaligns slightly depending on Syncfusion version, try this */
    .gantt-halfhour-grid .e-gantt-timeline {
        position: relative;
        z-index: 3;
    }

</style>
<style scoped>
    .e-yscroll, .e-chart-scroll-container {
        scrollbar-width: thin;
    }
</style>

<div class="card-body">
    <div class="row">
        <DxFormLayout CssClass="w-100">
            <DxFormLayoutItem ColSpanMd="5">

            </DxFormLayoutItem>
            <DxFormLayoutItem Caption="Method Code Name" ColSpanMd="3">
                <DxComboBox Data="@_syrupPlanningList"
                            NullText="Select Method"
                            ListRenderMode="ListRenderMode.Virtual"
                            SearchMode="ListSearchMode.AutoSearch"
                            SearchFilterCondition="ListSearchFilterCondition.Contains"
                            TextFieldName="MethodName"
                            ValueFieldName="DynamicFormDataID"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                            @bind-Value="@SelectDynamicFormDataID" ShowValidationIcon="true">
                </DxComboBox>
            </DxFormLayoutItem>
            <DxFormLayoutItem Caption="Week Of The Month" ColSpanMd="3">
                <DxDateEdit @bind-Date="DateTimeValue"
                            Mask="@DateTimeMask.MonthAndYear"
                            CssClass="cw-320"
                            InputId="deTimeSection" />
            </DxFormLayoutItem>
            <DxFormLayoutItem ColSpanMd="1">
                <button class="btn btn-primary ml-2" @onclick="ApplyDateFilterAsync">Apply filter</button>
            </DxFormLayoutItem>

        </DxFormLayout>
    </div>
</div>


<div class="col-lg-12 control-section">
    <div class="content-wrapper">
        <div class="row">
            @if(Tasks != null)
            {
                <SfGantt TValue="TaskData"
                         DataSource="@Tasks"
                         Height="80vh"
                         Width="100%"
                         DurationUnit="DurationUnit.Minute"
                         HighlightWeekends="true"
                         ProjectStartDate="@ProjectStartDate"
                         ProjectEndDate="@ProjectEndDate"
                         TimelineSettings="@TimelineSettings"
                         DayWorkingTime="@DayWorkingTimes"
                         TaskbarHeight="20"
                         RowHeight="38"
                         CssClass="gantt-halfhour-grid"
                         TreeColumnIndex="1"
                         Toolbar="@(new List<string>() {"ExpandAll", "CollapseAll" })">

                    <GanttTaskFields Id="TaskId"
                                     Name="TaskName"
                                     StartDate="StartDate"
                                     EndDate="EndDate"
                                     Progress="Progress"
                                     ParentID="ParentId"
                                     Dependency="Predecessor">
                    </GanttTaskFields>

                    <GanttColumns>
                        <GanttColumn Field="TaskId" HeaderText="ID" Visible="false" Width="70"></GanttColumn>
                        <GanttColumn Field="TaskName" HeaderText="Process Name" Width="260"></GanttColumn>
                        <GanttColumn Field="Room" HeaderText="Room"></GanttColumn>
                    </GanttColumns>
                </SfGantt>
            }
           
        </div>
    </div>
</div>

@code {
    private long? SelectDynamicFormDataID { get; set; }
    DateTime? DateTimeValue { get; set; }
    int? SelectedWeekOfMonth { get; set; }
    int? SelectedMonth { get; set; }
    int? SelectedYear { get; set; }   

    private List<SyrupPlanning> _syrupPlanningList;
    [Parameter]
    public SyrupPlanning? SyrupPlanningData { get; set; }
    private DateTime ProjectStartDate { get; set; } = new DateTime(2021, 4, 2, 8, 0, 0);
    private DateTime ProjectEndDate { get; set; } = new DateTime(2021, 4, 2, 20, 0, 0);
    private IReadOnlyList<TaskData> Tasks { get; set; } = Array.Empty<TaskData>();
    private GanttTimelineSettings TimelineSettings = new()
    {
        TimelineViewMode = TimelineViewMode.Hour,
        TimelineUnitSize = 120,
        TopTier = new GanttTimelineTierSettings
        {
            Unit = TimelineViewMode.Day,
            Format = "ddd, dd MMM"
        },
        BottomTier = new GanttTimelineTierSettings
        {
            Unit = TimelineViewMode.Hour,
            Format = "HH:mm"
        }
    };

    private List<GanttDayWorkingTime> DayWorkingTimes = new()
    {
        new GanttDayWorkingTime { From = 8, To = 20 }
    };
    protected override async Task OnParametersSetAsync()
    {        
        await JSRuntime.InvokeAsync<string>("showLoading");
        await LoadReportDataAsync();
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    protected override async Task OnInitializedAsync()
    {
        DateTimeValue = DateTime.Now;
        await JSRuntime.InvokeAsync<string>("showLoading");
        _syrupPlanningList = await Mediator.Send(new GetSyrupPlanningQuery());
        string profileNo = SyrupPlanningData?.ProfileNo ?? string.Empty;
        DateTime productionDay = DateTime.Today;
        TimeSpan shiftStart = TimeSpan.FromHours(8);
        TimeSpan shiftEnd = TimeSpan.FromHours(20);

        ProjectStartDate = productionDay.Date + shiftStart;
        ProjectEndDate = productionDay.Date + shiftEnd;


        var d = DateTimeValue.Value;
        // Simple week-of-month calculation: days 1-7 => 1, 8-14 => 2, 15-21 => 3, 22-28 => 4, 29+ => 5
        //SelectedWeekOfMonth = ((d.Day - 1) / 7) + 1;
        SelectedMonth = d.Month;
        SelectedYear = d.Year;

        int weekNumber = DateHelper.GetWeekNumber(DateTimeValue.Value);
        SelectedWeekOfMonth = weekNumber;

        //await Task.Delay(2000);
        //var readOnly = await StockQueryRepo.GetProductionGanttAsyncList(profileNo, productionDay, shiftStart);
        //Tasks = readOnly.ToList();

        await JSRuntime.InvokeAsync<string>("hideLoading");

    

    }
    private async Task ApplyDateFilterAsync()
    {
        //var id = SelectDynamicFormDataID;

        if (!DateTimeValue.HasValue)
        {
            SelectedWeekOfMonth = SelectedMonth = SelectedYear = null;
        }
        else
        {
            var d = DateTimeValue.Value;
            // Simple week-of-month calculation: days 1-7 => 1, 8-14 => 2, 15-21 => 3, 22-28 => 4, 29+ => 5
            //SelectedWeekOfMonth = ((d.Day - 1) / 7) + 1;
            SelectedMonth = d.Month;
            SelectedYear = d.Year;


            // Get first day of the month
            DateTime firstDayOfMonth = new DateTime(d.Year, d.Month, 1);
            int offset = DayOfWeekToInt(firstDayOfMonth.DayOfWeek);
            //int weekOfMonth = ((d.Day + offset - 1) / 7) + 1;
            int weekNumber = DateHelper.GetWeekNumber(DateTimeValue.Value);
            SelectedWeekOfMonth = weekNumber;


        }

        await LoadReportDataAsync();
    }
    int DayOfWeekToInt(DayOfWeek day)
    {        
        return (day == DayOfWeek.Sunday) ? 6 : ((int)day - 1);
    }
    private async Task LoadReportDataAsync()
    {
        string profileNo = SyrupPlanningData?.ProfileNo ?? string.Empty;
        DateTime productionDay = DateTime.Today;
        TimeSpan shiftStart = TimeSpan.FromHours(8);
        TimeSpan shiftEnd = TimeSpan.FromHours(20);

        ProjectStartDate = productionDay.Date + shiftStart;
        ProjectEndDate = productionDay.Date + shiftEnd;
        var readOnly = await StockQueryRepo.GetProductionGanttAsyncList(profileNo, productionDay, shiftStart, SelectDynamicFormDataID, SelectedWeekOfMonth, SelectedMonth, SelectedYear);
        Tasks = readOnly.ToList();
    }

}
