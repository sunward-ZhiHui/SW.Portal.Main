@page "/SyrupScheduleGantt"
@using AC.SD.Core.Helpers
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Gantt
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupReportDtos
@inject IStockInformationMasterQueryRepository StockQueryRepo
@inject NavigationManager NavigationManager
@inject IMediator Mediator
@using Application.Queries;
@using MediatR;
@inject IJSRuntime JSRuntime;
@using System.Globalization;

<style>
    /* Container class used in the SfGantt: gantt-halfhour-grid */
    .gantt-halfhour-grid .e-gantt-chart {
        /*
                   Two repeating gradients:
                   - faint line every half-hour (60px)
                   - stronger line every hour (120px)
                   Adjust 60px/120px if you change TimelineUnitSize.
                */
        background-image: repeating-linear-gradient( to right, rgba(0,0,0,0.04) 0px, rgba(0,0,0,0.04) 1px, transparent 1px, transparent 60px ), repeating-linear-gradient( to right, rgba(0,0,0,0.09) 0px, rgba(0,0,0,0.09) 1px, transparent 1px, transparent 120px );
        background-position: left top;
        background-repeat: repeat-y;
        background-size: auto 100%;
    }

        /* Slight tweak to ensure the chart content overlays grid cleanly */
        .gantt-halfhour-grid .e-gantt-chart .e-chart-row {
            background: transparent; /* keep the repeating-grid visible */
        }

    /* If header misaligns slightly depending on Syncfusion version, try this */
    .gantt-halfhour-grid .e-gantt-timeline {
        position: relative;
        z-index: 3;
    }

</style>
<style scoped>
    .e-yscroll, .e-chart-scroll-container {
        scrollbar-width: thin;
    }
</style>

<style>
    .e-gantt-human-resource-toolbar {
        height: 70px;
        display: flex;
        align-items: center;
    }

    #Gantt_Toolbar {
        padding: 5px 0px;
        display: inline !important;
    }

        #Gantt_Toolbar .e-toolbar-item.e-template {
            margin-left: 0px !important;
        }

    .e-human-resource-label {
        font-weight: 400;
        margin-bottom: 0px !important;
        margin-right: 10px;
    }

    .e-gantt-human-resource-use-case {
        height: 500px;
    }

    .sf-hr-header-container {
        background: rgba(var(--color-sf-primary));
    }

        .sf-hr-header-container h1 {
            font-size: 33px;
            padding: 10px;
            color: #fff;
        }

    .sf-gantt-chart-container {
        height: 55%
    }

    .sf-schedule-container {
        height: 36%;
    }

    .sf-hr-card-container {
        padding: 9px 20px 10px !important;
        background: linear-gradient(0deg, rgba(var(--color-sf-primary), 0.08), rgba(var(--color-sf-primary), 0.08)), rgba(var(--color-sf-surface));
        border: 1px solid lightgray;
        margin: 0px !important;
    }

    .sf-hr-card-div {
        padding: 7px 11px 7px 21px !important
    }

    .sf-hr-card-btn {
        float: right;
        border-radius: 7px;
        background: rgba(var(--color-sf-primary));
        color: #fff;
        padding: 1px 11px;
        border: none;
    }

    .e-input-group.sf-hr-dropdown-list {
        border-radius: 3px;
    }

    .e-input-group:not(.e-float-icon-left):not(.e-float-input)::before, .e-input-group:not(.e-float-icon-left):not(.e-float-input)::after {
        background: none !important;
    }

    .e-timeline-top-header-cell, .e-columnheader, .e-gridcontent tr:nth-child(even), .e-chart-root-container tr:nth-child(even):not(.e-active) {
        background: rgba(var(--color-sf-primary-container), 0.2) !important;
    }

    .sf-grid-progress-outer {
        float: left;
        display: inline-block;
        background: #E6E6E6;
        border-radius: 2px;
        width: 100px;
    }

        .sf-grid-progress-outer div {
            background-color: @ProgressBarColor;
            height: 2px;
            border-radius: 4px;
        }

    .fluent2-highcontrast .e-rowcell.e-templatecell.e-active .sf-grid-progress-outer div {
        background-color: #000;
    }

    .sf-grid-progress-inner {
        float: right;
        display: inline;
        font-size: 14px;
        padding: 4px 0px;
        margin-left: 18px;
    }

    .e-gantt-progress-custom {
        display: flex;
        align-items: center;
    }

    .e-gantt .e-gantt-chart .e-gantt-child-taskbar-inner-div, .e-gantt .e-gantt-chart .e-gantt-child-progressbar-inner-div {
        border-radius: 2px !important;
    }

    #Gantt_Toolbar {
        background: none !important;
        box-shadow: none !important;
    }

        #Gantt_Toolbar .e-toolbar-items {
            background: none !important;
        }

    @@media only screen and (max-width:992px) {
        .e-gantt-chart-human-resource {
            width: 100%;
        }

        .e-gantt-human-resource-schedule {
            display: none !important;
        }
    }

    .e-gantt-chart-human-resource {
        width: 75%;
        display: inline-block;
    }

    .e-gantt-human-resource-schedule {
        width: 25% !important;
        display: inline-block;
        float: right;
        padding-left: 10px;
    }

    @@media only screen and (max-width:992px) {
        .e-gantt-chart-human-resource {
            width: 100% !important;
        }

        .e-gantt-human-resource-schedule {
            display: none !important;
            width: 0% !important;
        }
    }

    .e-schedule .e-agenda-view .e-day-border {
        border: none !important;
    }

    .e-calendar, .e-bigger .e-calendar {
        min-width: min-content;
        max-width: max-content;
    }

        .e-calendar .e-header .e-title, .e-bigger .e-calendar .e-header .e-title {
            width: fit-content;
            white-space: nowrap;
        }
</style>

@if (_barCss.Count > 0)
{
    <style>
@foreach (var kv in _barCss)
{
/* Taskbar body + border (cover multiple Syncfusion builds) */
@: .e-gantt .@(kv.Key) .e-taskbar{ background-color:@(kv.Value) !important; border-color:@(kv.Value) !important; }
@: .e-gantt .@(kv.Key) .e-child-taskbar{ background-color:@(kv.Value) !important; border-color:@(kv.Value) !important; }
@: .e-gantt .@(kv.Key) .e-gantt-child-taskbar{ background-color:@(kv.Value) !important; border-color:@(kv.Value) !important; }
@: .e-gantt .@(kv.Key) .e-gantt-child-taskbar-inner-div{ background-color:@(kv.Value) !important; border-color:@(kv.Value) !important; }

/* Progress fill (cover multiple builds) */
@: .e-gantt .@(kv.Key) .e-progressbar{ background-color:@(kv.Value) !important; }
@: .e-gantt .@(kv.Key) .e-child-progressbar{ background-color:@(kv.Value) !important; }
@: .e-gantt .@(kv.Key) .e-gantt-child-progressbar-inner-div{ background-color:@(kv.Value) !important; }
}
    </style>
}


<div class="card-body">
    <div class="row">
        <DxFormLayout CssClass="w-100">
            <DxFormLayoutItem ColSpanMd="5">

            </DxFormLayoutItem>
            <DxFormLayoutItem Caption="Method Code Name" ColSpanMd="3">
                <DxComboBox Data="@_syrupPlanningList"
                            NullText="Select Method"
                            ListRenderMode="ListRenderMode.Virtual"
                            SearchMode="ListSearchMode.AutoSearch"
                            SearchFilterCondition="ListSearchFilterCondition.Contains"
                            TextFieldName="MethodName"
                            ValueFieldName="MethodCodeID"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                            @bind-Value="@SelectDynamicFormDataID" ShowValidationIcon="true">
                </DxComboBox>
            </DxFormLayoutItem>
            <DxFormLayoutItem Caption="Week Of The Month" ColSpanMd="3">
                <DxDateEdit @bind-Date="DateTimeValue"
                            Mask="@DateTimeMask.MonthAndYear"
                            CssClass="cw-320"
                            InputId="deTimeSection" />
            </DxFormLayoutItem>
            <DxFormLayoutItem ColSpanMd="1">
                <button class="btn btn-primary ml-2" @onclick="ApplyDateFilterAsync">Apply filter</button>
            </DxFormLayoutItem>

        </DxFormLayout>
    </div>
</div>
<div class="col-lg-12 control-section">
    <div class="content-wrapper">
        <div class="row">
            @if(Tasks != null)
            {
                <SfGantt @ref="GanttInstance"  TValue="TaskData"
                         DataSource="@Tasks"
                         Height="80vh"
                         Width="100%"
                         ProjectStartDate="@ProjectStartDate"
                         ProjectEndDate="@ProjectEndDate"  
                         DurationUnit="DurationUnit.Hour"
                         TaskbarHeight="20"
                         RowHeight="38"
                         CssClass="gantt-halfhour-grid"
                         TreeColumnIndex="1"
                         Toolbar="@(new List<string>() {"ExpandAll", "CollapseAll" })">

                    <GanttTaskFields Id="TaskId"
                                     Name="TaskName"
                                     StartDate="StartDate"
                                     EndDate="EndDate"
                                     Duration="DurationHours"
                                     Progress="Progress"
                                     ParentID="ParentId"
                                     Dependency="Predecessor">
                    </GanttTaskFields>

                    <GanttColumns>
                        <GanttColumn Field="TaskId" HeaderText="ID" Width="70"></GanttColumn>
                        <GanttColumn Field="TaskName" HeaderText="Process Name" MinWidth="400" ></GanttColumn>
                        <GanttColumn Field="StartDate" HeaderText="Start Date" Width="120"></GanttColumn>
                        <GanttColumn Field="EndDate" HeaderText="End Date" Width="120"></GanttColumn>
                        <GanttColumn Field="DurationHours" HeaderText="Duration" Width="70"></GanttColumn>
                        <GanttColumn Field="Room" HeaderText="Room" MinWidth="120"></GanttColumn>
                    </GanttColumns>

                    <GanttDayWorkingTimeCollection>
                    <GanttDayWorkingTime From="8" To="12.5"></GanttDayWorkingTime>
                    <GanttDayWorkingTime From="14" To="20"></GanttDayWorkingTime>
                </GanttDayWorkingTimeCollection> 
                  
                    @if (ShowMarkers)
                    {
                        <GanttEventMarkers>
                            @foreach (var day in EachDay(ProjectStartDate, ProjectEndDate))
                            {
                                var w = GetLunchWindow(day);
                                <GanttEventMarker Day="@w.start" Label="Lunch start" CssClass="e-lunch-marker-start"></GanttEventMarker>
                                <GanttEventMarker Day="@w.end" Label="Lunch end" CssClass="e-lunch-marker-end"></GanttEventMarker>
                            }
                        </GanttEventMarkers>
                    }

                    <GanttSplitterSettings Position="30%"></GanttSplitterSettings>
                    <GanttLabelSettings RightLabel="TaskName" TValue="TaskData"></GanttLabelSettings>
                    <GanttTimelineSettings TimelineViewMode="TimelineViewMode.Day" TimelineUnitSize="50">
                    <GanttTopTierSettings Unit="TimelineViewMode.Day" Format="@TopFormat"></GanttTopTierSettings>
                    <GanttBottomTierSettings Unit="TimelineViewMode.Hour" Format="@BottomFormat"></GanttBottomTierSettings>
                </GanttTimelineSettings>
                    <GanttEvents TValue="TaskData"
                                 QueryChartRowInfo="@( (QueryChartRowInfoEventArgs<TaskData> e) => OnQueryChartRowInfo(e) )" />


                </SfGantt>
            }
           
        </div>
    </div>
</div>

@code {
     public string TopFormat { get; set; } = "MMM dd, yyyy";
    public string BottomFormat { get; set; } = "hh tt";
    private SfGantt<TaskData>? GanttInstance;
    private List<Object>? toolbarItems;
       DateTime nowLocal = DateTime.Now;
    private long? SelectDynamicFormDataID { get; set; }
    DateTime? DateTimeValue { get; set; }
    int? SelectedWeekOfMonth { get; set; }
    int? SelectedMonth { get; set; }
    int? SelectedYear { get; set; }  
    private TimeSpan LunchStartTime { get; set; } = TimeSpan.FromHours(12.5); // 12:30
    private TimeSpan LunchEndTime { get; set; } = TimeSpan.FromHours(13.5);   // 13:30
    private bool ShowMarkers { get; set; } = true;
    private List<SegmentModel> SegmentCollection { get; set; } = new List<SegmentModel>();

    private List<SyrupPlanning> _syrupPlanningList;
    [Parameter]
    public SyrupPlanning? SyrupPlanningData { get; set; }
    private DateTime ProjectStartDate { get; set; } = new DateTime(2021, 4, 2, 8, 0, 0);
    private DateTime ProjectEndDate { get; set; } = new DateTime(2021, 4, 2, 20, 0, 0);
    private IReadOnlyList<TaskData> Tasks { get; set; } = Array.Empty<TaskData>();
    private string ProgressBarColor { get; set; } = string.Empty;

    private readonly Dictionary<string, string> _barCss = new();

   private void OnQueryChartRowInfo(QueryChartRowInfoEventArgs<TaskData> args)
{
    var d = args.Data;
    if (d == null || string.IsNullOrWhiteSpace(d.BarColor)) return;

    var cls = $"barcolor-{d.TaskId}";
    args.Row.AddClass(new[] { cls });

    _barCss[cls] = d.BarColor!;
    // ensure the <style> block below re-renders after rows report in
    InvokeAsync(StateHasChanged);
}



    private IEnumerable<DateTime> EachDay(DateTime from, DateTime thru)
    {
        for (var day = from.Date; day <= thru.Date; day = day.AddDays(1))
            yield return day;
    }   
    private GanttTimelineSettings TimelineSettings = new()
    {
        TimelineViewMode = TimelineViewMode.Hour,
        TimelineUnitSize = 120,
        TopTier = new GanttTimelineTierSettings
        {
            Unit = TimelineViewMode.Day,
            Format = "ddd, dd MMM"
        },
        BottomTier = new GanttTimelineTierSettings
        {
            Unit = TimelineViewMode.Hour,
            Format = "HH:mm"
        }
    };

    private List<GanttDayWorkingTime> DayWorkingTimes = new()
    {
        new GanttDayWorkingTime { From = 8, To = 20 }
    };
    protected override async Task OnParametersSetAsync()
    {        
        await JSRuntime.InvokeAsync<string>("showLoading");
        await LoadReportDataAsync();
        await JSRuntime.InvokeAsync<string>("hideLoading");
    }
    protected override async Task OnInitializedAsync()
    {
        DateTimeValue = DateTime.Now;
        await JSRuntime.InvokeAsync<string>("showLoading");
        _syrupPlanningList = await Mediator.Send(new GetSyrupPlanningQuery());
        string profileNo = SyrupPlanningData?.ProfileNo ?? string.Empty;
        DateTime productionDay = DateTime.Today;
        TimeSpan shiftStart = TimeSpan.FromHours(8);
        TimeSpan shiftEnd = TimeSpan.FromHours(20);

        ProjectStartDate = productionDay.Date + shiftStart;
        ProjectEndDate = productionDay.Date + shiftEnd;


        var d = DateTimeValue.Value;
        // Simple week-of-month calculation: days 1-7 => 1, 8-14 => 2, 15-21 => 3, 22-28 => 4, 29+ => 5
        //SelectedWeekOfMonth = ((d.Day - 1) / 7) + 1;
        SelectedMonth = d.Month;
        SelectedYear = d.Year;

        int weekNumber = DateHelper.GetWeekNumber(DateTimeValue.Value);
        SelectedWeekOfMonth = weekNumber;

        //await Task.Delay(2000);
        //var readOnly = await StockQueryRepo.GetProductionGanttAsyncList(profileNo, productionDay, shiftStart);
        //Tasks = readOnly.ToList();

        await JSRuntime.InvokeAsync<string>("hideLoading");



    }
    private async Task ApplyDateFilterAsync()
    {
        //var id = SelectDynamicFormDataID;

        if (!DateTimeValue.HasValue)
        {
            SelectedWeekOfMonth = SelectedMonth = SelectedYear = null;
        }
        else
        {
            var d = DateTimeValue.Value;
            // Simple week-of-month calculation: days 1-7 => 1, 8-14 => 2, 15-21 => 3, 22-28 => 4, 29+ => 5
            //SelectedWeekOfMonth = ((d.Day - 1) / 7) + 1;
            SelectedMonth = d.Month;
            SelectedYear = d.Year;


            // Get first day of the month
            DateTime firstDayOfMonth = new DateTime(d.Year, d.Month, 1);
            int offset = DayOfWeekToInt(firstDayOfMonth.DayOfWeek);
            //int weekOfMonth = ((d.Day + offset - 1) / 7) + 1;
            int weekNumber = DateHelper.GetWeekNumber(DateTimeValue.Value); 
            SelectedWeekOfMonth = weekNumber;


        }

        await LoadReportDataAsync();
    }
    int DayOfWeekToInt(DayOfWeek day)
    {        
        return (day == DayOfWeek.Sunday) ? 6 : ((int)day - 1);
    }
     private static (DateTime start, DateTime end) GetCurrentWorkWeekWindow(DateTime nowLocal, TimeSpan shiftStart, TimeSpan shiftEnd)
    {
        // Make Monday = 0, Tuesday = 1, ... Sunday = 6
        int diff = ((int)nowLocal.DayOfWeek + 6) % 7;

        var monday = nowLocal.Date.AddDays(-diff);
        var friday = monday.AddDays(4);

        var start = monday + shiftStart; // Monday 08:00
        var end   = friday + shiftEnd;   // Friday 20:00

        return (start, end);
    }

    private async Task LoadReportDataAsync()
    {
        await JSRuntime.InvokeAsync<string>("showLoading");
         _barCss.Clear();
        string profileNo = SyrupPlanningData?.ProfileNo ?? string.Empty;
        DateTime productionDay = DateTime.Today;
        TimeSpan shiftStart = TimeSpan.FromHours(8);
        TimeSpan shiftEnd = TimeSpan.FromHours(20);

        ProjectStartDate = productionDay.Date + shiftStart;
        ProjectEndDate = productionDay.Date + shiftEnd;

         (var weekStart, var weekEnd) = GetCurrentWorkWeekWindow(nowLocal, shiftStart, shiftEnd);
        ProjectStartDate = weekStart;
        ProjectEndDate   = weekEnd;

        productionDay = weekStart;

        var readOnly = await StockQueryRepo.GetProductionGanttAsyncList(
            profileNo, productionDay, shiftStart,
            SelectDynamicFormDataID, SelectedWeekOfMonth, SelectedMonth, SelectedYear);

        Tasks = readOnly.ToList();
        //SegmentCollection = StockQueryRepo.FlattenSegments(Tasks);

        var startCandidates = Tasks.Where(t => t.StartDate.HasValue).Select(t => t.StartDate!.Value);
        var endCandidates = Tasks.Where(t => t.EndDate.HasValue).Select(t => t.EndDate!.Value);

        if (startCandidates.Any() && endCandidates.Any())
        {
            var minStart = startCandidates.Min();
            var maxEnd = endCandidates.Max();
            ProjectStartDate = minStart.AddMinutes(-30);
            ProjectEndDate = maxEnd.AddMinutes(+30);
        }
        await InvokeAsync(StateHasChanged);
        if (GanttInstance != null)
            await GanttInstance.RefreshAsync();

        await JSRuntime.InvokeAsync<string>("hideLoading");

    }

    private IEnumerable<TaskData> SplitTasksAcrossLunch(IEnumerable<TaskData> source)
    {
        foreach (var t in source)
        {
            if (!(t.StartDate.HasValue && t.EndDate.HasValue))
            {
                yield return t;
                continue;
            }

            var start = t.StartDate.Value;
            var end = t.EndDate.Value;

            // only split single-day tasks
            if (start.Date != end.Date)
            {
                yield return t;
                continue;
            }

            var (ls, le) = GetLunchWindow(start.Date);

            // if no overlap with lunch, keep as is
            if (!(start < le && end > ls))
            {
                yield return t;
                continue;
            }

            // total planned working duration from SQL (minutes)
            var totalMinutes = (int)Math.Round((end - start).TotalMinutes);

            // minutes done before lunch (from start up to lunchStart, but not beyond end)
            int preLunchWorked = 0;
            if (start < ls)
            {
                var preLunchEnd = end < ls ? end : ls; // min(end, lunchStart)
                preLunchWorked = (int)Math.Round((preLunchEnd - start).TotalMinutes);
                if (preLunchWorked < 0) preLunchWorked = 0;
            }

            // lunch overlap within the original [start..end] (just informational)
            var overlapStart = (start > ls) ? start : ls; // max(start, lunchStart)
            var overlapEnd = (end < le) ? end : le; // min(end, lunchEnd)
            int lunchOverlap = overlapStart < overlapEnd
                ? (int)Math.Round((overlapEnd - overlapStart).TotalMinutes)
                : 0;

            // remaining minutes to work after lunch
            int remainingAfterLunch = Math.Max(0, totalMinutes - preLunchWorked);

            long baseId = t.TaskId;
            int? parentId = t.ParentId;

            // 1) Morning segment (only if any minutes before lunch)
            if (preLunchWorked > 0)
            {
                yield return new TaskData
                {
                    TaskId = (int)(baseId * 10 + 1),
                    TaskName = t.TaskName,
                    StartDate = start,
                    EndDate = start.AddMinutes(preLunchWorked), // ends exactly at lunch start in the crossing case
                    Room = t.Room,
                    Progress = t.Progress,
                    ParentId = (int)parentId,
                    Predecessor = t.Predecessor
                };
            }

            // 2) Afternoon segment (only if anything remains)
            if (remainingAfterLunch > 0)
            {
                var seg2Start = le; // start right after lunch
                                    // If the task starts inside lunch, it should also start after lunch
                if (start > ls && start < le) seg2Start = le;

                var seg2End = seg2Start.AddMinutes(remainingAfterLunch);

                // Depend on segment1 if it exists; keep any original predecessor too.
                string? seg2Pred = preLunchWorked > 0
                    ? ((baseId * 10 + 1).ToString()) +
                      (string.IsNullOrWhiteSpace(t.Predecessor) ? "" : $",{t.Predecessor}")
                    : t.Predecessor;

                yield return new TaskData
                {
                    TaskId = (int)(baseId * 10 + 2),
                    TaskName = t.TaskName,
                    StartDate = seg2Start,
                    EndDate = seg2End,
                    Room = t.Room,
                    Progress = t.Progress,
                    ParentId = (int)parentId,
                    Predecessor = seg2Pred
                };
            }

            // skip original
        }
    }

    private (DateTime start, DateTime end) GetLunchWindow(DateTime day)
    {
        var start = day.Date + LunchStartTime; // 12:30
        var end = (day.DayOfWeek == DayOfWeek.Friday)
            ? day.Date + TimeSpan.FromHours(14.5) // 14:30
            : day.Date + LunchEndTime;            // 13:30
        return (start, end);
    }




    private List<GanttDayWorkingTime> GetDayWorkingTimesForDate(DateTime date, bool hasOT)
    {
        bool isFriday = date.DayOfWeek == DayOfWeek.Friday;
        bool hasOTBreak = hasOT;

        // Morning: 8–12
        var times = new List<GanttDayWorkingTime>{new GanttDayWorkingTime { From = 8, To = 12 }};

        // Afternoon depends on Friday lunch
        if (isFriday)
        {
            times.Add(new GanttDayWorkingTime { From = 14, To = hasOTBreak ? 19 : 18 });
        }
        else
        {
            times.Add(new GanttDayWorkingTime { From = 13, To = hasOTBreak ? 19 : 18 });
        }

        return times;
    }

    
}
