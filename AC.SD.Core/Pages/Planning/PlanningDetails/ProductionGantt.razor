@page "/production-gantt"
@using Syncfusion.Blazor.Gantt
@using global::Core.EntityModels
@using Application.Queries
@using Newtonsoft.Json
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupReportDtos
@inject IStockInformationMasterQueryRepository StockQueryRepo
@inject NavigationManager NavigationManager

<div class="col-lg-12 control-section">
    <div class="content-wrapper">
        <SfGantt DataSource="@TaskCollection"
                 Height="600px"
                 Width="100%"
                 HighlightWeekends="true"
                 DurationUnit="DurationUnit.Hour"
                 AllowSelection="true"
                 TreeColumnIndex="1"
                 GridLines="GridLine.Both"
                 ProjectStartDate="@ProjectStartDate"
                 ProjectEndDate="@ProjectEndDate"
                 ScrollToTaskbarOnClick="true">

            <GanttTaskFields Id="TaskId"
                             Name="TaskName"
                             StartDate="StartDate"
                             EndDate="EndDate"
                             ParentID="ParentId"
                             Progress="Progress"
                             Notes="Notes">
            </GanttTaskFields>

            <GanttColumns>
                <GanttColumn Field="TaskId" Width="60" HeaderText="ID" />
                <GanttColumn Field="TaskName" Width="280" HeaderText="Process" ClipMode="Syncfusion.Blazor.Grids.ClipMode.EllipsisWithTooltip" />
                <GanttColumn Field="StartDate" HeaderText="Start" Format="dd-MMM-yyyy HH:mm" Width="180" />
                <GanttColumn Field="EndDate" HeaderText="End" Format="dd-MMM-yyyy HH:mm" Width="180" />
                <GanttColumn Field="Duration" HeaderText="Duration (Hrs)" Width="140" />
                <GanttColumn Field="Progress" HeaderText="Progress" Width="100" />
                <GanttColumn Field="Predecessor" HeaderText="Dependency" Width="160" />
                <GanttColumn Field="Notes" HeaderText="Notes" Width="300" />
            </GanttColumns>

            <GanttEditSettings AllowAdding="false"
                               AllowDeleting="false"
                               AllowEditing="false"
                               AllowTaskbarEditing="false" />
            <GanttLabelSettings LeftLabel="TaskName" TValue="TaskData" />
            <GanttSplitterSettings Position="30%" />

            <GanttDayWorkingTimeCollection>
                <GanttDayWorkingTime From="8" To="12" />
                <GanttDayWorkingTime From="13" To="17" />
            </GanttDayWorkingTimeCollection>

            <GanttTimelineSettings TimelineUnitSize="50">
                <GanttTopTierSettings Unit="TimelineViewMode.Day" Format="ddd dd MMM" />
                <GanttBottomTierSettings Unit="TimelineViewMode.Hour" Format="hh tt" />
            </GanttTimelineSettings>
        </SfGantt>
    </div>
</div>

<style>
    html, body {
        height: 100%;
    }
</style>

@code {
    private DateTime ProjectStartDate { get; set; } = DateTime.Today.AddDays(-1);
    private DateTime ProjectEndDate { get; set; } = DateTime.Today.AddDays(2);
    private List<TaskData> TaskCollection { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Replace with real profile/date/shift values
        string profileNo = "MC-0054";
        DateTime productionDay = new(2025, 10, 11);
        TimeSpan shiftStart = TimeSpan.FromHours(8);

        try
        {
            var result = await StockQueryRepo.GetProductionGanttRowsAsync(profileNo, productionDay, shiftStart);

            if (result != null && result.Any())
            {
                TaskCollection = result.ToList();

                // Auto-derive project range from earliest/latest
                ProjectStartDate = TaskCollection.Min(x => x.StartDate) ?? ProjectStartDate;
                ProjectEndDate = TaskCollection.Max(x => x.EndDate) ?? ProjectEndDate;
            }
            else
            {
                Console.WriteLine("⚠️ No Gantt data found for the specified profile.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading Gantt data: {ex.Message}");
        }
    }
}
