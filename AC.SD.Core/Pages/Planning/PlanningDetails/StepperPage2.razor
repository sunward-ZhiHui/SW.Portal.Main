@page "/syrup-Stepper2"
@using Application.Queries;
@using MediatR
@using System.ComponentModel
@using global::Core.Entities.Views
@using global::Core.Entities
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response
@using global::Core.EntityModels
@inject IJSRuntime jsRuntime
@using global::Core.Repositories.Query
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@inject NavigationManager NavigationManager

<DxFormLayout CaptionPosition="CaptionPosition.Vertical" CssClass="w-100">
    <DxFormLayoutItem Caption="Is there Syrup Simplex to produce?:" ColSpanMd="6">
        <DxRadioGroup Items="@RadioButtonOptions"
                      Value="@Model.IsthereSyrupSimplextoproduce"
                      ValueExpression="@(() => Model.IsthereSyrupSimplextoproduce)"
                      ValueChanged="@((string value) => OnChangeSyrupProduce(value))"
                      Layout="RadioGroupLayout.Horizontal"
                      CssClass="dx-demo-radio-group" />
    </DxFormLayoutItem>

    @* Render the rest only when user selected "Yes" *@
    @if (string.Equals(Model.IsthereSyrupSimplextoproduce, "Yes", StringComparison.OrdinalIgnoreCase))
    {
        <DxFormLayoutItem Caption="ProcessName:" ColSpanMd="6">
            <DxTextBox @bind-Text="Model.SyrupSimplexProcessName" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Location:" ColSpanMd="6">
            <DxTextBox @bind-Text="Model.SyrupSimplexLocation" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Preparation /Hour:" ColSpanMd="6">
            <DxTextBox @bind-Text="Model.SyrupSimplexPreparationHour" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Syrup Simplex/Manpower:" ColSpanMd="6">
            <DxSpinEdit @bind-Value="Model.SyrupSimplexManpower" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Level 2 Cleaning/Hours:" ColSpanMd="6">
            <DxTextBox @bind-Text="Model.SyrupSimplexLevel2CleaningHours" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Level 2 Cleaning/Manpower:" ColSpanMd="6">
            <DxSpinEdit @bind-Value="Model.SyrupSimplexLevel2CleaningManpower" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="No of Campaign:" ColSpanMd="6">
            <DxSpinEdit @bind-Value="Model.SyrupSimplexNoofCampaign" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Next Process Name:" ColSpanMd="6">
            <DxTextBox @bind-Text="Model.SyrupSimplexNextProcessName" @oninput="OnInputChanged" />
        </DxFormLayoutItem>
    }
</DxFormLayout>

@code {
    IEnumerable<string> RadioButtonOptions = new[] { "Yes", "No" };
    public ApplicationUser? applicationUser { get; private set; }

    [Parameter]
    public long? DynamicFormDataID { get; set; }

    [Parameter]
    public SyrupPlanning Model { get; set; } = new SyrupPlanning();

    [Parameter]
    public EventCallback<SyrupPlanning> OnChanged { get; set; }

    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        await UpdateDataAsync();
    }

    async Task UpdateDataAsync()
    {
        try
        {
            var serverData = await Mediator.Send(new GetSyrupSimplexDataList(DynamicFormDataID));

            if (serverData != null)
            {
                CopySyrupSimplexValues(serverData, Model);
            }

            if (OnChanged.HasDelegate)
                await OnChanged.InvokeAsync(Model);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"UpdateDataAsync failed: {ex.Message}");
        }
    }

    void CopySyrupSimplexValues(SyrupPlanning source, SyrupPlanning target)
    {
        if (source == null || target == null) return;

        target.DynamicFormDataItemID = source.DynamicFormDataItemID;
        target.DynamicFormDataID = source.DynamicFormDataID;
        target.MethodCodeLineID = source.MethodCodeLineID;
        target.MethodCodeID = source.MethodCodeID;
        target.ProfileNo = source.ProfileNo;

        target.IsthereSyrupSimplextoproduce = source.IsthereSyrupSimplextoproduce;
        target.SyrupSimplexProcessName = source.SyrupSimplexProcessName;
        target.SyrupSimplexLocation = source.SyrupSimplexLocation;
        target.SyrupSimplexPreparationHour = source.SyrupSimplexPreparationHour;
        target.SyrupSimplexManpower = source.SyrupSimplexManpower;
        target.SyrupSimplexLevel2CleaningHours = source.SyrupSimplexLevel2CleaningHours;
        target.SyrupSimplexLevel2CleaningManpower = source.SyrupSimplexLevel2CleaningManpower;
        target.SyrupSimplexNoofCampaign = source.SyrupSimplexNoofCampaign;
        target.SyrupSimplexNextProcessName = source.SyrupSimplexNextProcessName;
    }

    async Task OnChangeSyrupProduce(string value)
    {
        Model.IsthereSyrupSimplextoproduce = value;

        if (string.Equals(value, "No", StringComparison.OrdinalIgnoreCase))
        {
            // Clear the related fields when the user selects "No"
            Model.SyrupSimplexProcessName = null;
            Model.SyrupSimplexLocation = null;
            Model.SyrupSimplexPreparationHour = null;
            Model.SyrupSimplexManpower = 0;
            Model.SyrupSimplexLevel2CleaningHours = null;
            Model.SyrupSimplexLevel2CleaningManpower = 0;
            Model.SyrupSimplexNoofCampaign = 0;
            Model.SyrupSimplexNextProcessName = null;
        }

        // Notify parent about the change (and UI will re-render because of StateHasChanged inside the parent if needed)
        if (OnChanged.HasDelegate)
            await OnChanged.InvokeAsync(Model);

        StateHasChanged();
    }

    private async Task OnInputChanged()
    {
        if (OnChanged.HasDelegate)
        {
            await OnChanged.InvokeAsync(Model);
        }
    }
}
