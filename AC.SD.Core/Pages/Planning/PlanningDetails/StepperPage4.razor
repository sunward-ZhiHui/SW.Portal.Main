@page "/syrup-Stepper4"
@using Application.Queries
@using MediatR
@using global::Core.Entities
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupPlanning
@inject IMediator Mediator
@inject IStockInformationMasterQueryRepository Repo
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@inject NavigationManager NavigationManager

<DxFormLayout CaptionPosition="CaptionPosition.Vertical">
    <!-- 1. Primary Packing -->
    <DxFormLayoutGroup Caption="1. Primary Packing" ColSpanMd="12">
        <DxFormLayoutItem Caption="Process Name" ColSpanMd="6">
            <DxTextBox @bind-Text="EditVM.ProcessName_Primary" @oninput="OnInputChanged" />
           @*  <DxComboBox Data="@ProcessNames"
                        Value="EditVM.ProcessName_Primary"
                        ValueChanged="@((string v) => { EditVM.ProcessName_Primary = v; _ = OnInputChanged(); })"
                        AllowUserInput="false" /> *@
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Next Process Name" ColSpanMd="6">
            <DxTextBox @bind-Text="EditVM.NextProcessName_Primary" @oninput="OnInputChanged" />
         @*    <DxComboBox Data="@ProcessNames"
                        Value="EditVM.NextProcessName_Primary"
                        ValueChanged="@((string v) => { EditVM.NextProcessName_Primary = v; _ = OnInputChanged(); })"
                        AllowUserInput="false" /> *@
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Type of planning" ColSpanMd="6">
            <DxTextBox @bind-Text="EditVM.PlanningType_Primary" @oninput="OnInputChanged" />
            @* <DxComboBox Data="@PlanningTypes"
                        Value="EditVM.PlanningType_Primary"
                        ValueChanged="@((string v) => { EditVM.PlanningType_Primary = v; _ = OnInputChanged(); })"
                        AllowUserInput="false" /> *@
        </DxFormLayoutItem>
    </DxFormLayoutGroup>

    <!-- 2. Machine Filling -->
    <DxFormLayoutGroup Caption="2. Machine Filling" ColSpanMd="12">
        <DxFormLayoutItem Caption="Primary filling machine" ColSpanMd="6">
            <DxTextBox @bind-Text="EditVM.PrimaryFillingMachine" @oninput="OnInputChanged" />
            @* <DxComboBox Data="@Machines"
                        Value="EditVM.PrimaryFillingMachine"
                        ValueChanged="@((string v) => { EditVM.PrimaryFillingMachine = v; _ = OnInputChanged(); })"
                        AllowUserInput="false" /> *@
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="1. Filling/Hours" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.FillingHours_Level1"
                        ValueChanged="@(async (decimal? v) => { EditVM.FillingHours_Level1 = v; await OnInputChanged(); })"
                        Increment="0.1M" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="1. Filling Speed/bottle/minutes" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.Speed_BottlePerMinute"
                        ValueChanged="@(async (decimal? v) => { EditVM.Speed_BottlePerMinute = v; await OnInputChanged(); })"
                        Increment="1" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="1. Filling/Manpower" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.FillingManpower_Level1"
                        ValueChanged="@(async (int? v) => { EditVM.FillingManpower_Level1 = v; await OnInputChanged(); })"
                        Increment="1" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Change Packing Filling/Hours" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.ChangePackingFillingHours"
                        ValueChanged="@(async (decimal? v) => { EditVM.ChangePackingFillingHours = v; await OnInputChanged(); })"
                        Increment="0.1M" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Level 2/Hours" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.FillingHours_Level2"
                        ValueChanged="@(async (decimal? v) => { EditVM.FillingHours_Level2 = v; await OnInputChanged(); })"
                        Increment="0.1M" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Level 2/Manpower" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.FillingManpower_Level2"
                        ValueChanged="@(async (int? v) => { EditVM.FillingManpower_Level2 = v; await OnInputChanged(); })"
                        Increment="1" />
        </DxFormLayoutItem>
    </DxFormLayoutGroup>

    <!-- 4. Secondary Packing -->
    <DxFormLayoutGroup Caption="4. Secondary Packing" ColSpanMd="12">
        <DxFormLayoutItem Caption="Secondary Packing same as Primary time?" ColSpanMd="6">
            <DxCheckBox Checked="EditVM.SecondarySameAsPrimaryTime"
                        CheckedChanged="@((bool v) => { EditVM.SecondarySameAsPrimaryTime = v; _ = OnInputChanged(); })" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Secondary Packing /Hours" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.SecondaryPackingHours"
                        ValueChanged="@(async (decimal? v) => { EditVM.SecondaryPackingHours = v; await OnInputChanged(); })"
                        Increment="0.1M" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="No of Manpower" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.SecondaryManpower"
                        ValueChanged="@(async (int? v) => { EditVM.SecondaryManpower = v; await OnInputChanged(); })"
                        Increment="1" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Process Name" ColSpanMd="6">
            <DxTextBox @bind-Text="EditVM.ProcessName_Secondary" @oninput="OnInputChanged" />
            @* <DxComboBox Data="@ProcessNames"
                        Value="EditVM.ProcessName_Secondary"
                        ValueChanged="@((string v) => { EditVM.ProcessName_Secondary = v; _ = OnInputChanged(); })"
                        AllowUserInput="false" /> *@
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Next process Name" ColSpanMd="6">
            <DxTextBox @bind-Text="EditVM.NextProcessName_Secondary" @oninput="OnInputChanged" />
           @*  <DxComboBox Data="@ProcessNames"
                        Value="EditVM.NextProcessName_Secondary"
                        ValueChanged="@((string v) => { EditVM.NextProcessName_Secondary = v; _ = OnInputChanged(); })"
                        AllowUserInput="false" /> *@
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Require offline packing" ColSpanMd="6">
            <DxRadioGroup Items="@RadioButtonOptions"
                          Value="EditVM.RequireOfflinePacking"
                          ValueChanged="@((string v) => { EditVM.RequireOfflinePacking = v; _ = OnInputChanged(); })"
                          Layout="RadioGroupLayout.Horizontal" />
        </DxFormLayoutItem>
    </DxFormLayoutGroup>
</DxFormLayout>

@code {
    // Parent hookup (same pattern as other steps)
    [Parameter] public SyrupPlanning Model { get; set; } = new SyrupPlanning();
    [Parameter] public EventCallback<SyrupPlanning> OnChanged { get; set; }

    // Options
    IEnumerable<string> RadioButtonOptions = new[] { "Yes", "No" };
    readonly List<string> ProcessNames = new()
    {
        "Syrup - Primary Packing",
        "Syrup - Secondary packing (120Ml)",
        "Syrup - Machine Filling"
    };
    readonly List<string> PlanningTypes = new() { "BMP - Machine Filling", "Manual Filling" };
    readonly List<string> Machines = new() { "Filling Machine A", "Filling Machine B", "Filling Machine C" };

    // Local single-edit model (bind UI to this)
    SyrupFilling EditVM { get; set; } = new();

    // local list used if parent wants to read collection of child rows
    private List<SyrupFilling> _SyrupFillingList = new List<SyrupFilling>();

    public ApplicationUser? applicationUser { get; private set; }

    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        await LoadDataAsync();
    }

    async Task LoadDataAsync()
    {
        try
        {
            if (Model != null && Model.Id > 0)
            {
                // get existing fillings by parent id; take the first if you only want one record
                var rows = await Mediator.Send(new GetSyrupFillingListQuery());
                _SyrupFillingList = rows?.ToList() ?? new List<SyrupFilling>();

                var first = _SyrupFillingList.FirstOrDefault();
                if (first != null)
                {
                    EditVM = new SyrupFilling
                    {
                        ID = first.ID,
                        SyrupPlanningID = first.SyrupPlanningID,
                        ProfileNo = first.ProfileNo,
                        ProcessName_Primary = first.ProcessName_Primary,
                        NextProcessName_Primary = first.NextProcessName_Primary,
                        PlanningType_Primary = first.PlanningType_Primary,
                        PrimaryFillingMachine = first.PrimaryFillingMachine,
                        TypeOfPlanningProcess = first.TypeOfPlanningProcess,
                        FillingHours_Level1 = first.FillingHours_Level1,
                        FillingManpower_Level1 = first.FillingManpower_Level1,
                        Speed_BottlePerMinute = first.Speed_BottlePerMinute,
                        ChangePackingFillingHours = first.ChangePackingFillingHours,
                        FillingHours_Level2 = first.FillingHours_Level2,
                        FillingManpower_Level2 = first.FillingManpower_Level2,
                        SecondarySameAsPrimaryTime = first.SecondarySameAsPrimaryTime,
                        SecondaryPackingHours = first.SecondaryPackingHours,
                        SecondaryManpower = first.SecondaryManpower,
                        ProcessName_Secondary = first.ProcessName_Secondary,
                        NextProcessName_Secondary = first.NextProcessName_Secondary,
                        RequireOfflinePacking = first.RequireOfflinePacking,
                        ModifiedBy = first.ModifiedBy,
                        ModifiedDate = first.ModifiedDate,
                        AddedByUserID = first.AddedByUserID,
                        Description = first.Description
                    };
                }
                else
                {
                    // new blank record with parent FK filled if known
                    EditVM = new SyrupFilling
                    {
                        SyrupPlanningID = Model.Id,
                        AddedByUserID = applicationUser?.UserID,
                        ModifiedBy = applicationUser?.LoginID,
                        ModifiedDate = DateTime.Now
                    };
                }
            }
            else
            {
                // parent not saved yet — create blank VM
                EditVM = new SyrupFilling
                {
                    SyrupPlanningID = 0,
                    AddedByUserID = applicationUser?.UserID,
                    ModifiedBy = applicationUser?.LoginID,
                    ModifiedDate = DateTime.Now
                };
            }
        }
        catch (Exception ex)
        {
            toastService.ShowToast("Failed to load filling data: " + ex.Message, AC.SD.Core.Services.ToastLevel.Error);
            // fallback blank
            EditVM = new SyrupFilling { SyrupPlanningID = Model?.Id ?? 0 };
        }
    }

    // called whenever a field changes — update audit info and notify parent
    private async Task OnInputChanged()
    {
        EditVM.ModifiedBy = applicationUser?.LoginID;
        EditVM.ModifiedDate = DateTime.Now;

        // keep local list in sync (single-record behavior)
        _SyrupFillingList = new List<SyrupFilling> { EditVM };

        if (OnChanged.HasDelegate)
            await OnChanged.InvokeAsync(Model);
    }

    // Expose to parent: the child rows to persist during final save
    public List<SyrupFilling> GetLocalSyrupFilling()
    {
        // ensure FK aligns with parent
        if (Model != null && Model.Id > 0) EditVM.SyrupPlanningID = Model.Id;
        return new List<SyrupFilling> { EditVM };
    }
}
