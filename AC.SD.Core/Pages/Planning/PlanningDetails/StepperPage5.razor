@page "/syrup-Stepper5"
@using Application.Queries
@using MediatR
@using global::Core.Entities
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupPlanning
@inject IMediator Mediator
@inject IStockInformationMasterQueryRepository Repo
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@inject NavigationManager NavigationManager

<DxFormLayout CaptionPosition="CaptionPosition.Vertical">
    <DxFormLayoutGroup Caption="1. Other additional job (single record)" ColSpanMd="12">

        <DxFormLayoutItem Caption="Other Jobs Information" ColSpanMd="6">
            <DxRadioGroup Items="@OtherJobsOptions"
                          Value="@EditVM.OtherJobsInformation"
                          ValueExpression="@(() => EditVM.OtherJobsInformation)"
                          ValueChanged="@((string v) => { EditVM.OtherJobsInformation = v; _ = OnInputChanged(); })"
                          Layout="RadioGroupLayout.Horizontal" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Process Name" ColSpanMd="6">
            <DxTextBox @bind-Text="@EditVM.ProcessName" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Must complete to have next process?" ColSpanMd="6">
            <DxRadioGroup Items="@CompletNextprocessOptions"
                          Value="@EditVM.MustCompleteForNext"
                          ValueExpression="@(() => EditVM.MustCompleteForNext)"
                          ValueChanged="@((string v) => { EditVM.MustCompleteForNext = v; _ = OnInputChanged(); })"
                          Layout="RadioGroupLayout.Horizontal" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Next Process" ColSpanMd="6">
            <DxTextBox @bind-Text="@EditVM.SyrupOtherProcessNextProcess" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Location of process" ColSpanMd="6">
            <DxTextBox @bind-Text="@EditVM.LocationOfProcess" @oninput="OnInputChanged" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="No of manpower" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.NoOfManpower"
                        ValueChanged="@(async (int? v) => { EditVM.NoOfManpower = v; await OnInputChanged(); })"
                        Increment="1" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="No of Manhours/Hours" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.ManhoursOrHours"
                        ValueChanged="@(async (decimal? v) => { EditVM.ManhoursOrHours = v; await OnInputChanged(); })"
                        Increment="0.5M" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Manpower is from next process?" ColSpanMd="6">
            <DxRadioGroup Items="@ManpowerFromNextProcessOptions"
                          Value="@EditVM.ManpowerFromNextProcess"
                          ValueExpression="@(() => EditVM.ManpowerFromNextProcess)"
                          ValueChanged="@((string v) => { EditVM.ManpowerFromNextProcess = v; _ = OnInputChanged(); })"
                          Layout="RadioGroupLayout.Horizontal" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Can carryout on non work day?" ColSpanMd="6">
            <DxRadioGroup Items="@CanCarryoutOnNonWorkdayOptions"
                          Value="@EditVM.CanCarryoutOnNonWorkday"
                          ValueExpression="@(() => EditVM.CanCarryoutOnNonWorkday)"
                          ValueChanged="@((string v) => { EditVM.CanCarryoutOnNonWorkday = v; _ = OnInputChanged(); })"
                          Layout="RadioGroupLayout.Horizontal" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Time Gap/Hour" ColSpanMd="6">
            <DxSpinEdit Value="EditVM.TimeGapHour"
                        ValueChanged="@(async (decimal? v) => { EditVM.TimeGapHour = v; await OnInputChanged(); })"
                        Increment="0.5M" />
        </DxFormLayoutItem>

    </DxFormLayoutGroup>
</DxFormLayout>

@code {
    // Parameters for parent communication
    [Parameter] public SyrupPlanning Model { get; set; } = new SyrupPlanning();
    [Parameter] public EventCallback<SyrupPlanning> OnChanged { get; set; }

    // Lookups / options
    IEnumerable<string> OtherJobsOptions = new[] { "Before specific process", "After Specific Process", "Parallel with specific job" };
    IEnumerable<string> CompletNextprocessOptions = new[] { "Yes", "No, can run parallel" };
    IEnumerable<string> ManpowerFromNextProcessOptions = new[] { "Yes", "Not necessary" };
    IEnumerable<string> CanCarryoutOnNonWorkdayOptions = new[] { "Yes", "No" };

    // single-edit view model (child record)
    SyrupOtherProcess EditVM { get; set; } = new SyrupOtherProcess();

    public ApplicationUser? applicationUser { get; private set; }

    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");

        // If parent has an ID, try to load the existing single child for that parent.
        if (Model != null && Model.Id > 0)
        {
            try
            {
                // Use repo method that fetches by parent id. Replace with your Mediator call if needed.
                var list = await Mediator.Send(new GetSyrupOtherProcessListQuery());
                var first = list?.FirstOrDefault();

                if (first != null)
                {
                    EditVM = new SyrupOtherProcess
                    {
                        ID = first.ID,
                        SyrupPlanningID = first.SyrupPlanningID,
                        DynamicFormID = first.DynamicFormID,
                        OtherJobsInformation = first.OtherJobsInformation,
                        ProcessName = first.ProcessName,
                        ProfileNo = first.ProfileNo,
                        SyrupOtherProcessNextProcess = first.SyrupOtherProcessNextProcess,
                        MustCompleteForNext = first.MustCompleteForNext,
                        LocationOfProcess = first.LocationOfProcess,
                        ManhoursOrHours = first.ManhoursOrHours,
                        NoOfManpower = first.NoOfManpower,
                        ManpowerFromNextProcess = first.ManpowerFromNextProcess,
                        CanCarryoutOnNonWorkday = first.CanCarryoutOnNonWorkday,
                        TimeGapHour = first.TimeGapHour,
                        AddedByUserID = first.AddedByUserID,
                        ModifiedBy = first.ModifiedBy,
                        ModifiedDate = first.ModifiedDate
                    };
                }
                else
                {
                    // create a new record stub bound to parent
                    EditVM = new SyrupOtherProcess
                    {
                        SyrupPlanningID = Model.Id,
                        AddedByUserID = applicationUser?.UserID,
                        ModifiedBy = applicationUser?.LoginID,
                        ModifiedDate = DateTime.Now
                    };
                }
            }
            catch (Exception ex)
            {
                toastService.ShowToast("Failed to load other process: " + ex.Message, AC.SD.Core.Services.ToastLevel.Error);
                // fallback to empty VM
                EditVM = new SyrupOtherProcess { SyrupPlanningID = Model.Id };
            }
        }
        else
        {
            // Parent not saved yet — prepare blank child with no parent id
            EditVM = new SyrupOtherProcess
            {
                SyrupPlanningID = 0,
                AddedByUserID = applicationUser?.UserID,
                ModifiedBy = applicationUser?.LoginID,
                ModifiedDate = DateTime.Now
            };
        }
    }

    // Called after any input change — updates audit info and notifies parent.
    private async Task OnInputChanged()
    {
        // update audit info
        EditVM.ModifiedBy = applicationUser?.LoginID;
        EditVM.ModifiedDate = DateTime.Now;

        // Optionally copy some values to parent Model (if you want them mirrored)
        // e.g. Model.SomeChildSummary = EditVM.ProcessName;

        if (OnChanged.HasDelegate)
            await OnChanged.InvokeAsync(Model);
    }

    // Expose the single current child as a list so parent code that expects IEnumerable still works.
    public List<SyrupOtherProcess> GetLocalOtherProcesses()
    {
        if (EditVM == null) return new List<SyrupOtherProcess>();
        // Ensure FK matches parent
        if (Model != null && Model.Id > 0) EditVM.SyrupPlanningID = Model.Id;
        return new List<SyrupOtherProcess> { EditVM };
    }
}
