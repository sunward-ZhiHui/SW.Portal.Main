@page "/syrup-report"
@using Application.Queries
@using MediatR
@using global::Core.Entities
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupReportDtos
@using static global::Core.EntityModels.SyrupPlanning
@inject IMediator Mediator
@inject IStockInformationMasterQueryRepository Repo
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@inject NavigationManager NavigationManager

<style>
    .report-card {
        margin-bottom: 20px;
    }

    .overview-cards .card {
        min-height: 120px;
    }

    .process-flow {
        display: flex;
        gap: 18px;
        align-items: flex-start;
        flex-wrap: wrap;
    }

    .process-step {
        border: 1px solid #2b8cc4;
        border-radius: 6px;
        padding: 14px;
        width: 185px;
        background: #fff;
        box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }

        .process-step .title {
            font-weight: 700;
            color: #1f6fa5;
            margin-bottom: 6px;
        }

        .process-step .meta {
            font-size: 0.9rem;
            color: #666;
        }

    .critical-note {
        background: #fff3cd;
        border-left: 4px solid #ffd966;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
    }

    .table-small td, .table-small th {
        padding: .55rem;
        font-size: .95rem;
    }

    .muted-note {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>

<div class="py-4">
    <div class="card report-card">
        <div class="card-body">
            <h3 class="card-title">@Overview?.MethodCodeName</h3>
        </div>
    </div>

    <div class="row" style="margin-bottom:10px;">
        <div class="col-md-9"></div>
       <div class="col-md-2">
            <DxDateEdit @bind-Date="DateTimeValue"                        
                        Mask="@DateTimeMask.MonthAndYear"
                        CssClass="cw-320"
                        InputId="deTimeSection" />
       </div>
        <div class="col-md-1">
            <button class="btn btn-primary ml-2" @onclick="ApplyDateFilterAsync">Apply filter</button>
        </div>
    </div>


   

    <!-- Timing Details -->

    <DxGrid @ref="Grid"
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            ShowGroupPanel="true"
            ShowGroupedColumns="true"
            ShowSearchBox="true"
            Data="TimingDetails"
            KeyFieldName="ID"
            CustomizeElement="Grid_CustomizeElement"
            TextWrapEnabled="false"            
            PagerNavigationMode="PagerNavigationMode.InputBox"
            PageSizeSelectorVisible="true"
            PageSizeSelectorAllRowsItemVisible="true"
            PageSizeSelectorItems="@(new int[] { 5,10,20 })"
            PageSize="20"
            SelectionMode="GridSelectionMode.Single"
            ValidationEnabled="true"
            AutoExpandAllGroupRows="true"
            CssClass="ch-360 " 
            FocusedRowEnabled="true"            
            EditMode="GridEditMode.EditForm"
            VirtualScrollingEnabled="true"
            AllowSelectRowByClick="true">
        <Columns>           
            <DxGridDataColumn FieldName="ProcessName" Caption="Process Name" />
            <DxGridDataColumn FieldName="StartDate" Caption="Start Date" Width="230">
                <CellDisplayTemplate>
                    @{
                        var item = (TimingRowVm)context.DataItem;
                    }
                    @Application.Common.Helper.Helper.FormatDateTime(item.StartDate)
                </CellDisplayTemplate>
            </DxGridDataColumn>
            <DxGridDataColumn FieldName="EndDate" Caption="End Date" Width="180" >
                <CellDisplayTemplate>
                    @{
                        var item = (TimingRowVm)context.DataItem;
                    }
                    @Application.Common.Helper.Helper.FormatDateTime(item.EndDate)
                </CellDisplayTemplate>
            </DxGridDataColumn>
            <DxGridDataColumn FieldName="Location" Caption="Room"  />            
            <DxGridDataColumn FieldName="DurationHours" Caption="Duration Hours" Width="180" />
            <DxGridDataColumn FieldName="Manpower" Caption="Man power" Width="180" />
            <DxGridDataColumn FieldName="NextProcessTimeline" Caption="Next Process Timeline"  />
        </Columns>
        <TotalSummary>
            <DxGridSummaryItem SummaryType="GridSummaryItemType.Count" FieldName="ProcessName" />
        </TotalSummary>
    </DxGrid>
      
    <!-- Machine Info -->
    <div class="card report-card">
        <div class="card-body">
            <h5>Machine Information</h5>
            @if (MachineInfos?.Any() ?? false)
            {
                <table class="table table-bordered table-small">
                    <thead class="thead-light">
                        <tr><th>Machine</th><th>Type</th><th>Capacity</th><th>Speed</th><th>Notes</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var m in MachineInfos)
                        {
                            <tr>
                                <td>@m.Name</td>
                                <td>@m.Type</td>
                                <td>@m.Capacity</td>
                                <td>@m.Speed</td>
                                <td>@m.Notes</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="muted-note">No machine data.</div>
            }
        </div>
    </div>

    <!-- Product Items -->
    <div class="card report-card">
        <div class="card-body">
            <h5>Product Items</h5>
            <table class="table table-bordered table-small">
                <thead class="thead-light">
                    <tr><th>Product Name</th><th>Code</th><th>Description</th></tr>
                </thead>
                <tbody>
                    @if (ProductItems?.Any() ?? false)
                    {
                        @foreach (var p in ProductItems)
                        {
                            <tr>
                                <td>@p.Name</td>
                                <td>@p.Code</td>
                                <td>@p.PackSize</td>                                
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="4" class="muted-note">No product items.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
      
</div>
@code {
    DateTime? DateTimeValue { get; set; } = DateTime.Now;

    int? SelectedWeekOfMonth { get; set; }
    int? SelectedMonth { get; set; }
    int? SelectedYear { get; set; }

    [Parameter] 
    public SyrupPlanning? SyrupPlanningData { get; set; }

    IGrid Grid { get; set; }
    [Parameter]
    public int? MethodCodeID { get; set; } = 70;
    [Parameter]
    public long? SyrupPlanningId { get; set; } = 1;
    [Parameter]
    public string? ProfileNo { get; set; } = "MC-0054";
    DateTime productionDay = DateTime.Now;
    TimeSpan shiftStart = TimeSpan.FromHours(8); 



    async Task ApplyDateFilterAsync()
    {
        if (!DateTimeValue.HasValue)
        {
            SelectedWeekOfMonth = SelectedMonth = SelectedYear = null;
        }
        else
        {
            var d = DateTimeValue.Value;
            // Simple week-of-month calculation: days 1-7 => 1, 8-14 => 2, 15-21 => 3, 22-28 => 4, 29+ => 5
            SelectedWeekOfMonth = ((d.Day - 1) / 7) + 1;
            SelectedMonth = d.Month;
            SelectedYear = d.Year;
        }

        await LoadReportDataAsync();
    }

    async Task ClearDateFilterAsync()
    {
        DateTimeValue = null;
        SelectedWeekOfMonth = SelectedMonth = SelectedYear = null;
        await LoadReportDataAsync();
    }
    async Task LoadReportDataAsync()
    {
        var lst = SyrupPlanningData;
        try
        {
            string profile = lst.ProfileNo;

            if (!string.IsNullOrEmpty(profile))
            {

                Overview = await Repo.GetTimingOverviewByProfileNoAsync(profile) ?? new TimingOverviewDto { ProfileNo = profile };
                var pf = await Repo.GetProcessFlowByProfileNoAsync(lst.DynamicFormDataID, productionDay, shiftStart, SelectedWeekOfMonth,SelectedMonth,SelectedYear);
                //var td = await Repo.GetTimingDetailsByProfileNoAsync(profile);
                var td = await Repo.GetProcessFlowByProfileNoAsync(lst.DynamicFormDataID, productionDay, shiftStart, SelectedWeekOfMonth,SelectedMonth,SelectedYear);
                var machines = await Repo.GetMachineInfoByProfileNoAsync(profile);
                var products = MethodCodeID.HasValue ? await Repo.GetProductItemsByMethodCodeAsync(MethodCodeID.Value) : new List<ProductItemDto>();

                // map as before
                if (pf != null && pf.Any())
                {
                    ProcessFlow = pf.Select(x => new ProcessStepVm
                    {
                        Title = x.TaskName,
                        Subtitle = x.Room,
                        DurationHours = x.DurationHours,
                        Notes = x.Notes
                    }).ToList();
                }

                TimingDetails = td?.Select(r => new TimingRowVm
                {
                    ID = r.Seq,
                    ProcessName = r.TaskName,
                    DurationHours = r.DurationHours,
                    StartDate = r.StartDate,
                    EndDate = r.EndDate,
                    Manpower = r.Manpower,
                    Location = r.Room,
                    NextProcessTimeline = r.NextProcess_Timeline,
                    Notes = r.Notes
                }).ToList() ?? new();

                MachineInfos = machines?.Select(m => new MachineVm
                {
                    Name = m.Machine,
                    Type = m.Type,
                    Capacity = m.Capacity,
                    Speed = m.Speed,
                    Notes = m.Notes
                }).ToList() ?? new();

                ProductItems = products?.Select(p => new ProductVm
                {
                    Name = p.Description,
                    Code = p.No,
                    PackSize = p.Description2,
                    Notes = p.CategoryID?.ToString()
                }).ToList() ?? new();
            }
            else
            {
                toastService.ShowToast("No profile or method code supplied to render report.", AC.SD.Core.Services.ToastLevel.Warning);
            }
        }
        catch (Exception ex)
        {
            toastService.ShowToast("Failed to load report: " + ex.Message, AC.SD.Core.Services.ToastLevel.Error);
        }
        
    }


    // simple view models for the component
    class OverviewVm
    {
        public string? WorkingHours { get; set; }
        public string? WorkingHoursNote { get; set; }
        public string? FillingSpeed { get; set; }
        public string? FillingSpeedNote { get; set; }
        public string? BatchSize { get; set; }
        public string? BatchSizeNote { get; set; }
        public string? ShortNote { get; set; }
    }

    class ProcessStepVm 
    { 
        public string Title { get; set; } 
        public string Subtitle { get; set; } 
        public decimal? DurationHours { get; set; } 
        public string Notes { get; set; } 
    }
    class TimingRowVm 
    { 
        public long ID { get; set; }
        public string? ProcessName { get; set; } 
        public decimal? DurationHours { get; set; } 
        public decimal? Manpower { get; set; }
        public string Location { get; set; } 
        public string Notes { get; set; } 
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public string? Room { get; set; }
        public string? NextProcessTimeline { get; set; }
    }
    class MachineVm { public string Name { get; set; } public string Type { get; set; } public string Capacity { get; set; } public string Speed { get; set; } public string Notes { get; set; } }
    class ProductVm { public string Name { get; set; } public string Code { get; set; } public string PackSize { get; set; } public string Notes { get; set; } }
    class ConsiderationVm { public string Title { get; set; } public string Description { get; set; } }

    //OverviewVm Overview;
    List<ProcessStepVm> ProcessFlow = new();
    //List<TimingRowVm> TimingDetails = new();
    List<TimingRowVm> TimingDetails = new();
    List<MachineVm> MachineInfos = new();
    List<ProductVm> ProductItems = new();
    List<ConsiderationVm> KeyConsiderations = new();

 
    TimingOverviewDto? Overview;

    protected override async Task OnInitializedAsync()
    {
        var lst = SyrupPlanningData;

        if (!DateTimeValue.HasValue)
        {
            SelectedWeekOfMonth = SelectedMonth = SelectedYear = null;
        }
        else
        {
            var d = DateTimeValue.Value;
            // Simple week-of-month calculation: days 1-7 => 1, 8-14 => 2, 15-21 => 3, 22-28 => 4, 29+ => 5
            SelectedWeekOfMonth = ((d.Day - 1) / 7) + 1;
            SelectedMonth = d.Month;
            SelectedYear = d.Year;
        }

        await LoadReportDataAsync();
        
    }


    string FormatDuration(decimal? hours)
    {
        if (!hours.HasValue) return "—";
        var h = hours.Value;
        if (h < 1) return $"{h * 60:N0} min";
        return $"{h:N1} hrs";
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
            e.CssClass += "non-selectable-row";
        }
    }
}
