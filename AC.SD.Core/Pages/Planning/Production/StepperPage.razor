@page "/syrup-stepper"
@using System.ComponentModel.DataAnnotations
@using AC.SD.Core.Helpers
@using DevExpress.Blazor
@using Syncfusion.Blazor.Navigations
@using global::Core.Entities
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupPlanning
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IStockInformationMasterQueryRepository Repo

<style scoped>
    .step-content {
        border: 1px solid #eee;
        padding: 10px;
    }

    .e-stepper.e-horizontal {
        margin-top: 10px;
    }

    .stepper-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #ffffff;
        border-top: 1px solid #ddd;
        padding: 10px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        z-index: 1000;
    }

    .nav-button {
        padding: 8px 18px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color .3s ease, opacity .3s ease;
    }

        .nav-button.prevv {
            background-color: #3498db;
            color: #fff;
        }

            .nav-button.prevv:hover:not(:disabled) {
                background-color: #217dbb;
            }

        .nav-button.nextt {
            background-color: #2ecc71;
            color: #fff;
        }

            .nav-button.nextt:hover:not(:disabled) {
                background-color: #27ae60;
            }

        .nav-button:disabled {
            background-color: #d3d3d3;
            color: #888;
            cursor: not-allowed;
            opacity: .6;
        }
</style>

@if (isLoadingSteps)
{
    <div>Loading steps…</div>
}
else
{
    <SfStepper @key="VisibleSteps.Count" @bind-ActiveStep="currentStep">
        <StepperSteps>
            @foreach (var step in VisibleSteps)
            {
                <StepperStep Label="@step" IconCss="fa fa-check" />
            }
        </StepperSteps>
    </SfStepper>
}

@if (SyrupPlanningData != null)
{
    <div style="background:#f1f1f1; padding:10px; border:1px solid #f1f1f1;">
        @SyrupPlanningData.MethodCode
    </div>
}

<div class="step-content">
    @if (VisibleSteps.Count == 0)
    {
        <p>No steps available</p>
    }
    else
    {
        var currentStepName = VisibleSteps[Math.Clamp(currentStep, 0, VisibleSteps.Count - 1)];
        @switch (currentStepName)
        {
            case "Process Name":
                <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage1 DynamicFormDataID="@(SyrupPlanningData?.DynamicFormDataID ?? 0)" />
                break;

            case "Other process":
                <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage5 @ref="stepper5Ref" Model="Model" OnChanged="OnChildChanged" />
                break;

            case "Syrup Simplex process":
                <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage2 DynamicFormDataID="@(SyrupPlanningData?.DynamicFormDataID ?? 0)" Model="Model" OnChanged="OnChildChanged" />
                break;

            case "Syrup Preparation":
                <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage3 DynamicFormDataID="@(SyrupPlanningData?.DynamicFormDataID ?? 0)" Model="Model" OnChanged="OnChildChanged" />
                break;

            case "Specific item Card":
                <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage4 DynamicFormDataID="@(SyrupPlanningData?.DynamicFormDataID ?? 0)" @ref="stepper4Ref" Model="Model" OnChanged="OnChildChanged" />
                break;

            default:
                <p>Unknown step</p>
                break;
        }
    }
</div>

<!-- Footer Navigation -->
<div class="stepper-footer">
    <button @onclick="prevvStep"
            class="nav-button prevv"
            disabled="@(currentStep == 0 || IsBusy)">
        Previous
    </button>

    <button @onclick="HandleNextOrSubmit"
            class="nav-button nextt"
            disabled="@IsNextDisabled">
        @(IsLastStep ? (IsBusy ? "Submitting..." : "Submit") : "Next")
    </button>
</div>

@code {
    private AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage5 stepper5Ref;
    private AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage4 stepper4Ref;

    private bool isOtherProcess = false;
    private bool isLoadingSteps = false;
    private List<string> VisibleSteps { get; set; } = new();

    [Parameter] public SyrupPlanning? SyrupPlanningData { get; set; }
    [Parameter] public EventCallback OnSaveCompleted { get; set; }
    [Parameter] public EventCallback<SyrupPlanning?> OnSubmit { get; set; }

    private SyrupPlanning Model = new SyrupPlanning();
    public ApplicationUser applicationUser { get; private set; }

    public long DynamicFormDataID { get; set; }
    public long MethodCodeID { get; set; }
    DateTime? DateTimeValue { get; set; } = DateTime.Now;
    int currentStep = 0;
    bool IsBusy = false;

    bool IsLastStep => currentStep == VisibleSteps.Count - 1;
    bool IsNextDisabled => IsBusy || VisibleSteps.Count == 0;

    private Task OnChildChanged(SyrupPlanning partial)
    {
        StateHasChanged();
        return Task.CompletedTask;
    }

    protected override async Task OnParametersSetAsync()
    {
        // get cached user
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");

        // if there's no SyrupPlanningData yet, don't build steps
        if (SyrupPlanningData == null)
        {
            VisibleSteps = new List<string>(); // ensure empty
            return;
        }

        DynamicFormDataID = SyrupPlanningData.DynamicFormDataID;
        MethodCodeID = SyrupPlanningData.MethodCodeID;

        isLoadingSteps = true;
        StateHasChanged();

        try
        {
            // Await your async repo call to check existence
            isOtherProcess = await Repo.CheckSyrupOtherProcessExists(DynamicFormDataID);
        }
        catch
        {
            // if DB check fails, default to false - consider logging the error
            isOtherProcess = false;
        }

        BuildVisibleSteps();

        // clamp currentStep to valid range
        if (currentStep >= VisibleSteps.Count)
            currentStep = Math.Max(0, VisibleSteps.Count - 1);

        isLoadingSteps = false;

        // ensure UI updates
        StateHasChanged();
    }

    private void BuildVisibleSteps()
    {
        var prevCount = VisibleSteps?.Count ?? 0;

        var list = new List<string> { "Process Name" };

        if (isOtherProcess)
            list.Add("Other process");

        list.AddRange(new[]
        {
            "Syrup Simplex process",
            "Syrup Preparation",
            "Specific item Card"
        });

        VisibleSteps = list;

        // If list grew from 0 to >0, reset current step to 0 (avoid showing blank)
        if (prevCount == 0 && VisibleSteps.Count > 0)
            currentStep = 0;

        // clamp otherwise
        currentStep = Math.Clamp(currentStep, 0, Math.Max(0, VisibleSteps.Count - 1));
    }

    async Task HandleNextOrSubmit()
    {
        if (!IsLastStep)
        {
            nexttStep();
            return;
        }

        await SaveAllAsync();
    }

    void nexttStep()
    {
        if (currentStep < VisibleSteps.Count - 1)
            currentStep++;
    }

    void prevvStep()
    {
        if (currentStep > 0 && !IsBusy)
            currentStep--;
    }

    async Task SubmitAsync()
    {
        try
        {
            IsBusy = true;

            if (OnSubmit.HasDelegate)
            {
                await OnSubmit.InvokeAsync(SyrupPlanningData);
            }
        }
        finally
        {
            IsBusy = false;
        }
    }

    async Task SaveAllAsync()
    {
        try
        {
            IsBusy = true;

            var d = DateTimeValue.Value;
            int weekNumber = DateHelper.GetWeekNumber(DateTimeValue.Value);
            var SelectedWeekOfMonth = weekNumber;
            var SelectedMonth = d.Month;
            var SelectedYear = d.Year;

            // set meta
            Model.AddedByUserID = applicationUser.UserID;
            Model.AddedDate = DateTime.Now;
            Model.ModifiedByUserID = applicationUser.UserID;
            Model.ModifiedDate = DateTime.Now;
            Model.Year = SelectedYear;
            Model.Month = SelectedMonth;
            Model.WeekOfMonth = SelectedWeekOfMonth;

            // copy relevant values (guard SyrupPlanningData not null)
            if (SyrupPlanningData != null)
            {
                Model.DynamicFormDataID = SyrupPlanningData.DynamicFormDataID;
                Model.MethodCodeID = SyrupPlanningData.MethodCodeID;
                Model.DynamicFormDataItemID = SyrupPlanningData.DynamicFormDataItemID;
                Model.ProfileNo = SyrupPlanningData.ProfileNo;
                Model.MethodName = SyrupPlanningData.MethodName;
                Model.BatchSizeInLiters = SyrupPlanningData.BatchSizeInLiters;
            }

            var _SyrupPlanningData = await Repo.InsertOrUpdateSyrupPlanningAsync(Model);
            long newId = _SyrupPlanningData.Id;

            // Other processes (stepper5)
            var childList = stepper5Ref?.GetLocalOtherProcesses() ?? new List<SyrupOtherProcess>();
            foreach (var c in childList)
            {
                c.SyrupPlanningID = newId;
                if (SyrupPlanningData != null)
                {
                    c.DynamicFormDataID = SyrupPlanningData.DynamicFormDataID;
                    c.DynamicFormDataItemID = SyrupPlanningData.DynamicFormDataItemID;
                    c.ProfileNo = SyrupPlanningData.ProfileNo;
                }
                c.AddedByUserID = applicationUser.UserID;
                c.ModifiedDate = DateTime.Now;
            }
            await Repo.SaveSyrupOtherProcessesAsync(newId, childList);

            // Syrup filling (stepper4)
            var syrupFillingList = stepper4Ref?.GetLocalSyrupFilling() ?? new List<SyrupFilling>();
            foreach (var r in syrupFillingList)
            {
                r.SyrupPlanningID = newId;
                if (SyrupPlanningData != null)
                {
                    r.DynamicFormDataID = SyrupPlanningData.DynamicFormDataID;
                    r.DynamicFormDataItemID = SyrupPlanningData.DynamicFormDataItemID;
                    r.ProfileNo = SyrupPlanningData.ProfileNo;
                }
                r.AddedByUserID = applicationUser.UserID;
                r.ModifiedDate = DateTime.Now;
            }
            await Repo.SaveSyrupFillingAsync(newId, syrupFillingList);

            if (OnSaveCompleted.HasDelegate)
                await OnSaveCompleted.InvokeAsync();

            if (OnSubmit.HasDelegate)
                await OnSubmit.InvokeAsync(SyrupPlanningData);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Save failed: " + ex.Message);
            throw;
        }
        finally
        {
            IsBusy = false;
        }
    }
}
