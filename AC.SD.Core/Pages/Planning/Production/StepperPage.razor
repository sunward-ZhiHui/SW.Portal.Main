@page "/syrup-stepper"
@using System.ComponentModel.DataAnnotations
@using DevExpress.Blazor
@using Syncfusion.Blazor.Navigations
@using global::Core.Entities
@using global::Core.EntityModels
@using global::Core.Repositories.Query
@using static global::Core.EntityModels.SyrupPlanning
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject IStockInformationMasterQueryRepository Repo

<style scoped>
    .step-content {
        border: 1px solid #eee;
        padding: 10px;
    }

    .e-stepper.e-horizontal {
        margin-top: 10px;
    }

    .stepper-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #ffffff;
        border-top: 1px solid #ddd;
        padding: 10px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        z-index: 1000;
    }

    .nav-button {
        padding: 8px 18px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color .3s ease, opacity .3s ease;
    }

        .nav-button.prevv {
            background-color: #3498db;
            color: #fff;
        }

            .nav-button.prevv:hover:not(:disabled) {
                background-color: #217dbb;
            }

        .nav-button.nextt {
            background-color: #2ecc71;
            color: #fff;
        }

            .nav-button.nextt:hover:not(:disabled) {
                background-color: #27ae60;
            }

        .nav-button:disabled {
            background-color: #d3d3d3;
            color: #888;
            cursor: not-allowed;
            opacity: .6;
        }
</style>

<SfStepper @bind-ActiveStep="currentStep">
    <StepperSteps>
        <StepperStep Label="Process Name" IconCss="fa fa-check" />
        <StepperStep Label="Other process" IconCss="fa fa-check" />
        <StepperStep Label="Syrup Simplex process" IconCss="fa fa-check" />
        <StepperStep Label="Syrup Preparation" IconCss="fa fa-check" />
        <StepperStep Label="Specific item Card" IconCss="fa fa-check" />
       
    </StepperSteps>
</SfStepper>

@if (SyrupPlanningData != null)
{
    <div style="background:#f1f1f1; padding:10px; border:1px solid #f1f1f1;">
        @SyrupPlanningData.MethodCode
    </div>
}

<div class="step-content">
    @if (currentStep == 0)
    {
        <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage1 />
    }
    else if (currentStep == 1)
    {
        <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage5 @ref="stepper5Ref" Model="Model" OnChanged="OnChildChanged" />
    }
    else if (currentStep == 2)
    {
        <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage2 Model="Model" OnChanged="OnChildChanged" />
    }
    else if (currentStep == 3)
    {
        <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage3 Model="Model" OnChanged="OnChildChanged" />
    }
    else if (currentStep == 4)
    {
        <AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage4 @ref="stepper4Ref" Model="Model" OnChanged="OnChildChanged" />
    }
   @*  else if (currentStep == 5)
    {
        <AC.SD.Core.Pages.Planning.PlanningDetails.VijayPage1 />
    } *@
</div>

<!-- Footer Navigation -->
<div class="stepper-footer">
    <button @onclick="prevvStep"
            class="nav-button prevv"
            disabled="@(currentStep == 0 || IsBusy)">
        Previous
    </button>

    <!-- This button becomes Submit on last step -->
    <button @onclick="HandleNextOrSubmit"
            class="nav-button nextt"
            disabled="@IsNextDisabled">
        @(IsLastStep ? (IsBusy ? "Submitting..." : "Submit") : "Next")
    </button>
</div>

@code {
    private AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage5 stepper5Ref;
    private AC.SD.Core.Pages.Planning.PlanningDetails.StepperPage4 stepper4Ref;
    [Parameter] 
    public EventCallback OnSaveCompleted { get; set; }

    public long MethodCodeID { get; set; }
    private SyrupPlanning Model = new SyrupPlanning();
    public ApplicationUser applicationUser { get; private set; }
    [Parameter] 
    public SyrupPlanning? SyrupPlanningData { get; set; }

    // Parent can subscribe to this to receive the final data.
    [Parameter] public EventCallback<SyrupPlanning?> OnSubmit { get; set; }

    int currentStep = 0;
    int StepCount => 5;
    bool IsBusy = false;

    bool IsLastStep => currentStep == StepCount - 1;
    bool IsNextDisabled =>
        IsBusy || (!IsLastStep && currentStep == StepCount - 1); // safety plus busy state

    private Task OnChildChanged(SyrupPlanning partial)
    {        
        StateHasChanged();
        return Task.CompletedTask;
    }
    protected override async Task OnParametersSetAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        var x = MethodCodeID;       

    }

    async Task HandleNextOrSubmit()
    {
        if (!IsLastStep)
        {
            nexttStep();
            return;
        }

        // Last step => submit
        //await SubmitAsync();
        await SaveAllAsync();
    }

    void nexttStep()
    {
        if (currentStep < StepCount - 1)
        {
            currentStep++;
        }
    }

    void prevvStep()
    {
        if (currentStep > 0 && !IsBusy)
        {
            currentStep--;
        }
    }

    async Task SubmitAsync()
    {
        try
        {
            IsBusy = true;

            // TODO: run any validation you need from sub-pages here.
            // If you have EditForm/FluentValidation, trigger and gate submit.

            // Fire the event to the parent with the collected data
            if (OnSubmit.HasDelegate)
            {
                await OnSubmit.InvokeAsync(SyrupPlanningData);
            }

            // Optionally reset or navigate
            // Navigation or state reset can go here.
        }
        finally
        {
            IsBusy = false;
        }
    }

    async Task SaveAllAsync()
    {
        try
        {
            IsBusy = true;
            var lst = Model;
            Model.AddedByUserID =  applicationUser.UserID;
            Model.AddedDate = DateTime.Now;
            Model.ModifiedByUserID = applicationUser.UserID;
            Model.ModifiedDate = DateTime.Now;

            Model.DynamicFormDataID = SyrupPlanningData.DynamicFormDataID;
            Model.MethodCodeID = SyrupPlanningData.MethodCodeID;
            Model.DynamicFormDataItemID = SyrupPlanningData.DynamicFormDataItemID;
            Model.ProfileNo = SyrupPlanningData.ProfileNo;
            Model.MethodName = SyrupPlanningData.MethodName;
            Model.BatchSizeInLiters = SyrupPlanningData.BatchSizeInLiters;


            var _SyrupPlanningData = await Repo.InsertOrUpdateSyrupPlanningAsync(Model);
            long newId = _SyrupPlanningData.Id;
            var childList = stepper5Ref?.GetLocalOtherProcesses() ?? new List<SyrupOtherProcess>();
            foreach (var c in childList)
            {
                c.SyrupPlanningID = newId;
                c.DynamicFormDataID = SyrupPlanningData.DynamicFormDataID;
                c.DynamicFormDataItemID = SyrupPlanningData.DynamicFormDataItemID;
                c.ProfileNo = SyrupPlanningData.ProfileNo;
                c.AddedByUserID = applicationUser.UserID;             
                c.ModifiedDate = DateTime.Now;
            }
            
            await Repo.SaveSyrupOtherProcessesAsync(newId, childList);


            // get child list from StepperPage4
            var syrupFillingList = stepper4Ref?.GetLocalSyrupFilling() ?? new List<SyrupFilling>();
            foreach (var r in syrupFillingList) 
            {
                r.SyrupPlanningID = newId;
                r.DynamicFormDataID = SyrupPlanningData.DynamicFormDataID;
                r.DynamicFormDataItemID = SyrupPlanningData.DynamicFormDataItemID;
                r.ProfileNo = SyrupPlanningData.ProfileNo;
                r.AddedByUserID = applicationUser.UserID;        
                r.ModifiedDate = DateTime.Now;

            }
            // persist children
            await Repo.SaveSyrupFillingAsync(newId, syrupFillingList);


            if (OnSaveCompleted.HasDelegate)
                await OnSaveCompleted.InvokeAsync();

            // If you have OnSubmit callback to parent, fire it
            if (OnSubmit.HasDelegate)
                await OnSubmit.InvokeAsync(SyrupPlanningData);
           
        }
        catch (Exception ex)
        {
           
            Console.WriteLine("Save failed: " + ex.Message);
            throw;
        }
        finally
        {
            IsBusy = false;
        }
    }

}
