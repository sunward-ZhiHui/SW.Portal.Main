@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject ClipboardService ClipboardService
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@implements IAsyncDisposable
<style scoped>
    .save_hover_Master_From_1 {
        float: left;
        margin-top: -41px;
        line-height: 38px;
        margin-left: 200px;
        width: 100px;
    }
</style>
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                        <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDetailDelete" Enabled="@EditEnabled" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>

<div class="" style="overflow-x: hidden;overflow-y: auto;height: calc(100vh - 210px);">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />
                    <DxFormLayoutItem Caption="Method Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.MethodName" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.MethodName)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Method Description" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.MethodDescription" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.MethodDescription)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                        <DxComboBox Data="@_plantItems"
                                    NullText="Select Company..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Description"
                                    ValueFieldName="PlantID"
                                    @bind-Value="@Data.CompanyId">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.CompanyId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Planning Category" ColSpanMd="6">
                        <DxComboBox Data="@_planning_category"
                                    NullText="Select Planning Category"
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.PlanningCategoryID">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.PlanningCategoryID)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Available Batch Size" ColSpanMd="6">
                        <DxTagBox Data="@_view_ApplicationMasterDetails"
                                  NullText="Select Available Batch Size..."
                                  SearchMode="ListSearchMode.AutoSearch"
                                  SearchFilterCondition="ListSearchFilterCondition.Contains"
                                  TextFieldName="Value"
                                  ValueFieldName="ApplicationMasterDetailID"
                                  @bind-Values="@Data.BatchSizeIds">
                        </DxTagBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Default Batch Size" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetails"
                                    NullText="Select Default Batch Size..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.BatchSizeId">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.BatchSizeId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Batch Size Unit" ColSpanMd="6">
                        <DxSpinEdit @bind-Value="@Data.BatchSizeNo" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.BatchSizeNo)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Planning Cycle">
                                <EditForm EditContext="this._editContext" Context="EditFormContext1" style="padding:10px;">
                                    <DxFormLayout CssClass="w-100">
                                        <DxFormLayoutItem Caption="Production Frequency" ColSpanMd="6">
                                            <DxSpinEdit @bind-Value="@Data.ProdFrequency" ShowValidationIcon="true" />
                                            <ValidationMessage For="@(() => Data.ProdFrequency)" />
                                        </DxFormLayoutItem>
                                        <DxFormLayoutItem Caption="" ColSpanMd="6">
                                        </DxFormLayoutItem>
                                        <DxFormLayoutGroup Caption="Distributor Planning Info" ColSpanMd="6">
                                            <DxFormLayoutItem Caption="Replenish Distributor HS" ColSpanMd="12">
                                                <DxSpinEdit @bind-Value="@Data.DistReplenishHs" ShowValidationIcon="true" />
                                                <ValidationMessage For="@(() => Data.DistReplenishHs)" />
                                            </DxFormLayoutItem>
                                            <DxFormLayoutItem Caption="To Plan AC Month" ColSpanMd="12">
                                                <DxSpinEdit @bind-Value="@Data.DistAcmonth" ShowValidationIcon="true" />
                                                <ValidationMessage For="@(() => Data.DistAcmonth)" />
                                            </DxFormLayoutItem>
                                        </DxFormLayoutGroup>
                                        <DxFormLayoutGroup Caption="Adhoc Order" ColSpanMd="6">
                                            <DxFormLayoutItem Caption="Adhoc Months Stand Alone" ColSpanMd="12">
                                                <DxComboBox Data="@_adhocMonthStandAloneItems"
                                                            NullText="Select Adhoc Months Stand Alone..."
                                                            SearchMode="ListSearchMode.AutoSearch"
                                                            SearchFilterCondition="ListSearchFilterCondition.Contains"
                                                            TextFieldName="CodeValue"
                                                            ValueFieldName="CodeId"
                                                            @bind-Value="@Data.AdhocMonthStandAlone"
                                                            ShowValidationIcon="true">
                                                </DxComboBox>
                                                <ValidationMessage For="@(() => Data.AdhocMonthStandAlone)" />
                                            </DxFormLayoutItem>
                                            <DxFormLayoutItem Caption="Replenish HS/Qty" ColSpanMd="12">
                                                <DxSpinEdit @bind-Value="@Data.AdhocReplenishHs" ShowValidationIcon="true" />
                                                <ValidationMessage For="@(() => Data.AdhocReplenishHs)" />
                                            </DxFormLayoutItem>
                                            <DxFormLayoutItem Caption="Plan Qty" ColSpanMd="12">
                                                <DxSpinEdit @bind-Value="@Data.AdhocPlanQty" ShowValidationIcon="true" />
                                                <ValidationMessage For="@(() => Data.AdhocPlanQty)" />
                                            </DxFormLayoutItem>
                                        </DxFormLayoutGroup>
                                    </DxFormLayout>
                                </EditForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="MethodCode Line">
                                <NavMethodCodeLinesForm _selectedDataItems="@_dynamicFormData"></NavMethodCodeLinesForm>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Production Forecast">
                                <ProductionForecastForm _selectedDataItems="@_dynamicFormData"></ProductionForecastForm>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>

        </div>
    </div>


</div>
<DxPopup @bind-Visible="@Blukdeletepopup"
         ShowFooter="true"
         HeaderText="Delete Main Form"
         Closed="EulaPopupClosed"
         CloseOnEscape="false"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Do you want to delete?
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="((e) => bulkDelete(_dynamicFormData))" />
    </FooterContentTemplate>
</DxPopup>
@code {
    bool EditEnabled { get; set; } = false;
    EditContext _editContext;
    public long? MethodCodeId { get; set; }
    [Parameter]
    public NavMethodCodeModel? _dynamicFormData { get; set; }
    [Parameter]
    public Action RevokeBack { get; set; }
    private bool loading;
    bool EditEnabledTab { get; set; } = false;
    bool DeleteEnabled { get; set; } = false;
    int ActiveSubTabIndex { get; set; } = 0; bool Blukdeletepopup { get; set; } = false;
    private NavMethodCodeModel Data = new NavMethodCodeModel();
    public ApplicationUser applicationUser { get; private set; }
    private List<ViewPlants>? _plantItems; private List<CodeMaster> _stausItems; 
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetails;

    private List<View_ApplicationMasterDetail>? _planning_category;

    private List<NAVINPCategoryModel> _NAVINPCategorys;
    private List<CodeMaster> _adhocMonthStandAloneItems;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("Status"));
        _adhocMonthStandAloneItems = await Mediator.Send(new GetAllCodeMasterQuery("AdhocStandAlone"));
        _view_ApplicationMasterDetails = await Mediator.Send(new GetAllApplicationMasterDetailQuery(175));
        //_NAVINPCategorys = await Mediator.Send(new GetAllNAVINPCategory());
        _planning_category = await Mediator.Send(new GetAllApplicationMasterDetailQuery(483));
        if (_stausItems != null && _stausItems.Count() > 0)
        {
            List<int?> codeIds = new List<int?>() { 1, 2 };
            _stausItems = _stausItems.Where(w => codeIds.Contains(w.CodeId)).ToList();
        }
        OnParametersSetLoadAsync();
    }
    void SelectedPlantChanged(long? country)
    {
        Data.CompanyId = null;
        if (country > 0)
        {
            Data.CompanyId = country;
        }
    }

    public async ValueTask DisposeAsync()
    {

    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
    void OnParametersSetLoadAsync()
    {
        EditEnabled = false;
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedByUser = applicationUser.UserName;
        MethodCodeId = -1;
        Data.ModifiedByUserID = null;
        Data.AddedByUserID = null;
        Data.ModifiedDate = null;
        Data.ModifiedByUser = applicationUser.UserName;
        Data.MethodCodeID = -1;
        Data.MethodName = null;
        Data.CompanyId = null;
        Data.MethodDescription = null;
        Data.PlanningCategoryID = null;
        Data.ProdFrequency = null;
        Data.DistReplenishHs = null;
        Data.DistAcmonth = null;
        Data.AdhocPlanQty = null;
        Data.AdhocReplenishHs = null;
        Data.AdhocMonthStandAlone = null;
        Data.BatchSizeId = null;
        Data.BatchSizeIds = new List<long?>();
        Data.BatchSizeNo = null; Data.StatusCodeID = 1; ActiveSubTabIndex = 0;
        if (_dynamicFormData != null && _dynamicFormData.MethodCodeID > 0)
        {
            EditEnabled = true;
            Data.AddedDate = _dynamicFormData.AddedDate;
            Data.AddedByUser = _dynamicFormData.AddedByUser;
            MethodCodeId = _dynamicFormData.MethodCodeID;
            Data.ModifiedByUserID = _dynamicFormData.ModifiedByUserID;
            Data.AddedByUserID = _dynamicFormData.AddedByUserID;
            Data.ModifiedDate = _dynamicFormData.ModifiedDate;
            Data.ModifiedByUser = _dynamicFormData.ModifiedByUser;
            Data.MethodCodeID = _dynamicFormData.MethodCodeID;
            Data.MethodName = _dynamicFormData.MethodName;
            Data.CompanyId = _dynamicFormData.CompanyId;
            Data.MethodDescription = _dynamicFormData.MethodName;
            Data.PlanningCategoryID = _dynamicFormData.PlanningCategoryID;
            Data.ProdFrequency = _dynamicFormData.ProdFrequency;
            Data.DistReplenishHs = _dynamicFormData.DistReplenishHs;
            Data.DistAcmonth = _dynamicFormData.DistAcmonth;
            Data.AdhocPlanQty = _dynamicFormData.AdhocPlanQty;
            Data.AdhocReplenishHs = _dynamicFormData.AdhocReplenishHs;
            Data.AdhocMonthStandAlone = _dynamicFormData.AdhocMonthStandAlone;
            Data.BatchSizeId = _dynamicFormData.BatchSizeId;
            Data.BatchSizeIds = _dynamicFormData.BatchSizeIds;
            Data.BatchSizeNo = _dynamicFormData.BatchSizeNo;
            Data.StatusCodeID = _dynamicFormData.StatusCodeID > 0 ? _dynamicFormData.StatusCodeID : 1;
        }
        StateHasChanged();
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
        }
        else if (e.TabIndex == 1)
        {
        }
    }
    void backUrl()
    {
        RevokeBack?.Invoke();
    }
    void AddNewForm()
    {
        OnParametersSetLoadAsync();
    }
    void addNew()
    {
        _dynamicFormData = null;
        ActiveSubTabIndex = 0;
        OnParametersSetLoadAsync();
    }
    void addDetailDelete()
    {
        Blukdeletepopup = true;
    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        Blukdeletepopup = false;
    }
    async Task bulkDelete(NavMethodCodeModel dynamicForm)
    {
        try
        {
            var request = new DeleteNavMethodCode(dynamicForm);
            await Mediator.Send(request);
            Blukdeletepopup = false;
            addNew();
            toastService.ShowToast("Delete record Successfully", AC.SD.Core.Services.ToastLevel.Success);
            StateHasChanged();
        }
        catch (Exception eq)
        {
            //DeleteerrorMessage = eq.Message;
            //PopupVisible = true;
            Blukdeletepopup = false;
            toastService.ShowToast("The Selected Record Do not deleted", AC.SD.Core.Services.ToastLevel.Error);
        }
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.MethodCodeID > 0)
        {
            var createReq = new InsertOrUpdateNavMethodCode
                {
                    MethodCodeID = Data.MethodCodeID,
                    MethodName = Data.MethodName,
                    CompanyId = Data.CompanyId,
                    MethodDescription = Data.MethodDescription,
                    AddedByUserID = applicationUser?.UserID,
                    ModifiedByUserID = applicationUser?.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = Data.StatusCodeID,
                    AddedDate = DateTime.Now,
                    PlanningCategoryID = Data.PlanningCategoryID,
                    ProdFrequency = Data.ProdFrequency,
                    DistReplenishHs = Data.DistReplenishHs,
                    DistAcmonth = Data.DistAcmonth,
                    AdhocPlanQty = Data.AdhocPlanQty,
                    AdhocReplenishHs = Data.AdhocReplenishHs,
                    AdhocMonthStandAlone = Data.AdhocMonthStandAlone,
                    BatchSizeId = Data.BatchSizeId,
                    BatchSizeIds = Data.BatchSizeIds,
                    BatchSizeNo = Data.BatchSizeNo,
                };

            await Mediator.Send(createReq);
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;
            StateHasChanged();
        }
        else
        {
            var UpdateReq = new InsertOrUpdateNavMethodCode
                {
                    MethodCodeID = Data.MethodCodeID,
                    MethodName = Data.MethodName,
                    CompanyId = Data.CompanyId,
                    MethodDescription = Data.MethodDescription,
                    AddedByUserID = Data.AddedByUserID == null ? applicationUser?.UserID : Data.AddedByUserID,
                    ModifiedByUserID = applicationUser?.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = Data.StatusCodeID,
                    AddedDate = Data.AddedDate == null ? DateTime.Now : Data.AddedDate,
                    PlanningCategoryID = Data.PlanningCategoryID,
                    ProdFrequency = Data.ProdFrequency,
                    DistReplenishHs = Data.DistReplenishHs,
                    DistAcmonth = Data.DistAcmonth,
                    AdhocPlanQty = Data.AdhocPlanQty,
                    AdhocReplenishHs = Data.AdhocReplenishHs,
                    AdhocMonthStandAlone = Data.AdhocMonthStandAlone,
                    BatchSizeId = Data.BatchSizeId,
                    BatchSizeIds = Data.BatchSizeIds,
                    BatchSizeNo = Data.BatchSizeNo,
                };
            var result = await Mediator.Send(UpdateReq);
            if (result.MethodCodeID > 0)
            {
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                MethodCodeId = result.MethodCodeID;
                Data.MethodCodeID = result.MethodCodeID;
                ActiveSubTabIndex = 0;
                loading = false;
            }


            StateHasChanged();
        }
    }
}
