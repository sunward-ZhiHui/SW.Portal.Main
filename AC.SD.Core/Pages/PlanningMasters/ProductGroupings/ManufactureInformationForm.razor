@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject ClipboardService ClipboardService
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@implements IAsyncDisposable
<div class="card w-100" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">

        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDetailDelete" Enabled="@EditEnabled" />
            </Items>
        </DxMenu>
    </div>
</div>


<div class="" style="overflow-x: hidden;overflow-y: auto;height: calc(100vh - 210px);">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-bottom: 10px;margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <DxFormLayout CssClass="w-100">
                    <DxFormLayoutItem Caption="Manufacture By" ColSpanMd="6">
                        <DxComboBox Data="@_customerItems"
                                    NullText="Select Manufacture By..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="BlanketName"
                                    ValueFieldName="CompanyListingID"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ShowValidationIcon="true"
                                    @bind-Value="@Data.ManufactureById">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.ManufactureById)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Dosage form" ColSpanMd="6">
                        <DxComboBox Data="@_dosageFormItems"
                                    NullText="Select Dosage form..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.DosageFormId">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.DosageFormId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Drug Classification" ColSpanMd="6">
                        <DxComboBox Data="@_drugClassificationItems"
                                    NullText="Select Drug Classification..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.DrugClassificationId">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.DrugClassificationId)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="NAV Information">
                                <ProductGroupingNavList ProductGroupingManufactureId="@ProductGroupingManufactureId" _ProductGroupingManufactureFormData="@_ProductGroupingManufactureFormData"></ProductGroupingNavList>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>
        </div>
    </div>
</div>
<DxPopup @bind-Visible="@Blukdeletepopup"
         ShowFooter="true"
         HeaderText="Delete Main Form"
         Closed="EulaPopupClosed"
         CloseOnEscape="false"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Do you want to delete?
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="((e) => bulkDelete())" />
    </FooterContentTemplate>
</DxPopup>
@code {
    bool EditEnabled { get; set; } = false;
    EditContext _editContext;
    public long? ProductGroupingManufactureId { get; set; }
    [Parameter]
    public ProductGroupingManufactureModel? _ProductGroupingManufactureFormData { get; set; }
    [Parameter]
    public Action RevokeBack { get; set; }
    [Parameter]
    public long? ProductGroupingId { get; set; }
    private bool loading;
    bool EditEnabledTab { get; set; } = false;
    bool DeleteEnabled { get; set; } = false;
    int ActiveSubTabIndex { get; set; } = 0; bool Blukdeletepopup { get; set; } = false;
    private ProductGroupingManufactureModel Data = new ProductGroupingManufactureModel();
    public ApplicationUser applicationUser { get; private set; }
    private List<View_ApplicationMasterDetail> _dosageFormItems; private List<CodeMaster> _stausItems;

    private List<View_ApplicationMasterDetail> _drugClassificationItems; private List<CompanyListingModel> _customerItems;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _dosageFormItems = await Mediator.Send(new GetAllApplicationMasterDetailQuery(107));
        _drugClassificationItems = await Mediator.Send(new GetAllApplicationMasterDetailQuery(255));
        _customerItems = await Mediator.Send(new GetCompanyListingForProductGroupingManufacture());
        OnParametersSetLoadAsync();
    }
    public async ValueTask DisposeAsync()
    {

    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
    void OnParametersSetLoadAsync()
    {
        EditEnabled = false;
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedByUser = applicationUser.UserName;
        ProductGroupingManufactureId = -1;
        Data.ModifiedByUserID = null;
        Data.AddedByUserID = null;
        Data.ModifiedDate = null;
        Data.ModifiedByUser = applicationUser.UserName;
        Data.AddedDate = DateTime.Now;
        Data.ProductGroupingId = null;
        Data.ManufactureById = null;
        Data.DrugClassificationId = null;
        Data.DosageFormId = null;
        Data.StatusCodeID = 1; ActiveSubTabIndex = 0;
        if (_ProductGroupingManufactureFormData != null && _ProductGroupingManufactureFormData.ProductGroupingManufactureId > 0)
        {
            EditEnabled = true;
            Data.AddedDate = _ProductGroupingManufactureFormData.AddedDate;
            Data.AddedByUser = _ProductGroupingManufactureFormData.AddedByUser;
            ProductGroupingManufactureId = _ProductGroupingManufactureFormData.ProductGroupingManufactureId;
            Data.ModifiedByUserID = _ProductGroupingManufactureFormData.ModifiedByUserID;
            Data.AddedByUserID = _ProductGroupingManufactureFormData.AddedByUserID;
            Data.ModifiedDate = _ProductGroupingManufactureFormData.ModifiedDate;
            Data.ModifiedByUser = _ProductGroupingManufactureFormData.ModifiedByUser;
            Data.ProductGroupingId = _ProductGroupingManufactureFormData.ProductGroupingId;
            Data.ManufactureById = _ProductGroupingManufactureFormData.ManufactureById;
            Data.DrugClassificationId = _ProductGroupingManufactureFormData.DrugClassificationId;
            Data.DosageFormId = _ProductGroupingManufactureFormData.DosageFormId;
            Data.StatusCodeID = _ProductGroupingManufactureFormData.StatusCodeID > 0 ? _ProductGroupingManufactureFormData.StatusCodeID : 1;
        }
        StateHasChanged();
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
        }
        else if (e.TabIndex == 1)
        {
        }
    }
    void backUrl()
    {
        RevokeBack?.Invoke();
    }
    void AddNewForm()
    {
        OnParametersSetLoadAsync();
    }
    void addNew()
    {
        _ProductGroupingManufactureFormData = null;
        ActiveSubTabIndex = 0;
        OnParametersSetLoadAsync();
    }
    void addDetailDelete()
    {
        Blukdeletepopup = true;
    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        Blukdeletepopup = false;
    }
    async Task bulkDelete()
    {
        try
        {
            var request = new DeleteProductGroupingManufacture(Data);
            await Mediator.Send(request);
            Blukdeletepopup = false;
            addNew();
            toastService.ShowToast("Delete record Successfully", AC.SD.Core.Services.ToastLevel.Success);
            StateHasChanged();
        }
        catch (Exception eq)
        {
            //DeleteerrorMessage = eq.Message;
            //PopupVisible = true;
            Blukdeletepopup = false;
            toastService.ShowToast("The Selected Record Do not deleted", AC.SD.Core.Services.ToastLevel.Error);
        }
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.ProductGroupingId > 0)
        {
            var createReq = new InsertOrUpdateProductGroupingManufacture
                {
                    AddedByUserID = Data.AddedByUserID == null ? applicationUser?.UserID : Data.AddedByUserID,
                    ModifiedByUserID = applicationUser?.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = Data.StatusCodeID,
                    AddedDate = Data.AddedDate == null ? DateTime.Now : Data.AddedDate,
                    ManufactureById = Data.ManufactureById,
                    DrugClassificationId = Data.DrugClassificationId,
                    ProductGroupingId = ProductGroupingId,
                    DosageFormId = Data.DosageFormId,
                    ProductGroupingManufactureId = Data.ProductGroupingManufactureId,
                };

            await Mediator.Send(createReq);
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;
            StateHasChanged();
        }
        else
        {
            var UpdateReq = new InsertOrUpdateProductGroupingManufacture
                {
                    ManufactureById = Data.ManufactureById,
                    DrugClassificationId = Data.DrugClassificationId,
                    ProductGroupingId = ProductGroupingId,
                    DosageFormId = Data.DosageFormId,
                    ProductGroupingManufactureId = Data.ProductGroupingManufactureId,
                    AddedByUserID = Data.AddedByUserID == null ? applicationUser?.UserID : Data.AddedByUserID,
                    ModifiedByUserID = Data.ModifiedByUserID == null ? applicationUser?.UserID : Data.ModifiedByUserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = Data.StatusCodeID,
                    AddedDate = DateTime.Now,
                };
            var result = await Mediator.Send(UpdateReq);
            if (result.ProductGroupingManufactureId > 0)
            {
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                ProductGroupingManufactureId = result.ProductGroupingManufactureId;
                Data.ProductGroupingManufactureId = result.ProductGroupingManufactureId;
                ActiveSubTabIndex = 0; EditEnabled = true;
                loading = false;
            }
            StateHasChanged();
        }
    }
}
