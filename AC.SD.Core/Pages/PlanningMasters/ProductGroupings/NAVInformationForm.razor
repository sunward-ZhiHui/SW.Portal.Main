@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject ClipboardService ClipboardService
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@implements IAsyncDisposable
<div class="card w-100" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">

        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDetailDelete" Enabled="@EditEnabled" />
            </Items>
        </DxMenu>
    </div>
</div>


<div class="" style="overflow-x: hidden;overflow-y: auto;height: calc(100vh - 210px);">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-bottom: 10px;margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <DxFormLayout CssClass="w-100">
                    <DxFormLayoutItem Caption="Item" ColSpanMd="6">
                        <DxComboBox Data="@_AllNavitems"
                                    NullText="Select Item..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Description"
                                    ValueFieldName="ItemId"
                                    EditFormat="{0}-{1}-{2}"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ShowValidationIcon="true"
                                    Value="@Data.ItemId"
                                    ValueExpression="@(() => Data.ItemId )"
                                    ValueChanged="@((long? navitems) => SelectedItemChanged(navitems))">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(View_NavItems.No)"
                                                    Caption="Item No"
                                                    Width="90px" />
                                <DxListEditorColumn FieldName="@nameof(View_NavItems.Description)"
                                                    Caption="Description"
                                                    Width="130px">
                                </DxListEditorColumn>
                                <DxListEditorColumn FieldName="@nameof(View_NavItems.BaseUnitofMeasure)"
                                                    Caption="Uom" Width="40px" />
                            </Columns>

                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.ItemId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Variance No" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.VarianceNo" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.VarianceNo)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Manufacture By" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.ManufactureBy" ShowValidationIcon="true" Enabled="false" />
                        <ValidationMessage For="@(() => Data.ManufactureBy)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Manufacture For" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.ManufactureFor" ShowValidationIcon="true" Enabled="false" />
                        <ValidationMessage For="@(() => Data.ManufactureFor)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Manufacture For" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.ManufactureFor" ShowValidationIcon="true" Enabled="false" />
                        <ValidationMessage For="@(() => Data.ManufactureFor)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Uom" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.UOM" ShowValidationIcon="true" Enabled="false" />
                        <ValidationMessage For="@(() => Data.UOM)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Stock Depletion Status" ColSpanMd="6">
                        <DxComboBox Data="@_stausItems"
                                    NullText="Select Status..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="CodeValue"
                                    ValueFieldName="CodeId"
                                    @bind-Value="@Data.StockDepletionStatusId"
                                    ShowValidationIcon="true">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.StockDepletionStatusId)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Difference For Item Card">
                                <NAVInformationDifferenceForItemCard ProductGroupingNavId="@ProductGroupingNavId"></NAVInformationDifferenceForItemCard>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>
        </div>
    </div>
</div>
<DxPopup @bind-Visible="@Blukdeletepopup"
         ShowFooter="true"
         HeaderText="Delete Main Form"
         Closed="EulaPopupClosed"
         CloseOnEscape="false"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Do you want to delete?
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="((e) => bulkDelete())" />
    </FooterContentTemplate>
</DxPopup>
@code {
    bool EditEnabled { get; set; } = false;
    EditContext _editContext;
    [Parameter]
    public long? ProductGroupingManufactureId { get; set; }
    [Parameter]
    public ProductGroupingNavModel? _ProductGroupingNavFormData { get; set; }
    [Parameter]
    public Action RevokeBack { get; set; }
    public long? ProductGroupingNavId { get; set; }
    [Parameter]
    public long? ProductGroupingId { get; set; }
    private bool loading;
    bool EditEnabledTab { get; set; } = false;
    bool DeleteEnabled { get; set; } = false;
    int ActiveSubTabIndex { get; set; } = 0; bool Blukdeletepopup { get; set; } = false;
    private ProductGroupingNavModel Data = new ProductGroupingNavModel();
    public ApplicationUser applicationUser { get; private set; }
    private List<View_NavItems>? _AllNavitems; private List<CodeMaster> _stausItems;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _AllNavitems = await Mediator.Send(new GetAllNavItemsQuery());
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("DepleteStatus"));
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("Status"));
        OnParametersSetLoadAsync();
    }
    public async ValueTask DisposeAsync()
    {

    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
    void SelectedItemChanged(long? navitemsId)
    {
        Data.ItemId = navitemsId;
        Data.Description = null;
        Data.ManufactureFor = null;
        Data.ManufactureBy = null;
        Data.UOM = null;
        Data.ReplenishmentMethod = null;
        var navitems = _AllNavitems != null && navitemsId > 0 ? _AllNavitems.FirstOrDefault(f => f.ItemId == navitemsId) : null;
        if (navitems != null)
        {
            Data.Description = navitems.Description;
            Data.ManufactureFor = navitems.InternalRef;
            Data.ManufactureBy = navitems.ItemCategoryCode;
            Data.UOM = navitems.BaseUnitofMeasure;
            Data.ReplenishmentMethod = navitems.VendorNo;
        }
    }
    void OnParametersSetLoadAsync()
    {
        EditEnabled = false;
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedByUser = applicationUser.UserName;
        ProductGroupingNavId = -1;
        Data.ModifiedByUserID = null;
        Data.AddedByUserID = null;
        Data.ModifiedDate = null;
        Data.ModifiedByUser = applicationUser.UserName;
        Data.AddedDate = DateTime.Now;
        Data.ProductGroupingManufactureId = null;
        Data.ProductGroupingNavId = -1;
        Data.ItemId = null;
        Data.VarianceNo = null;
        Data.Description = null;
        Data.ManufactureFor = null;
        Data.ManufactureBy = null;
        Data.UOM = null;
        Data.ReplenishmentMethod = null;
        Data.ReplenishmentMethodId = null; Data.GenericCodeSupplyToMultipleId = null;
        Data.StockDepletionStatusId = null; ActiveSubTabIndex = 0;
        if (_ProductGroupingNavFormData != null && _ProductGroupingNavFormData.ProductGroupingNavId > 0)
        {
            ProductGroupingNavId = _ProductGroupingNavFormData.ProductGroupingNavId;
            EditEnabled = true;
            Data.VarianceNo = _ProductGroupingNavFormData.VarianceNo;
            Data.AddedDate = _ProductGroupingNavFormData.AddedDate;
            Data.AddedByUser = _ProductGroupingNavFormData.AddedByUser;
            ProductGroupingManufactureId = _ProductGroupingNavFormData.ProductGroupingManufactureId;
            Data.ModifiedByUserID = _ProductGroupingNavFormData.ModifiedByUserID;
            Data.AddedByUserID = _ProductGroupingNavFormData.AddedByUserID;
            Data.ModifiedDate = _ProductGroupingNavFormData.ModifiedDate;
            Data.ModifiedByUser = _ProductGroupingNavFormData.ModifiedByUser;
            Data.ProductGroupingNavId = _ProductGroupingNavFormData.ProductGroupingNavId;
            Data.ReplenishmentMethodId = _ProductGroupingNavFormData.ReplenishmentMethodId;
            Data.GenericCodeSupplyToMultipleId = _ProductGroupingNavFormData.GenericCodeSupplyToMultipleId;
            Data.StockDepletionStatusId = _ProductGroupingNavFormData.StatusCodeID;
            Data.ItemId = _ProductGroupingNavFormData.ItemId;
            Data.Description = _ProductGroupingNavFormData.Description;
            Data.ManufactureFor = _ProductGroupingNavFormData.ManufactureFor;
            Data.ManufactureBy = _ProductGroupingNavFormData.ManufactureBy;
            Data.UOM = _ProductGroupingNavFormData.UOM;
            Data.ReplenishmentMethod = _ProductGroupingNavFormData.ReplenishmentMethod;
        }
        StateHasChanged();
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
        }
        else if (e.TabIndex == 1)
        {
        }
    }
    void backUrl()
    {
        RevokeBack?.Invoke();
    }
    void AddNewForm()
    {
        OnParametersSetLoadAsync();
    }
    void addNew()
    {
        _ProductGroupingNavFormData = null;
        ActiveSubTabIndex = 0;
        OnParametersSetLoadAsync();
    }
    void addDetailDelete()
    {
        Blukdeletepopup = true;
    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        Blukdeletepopup = false;
    }
    async Task bulkDelete()
    {
        try
        {
            var request = new DeleteProductGroupingNav(Data);
            await Mediator.Send(request);
            Blukdeletepopup = false;
            addNew();
            toastService.ShowToast("Delete record Successfully", AC.SD.Core.Services.ToastLevel.Success);
            StateHasChanged();
        }
        catch (Exception eq)
        {
            //DeleteerrorMessage = eq.Message;
            //PopupVisible = true;
            Blukdeletepopup = false;
            toastService.ShowToast("The Selected Record Do not deleted", AC.SD.Core.Services.ToastLevel.Error);
        }
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.ProductGroupingNavId > 0)
        {
            var createReq = new InsertOrUpdateProductGroupingNav
                {
                    AddedByUserID = Data.AddedByUserID == null ? applicationUser?.UserID : Data.AddedByUserID,
                    ModifiedByUserID = applicationUser?.UserID,
                    ModifiedDate = DateTime.Now,
                    VarianceNo = Data.VarianceNo,
                    StatusCodeID = Data.StockDepletionStatusId,
                    AddedDate = Data.AddedDate == null ? DateTime.Now : Data.AddedDate,
                    ProductGroupingNavId = Data.ProductGroupingNavId,
                    ItemId = Data.ItemId,
                    GenericCodeSupplyToMultipleId = Data.GenericCodeSupplyToMultipleId,
                    ReplenishmentMethodId = Data.ReplenishmentMethodId,
                    ProductGroupingManufactureId = ProductGroupingManufactureId,
                };

            await Mediator.Send(createReq);
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;
            StateHasChanged();
        }
        else
        {
            var UpdateReq = new InsertOrUpdateProductGroupingNav
                {
                    ProductGroupingNavId = Data.ProductGroupingNavId,
                    ItemId = Data.ItemId,
                    VarianceNo = Data.VarianceNo,
                    GenericCodeSupplyToMultipleId = Data.GenericCodeSupplyToMultipleId,
                    ReplenishmentMethodId = Data.ReplenishmentMethodId,
                    ProductGroupingManufactureId = ProductGroupingManufactureId,
                    AddedByUserID = Data.AddedByUserID == null ? applicationUser?.UserID : Data.AddedByUserID,
                    ModifiedByUserID = Data.ModifiedByUserID == null ? applicationUser?.UserID : Data.ModifiedByUserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = Data.StockDepletionStatusId,
                    AddedDate = DateTime.Now,
                };
            var result = await Mediator.Send(UpdateReq);
            if (result.ProductGroupingNavId > 0)
            {
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                ProductGroupingNavId = result.ProductGroupingNavId;
                Data.ProductGroupingNavId = result.ProductGroupingNavId;
                ActiveSubTabIndex = 0; EditEnabled = true;
                loading = false;
            }
            StateHasChanged();
        }
    }
}
