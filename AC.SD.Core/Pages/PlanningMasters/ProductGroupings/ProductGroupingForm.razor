@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject ClipboardService ClipboardService
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@implements IAsyncDisposable
<style scoped>
    .save_hover_Master_From_1 {
        float: left;
        margin-top: -41px;
        line-height: 38px;
        margin-left: 200px;
        width: 100px;
    }
</style>
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                        <DxMenuItem Text="Delete" IconCssClass="fa fa-remove" Click="@addDetailDelete" Enabled="@EditEnabled" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>

<div class="" style="overflow-x: hidden;overflow-y: auto;height: calc(100vh - 210px);">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;margin-bottom:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />
                    <DxFormLayoutItem Caption="Code" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.Code" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.Code)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Product Group Code" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.ProfileNo" ShowValidationIcon="true" Enabled="false" />
                        <ValidationMessage For="@(() => Data.ProfileNo)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Product Group Description" ColSpanMd="6">
                        <DxMemo @bind-Text="@Data.Description" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.Description)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description" ColSpanMd="6">
                        <DxMemo @bind-Text="@Data.Description2" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.Description2)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Product Name" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetails"
                                    NullText="Select Product Name..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    Value="@Data.ProductNameId"
                                    ValueExpression="@(() => Data.ProductNameId )"
                                    ValueChanged="@((long? plantData) => SelectedProductNameChanged(plantData))">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.ProductNameId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Is Simulation" ColSpanMd="6">
                        <DxCheckBox @bind-Checked="@Data.IsSimulation" />
                        <ValidationMessage For="@(() => Data.IsSimulation)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                        <DxTagBox Data="@_plantItems"
                                  NullText="Select Company..."
                                  SearchMode="ListSearchMode.AutoSearch"
                                  SearchFilterCondition="ListSearchFilterCondition.Contains"
                                  TextFieldName="Description"
                                  ValueFieldName="PlantID"
                                  @bind-Values="@Data.ManufacturingIds">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompanyName)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxTagBox>
                        <ValidationMessage For="@(() => Data.ManufacturingIds)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Packing Units" ColSpanMd="6">
                        <DxComboBox Data="@_view_ApplicationMasterDetailsPackingUnits"
                                    NullText="Select Packing Units..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    Value="@Data.PackingUnitsId"
                                    ValueExpression="@(() => Data.PackingUnitsId )"
                                    ValueChanged="@((long? plantData) => SelectedPackingUnitsChanged(plantData))">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.PackingUnitsId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Uom" ColSpanMd="6">
                        <DxComboBox Data="@uomItems"
                                    NullText="Select Uom..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                                    @bind-Value="@Data.Uom">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.Uom)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Supply To" ColSpanMd="6">
                        <DxTagBox Data="@CompanyListingItems"
                                  NullText="Select Supply To..."
                                  SearchMode="ListSearchMode.AutoSearch"
                                  SearchFilterCondition="ListSearchFilterCondition.Contains"
                                  TextFieldName="BlanketName"
                                  ValueFieldName="CompanyListingID"
                                  @bind-Values="@Data.SupplyToIds">

                        </DxTagBox>
                        <ValidationMessage For="@(() => Data.SupplyToIds)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Status" ColSpanMd="6">
                        <DxComboBox Data="@_stausItems"
                                    NullText="Select Status..."
                                    SearchMode="ListSearchMode.AutoSearch"
                                    SearchFilterCondition="ListSearchFilterCondition.Contains"
                                    TextFieldName="CodeValue"
                                    ValueFieldName="CodeId"
                                    @bind-Value="@Data.StatusCodeID"
                                    ShowValidationIcon="true">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.StatusCodeID)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Manufacture Information">
                                <ManufactureInformationList GenericCodeId="@GenericCodeId"></ManufactureInformationList>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>
        </div>
    </div>


</div>
<DxPopup @bind-Visible="@Blukdeletepopup"
         ShowFooter="true"
         HeaderText="Delete Main Form"
         Closed="EulaPopupClosed"
         CloseOnEscape="false"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Do you want to delete?
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="Context.CloseCallback" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="((e) => bulkDelete())" />
    </FooterContentTemplate>
</DxPopup>
@code {
    bool EditEnabled { get; set; } = false;
    EditContext _editContext;
    public long? GenericCodeId { get; set; }
    [Parameter]
    public GenericCodesModel? _GenericCodesFormData { get; set; }
    [Parameter]
    public Action RevokeBack { get; set; }
    private bool loading;
    bool EditEnabledTab { get; set; } = false;
    bool DeleteEnabled { get; set; } = false;
    int ActiveSubTabIndex { get; set; } = 0; bool Blukdeletepopup { get; set; } = false;
    private GenericCodesModel Data = new GenericCodesModel();
    public ApplicationUser applicationUser { get; private set; }
    private List<ViewPlants>? _plantItems; private List<CodeMaster> _stausItems; private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetails;
    private List<View_ApplicationMasterDetail> _view_ApplicationMasterDetailsPackingUnits; private List<View_ApplicationMasterDetail> uomItems;
    private List<CompanyListingModel> CompanyListingItems;
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _plantItems = await Mediator.Send(new GetAllPlantQuery());
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("Status"));
        _view_ApplicationMasterDetails = await Mediator.Send(new GetAllApplicationMasterDetailQuery(103));
        _view_ApplicationMasterDetailsPackingUnits = await Mediator.Send(new GetAllApplicationMasterDetailQuery(235));
        CompanyListingItems = await Mediator.Send(new GetCompanyListingListQuery());
        uomItems = await Mediator.Send(new GetAllApplicationMasterDetailQuery(234));
        if (_stausItems != null && _stausItems.Count() > 0)
        {
            List<int?> codeIds = new List<int?>() { 1, 2 };
            _stausItems = _stausItems.Where(w => codeIds.Contains(w.CodeId)).ToList();
        }
        OnParametersSetLoadAsync();
    }
    public async ValueTask DisposeAsync()
    {

    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
    void SelectedProductNameChanged(long? productId)
    {
        Data.ProductNameId = productId;
        Data.ProductName = null;
        if (productId > 0 && _view_ApplicationMasterDetails != null && _view_ApplicationMasterDetails.Count() > 0)
        {
            Data.ProductName = _view_ApplicationMasterDetails.FirstOrDefault(f => f.ApplicationMasterDetailID == productId)?.Value;
        }
    }
    void SelectedPackingUnitsChanged(long? productId)
    {
        Data.PackingUnitsId = productId;
        Data.PackingUnits = null;
        if (productId > 0 && _view_ApplicationMasterDetailsPackingUnits != null && _view_ApplicationMasterDetailsPackingUnits.Count() > 0)
        {
            Data.PackingUnits = _view_ApplicationMasterDetailsPackingUnits.FirstOrDefault(f => f.ApplicationMasterDetailID == productId)?.Value;
        }
    }
    void OnParametersSetLoadAsync()
    {
        EditEnabled = false;
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedByUser = applicationUser.UserName;
        Data.ModifiedByUserID = null;
        Data.AddedByUserID = null;
        Data.ModifiedDate = null;
        Data.ModifiedByUser = applicationUser.UserName;
        Data.GenericCodeID = -1;
        Data.Code = null;
        Data.ProfileId = null;
        Data.ProfileNo = null;
        Data.Description = null;
        Data.Description2 = null;
        Data.ProductNameId = null;
        Data.IsSimulation = false;
        Data.ManufacturingIds = new List<long?>();
        Data.PackingUnitsId = null;
        Data.Uom = null;
        Data.UomName = null; Data.ProductName = null;
        Data.SupplyToIds = new List<long?>();
        Data.PackingUnits = null; Data.StatusCodeID = 1; ActiveSubTabIndex = 0;
        if (_GenericCodesFormData != null && _GenericCodesFormData.GenericCodeID > 0)
        {
            EditEnabled = true;
            Data.AddedDate = _GenericCodesFormData.AddedDate;
            Data.AddedByUser = _GenericCodesFormData.AddedByUser;
            GenericCodeId = _GenericCodesFormData.GenericCodeID;
            Data.ModifiedByUserID = _GenericCodesFormData.ModifiedByUserID;
            Data.AddedByUserID = _GenericCodesFormData.AddedByUserID;
            Data.ModifiedDate = _GenericCodesFormData.ModifiedDate;
            Data.ModifiedByUser = _GenericCodesFormData.ModifiedByUser;
            Data.GenericCodeID = _GenericCodesFormData.GenericCodeID;
            Data.Code = _GenericCodesFormData.Code;
            Data.ProfileId = _GenericCodesFormData.ProfileId;
            Data.ProfileNo = _GenericCodesFormData.ProfileNo;
            Data.Description = _GenericCodesFormData.Description;
            Data.Description2 = _GenericCodesFormData.Description2;
            Data.ProductName = _GenericCodesFormData.ProductName;
            Data.ProductNameId = _GenericCodesFormData.ProductNameId;
            Data.Uom = _GenericCodesFormData.Uom;
            Data.UomName = _GenericCodesFormData.UomName;
            Data.PackingUnitsId = _GenericCodesFormData.PackingUnitsId;
            Data.PackingUnits = _GenericCodesFormData.PackingUnits;
            Data.IsSimulation = _GenericCodesFormData.IsSimulation;
            Data.SupplyToIds = _GenericCodesFormData.SupplyToIds;
            Data.ManufacturingIds = _GenericCodesFormData.ManufacturingIds;
            Data.StatusCodeID = _GenericCodesFormData.StatusCodeID > 0 ? _GenericCodesFormData.StatusCodeID : 1;
        }
        StateHasChanged();
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
        }
        else if (e.TabIndex == 1)
        {
        }
    }
    void backUrl()
    {
        RevokeBack?.Invoke();
    }
    void AddNewForm()
    {
        OnParametersSetLoadAsync();
    }
    void addNew()
    {
        GenericCodeId = -1;
        _GenericCodesFormData = null;
        ActiveSubTabIndex = 0;
        OnParametersSetLoadAsync();
        StateHasChanged();
    }
    void addDetailDelete()
    {
        Blukdeletepopup = true;
    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        Blukdeletepopup = false;
    }
    async Task bulkDelete()
    {
        try
        {
            var request = new DeleteProductGrouping(Data);
            await Mediator.Send(request);
            Blukdeletepopup = false;
            addNew();
            toastService.ShowToast("Delete record Successfully", AC.SD.Core.Services.ToastLevel.Success);
            StateHasChanged();
        }
        catch (Exception eq)
        {
            //DeleteerrorMessage = eq.Message;
            //PopupVisible = true;
            Blukdeletepopup = false;
            toastService.ShowToast("The Selected Record Do not deleted", AC.SD.Core.Services.ToastLevel.Error);
        }
    }
    async Task HandleValidSubmit()
    {
        loading = true;
        if (Data.GenericCodeID > 0)
        {
            var createReq = new InsertOrUpdateProductGrouping
                {
                    GenericCodeID = Data.GenericCodeID,
                    Code = Data.Code,
                    ProfileId = Data.ProfileId,
                    ProfileNo = Data.ProfileNo,
                    Description = Data.Description,
                    Description2 = Data.Description2,
                    ProductNameId = Data.ProductNameId,
                    IsSimulation = Data.IsSimulation,
                    ManufacturingIds = Data.ManufacturingIds,
                    PackingUnitsId = Data.PackingUnitsId,
                    Uom = Data.Uom,
                    UomName = Data.UomName,
                    ProductName = Data.ProductName,
                    PackingUnits = Data.PackingUnits,
                    SupplyToIds = Data.SupplyToIds,
                    AddedByUserID = applicationUser?.UserID,
                    ModifiedByUserID = applicationUser?.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = Data.StatusCodeID,
                    AddedDate = DateTime.Now,
                };

            await Mediator.Send(createReq);
            toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
            loading = false;
            StateHasChanged();
        }
        else
        {
            var UpdateReq = new InsertOrUpdateProductGrouping
                {
                    GenericCodeID = Data.GenericCodeID,
                    Code = Data.Code,
                    ProfileId = Data.ProfileId,
                    ProfileNo = Data.ProfileNo,
                    Description = Data.Description,
                    Description2 = Data.Description2,
                    ProductNameId = Data.ProductNameId,
                    IsSimulation = Data.IsSimulation,
                    ManufacturingIds = Data.ManufacturingIds,
                    PackingUnitsId = Data.PackingUnitsId,
                    Uom = Data.Uom,
                    UomName = Data.UomName,
                    ProductName = Data.ProductName,
                    PackingUnits = Data.PackingUnits,
                    SupplyToIds = Data.SupplyToIds,
                    AddedByUserID = Data.AddedByUserID == null ? applicationUser?.UserID : Data.AddedByUserID,
                    ModifiedByUserID = applicationUser?.UserID,
                    ModifiedDate = DateTime.Now,
                    StatusCodeID = Data.StatusCodeID,
                    AddedDate = Data.AddedDate == null ? DateTime.Now : Data.AddedDate,
                };
            var result = await Mediator.Send(UpdateReq);
            if (result.GenericCodeID > 0)
            {
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                GenericCodeId = result.GenericCodeID;
                Data.GenericCodeID = result.GenericCodeID;
                Data.ProfileNo = result.ProfileNo;
                ActiveSubTabIndex = 0; EditEnabled = true;
                loading = false;
            }


            StateHasChanged();
        }
    }
}
