@page "/pushnotification"
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime;
@using FirebaseAdmin.Messaging;

<h3>Push Notifications</h3>

<button @onclick="LoadExampleScript">Load Example Script</button>

<button @onclick="RegisterServiceWorker">Register Service Worker</button>

<div class="alert alert-success">
    @message
</div>

@code {
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
        await InitializeFirebase();
    }

    private async Task RegisterServiceWorker()
    {
        await JSRuntime.InvokeVoidAsync("registerServiceWorker");
    }

    private async Task LoadExampleScript()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("import", "example.js");
            await JSRuntime.InvokeVoidAsync("sayHello");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading script: {ex.Message}");
        }
    }

    private async Task InitializeFirebase()
    {
        await JSRuntime.InvokeVoidAsync("registerServiceWorker");
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                var firebaseConfig1 = {
                    apiKey: 'AAAAo15k7XM:APA91bGEqcSX_EQ2aljOJYVj7REFYkKsWC_tMK_5gpMcnJ4ow_HgSes9vI61pGSVoboCzn44xNON3ByPyIl9_JGijrdW9WUomdPvXaxo-GJHfGW2kH3Lx327IWmx8PSbgbSTymdDznDj',
                    authDomain: 'https://portal.sunwardpharma.com',
                    projectId: 'sunwardportal-9e39c',
                    storageBucket: 'sunwardportal-9e39c.appspot.com',
                    messagingSenderId: '701663341939',
                    appId: '1:701663341939:web:bdf0c935c30ea01c826906',
                    measurementId: 'G-9HNG9SMNXF'
                };

                firebase.initializeApp(firebaseConfig1);

                const messaging = firebase.messaging();

                messaging.onMessage((payload) => {
                    const notification = payload.notification;
                    const message = notification.body;
                    invokePushNotificationReceived(message);
                });

                window.initializeFirebase = async (dotnetHelper) => {
                    try {
                        await messaging.requestPermission();
                        const token = await messaging.getToken();
                        console.log('Firebase Token:', token);
                    } catch (error) {
                        console.error('Error initializing Firebase:', error);
                    }
                };

                function invokePushNotificationReceived(message) {
                    DotNet.invokeMethodAsync('YourAppName', 'PushNotificationReceived', message)
                        .then(() => {})
                        .catch((error) => {
                            console.error('Error invoking PushNotificationReceived:', error);
                        });
                }
            ");


            // Construct the message payload
            var message = new Message()
                {
                    //Notification = new Notification
                    //{
                    //    Title = "Test Notification",
                    //    Body = "This is a test notification"
                    //},
                    //Token = "your_device_token"
                };

            var response = await FirebaseMessaging.DefaultInstance.SendAsync(message);


        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // This method will be called from JavaScript
    [JSInvokable]
    public async Task PushNotificationReceived(string data)
    {
        message = data;
        StateHasChanged();
    }
}
