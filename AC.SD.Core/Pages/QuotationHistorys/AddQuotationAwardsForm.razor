@page "/QuotationHistory/AddQuotationAwardForm"
@page "/QuotationHistory/AddQuotationAwardForm/{SessionId:guid}"
@page "/QuotationHistory/AddQuotationAwardForm/{SessionId:guid}/{EditSessionId:guid}"
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager NavigationManager
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Auto">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fas fa-reply" Click="@onBack" />
                        <DxMenuItem Text="Add New" IconCssClass="fas fa-save" Click="@(() => addNewForm(""))" Enabled="@addEnabled" />
                        <DxMenuItem Text="Save" IconCssClass="fas fa-save" Click="@SubmitFormExternally" Enabled="@saveEnabled" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>
<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleFormValidSubmit">

                <DataAnnotationsValidator />
                <DxFormLayout CssClass="w-100">
                    <DxFormLayoutItem Caption="Type Of Order:" ColSpanMd="6">
                        <DxComboBox Data="@_typeOfOrderItems"
                                    NullText="Select Type Of Order..."
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="Value"
                                    ValueFieldName="ApplicationMasterDetailID"
                        @bind-Value="Data.TypeOfOrderId"
                                    ShowValidationIcon="true">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.TypeOfOrderId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Navision No" ColSpanMd="6">
                        <DxComboBox Data="@_productItems"
                                    NullText="Select Navision No..."
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="Code"
                                    ValueFieldName="GenericCodeId"
                                    EditFormat="{0}-{1}-{3}"
                                    SelectedItemChanged="@((GenericCodes prod) => SelectedItemprod(prod))"
                        @bind-Value="Data.ItemId"
                                    ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(GenericCodes.Code)"
                                                    Caption="Code"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(GenericCodes.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(GenericCodes.Description2)"
                                                    Caption="Description2" />
                                <DxListEditorColumn FieldName="@nameof(GenericCodes.UomName)"
                                                    Caption="Uom" />
                            </Columns>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.ItemId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Total Qty:" ColSpanMd="6">
                        <DxTextBox Text="@Data.TotalQtys" TextExpression="@(() => Data.TotalQtys )"
                                   TextChanged="@((string value) => OnTotalQtyValueChanged(value))" />
                        <ValidationMessage For="@(() => Data.TotalQtys)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Reason for Different Qty:" ColSpanMd="6" Visible="@Data.IsDifferentQty">
                        <DxMemo @bind-Text="Data.ReasonForDifferentQty" Rows="5" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Price:" ColSpanMd="6">
                        <DxTextBox Text="@Data.Prices" TextExpression="@(() => Data.Prices )"
                                   TextChanged="@((string value) => OnTotalPricesValueChanged(value))" />
                        <ValidationMessage For="@(() => Data.Prices)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Reason for Different Price:" ColSpanMd="6" Visible="@Data.IsDifferentPrice">
                        <DxMemo @bind-Text="Data.ReasonForDifferentPrice" Rows="5" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Is This With Commitment?" ColSpanMd="6">
                        <DxRadioGroup Items="@TemplateUploadOptions"
                                      Value="@Data.IsCommitmentBy"
                                      ValueExpression="@(() => Data.IsCommitmentBy )"
                                      ValueChanged="@((string value) => OnCommitmentByValueChanged(value))"
                                      Layout="RadioGroupLayout.Horizontal"
                                      CssClass="dx-demo-radio-group" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Committed Qty:" ColSpanMd="6" Visible="@Data.IsCommitment">
                        <DxSpinEdit @bind-Value="Data.CommittedQtys" />
                        <ValidationMessage For="@(() => Data.CommittedQtys)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Committed On" ColSpanMd="6" Visible="@Data.IsCommitment">
                        <DxDateEdit NullText="Select a Committed On..." @bind-Date="@Data.CommittedOn" CssClass="cw-320" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Promised Date?" ColSpanMd="6">
                        <DxRadioGroup Items="@TemplateUploadOptions"
                                      Value="@Data.IsFollowDateBy"
                                      ValueExpression="@(() => Data.IsFollowDateBy )"
                                      ValueChanged="@((string value) => OnIsFollowDateValueChanged(value))"
                                      Layout="RadioGroupLayout.Horizontal"
                                      CssClass="dx-demo-radio-group" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Status" ColSpanMd="6">
                        <DxComboBox Data="@_stausItems"
                                    NullText="Select Status..."
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="CodeValue"
                                    ValueFieldName="CodeId"
                        @bind-Value="@Data.StatusCodeId"
                                    ShowValidationIcon="true">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.StatusCodeId)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Quotation Award Line">
                                <AddQuotationAwardLineForms @ref="RefAddQuotationAwardLineForms" applicationUser="@applicationUser" QuotatonAwardId="@QuotationAwardId"></AddQuotationAwardLineForms>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>
        </div>
    </div>


</div>
<DxPopup @bind-Visible="@IsDifferentQtypopup"
         ShowFooter="true"
         HeaderText="Qty is Different"
         Closed="EulaPopupQtyClosed"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Qty is Different, Confirm You Want To Save?
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="IsDifferentQtyNoClick" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="IsDifferentQtyClick" />
    </FooterContentTemplate>
</DxPopup>

<DxPopup @bind-Visible="@IsDifferentPricepopup"
         ShowFooter="true"
         HeaderText="Price is Different"
         Closed="EulaPopupPriceClosed"
         Width="300px">
    <BodyContentTemplate>
        <p>
            Price is Different, Confirm You Want To Save?
        </p>
    </BodyContentTemplate>
    <FooterContentTemplate Context="Context">
        <DxButton style="margin-right: 10px;" RenderStyle="ButtonRenderStyle.Primary" Text="NO" Click="IsDifferentPriceNoClick" />
        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Yes" Click="IsDifferentPriceClick" />
    </FooterContentTemplate>
</DxPopup>
@code {
    AddQuotationAwardLineForms RefAddQuotationAwardLineForms;
    [Parameter]
    public QuotationAward ParentData { get; set; }
    [Parameter]
    public Guid? SessionId { get; set; }
    [Parameter]
    public Guid? EditSessionId { get; set; }
    [Parameter]
    public ApplicationUser applicationUser { get; set; }
    [Parameter]
    public Action RevokeBack { get; set; }
    [Parameter]
    public long? QutationHistoryId { get; set; }
    int ActiveSubTabIndex { get; set; } = 0;
    public QuotationHistory quotationHistory { get; set; }
    bool IsDifferentQtypopup { get; set; } = false;
    bool IsDifferentQtys { get; set; } = false;
    bool IsDifferentPricepopup { get; set; } = false;
    bool IsDifferentPrices { get; set; } = false;
    QuotationAward Data = new QuotationAward();
    bool addEnabled { get; set; } = false; bool saveEnabled { get; set; } = false;
    EditContext _editContext;
    public long? QuotationAwardId { get; set; }
    private List<GenericCodes> _productItems;
    private List<View_ApplicationMasterDetail> _typeOfOrderItems;
    private List<CodeMaster> _stausItems;
    IEnumerable<string> TemplateUploadOptions = new[] { "Yes", "No" };
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        addEnabled = true; saveEnabled = true;
        _typeOfOrderItems = await Mediator.Send(new GetAllApplicationMasterDetailQuery(288));
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("Status"));
    }
    protected override async Task OnParametersSetAsync()
    {
        await OnParametersSetLoadAsync();
        base.OnParametersSet();
    }
    async Task OnParametersSetLoadAsync()
    {
        _productItems = new List<GenericCodes>();
        QuotationAwardId = 0;
        quotationHistory = await Mediator.Send(new GetQuotationHistoryBySession(SessionId));
        if (quotationHistory != null && quotationHistory.QuotationHistoryId > 0)
        {
            QutationHistoryId = quotationHistory.QuotationHistoryId;
            _productItems = await Mediator.Send(new GetAllQuotationHistoryLineProducts(quotationHistory.QuotationHistoryId));
        }
        addNewForm("load");
        if (EditSessionId != null)
        {
            ParentData = await Mediator.Send(new GetQuotationAwardSession(EditSessionId));

            if (ParentData != null && ParentData.QuotationAwardId > 0)
            {
                QuotationAwardId = ParentData.QuotationAwardId;
                Data.QuotationAwardId = ParentData.QuotationAwardId;
                Data.TypeOfOrderId = ParentData.TypeOfOrderId;
                Data.ItemId = ParentData.ItemId;
                Data.TotalQtys = ParentData.TotalQty != null && ParentData.TotalQty > 0 ? ParentData.TotalQty.ToString().Split(".")[0] : null;
                Data.IsCommitment = ParentData.IsCommitment;
                Data.IsCommitmentBy = ParentData.IsCommitment == true ? "Yes" : "No";
                Data.IsFollowDateBy = ParentData.IsFollowDate == true ? "Yes" : "No";
                Data.CommittedQtys = ParentData.CommittedQty != null && ParentData.CommittedQty > 0 ? (int.Parse(ParentData.CommittedQty.ToString().TrimEnd('0').TrimEnd('.'))) : null;
                Data.CommittedOn = ParentData.CommittedOn;
                Data.IsFollowDate = ParentData.IsFollowDate;
                Data.Prices = ParentData.Price != null && ParentData.Price > 0 ? ParentData.Price.ToString().TrimEnd('0').TrimEnd('.') : null;
                Data.ReasonForDifferentQty = ParentData.ReasonForDifferentQty;
                Data.StatusCodeId = ParentData.StatusCodeId;
                Data.ReasonForDifferentPrice = ParentData.ReasonForDifferentPrice;
                Data.IsDifferentQty = ParentData.IsDifferentQty;
                Data.ReasonForDifferentPrice = ParentData.ReasonForDifferentPrice;
                Data.IsDifferentPrice = ParentData.IsDifferentPrice;
                Data.SessionId = ParentData.SessionId;
                Data.AddedDate = ParentData.AddedDate;
                Data.AddedByUserId = ParentData.AddedByUserId;
                addEnabled = true; saveEnabled = true;
                await RefAddQuotationAwardLineForms.loadChildData(QuotationAwardId);
            }
        }
        else
        {
            await RefAddQuotationAwardLineForms.loadChildData(QuotationAwardId);
        }
        StateHasChanged();
    }

    void SelectedItemprod(GenericCodes genericCodes)
    {
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
        }
        else if (e.TabIndex == 1)
        {
        }
    }
    void onBack()
    {
        NavigationManager.NavigateTo("QuotationHistory/AddQuotationHistory/" + SessionId);

        //RevokeBack?.Invoke();
    }
    void EulaPopupQtyClosed(PopupClosedEventArgs args)
    {
        IsDifferentQtypopup = false;
    }
    void IsDifferentQtyClick()
    {
        IsDifferentQtys = true;
        Data.IsDifferentQty = true;
        IsDifferentQtypopup = false;
        StateHasChanged();
    }
    void IsDifferentQtyNoClick()
    {
        IsDifferentQtys = true;
        Data.ReasonForDifferentQty = null;
        Data.IsDifferentQty = false;
        IsDifferentQtypopup = false;
        StateHasChanged();
    }
    void IsDifferentPriceClick()
    {
        IsDifferentPrices = true;
        Data.IsDifferentPrice = true;
        IsDifferentPricepopup = false;
        StateHasChanged();
    }
    void IsDifferentPriceNoClick()
    {
        IsDifferentPrices = true;
        Data.ReasonForDifferentPrice = null;
        Data.IsDifferentPrice = false;
        IsDifferentPricepopup = false;
        StateHasChanged();
    }
    void EulaPopupPriceClosed(PopupClosedEventArgs args)
    {
        IsDifferentPricepopup = false;
    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleFormValidSubmit();
        }
    }
    void addNewForm(string? load)
    {
        if (string.IsNullOrEmpty(load))
        {
            if (EditSessionId != null)
            {
                NavigationManager.NavigateTo($"QuotationHistory/AddQuotationAwardForm/" + SessionId);
            }
        }
        _editContext = new EditContext(Data);
        QuotationAwardId = 0;
        Data.QuotationAwardId = 0;
        Data.TypeOfOrderId = null;
        Data.ItemId = null;
        Data.TotalQty = null; Data.TotalQtys = null;
        Data.CommittedOn = null;
        Data.CommittedQty = null; Data.CommittedQtys = null;
        Data.IsFollowDate = false;
        Data.IsCommitment = false;
        Data.Price = null; Data.Prices = null;
        Data.ReasonForDifferentQty = null;
        Data.ReasonForDifferentPrice = null;
        Data.StatusCodeId = 1;
        Data.IsDifferentQty = false;
        Data.IsDifferentPrice = false;
        Data.IsCommitmentBy = "No";
        Data.IsFollowDateBy = "No";
        Data.SessionId = null;
        Data.AddedByUserId = null; Data.AddedDate = DateTime.Now;
        Data.ModifiedByUserId = null; Data.ModifiedDate = null;
        addEnabled = true; saveEnabled = true; IsDifferentQtys = false; IsDifferentPrices = false;
        StateHasChanged();
    }
    void OnTotalQtyValueChanged(string totalQtys)
    {
        if (IsDifferentQtys == false)
        {
            IsDifferentQtypopup = true;
        }
        Data.TotalQtys = totalQtys;
        StateHasChanged();
    }
    void OnTotalPricesValueChanged(string prices)
    {
        if (IsDifferentPrices == false)
        {
            IsDifferentPricepopup = true;
        }
        Data.Prices = prices;
        StateHasChanged();
    }
    async Task HandleFormValidSubmit()
    {
        addEnabled = false; saveEnabled = false;
        var request = new InsertOrUpdateQuotationAward
            {
                QuotationAwardId = Data.QuotationAwardId,
                QuotationHistoryId = QutationHistoryId,
                TypeOfOrderId = Data.TypeOfOrderId,
                ItemId = Data.ItemId,
                TotalQty = !string.IsNullOrEmpty(Data.TotalQtys) ? Decimal.Parse(Data.TotalQtys) : null,
                CommittedOn = Data.CommittedOn,
                IsCommitment = Data.IsCommitmentBy == "Yes" ? true : false,
                CommittedQty = Data.CommittedQtys,
                IsFollowDate = Data.IsFollowDateBy == "Yes" ? true : false,
                Price = !string.IsNullOrEmpty(Data.Prices) ? Decimal.Parse(Data.Prices) : null,
                ReasonForDifferentQty = Data.ReasonForDifferentQty,
                ReasonForDifferentPrice = Data.ReasonForDifferentPrice,
                StatusCodeId = Data.StatusCodeId,
                IsDifferentQty = Data.IsDifferentQty == true ? true : false,
                IsDifferentPrice = Data.IsDifferentPrice == true ? true : false,
                AddedByUserId = Data.AddedByUserId > 0 ? Data.AddedByUserId : applicationUser.UserID,
                AddedDate = Data.AddedByUserId > 0 ? Data.AddedDate : DateTime.Now,
                ModifiedByUserId = applicationUser.UserID,
                ModifiedDate = DateTime.Now,
                SessionId = Data.SessionId != null ? Data.SessionId : Guid.NewGuid(),
            };
        var result = await Mediator.Send(request);
        if (result.QuotationAwardId > 0)
        {
            if (QuotationAwardId > 0)
            {
                toastService.ShowToast("Record Updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
                NavigationManager.NavigateTo($"QuotationHistory/AddQuotationAwardForm/" + SessionId + "/" + result.SessionId);
            }
            else
            {
                toastService.ShowToast("Record Save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                NavigationManager.NavigateTo($"QuotationHistory/AddQuotationAwardForm/" + SessionId + "/" + result.SessionId);
            }
            QuotationAwardId = result.QuotationAwardId;
            Data.QuotationAwardId = result.QuotationAwardId;
            addEnabled = true; saveEnabled = true;
        }
        StateHasChanged();
    }
    void OnCommitmentByValueChanged(string? radioValue)
    {
        Data.IsCommitment = false;
        Data.IsCommitmentBy = radioValue;
        if (radioValue == "Yes")
        {
            Data.IsCommitment = true;

        }
        StateHasChanged();
    }
    void OnIsFollowDateValueChanged(string? radioValue)
    {
        Data.IsFollowDate = false;
        Data.IsFollowDateBy = radioValue;
        if (radioValue == "Yes")
        {
            Data.IsFollowDate = true;

        }
        StateHasChanged();
    }
}
