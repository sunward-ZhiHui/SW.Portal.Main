@using Application.Commands;
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@using global::Core.Entities.Views;
@using global::Core.Repositories.Query;
@using global::Core.EntityModels;
@inject IMediator Mediator
@using DevExpress.Export
@using Application.Response;
@using System.ComponentModel.DataAnnotations;
@inject IJSRuntime JSRuntime;
@using System.Reflection;
@inject AC.SD.Core.Services.ToastService toastService
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Helpers.TreeGenerateRecursive _treeGenerateRecursive
@inject NavigationManager NavigationManager
@page "/QuotationHistory/AddQuotationHistory"
@page "/QuotationHistory/AddQuotationHistory/{SessionIds:guid}"
@implements IDisposable
<style scoped>
    .save_hover_Master_From_1 {
        float: left;
        margin-top: -41px;
        line-height: 38px;
        margin-left: 200px;
        width: 100px;
    }
</style>
<div class="card" style="margin-bottom:10px; margin-left:-12px; margin-right:-12px;">
    <div class="card-body p-0">
        <div class="row">
            <div class="">
                <DxMenu CollapseItemsToHamburgerMenu="true"
                        CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                        DisplayMode="MenuDisplayMode.Desktop">
                    <Items>
                        <DxMenuItem Text="Back" IconCssClass="fa fa-reply" Click="@backUrl" />
                        <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@addNew" />
                        <DxMenuItem Text="Save" IconCssClass="fa fa-save" Click="@SubmitFormExternally" />
                    </Items>
                </DxMenu>
            </div>
        </div>
    </div>
</div>

<div class="">
    <div class="row align-items-start" style="overflow: auto; border: 1px solid #d5d4d4;">
        <div class="cw-480" style="margin-top:10px;">
            <EditForm EditContext="this._editContext" Context="EditFormContext" OnValidSubmit="HandleValidSubmit">
                <DxFormLayout CssClass="w-100">
                    <DataAnnotationsValidator />

                    <DxFormLayoutItem Caption="User Name" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.AddedBy" ShowValidationIcon="true" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.AddedDate" Enabled=false />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Company" ColSpanMd="6">
                        <DxComboBox Data="@_plantItems"
                                    NullText="Select Company..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="NavCompany"
                                    ValueFieldName="PlantID"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                        @bind-Value="@Data.CompanyId" ShowValidationIcon="true">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.PlantCode)"
                                                    Caption="Company Code"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.Description)"
                                                    Caption="Description" />
                                <DxListEditorColumn FieldName="@nameof(ViewPlants.NavCompany)"
                                                    Caption="Nav Company" />
                            </Columns>
                        </DxComboBox>

                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="SW ReferenceNo" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.SwreferenceNo"></DxTextBox>

                    </DxFormLayoutItem><DxFormLayoutItem Caption="Date" ColSpanMd="6">
                        <DxDateEdit NullText="Date" @bind-Date="@Data.Date" ShowValidationIcon="true" />
                        <ValidationMessage For="@(() => Data.Date)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Customer Name" ColSpanMd="6">
                        <DxComboBox Data="@_AllSoCustomer"
                                    NullText="Select Customer..."
                                    ListRenderMode="ListRenderMode.Virtual"
                                    FilteringMode="DataGridFilteringMode.StartsWith"
                                    TextFieldName="CustomerName"
                                    ValueFieldName="SoCustomerId"
                                    EditFormat="{0}-{1}"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                        @bind-Value="@Data.CustomerId" ShowValidationIcon="true"
                                    SelectedItemChanged="@((SoCustomer soCustomer) => SelectedItemChanged(soCustomer))">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(SoCustomer.CustomerName)"
                                                    Caption="Customer Name"
                                                    Width="180px" />
                                <DxListEditorColumn FieldName="@nameof(SoCustomer.ShipCode)"
                                                    Caption="Ship Code" />
                                <DxListEditorColumn FieldName="@nameof(SoCustomer.AssignToRep)"
                                                    Caption="AssignTo Rep" />
                                <DxListEditorColumn FieldName="@nameof(SoCustomer.Type)"
                                                    Caption="Type" />
                            </Columns>
                            <Buttons>
                                <DxEditorButton IconCssClass="fa fa-eye" Id=@($"flyout-overview-target-container-customer-info")
                                                Tooltip="Pricing Info"
                                                Click="@(_ => OnButtonCustomerClick())" />
                            </Buttons>
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.CustomerId)" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Customer RefNo" ColSpanMd="6">
                        <DxTextBox @bind-Text="@Data.CustomerRefNo"></DxTextBox>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Status" ColSpanMd="6">
                        <DxComboBox Data="@_stausItems"
                                    NullText="Select Status..."
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    TextFieldName="CodeValue"
                                    ValueFieldName="CodeId"
                        @bind-Value="@Data.StatusCodeId"
                                    ShowValidationIcon="true">
                        </DxComboBox>
                        <ValidationMessage For="@(() => Data.StatusCodeId)" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditForm>
            <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                <div class="cw-480 ch-220" style="margin-top:10px;">
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick=@OnTabClick>
                            <DxFormLayoutTabPage Caption="Quotation History Line">
                                <AddQuotationHistorysLine @ref="refAddQuotationHistorysLine" applicationUser="@applicationUser" QuotationHistoryId="@QuotationHistoryId"></AddQuotationHistorysLine>
                            </DxFormLayoutTabPage>
                            <DxFormLayoutTabPage Caption="Attachment">
                                <AC.SD.Core.Pages.UploadDocuments.UploadDocuments SessionId="@SessionIds" ForNoPopup="Yes"></AC.SD.Core.Pages.UploadDocuments.UploadDocuments>
                            </DxFormLayoutTabPage>
                        </DxFormLayoutTabPages>
                    </DxFormLayout>
                </div>
            </div>

        </div>
    </div>


</div>
<DxFlyout @bind-IsOpen=IsCustomerOpen
          PositionTarget=@($"#flyout-overview-target-container-customer-info")
          RestrictionTarget="#Navigation-Flyout-Customization"
          AnimationType="FlyoutAnimationType.Fade"
          PreventCloseOnPositionTargetClick="true"
          FooterVisible="true"
          FooterCssClass="custom-flyout-footer"
          Width="max(25vw, 550px)"
          CloseOnOutsideClick=false
          Position=@(FlyoutPosition.BottomStart | FlyoutPosition.TopStart)>
    <BodyContentTemplate Context="PopupContext">
        <div class="custom-flyout-body" style="width:100%">

            <table style="width:100%" id="customers">
                @if (@soCustomer1.SoCustomerId > 0)
                {
                    <tr>
                        <th>Name</th>
                        <td>@soCustomer1.CustomerName</td>
                    </tr>
                    <tr>
                        <th>Ship Code</th>
                        <td>@soCustomer1.ShipCode</td>
                    </tr>
                    <tr>
                        <th>Assign To Rep</th>
                        <td>@soCustomer1.AssignToRep</td>
                    </tr>
                    <tr>
                        <th>Address1</th>
                        <td>@soCustomer1.Address1</td>
                    </tr>
                    <tr>
                        <th>Address2</th>
                        <td>@soCustomer1.Address2</td>
                    </tr>
                    <tr>
                        <th>State Code</th>
                        <td>@soCustomer1.StateCode</td>
                    </tr>
                    <tr>
                        <th>City</th>
                        <td>@soCustomer1.City</td>
                    </tr>
                    <tr>
                        <th>PostCode</th>
                        <td>@soCustomer1.PostCode</td>
                    </tr>
                    <tr>
                        <th>Channel</th>
                        <td>@soCustomer1.Channel</td>
                    </tr>
                }
                else
                {
                    <tr><td colspan="2">No Records Found.</td></tr>
                }
            </table>

        </div>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="w-100">
            <div class="custom-flyout-footer">

                <DxButton CssClass="popup-button" RenderStyle="ButtonRenderStyle.Primary" Text="Close" Click=@(()=> IsCustomerOpen = false) />
            </div>
        </div>
    </FooterContentTemplate>
</DxFlyout>
@code {
    AddQuotationHistorysLine? refAddQuotationHistorysLine { get; set; }
    private DxTreeView _treeFilterDocView;
    string? FilterDocumentString { get; set; }
    EditContext _editContext;
    [Parameter]
    public Guid? SessionIds { get; set; }
    public QuotationHistory _quotationHistoryData;
    private bool loading;
    int ActiveSubTabIndex { get; set; } = 0;
    private QuotationHistory Data = new QuotationHistory();
    public ApplicationUser applicationUser { get; private set; }
    IEnumerable<DocumentsModel> _selectedTreeItems = new List<DocumentsModel>();
    long? QuotationHistoryId { get; set; }
    private List<CodeMaster> _stausItems;
    private List<ViewPlants>? _plantItems;
    private List<SoCustomer>? _AllSoCustomer;
    bool IsCustomerOpen { get; set; } = false;
    SoCustomer soCustomer1 = new SoCustomer();
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(Data);
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        _plantItems = await Mediator.Send(new GetAllPlantByNavCompanyQuery());
        _stausItems = await Mediator.Send(new GetAllCodeMasterQuery("Status"));
        _AllSoCustomer = await Mediator.Send(new GetSoCustomerByTypeQuery("Customer"));
    }
    protected override async Task OnParametersSetAsync()
    {
        await OnParametersSetLoadAsync();
        base.OnParametersSet();
    }
    void OnButtonCustomerClick()
    {
        IsCustomerOpen = true;
    }
    void SelectedItemChanged(SoCustomer soCustomer)
    {
        if (soCustomer != null)
        {
            Data.ShipCode = soCustomer.ShipCode;
            Data.AssignToRep = soCustomer.AssignToRep;
            Data.Address1 = soCustomer.Address1;
            soCustomer1 = soCustomer;
        }
        else
        {
            soCustomer1 = new SoCustomer();
            Data.ShipCode = "";
            Data.AssignToRep = "";
            Data.Address1 = "";
        }
    }
    private async Task SubmitFormExternally()
    {
        if (_editContext.Validate())
        {
            await this.HandleValidSubmit();
        }
    }
    async Task OnParametersSetLoadAsync()
    {
        _editContext = new EditContext(Data);
        Data.AddedDate = DateTime.Now;
        Data.AddedBy = applicationUser.UserName;
        Data.ModifiedBy = applicationUser.UserName;
        QuotationHistoryId = 0;
        Data.QuotationHistoryId = 0;
        Data.ModifiedByUserId = applicationUser.UserID;
        Data.AddedByUserId = applicationUser.UserID;
        Data.ModifiedDate = null;
        Data.ModifiedBy = null;
        Data.SwreferenceNo = null;
        Data.CustomerRefNo = null;
        Data.CustomerId = null;
        Data.SessionId = Guid.NewGuid();
        Data.StatusCodeId = 1; Data.CompanyId = null;
        ActiveSubTabIndex = 0;
        if (SessionIds != null)
        {
            var quotationHistoryData = await Mediator.Send(new GetQuotationHistoryBySession(SessionIds));
            if (quotationHistoryData != null)
            {
                _quotationHistoryData = quotationHistoryData;
                QuotationHistoryId = quotationHistoryData.QuotationHistoryId;
                Data.QuotationHistoryId = quotationHistoryData.QuotationHistoryId;
                Data.AddedBy = quotationHistoryData.AddedBy;
                Data.ModifiedByUserId = quotationHistoryData.ModifiedByUserId;
                Data.AddedByUserId = quotationHistoryData.AddedByUserId;
                Data.AddedDate = quotationHistoryData.AddedDate;
                Data.ModifiedDate = quotationHistoryData.ModifiedDate;
                Data.ModifiedBy = quotationHistoryData.ModifiedBy;
                Data.CustomerId = quotationHistoryData.CustomerId;
                Data.SwreferenceNo = quotationHistoryData.SwreferenceNo;
                Data.CustomerRefNo = quotationHistoryData.CustomerRefNo;
                Data.SessionId = quotationHistoryData.SessionId == null ? Guid.NewGuid() : quotationHistoryData.SessionId;
                Data.Date = quotationHistoryData.Date;
                Data.StatusCodeId = quotationHistoryData.StatusCodeId;
                Data.CompanyId = quotationHistoryData.CompanyId;
                await refAddQuotationHistorysLine.loadChildData(QuotationHistoryId);
            }
        }
        else
        {
            await refAddQuotationHistorysLine.loadChildData(QuotationHistoryId);
        }
        StateHasChanged();

    }
    async Task OnTabClick(TabClickEventArgs e)
    {
        if (e.TabIndex == 0)
        {
            await refAddQuotationHistorysLine.loadChildData(QuotationHistoryId);
        }
        else if (e.TabIndex == 1)
        {
        }
    }
    void backUrl()
    {
        NavigationManager.NavigateTo("QuotationHistory");
    }
    void ResetForm()
    {
        QuotationHistoryId = 0;
        ActiveSubTabIndex = 0;
        NavigationManager.NavigateTo("QuotationHistory/AddQuotationHistory");
    }
    async Task addNew()
    {
        if (SessionIds != null)
        {
            NavigationManager.NavigateTo("QuotationHistory/AddQuotationHistory");
        }
        else
        {
            await OnParametersSetLoadAsync();
        }

    }

    async Task HandleValidSubmit()
    {
        loading = true;

        var editReq = new InsertOrUpdateQuotationHistory
            {
                QuotationHistoryId = Data.QuotationHistoryId,
                AddedByUserId = Data.AddedByUserId,
                CustomerId = Data.CustomerId,
                SessionId = Data.SessionId,
                ModifiedByUserId = Data.ModifiedByUserId,
                ModifiedDate = DateTime.Now,
                StatusCodeId = 1,
                AddedDate = DateTime.Now,
                SwreferenceNo = Data.SwreferenceNo,
                Date = Data.Date,
                CompanyId = Data.CompanyId,
                CustomerRefNo = Data.CustomerRefNo,
            };

        var result = await Mediator.Send(editReq);
        if (result.QuotationHistoryId > 0)
        {
            if (QuotationHistoryId > 0)
            {
                toastService.ShowToast("Record updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
                QuotationHistoryId = result.QuotationHistoryId;
                ActiveSubTabIndex = 0;
                loading = false;
                await OnParametersSetLoadAsync();
            }
            else
            {
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                QuotationHistoryId = result.QuotationHistoryId;
                ActiveSubTabIndex = 0;
                loading = false;
                NavigationManager.NavigateTo("QuotationHistory/AddQuotationHistory/" + editReq.SessionId + "");
            }

        }
        StateHasChanged();

    }
    public void Dispose()
    {
        System.GC.Collect();
        GC.SuppressFinalize(this);
    }
}
