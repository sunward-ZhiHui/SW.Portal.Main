@page "/FileUploads"
@using Application.Commands;
@using Application.Queries;
@using DevExpress.Export;
@inject IJSRuntime jsRuntime
@using global::Core.Entities;
@using global::Core.Entities.Views;
@inject IMediator Mediator
@using MediatR
@using Microsoft.Extensions.Configuration;
@using global::Core.Repositories.Query;
@inject IConfiguration Configuration;
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@using System.IO;
@using System.Linq;


<div class="card w-100" style="margin-bottom:10px;">
    <div class="card-body p-0">
        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@AddFile" />
                <DxMenuItem Text="Download" IconCssClass="fa fa-cloud-download" Click="((e) => onDocDownload(_selectedItems.ReportDocumentID))"  />
             <DxMenuItem Text="View Document" IconCssClass="fa fa-eye" Click="((e) => onPreView(_selectedItems.ReportDocumentID))" />
                
            </Items>
        </DxMenu>
    </div>
</div>
<DxLoadingPanel @bind-Visible="PanelVisible"
                IsContentBlocked="true"
                ApplyBackgroundShading="true"
                IndicatorAreaVisible="false"
                Text="Fetching Data...">


    <DxGrid @ref="Grid" Data="@_reportdocuments" ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
            PagerNavigationMode="PagerNavigationMode.InputBox" PageSizeSelectorVisible="true"
            @bind-SelectedDataItems="@SelectedDataItems"
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            PageSizeSelectorAllRowsItemVisible="true"
            PageSizeSelectorItems="@(new int[] { 5,10,20 })"
            PageSize="20" CustomizeElement="Grid_CustomizeElement" style="height: calc(100vh - 220px);"
            CssClass="w-100" AutoExpandAllGroupRows="true"
            SelectionMode="GridSelectionMode.Multiple"
            FocusedRowEnabled ="true"
            EditModelSaving="@OnEditModelSaving"
            RowClick="OnRowClick"
            SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages">
        <Columns>

            <DxGridDataColumn FieldName="Name" MinWidth="150" />
            <DxGridDataColumn FieldName="Description" MinWidth="250" />
           @* <DxGridDataColumn FieldName="FileSize "  MinWidth="150" />*@
           @* <DxGridDataColumn FieldName="FilePath" Width="180" />*@
           
        </Columns>
        <EditFormTemplate Context="EditFormContext">
            @{
                var documents = (ReportDocuments)EditFormContext.EditModel;
            }
            <DxFormLayout CssClass="w-100">
                <DxFormLayoutItem Caption="Name:" ColSpanMd="6">
                    <DxTextBox @bind-Text="@documents.Name" />
                    <ValidationMessage For="@(() => documents.Name)" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Description:" ColSpanMd="6">
                    <DxTextBox @bind-Text="@documents.Description" />
                </DxFormLayoutItem>
                <DxFormLayoutItem>
                   @* <div id="attachmentSelectButton" style="height: 33px;" class="btn border-primary btn-primary m-1 handline">Select File</div>
                    <div class="">
                        <DxUpload @ref="uploadComponent" Name="files"
                                  Visible="@AttachmentUploadVisible"
                                  AcceptedFileTypes=@AcceptedFileTypes
                                  UploadMode="@UploadMode.OnButtonClick"
                                  UploadUrl="@GetUploadUrl()"
                                  AllowMultiFileUpload="true"
                                  ExternalSelectButtonCssSelector="#attachmentSelectButton"
                                  SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                  FileUploaded="@isUploadSuccess"
                                  FileUploadError="@OnUploadError">
                        </DxUpload>
                  

                        <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>
                    </div>*@

             
                    <InputFile  type="file"  OnChange="@HandleFileChange" />
                  @*  <button @onclick="UploadFile">Upload</button>*@

                    <div style="width:100%;">
                        @if (ActiveSessionId != null)
                        {
                            @if (_reportdocuments != null && _reportdocuments.Any())
                            {
                                <ul class="d-flex flex-column-reverse todo-list">
                                    @foreach (var item in _reportdocuments)
                                    {

                                        <li class="doc_lst_view">
                                            <div class="form-check">
                                                <label class="form-check-label">
                                                    <span style="font-weight: 600; font-size: 14px;">@item.FileName</span>
                                                    @{
                                                        string formattedFileSize = FormatFileSize(item.FileSize);
                                                    }
                                                    <span style="font-size: 11px;">  @formattedFileSize</span>



                                                </label>
                                            </div>
                                        </li>
                                    }
                                </ul>

                            }
                        }
                    </div>
                </DxFormLayoutItem>
                <ValidationSummary />
            </DxFormLayout>
        </EditFormTemplate>
    </DxGrid>

       
</DxLoadingPanel>

@code {
    bool UploadVisible { get; set; } = false;
    IEnumerable<UploadFileInfo> Files { get; set; }
    UploadFileInfo FirstFile { get; set; }
    DxUpload MyUpload { get; set; }
    ReportDocuments? Data { get; set; } = new ReportDocuments();
    private ReportDocuments _selectedItems;
    bool PopupVisible { get; set; } = false;
    public ApplicationUser applicationUser { get; private set; }
    Guid? _sessionId;
    [Parameter]
    public string ActiveSessionId { get; set; }
    [Parameter]
    public List<string> AcceptedFileTypes { get; set; } = new List<string> {  ".repx" };
    bool AttachmentUploadVisible { get; set; } = false;
    IReadOnlyList<object> SelectedDataItems { get; set; }
    bool PanelVisible { get; set; }
    private List<ReportDocuments> _reportdocuments;
    IGrid Grid { get; set; }
    private DxUpload uploadComponent;
    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    bool isFileUpload = false;
    string MyError { get; set; }
    bool ErrorVisible { get; set; } = false;
    //protected void SelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    //{
    //    using (var memoryStream = new MemoryStream())
    //    {
    //        files.FileStream.CopyTo(memoryStream);
    //        byte[] fileBytes = memoryStream.ToArray();

    //         Now, you can use the 'fileBytes' array as needed.
    //         For example, you can save it to a database or process it further.
    //    }
    //    Files = files;
    //      UploadVisible = files.ToList().Count > 0;

    //    InvokeAsync(StateHasChanged);
    //}

    protected override async Task OnInitializedAsync()
    {

        PanelVisible = true;
        _sessionId = Guid.NewGuid();
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        await UpdateDataAsync();
        PanelVisible = false;

    }
    async Task UpdateDataAsync()
    {
        var model = await Mediator.Send(new GetAllReportFileUploadsQuery());
        _reportdocuments = model;
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }

    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        PopupVisible = false;
        UpdateDataAsync();
    }

    async void ClosePopup()
    {
        PopupVisible = false;
    }

    void OnCustomizeCell(GridExportCustomizeCellEventArgs args)
    {
        if (args.ColumnFieldName == "ContactName" && args.AreaType == SheetAreaType.DataArea)
            args.Formatting.Font = new XlCellFont() { Italic = true };
        args.Handled = true;



    }
    public  string GetUploadUrl()
    {
        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];

        string url = BaseUrl + "Report/UplodReportDocuments?SessionId=" + _sessionId + "&addedByUserId = 1" ;
        return url.ToString();
        PopupVisible = false;
        UpdateDataAsync();

    }
    protected async void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
    }
    private async Task isUploadSuccess()
    {
        //uploadComponent.RemoveAllFiles();
        //uploadComponent.CancelAllFilesUpload();
        isFileUpload = false;
        //await LoadData();
    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }
    public static string FormatFileSize(long bytes)
    {
        var unit = 1024;
        if (bytes < unit) { return $"{bytes} B"; }

        var exp = (int)(Math.Log(bytes) / Math.Log(unit));
        return $"{bytes / Math.Pow(unit, exp):F2} {("KMGTPE")[exp - 1]}B";
    }
    public void AddFile()
    {
        Grid.StartEditNewRowAsync();
    }
    public async Task onDocDownload(long Id)
    {
        var lst = _reportdocuments?.FirstOrDefault(a => a.ReportDocumentID == Id);
       
        //string BaseDirectory = System.AppContext.BaseDirectory;
        //var reportFolder = Path.Combine(BaseDirectory, "Reports");
        //var filePath = reportFolder + lst.FileName;
        //        if (System.IO.File.Exists(filePath))
        //        {
        //            var fileBytes = System.IO.File.ReadAllBytes(filePath);
        //            return File(fileBytes, "application/octet-stream", lst.FileName);
        //        }
        ////  _reportdocuments = await Mediator.Send(new GetEmailTopicDocList(long.Parse(@SelectedGroup)));
        //var lst = _reportdocuments?.FirstOrDefault(a => a.ReportDocumentID == Id);



        ////var url = FileUrl + lst.FilePath;
        ////await OpenUrlInNewTab(url);
        ////NavigationManager.NavigateTo(url, forceLoad: true);
//  var request = new DownloadReportFileRequest
        //    {
        //        FileName = lst.FileName,
        //        FilePath = lst.FilePath,
        //        ContentType = lst.ContentType
        //    };

        //var response = await Mediator.Send(request);

        ////  Trigger file download
        //await jsRuntime.InvokeVoidAsync("downloadFile", response.FileName, response.ContentType, "");
    }
    void OnRowClick(GridRowClickEventArgs e)
    {


        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ReportDocumentID");
        _selectedItems = _reportdocuments.FirstOrDefault(f => f.ReportDocumentID == (long?)UniqueId);
    }
    async Task OnEditModelSaving(GridEditModelSavingEventArgs e)
    {

        var editModel = (ReportDocuments)e.EditModel;


        var ex = _reportdocuments.Where(x => x.Name == editModel.Name);
        if (ex.Any())
        {
            // onShowPopupMessage("Error", "The entered value Already exists.");
            toastService.ShowToast("The entered value Already exists.", AC.SD.Core.Services.ToastLevel.Error);
        }
        else
        {


            var createReq = new CreateReportFileQuery
                    {
                        Name = editModel.Name,
                        Description = editModel.Description,
                        FileContent = fileContent,
                        FileName = fileName,
                       // FileContent = Files,
                        //StatusCodeID = 1,
                        //AddedByUserID = applicationUser.UserID,
                        // ModifiedByUserID = applicationUser.UserID,
                        //AddedDate = DateTime.Now,
                        //  ModifiedDate = DateTime.Now,
                        SessionId = Guid.NewGuid()
                    };

            try
            {
                var result = await Mediator.Send(createReq);
                toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                //  onShowPopupMessage("Success", "Record save Successfully");
            }
            catch (Exception eq)
            {

                //errorMessage = eq.Message;
                //PopupVisible = true;

            }

            await UpdateDataAsync();
        }



    }
    public async Task onPreView(long Id)
    {
        
    }
    private byte[] fileContent;
    private string fileName;
    private string uploadStatus;

   

    private async Task HandleFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        fileName = file.Name;
        var buffer = new byte[file.Size];
        await file.OpenReadStream().ReadAsync(buffer);
        fileContent = buffer;
    }

    private async Task UploadFile()
    {
        var command = new FileUploadCommand
            {
                FileName = fileName,
                FileContent = fileContent
            };

        var result = await Mediator.Send(command);
        uploadStatus = $"File '{result}' uploaded successfully!";
    }
}