@page "/reportFileUploads"
@using Application.Commands;
@using Application.Queries;
@using DevExpress.Export;
@inject IJSRuntime jsRuntime
@using System.IO;
@using System.Text.RegularExpressions;
@using global::Core.Entities;
@using global::Core.Entities.Views;
@inject IMediator Mediator
@using MediatR
@using Microsoft.Extensions.Configuration;
@using global::Core.Repositories.Query;
@inject IConfiguration Configuration;
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject AC.SD.Core.Services.ToastService toastService
@using System.Linq;
@using Microsoft.AspNetCore.Mvc;
@using Microsoft.EntityFrameworkCore;
@using System;
@inject NavigationManager NavigationManager

<div class="card w-100" style="margin-bottom:10px;">
    <div class="card-body p-0">
        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Add" IconCssClass="fa fa-add" Click="@AddFile" />
                <DxMenuItem Text="Edit" IconCssClass="fa fa-pencil" Click="@EditFile" />
                <DxMenuItem Text="Download" IconCssClass="fa fa-cloud-download" Click="((e) => onDocDownload(_selectedItems.ReportDocumentID))"  />
               
             <DxMenuItem Text="View Document" IconCssClass="fa fa-eye" Click="((e) => onPreView(_selectedItems.FileName))" />
                
            </Items>
        </DxMenu>
    </div>
</div>
<DxLoadingPanel @bind-Visible="PanelVisible"
                IsContentBlocked="true"
                ApplyBackgroundShading="true"
                IndicatorAreaVisible="false"
                Text="Fetching Data...">


    <DxGrid @ref="Grid" Data="@_reportdocuments" ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
            PagerNavigationMode="PagerNavigationMode.InputBox" PageSizeSelectorVisible="true"
            @bind-SelectedDataItems="@SelectedDataItems"
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            PageSizeSelectorAllRowsItemVisible="true"
            PageSizeSelectorItems="@(new int[] { 5,10,20 })"
            PageSize="20" CustomizeElement="Grid_CustomizeElement" style="height: calc(100vh - 220px);"
            CssClass="w-100" AutoExpandAllGroupRows="true"
            SelectionMode="GridSelectionMode.Multiple"
            FocusedRowEnabled ="true"
            EditModelSaving="@OnEditModelSaving"
            RowClick="OnRowClick"
            SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages">
        <Columns>

            <DxGridDataColumn FieldName="Name" MinWidth="150" />
            <DxGridDataColumn FieldName="Description" MinWidth="250" />
           @* <DxGridDataColumn FieldName="FileSize "  MinWidth="150" />*@
           @* <DxGridDataColumn FieldName="FilePath" Width="180" />*@
           
        </Columns>
        <EditFormTemplate Context="EditFormContext">
            @{
                var documents = (ReportDocuments)EditFormContext.EditModel;
            }
            <DxFormLayout CssClass="w-100">
                <DxFormLayoutItem Caption="Name:" ColSpanMd="6">
                    <DxTextBox @bind-Text="@documents.Name" />
                    <ValidationMessage For="@(() => documents.Name)" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Description:" ColSpanMd="6">
                    <DxTextBox @bind-Text="@documents.Description" />
                </DxFormLayoutItem>
                <DxFormLayoutItem>
                   @* <div id="attachmentSelectButton" style="height: 33px;" class="btn border-primary btn-primary m-1 handline">Select File</div>
                    <div class="">
                        <DxUpload @ref="uploadComponent" Name="files"
                                  Visible="@AttachmentUploadVisible"
                                  AcceptedFileTypes=@AcceptedFileTypes
                                  UploadMode="@UploadMode.OnButtonClick"
                                  UploadUrl="@GetUploadUrl()"
                                  AllowMultiFileUpload="true"
                                  ExternalSelectButtonCssSelector="#attachmentSelectButton"
                                  SelectedFilesChanged="@AttachmentSelectedFilesChanged"
                                  FileUploaded="@isUploadSuccess"
                                  FileUploadError="@OnUploadError">
                        </DxUpload>
                        <div class="alert alert-danger @(ErrorVisible? " visible" : " invisible")">@MyError</div>
                    </div>*@

             
                    <InputFile  type="file"  OnChange="@HandleFileChange" />
                  @*  <button @onclick="UploadFile">Upload</button>*@
                   
                    <div style="width:100%;">
                        @if (ActiveSessionId != null)
                        {
                            @if (_reportdocuments != null && _reportdocuments.Any())
                            {
                                <ul class="d-flex flex-column-reverse todo-list">
                                    @foreach (var item in _reportdocuments)
                                    {

                                        <li class="doc_lst_view">
                                            <div class="form-check">
                                                <label class="form-check-label">
                                                    <span style="font-weight: 600; font-size: 14px;">@item.FileName</span>
                                                    @{
                                                        string formattedFileSize = FormatFileSize(item.FileSize);
                                                    }
                                                    <span style="font-size: 11px;">  @formattedFileSize</span>
                                                </label>
                                            </div>
                                        </li>
                                    }
                                </ul>

                            }
                        }
                    </div>
                </DxFormLayoutItem>
                <ValidationSummary />
            </DxFormLayout>
        </EditFormTemplate>
    </DxGrid>

       
</DxLoadingPanel>

@code {
    bool UploadVisible { get; set; } = false;
    IEnumerable<UploadFileInfo> Files { get; set; }
    UploadFileInfo FirstFile { get; set; }
    DxUpload MyUpload { get; set; }
    ReportDocuments? Data { get; set; } = new ReportDocuments();
    private ReportDocuments _selectedItems;
    bool PopupVisible { get; set; } = false;
    public ApplicationUser applicationUser { get; private set; }
    Guid? _sessionId;
    [Parameter]
    public string ActiveSessionId { get; set; }
    [Parameter]
    public List<string> AcceptedFileTypes { get; set; } = new List<string> {  ".repx" };
    bool AttachmentUploadVisible { get; set; } = false;
    IReadOnlyList<object> SelectedDataItems { get; set; }
    bool PanelVisible { get; set; }
    private List<ReportDocuments> _reportdocuments;
    IGrid Grid { get; set; }
    private DxUpload uploadComponent;
    private List<UploadFileInfo> SelectedFiles { get; set; } = new List<UploadFileInfo>();
    bool isFileUpload = false;
    string MyError { get; set; }
    bool ErrorVisible { get; set; } = false;


    protected override async Task OnInitializedAsync()
    {

        PanelVisible = true;
        _sessionId = Guid.NewGuid();
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        await UpdateDataAsync();
        PanelVisible = false;

    }
    async Task UpdateDataAsync()
    {
        var model = await Mediator.Send(new GetAllReportFileUploadsQuery());
        _reportdocuments = model;
    }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }

    }
    void EulaPopupClosed(PopupClosedEventArgs args)
    {
        PopupVisible = false;
        UpdateDataAsync();
    }

    async void ClosePopup()
    {
        PopupVisible = false;
    }

    void OnCustomizeCell(GridExportCustomizeCellEventArgs args)
    {
        if (args.ColumnFieldName == "ContactName" && args.AreaType == SheetAreaType.DataArea)
            args.Formatting.Font = new XlCellFont() { Italic = true };
        args.Handled = true;
    }
    public  string GetUploadUrl()
    {
        string BaseUrl = Configuration["DocumentsUrl:BaseUrl"];

        string url = BaseUrl + "Report/UplodReportDocuments?SessionId=" + _sessionId + "&addedByUserId = 1" ;
        return url.ToString();
        PopupVisible = false;
        UpdateDataAsync();

    }
    protected async void AttachmentSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        AttachmentUploadVisible = files.ToList().Count > 0;
        SelectedFiles.AddRange(files);
    }
    private async Task isUploadSuccess()
    {
        //uploadComponent.RemoveAllFiles();
        //uploadComponent.CancelAllFilesUpload();
        isFileUpload = false;
        //await LoadData();
    }
    void OnUploadError(FileUploadErrorEventArgs e)
    {
        MyError = e.RequestInfo.ResponseText;
        ErrorVisible = true;
        InvokeAsync(StateHasChanged);
    }
    public static string FormatFileSize(long bytes)
    {
        var unit = 1024;
        if (bytes < unit) { return $"{bytes} B"; }

        var exp = (int)(Math.Log(bytes) / Math.Log(unit));
        return $"{bytes / Math.Pow(unit, exp):F2} {("KMGTPE")[exp - 1]}B";
    }
    public void AddFile()
    {
        Grid.StartEditNewRowAsync();
    }
    public async Task onDocDownload(long Id)
    {

        var lst = _reportdocuments?.FirstOrDefault(a => a.ReportDocumentID == Id);

        var request = new DownloadReportFileRequest
            {
                FileName = lst.FileName,


            };

        var response = await Mediator.Send(request);

        //  Trigger file download
        await jsRuntime.InvokeVoidAsync("downloadFile", response.FileName +".repx", response.FileData, "");
    }
    void OnRowClick(GridRowClickEventArgs e)
    {


        var UniqueId = e.Grid.GetRowValue(e.VisibleIndex, "ReportDocumentID");
        _selectedItems = _reportdocuments.FirstOrDefault(f => f.ReportDocumentID == (long?)UniqueId);
    }
    async Task OnEditModelSaving(GridEditModelSavingEventArgs e)
    {


        var editModel = (ReportDocuments)e.EditModel;

        if (fileName == null)
        {
            toastService.ShowToast("Please Select File", AC.SD.Core.Services.ToastLevel.Error);
            return;
        }

        if (e.IsNew)
        {
            var ex = _reportdocuments.Where(x => x.FileName == fileName);
            if (ex.Any())
            {
                // onShowPopupMessage("Error", "The entered value Already exists.");
                toastService.ShowToast("The entered value Already exists.", AC.SD.Core.Services.ToastLevel.Error);
            }
            else
            {

                var createReq = new CreateReportFileQuery
                        {
                            Name = editModel.Name,
                            Description = editModel.Description,
                            FileContent = fileContent,
                            FileName = fileName,
                            // FileContent = Files,
                            //StatusCodeID = 1,
                            //AddedByUserID = applicationUser.UserID,
                            // ModifiedByUserID = applicationUser.UserID,
                            //AddedDate = DateTime.Now,
                            //  ModifiedDate = DateTime.Now,
                            SessionId = Guid.NewGuid()
                        };

                try
                {
                    var result = await Mediator.Send(createReq);
                    toastService.ShowToast("Record save Successfully", AC.SD.Core.Services.ToastLevel.Success);
                    //  onShowPopupMessage("Success", "Record save Successfully");
                }
                catch (Exception eq)
                {
                    //toastService.ShowToast("Please Select File", AC.SD.Core.Services.ToastLevel.Error);
                    //errorMessage = eq.Message;
                    //PopupVisible = true;

                }
            }
        }
        else
        {

            var ex = _reportdocuments.Where(x => x.FileName == editModel.FileName && x.ReportDocumentID != editModel.ReportDocumentID);
            if (ex.Any())
            {


                toastService.ShowToast("The entered value Already exists.", AC.SD.Core.Services.ToastLevel.Error);
            }
            else
            {
                var UpdateReq = new EditReportFileQuery
                    {
                        ReportDocumentID = editModel.ReportDocumentID,
                        Name = editModel.Name,
                        Description = editModel.Description,
                        FileName = editModel.FileName,
                        FileData = editModel.FileData,
                        //AddedByUserID = editModel.AddedByUserID,
                        //StatusCodeID = editModel.StatusCodeID,
                        //ModifiedByUserID = applicationUser.UserID,
                        ////   ModifiedDate = DateTime.Now,
                        //AddedDate = editModel.AddedDate,
                        SessionId = editModel.SessionId,

                    };
                try
                {
                    var ans = await Mediator.Send(UpdateReq);
                    toastService.ShowToast("Record Updated Successfully", AC.SD.Core.Services.ToastLevel.Success);
                }
                catch (Exception eq)
                {
                    // toastService.ShowToast("Please Select File", AC.SD.Core.Services.ToastLevel.Error);
                }

            }

        }
        await UpdateDataAsync();




    }
    public async Task onPreView(string fileName)
    {
        //NavigationManager.NavigateTo("ReportViewer/" + fileName + "");
        await jsRuntime.InvokeVoidAsync("window.open", "ReportViewer/" + fileName + "", "_blank");
    }
    private byte[] fileContent;
    private string fileName;
    private string uploadStatus;

    void EditFile()
    {
        Grid.StartEditDataItemAsync(_selectedItems);
    }

    private async Task HandleFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var name  = file.Name;
        var ext = Path.GetExtension(name);


        var m = Regex.Match(name, @"[\[\]'~#%&*{}<>:?/|\\@! 1,2,3,4,5,6,7,8,9,0""]");

        if(m.Success)
        {
            toastService.ShowToast("The File Name DoseNot Contains Special Characters", AC.SD.Core.Services.ToastLevel.Error);
            return;
        }
        if (ext == ".repx" )
        {
            fileName = Path.GetFileNameWithoutExtension(name);

            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);
            fileContent = buffer;
        }
        else
        {
            toastService.ShowToast("The Record Format Is Not Supported", AC.SD.Core.Services.ToastLevel.Error);
        }
    }
 
   
}