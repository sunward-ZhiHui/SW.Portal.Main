@page "/dynamic-colored-chart"
@using System.Drawing
@using DevExpress.Blazor

<h3>Dynamic Colored Line Chart</h3>

<h4>Define Ranges</h4>
@foreach (var rule in Rules)
{
    <div class="mb-2 d-flex align-items-center">
        <label class="me-2">Min:</label>
        <InputNumber @bind-Value="rule.Min" class="me-2" />

        <label class="me-2">Max:</label>
        <InputNumber @bind-Value="rule.Max" class="me-2" />

        <label class="me-2">Color:</label>
        <InputText type="color" @bind-Value="rule.ColorHex" class="me-2" />

        <div style="width: 20px; height: 20px; background-color:@rule.ColorHex; border: 1px solid #000;"></div>
    </div>
}

<button class="btn btn-sm btn-primary" @onclick="AddRule">Add Rule</button>
<button class="btn btn-sm btn-success ms-2" @onclick="RenderChart">Render Chart</button>

@if (colorGroups.Count > 0)
{
    <DxChart T="CapabilityData" Width="100%" Height="500px">
        <DxChartTitle Text="SPC Chart with Conditional Line Colors" />
        <DxChartArgumentAxis ArgumentType="ChartAxisDataType.Numeric" />
        <DxChartValueAxis />

        @foreach (var group in colorGroups)
        {
            <DxChartLineSeries T="CapabilityData"
                               TArgument="double"
                               TValue="double"
                               Data="@group.Value"
                               ArgumentField="p => p.SpecificGravity"
                               ValueField="p => p.Value"
                                                           
                               Name="@($"Range {group.Key}")" />
        }
    </DxChart>
}

@code {
    // Sample chart data (simulate user-selected points)
    private List<CapabilityData> SelectedPoints = new()
    {
        new CapabilityData { SpecificGravity = 1.0, Value = 1.05 },
        new CapabilityData { SpecificGravity = 1.1, Value = 1.1 },
        new CapabilityData { SpecificGravity = 1.2, Value = 1.15 },
        new CapabilityData { SpecificGravity = 1.3, Value = 1.25 },
        new CapabilityData { SpecificGravity = 1.4, Value = 1.35 },
        new CapabilityData { SpecificGravity = 1.5, Value = 1.45 }
    };

    public class CapabilityData
    {
        public double SpecificGravity { get; set; }
        public double Value { get; set; }
    }

    public class ConditionalFormatRule
    {
        public double Min { get; set; }
        public double Max { get; set; }
        public string ColorHex { get; set; } = "#000000";
    }

    private List<ConditionalFormatRule> Rules = new()
    {
        new ConditionalFormatRule { Min = 1.0, Max = 1.15, ColorHex = "#FF0000" },
        new ConditionalFormatRule { Min = 1.15, Max = 1.3, ColorHex = "#FFA500" },
        new ConditionalFormatRule { Min = 1.3, Max = 1.5, ColorHex = "#00FF00" }
    };

    private Dictionary<string, List<CapabilityData>> colorGroups = new();

    private void AddRule()
    {
        Rules.Add(new ConditionalFormatRule());
    }

    private void RenderChart()
    {
        colorGroups.Clear();

        foreach (var rule in Rules)
        {
            string key = rule.ColorHex;

            if (!colorGroups.ContainsKey(key))
                colorGroups[key] = new List<CapabilityData>();

            var matchingPoints = SelectedPoints
                .Where(p => p.Value >= rule.Min && p.Value <= rule.Max)
                .ToList();

            colorGroups[key].AddRange(matchingPoints);
        }
    }
}
