@page "/SPCDashboard"
@using System.IO
@using System.Text.Json
@using System.Security.Claims
@using Application.Queries
@using DevExpress.DashboardWeb
@using MediatR
@using Microsoft.AspNetCore.Http
@using DevExpress.DashboardBlazor
@using DevExpress.DashboardCommon
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using global::Core.Entities
@using global::Core.Repositories.Query
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@inject ILocalStorageService<ApplicationUser> _localStorageService
@inject NavigationManager Navigation
@inject IMediator Mediator
@inject AC.SD.Core.Services.ToastService toastService
@inject IJSRuntime JSRuntime
@implements IDisposable
@using System.Threading

@inject IHttpContextAccessor HttpContextAccessor

@rendermode InteractiveServer

<link href="_content/DevExpress.Blazor.Dashboard/ace.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/ace-theme-dreamweaver.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/ace-theme-ambiance.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx.light.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-analytics.common.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-analytics.light.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-querybuilder.css" rel="stylesheet" />
<link href="_content/DevExpress.Blazor.Dashboard/dx-dashboard.light.min.css" rel="stylesheet" />

<DxSplitter CssClass="splitter" Width="100%">
    <Panes>
        <DxSplitterPane Size="18%" MinSize="200px" AllowCollapse="true">
            <div class="d-flex flex-column gap-2">
                
                <DxButton Text="@ButtonText" Click="ChangeWorkingMode" CssClass="btn btn-primary flex-fill" />

                <DxListBox Data="@DashboardIds"
                           TextFieldName="@nameof(DashboardItem.DisplayName)"
                           @bind-SearchText="@SearchText"
                           @bind-Value="@dashboardItem"
                           ShowSearchBox="true"
                           SearchTextParseMode="@SearchTextParseMode"
                           ListRenderMode="ListRenderMode.Virtual"
                           style="height: calc(100vh - 200px); margin-top: 5px;">
                    <ItemTemplate Context="item">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <span>@item.DisplayName</span>
                        </div>
                    </ItemTemplate>
                </DxListBox>
            </div>
        </DxSplitterPane>

        <DxSplitterPane MaxSize="100%" AllowCollapse="true">
            <DxDashboard Endpoint="api/dashboard"
                         @bind-WorkingMode="@workingMode"
                         @bind-DashboardId="dashboardItem.Id"
                         style="height: calc(100vh - 200px);">
                <DxBackendOptions RequestHttpHeaders="@headers" />
            </DxDashboard>
        </DxSplitterPane>
    </Panes>
</DxSplitter>

<DxPopup @bind-Visible="isDeletePopupVisible"
         ShowCloseButton="true"
         Width="400px"
         CloseOnOutsideClick="true"
         HeaderText="Confirm Delete">
    <div>
        Are you sure you want to delete the dashboard "<b>@dashboardToDelete?.DisplayName</b>"?
    </div>
    <div style="margin-top: 20px; text-align: right;">
        <DxButton Text="Yes" CssClass="btn btn-danger" Click="ConfirmDelete" Style="margin-right: 10px;" />
        <DxButton Text="No" Click="CancelDelete" CssClass="btn btn-secondary" />
    </div>
</DxPopup>

@code {
    string SearchText { get; set; }
    ListSearchTextParseMode SearchTextParseMode { get; set; } = ListSearchTextParseMode.GroupWordsByAnd;
    string endpoint = "api/dashboard";
    WorkingMode workingMode = WorkingMode.Viewer;
    public string DashboardIdValue { get; set; } = "dashboard2";
    DashboardItem dashboardItem = new DashboardItem();
    Dictionary<string, string> headers = new();
    long UserId = 1;
    public ApplicationUser? applicationUser { get; private set; }
    public List<DashboardItem> DashboardIds { get; set; } = new();
    bool isDeletePopupVisible = false;
    DashboardItem? dashboardToDelete = null;
    private CancellationTokenSource _cts = new();
    private List<string> _customOrder = new();

    // 🔧 Dashboard folder path
    string dashboardStoragePath = "Data/SPCDashboards";

    public void ChangeWorkingMode()
    {
        workingMode = workingMode == WorkingMode.Designer ? WorkingMode.Viewer : WorkingMode.Designer;
        DashboardIds = LoadDashboardsFromXml();
    }

    public string ButtonText => "Switch to " + (workingMode == WorkingMode.Designer ? "Viewer" : "Designer");

    protected override async Task OnInitializedAsync()
    {
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        DashboardIds = LoadDashboardsFromXml();
        dashboardItem = DashboardIds.FirstOrDefault() ?? new DashboardItem();

        HttpContextAccessor.HttpContext?.Request?.Headers.TryAdd("DashboardType", "SPC");

        headers["DashboardType"] = "SPC";
    }

    public class DashboardItem
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string? XmlData { get; set; }
    }

    public List<DashboardItem> LoadDashboardsFromXml()
    {
        var dashboards = new List<DashboardItem>();

        try
        {
            if (!Directory.Exists(dashboardStoragePath))
                Directory.CreateDirectory(dashboardStoragePath);

            foreach (var file in Directory.GetFiles(dashboardStoragePath, "*.xml"))
            {
                var dashboardId = Path.GetFileNameWithoutExtension(file);
                var dashboard = new DevExpress.DashboardCommon.Dashboard();
                dashboard.LoadFromXml(file);

                dashboards.Add(new DashboardItem
                {
                    Id = dashboardId,
                    DisplayName = dashboard.Title.Text ?? dashboardId
                });
            }

            dashboards = dashboards
                .OrderBy(d => _customOrder.Contains(d.Id) ? _customOrder.IndexOf(d.Id) : int.MaxValue)
                .ThenBy(d => d.DisplayName)
                .ToList();

            if (dashboards.Any())
                DashboardIdValue = dashboards.First().Id;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboards: {ex.Message}");
        }

        return dashboards;
    }

 

    private void PromptDelete(DashboardItem item)
    {
        dashboardToDelete = item;
        isDeletePopupVisible = true;
    }

    private void CancelDelete()
    {
        dashboardToDelete = null;
        isDeletePopupVisible = false;
    }

    private void ConfirmDelete()
    {
        try
        {
            if (dashboardToDelete != null)
            {
                string filePath = Path.Combine(dashboardStoragePath, $"{dashboardToDelete.Id}.xml");

                if (File.Exists(filePath))
                    File.Delete(filePath);

                DashboardIds = LoadDashboardsFromXml();

                if (dashboardItem?.Id == dashboardToDelete.Id)
                    dashboardItem = DashboardIds.FirstOrDefault();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting dashboard: {ex.Message}");
        }
        finally
        {
            dashboardToDelete = null;
            isDeletePopupVisible = false;
        }
    }

    public void Dispose()
    {
        dashboardToDelete = null;
        dashboardItem = null;
        DashboardIds.Clear();
        _customOrder.Clear();
        _cts.Cancel();
        _cts.Dispose();
    }

    public async ValueTask DisposeAsync()
    {
        await Task.CompletedTask;
    }
}
