
@inject IJSRuntime jsRuntime
@page "/EmailTransferList"
@using Application.Commands;
@using Application.Queries;
@using Application.Response;
@using MediatR
@using global::Core.Entities;
@inject IMediator Mediator
@using DevExpress.Export
@using global::Core.Entities.Views
@using global::Core.Repositories.Query;
@implements IAsyncDisposable

<div class="card-body">
    <div class="row">
        <div class="col-md-12">
            <DxFormLayout>
                <DxFormLayoutItem Caption="From User" ColSpanMd="6">
                    <DxComboBox Data="@_usersFromList"
                                NullText="Select From User..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.AutoSearch"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                ValueFieldName="UserID"
                                TextFieldName="FirstName"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                Value="@CurrentFromUser"
                                ValueExpression="@(() => CurrentFromUser )"
                                ValueChanged="@((ViewEmployee soCustomer) => onSelectedUserItemsChanged(soCustomer))"
                                ShowValidationIcon="true">
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.FirstName)" Caption="FirstName" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.LastName)" Caption="Last Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.StatusName)" Caption="Status" />
                    </DxComboBox>
                </DxFormLayoutItem>
               @*  <DxFormLayoutItem Caption="To User" ColSpanMd="6">
                    <DxComboBox Data="@_usersToList"
                                NullText="Select To User..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.AutoSearch"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                ValueFieldName="UserID"
                                TextFieldName="FirstName"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                Value="@CurrentToUser"
                                ValueExpression="@(() => CurrentToUser )"
                                ValueChanged="@((ViewEmployee soCustomer) => onSelectedUserToItemsChanged(soCustomer))"
                                ShowValidationIcon="true">
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.FirstName)" Caption="FirstName" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.LastName)" Caption="Last Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.StatusName)" Caption="Status" />
                    </DxComboBox>
                </DxFormLayoutItem> *@
            </DxFormLayout>
            <div class="col-md-12">
                <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                    <div class="cw-480 ch-220" style="margin-top:10px;">
                        <DxLoadingPanel @bind-Visible="PanelVisible"
                                        IsContentBlocked="true"
                                        ApplyBackgroundShading="true"
                                        IndicatorAreaVisible="false"
                                        Text="Fetching Data...">

                            <DxGrid @ref="Grid" Data="@_EmailTransferItems" EditMode="GridEditMode.EditForm" ShowGroupPanel="true" ShowGroupedColumns="true" ShowSearchBox="true"
                                    PagerNavigationMode="PagerNavigationMode.InputBox" PageSizeSelectorVisible="true"
                                    @bind-SelectedDataItems="@SelectedDataItems"
                                    FocusedRowEnabled="true"
                                    ColumnResizeMode="GridColumnResizeMode.NextColumn"
                                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                    PageSizeSelectorAllRowsItemVisible="true"
                                    PageSizeSelectorItems="@(new int[] { 5,10,20 })"
                                    PageSize="20" CustomizeElement="Grid_CustomizeElement"
                                    style="height: calc(100vh - 200px);"
                                    CssClass="ch-360"
                                    AutoExpandAllGroupRows="true"
                                    SelectionMode="GridSelectionMode.Multiple"
                                    SelectAllCheckboxMode="GridSelectAllCheckboxMode.AllPages">
                                <Columns>
                                    <DxGridSelectionColumn Width="60px" AllowSelectAll="true" />
                                    <DxGridDataColumn FieldName="FromName" Caption="From" />
                                    <DxGridDataColumn FieldName="ToName" Caption="To" />
                                    <DxGridDataColumn FieldName="TopicName" />
                                    <DxGridDataColumn FieldName="TransferBy" />
                                    <DxGridDataColumn Caption="Transfer Date" FieldName="AddedDate" MinWidth="180">
                                        <CellDisplayTemplate>
                                            @{
                                                var item = (TransferEmailHistory)context.DataItem;
                                            }
                                            @Application.Common.Helper.Helper.FormatDateTime(item.AddedDate)
                                        </CellDisplayTemplate>
                                    </DxGridDataColumn>
                                </Columns>

                            </DxGrid>
                        </DxLoadingPanel>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@* <div class="card w-100" style="margin-bottom:10px;">
    <div class="card-body p-0">
        <DxMenu CollapseItemsToHamburgerMenu="true"
                CollapseItemToIconMode="MenuCollapseItemToIconMode.Sequentially"
                DisplayMode="MenuDisplayMode.Desktop">
            <Items>
                <DxMenuItem Text="Export" IconCssClass="fa fa-file-excel" Click="@ExportToExcel" />
            </Items>
        </DxMenu>
    </div>
</div> *@

@code {
    ViewEmployee CurrentFromUser { get; set; }
    ViewEmployee CurrentToUser { get; set; }
    IReadOnlyList<object> SelectedDataItems { get; set; }
    bool PanelVisible { get; set; }
    private List<TransferEmailHistory> _EmailTransferItems;
    IGrid Grid { get; set; }
    private List<ViewEmployee> _usersFromList { get; set; }
    private List<ViewEmployee> _usersToList { get; set; }
    //object MasterGridData { get; set; }
    //object DetailGridData { get; set; }
    protected override async Task OnInitializedAsync()
    {
        PanelVisible = true;
       
        var usersList = await Mediator.Send(new GetAllUserWithoutStatusQuery());
        var tolist = await Mediator.Send(new GetAllEmployeeListQuery());
        _usersFromList = new List<ViewEmployee>();
        _usersFromList = usersList;
        _usersToList = new List<ViewEmployee>();
        _usersToList = tolist;
        PanelVisible = false;
       // await UpdateDataAsync();
    }
    async Task onSelectedUserItemsChanged(ViewEmployee viewEmployee)
    {
      
        CurrentFromUser = viewEmployee;
       
        if (viewEmployee != null && viewEmployee.UserID > 0)
        {
            var model = await Mediator.Send(new GetAllEmailHistoryQuery(viewEmployee.UserID.Value));

            _EmailTransferItems = model;
        }
       
        StateHasChanged();
        
    }
    // async Task onSelectedUserToItemsChanged(ViewEmployee viewEmployees)
    // {
       
    //     CurrentToUser = viewEmployees;
      
    //     long? toUserIds = -1;
    //     if (viewEmployees != null && viewEmployees.UserID > 0)
    //     {
    //         toUserIds = viewEmployees.UserID;
    //         _usersFromList = _usersList.Where(w => w.UserID != viewEmployees.UserID).ToList();
    //     }
    //     else
    //     {
    //         _usersFromList = _usersList;
    //     }
       
    //     StateHasChanged();
    //     await loadTabDatas();
    // }
    void Grid_CustomizeElement(GridCustomizeElementEventArgs e)
    {
        if (e.ElementType == GridElementType.DataRow && e.VisibleIndex % 2 == 1)
        {
            e.CssClass = "alt-item";
        }
        
    }
    async Task ExportToExcel()

    {
        if (SelectedDataItems != null)
        {

            await Grid.ExportToXlsxAsync("ExportResult", new GridXlExportOptions()
                {

                    ExportSelectedRowsOnly = true,
                    CustomizeCell = OnCustomizeCell

                });
        }
        else
        {
            await Grid.ExportToXlsxAsync("ExportResult", new GridXlExportOptions()
                {

                    ExportSelectedRowsOnly = false,
                    CustomizeCell = OnCustomizeCell

                });
        }

    }


    void OnCustomizeCell(GridExportCustomizeCellEventArgs args)
    {
        if (args.ColumnFieldName == "ContactName" && args.AreaType == SheetAreaType.DataArea)
            args.Formatting.Font = new XlCellFont() { Italic = true };
        args.Handled = true;



    }
    public async ValueTask DisposeAsync()
    {
        if (_EmailTransferItems != null)
        {
            _EmailTransferItems.Clear();
            _EmailTransferItems = null;
        }

        SelectedDataItems = null;

    }
}
