@page "/TransferPermissions"
@using global::Core.Entities.Views;
@using global::Core.Entities;
@using Application.Queries;
@using MediatR
@inject IMediator Mediator
@using global::Core.EntityModels;
@implements IAsyncDisposable


<div class="card-body">
    <div class="row">
        <div class="col-md-12">
            <DxFormLayout>
                <DxFormLayoutItem Caption="From User" ColSpanMd="6">
                    <DxComboBox Data="@_usersFromList"
                                NullText="Select From User..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.AutoSearch"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                ValueFieldName="UserID"
                                TextFieldName="FirstName"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                Value="@CurrentFromUser"
                                ValueExpression="@(() => CurrentFromUser )"
                                ValueChanged="@((ViewEmployee soCustomer) => onSelectedUserItemsChanged(soCustomer))"
                                ShowValidationIcon="true">
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.FirstName)" Caption="FirstName" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.LastName)" Caption="Last Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.StatusName)" Caption="Status" />
                    </DxComboBox>
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="To User" ColSpanMd="6">
                    <DxComboBox Data="@_usersToList"
                                NullText="Select To User..."
                                ListRenderMode="ListRenderMode.Virtual"
                                SearchMode="ListSearchMode.AutoSearch"
                                SearchFilterCondition="ListSearchFilterCondition.Contains"
                                ValueFieldName="UserID"
                                TextFieldName="FirstName"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                Value="@CurrentToUser"
                                ValueExpression="@(() => CurrentToUser )"
                                ValueChanged="@((ViewEmployee soCustomer) => onSelectedUserToItemsChanged(soCustomer))"
                                ShowValidationIcon="true">
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.FirstName)" Caption="FirstName" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.LastName)" Caption="Last Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.StatusName)" Caption="Status" />
                    </DxComboBox>
                </DxFormLayoutItem>
            </DxFormLayout>
            <div class="col-md-12">
                <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                    <div class="cw-480 ch-220" style="margin-top:10px;">
                        <DxFormLayout CssClass="w-100">
                            <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick="OnTabClick">
                                <DxFormLayoutTabPage Caption="User Groups">
                                    <TransferUserGroups @ref="refResetUserGroups" Data="@Data"></TransferUserGroups>
                                </DxFormLayoutTabPage>
                                <DxFormLayoutTabPage Caption="File Profile Type Security">
                                    <TransferPermissionDocumentUserRole @ref="refTransferPermissionDocumentUserRole" Data="@Data"></TransferPermissionDocumentUserRole>
                                </DxFormLayoutTabPage>
                                <DxFormLayoutTabPage Caption="Email Conversations">
                                    <TransferPermissionsEmailConversationParticipant @ref="refTransferPermissionsEmailConversationParticipant" Data="@Data"></TransferPermissionsEmailConversationParticipant>
                                </DxFormLayoutTabPage>
                               @*  <DxFormLayoutTabPage Caption="Dynamic Form Master">
                                    <DynamicFormTransferTab @ref="refDynamicFormTransferTab" Data="@Data"></DynamicFormTransferTab>
                                </DxFormLayoutTabPage>
                                <DxFormLayoutTabPage Caption="Dynamic Form Data">
                                    <DynamicFormDataTransferTab @ref="refDynamicFormDataTransferTab" Data="@Data"></DynamicFormDataTransferTab>
                                </DxFormLayoutTabPage> *@
                            </DxFormLayoutTabPages>
                        </DxFormLayout>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@code {
    ViewEmployee CurrentFromUser { get; set; }
    ViewEmployee CurrentToUser { get; set; }
    private TransferUserGroups refResetUserGroups;
    private DynamicFormTransferTab refDynamicFormTransferTab;
    private DynamicFormDataTransferTab refDynamicFormDataTransferTab;
    private TransferPermissionDocumentUserRole refTransferPermissionDocumentUserRole;
    private TransferPermissionsEmailConversationParticipant refTransferPermissionsEmailConversationParticipant;
    private List<ViewEmployee> _usersList { get; set; }
    private List<ViewEmployee> _userList { get; set; }
    private List<ViewEmployee> _usersFromList { get; set; }
    private List<ViewEmployee> _usersToList { get; set; }
    ResetPermissionModel Data = new ResetPermissionModel();
    long? UserIds { get; set; }
    int tabIndex { get; set; } = 0;
    int ActiveSubTabIndex { get; set; } = 0;
    protected override async Task OnInitializedAsync()
    {
        var usersList = await Mediator.Send(new GetAllUserWithoutStatusQuery());
        var tolist = await Mediator.Send(new GetAllEmployeeListQuery());
        _usersFromList = new List<ViewEmployee>();
        _usersFromList = usersList;
        _usersToList = new List<ViewEmployee>();
        _usersToList = tolist;
        _usersList = new List<ViewEmployee>();
        _usersList = usersList;
        _userList = new List<ViewEmployee>();
        _userList = tolist;
        StateHasChanged();
    }
    async Task onSelectedUserItemsChanged(ViewEmployee viewEmployee)
    {
        Data.FromUserId = null;
        CurrentFromUser = viewEmployee;
        UserIds = -1;
        if (viewEmployee != null && viewEmployee.UserID > 0)
        {
            UserIds = viewEmployee.UserID;
            _usersToList = _userList.Where(w => w.UserID != viewEmployee.UserID).ToList();
        }
        else
        {
            _usersToList = _userList;
        }
        Data.FromUserId = viewEmployee != null ? UserIds : null;
        StateHasChanged();
        await loadTabDatas();
    }
    async Task onSelectedUserToItemsChanged(ViewEmployee viewEmployees)
    {
        Data.ToUserId = null;
        CurrentToUser = viewEmployees;
        ActiveSubTabIndex = 0;
        long? toUserIds = -1;
        if (viewEmployees != null && viewEmployees.UserID > 0)
        {
            toUserIds = viewEmployees.UserID;
            _usersFromList = _usersList.Where(w => w.UserID != viewEmployees.UserID).ToList();
        }
        else
        {
            _usersFromList = _usersList;
        }
        Data.ToUserId = viewEmployees != null ? toUserIds : null;
        StateHasChanged();
        await loadTabDatas();
    }
    async Task loadTabDatas()
    {
        if (tabIndex == 0)
        {
            ActiveSubTabIndex = tabIndex;
            await refResetUserGroups.loadUserGroupData(Data);
        }
        if (tabIndex == 1)
        {
            ActiveSubTabIndex = tabIndex;
            await refTransferPermissionDocumentUserRole.loadDocumentUserRoles(Data);
        }
        if (tabIndex == 2)
        {
            ActiveSubTabIndex = tabIndex;
            await refTransferPermissionsEmailConversationParticipant.loadEmailConversations(Data);
        }
        if (tabIndex == 3)
        {
            ActiveSubTabIndex = tabIndex;
            await refDynamicFormTransferTab.loadDynamicFormData(Data);
        }
        if (tabIndex == 4)
        {
            ActiveSubTabIndex = tabIndex;
            await refDynamicFormDataTransferTab.loadDynamicFormDataForm(Data);
        }
    }
    void OnTabClick(TabClickEventArgs e)
    {
        tabIndex = e.TabIndex;

    }
    public async ValueTask DisposeAsync()
    {
        if (_usersFromList != null)
        {
            _usersFromList.Clear();
            _usersFromList = null;
        }
        if (_usersToList != null)
        {
            _usersToList.Clear();
            _usersToList = null;
        }
        if (_usersList != null)
        {
            _usersList.Clear();
            _usersList = null;

        }
        if(_userList != null)
        {
            _userList.Clear();
            _userList = null;
        }
        CurrentToUser = null;
        CurrentFromUser = null;
        Data = null;
        refResetUserGroups?.DisposeAsync();
        refTransferPermissionDocumentUserRole?.DisposeAsync();
        refTransferPermissionsEmailConversationParticipant?.DisposeAsync();
        refDynamicFormTransferTab?.DisposeAsync();
    }
}
