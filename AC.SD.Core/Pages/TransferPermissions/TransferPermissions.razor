@page "/TransferPermissions"
@using global::Core.Entities.Views;
@using global::Core.Entities;
@using Application.Queries;
@using MediatR
@inject IMediator Mediator
@using global::Core.EntityModels;


<div class="card-body">
    <div class="row">
        <div class="col-md-12">
            <DxFormLayout>
                <DxFormLayoutItem Caption="From User" ColSpanMd="6">
                    <DxComboBox Data="@_usersFromList"
                                NullText="Select From User..."
                                ListRenderMode="ListRenderMode.Virtual"
                                FilteringMode="DataGridFilteringMode.Contains"
                                ValueFieldName="UserID"
                                TextFieldName="FirstName"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                SelectedItemChanged="@((ViewEmployee soCustomer) => onSelectedUserItemsChanged(soCustomer))"
                    @bind-Value="@Data.FromUserId" ShowValidationIcon="true">
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.FirstName)" Caption="FirstName" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.LastName)" Caption="Last Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.StatusName)" Caption="Status" />
                    </DxComboBox>
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="To User" ColSpanMd="6">
                    <DxComboBox Data="@_usersToList"
                                NullText="Select To User..."
                                ListRenderMode="ListRenderMode.Virtual"
                                FilteringMode="DataGridFilteringMode.Contains"
                                ValueFieldName="UserID"
                                TextFieldName="FirstName"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                SelectedItemChanged="@((ViewEmployee soCustomer) => onSelectedUserToItemsChanged(soCustomer))"
                    @bind-Value="@Data.ToUserId" ShowValidationIcon="true">
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.FirstName)" Caption="FirstName" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.LastName)" Caption="Last Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.NickName)" Caption="Nick Name" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.DesignationName)" Caption="Designation" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.CompanyName)" Caption="Company" />
                        <DxListEditorColumn FieldName="@nameof(ViewEmployee.StatusName)" Caption="Status" />
                    </DxComboBox>
                </DxFormLayoutItem>
            </DxFormLayout>
            <div class="col-md-12">
                <div class="row align-items-end" style="border-top: 1px solid #d5d4d4; margin-top:10px;">
                    <div class="cw-480 ch-220" style="margin-top:10px;">
                        <DxFormLayout CssClass="w-100">
                            <DxFormLayoutTabPages @bind-ActiveTabIndex="@ActiveSubTabIndex" RenderMode="TabsRenderMode.Default" TabClick="OnTabClick">
                                <DxFormLayoutTabPage Caption="User Groups">
                                    <TransferUserGroups @ref="refResetUserGroups" Data="@Data"></TransferUserGroups>
                                </DxFormLayoutTabPage>
                                <DxFormLayoutTabPage Caption="File Profile Type Security">
                                    <TransferPermissionDocumentUserRole Data="@Data"></TransferPermissionDocumentUserRole>
                                </DxFormLayoutTabPage>
                                <DxFormLayoutTabPage Caption="Email Conversations">
                                    <TransferPermissionsEmailConversationParticipant Data="@Data"></TransferPermissionsEmailConversationParticipant>
                                </DxFormLayoutTabPage>
                            </DxFormLayoutTabPages>
                        </DxFormLayout>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@code {
    private TransferUserGroups refResetUserGroups;
    private List<ViewEmployee> _usersList { get; set; }
    private List<ViewEmployee> _usersFromList { get; set; }
    private List<ViewEmployee> _usersToList { get; set; }
    ResetPermissionModel Data = new ResetPermissionModel();
    long? UserIds { get; set; }
    int? tabIndex { get; set; }
    int ActiveSubTabIndex { get; set; } = 0;
    protected override async Task OnInitializedAsync()
    {
        var usersList = await Mediator.Send(new GetAllUserWithoutStatusQuery());
        _usersFromList = new List<ViewEmployee>();
        _usersFromList = usersList;
        _usersToList = new List<ViewEmployee>();
        _usersToList = usersList;
        _usersList = new List<ViewEmployee>();
        _usersList = usersList;
        StateHasChanged();
    }
    async Task onSelectedUserItemsChanged(ViewEmployee viewEmployee)
    {
        ActiveSubTabIndex = 0;
        UserIds = -1;
        if (viewEmployee != null && viewEmployee.UserID > 0)
        {
            UserIds = viewEmployee.UserID;
            _usersToList = _usersList.Where(w => w.UserID != viewEmployee.UserID).ToList();
        }
        else
        {
            _usersFromList = _usersList;
        }
        Data.FromUserId = UserIds;
        StateHasChanged();
        await refResetUserGroups.loadUserGroupData(Data);


    }
    async Task onSelectedUserToItemsChanged(ViewEmployee viewEmployees)
    {
        ActiveSubTabIndex = 0;
        long? toUserIds = -1;
        if (viewEmployees != null && viewEmployees.UserID > 0)
        {
            toUserIds = viewEmployees.UserID;
            _usersFromList = _usersList.Where(w => w.UserID != viewEmployees.UserID).ToList();
        }
        else
        {
            _usersFromList = _usersList;
        }
        Data.ToUserId = toUserIds;
        StateHasChanged();
        await refResetUserGroups.loadUserGroupData(Data);
    }
    async Task OnTabClick(TabClickEventArgs e)
    {
         tabIndex = e.TabIndex;
        // if (tabIndex == 0)
        // {
        //     await refResetUserGroups.loadUserGroupData(Data);
        //     StateHasChanged();
        // }
    }
}
