@using global::Core.EntityModels;
@inject NavigationManager NavigationManager
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@inject IMediator Mediator
@using global::Core.Repositories.Query;
@inject ILocalStorageService<ApplicationUser> _localStorageService;


<DxTreeView @ref="treeView"
@bind-FilterString="FilterString"
            FilterMinLength="2"
            ShowFilterPanel="true"
            Target="_blank"
            FilterMode="NavigationFilterMode.EntireBranch"
            Data="@portalMenuModel"
            ExpandButtonIconCssClass="demo-icon-expand"
            CollapseButtonIconCssClass="demo-icon-collapse"
            AllowSelectNodes="true"
            SelectionChanged="@SelectionChanged">
    <DataMappings>
        <DxTreeViewDataMapping Text="Title"
                               Key="PermissionID"
                               ParentKey="ParentID" />
    </DataMappings>
</DxTreeView>


@code {

    private DxTreeView treeView;
    private string previousUri;
    string? FilterString { get; set; }
    public List<PortalMenuModel> portalMenuModel { get; set; }
    public ApplicationUser applicationUser { get; private set; }
    int count = 0;
    int scount = 0;
    string segmentcurrentUri = "";
    protected override async Task OnParametersSetAsync()
    {
        previousUri = NavigationManager.Uri;
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        if(applicationUser != null)
        {
            portalMenuModel = await Mediator.Send(new GetAllApplicationPermissionAllQuery(applicationUser.UserID));
        }
        
        NavigationManager.LocationChanged += OnLocationChanged;

    }
    
    void OnLocationChanged(object sender, LocationChangedEventArgs args)
    {    
        var currentUri = NavigationManager.Uri;
        // var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        //var queryParameters = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        // Check if the URL has changed
        if (currentUri != previousUri)
        {
            previousUri = currentUri; // Update the previous URL
            //UpdateSelection(currentUri, true);
            //StateHasChanged();
        }

        previousUri = currentUri;       
        
    }
    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
         //if (firstRender == true && count == 0)
         //{
         //    UpdateSelection(NavigationManager.Uri, true);
         //}
         //count++;
    }
    void UpdateSelection(string currentUri, bool expandNodesToSelection)
    {
        string uri = NavigationManager.Uri;
        string baseUri = NavigationManager.BaseUri;
        treeView.SelectNode(n =>
        {
            var dataItem = n.DataItem as PortalMenuModel;
            string rep1 = uri.Replace(baseUri, "").ToLower();
            string[] UrlList = rep1.Split("/");
            if (dataItem != null && UrlList.Length > 0 && UrlList[0] != null && dataItem.Component != null && dataItem.Component.ToLower() == UrlList[0])
            {
                if (expandNodesToSelection)
                    ExpandToSelectedNode(n);
                return true;
            }
            return false;
        });
    }
    public void LoadUpdateSelection(string currentUri, bool expandNodesToSelection)
    {
        string uri = NavigationManager.Uri;
        string baseUri = NavigationManager.BaseUri;
        treeView.SelectNode(n =>
        {
            var dataItem = n.DataItem as PortalMenuModel;
            string rep1 = uri.Replace(baseUri, "").ToLower();
            string[] UrlList = rep1.Split("/");
            if (dataItem != null && UrlList.Length > 0 && UrlList[0] != null && dataItem.Component != null && dataItem.Component.ToLower() == UrlList[0])
            {
                if (expandNodesToSelection)
                    ExpandToSelectedNode(n);
                return true;
            }
            return false;
        });
        
    }
    void ExpandToSelectedNode(ITreeViewNodeInfo selectedNode)
    {
        var nodes = treeView.GetNodesInfo(n => true);
        foreach (var node in nodes)
        {
            treeView.SetNodeExpanded(n => n == node, IsParentNode(node, selectedNode));
        }
    }
    bool IsParentNode(ITreeViewNodeInfo parentNode, ITreeViewNodeInfo node)
    {
        while (node != null)
        {
            if (node == parentNode)
                return true;
            node = node.Parent;
        }
        return false;
    }
    protected void SelectionChanged(TreeViewNodeEventArgs e)
    {
        if (e.NodeInfo?.DataItem != null)
        {
            var dataItem = e.NodeInfo.DataItem as PortalMenuModel;
            if (dataItem != null && dataItem.Component != null || dataItem.Name != null)
            {
                var url = dataItem.Name;
                // if (dataItem.Component.ToLower() != dataItem.Name.ToLower())
                // {
                //     url = dataItem.Component + "/" + dataItem.Name;
                // }
                if (url != null)
                {
                    NavigationManager.NavigateTo(url);
                }
            }
            var nodes = treeView.GetNodesInfo(n => true);
            foreach (var node in nodes)
            {
                treeView.SetNodeExpanded(n => n == node, IsParentNode(node, e.NodeInfo));
            }
        }
    }
}
