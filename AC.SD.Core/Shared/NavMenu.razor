@using DevExpress.Blazor.DocumentMetadata
@using global::Core.EntityModels;
@inject NavigationManager NavigationManager
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@inject IMediator Mediator
@using global::Core.Repositories.Query;
@inject ILocalStorageService<ApplicationUser> _localStorageService;
@rendermode @(new  InteractiveServerRenderMode(prerender: false))


@* <DxTreeView @ref="treeView"
            @bind-FilterString="FilterString"
            FilterMinLength="2"
            ShowFilterPanel="true"
            Target="_blank"
            style="height:calc(100vh - 69px)"
            FilterMode="NavigationFilterMode.EntireBranch"
            Data="@portalMenuModel"
            ExpandButtonIconCssClass="demo-icon-expand"
            CollapseButtonIconCssClass="demo-icon-collapse"
            AllowSelectNodes="true"
            SelectionChanged="@SelectionChanged">
    <DataMappings>
        <DxTreeViewDataMapping Text="Title"
                               Key="PermissionID"
                               ParentKey="ParentID" />
    </DataMappings>
</DxTreeView> *@

<DxLoadingPanel @bind-Visible="indicatorVisible"
                IndicatorAnimationType="WaitIndicatorAnimationType.Pulse"
                IndicatorVisible="indicatorVisible"
                IndicatorAreaVisible="indicatorAreaVisible"
                ApplyBackgroundShading="true"
                TextAlignment="LoadingPanelTextAlignment.Right"
                Text="Fetching Menus...">
    <DxTreeView @ref="menutreeView"
                @bind-FilterString="@FilterString"
                FilterMinLength="2"
                style="height:calc(100vh - 69px)"
                CssClass="sidebar-tree"
                ShowFilterPanel="true"
                Target="_blank"
                FilterMode="NavigationFilterMode.EntireBranch"
                Data="@portalMenuModel"
                ExpandButtonIconCssClass="demo-icon-expand"
                CollapseButtonIconCssClass="demo-icon-collapse"
                AllowSelectNodes="true"
                SelectionChanged="@SelectionChanged">
        <DataMappings>
            <DxTreeViewDataMapping Text="Title"
                                   Key="PermissionID"
                                   ParentKey="ParentID" />
        </DataMappings>
    </DxTreeView>
</DxLoadingPanel>


@code {
    bool indicatorVisible { get; set; }
    bool indicatorAreaVisible { get; set; } = true;
    private DxTreeView menutreeView;
    public string componentName { get; set; } = "";
    private string? lastLocation;

    internal DxTreeView treeView;
    internal string previousUri;
    string? FilterString { get; set; }
    public List<PortalMenuModel> portalMenuModel { get; set; }
    public ApplicationUser applicationUser { get; private set; }
    int count = 0;
    int scount = 0;
    string segmentcurrentUri = "";
    protected override void OnInitialized()
    {
        lastLocation = NavigationManager.Uri;
        NavigationManager.LocationChanged += HandleLocationChanged;
        StateHasChanged();
        base.OnInitialized();
    }
    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        //Logger.LogInformation("URL of new location: {Location}", e.Location);
    }
    protected override async Task OnParametersSetAsync()
    {
        previousUri = NavigationManager.Uri;
        applicationUser = await _localStorageService.GetItem<ApplicationUser>("user");
        if (applicationUser != null)
        {
            portalMenuModel = await Mediator.Send(new GetAllApplicationPermissionAllQuery(applicationUser.UserID));
            if (portalMenuModel?.Any() == true)
            {
                portalMenuModel = portalMenuModel.Where(w => w.IsPermissionForm != true).ToList();
            }
        }

        UpdateSelection(); 
        base.OnParametersSet();


        NavigationManager.LocationChanged += OnLocationChanged;
        await InvokeAsync(StateHasChanged);
    }
    void UpdateSelection()
    {
        var pageName = NavigationManager.GetCurrentPageName().Split('?')[0];
        if (menutreeView != null && !string.IsNullOrEmpty(pageName))
        {
            if (portalMenuModel != null)
            {

                var menu = portalMenuModel.Where(f => f.Name == pageName).FirstOrDefault();

                if (menu != null && !string.IsNullOrEmpty(menu.Title))
                {
                    if (!string.IsNullOrEmpty(componentName))
                    {
                        menutreeView.SelectNode((n) => n.Text == menu.Title);
                        menutreeView.ExpandToNode((n) => n.Text == menu.Title);
                    }
                }
            }
        }
    }
     void OnLocationChanged(object sender, LocationChangedEventArgs args)
    {
        if (args.Location == lastLocation) return; // Ignore redundant navigation
        lastLocation = args.Location;

        UpdateSelection();
    }
    async void OnLocationChangedold(object? sender, LocationChangedEventArgs args)
    {
        var currentUri = NavigationManager.Uri;
        // var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        //var queryParameters = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        // Check if the URL has changed
        if (currentUri != previousUri)
        {
            previousUri = currentUri; // Update the previous URL
                                      //UpdateSelection(currentUri, true);
                                      //StateHasChanged();
        }

        previousUri = currentUri;

        //StateHasChanged();
        await InvokeAsync(StateHasChanged);
    }
    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
    void UpdateSelection(string currentUri, bool expandNodesToSelection)
    {

        var pageName = NavigationManager.GetCurrentPageName().Split('?')[0];
        if (menutreeView != null && !string.IsNullOrEmpty(pageName))
        {
            if (portalMenuModel != null)
            {

                var menu = portalMenuModel.Where(f => f.Name == pageName).FirstOrDefault();

                if (menu != null && !string.IsNullOrEmpty(menu.Title))
                {
                    if (!string.IsNullOrEmpty(componentName))
                    {
                        menutreeView.SelectNode((n) => n.Text == menu.Title);
                        menutreeView.ExpandToNode((n) => n.Text == menu.Title);
                    }
                }
            }
        }




        // string uri = NavigationManager.Uri;
        // string baseUri = NavigationManager.BaseUri;
        // treeView.SelectNode(n =>
        // {
        //     var dataItem = n.DataItem as PortalMenuModel;
        //     string rep1 = uri.Replace(baseUri, "").ToLower();
        //     string[] UrlList = rep1.Split("/");
        //     if (dataItem != null && UrlList.Length > 0 && UrlList[0] != null && dataItem.Component != null && dataItem.Component.ToLower() == UrlList[0])
        //     {
        //         if (expandNodesToSelection)
        //             ExpandToSelectedNode(n);
        //         return true;
        //     }
        //     return false;
        // });
    }
    public void LoadUpdateSelection(string currentUri, bool expandNodesToSelection)
    {
        string uri = NavigationManager.Uri;
        string baseUri = NavigationManager.BaseUri;
        treeView.SelectNode(n =>
        {
            var dataItem = n.DataItem as PortalMenuModel;
            string rep1 = uri.Replace(baseUri, "").ToLower();
            string[] UrlList = rep1.Split("/");
            if (dataItem != null && UrlList.Length > 0 && UrlList[0] != null && dataItem.Component != null && dataItem.Component.ToLower() == UrlList[0])
            {
                if (expandNodesToSelection)
                    ExpandToSelectedNode(n);
                return true;
            }
            return false;
        });

    }
    void ExpandToSelectedNode(ITreeViewNodeInfo selectedNode)
    {
        var nodes = treeView.GetNodesInfo(n => true);
        foreach (var node in nodes)
        {
            treeView.SetNodeExpanded(n => n == node, IsParentNode(node, selectedNode));
        }
    }
    bool IsParentNode(ITreeViewNodeInfo parentNode, ITreeViewNodeInfo node)
    {
        while (node != null)
        {
            if (node == parentNode)
                return true;
            node = node.Parent;
        }
        return false;
    }
    protected void SelectionChanged(TreeViewNodeEventArgs e)
    {

        if (e.NodeInfo?.DataItem != null)
        {
            var dataItem = e.NodeInfo.DataItem as PortalMenuModel;
            componentName = dataItem.Name;
            if (dataItem != null && dataItem.Name != null)
            {              
                var isPermissionURL = dataItem.IsPermissionURL;
                var url = dataItem.Name;

                if (url != null)
                {
                    if (isPermissionURL)
                    {
                        NavigationManager.NavigateTo($"{url}/{dataItem.UniqueSessionID}");
                    }
                    else
                    {
                        if (dataItem.ParentID == 60248)
                        {
                            var urls = $"{url}/{dataItem.Component}/{dataItem.PermissionURL}";
                            NavigationManager.NavigateTo(urls);
                        }
                        else
                        {
                            NavigationManager.NavigateTo($"{url}");
                        }
                    }
                }
            }
            var nodes = menutreeView.GetNodesInfo(n => true);
            foreach (var node in nodes)
            {
                menutreeView.SetNodeExpanded(n => n == node, IsParentNode(node, e.NodeInfo));
            }
        }


        // if (e.NodeInfo?.DataItem != null)
        // {
        //     var dataItem = e.NodeInfo.DataItem as PortalMenuModel;
        //     if (dataItem != null && dataItem.Component != null || dataItem.Name != null)
        //     {
        //         var isPermissionURL = dataItem.IsPermissionURL;
        //         var url = dataItem.Name;
        //         if (url != null)
        //         {
        //             if (isPermissionURL)
        //             {
        //                 NavigationManager.NavigateTo($"{url}/{dataItem.UniqueSessionID}");
        //             }
        //             else
        //             {
        //                 if (dataItem.ParentID == 60248)
        //                 {
        //                     var urls = $"{url}/{dataItem.Component}/{dataItem.PermissionURL}";
        //                     NavigationManager.NavigateTo(urls);
        //                 }
        //                 else
        //                 {
        //                     NavigationManager.NavigateTo($"{url}");
        //                 }
        //             }
        //         }

        //     }
        //     var nodes = treeView.GetNodesInfo(n => true);
        //     foreach (var node in nodes)
        //     {
        //         treeView.SetNodeExpanded(n => n == node, IsParentNode(node, e.NodeInfo));
        //     }
        // }

        StateHasChanged();
    }
}
