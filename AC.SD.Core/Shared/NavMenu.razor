@using AC.SD.Core.Configuration
@using global::Core.EntityModels;
@inject DemoConfiguration Configuration
@inject NavigationManager NavigationManager
@using Application.Queries;
@using MediatR
@using global::Core.Entities;
@inject IMediator Mediator
@using DevExpress.Export
@inject IJSRuntime Js;
@using global::Core.Entities.Views;
@functions {
    async Task<List<PortalMenuModel>> NavMenuLists()
    {
        return await Configuration.DoNavMenuListsItemsAsync();
    }
    public List<PortalMenuModel>  listsItemss()
    {
        return Configuration.DoNavMenuLists();
    }
}
@{
    
    //var lists = Task.Run(async () => await NavMenuLists()).GetAwaiter().GetResult();
    var lists = listsItemss();
    var siteMode = Configuration.GetConfigurationValue<bool>("SiteMode");
    
}

<DxTreeView @ref="@treeView"
            CssClass="sidebar-tree"
            ExpandButtonIconCssClass="demo-icon-expand"
            CollapseButtonIconCssClass="demo-icon-collapse"
            AllowSelectNodes="true"
            SelectionChanged="@SelectionChanged">
    <Nodes>
        @foreach (var demoPage in lists)
        {
           
                <NavMenuLeaf Page="@demoPage"></NavMenuLeaf>
           
        }
    </Nodes>
</DxTreeView>
@code {
    DxTreeView treeView;

    //[Parameter]
    //public IEnumerable<PortalMenuModel> Pagess { get; set; }
    //public IEnumerable<DemoPageBase> Pages { get; set; }
    public List<PortalMenuModel> portalMenuModel { get; set; }
    [Parameter]
    public PortalMenuPermission portalMenuModels { get; set; }

    protected override async Task OnInitializedAsync()
    {
        this.StateHasChanged();
    }
    protected override void OnInitialized() {
        
        NavigationManager.LocationChanged += OnLocationChanged;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        UpdateSelection(NavigationManager.Uri, true);
        this.StateHasChanged();
    }
    void OnLocationChanged(object sender, LocationChangedEventArgs args) {
        UpdateSelection(NavigationManager.Uri, true);
    }
    void UpdateSelection(string currentUri, bool expandNodesToSelection) {
        treeView.SelectNode(n => {
            if(!string.IsNullOrEmpty(n.NavigateUrl) && (currentUri.EndsWith("/" + n.NavigateUrl) || currentUri == NavigationManager.BaseUri && n.NavigateUrl == "./")) {
                if(expandNodesToSelection)
                    ExpandToSelectedNode(n);
                return true;
            }
            return false;
        });
    }
    void ExpandToSelectedNode(ITreeViewNodeInfo selectedNode) {
        var nodes = treeView.GetNodesInfo(n => true);
        foreach(var node in nodes) {
            treeView.SetNodeExpanded(n => n == node, IsParentNode(node, selectedNode));
        }
    }
    bool IsParentNode(ITreeViewNodeInfo parentNode, ITreeViewNodeInfo node) {
        while(node != null) {
            if(node == parentNode)
                return true;
            node = node.Parent;
        }
        return false;
    }
    protected void SelectionChanged(TreeViewNodeEventArgs e) {
        if(e.Reason != NavigationItemStateChangeReason.ApiCall && string.IsNullOrEmpty(e.NodeInfo.NavigateUrl)) 
            UpdateSelection(NavigationManager.Uri, false);
    }
    public void Dispose() {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
    protected override bool ShouldRender() {
        return false;
    }
}
