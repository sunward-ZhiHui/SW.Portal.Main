set xact_abort on;
go

begin transaction;
go

set ANSI_NULLS on;
go

alter PROC sp_Ins_ForumTopics
   
    @TicketNo varchar(100) = NULL,
    @TopicName varchar(50)= NULL,
	@TypeId bigint= NULL,
	@CategoryId bigint= NULL,
	@TopicFrom bigint= NULL,
	@StatusCodeID int= NULL,
	@AddedByUserID bigint= NULL,
	@AddedDate date = NULL,
	@SessionId uniqueidentifier,
	@Participants varchar(MAX) = null,
	@CC varchar(MAX) = null,
	@To varchar(MAX) = null,
	@StartDate smalldatetime = null,
	@Description varchar(MAX) = null,
	@FileData varbinary(MAX) = null

   
 AS 
 
 BEGIN
	DECLARE @TopicID bigint

    INSERT  INTO ForumTopics (TicketNo,TopicName,TypeId,CategoryId,TopicFrom,StatusCodeID,AddedByUserID,AddedDate,SessionId,StartDate,FileData)
    VALUES  (@TicketNo,@TopicName,@TypeId,@CategoryId,@AddedByUserID,@StatusCodeID,@AddedByUserID,@AddedDate,@SessionId,@StartDate,@FileData)
    SET @TopicID = SCOPE_IDENTITY()
	SELECT SCOPE_IDENTITY()


	IF (@To IS NOT NULL AND @To <> '')
	BEGIN
		INSERT INTO ForumTopicTo (TopicId, UserId, StatusCodeID, AddedByUserID, AddedDate, SessionId)
		SELECT @TopicID, s.Value, @StatusCodeID, @AddedByUserID, @AddedDate, @SessionId
		FROM dbo.SplitString(@To, ',') s
	END

	--INSERT INTO ForumTopicTo(TopicId,UserId,StatusCodeID,AddedByUserID,AddedDate,SessionId) VALUES(@TopicID,@AddedByUserID,@StatusCodeID,@AddedByUserID,@AddedDate,@SessionId)
	IF (@CC IS NOT NULL AND @CC <> '')
	BEGIN
		INSERT INTO ForumTopicCC(TopicId,UserId,StatusCodeID,AddedByUserID,AddedDate,SessionId)
		SELECT @TopicID, s.Value, @StatusCodeID, @AddedByUserID, @AddedDate, @SessionId
		FROM dbo.SplitString(@CC, ',') s
	END
	IF (@Participants IS NOT NULL AND @Participants <> '')
	BEGIN
		INSERT INTO ForumTopicParticipant(TopicId,UserId,StatusCodeID,AddedByUserID,AddedDate,SessionId)
		SELECT @TopicID, s.Value, @StatusCodeID, @AddedByUserID, @AddedDate, @SessionId
		FROM dbo.SplitString(@Participants, ',') s
	END
END
go

commit;
go


